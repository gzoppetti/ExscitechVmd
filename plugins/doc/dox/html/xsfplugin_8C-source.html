<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>xsfplugin.C Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.2.14 -->
<center>
<a class="qindex" href="index.html">Main Page</a> &nbsp; <a class="qindex" href="classes.html">Alphabetical List</a> &nbsp; <a class="qindex" href="annotated.html">Compound List</a> &nbsp; <a class="qindex" href="files.html">File List</a> &nbsp; <a class="qindex" href="functions.html">Compound Members</a> &nbsp; <a class="qindex" href="globals.html">File Members</a> &nbsp; <a class="qindex" href="pages.html">Related Pages</a> &nbsp; </center>
<hr><h1>xsfplugin.C</h1><a href="xsfplugin_8C.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 <font class="comment">/***************************************************************************</font>
00002 <font class="comment"> * RCS INFORMATION:</font>
00003 <font class="comment"> *</font>
00004 <font class="comment"> *      $RCSfile: xsfplugin.C,v $</font>
00005 <font class="comment"> *      $Author: johns $       $Locker:  $             $State: Exp $</font>
00006 <font class="comment"> *      $Revision: 1.14 $       $Date: 2006/02/23 19:36:46 $</font>
00007 <font class="comment"> *</font>
00008 <font class="comment"> ***************************************************************************/</font>
00009 
00010 <font class="comment">//</font>
00011 <font class="comment">// Plugin reader for xsf format files as created by the espresso</font>
00012 <font class="comment">// software package (http://www.pwscf.org/) and XCrySDen (http://www.xcrysden.org/).</font>
00013 <font class="comment">//</font>
00014 <font class="comment">// a file format description is available at:</font>
00015 <font class="comment">// http://www.xcrysden.org/doc/XSF.html</font>
00016 <font class="comment">//</font>
00017 
00018 <font class="preprocessor">#include "<a class="code" href="largefiles_8h.html">largefiles.h</a>"</font>   <font class="comment">/* platform dependent 64-bit file I/O defines */</font>
00019 
00020 <font class="preprocessor">#include &lt;stdio.h&gt;</font>
00021 <font class="preprocessor">#include &lt;stdlib.h&gt;</font>
00022 <font class="preprocessor">#include &lt;math.h&gt;</font>
00023 <font class="preprocessor">#include &lt;string.h&gt;</font>
00024 
00025 <font class="preprocessor">#include "<a class="code" href="molfile__plugin_8h.html">molfile_plugin.h</a>"</font>
00026 
00027 <font class="preprocessor">#ifndef M_PI_2</font>
<a name="l00028"></a><a class="code" href="xsfplugin_8C.html#a0">00028</a> <font class="preprocessor"></font><font class="preprocessor">#define M_PI_2 1.57079632679489661922</font>
00029 <font class="preprocessor"></font><font class="preprocessor">#endif</font>
00030 <font class="preprocessor"></font>
00031 <font class="preprocessor">#include "<a class="code" href="periodic__table_8h.html">periodic_table.h</a>"</font>
00032 
<a name="l00033"></a><a class="code" href="xsfplugin_8C.html#a1">00033</a> <font class="keyword">static</font> <font class="keyword">const</font> <font class="keywordtype">char</font> *<a class="code" href="xsfplugin_8C.html#a1">xsf_symtab</a>[] = {
00034   <font class="stringliteral">"(unknown keyword)"</font>, <font class="stringliteral">"#"</font>,
00035   <font class="stringliteral">"BEGIN_INFO"</font>, <font class="stringliteral">"END_INFO"</font>,
00036   <font class="stringliteral">"BEGIN_BLOCK_DATAGRID_2D"</font>, <font class="stringliteral">"END_BLOCK_DATAGRID_2D"</font>,
00037   <font class="stringliteral">"BEGIN_DATAGRID_2D"</font>, <font class="stringliteral">"END_DATAGRID_2D"</font>,
00038   <font class="stringliteral">"BEGIN_BLOCK_DATAGRID_3D"</font>, <font class="stringliteral">"END_BLOCK_DATAGRID_3D"</font>,
00039   <font class="stringliteral">"BEGIN_DATAGRID_3D"</font>, <font class="stringliteral">"END_DATAGRID_3D"</font>,
00040   <font class="stringliteral">"BEGIN_BLOCK_BANDGRID_3D"</font>, <font class="stringliteral">"END_BLOCK_BANDGRID_3D"</font>,
00041   <font class="stringliteral">"ATOMS"</font>, <font class="stringliteral">"ANIMSTEPS"</font>, <font class="stringliteral">"BAND"</font>,
00042   <font class="stringliteral">"MOLECULE"</font>, <font class="stringliteral">"POLYMER"</font>, <font class="stringliteral">"SLAB"</font>, <font class="stringliteral">"CRYSTAL"</font>,
00043   <font class="stringliteral">"PRIMVEC"</font>, <font class="stringliteral">"CONVVEC"</font>, <font class="stringliteral">"PRIMCOORD"</font>, <font class="stringliteral">"CONVCOORD"</font>
00044 };
00045 
<a name="l00046"></a><a class="code" href="xsfplugin_8C.html#a47">00046</a> <font class="keyword">typedef</font> <font class="keyword">enum</font> {
00047   <a class="code" href="xsfplugin_8C.html#a47a6">xsf_UNKNOWN</a> = 0,  <a class="code" href="xsfplugin_8C.html#a47a7">xsf_COMMENT</a>,
00048   <a class="code" href="xsfplugin_8C.html#a47a8">xsf_BEGINFO</a>,      <a class="code" href="xsfplugin_8C.html#a47a9">xsf_ENDINFO</a>, 
00049   <a class="code" href="xsfplugin_8C.html#a47a10">xsf_BEG_2D_BLOCK</a>, <a class="code" href="xsfplugin_8C.html#a47a11">xsf_END_2D_BLOCK</a>,
00050   <a class="code" href="xsfplugin_8C.html#a47a12">xsf_BEG_2D_DATA</a>,  <a class="code" href="xsfplugin_8C.html#a47a13">xsf_END_2D_DATA</a>,
00051   <a class="code" href="xsfplugin_8C.html#a47a14">xsf_BEG_3D_BLOCK</a>, <a class="code" href="xsfplugin_8C.html#a47a15">xsf_END_3D_BLOCK</a>,
00052   <a class="code" href="xsfplugin_8C.html#a47a16">xsf_BEG_3D_DATA</a>,  <a class="code" href="xsfplugin_8C.html#a47a17">xsf_END_3D_DATA</a>,
00053   <a class="code" href="xsfplugin_8C.html#a47a18">xsf_BEG_3D_BAND</a>,  <a class="code" href="xsfplugin_8C.html#a47a19">xsf_END_3D_BAND</a>,
00054   <a class="code" href="xsfplugin_8C.html#a47a20">xsf_ATOMS</a>, <a class="code" href="xsfplugin_8C.html#a47a21">xsf_ANIMSTEPS</a>, <a class="code" href="xsfplugin_8C.html#a47a22">xsf_BAND</a>,
00055   <a class="code" href="xsfplugin_8C.html#a47a23">xsf_MOLECULE</a>, <a class="code" href="xsfplugin_8C.html#a47a24">xsf_POLYMER</a>, <a class="code" href="xsfplugin_8C.html#a47a25">xsf_SLAB</a>, <a class="code" href="xsfplugin_8C.html#a47a26">xsf_CRYSTAL</a>,
00056   <a class="code" href="xsfplugin_8C.html#a47a27">xsf_PRIMVEC</a>, <a class="code" href="xsfplugin_8C.html#a47a28">xsf_CONVVEC</a>, <a class="code" href="xsfplugin_8C.html#a47a29">xsf_PRIMCOORD</a>, <a class="code" href="xsfplugin_8C.html#a47a30">xsf_CONVCOORD</a>,
00057   <a class="code" href="xsfplugin_8C.html#a47a31">xsf_NR_KEYWORDS</a>
00058 } <a class="code" href="xsfplugin_8C.html#a47">xsf_keyword_t</a>;
00059 
00060 <font class="comment">// list of known alternatives to the keywords above</font>
00061 <font class="comment">// last entry has to be an xsf_UNKNOWN.</font>
00062 <font class="keyword">static</font> <font class="keyword">const</font> <font class="keyword">struct </font>{
<a name="l00063"></a><a class="code" href="xsfplugin_8C.html#a2">00063</a>   <font class="keyword">const</font> <font class="keywordtype">char</font> *<a class="code" href="xsfplugin_8C.html#a2">name</a>;
<a name="l00064"></a><a class="code" href="xsfplugin_8C.html#a3">00064</a>   <a class="code" href="xsfplugin_8C.html#a47">xsf_keyword_t</a> <a class="code" href="xsfplugin_8C.html#a3">kw</a>;
00065 }  <a class="code" href="xsfplugin_8C.html#a4">xsf_aliases</a>[] = {
00066   { <font class="stringliteral">"DATAGRID_2D"</font>, <a class="code" href="xsfplugin_8C.html#a47a12">xsf_BEG_2D_DATA</a> },
00067   { <font class="stringliteral">"DATAGRID_3D"</font>, <a class="code" href="xsfplugin_8C.html#a47a16">xsf_BEG_3D_DATA</a> },
00068   { <font class="stringliteral">"BEGIN_BLOCK_DATAGRID2D"</font>, <a class="code" href="xsfplugin_8C.html#a47a10">xsf_BEG_2D_BLOCK</a> },
00069   { <font class="stringliteral">"BEGIN_BLOCK_DATAGRID3D"</font>, <a class="code" href="xsfplugin_8C.html#a47a14">xsf_BEG_3D_BLOCK</a> },
00070   { <font class="stringliteral">"END_BLOCK_DATAGRID2D"</font>, <a class="code" href="xsfplugin_8C.html#a47a11">xsf_END_2D_BLOCK</a> },
00071   { <font class="stringliteral">"END_BLOCK_DATAGRID3D"</font>, <a class="code" href="xsfplugin_8C.html#a47a15">xsf_END_3D_BLOCK</a> },
00072   { NULL,          <a class="code" href="xsfplugin_8C.html#a47a6">xsf_UNKNOWN</a>     }
00073 };
00074 
<a name="l00075"></a><a class="code" href="xsfplugin_8C.html#a32">00075</a> <font class="keyword">static</font> <a class="code" href="xsfplugin_8C.html#a47">xsf_keyword_t</a> <a class="code" href="xsfplugin_8C.html#a32">lookup_keyword</a>(<font class="keyword">const</font> <font class="keywordtype">char</font>* word)
00076 {
00077   <font class="keywordtype">int</font> i, j;
00078   
00079   <font class="keywordflow">if</font> (word == 0) <font class="keywordflow">return</font> <a class="code" href="xsfplugin_8C.html#a47a6">xsf_UNKNOWN</a>;
00080   
00081   <font class="comment">// find start of word.</font>
00082   j=0;
00083   <font class="keywordflow">for</font> (i=0; i &lt; (int)strlen(word); ++i) {
00084     j=i;
00085     <font class="keywordflow">if</font> (! isspace(word[i])) <font class="keywordflow">break</font>;
00086   }
00087   
00088   <font class="keywordflow">for</font> (i=1; i &lt; <a class="code" href="xsfplugin_8C.html#a47a31">xsf_NR_KEYWORDS</a>; ++i) {
00089     <font class="keywordflow">if</font> (0 == strncmp(word + j, <a class="code" href="xsfplugin_8C.html#a1">xsf_symtab</a>[i], strlen(<a class="code" href="xsfplugin_8C.html#a1">xsf_symtab</a>[i])))
00090       <font class="keywordflow">return</font> (xsf_keyword_t) i;
00091   }
00092 
00093   <font class="comment">// check for known aliases/alternatives</font>
00094   <font class="keywordflow">for</font> (i=0; <a class="code" href="xsfplugin_8C.html#a4">xsf_aliases</a>[i].kw != <a class="code" href="xsfplugin_8C.html#a47a6">xsf_UNKNOWN</a>; ++i) {
00095     <font class="keyword">const</font> <font class="keywordtype">char</font> *<a class="code" href="xsfplugin_8C.html#a2">name</a> = <a class="code" href="xsfplugin_8C.html#a4">xsf_aliases</a>[i].name;
00096 
00097     <font class="keywordflow">if</font> (0 == strncmp(word + j, <a class="code" href="xsfplugin_8C.html#a2">name</a>, strlen(<a class="code" href="xsfplugin_8C.html#a2">name</a>)))
00098       <font class="keywordflow">return</font> <a class="code" href="xsfplugin_8C.html#a4">xsf_aliases</a>[i].kw;
00099 
00100   }
00101 
00102   <font class="keywordflow">return</font> <a class="code" href="xsfplugin_8C.html#a47a6">xsf_UNKNOWN</a>;
00103 }
00104 
00105 <font class="comment">// A format-independent structure to hold unit cell data</font>
<a name="l00106"></a><a class="code" href="structxsf__box.html">00106</a> <font class="keyword">typedef</font> <font class="keyword">struct </font>{
<a name="l00107"></a><a class="code" href="structxsf__box.html#m5">00107</a>   <font class="keywordtype">float</font> A, B, C, alpha, beta, gamma, cell[3][3];
00108 } <a class="code" href="structxsf__box.html">xsf_box</a>;
00109 
<a name="l00110"></a><a class="code" href="structxsf__t.html">00110</a> <font class="keyword">typedef</font> <font class="keyword">struct </font>{
<a name="l00111"></a><a class="code" href="structxsf__t.html#m0">00111</a>   FILE *fd;                     <font class="comment">// file descriptor</font>
<a name="l00112"></a><a class="code" href="structxsf__t.html#m1">00112</a>   <font class="keywordtype">int</font> nvolsets;                 <font class="comment">// number of volumetric datasets</font>
<a name="l00113"></a><a class="code" href="structxsf__t.html#m2">00113</a>   <font class="keywordtype">int</font> numatoms;                 <font class="comment">// number of atoms</font>
<a name="l00114"></a><a class="code" href="structxsf__t.html#m3">00114</a>   <font class="keywordtype">int</font> animsteps;                <font class="comment">// for comparison.</font>
<a name="l00115"></a><a class="code" href="structxsf__t.html#m4">00115</a>   <font class="keywordtype">int</font> numsteps;                 <font class="comment">// number of coordinate sets.</font>
<a name="l00116"></a><a class="code" href="structxsf__t.html#m5">00116</a>   <font class="keywordtype">bool</font> coord;                   <font class="comment">// has coordinate data</font>
<a name="l00117"></a><a class="code" href="structxsf__t.html#m6">00117</a>   <font class="keywordtype">char</font> *file_name;              <font class="comment">// original filename </font>
<a name="l00118"></a><a class="code" href="structxsf__t.html#m7">00118</a>   <a class="code" href="xsfplugin_8C.html#a47">xsf_keyword_t</a> pbctype;        <font class="comment">// type of periodicity (none/polymer/slab/crystal)</font>
<a name="l00119"></a><a class="code" href="structxsf__t.html#m8">00119</a>   <a class="code" href="structmolfile__volumetric__t.html">molfile_volumetric_t</a> *vol;    <font class="comment">// volume set metadata </font>
<a name="l00120"></a><a class="code" href="structxsf__t.html#m9">00120</a>   <font class="keywordtype">int</font> numvolmeta;               <font class="comment">// number of entries in *vol</font>
<a name="l00121"></a><a class="code" href="structxsf__t.html#m10">00121</a>   <font class="keywordtype">float</font> origin[3];              <font class="comment">// origin, stored for periodic display hack </font>
<a name="l00122"></a><a class="code" href="structxsf__t.html#m11">00122</a>   <font class="keywordtype">float</font> rotmat[3][3];           <font class="comment">// rotation matrix, stored for periodic display hack</font>
<a name="l00123"></a><a class="code" href="structxsf__t.html#m12">00123</a>   <font class="keywordtype">float</font> invmat[3][3];           <font class="comment">// reciprocal cell matrix (for PBC wrapping).</font>
<a name="l00124"></a><a class="code" href="structxsf__t.html#m13">00124</a>   <a class="code" href="structxsf__box.html">xsf_box</a> box;                  <font class="comment">// unit cell dimensions (for VMD).</font>
00125 } <a class="code" href="structxsf__t.html">xsf_t</a>;
00126 
00127 
00128 <font class="comment">// Converts box basis vectors to A, B, C, alpha, beta, and gamma.  </font>
00129 <font class="comment">// Stores values in xsf_box struct, which should be allocated before calling</font>
00130 <font class="comment">// this function.</font>
<a name="l00131"></a><a class="code" href="xsfplugin_8C.html#a33">00131</a> <font class="keyword">static</font> <font class="keywordtype">int</font> <a class="code" href="xsfplugin_8C.html#a33">xsf_readbox</a>(<a class="code" href="structxsf__box.html">xsf_box</a> *box, <font class="keywordtype">float</font> *x, <font class="keywordtype">float</font> *y, <font class="keywordtype">float</font> *z) {
00132   <font class="keywordtype">float</font> A, B, C;
00133   <font class="keywordtype">int</font> i;
00134 
00135   <font class="keywordflow">if</font> (!box) {
00136     <font class="keywordflow">return</font> 1;
00137   }
00138 
00139   <font class="comment">// provide defaults</font>
00140   box-&gt;<a class="code" href="structxsf__box.html#m0">A</a> = 10.0;
00141   box-&gt;<a class="code" href="structxsf__box.html#m1">B</a> = 10.0;
00142   box-&gt;<a class="code" href="structxsf__box.html#m2">C</a> = 10.0;
00143   box-&gt;<a class="code" href="structxsf__box.html#m3">alpha</a> = 90.0;
00144   box-&gt;<a class="code" href="structxsf__box.html#m4">beta</a>  = 90.0;
00145   box-&gt;<a class="code" href="structxsf__box.html#m5">gamma</a> = 90.0;
00146 
00147   <font class="comment">// A, B, C are the lengths of the x, y, z vectors, respectively</font>
00148   A = sqrt( x[0]*x[0] + x[1]*x[1] + x[2]*x[2] );
00149   B = sqrt( y[0]*y[0] + y[1]*y[1] + y[2]*y[2] );
00150   C = sqrt( z[0]*z[0] + z[1]*z[1] + z[2]*z[2] );
00151   <font class="keywordflow">if</font> ((A&lt;=0) || (B&lt;=0) || (C&lt;=0)) {
00152     <font class="keywordflow">return</font> 1;
00153   }
00154   box-&gt;<a class="code" href="structxsf__box.html#m0">A</a> = A;
00155   box-&gt;<a class="code" href="structxsf__box.html#m1">B</a> = B;
00156   box-&gt;<a class="code" href="structxsf__box.html#m2">C</a> = C;
00157 
00158   <font class="comment">// gamma, beta, alpha are the angles between the x &amp; y, x &amp; z, y &amp; z</font>
00159   <font class="comment">// vectors, respectively</font>
00160   box-&gt;<a class="code" href="structxsf__box.html#m5">gamma</a> = acos( (x[0]*y[0]+x[1]*y[1]+x[2]*y[2])/(A*B) ) * 90.0/<a class="code" href="xsfplugin_8C.html#a0">M_PI_2</a>;
00161   box-&gt;<a class="code" href="structxsf__box.html#m4">beta</a> = acos( (x[0]*z[0]+x[1]*z[1]+x[2]*z[2])/(A*C) ) * 90.0/<a class="code" href="xsfplugin_8C.html#a0">M_PI_2</a>;
00162   box-&gt;<a class="code" href="structxsf__box.html#m3">alpha</a> = acos( (y[0]*z[0]+y[1]*z[1]+y[2]*z[2])/(B*C) ) * 90.0/<a class="code" href="xsfplugin_8C.html#a0">M_PI_2</a>; 
00163 
00164   <font class="comment">// copy original cell vectors for PBC wrapping.</font>
00165   <font class="keywordflow">for</font> (i=0; i&lt;3; ++i) {
00166     box-&gt;<a class="code" href="structxsf__box.html#m6">cell</a>[0][i] = x[i];
00167     box-&gt;<a class="code" href="structxsf__box.html#m6">cell</a>[1][i] = y[i];
00168     box-&gt;<a class="code" href="structxsf__box.html#m6">cell</a>[2][i] = z[i];
00169   }
00170   
00171   <font class="keywordflow">return</font> 0;
00172 }
00173 
00174 <font class="comment">// calculate and store rotation matrix to realign everything later.</font>
<a name="l00175"></a><a class="code" href="xsfplugin_8C.html#a34">00175</a> <font class="keyword">static</font> <font class="keywordtype">void</font> <a class="code" href="xsfplugin_8C.html#a34">xsf_buildrotmat</a>(<a class="code" href="structxsf__t.html">xsf_t</a> *xsf, <font class="keywordtype">float</font> *a, <font class="keywordtype">float</font> *b)
00176 {
00177   <font class="comment">// we rotate first around y and z to align a along the x-axis...</font>
00178   <font class="keyword">const</font> <font class="keywordtype">double</font> len   = sqrt(a[0]*a[0] + a[1]*a[1]);
00179   <font class="keyword">const</font> <font class="keywordtype">double</font> phi   = atan2((<font class="keywordtype">double</font>) a[2], (<font class="keywordtype">double</font>) len);
00180   <font class="keyword">const</font> <font class="keywordtype">double</font> theta = atan2((<font class="keywordtype">double</font>) a[1], (<font class="keywordtype">double</font>) a[0]);
00181 
00182   <font class="keyword">const</font> <font class="keywordtype">double</font> cph = cos(phi);
00183   <font class="keyword">const</font> <font class="keywordtype">double</font> cth = cos(theta);
00184   <font class="keyword">const</font> <font class="keywordtype">double</font> sph = sin(phi);
00185   <font class="keyword">const</font> <font class="keywordtype">double</font> sth = sin(theta);
00186 
00187   <font class="comment">// ...then we rotate around x to put b into the xy-plane.</font>
00188   <font class="keyword">const</font> <font class="keywordtype">double</font> psi = atan2(-sph*cth*b[0] - sph*sth*b[1] + cph*b[2],-sth*b[0] + cth*b[1]);
00189   <font class="keyword">const</font> <font class="keywordtype">double</font> cps = cos(psi);
00190   <font class="keyword">const</font> <font class="keywordtype">double</font> sps = sin(psi);
00191 
00192   <font class="keyword">const</font> <font class="keywordtype">double</font> r[3][3] = { 
00193     {               cph*cth,                    cph*sth,      sph},
00194     {-sth*cps - sph*cth*sps,      cth*cps - sph*sth*sps,  cph*sps},
00195     { sth*sps - sph*cth*cps,     -cth*sps - sph*sth*cps,  cph*cps}
00196   };
00197 
00198   <font class="keywordflow">for</font> (<font class="keywordtype">int</font> i=0; i&lt;3; ++i) {
00199     <font class="keywordflow">for</font> (<font class="keywordtype">int</font> j=0; j&lt;3; ++j) {
00200       xsf-&gt;<a class="code" href="structxsf__t.html#m11">rotmat</a>[i][j] = r[i][j];
00201     }
00202   }
00203 }
00204 
<a name="l00205"></a><a class="code" href="xsfplugin_8C.html#a35">00205</a> <font class="keyword">static</font> <font class="keywordtype">void</font> <a class="code" href="xsfplugin_8C.html#a35">xsf_buildinvmat</a>(<a class="code" href="structxsf__t.html">xsf_t</a> *xsf, <font class="keywordtype">float</font> *a, <font class="keywordtype">float</font> *b, <font class="keywordtype">float</font> *c)
00206 {
00207   <font class="keywordtype">float</font> det, id;
00208   
00209   det = a[0]*b[1]*c[2] + b[0]*c[1]*a[2] + c[0]*a[1]*b[2] 
00210     - a[0]*c[1]*b[2] - b[0]*a[1]*c[2] - c[0]*b[1]*a[2];
00211   
00212   id = 1.0 / det;
00213   xsf-&gt;<a class="code" href="structxsf__t.html#m12">invmat</a>[0][0] = id * ( b[1]*c[2]-b[2]*c[1] );
00214   xsf-&gt;<a class="code" href="structxsf__t.html#m12">invmat</a>[1][0] = id * ( a[2]*c[1]-a[1]*c[2] );
00215   xsf-&gt;<a class="code" href="structxsf__t.html#m12">invmat</a>[2][0] = id * ( a[1]*b[2]-a[2]*b[1] );
00216   xsf-&gt;<a class="code" href="structxsf__t.html#m12">invmat</a>[0][1] = id * ( b[2]*c[0]-b[0]*c[2] );
00217   xsf-&gt;<a class="code" href="structxsf__t.html#m12">invmat</a>[1][1] = id * ( a[0]*c[2]-a[2]*c[0] );
00218   xsf-&gt;<a class="code" href="structxsf__t.html#m12">invmat</a>[2][1] = id * ( a[2]*b[0]-a[0]*b[2] );
00219   xsf-&gt;<a class="code" href="structxsf__t.html#m12">invmat</a>[0][2] = id * ( b[0]*c[1]-b[1]*c[0] );
00220   xsf-&gt;<a class="code" href="structxsf__t.html#m12">invmat</a>[1][2] = id * ( a[1]*c[0]-a[0]*c[1] );
00221   xsf-&gt;<a class="code" href="structxsf__t.html#m12">invmat</a>[2][2] = id * ( a[0]*b[1]-a[1]*b[0] );
00222 }
00223 
00224 
00225 <font class="comment">// read a line and forget the data</font>
<a name="l00226"></a><a class="code" href="xsfplugin_8C.html#a36">00226</a> <font class="keyword">static</font> <font class="keywordtype">void</font> <a class="code" href="xsfplugin_8C.html#a36">eatline</a>(FILE *fd) {
00227   <font class="keywordtype">char</font> readbuf[1025];
00228   fgets(readbuf, 1024, fd);    <font class="comment">// go on to next line</font>
00229 }  
00230 
<a name="l00231"></a><a class="code" href="xsfplugin_8C.html#a37">00231</a> <font class="keyword">static</font> <font class="keywordtype">bool</font> <a class="code" href="xsfplugin_8C.html#a37">xsf_read_cell</a>(FILE *fd, <font class="keywordtype">float</font> *a, <font class="keywordtype">float</font> *b, <font class="keywordtype">float</font> *c)
00232 {
00233   <font class="keywordflow">return</font> (9 == fscanf(fd, <font class="stringliteral">"%f%f%f%f%f%f%f%f%f"</font>, 
00234                       &amp;a[0],&amp;a[1],&amp;a[2],
00235                       &amp;b[0],&amp;b[1],&amp;b[2],
00236                       &amp;c[0],&amp;c[1],&amp;c[2]));
00237 }
00238 
00239 <font class="keyword">static</font> <font class="keywordtype">void</font> <a class="code" href="xsfplugin_8C.html#a38">close_xsf_read</a>(<font class="keywordtype">void</font> *v);
00240 
<a name="l00241"></a><a class="code" href="xsfplugin_8C.html#a39">00241</a> <font class="keyword">static</font> <font class="keywordtype">void</font> *<a class="code" href="xsfplugin_8C.html#a39">open_xsf_read</a>(<font class="keyword">const</font> <font class="keywordtype">char</font> *filepath, <font class="keyword">const</font> <font class="keywordtype">char</font> *filetype,
00242                            <font class="keywordtype">int</font> *natoms) {
00243   FILE *fd;
00244   <a class="code" href="structxsf__t.html">xsf_t</a> *xsf;
00245   <font class="keywordtype">int</font> i,j;
00246   
00247   fd = fopen(filepath, <font class="stringliteral">"rb"</font>);
00248   <font class="keywordflow">if</font> (!fd) 
00249     <font class="keywordflow">return</font> NULL;
00250 
00251   xsf = <font class="keyword">new</font> <a class="code" href="structxsf__t.html">xsf_t</a>;
00252   xsf-&gt;<a class="code" href="structxsf__t.html#m0">fd</a> = fd;
00253   xsf-&gt;<a class="code" href="structxsf__t.html#m8">vol</a> = NULL;
00254   xsf-&gt;<a class="code" href="structxsf__t.html#m9">numvolmeta</a> = 0;
00255   xsf-&gt;<a class="code" href="structxsf__t.html#m5">coord</a> = <font class="keyword">false</font>;
00256   xsf-&gt;<a class="code" href="structxsf__t.html#m1">nvolsets</a> = 0;
00257   xsf-&gt;<a class="code" href="structxsf__t.html#m2">numatoms</a> = 0;
00258   xsf-&gt;<a class="code" href="structxsf__t.html#m4">numsteps</a> = 0;
00259   xsf-&gt;<a class="code" href="structxsf__t.html#m6">file_name</a> = strdup(filepath);
00260   <font class="comment">// this will disable pbc wrapping of coordinates by default</font>
00261   xsf-&gt;<a class="code" href="structxsf__t.html#m7">pbctype</a> = <a class="code" href="xsfplugin_8C.html#a47a23">xsf_MOLECULE</a>; 
00262 
00263   <font class="comment">// initialize origin and rotmat to sensible defaults.</font>
00264   <font class="keywordflow">for</font> (i=0; i&lt;3; ++i) {
00265     <font class="keywordflow">for</font> (j=0; j&lt;3; ++j) {
00266       xsf-&gt;<a class="code" href="structxsf__t.html#m11">rotmat</a>[i][j] = 0.0;
00267     }
00268   }
00269   <font class="keywordflow">for</font> (i=0; i&lt;3; ++i) {
00270     xsf-&gt;<a class="code" href="structxsf__t.html#m10">origin</a>[i] = 0.0;
00271     xsf-&gt;<a class="code" href="structxsf__t.html#m11">rotmat</a>[i][i] = 1.0;
00272   }
00273 
00274   <font class="comment">// since there can be all kinds of data in the file, </font>
00275   <font class="comment">// we start by scanning through the whole file and analyse</font>
00276   <font class="comment">// the available info.</font>
00277   <font class="keywordtype">char</font> readbuf[256]; <font class="comment">// line buffer</font>
00278   <a class="code" href="xsfplugin_8C.html#a47">xsf_keyword_t</a> <a class="code" href="xsfplugin_8C.html#a3">kw</a>;
00279 
00280   <font class="comment">// we loop until can't read anymore.</font>
00281   <font class="keywordflow">do</font> {
00282     <font class="keywordflow">if</font> (NULL == fgets(readbuf, 256, xsf-&gt;<a class="code" href="structxsf__t.html#m0">fd</a>)) <font class="keywordflow">break</font>;
00283 
00284     again:
00285     <a class="code" href="xsfplugin_8C.html#a3">kw</a> = <a class="code" href="xsfplugin_8C.html#a32">lookup_keyword</a>(readbuf);
00286 <font class="preprocessor">#ifdef TEST_PLUGIN</font>
00287 <font class="preprocessor"></font>    fprintf(stderr, <font class="stringliteral">"keyword: %d / %s"</font>, <a class="code" href="xsfplugin_8C.html#a3">kw</a>, readbuf);
00288 <font class="preprocessor">#endif          </font>
00289 <font class="preprocessor"></font>    
00290     <font class="keywordflow">switch</font> (kw) {
00291       <font class="keywordflow">case</font> <a class="code" href="xsfplugin_8C.html#a47a21">xsf_ANIMSTEPS</a>:
00292 <font class="preprocessor">#ifdef TEST_PLUGIN</font>
00293 <font class="preprocessor"></font>      {
00294         <font class="keywordtype">int</font> n;
00295         <font class="keywordflow">if</font> (1 == sscanf(readbuf, <font class="stringliteral">"%*s%d"</font>, &amp;n)) {
00296           fprintf(stderr, <font class="stringliteral">"ANIMSTEPS: found %d steps\n"</font>, n);
00297         }
00298       }
00299 <font class="preprocessor">#endif          </font>
00300 <font class="preprocessor"></font>      <font class="keywordflow">break</font>;
00301         
00302       <font class="keywordflow">case</font> <a class="code" href="xsfplugin_8C.html#a47a20">xsf_ATOMS</a>: <font class="comment">// no specification for the number of atoms, so we</font>
00303                       <font class="comment">// try to figure them out</font>
00304         ++ xsf-&gt;<a class="code" href="structxsf__t.html#m4">numsteps</a>;
00305         <font class="keywordflow">if</font> (xsf-&gt;<a class="code" href="structxsf__t.html#m2">numatoms</a> == 0) { <font class="comment">// count atoms only, if we don't know how many</font>
00306           <font class="keywordflow">while</font> (fgets(readbuf, 256, xsf-&gt;<a class="code" href="structxsf__t.html#m0">fd</a>)) {
00307             <font class="keywordtype">float</font> x,y,z;
00308             <font class="comment">// the coordinate lines are &lt;index&gt; &lt;x&gt; &lt;y&gt; &lt;z&gt; with optional forces.</font>
00309             <font class="keywordflow">if</font> (3 == sscanf(readbuf, <font class="stringliteral">"%*s%f%f%f"</font>, &amp;x, &amp;y, &amp;z)) {
00310               ++ xsf-&gt;<a class="code" href="structxsf__t.html#m2">numatoms</a>;
00311             } <font class="keywordflow">else</font> {
00312               <font class="comment">// we've most likely read the next keyword.</font>
00313               <font class="comment">// reparse buffer.</font>
00314               <font class="keywordflow">goto</font> again;
00315               <font class="keywordflow">break</font>;
00316             }
00317           }
00318 <font class="preprocessor">#ifdef TEST_PLUGIN</font>
00319 <font class="preprocessor"></font>          fprintf(stderr, <font class="stringliteral">"ATOMS: found %d atoms\n"</font>, xsf-&gt;<a class="code" href="structxsf__t.html#m2">numatoms</a>);
00320 <font class="preprocessor">#endif          </font>
00321 <font class="preprocessor"></font>        }  <font class="keywordflow">else</font> { <font class="comment">// skip over the lines</font>
00322           <font class="keywordtype">int</font> n;
00323           <font class="keywordflow">for</font> (n=0; n &lt; xsf-&gt;<a class="code" href="structxsf__t.html#m2">numatoms</a>; ++n) <a class="code" href="xsfplugin_8C.html#a36">eatline</a>(xsf-&gt;<a class="code" href="structxsf__t.html#m0">fd</a>);
00324         }
00325         <font class="keywordflow">break</font>;
00326         
00327       <font class="keywordflow">case</font> <a class="code" href="xsfplugin_8C.html#a47a29">xsf_PRIMCOORD</a>: <font class="comment">// number of atoms is in the next line</font>
00328          
00329         <font class="keywordflow">if</font>(fgets(readbuf, 256, xsf-&gt;<a class="code" href="structxsf__t.html#m0">fd</a>)) {
00330           <font class="keywordtype">int</font> mol, mult;
00331           
00332           <font class="keywordflow">if</font> (xsf-&gt;<a class="code" href="structxsf__t.html#m2">numatoms</a> == 0) {
00333             <font class="keywordflow">if</font> (2 == sscanf(readbuf, <font class="stringliteral">"%d%d"</font>, &amp;mol, &amp;mult)) {
00334               xsf-&gt;<a class="code" href="structxsf__t.html#m2">numatoms</a> = mol * mult;
00335             } <font class="keywordflow">else</font> {
00336               xsf-&gt;<a class="code" href="structxsf__t.html#m2">numatoms</a> = mol;
00337             }
00338           }
00339           <font class="comment">// skip over atom coordinates</font>
00340           <font class="keywordtype">int</font> n;
00341           <font class="keywordflow">for</font> (n=0; n &lt; xsf-&gt;<a class="code" href="structxsf__t.html#m2">numatoms</a>; ++n) <a class="code" href="xsfplugin_8C.html#a36">eatline</a>(xsf-&gt;<a class="code" href="structxsf__t.html#m0">fd</a>);
00342           ++ xsf-&gt;<a class="code" href="structxsf__t.html#m4">numsteps</a>; 
00343 
00344 <font class="preprocessor">#ifdef TEST_PLUGIN</font>
00345 <font class="preprocessor"></font>          fprintf(stderr, <font class="stringliteral">"PRIMCOORD: found %d atoms\n"</font>, xsf-&gt;<a class="code" href="structxsf__t.html#m2">numatoms</a>);
00346 <font class="preprocessor">#endif          </font>
00347 <font class="preprocessor"></font>        }
00348         <font class="keywordflow">break</font>;
00349         
00350       <font class="keywordflow">case</font> <a class="code" href="xsfplugin_8C.html#a47a30">xsf_CONVCOORD</a>: <font class="comment">// number of atoms is in the next line</font>
00351          
00352         <font class="keywordflow">if</font>(fgets(readbuf, 256, xsf-&gt;<a class="code" href="structxsf__t.html#m0">fd</a>)) {
00353           <font class="keywordtype">int</font> mol, mult, num;
00354           
00355           num = 0;
00356           <font class="keywordflow">if</font> (2 == sscanf(readbuf, <font class="stringliteral">"%d%d"</font>, &amp;mol, &amp;mult)) {
00357             num = mol * mult;
00358           }
00359           
00360           <font class="comment">// skip over atom coordinates</font>
00361           <font class="keywordtype">int</font> n;
00362           <font class="keywordflow">for</font> (n=0; n &lt; num; ++n) <a class="code" href="xsfplugin_8C.html#a36">eatline</a>(xsf-&gt;<a class="code" href="structxsf__t.html#m0">fd</a>);
00363 <font class="preprocessor">#ifdef TEST_PLUGIN</font>
00364 <font class="preprocessor"></font>          fprintf(stderr, <font class="stringliteral">"CONVCOORD: ignoring %d atoms\n"</font>, num);
00365 <font class="preprocessor">#endif          </font>
00366 <font class="preprocessor"></font>        }
00367         <font class="keywordflow">break</font>;
00368 
00369       <font class="keywordflow">case</font> <a class="code" href="xsfplugin_8C.html#a47a27">xsf_PRIMVEC</a>: <font class="comment">// store primitive cell info for rotation of the volumetric data grid vectors</font>
00370       {
00371         <font class="keywordtype">float</font> a[3], b[3], c[3];
00372         
00373         <font class="keywordflow">if</font> (<a class="code" href="xsfplugin_8C.html#a37">xsf_read_cell</a>(xsf-&gt;<a class="code" href="structxsf__t.html#m0">fd</a>, a, b, c)) {
00374           <a class="code" href="xsfplugin_8C.html#a34">xsf_buildrotmat</a>(xsf, a, b);
00375         } <font class="keywordflow">else</font> {
00376           fprintf(stderr, <font class="stringliteral">"xsfplugin) WARNING: error reading unit cell. ignoring unit cell info.\n"</font>);
00377         }
00378       }
00379       <font class="keywordflow">break</font>;
00380       
00381       <font class="keywordflow">case</font> <a class="code" href="xsfplugin_8C.html#a47a28">xsf_CONVVEC</a>: <font class="comment">// ignore conventional cells.</font>
00382       {
00383         <font class="keywordtype">int</font> n;
00384         <font class="keywordflow">for</font> (n=0; n &lt; 3; ++n) <a class="code" href="xsfplugin_8C.html#a36">eatline</a>(xsf-&gt;<a class="code" href="structxsf__t.html#m0">fd</a>);
00385       }
00386       <font class="keywordflow">break</font>;
00387 
00388       <font class="keywordflow">case</font> <a class="code" href="xsfplugin_8C.html#a47a14">xsf_BEG_3D_BLOCK</a>: <font class="comment">// analyse number of 3d-data sets</font>
00389         <font class="comment">// ordinarily the parsing of the metadata would be done in read_xsf_metadata()</font>
00390         <font class="comment">// but since we have to move through the whole file to count its contents,</font>
00391         <font class="comment">// it is faster to parse it here and just pass the data later.</font>
00392 
00393         <font class="keywordflow">if</font> (xsf-&gt;<a class="code" href="structxsf__t.html#m8">vol</a> == NULL) { <font class="comment">// initialize the volume set list with 32 entries</font>
00394           xsf-&gt;<a class="code" href="structxsf__t.html#m9">numvolmeta</a> = 32;
00395           xsf-&gt;<a class="code" href="structxsf__t.html#m8">vol</a> = <font class="keyword">new</font> <a class="code" href="structmolfile__volumetric__t.html">molfile_volumetric_t</a>[xsf-&gt;<a class="code" href="structxsf__t.html#m9">numvolmeta</a>];
00396         }
00397         
00398         <font class="comment">// next line is title, then check for data blocks</font>
00399         fgets(readbuf, 256, xsf-&gt;<a class="code" href="structxsf__t.html#m0">fd</a>);
00400         printf(<font class="stringliteral">"xsfplugin) found grid data block: %s"</font>, readbuf);
00401 
00402         <font class="keywordflow">do</font> { <font class="comment">// loop until we reach the end of the whole block </font>
00403              <font class="comment">// or run out of data.</font>
00404           <font class="keywordflow">if</font> (NULL == fgets(readbuf, 256, xsf-&gt;<a class="code" href="structxsf__t.html#m0">fd</a>)) <font class="keywordflow">break</font>;
00405           <font class="keywordflow">switch</font> (<a class="code" href="xsfplugin_8C.html#a32">lookup_keyword</a>(readbuf)) {
00406             <font class="keywordflow">case</font> <a class="code" href="xsfplugin_8C.html#a47a16">xsf_BEG_3D_DATA</a>: <font class="comment">// fallthrough</font>
00407             {
00408               <font class="keywordtype">int</font> n;
00409               <a class="code" href="structmolfile__volumetric__t.html">molfile_volumetric_t</a> *set;
00410               <font class="keywordtype">float</font> a[3], b[3], c[3];
00411               
00412               ++ xsf-&gt;<a class="code" href="structxsf__t.html#m1">nvolsets</a>;
00413 
00414               <font class="comment">// double the size of the cache for metainfo, if needed</font>
00415               <font class="keywordflow">if</font> (xsf-&gt;<a class="code" href="structxsf__t.html#m1">nvolsets</a> &gt; xsf-&gt;<a class="code" href="structxsf__t.html#m9">numvolmeta</a>) {
00416                 <a class="code" href="structmolfile__volumetric__t.html">molfile_volumetric_t</a> *ptr = xsf-&gt;<a class="code" href="structxsf__t.html#m8">vol</a>;
00417                 xsf-&gt;<a class="code" href="structxsf__t.html#m8">vol</a> = <font class="keyword">new</font> <a class="code" href="structmolfile__volumetric__t.html">molfile_volumetric_t</a>[2 * xsf-&gt;<a class="code" href="structxsf__t.html#m9">numvolmeta</a>];
00418                 memcpy((<font class="keywordtype">void</font> *)xsf-&gt;<a class="code" href="structxsf__t.html#m8">vol</a>, (<font class="keywordtype">void</font> *)ptr, xsf-&gt;<a class="code" href="structxsf__t.html#m9">numvolmeta</a>*<font class="keyword">sizeof</font>(<a class="code" href="structmolfile__volumetric__t.html">molfile_volumetric_t</a>));
00419                 xsf-&gt;<a class="code" href="structxsf__t.html#m9">numvolmeta</a> *= 2;
00420                 <font class="keyword">delete</font>[] ptr;
00421               }
00422 
00423               <font class="comment">// get a handle to the current volume set meta data</font>
00424               set = &amp;(xsf-&gt;<a class="code" href="structxsf__t.html#m8">vol</a>[xsf-&gt;<a class="code" href="structxsf__t.html#m1">nvolsets</a> - 1]);
00425               set-&gt;<a class="code" href="structmolfile__volumetric__t.html#m8">has_color</a> = 0;
00426 
00427               <font class="comment">// the begin mark is also the title of the data set.</font>
00428               <font class="comment">// we need the exact name to later find the start of the data set.</font>
00429               strncpy(set-&gt;<a class="code" href="structmolfile__volumetric__t.html#m0">dataname</a>, readbuf, 255);
00430               
00431               <font class="comment">// next is the number of grid points, the origin and</font>
00432               <font class="comment">// the spanning vectors of the data block</font>
00433               fgets(readbuf, 256, xsf-&gt;<a class="code" href="structxsf__t.html#m0">fd</a>);
00434               sscanf(readbuf, <font class="stringliteral">"%d%d%d"</font>, &amp;(set-&gt;<a class="code" href="structmolfile__volumetric__t.html#m5">xsize</a>), &amp;(set-&gt;<a class="code" href="structmolfile__volumetric__t.html#m6">ysize</a>), &amp;(set-&gt;<a class="code" href="structmolfile__volumetric__t.html#m7">zsize</a>));
00435               fgets(readbuf, 256, xsf-&gt;<a class="code" href="structxsf__t.html#m0">fd</a>);
00436               sscanf(readbuf, <font class="stringliteral">"%f%f%f"</font>, &amp;(set-&gt;<a class="code" href="structmolfile__volumetric__t.html#m1">origin</a>[0]), &amp;(set-&gt;<a class="code" href="structmolfile__volumetric__t.html#m1">origin</a>[1]), &amp;(set-&gt;<a class="code" href="structmolfile__volumetric__t.html#m1">origin</a>[2]));
00437               fgets(readbuf, 256, xsf-&gt;<a class="code" href="structxsf__t.html#m0">fd</a>);
00438               sscanf(readbuf, <font class="stringliteral">"%f%f%f"</font>, &amp;a[0], &amp;a[1], &amp;a[2]);
00439               fgets(readbuf, 256, xsf-&gt;<a class="code" href="structxsf__t.html#m0">fd</a>);
00440               sscanf(readbuf, <font class="stringliteral">"%f%f%f"</font>, &amp;b[0], &amp;b[1], &amp;b[2]);
00441               fgets(readbuf, 256, xsf-&gt;<a class="code" href="structxsf__t.html#m0">fd</a>);
00442               sscanf(readbuf, <font class="stringliteral">"%f%f%f"</font>, &amp;c[0], &amp;c[1], &amp;c[2]);
00443               
00444               <font class="comment">// we need to fix up the size of the data points, since xsf file </font>
00445               <font class="comment">// store the data points at the borders on both sides.</font>
00446               -- set-&gt;<a class="code" href="structmolfile__volumetric__t.html#m5">xsize</a>; -- set-&gt;<a class="code" href="structmolfile__volumetric__t.html#m6">ysize</a>; -- set-&gt;<a class="code" href="structmolfile__volumetric__t.html#m7">zsize</a>;
00447 
00448               <font class="comment">// store the realigned axes.</font>
00449               <font class="keywordflow">for</font> (n=0; n&lt;3; ++n) {
00450                 set-&gt;<a class="code" href="structmolfile__volumetric__t.html#m2">xaxis</a>[n] = xsf-&gt;<a class="code" href="structxsf__t.html#m11">rotmat</a>[n][0] * a[0] 
00451                   + xsf-&gt;<a class="code" href="structxsf__t.html#m11">rotmat</a>[n][1] * a[1] + xsf-&gt;<a class="code" href="structxsf__t.html#m11">rotmat</a>[n][2] * a[2];
00452                 
00453                 set-&gt;<a class="code" href="structmolfile__volumetric__t.html#m3">yaxis</a>[n] = xsf-&gt;<a class="code" href="structxsf__t.html#m11">rotmat</a>[n][0] * b[0] 
00454                   + xsf-&gt;<a class="code" href="structxsf__t.html#m11">rotmat</a>[n][1] * b[1] + xsf-&gt;<a class="code" href="structxsf__t.html#m11">rotmat</a>[n][2] * b[2];
00455     
00456                 set-&gt;<a class="code" href="structmolfile__volumetric__t.html#m4">zaxis</a>[n] = xsf-&gt;<a class="code" href="structxsf__t.html#m11">rotmat</a>[n][0] * c[0] 
00457                   + xsf-&gt;<a class="code" href="structxsf__t.html#m11">rotmat</a>[n][1] * c[1] + xsf-&gt;<a class="code" href="structxsf__t.html#m11">rotmat</a>[n][2] * c[2];
00458               }
00459 
00460               <font class="keywordflow">do</font> { <font class="comment">// loop until we reach the end of the data set</font>
00461                 fgets(readbuf, 256, xsf-&gt;<a class="code" href="structxsf__t.html#m0">fd</a>);
00462               } <font class="keywordflow">while</font> (<a class="code" href="xsfplugin_8C.html#a47a17">xsf_END_3D_DATA</a> != <a class="code" href="xsfplugin_8C.html#a32">lookup_keyword</a>(readbuf));
00463 
00464 <font class="preprocessor">#if 1</font>
00465 <font class="preprocessor"></font>              <font class="comment">/*   as of VMD version 1.8.3, volumetric data points are </font>
00466 <font class="comment">               *   expected to represent the center of a grid box. xsf format </font>
00467 <font class="comment">               *   volumetric data represents the value at the edges of the </font>
00468 <font class="comment">               *   grid boxes, so we need to shift the internal origin by half </font>
00469 <font class="comment">               *   a grid box diagonal to have the data at the correct position </font>
00470 <font class="comment">               *   This will need to be changed again when the plugin interface</font>
00471 <font class="comment">               *   is updated to explicitly allow point/face-centered data sets.</font>
00472 <font class="comment">               */</font>
00473               set-&gt;<a class="code" href="structmolfile__volumetric__t.html#m1">origin</a>[0] -= 0.5 * ( set-&gt;<a class="code" href="structmolfile__volumetric__t.html#m2">xaxis</a>[0] / (double) set-&gt;<a class="code" href="structmolfile__volumetric__t.html#m5">xsize</a>
00474                                         + set-&gt;<a class="code" href="structmolfile__volumetric__t.html#m3">yaxis</a>[0] / (double) set-&gt;<a class="code" href="structmolfile__volumetric__t.html#m6">ysize</a>
00475                                         + set-&gt;<a class="code" href="structmolfile__volumetric__t.html#m4">zaxis</a>[0] / (double) set-&gt;<a class="code" href="structmolfile__volumetric__t.html#m7">zsize</a>);
00476               set-&gt;<a class="code" href="structmolfile__volumetric__t.html#m1">origin</a>[1] -= 0.5 * ( set-&gt;<a class="code" href="structmolfile__volumetric__t.html#m2">xaxis</a>[1] / (double) set-&gt;<a class="code" href="structmolfile__volumetric__t.html#m5">xsize</a>
00477                                         + set-&gt;<a class="code" href="structmolfile__volumetric__t.html#m3">yaxis</a>[1] / (double) set-&gt;<a class="code" href="structmolfile__volumetric__t.html#m6">ysize</a>
00478                                         + set-&gt;<a class="code" href="structmolfile__volumetric__t.html#m4">zaxis</a>[1] / (double) set-&gt;<a class="code" href="structmolfile__volumetric__t.html#m7">zsize</a>);
00479               set-&gt;<a class="code" href="structmolfile__volumetric__t.html#m1">origin</a>[2] -= 0.5 * ( set-&gt;<a class="code" href="structmolfile__volumetric__t.html#m2">xaxis</a>[2] / (double) set-&gt;<a class="code" href="structmolfile__volumetric__t.html#m5">xsize</a>
00480                                         + set-&gt;<a class="code" href="structmolfile__volumetric__t.html#m3">yaxis</a>[2] / (double) set-&gt;<a class="code" href="structmolfile__volumetric__t.html#m6">ysize</a>
00481                                         + set-&gt;<a class="code" href="structmolfile__volumetric__t.html#m4">zaxis</a>[2] / (double) set-&gt;<a class="code" href="structmolfile__volumetric__t.html#m7">zsize</a>);
00482 <font class="preprocessor">#endif</font>
00483 <font class="preprocessor"></font>            }
00484             <font class="keywordflow">break</font>;
00485 
00486             <font class="keywordflow">default</font>:
00487               <font class="keywordflow">break</font>;
00488           }
00489         } <font class="keywordflow">while</font> (<a class="code" href="xsfplugin_8C.html#a47a15">xsf_END_3D_BLOCK</a> != <a class="code" href="xsfplugin_8C.html#a32">lookup_keyword</a>(readbuf));
00490         
00491 <font class="preprocessor">#ifdef TEST_PLUGIN</font>
00492 <font class="preprocessor"></font>        fprintf(stderr, <font class="stringliteral">"found %d volumetric data sets\n"</font>, xsf-&gt;<a class="code" href="structxsf__t.html#m1">nvolsets</a>);
00493 <font class="preprocessor">#endif          </font>
00494 <font class="preprocessor"></font>        <font class="keywordflow">break</font>;
00495 
00496       <font class="keywordflow">case</font> <a class="code" href="xsfplugin_8C.html#a47a10">xsf_BEG_2D_BLOCK</a>:
00497         <font class="keywordflow">do</font> { <font class="comment">// skip over data</font>
00498           fgets(readbuf, 256, xsf-&gt;<a class="code" href="structxsf__t.html#m0">fd</a>);
00499         } <font class="keywordflow">while</font> (<a class="code" href="xsfplugin_8C.html#a47a11">xsf_END_2D_BLOCK</a> != <a class="code" href="xsfplugin_8C.html#a32">lookup_keyword</a>(readbuf));
00500         <font class="keywordflow">break</font>;
00501         
00502         <font class="comment">// periodicity encoding. needed for coordinate wrapping.</font>
00503       <font class="keywordflow">case</font> <a class="code" href="xsfplugin_8C.html#a47a23">xsf_MOLECULE</a>: <font class="comment">// fallthrough</font>
00504       <font class="keywordflow">case</font> <a class="code" href="xsfplugin_8C.html#a47a25">xsf_SLAB</a>:     <font class="comment">// fallthrough</font>
00505       <font class="keywordflow">case</font> <a class="code" href="xsfplugin_8C.html#a47a24">xsf_POLYMER</a>:  <font class="comment">// fallthrough</font>
00506       <font class="keywordflow">case</font> <a class="code" href="xsfplugin_8C.html#a47a26">xsf_CRYSTAL</a>:
00507         xsf-&gt;<a class="code" href="structxsf__t.html#m7">pbctype</a> = <a class="code" href="xsfplugin_8C.html#a3">kw</a>;
00508         <font class="keywordflow">break</font>;
00509 
00510       <font class="keywordflow">case</font> <a class="code" href="xsfplugin_8C.html#a47a7">xsf_COMMENT</a>:  <font class="comment">// fallthrough</font>
00511       <font class="keywordflow">case</font> <a class="code" href="xsfplugin_8C.html#a47a6">xsf_UNKNOWN</a>:  <font class="comment">// fallthrough</font>
00512       <font class="keywordflow">default</font>:                  <font class="comment">// ignore everything unknown</font>
00513         <font class="keywordflow">break</font>;
00514         
00515     }
00516   } <font class="keywordflow">while</font> (! (feof(xsf-&gt;<a class="code" href="structxsf__t.html#m0">fd</a>) || ferror(xsf-&gt;<a class="code" href="structxsf__t.html#m0">fd</a>)));
00517 <font class="preprocessor">#ifdef TEST_PLUGIN</font>
00518 <font class="preprocessor"></font>  fprintf(stderr, <font class="stringliteral">"total of %d coordinate sets\n"</font>, xsf-&gt;<a class="code" href="structxsf__t.html#m4">numsteps</a>);
00519 <font class="preprocessor">#endif</font>
00520 <font class="preprocessor"></font>  rewind(xsf-&gt;<a class="code" href="structxsf__t.html#m0">fd</a>);
00521   *natoms = xsf-&gt;<a class="code" href="structxsf__t.html#m2">numatoms</a>;
00522   <font class="keywordflow">return</font> xsf;
00523 }
00524 
00525   
<a name="l00526"></a><a class="code" href="xsfplugin_8C.html#a40">00526</a> <font class="keyword">static</font> <font class="keywordtype">int</font> <a class="code" href="xsfplugin_8C.html#a40">read_xsf_structure</a>(<font class="keywordtype">void</font> *v, <font class="keywordtype">int</font> *optflags, <a class="code" href="structmolfile__atom__t.html">molfile_atom_t</a> *atoms) {
00527   <font class="keywordtype">int</font> i;
00528   <a class="code" href="structxsf__t.html">xsf_t</a> *xsf = (<a class="code" href="structxsf__t.html">xsf_t</a> *)v;
00529 
00530   <font class="comment">// return immediately if there is no structure in this file.</font>
00531   <font class="keywordflow">if</font> (xsf-&gt;<a class="code" href="structxsf__t.html#m2">numatoms</a> &lt; 1) <font class="keywordflow">return</font> <a class="code" href="molfile__plugin_8h.html#a2">MOLFILE_SUCCESS</a>;
00532 
00533   
00534   <font class="comment">// go to beginning of file and find first set of coordinates</font>
00535   rewind(xsf-&gt;<a class="code" href="structxsf__t.html#m0">fd</a>);
00536 
00537   <font class="comment">// we loop until we have found, read and parsed the first </font>
00538   <font class="comment">// set of atomic coordinates. we only accept ATOMS and PRIMCOORD</font>
00539   <font class="comment">// sections. if we happen to find a PRIMVEC section, too, we use</font>
00540   <font class="comment">// that to set the default for animations.</font>
00541   <font class="keywordtype">char</font> readbuf[1024]; <font class="comment">// line buffer</font>
00542   <font class="keywordflow">do</font> {
00543     <font class="keywordflow">if</font> (NULL == fgets(readbuf, 256, xsf-&gt;<a class="code" href="structxsf__t.html#m0">fd</a>)) <font class="keywordflow">break</font>;
00544 
00545     <font class="keywordflow">switch</font> (<a class="code" href="xsfplugin_8C.html#a32">lookup_keyword</a>(readbuf)) {
00546 
00547       <font class="keywordflow">case</font> <a class="code" href="xsfplugin_8C.html#a47a29">xsf_PRIMCOORD</a>: <font class="comment">// number of atoms is in the next line. skip.</font>
00548         <a class="code" href="xsfplugin_8C.html#a36">eatline</a>(xsf-&gt;<a class="code" href="structxsf__t.html#m0">fd</a>);
00549         <font class="comment">// fallthrough</font>
00550       <font class="keywordflow">case</font> <a class="code" href="xsfplugin_8C.html#a47a20">xsf_ATOMS</a>: <font class="comment">// no specification for the number of atoms, </font>
00551                       <font class="comment">// we can use the same parser for both sections.</font>
00552 
00553         <font class="comment">/* we set atom mass and VDW radius from the PTE. */</font>
00554         *optflags = <a class="code" href="molfile__plugin_8h.html#a16">MOLFILE_ATOMICNUMBER</a> | <a class="code" href="molfile__plugin_8h.html#a12">MOLFILE_MASS</a> | <a class="code" href="molfile__plugin_8h.html#a14">MOLFILE_RADIUS</a>;
00555 
00556         <font class="keywordflow">for</font>(i=0; i&lt;xsf-&gt;<a class="code" href="structxsf__t.html#m2">numatoms</a>; ++i) {
00557           <font class="keywordtype">int</font> j;
00558           <font class="keywordtype">char</font> *k;
00559           <font class="keywordtype">float</font> coord;
00560           <a class="code" href="structmolfile__atom__t.html">molfile_atom_t</a> *atom;
00561 
00562           <font class="keywordtype">char</font> buffer[1024];
00563           k = fgets(readbuf, 1024, xsf-&gt;<a class="code" href="structxsf__t.html#m0">fd</a>);
00564           atom = atoms + i;
00565           j=sscanf(readbuf, <font class="stringliteral">"%s %f %f %f"</font>, buffer, &amp;coord, &amp;coord, &amp;coord);
00566           <font class="keywordflow">if</font> (k == NULL) {
00567             fprintf(stderr, <font class="stringliteral">"xsf structure) missing atom(s) in file '%s'\n"</font>,xsf-&gt;<a class="code" href="structxsf__t.html#m6">file_name</a>);
00568             fprintf(stderr, <font class="stringliteral">"xsf structure) expecting '%d' atoms, found only '%d'\n"</font>,xsf-&gt;<a class="code" href="structxsf__t.html#m2">numatoms</a>,i+1);
00569             <font class="keywordflow">return</font> <a class="code" href="molfile__plugin_8h.html#a4">MOLFILE_ERROR</a>;
00570           } <font class="keywordflow">else</font> <font class="keywordflow">if</font> (j &lt; 4) {
00571             fprintf(stderr, <font class="stringliteral">"xsf structure) missing type or coordinate(s) in file '%s' for atom '%d'\n"</font>,
00572                     xsf-&gt;<a class="code" href="structxsf__t.html#m6">file_name</a>, i+1);
00573             <font class="keywordflow">return</font> <a class="code" href="molfile__plugin_8h.html#a4">MOLFILE_ERROR</a>;
00574           }
00575 
00576           <font class="comment">/* handle the case if the first item is an ordinal number </font>
00577 <font class="comment">           * from the PTE */</font>
00578           <font class="keywordflow">if</font> (isdigit(buffer[0])) {
00579             <font class="keywordtype">int</font> idx;
00580             idx = atoi(buffer);
00581             strncpy(atom-&gt;<a class="code" href="structmolfile__atom__t.html#m0">name</a>, get_pte_label(idx), <font class="keyword">sizeof</font>(atom-&gt;<a class="code" href="structmolfile__atom__t.html#m0">name</a>));
00582             atom-&gt;<a class="code" href="structmolfile__atom__t.html#m13">atomicnumber</a> = idx;
00583             atom-&gt;<a class="code" href="structmolfile__atom__t.html#m10">mass</a> = <a class="code" href="periodic__table_8h.html#a5">get_pte_mass</a>(idx);
00584             atom-&gt;<a class="code" href="structmolfile__atom__t.html#m12">radius</a> = <a class="code" href="periodic__table_8h.html#a6">get_pte_vdw_radius</a>(idx);
00585           } <font class="keywordflow">else</font> {
00586             <font class="keywordtype">int</font> idx;
00587             strncpy(atom-&gt;<a class="code" href="structmolfile__atom__t.html#m0">name</a>, buffer, <font class="keyword">sizeof</font>(atom-&gt;<a class="code" href="structmolfile__atom__t.html#m0">name</a>));
00588             idx = <a class="code" href="periodic__table_8h.html#a7">get_pte_idx</a>(buffer);
00589             atom-&gt;<a class="code" href="structmolfile__atom__t.html#m13">atomicnumber</a> = idx;
00590             atom-&gt;<a class="code" href="structmolfile__atom__t.html#m10">mass</a> = <a class="code" href="periodic__table_8h.html#a5">get_pte_mass</a>(idx);
00591             atom-&gt;<a class="code" href="structmolfile__atom__t.html#m12">radius</a> = <a class="code" href="periodic__table_8h.html#a6">get_pte_vdw_radius</a>(idx);
00592           }
00593           strncpy(atom-&gt;<a class="code" href="structmolfile__atom__t.html#m1">type</a>, atom-&gt;<a class="code" href="structmolfile__atom__t.html#m0">name</a>, <font class="keyword">sizeof</font>(atom-&gt;<a class="code" href="structmolfile__atom__t.html#m1">type</a>));
00594           atom-&gt;<a class="code" href="structmolfile__atom__t.html#m2">resname</a>[0] = <font class="charliteral">'\0'</font>;
00595           atom-&gt;<a class="code" href="structmolfile__atom__t.html#m3">resid</a> = 1;
00596           atom-&gt;<a class="code" href="structmolfile__atom__t.html#m5">chain</a>[0] = <font class="charliteral">'\0'</font>;
00597           atom-&gt;<a class="code" href="structmolfile__atom__t.html#m4">segid</a>[0] = <font class="charliteral">'\0'</font>;
00598 <font class="preprocessor">#ifdef TEST_PLUGIN</font>
00599 <font class="preprocessor"></font>          fprintf(stderr,<font class="stringliteral">"xsf structure) atom %4d: %s  / mass= %f\n"</font>, i, atom-&gt;<a class="code" href="structmolfile__atom__t.html#m0">name</a>, atom-&gt;<a class="code" href="structmolfile__atom__t.html#m10">mass</a>);
00600 <font class="preprocessor">#endif</font>
00601 <font class="preprocessor"></font>        }
00602         
00603         <font class="comment">// ok. done. rewind once more and get the hell out of here.</font>
00604         rewind(xsf-&gt;<a class="code" href="structxsf__t.html#m0">fd</a>);
00605         <font class="keywordflow">return</font> <a class="code" href="molfile__plugin_8h.html#a2">MOLFILE_SUCCESS</a>;
00606         <font class="keywordflow">break</font>;
00607         
00608         <font class="comment">// read primitive cell info.</font>
00609       <font class="keywordflow">case</font> <a class="code" href="xsfplugin_8C.html#a47a27">xsf_PRIMVEC</a>: 
00610       {
00611         <font class="keywordtype">float</font> a[3], b[3], c[3];
00612 
00613         <font class="keywordflow">if</font> (<a class="code" href="xsfplugin_8C.html#a37">xsf_read_cell</a>(xsf-&gt;<a class="code" href="structxsf__t.html#m0">fd</a>, a, b, c)) { <font class="comment">// ignore unit cell info,if we cannot parse it.</font>
00614           <a class="code" href="xsfplugin_8C.html#a33">xsf_readbox</a>(&amp;(xsf-&gt;<a class="code" href="structxsf__t.html#m13">box</a>), a, b, c);
00615           <a class="code" href="xsfplugin_8C.html#a34">xsf_buildrotmat</a>(xsf, a, b);
00616           <font class="comment">// print warning, if the rotation will be significant:</font>
00617           <font class="keywordflow">if</font> ((fabs((<font class="keywordtype">double</font>) a[1]) + fabs((<font class="keywordtype">double</font>) a[2]) + fabs((<font class="keywordtype">double</font>) b[2]))
00618               &gt; 0.001) {
00619             fprintf(stderr, <font class="stringliteral">"xsfplugin) WARNING: Coordinates will be rotated to comply \n"</font>
00620                     <font class="stringliteral">"xsfplugin) with VMD's conventions for periodic display...\n"</font>);
00621           }
00622           <a class="code" href="xsfplugin_8C.html#a35">xsf_buildinvmat</a>(xsf, a, b, c);
00623 
00624 <font class="preprocessor">#if defined(TEST_PLUGIN)</font>
00625 <font class="preprocessor"></font>        printf(<font class="stringliteral">"cell vectors:\n"</font>);
00626         printf(<font class="stringliteral">"&lt;a&gt;: %12.8f %12.8f %12.8f\n"</font>, a[0], a[1], a[2]);
00627         printf(<font class="stringliteral">"&lt;b&gt;: %12.8f %12.8f %12.8f\n"</font>, b[0], b[1], b[2]);
00628         printf(<font class="stringliteral">"&lt;c&gt;: %12.8f %12.8f %12.8f\n"</font>, c[0], c[1], c[2]);
00629         printf(<font class="stringliteral">"cell dimensions:\n"</font>);
00630         printf(<font class="stringliteral">"a= %12.8f   b= %12.8f   c= %12.8f\n"</font>, xsf-&gt;<a class="code" href="structxsf__t.html#m13">box</a>.<a class="code" href="structxsf__box.html#m0">A</a>, xsf-&gt;<a class="code" href="structxsf__t.html#m13">box</a>.<a class="code" href="structxsf__box.html#m1">B</a>, xsf-&gt;<a class="code" href="structxsf__t.html#m13">box</a>.<a class="code" href="structxsf__box.html#m2">C</a>);
00631         printf(<font class="stringliteral">"alpha= %6.2f  beta= %6.2f  gamma= %6.2f\n"</font>, xsf-&gt;<a class="code" href="structxsf__t.html#m13">box</a>.<a class="code" href="structxsf__box.html#m3">alpha</a>, xsf-&gt;<a class="code" href="structxsf__t.html#m13">box</a>.<a class="code" href="structxsf__box.html#m4">beta</a>, xsf-&gt;<a class="code" href="structxsf__t.html#m13">box</a>.<a class="code" href="structxsf__box.html#m5">gamma</a>);
00632         printf(<font class="stringliteral">"reciprocal cell vectors:\n"</font>);
00633         printf(<font class="stringliteral">"i: %12.8f %12.8f %12.8f\n"</font>, xsf-&gt;<a class="code" href="structxsf__t.html#m12">invmat</a>[0][0], xsf-&gt;<a class="code" href="structxsf__t.html#m12">invmat</a>[0][1], xsf-&gt;<a class="code" href="structxsf__t.html#m12">invmat</a>[0][2]);
00634         printf(<font class="stringliteral">"k: %12.8f %12.8f %12.8f\n"</font>, xsf-&gt;<a class="code" href="structxsf__t.html#m12">invmat</a>[1][0], xsf-&gt;<a class="code" href="structxsf__t.html#m12">invmat</a>[1][1], xsf-&gt;<a class="code" href="structxsf__t.html#m12">invmat</a>[1][2]);
00635         printf(<font class="stringliteral">"l: %12.8f %12.8f %12.8f\n"</font>, xsf-&gt;<a class="code" href="structxsf__t.html#m12">invmat</a>[2][0], xsf-&gt;<a class="code" href="structxsf__t.html#m12">invmat</a>[2][1], xsf-&gt;<a class="code" href="structxsf__t.html#m12">invmat</a>[2][2]);
00636         printf(<font class="stringliteral">"cell rotation matrix:\n"</font>);
00637         printf(<font class="stringliteral">"x: %12.8f %12.8f %12.8f\n"</font>, xsf-&gt;<a class="code" href="structxsf__t.html#m11">rotmat</a>[0][0], xsf-&gt;<a class="code" href="structxsf__t.html#m11">rotmat</a>[0][1], xsf-&gt;<a class="code" href="structxsf__t.html#m11">rotmat</a>[0][2]);
00638         printf(<font class="stringliteral">"y: %12.8f %12.8f %12.8f\n"</font>, xsf-&gt;<a class="code" href="structxsf__t.html#m11">rotmat</a>[1][0], xsf-&gt;<a class="code" href="structxsf__t.html#m11">rotmat</a>[1][1], xsf-&gt;<a class="code" href="structxsf__t.html#m11">rotmat</a>[1][2]);
00639         printf(<font class="stringliteral">"z: %12.8f %12.8f %12.8f\n"</font>, xsf-&gt;<a class="code" href="structxsf__t.html#m11">rotmat</a>[2][0], xsf-&gt;<a class="code" href="structxsf__t.html#m11">rotmat</a>[2][1], xsf-&gt;<a class="code" href="structxsf__t.html#m11">rotmat</a>[2][2]);
00640 <font class="preprocessor">#endif</font>
00641 <font class="preprocessor"></font>        }
00642       }
00643       <font class="keywordflow">break</font>;
00644 
00645       <font class="keywordflow">default</font>:                  <font class="comment">// ignore everything unknown</font>
00646         <font class="keywordflow">break</font>;
00647     }
00648   } <font class="keywordflow">while</font> (! (feof(xsf-&gt;<a class="code" href="structxsf__t.html#m0">fd</a>) || ferror(xsf-&gt;<a class="code" href="structxsf__t.html#m0">fd</a>)));
00649 
00650   <font class="comment">// if we reach this point, some error must have happened.</font>
00651   <font class="keywordflow">return</font> <a class="code" href="molfile__plugin_8h.html#a4">MOLFILE_ERROR</a>;
00652 
00653 }
00654 
00655 
<a name="l00656"></a><a class="code" href="xsfplugin_8C.html#a41">00656</a> <font class="keyword">static</font> <font class="keywordtype">int</font> <a class="code" href="xsfplugin_8C.html#a41">read_xsf_timestep</a>(<font class="keywordtype">void</font> *v, <font class="keywordtype">int</font> natoms, <a class="code" href="structmolfile__timestep__t.html">molfile_timestep_t</a> *ts) {
00657   <font class="keywordtype">int</font> i;
00658   
00659   <a class="code" href="structxsf__t.html">xsf_t</a> *xsf = (<a class="code" href="structxsf__t.html">xsf_t</a> *)v;
00660 
00661   <font class="comment">// we loop until we have found, read and parsed the next.</font>
00662   <font class="comment">// set of atomic coordinates. we only accept ATOMS and PRIMCOORD</font>
00663   <font class="comment">// sections. if we happen to find a PRIMVEC section, too, we use</font>
00664   <font class="comment">// that to reset the cell parameters.</font>
00665 
00666   <font class="keywordtype">char</font> readbuf[1024]; <font class="comment">// line buffer</font>
00667   <font class="keywordflow">do</font> {
00668     <font class="keywordflow">if</font> (NULL == fgets(readbuf, 256, xsf-&gt;<a class="code" href="structxsf__t.html#m0">fd</a>)) <font class="keywordflow">break</font>;
00669 
00670     <font class="keywordflow">switch</font> (<a class="code" href="xsfplugin_8C.html#a32">lookup_keyword</a>(readbuf)) {
00671 
00672       <font class="keywordflow">case</font> <a class="code" href="xsfplugin_8C.html#a47a29">xsf_PRIMCOORD</a>: <font class="comment">// number of atoms is in the next line. skip.</font>
00673         <a class="code" href="xsfplugin_8C.html#a36">eatline</a>(xsf-&gt;<a class="code" href="structxsf__t.html#m0">fd</a>);
00674         <font class="comment">// fallthrough</font>
00675       <font class="keywordflow">case</font> <a class="code" href="xsfplugin_8C.html#a47a20">xsf_ATOMS</a>: <font class="comment">// no specification for the number of atoms, </font>
00676                       <font class="comment">// we can use the same parser for both sections.</font>
00677 
00678         <font class="keywordflow">for</font>(i=0; i&lt;natoms; ++i) {
00679           <font class="keywordtype">int</font> j, n;
00680           <font class="keywordtype">char</font> *k, buffer[1024];
00681           <font class="keywordtype">float</font> x, y, z;
00682           
00683           k = fgets(readbuf, 1024, xsf-&gt;<a class="code" href="structxsf__t.html#m0">fd</a>);
00684           j=sscanf(readbuf, <font class="stringliteral">"%s %f %f %f"</font>, buffer, &amp;x, &amp;y, &amp;z);
00685 
00686           <font class="keywordflow">if</font> (k == NULL) {
00687             <font class="keywordflow">return</font> <a class="code" href="molfile__plugin_8h.html#a4">MOLFILE_ERROR</a>;
00688           } <font class="keywordflow">else</font> <font class="keywordflow">if</font> (j &lt; 4) {
00689             fprintf(stderr, <font class="stringliteral">"xsf structure) missing type or coordinate(s) in file '%s' for atom '%d'\n"</font>,
00690                     xsf-&gt;<a class="code" href="structxsf__t.html#m6">file_name</a>, i+1);
00691             <font class="keywordflow">return</font> <a class="code" href="molfile__plugin_8h.html#a4">MOLFILE_ERROR</a>;
00692           } <font class="keywordflow">else</font> <font class="keywordflow">if</font> (j&gt;=3) {
00693             <font class="keywordflow">if</font> (ts != NULL) { 
00694               <font class="comment">// Only save coords if we're given a timestep pointer, </font>
00695               <font class="comment">// otherwise assume that VMD wants us to skip past it.</font>
00696               <font class="keywordtype">float</font> xf, yf, zf;
00697               
00698               <font class="comment">// apply periodic boundary conditions.</font>
00699 <font class="preprocessor">#ifdef TEST_PLUGIN</font>
00700 <font class="preprocessor"></font>                  printf(<font class="stringliteral">"wrap PBC: before: %12.6f %12.6f %12.6f\n"</font>, x, y, z);
00701 <font class="preprocessor">#endif                  </font>
00702 <font class="preprocessor"></font>              <font class="keywordflow">switch</font>(xsf-&gt;<a class="code" href="structxsf__t.html#m7">pbctype</a>) {
00703                 <font class="keywordflow">case</font> <a class="code" href="xsfplugin_8C.html#a47a26">xsf_CRYSTAL</a>:
00704                   xf = xsf-&gt;<a class="code" href="structxsf__t.html#m12">invmat</a>[0][0] * x + xsf-&gt;<a class="code" href="structxsf__t.html#m12">invmat</a>[0][1] * y + xsf-&gt;<a class="code" href="structxsf__t.html#m12">invmat</a>[0][2] * z;
00705                   xf = xf - floor((<font class="keywordtype">double</font>)xf);
00706                   yf = xsf-&gt;<a class="code" href="structxsf__t.html#m12">invmat</a>[1][0] * x + xsf-&gt;<a class="code" href="structxsf__t.html#m12">invmat</a>[1][1] * y + xsf-&gt;<a class="code" href="structxsf__t.html#m12">invmat</a>[1][2] * z;
00707                   yf = yf - floor((<font class="keywordtype">double</font>)yf);
00708                   zf = xsf-&gt;<a class="code" href="structxsf__t.html#m12">invmat</a>[2][0] * x + xsf-&gt;<a class="code" href="structxsf__t.html#m12">invmat</a>[2][1] * y + xsf-&gt;<a class="code" href="structxsf__t.html#m12">invmat</a>[2][2] * z;
00709                   zf = zf - floor((<font class="keywordtype">double</font>)zf);
00710                   x = xsf-&gt;<a class="code" href="structxsf__t.html#m13">box</a>.<a class="code" href="structxsf__box.html#m6">cell</a>[0][0] * xf + xsf-&gt;<a class="code" href="structxsf__t.html#m13">box</a>.<a class="code" href="structxsf__box.html#m6">cell</a>[0][1] * yf + xsf-&gt;<a class="code" href="structxsf__t.html#m13">box</a>.<a class="code" href="structxsf__box.html#m6">cell</a>[0][2] * zf;
00711                   y = xsf-&gt;<a class="code" href="structxsf__t.html#m13">box</a>.<a class="code" href="structxsf__box.html#m6">cell</a>[1][0] * xf + xsf-&gt;<a class="code" href="structxsf__t.html#m13">box</a>.<a class="code" href="structxsf__box.html#m6">cell</a>[1][1] * yf + xsf-&gt;<a class="code" href="structxsf__t.html#m13">box</a>.<a class="code" href="structxsf__box.html#m6">cell</a>[1][2] * zf;
00712                   z = xsf-&gt;<a class="code" href="structxsf__t.html#m13">box</a>.<a class="code" href="structxsf__box.html#m6">cell</a>[2][0] * xf + xsf-&gt;<a class="code" href="structxsf__t.html#m13">box</a>.<a class="code" href="structxsf__box.html#m6">cell</a>[2][1] * yf + xsf-&gt;<a class="code" href="structxsf__t.html#m13">box</a>.<a class="code" href="structxsf__box.html#m6">cell</a>[2][2] * zf;
00713                   <font class="keywordflow">break</font>;
00714 
00715                 <font class="keywordflow">case</font> <a class="code" href="xsfplugin_8C.html#a47a25">xsf_SLAB</a>:
00716                   xf = xsf-&gt;<a class="code" href="structxsf__t.html#m12">invmat</a>[0][0] * x + xsf-&gt;<a class="code" href="structxsf__t.html#m12">invmat</a>[0][1] * y + xsf-&gt;<a class="code" href="structxsf__t.html#m12">invmat</a>[0][2] * z;
00717                   xf = xf - floor((<font class="keywordtype">double</font>)xf);
00718                   yf = xsf-&gt;<a class="code" href="structxsf__t.html#m12">invmat</a>[1][0] * x + xsf-&gt;<a class="code" href="structxsf__t.html#m12">invmat</a>[1][1] * y + xsf-&gt;<a class="code" href="structxsf__t.html#m12">invmat</a>[1][2] * z;
00719                   yf = yf - floor((<font class="keywordtype">double</font>)yf);
00720                   zf = xsf-&gt;<a class="code" href="structxsf__t.html#m12">invmat</a>[2][0] * x + xsf-&gt;<a class="code" href="structxsf__t.html#m12">invmat</a>[2][1] * y + xsf-&gt;<a class="code" href="structxsf__t.html#m12">invmat</a>[2][2] * z;
00721                   x = xsf-&gt;<a class="code" href="structxsf__t.html#m13">box</a>.<a class="code" href="structxsf__box.html#m6">cell</a>[0][0] * xf + xsf-&gt;<a class="code" href="structxsf__t.html#m13">box</a>.<a class="code" href="structxsf__box.html#m6">cell</a>[0][1] * yf + xsf-&gt;<a class="code" href="structxsf__t.html#m13">box</a>.<a class="code" href="structxsf__box.html#m6">cell</a>[0][2] * zf;
00722                   y = xsf-&gt;<a class="code" href="structxsf__t.html#m13">box</a>.<a class="code" href="structxsf__box.html#m6">cell</a>[1][0] * xf + xsf-&gt;<a class="code" href="structxsf__t.html#m13">box</a>.<a class="code" href="structxsf__box.html#m6">cell</a>[1][1] * yf + xsf-&gt;<a class="code" href="structxsf__t.html#m13">box</a>.<a class="code" href="structxsf__box.html#m6">cell</a>[1][2] * zf;
00723                   z = xsf-&gt;<a class="code" href="structxsf__t.html#m13">box</a>.<a class="code" href="structxsf__box.html#m6">cell</a>[2][0] * xf + xsf-&gt;<a class="code" href="structxsf__t.html#m13">box</a>.<a class="code" href="structxsf__box.html#m6">cell</a>[2][1] * yf + xsf-&gt;<a class="code" href="structxsf__t.html#m13">box</a>.<a class="code" href="structxsf__box.html#m6">cell</a>[2][2] * zf;
00724                   <font class="keywordflow">break</font>;
00725                   
00726                 <font class="keywordflow">case</font> <a class="code" href="xsfplugin_8C.html#a47a24">xsf_POLYMER</a>:
00727                   xf = xsf-&gt;<a class="code" href="structxsf__t.html#m12">invmat</a>[0][0] * x + xsf-&gt;<a class="code" href="structxsf__t.html#m12">invmat</a>[0][1] * y + xsf-&gt;<a class="code" href="structxsf__t.html#m12">invmat</a>[0][2] * z;
00728                   xf = xf - floor((<font class="keywordtype">double</font>)xf);
00729                   yf = xsf-&gt;<a class="code" href="structxsf__t.html#m12">invmat</a>[1][0] * x + xsf-&gt;<a class="code" href="structxsf__t.html#m12">invmat</a>[1][1] * y + xsf-&gt;<a class="code" href="structxsf__t.html#m12">invmat</a>[1][2] * z;
00730                   zf = xsf-&gt;<a class="code" href="structxsf__t.html#m12">invmat</a>[2][0] * x + xsf-&gt;<a class="code" href="structxsf__t.html#m12">invmat</a>[2][1] * y + xsf-&gt;<a class="code" href="structxsf__t.html#m12">invmat</a>[2][2] * z;
00731                   x = xsf-&gt;<a class="code" href="structxsf__t.html#m13">box</a>.<a class="code" href="structxsf__box.html#m6">cell</a>[0][0] * xf + xsf-&gt;<a class="code" href="structxsf__t.html#m13">box</a>.<a class="code" href="structxsf__box.html#m6">cell</a>[0][1] * yf + xsf-&gt;<a class="code" href="structxsf__t.html#m13">box</a>.<a class="code" href="structxsf__box.html#m6">cell</a>[0][2] * zf;
00732                   y = xsf-&gt;<a class="code" href="structxsf__t.html#m13">box</a>.<a class="code" href="structxsf__box.html#m6">cell</a>[1][0] * xf + xsf-&gt;<a class="code" href="structxsf__t.html#m13">box</a>.<a class="code" href="structxsf__box.html#m6">cell</a>[1][1] * yf + xsf-&gt;<a class="code" href="structxsf__t.html#m13">box</a>.<a class="code" href="structxsf__box.html#m6">cell</a>[1][2] * zf;
00733                   z = xsf-&gt;<a class="code" href="structxsf__t.html#m13">box</a>.<a class="code" href="structxsf__box.html#m6">cell</a>[2][0] * xf + xsf-&gt;<a class="code" href="structxsf__t.html#m13">box</a>.<a class="code" href="structxsf__box.html#m6">cell</a>[2][1] * yf + xsf-&gt;<a class="code" href="structxsf__t.html#m13">box</a>.<a class="code" href="structxsf__box.html#m6">cell</a>[2][2] * zf;
00734                   <font class="keywordflow">break</font>;
00735                   
00736                 <font class="keywordflow">case</font> <a class="code" href="xsfplugin_8C.html#a47a23">xsf_MOLECULE</a>:
00737                   xf = x;
00738                   yf = y;
00739                   zf = z;
00740                   <font class="keywordflow">break</font>;
00741                   
00742                 <font class="keywordflow">default</font>:
00743                   <font class="keywordflow">break</font>;
00744               }
00745               
00746 <font class="preprocessor">#ifdef TEST_PLUGIN</font>
00747 <font class="preprocessor"></font>                  printf(<font class="stringliteral">"wrap PBC: fract:  %12.6f %12.6f %12.6f\n"</font>, xf, yf, zf);
00748                   printf(<font class="stringliteral">"wrap PBC: after: %12.6f %12.6f %12.6f\n"</font>, x, y, z);
00749 <font class="preprocessor">#endif                  </font>
00750 <font class="preprocessor"></font>
00751               <font class="comment">// In order to make the periodic display work, we need to</font>
00752               <font class="comment">// rotate the coordinates around the origin by the stored</font>
00753               <font class="comment">// rotation matrix. for xsf files the origin is not explicitely</font>
00754               <font class="comment">// so far, but since it is already initialized to (0,0,0) it</font>
00755               <font class="comment">// does no harm, to leave it in here.</font>
00756               x -= xsf-&gt;<a class="code" href="structxsf__t.html#m10">origin</a>[0];
00757               y -= xsf-&gt;<a class="code" href="structxsf__t.html#m10">origin</a>[1];
00758               z -= xsf-&gt;<a class="code" href="structxsf__t.html#m10">origin</a>[2];
00759         
00760               <font class="keywordflow">for</font> (n=0; n&lt;3; ++n) {
00761                 ts-&gt;<a class="code" href="structmolfile__timestep__t.html#m0">coords</a>[3*i + n] = (xsf-&gt;<a class="code" href="structxsf__t.html#m10">origin</a>[n] + xsf-&gt;<a class="code" href="structxsf__t.html#m11">rotmat</a>[n][0] * x
00762                                        + xsf-&gt;<a class="code" href="structxsf__t.html#m11">rotmat</a>[n][1] * y + xsf-&gt;<a class="code" href="structxsf__t.html#m11">rotmat</a>[n][2] * z);
00763               }
00764             }
00765           } <font class="keywordflow">else</font> {
00766             <font class="keywordflow">break</font>;
00767           }
00768         }
00769         <font class="comment">// (re-)set unitcell dimensions</font>
00770         <font class="keywordflow">if</font> (ts != NULL) { 
00771           ts-&gt;<a class="code" href="structmolfile__timestep__t.html#z4_0">A</a> = xsf-&gt;<a class="code" href="structxsf__t.html#m13">box</a>.<a class="code" href="structxsf__box.html#m0">A</a>;
00772           ts-&gt;<a class="code" href="structmolfile__timestep__t.html#z4_1">B</a> = xsf-&gt;<a class="code" href="structxsf__t.html#m13">box</a>.<a class="code" href="structxsf__box.html#m1">B</a>;
00773           ts-&gt;<a class="code" href="structmolfile__timestep__t.html#z4_2">C</a> = xsf-&gt;<a class="code" href="structxsf__t.html#m13">box</a>.<a class="code" href="structxsf__box.html#m2">C</a>;
00774           ts-&gt;<a class="code" href="structmolfile__timestep__t.html#z4_3">alpha</a> = xsf-&gt;<a class="code" href="structxsf__t.html#m13">box</a>.<a class="code" href="structxsf__box.html#m3">alpha</a>;
00775           ts-&gt;<a class="code" href="structmolfile__timestep__t.html#z4_4">beta</a>  = xsf-&gt;<a class="code" href="structxsf__t.html#m13">box</a>.<a class="code" href="structxsf__box.html#m4">beta</a>;
00776           ts-&gt;<a class="code" href="structmolfile__timestep__t.html#z4_5">gamma</a> = xsf-&gt;<a class="code" href="structxsf__t.html#m13">box</a>.<a class="code" href="structxsf__box.html#m5">gamma</a>;
00777         }
00778   
00779         <font class="keywordflow">return</font> <a class="code" href="molfile__plugin_8h.html#a2">MOLFILE_SUCCESS</a>;
00780         <font class="keywordflow">break</font>;
00781         
00782         <font class="comment">// read and update primitive cell info.</font>
00783       <font class="keywordflow">case</font> <a class="code" href="xsfplugin_8C.html#a47a27">xsf_PRIMVEC</a>: 
00784       {
00785         <font class="keywordtype">float</font> a[3], b[3], c[3];
00786         
00787         <font class="keywordflow">if</font> (<a class="code" href="xsfplugin_8C.html#a37">xsf_read_cell</a>(xsf-&gt;<a class="code" href="structxsf__t.html#m0">fd</a>, a, b, c)) {
00788           <a class="code" href="xsfplugin_8C.html#a33">xsf_readbox</a>(&amp;(xsf-&gt;<a class="code" href="structxsf__t.html#m13">box</a>), a,b,c);
00789           <a class="code" href="xsfplugin_8C.html#a34">xsf_buildrotmat</a>(xsf, a, b);
00790           <font class="comment">// print warning, if the rotation will be significant:</font>
00791           <font class="keywordflow">if</font> ((fabs((<font class="keywordtype">double</font>) a[1]) + fabs((<font class="keywordtype">double</font>) a[2]) + fabs((<font class="keywordtype">double</font>) b[2]))
00792               &gt; 0.001) {
00793             fprintf(stderr, <font class="stringliteral">"xsfplugin) WARNING: Coordinates will be rotated to comply \n"</font>
00794                     <font class="stringliteral">"xsfplugin) with VMD's conventions for periodic display...\n"</font>);
00795           }
00796           <a class="code" href="xsfplugin_8C.html#a35">xsf_buildinvmat</a>(xsf, a, b, c);
00797 
00798 <font class="preprocessor">#if defined(TEST_PLUGIN)</font>
00799 <font class="preprocessor"></font>        printf(<font class="stringliteral">"new cell vectors:\n"</font>);
00800         printf(<font class="stringliteral">"&lt;a&gt;: %12.8f %12.8f %12.8f\n"</font>, a[0], a[1], a[2]);
00801         printf(<font class="stringliteral">"&lt;b&gt;: %12.8f %12.8f %12.8f\n"</font>, b[0], b[1], b[2]);
00802         printf(<font class="stringliteral">"&lt;c&gt;: %12.8f %12.8f %12.8f\n"</font>, c[0], c[1], c[2]);
00803         printf(<font class="stringliteral">"new cell dimensions:\n"</font>);
00804         printf(<font class="stringliteral">"a= %12.8f   b= %12.8f   c= %12.8f\n"</font>, xsf-&gt;<a class="code" href="structxsf__t.html#m13">box</a>.<a class="code" href="structxsf__box.html#m0">A</a>, xsf-&gt;<a class="code" href="structxsf__t.html#m13">box</a>.<a class="code" href="structxsf__box.html#m1">B</a>, xsf-&gt;<a class="code" href="structxsf__t.html#m13">box</a>.<a class="code" href="structxsf__box.html#m2">C</a>);
00805         printf(<font class="stringliteral">"alpha= %6.2f  beta= %6.2f  gamma= %6.2f\n"</font>, xsf-&gt;<a class="code" href="structxsf__t.html#m13">box</a>.<a class="code" href="structxsf__box.html#m3">alpha</a>, xsf-&gt;<a class="code" href="structxsf__t.html#m13">box</a>.<a class="code" href="structxsf__box.html#m4">beta</a>, xsf-&gt;<a class="code" href="structxsf__t.html#m13">box</a>.<a class="code" href="structxsf__box.html#m5">gamma</a>);
00806         printf(<font class="stringliteral">"new reciprocal cell vectors:\n"</font>);
00807         printf(<font class="stringliteral">"i: %12.8f %12.8f %12.8f\n"</font>, xsf-&gt;<a class="code" href="structxsf__t.html#m12">invmat</a>[0][0], xsf-&gt;<a class="code" href="structxsf__t.html#m12">invmat</a>[0][1], xsf-&gt;<a class="code" href="structxsf__t.html#m12">invmat</a>[0][2]);
00808         printf(<font class="stringliteral">"k: %12.8f %12.8f %12.8f\n"</font>, xsf-&gt;<a class="code" href="structxsf__t.html#m12">invmat</a>[1][0], xsf-&gt;<a class="code" href="structxsf__t.html#m12">invmat</a>[1][1], xsf-&gt;<a class="code" href="structxsf__t.html#m12">invmat</a>[1][2]);
00809         printf(<font class="stringliteral">"l: %12.8f %12.8f %12.8f\n"</font>, xsf-&gt;<a class="code" href="structxsf__t.html#m12">invmat</a>[2][0], xsf-&gt;<a class="code" href="structxsf__t.html#m12">invmat</a>[2][1], xsf-&gt;<a class="code" href="structxsf__t.html#m12">invmat</a>[2][2]);
00810         printf(<font class="stringliteral">"new cell rotation matrix:\n"</font>);
00811         printf(<font class="stringliteral">"x: %12.8f %12.8f %12.8f\n"</font>, xsf-&gt;<a class="code" href="structxsf__t.html#m11">rotmat</a>[0][0], xsf-&gt;<a class="code" href="structxsf__t.html#m11">rotmat</a>[0][1], xsf-&gt;<a class="code" href="structxsf__t.html#m11">rotmat</a>[0][2]);
00812         printf(<font class="stringliteral">"y: %12.8f %12.8f %12.8f\n"</font>, xsf-&gt;<a class="code" href="structxsf__t.html#m11">rotmat</a>[1][0], xsf-&gt;<a class="code" href="structxsf__t.html#m11">rotmat</a>[1][1], xsf-&gt;<a class="code" href="structxsf__t.html#m11">rotmat</a>[1][2]);
00813         printf(<font class="stringliteral">"z: %12.8f %12.8f %12.8f\n"</font>, xsf-&gt;<a class="code" href="structxsf__t.html#m11">rotmat</a>[2][0], xsf-&gt;<a class="code" href="structxsf__t.html#m11">rotmat</a>[2][1], xsf-&gt;<a class="code" href="structxsf__t.html#m11">rotmat</a>[2][2]);
00814 <font class="preprocessor">#endif</font>
00815 <font class="preprocessor"></font>        }
00816       }
00817       <font class="keywordflow">break</font>;
00818 
00819       <font class="keywordflow">default</font>:                  <font class="comment">// ignore everything unknown</font>
00820         <font class="keywordflow">break</font>;
00821     }
00822   } <font class="keywordflow">while</font> (! (feof(xsf-&gt;<a class="code" href="structxsf__t.html#m0">fd</a>) || ferror(xsf-&gt;<a class="code" href="structxsf__t.html#m0">fd</a>)));
00823 
00824   <font class="comment">// if we reach this point, some error must have happened.</font>
00825   <font class="keywordflow">return</font> <a class="code" href="molfile__plugin_8h.html#a4">MOLFILE_ERROR</a>;
00826 }
00827 
<a name="l00828"></a><a class="code" href="xsfplugin_8C.html#a42">00828</a> <font class="keyword">static</font> <font class="keywordtype">int</font> <a class="code" href="xsfplugin_8C.html#a42">read_xsf_metadata</a>(<font class="keywordtype">void</font> *v, <font class="keywordtype">int</font> *nvolsets, 
00829   <a class="code" href="structmolfile__volumetric__t.html">molfile_volumetric_t</a> **metadata) {
00830   <a class="code" href="structxsf__t.html">xsf_t</a> *xsf = (<a class="code" href="structxsf__t.html">xsf_t</a> *)v;
00831   *nvolsets = xsf-&gt;<a class="code" href="structxsf__t.html#m1">nvolsets</a>; 
00832   *metadata = xsf-&gt;<a class="code" href="structxsf__t.html#m8">vol</a>;  
00833 
00834   <font class="keywordflow">return</font> <a class="code" href="molfile__plugin_8h.html#a2">MOLFILE_SUCCESS</a>;
00835 }
00836 
<a name="l00837"></a><a class="code" href="xsfplugin_8C.html#a43">00837</a> <font class="keyword">static</font> <font class="keywordtype">int</font> <a class="code" href="xsfplugin_8C.html#a43">read_xsf_data</a>(<font class="keywordtype">void</font> *v, <font class="keywordtype">int</font> set, <font class="keywordtype">float</font> *datablock, <font class="keywordtype">float</font> *colorblock) {
00838   <a class="code" href="structxsf__t.html">xsf_t</a> *xsf = (<a class="code" href="structxsf__t.html">xsf_t</a> *)v;
00839   <font class="keyword">const</font> <font class="keywordtype">char</font> *block = xsf-&gt;<a class="code" href="structxsf__t.html#m8">vol</a>[set].<a class="code" href="structmolfile__volumetric__t.html#m0">dataname</a>;
00840   
00841   fprintf(stderr, <font class="stringliteral">"xsfplugin) trying to read xsf data set %d: %s\n"</font>, set, block);
00842   
00843   <font class="keywordtype">int</font> xsize = xsf-&gt;<a class="code" href="structxsf__t.html#m8">vol</a>[set].<a class="code" href="structmolfile__volumetric__t.html#m5">xsize</a>; 
00844   <font class="keywordtype">int</font> ysize = xsf-&gt;<a class="code" href="structxsf__t.html#m8">vol</a>[set].<a class="code" href="structmolfile__volumetric__t.html#m6">ysize</a>;
00845   <font class="keywordtype">int</font> zsize = xsf-&gt;<a class="code" href="structxsf__t.html#m8">vol</a>[set].<a class="code" href="structmolfile__volumetric__t.html#m7">zsize</a>;
00846   <font class="keywordtype">int</font> x, y, z;
00847   <font class="keywordtype">int</font> n;
00848   <font class="keywordtype">char</font> readbuf[1024];
00849   <font class="keywordtype">float</font> dummy;
00850   
00851   <font class="comment">// find data set ...</font>
00852   rewind(xsf-&gt;<a class="code" href="structxsf__t.html#m0">fd</a>);
00853   <font class="keywordflow">do</font> {
00854     <font class="keywordflow">if</font> (NULL == fgets(readbuf, 1024, xsf-&gt;<a class="code" href="structxsf__t.html#m0">fd</a>)) <font class="keywordflow">return</font> <a class="code" href="molfile__plugin_8h.html#a4">MOLFILE_ERROR</a>;
00855   } <font class="keywordflow">while</font> (strncmp(readbuf, block, 1024));
00856   <font class="comment">// ... and skip five more lines to get to the beginning of the data</font>
00857   <a class="code" href="xsfplugin_8C.html#a36">eatline</a>(xsf-&gt;<a class="code" href="structxsf__t.html#m0">fd</a>);
00858   <a class="code" href="xsfplugin_8C.html#a36">eatline</a>(xsf-&gt;<a class="code" href="structxsf__t.html#m0">fd</a>);
00859   <a class="code" href="xsfplugin_8C.html#a36">eatline</a>(xsf-&gt;<a class="code" href="structxsf__t.html#m0">fd</a>);
00860   <a class="code" href="xsfplugin_8C.html#a36">eatline</a>(xsf-&gt;<a class="code" href="structxsf__t.html#m0">fd</a>);
00861   <a class="code" href="xsfplugin_8C.html#a36">eatline</a>(xsf-&gt;<a class="code" href="structxsf__t.html#m0">fd</a>);
00862   
00863   <font class="comment">// read in the data values</font>
00864   <font class="comment">// XSF data grids include the points at the border on both sides,</font>
00865   <font class="comment">// so we have to read and skip over those on one of them.</font>
00866   n = 0;
00867   <font class="keywordflow">for</font> (z=0; z&lt;zsize+1; z++) {
00868     <font class="keywordflow">for</font> (y=0; y&lt;ysize+1; y++) {
00869       <font class="keywordflow">for</font> (x=0; x&lt;xsize+1; x++) {
00870         <font class="keywordflow">if</font>((x&gt;=xsize) || (y&gt;=ysize) || (z&gt;=zsize)) { 
00871           <font class="keywordflow">if</font> (fscanf(xsf-&gt;<a class="code" href="structxsf__t.html#m0">fd</a>, <font class="stringliteral">"%f"</font>, &amp;dummy) != 1) <font class="keywordflow">return</font> <a class="code" href="molfile__plugin_8h.html#a4">MOLFILE_ERROR</a>;
00872         } <font class="keywordflow">else</font> {
00873           <font class="keywordflow">if</font> (fscanf(xsf-&gt;<a class="code" href="structxsf__t.html#m0">fd</a>, <font class="stringliteral">"%f"</font>, &amp;datablock[n]) != 1) <font class="keywordflow">return</font> <a class="code" href="molfile__plugin_8h.html#a4">MOLFILE_ERROR</a>;
00874           ++ n;
00875         }
00876       }
00877     }
00878   }
00879   rewind(xsf-&gt;<a class="code" href="structxsf__t.html#m0">fd</a>);
00880   <font class="keywordflow">return</font> <a class="code" href="molfile__plugin_8h.html#a2">MOLFILE_SUCCESS</a>;
00881 }
00882 
<a name="l00883"></a><a class="code" href="xsfplugin_8C.html#a38">00883</a> <font class="keyword">static</font> <font class="keywordtype">void</font> <a class="code" href="xsfplugin_8C.html#a38">close_xsf_read</a>(<font class="keywordtype">void</font> *v) {
00884   <a class="code" href="structxsf__t.html">xsf_t</a> *xsf = (<a class="code" href="structxsf__t.html">xsf_t</a> *)v;
00885 
00886   fclose(xsf-&gt;<a class="code" href="structxsf__t.html#m0">fd</a>);
00887   <font class="keywordflow">if</font> (xsf-&gt;<a class="code" href="structxsf__t.html#m8">vol</a>) {
00888     <font class="keyword">delete</font>[] xsf-&gt;<a class="code" href="structxsf__t.html#m8">vol</a>; 
00889   }
00890   free(xsf-&gt;<a class="code" href="structxsf__t.html#m6">file_name</a>);
00891   <font class="keyword">delete</font> xsf;
00892 }
00893 
00894 <font class="comment">/*</font>
00895 <font class="comment"> * Initialization stuff here</font>
00896 <font class="comment"> */</font>
<a name="l00897"></a><a class="code" href="xsfplugin_8C.html#a5">00897</a> <font class="keyword">static</font> <a class="code" href="structmolfile__plugin__t.html">molfile_plugin_t</a> <a class="code" href="xsfplugin_8C.html#a5">plugin</a> = {
00898   <a class="code" href="vmdplugin_8h.html#a10">vmdplugin_ABIVERSION</a>,   <font class="comment">// ABI version</font>
00899   <a class="code" href="molfile__plugin_8h.html#a0">MOLFILE_PLUGIN_TYPE</a>,    <font class="comment">// plugin type</font>
00900   <font class="stringliteral">"xsf"</font>,                  <font class="comment">// file format description</font>
00901   <font class="stringliteral">"XSF"</font>,                  <font class="comment">// file format description</font>
00902   <font class="stringliteral">"Axel Kohlmeyer, John E. Stone"</font>, <font class="comment">// author(s)</font>
00903   0,                      <font class="comment">// major version</font>
00904   5,                      <font class="comment">// minor version</font>
00905   <a class="code" href="vmdplugin_8h.html#a12">VMDPLUGIN_THREADSAFE</a>,   <font class="comment">// is reentrant</font>
00906   <font class="stringliteral">"xsf"</font>,                  <font class="comment">// filename extension</font>
00907   <a class="code" href="xsfplugin_8C.html#a39">open_xsf_read</a>,               
00908   <a class="code" href="xsfplugin_8C.html#a40">read_xsf_structure</a>,
00909   0,                      <font class="comment">// read_bonds</font>
00910   <a class="code" href="xsfplugin_8C.html#a41">read_xsf_timestep</a>,
00911   <a class="code" href="xsfplugin_8C.html#a38">close_xsf_read</a>,
00912   0,                      <font class="comment">// open_file_write</font>
00913   0,                      <font class="comment">// write_structure</font>
00914   0,                      <font class="comment">// write_timestep</font>
00915   0,                      <font class="comment">// close_file_write</font>
00916   <a class="code" href="xsfplugin_8C.html#a42">read_xsf_metadata</a>,
00917   <a class="code" href="xsfplugin_8C.html#a43">read_xsf_data</a>,
00918   0                       <font class="comment">// read_rawgraphics</font>
00919 };
00920 
<a name="l00921"></a><a class="code" href="xsfplugin_8C.html#a44">00921</a> <a class="code" href="vmdplugin_8h.html#a7">VMDPLUGIN_API</a> <font class="keywordtype">int</font> <a class="code" href="vmdplugin_8h.html#a5">VMDPLUGIN_init</a>(<font class="keywordtype">void</font>) { <font class="keywordflow">return</font> <a class="code" href="vmdplugin_8h.html#a13">VMDPLUGIN_SUCCESS</a>; }
<a name="l00922"></a><a class="code" href="xsfplugin_8C.html#a45">00922</a> <a class="code" href="vmdplugin_8h.html#a7">VMDPLUGIN_API</a> <font class="keywordtype">int</font> <a class="code" href="vmdplugin_8h.html#a6">VMDPLUGIN_fini</a>(<font class="keywordtype">void</font>) { <font class="keywordflow">return</font> <a class="code" href="vmdplugin_8h.html#a13">VMDPLUGIN_SUCCESS</a>; }
<a name="l00923"></a><a class="code" href="xsfplugin_8C.html#a46">00923</a> <a class="code" href="vmdplugin_8h.html#a7">VMDPLUGIN_API</a> <font class="keywordtype">int</font> <a class="code" href="vmdplugin_8h.html#a3">VMDPLUGIN_register</a>(<font class="keywordtype">void</font> *v, <a class="code" href="vmdplugin_8h.html#a15">vmdplugin_register_cb</a> cb) {
00924   (*cb)(v, (<a class="code" href="structvmdplugin__t.html">vmdplugin_t</a> *)&amp;plugin);
00925   <font class="keywordflow">return</font> <a class="code" href="vmdplugin_8h.html#a13">VMDPLUGIN_SUCCESS</a>;
00926 }
00927 
00928 
00929 
00930 <font class="preprocessor">#ifdef TEST_PLUGIN</font>
00931 <font class="preprocessor"></font>
00932 <font class="keywordtype">int</font> <a class="code" href="main_8c.html#a3">main</a>(<font class="keywordtype">int</font> argc, <font class="keywordtype">char</font> *argv[]) {
00933   <font class="keywordtype">int</font> natoms, optflags;
00934   <font class="keywordtype">void</font> *v;
00935   <font class="keywordtype">int</font> i, nvolsets, set;
00936   <a class="code" href="structmolfile__volumetric__t.html">molfile_volumetric_t</a> * meta;
00937 
00938 
00939   printf(<font class="stringliteral">"got index: %d\n"</font>, <a class="code" href="xsfplugin_8C.html#a32">lookup_keyword</a>(<font class="stringliteral">"     ATOMS  "</font>));
00940   
00941   <font class="keywordflow">while</font> (--argc) {
00942     ++argv;
00943     v = <a class="code" href="xsfplugin_8C.html#a39">open_xsf_read</a>(*argv, <font class="stringliteral">"xsf"</font>, &amp;natoms);
00944     <font class="keywordflow">if</font> (!v) {
00945       fprintf(stderr, <font class="stringliteral">"open_xsf_read failed for file %s\n"</font>, *argv);
00946       <font class="keywordflow">return</font> 1;
00947     }
00948     fprintf(stderr, <font class="stringliteral">"open_xsf_read succeeded for file %s\n"</font>, *argv);
00949     fprintf(stderr, <font class="stringliteral">"input contains %d atoms\n"</font>, natoms);
00950 
00951     <a class="code" href="structmolfile__atom__t.html">molfile_atom_t</a> atoms[natoms];
00952     
00953     <font class="comment">// try reading the structure info</font>
00954     i = <a class="code" href="xsfplugin_8C.html#a40">read_xsf_structure</a>(v, &amp;optflags, atoms);
00955     <font class="keywordflow">if</font> (i) {
00956       fprintf(stderr, <font class="stringliteral">"read_xsf_structure failed for file %s\n"</font>, *argv);
00957       <font class="keywordflow">return</font> 1;
00958     }
00959     fprintf(stderr, <font class="stringliteral">"read_xsf_structure succeeded for file %s\n"</font>, *argv);
00960 
00961     <font class="comment">// try loading the EDM metadata now</font>
00962     <font class="keywordflow">if</font> (<a class="code" href="xsfplugin_8C.html#a42">read_xsf_metadata</a>(v, &amp;nvolsets, &amp;meta)) {
00963       <font class="keywordflow">return</font> 1; <font class="comment">// failed to load xsf file</font>
00964     }
00965     fprintf(stderr, <font class="stringliteral">"read_xsf_metadata succeeded for file %s\n"</font>, *argv);
00966 
00967     <font class="keywordflow">for</font> (set=0; set&lt;nvolsets; set++) {
00968       printf(<font class="stringliteral">"Loading volume set: %d\n"</font>, set);   
00969       
00970       <font class="keywordtype">int</font> elements = meta[set].<a class="code" href="structmolfile__volumetric__t.html#m5">xsize</a> * meta[set].<a class="code" href="structmolfile__volumetric__t.html#m6">ysize</a> * meta[set].<a class="code" href="structmolfile__volumetric__t.html#m7">zsize</a>;
00971       printf(<font class="stringliteral">"   Grid Elements: %d\n"</font>, elements);
00972       printf(<font class="stringliteral">" Grid dimensions: X: %d Y: %d Z: %d\n"</font>, 
00973              meta[set].xsize, meta[set].ysize, meta[set].zsize);
00974 
00975       <font class="keywordtype">float</font> * voldata = (<font class="keywordtype">float</font> *) malloc(<font class="keyword">sizeof</font>(<font class="keywordtype">float</font>) * elements);
00976       <font class="keywordtype">float</font> * coldata = NULL;
00977 
00978       <font class="keywordflow">if</font> (meta[set].<a class="code" href="structmolfile__volumetric__t.html#m8">has_color</a>) {
00979         coldata = (<font class="keywordtype">float</font> *) malloc(<font class="keyword">sizeof</font>(<font class="keywordtype">float</font>) * elements * 3);
00980       }
00981 
00982       <font class="comment">// try loading the data sets now</font>
00983       <font class="keywordflow">if</font> (<a class="code" href="xsfplugin_8C.html#a43">read_xsf_data</a>(v, set, voldata, coldata)) {
00984         <font class="keywordflow">return</font> 1; <font class="comment">// failed to load xsf file</font>
00985       }
00986 
00987       printf(<font class="stringliteral">"First 6 elements:\n   "</font>);
00988       <font class="keywordflow">for</font> (i=0; i&lt;6; i++) {
00989         printf(<font class="stringliteral">"%g, "</font>, voldata[i]);
00990       }
00991       printf(<font class="stringliteral">"\n"</font>); 
00992 
00993       printf(<font class="stringliteral">"Last 6 elements:\n   "</font>);
00994       <font class="keywordflow">for</font> (i=elements - 6; i&lt;elements; i++) {
00995         printf(<font class="stringliteral">"%g, "</font>, voldata[i]);
00996       }
00997       printf(<font class="stringliteral">"\n"</font>); 
00998     }
00999 
01000     <a class="code" href="structmolfile__timestep__t.html">molfile_timestep_t</a> ts;
01001     ts.<a class="code" href="structmolfile__timestep__t.html#m0">coords</a> = <font class="keyword">new</font> <font class="keywordtype">float</font>[3*natoms];
01002     
01003     <font class="keywordflow">if</font> (<a class="code" href="xsfplugin_8C.html#a41">read_xsf_timestep</a>(v, natoms, &amp;ts)) {
01004       printf(<font class="stringliteral">"read_xsf_timestep 0: failed\n"</font>);
01005     } <font class="keywordflow">else</font> {
01006       printf(<font class="stringliteral">"read_xsf_timestep 0: success\n"</font>);
01007     }
01008     
01009     <font class="keywordflow">if</font> (<a class="code" href="xsfplugin_8C.html#a41">read_xsf_timestep</a>(v, natoms, &amp;ts)) {
01010       printf(<font class="stringliteral">"read_xsf_timestep 1: failed\n"</font>);
01011     } <font class="keywordflow">else</font> {
01012       printf(<font class="stringliteral">"read_xsf_timestep 1: success\n"</font>);
01013     }
01014     
01015     <a class="code" href="xsfplugin_8C.html#a38">close_xsf_read</a>(v);
01016   }
01017   <font class="keywordflow">return</font> 0;
01018 }
01019 
01020 <font class="preprocessor">#endif</font>
01021 <font class="preprocessor"></font>
</pre></div><hr><address><small>Generated on Wed Mar 22 13:15:32 2006 for VMD Plugins (current) by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.gif" alt="doxygen" align="middle" border=0 
width=110 height=53></a>1.2.14 written by <a href="mailto:dimitri@stack.nl">Dimitri van Heesch</a>,
 &copy;&nbsp;1997-2002</small></address>
</body>
</html>
