<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>ccp4plugin.C Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.2.14 -->
<center>
<a class="qindex" href="index.html">Main Page</a> &nbsp; <a class="qindex" href="classes.html">Alphabetical List</a> &nbsp; <a class="qindex" href="annotated.html">Compound List</a> &nbsp; <a class="qindex" href="files.html">File List</a> &nbsp; <a class="qindex" href="functions.html">Compound Members</a> &nbsp; <a class="qindex" href="globals.html">File Members</a> &nbsp; <a class="qindex" href="pages.html">Related Pages</a> &nbsp; </center>
<hr><h1>ccp4plugin.C</h1><a href="ccp4plugin_8C.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 <font class="comment">/***************************************************************************</font>
00002 <font class="comment"> *cr</font>
00003 <font class="comment"> *cr            (C) Copyright 1995-2006 The Board of Trustees of the</font>
00004 <font class="comment"> *cr                        University of Illinois</font>
00005 <font class="comment"> *cr                         All Rights Reserved</font>
00006 <font class="comment"> *cr</font>
00007 <font class="comment"> ***************************************************************************/</font>
00008 
00009 <font class="comment">/***************************************************************************</font>
00010 <font class="comment"> * RCS INFORMATION:</font>
00011 <font class="comment"> *</font>
00012 <font class="comment"> *      $RCSfile: ccp4plugin.C,v $</font>
00013 <font class="comment"> *      $Author: johns $       $Locker:  $             $State: Exp $</font>
00014 <font class="comment"> *      $Revision: 1.23 $       $Date: 2006/03/17 21:15:44 $</font>
00015 <font class="comment"> *</font>
00016 <font class="comment"> ***************************************************************************/</font>
00017 
00018 <font class="comment">/*</font>
00019 <font class="comment"> * CCP4 electron density map file format description:</font>
00020 <font class="comment"> *   http://www.ccp4.ac.uk/html/maplib.html</font>
00021 <font class="comment"> *   http://iims.ebi.ac.uk/3dem-mrc-maps/distribution/mrc_maps.txt</font>
00022 <font class="comment"> *</font>
00023 <font class="comment"> * TODO: Fix translation/scaling problems found when using non-orthogonal</font>
00024 <font class="comment"> *       unit cells.</font>
00025 <font class="comment"> *</font>
00026 <font class="comment"> */</font>
00027 
00028 <font class="preprocessor">#include &lt;stdio.h&gt;</font>
00029 <font class="preprocessor">#include &lt;stdlib.h&gt;</font>
00030 <font class="preprocessor">#include &lt;math.h&gt;</font>
00031 <font class="preprocessor">#include &lt;string.h&gt;</font>
00032 
00033 <font class="preprocessor">#ifndef M_PI</font>
<a name="l00034"></a><a class="code" href="ccp4plugin_8C.html#a0">00034</a> <font class="preprocessor"></font><font class="preprocessor">#define M_PI 3.14159265358979323846</font>
00035 <font class="preprocessor"></font><font class="preprocessor">#endif</font>
00036 <font class="preprocessor"></font>
00037 <font class="preprocessor">#include "<a class="code" href="molfile__plugin_8h.html">molfile_plugin.h</a>"</font>
00038 <font class="preprocessor">#include "<a class="code" href="endianswap_8h.html">endianswap.h</a>"</font>
00039 
<a name="l00040"></a><a class="code" href="ccp4plugin_8C.html#a1">00040</a> <font class="preprocessor">#define CCP4HDSIZE 1024</font>
00041 <font class="preprocessor"></font>
<a name="l00042"></a><a class="code" href="structccp4__t.html">00042</a> <font class="keyword">typedef</font> <font class="keyword">struct </font>{
<a name="l00043"></a><a class="code" href="structccp4__t.html#m0">00043</a>   FILE *fd;
<a name="l00044"></a><a class="code" href="structccp4__t.html#m1">00044</a>   <font class="keywordtype">int</font> nsets;
<a name="l00045"></a><a class="code" href="structccp4__t.html#m2">00045</a>   <font class="keywordtype">int</font> swap;
<a name="l00046"></a><a class="code" href="structccp4__t.html#m3">00046</a>   <font class="keywordtype">int</font> xyz2crs[3];
<a name="l00047"></a><a class="code" href="structccp4__t.html#m4">00047</a>   <font class="keywordtype">long</font> dataOffset;
<a name="l00048"></a><a class="code" href="structccp4__t.html#m5">00048</a>   <a class="code" href="structmolfile__volumetric__t.html">molfile_volumetric_t</a> *vol;
00049 } <a class="code" href="structccp4__t.html">ccp4_t</a>;
00050 
<a name="l00051"></a><a class="code" href="ccp4plugin_8C.html#a3">00051</a> <font class="keyword">static</font> <font class="keywordtype">void</font> *<a class="code" href="ccp4plugin_8C.html#a3">open_ccp4_read</a>(<font class="keyword">const</font> <font class="keywordtype">char</font> *filepath, <font class="keyword">const</font> <font class="keywordtype">char</font> *filetype,
00052     <font class="keywordtype">int</font> *natoms) {
00053   FILE *fd;
00054   <a class="code" href="structccp4__t.html">ccp4_t</a> *ccp4;
00055   <font class="keywordtype">char</font> mapString[4], symData[81];
00056   <font class="keywordtype">int</font> origin[3], extent[3], grid[3], crs2xyz[3], mode, symBytes;
00057   <font class="keywordtype">int</font> swap, i, xIndex, yIndex, zIndex;
00058   <font class="keywordtype">long</font> dataOffset, filesize;
00059   <font class="keywordtype">float</font> cellDimensions[3], cellAngles[3], xaxis[3], yaxis[3], zaxis[3];
00060   <font class="keywordtype">float</font> alpha, beta, gamma, xScale, yScale, zScale, z1, z2, z3;
00061   
00062   fd = fopen(filepath, <font class="stringliteral">"rb"</font>);
00063   <font class="keywordflow">if</font> (!fd) {
00064     printf(<font class="stringliteral">"ccp4plugin) Error opening file %s\n"</font>, filepath);
00065     <font class="keywordflow">return</font> NULL;
00066   }
00067 
00068   <font class="keywordflow">if</font> ( (fread(extent, <font class="keyword">sizeof</font>(<font class="keywordtype">int</font>), 3, fd) != 3) ||
00069        (fread(&amp;mode, <font class="keyword">sizeof</font>(<font class="keywordtype">int</font>), 1, fd) != 1) ||
00070        (fread(origin, <font class="keyword">sizeof</font>(<font class="keywordtype">int</font>), 3, fd) != 3) ||
00071        (fread(grid, <font class="keyword">sizeof</font>(<font class="keywordtype">int</font>), 3, fd) != 3) ||
00072        (fread(cellDimensions, <font class="keyword">sizeof</font>(<font class="keywordtype">float</font>), 3, fd) != 3) ||
00073        (fread(cellAngles, <font class="keyword">sizeof</font>(<font class="keywordtype">float</font>), 3, fd) != 3) ||
00074        (fread(crs2xyz, <font class="keyword">sizeof</font>(<font class="keywordtype">int</font>), 3, fd) != 3) ) {
00075     printf(<font class="stringliteral">"ccp4plugin) Error: Improperly formatted line.\n"</font>);
00076     <font class="keywordflow">return</font> NULL;
00077   }
00078 
00079   <font class="comment">// Check the number of bytes used for storing symmetry operators</font>
00080   fseek(fd, 92, SEEK_SET);
00081   <font class="keywordflow">if</font> ((fread(&amp;symBytes, <font class="keyword">sizeof</font>(<font class="keywordtype">int</font>), 1, fd) != 1) ) {
00082     printf(<font class="stringliteral">"ccp4plugin) Error: Failed reading symmetry bytes record.\n"</font>);
00083     <font class="keywordflow">return</font> NULL;
00084   }
00085 
00086   <font class="comment">// Check for the string "MAP" at byte 208, indicating a CCP4 file.</font>
00087   fseek(fd, 208, SEEK_SET);
00088   <font class="keywordflow">if</font> ( (fgets(mapString, 4, fd) == NULL) ||
00089        (strcmp(mapString, <font class="stringliteral">"MAP"</font>) != 0) ) {
00090     printf(<font class="stringliteral">"ccp4plugin) Error: 'MAP' string missing, not a valid CCP4 file.\n"</font>);
00091     <font class="keywordflow">return</font> NULL;
00092   }
00093 
00094   swap = 0;
00095   <font class="comment">// Check the data type of the file.</font>
00096   <font class="keywordflow">if</font> (mode != 2) {
00097     <font class="comment">// Check if the byte-order is flipped</font>
00098     <a class="code" href="endianswap_8h.html#a4">swap4_aligned</a>(&amp;mode, 1);
00099     <font class="keywordflow">if</font> (mode != 2) {
00100       printf(<font class="stringliteral">"ccp4plugin) Error: Non-real (32-bit float) data types are unsupported.\n"</font>);
00101       <font class="keywordflow">return</font> NULL;
00102     } <font class="keywordflow">else</font> {
00103       swap = 1; <font class="comment">// enable byte swapping</font>
00104     }
00105   }
00106 
00107   <font class="comment">// Swap all the information obtained from the header</font>
00108   <font class="keywordflow">if</font> (swap == 1) {
00109     <a class="code" href="endianswap_8h.html#a4">swap4_aligned</a>(extent, 3);
00110     <a class="code" href="endianswap_8h.html#a4">swap4_aligned</a>(origin, 3);
00111     <a class="code" href="endianswap_8h.html#a4">swap4_aligned</a>(grid, 3);
00112     <a class="code" href="endianswap_8h.html#a4">swap4_aligned</a>(cellDimensions, 3);
00113     <a class="code" href="endianswap_8h.html#a4">swap4_aligned</a>(cellAngles, 3);
00114     <a class="code" href="endianswap_8h.html#a4">swap4_aligned</a>(crs2xyz, 3);
00115     <a class="code" href="endianswap_8h.html#a4">swap4_aligned</a>(&amp;symBytes, 1);
00116   }
00117 
00118 
00119 <font class="preprocessor">#if 0</font>
00120 <font class="preprocessor"></font>  printf(<font class="stringliteral">"ccp4plugin) extent: %d x %d x %d\n"</font>, extent[0], extent[1], extent[2]);
00121   printf(<font class="stringliteral">"ccp4plugin) origin: %d x %d x %d\n"</font>, origin[0], origin[1], origin[2]);
00122   printf(<font class="stringliteral">"ccp4plugin)   grid: %d x %d x %d\n"</font>, grid[0], grid[1], grid[2]);
00123   printf(<font class="stringliteral">"ccp4plugin) celldim: %f x %f x %f\n"</font>, 
00124          cellDimensions[0], cellDimensions[1], cellDimensions[2]);
00125   printf(<font class="stringliteral">"cpp4plugin)cellangles: %f, %f, %f\n"</font>, 
00126          cellAngles[0], cellAngles[1], cellAngles[2]);
00127   printf(<font class="stringliteral">"ccp4plugin) crs2xyz: %f %f %f\n"</font>, 
00128          crs2xyz[0], crs2xyz[1], crs2xyz[2]);
00129   printf(<font class="stringliteral">"ccp4plugin) symBytes: %d\n"</font>, symBytes);
00130 <font class="preprocessor">#endif</font>
00131 <font class="preprocessor"></font>
00132 
00133   <font class="comment">// Check the dataOffset: this fixes the problem caused by files claiming</font>
00134   <font class="comment">// to have symmetry records when they do not.</font>
00135   fseek(fd, 0, SEEK_END);
00136   filesize = ftell(fd);
00137   dataOffset = filesize - 4*(extent[0]*extent[1]*extent[2]);
00138   <font class="keywordflow">if</font> (dataOffset != (<a class="code" href="ccp4plugin_8C.html#a1">CCP4HDSIZE</a> + symBytes)) {
00139     <font class="keywordflow">if</font> (dataOffset == <a class="code" href="ccp4plugin_8C.html#a1">CCP4HDSIZE</a>) {
00140       <font class="comment">// Bogus symmetry record information</font>
00141       printf(<font class="stringliteral">"ccp4plugin) Warning: file contains bogus symmetry record.\n"</font>);
00142       symBytes = 0;
00143     } <font class="keywordflow">else</font> <font class="keywordflow">if</font> (dataOffset &lt; <a class="code" href="ccp4plugin_8C.html#a1">CCP4HDSIZE</a>) {
00144       printf(<font class="stringliteral">"ccp4plugin) Error: File appears truncated and doesn't match header.\n"</font>);
00145       <font class="keywordflow">return</font> NULL;
00146     } <font class="keywordflow">else</font> <font class="keywordflow">if</font> ((dataOffset &gt; <a class="code" href="ccp4plugin_8C.html#a1">CCP4HDSIZE</a>) &amp;&amp; (dataOffset &lt; (1024*1024))) {
00147       <font class="comment">// Fix for loading SPIDER files which are larger than usual</font>
00148       <font class="comment">// In this specific case, we must absolutely trust the symBytes record</font>
00149       dataOffset = <a class="code" href="ccp4plugin_8C.html#a1">CCP4HDSIZE</a> + symBytes; 
00150       printf(<font class="stringliteral">"ccp4plugin) Warning: File is larger than expected and doesn't match header.\n"</font>);
00151       printf(<font class="stringliteral">"ccp4plugin) Warning: Continuing file load, good luck!\n"</font>);
00152     } <font class="keywordflow">else</font> {
00153       printf(<font class="stringliteral">"ccp4plugin) Error: File is MUCH larger than expected and doesn't match header.\n"</font>);
00154       <font class="keywordflow">return</font> NULL;
00155     }
00156   }
00157 
00158   <font class="comment">// Read symmetry records -- organized as 80-byte lines of text.</font>
00159   <font class="keywordflow">if</font> (symBytes != 0) {
00160     printf(<font class="stringliteral">"ccp4plugin) Symmetry records found:\n"</font>);
00161     fseek(fd, <a class="code" href="ccp4plugin_8C.html#a1">CCP4HDSIZE</a>, SEEK_SET);
00162     <font class="keywordflow">for</font> (i = 0; i &lt; symBytes/80; i++) {
00163       fgets(symData, 81, fd);
00164       printf(<font class="stringliteral">"ccp4plugin) %s\n"</font>, symData);
00165     }
00166   }
00167 
00168   <font class="comment">// check extent and grid interval counts</font>
00169   <font class="keywordflow">if</font> (grid[0] == 0 &amp;&amp; extent[0] &gt; 0) {
00170     grid[0] = extent[0] - 1;
00171     printf(<font class="stringliteral">"ccp4plugin) Warning: Fixed X interval count\n"</font>);
00172   }
00173   <font class="keywordflow">if</font> (grid[1] == 0 &amp;&amp; extent[1] &gt; 0) {
00174     grid[1] = extent[1] - 1;
00175     printf(<font class="stringliteral">"ccp4plugin) Warning: Fixed Y interval count\n"</font>);
00176   }
00177   <font class="keywordflow">if</font> (grid[2] == 0 &amp;&amp; extent[2] &gt; 0) {
00178     grid[2] = extent[2] - 1;
00179     printf(<font class="stringliteral">"ccp4plugin) Warning: Fixed Z interval count\n"</font>);
00180   }
00181  
00182   xScale = cellDimensions[0] / grid[0];
00183   yScale = cellDimensions[1] / grid[1];
00184   zScale = cellDimensions[2] / grid[2];
00185 
00186   <font class="comment">// Allocate and initialize the ccp4 structure</font>
00187   ccp4 = <font class="keyword">new</font> <a class="code" href="structccp4__t.html">ccp4_t</a>;
00188   ccp4-&gt;<a class="code" href="structccp4__t.html#m0">fd</a> = fd;
00189   ccp4-&gt;<a class="code" href="structccp4__t.html#m5">vol</a> = NULL;
00190   *natoms = <a class="code" href="molfile__plugin_8h.html#a7">MOLFILE_NUMATOMS_NONE</a>;
00191   ccp4-&gt;<a class="code" href="structccp4__t.html#m1">nsets</a> = 1; <font class="comment">// this EDM file contains only one data set</font>
00192   ccp4-&gt;<a class="code" href="structccp4__t.html#m2">swap</a> = swap;
00193   ccp4-&gt;<a class="code" href="structccp4__t.html#m4">dataOffset</a> = dataOffset;
00194 
00195   ccp4-&gt;<a class="code" href="structccp4__t.html#m5">vol</a> = <font class="keyword">new</font> <a class="code" href="structmolfile__volumetric__t.html">molfile_volumetric_t</a>[1];
00196   strcpy(ccp4-&gt;<a class="code" href="structccp4__t.html#m5">vol</a>[0].<a class="code" href="structmolfile__volumetric__t.html#m0">dataname</a>, <font class="stringliteral">"CCP4 Electron Density Map"</font>);
00197 
00198   <font class="comment">// Mapping between CCP4 column, row, section and VMD x, y, z.</font>
00199   ccp4-&gt;<a class="code" href="structccp4__t.html#m3">xyz2crs</a>[crs2xyz[0]-1] = 0;
00200   ccp4-&gt;<a class="code" href="structccp4__t.html#m3">xyz2crs</a>[crs2xyz[1]-1] = 1;
00201   ccp4-&gt;<a class="code" href="structccp4__t.html#m3">xyz2crs</a>[crs2xyz[2]-1] = 2;
00202   xIndex = ccp4-&gt;<a class="code" href="structccp4__t.html#m3">xyz2crs</a>[0];
00203   yIndex = ccp4-&gt;<a class="code" href="structccp4__t.html#m3">xyz2crs</a>[1];
00204   zIndex = ccp4-&gt;<a class="code" href="structccp4__t.html#m3">xyz2crs</a>[2];
00205 
00206   <font class="comment">// calculate non-orthogonal unit cell coordinates</font>
00207   alpha = (<a class="code" href="ccp4plugin_8C.html#a0">M_PI</a> / 180.0) * cellAngles[0];
00208   beta = (<a class="code" href="ccp4plugin_8C.html#a0">M_PI</a> / 180.0) * cellAngles[1];
00209   gamma = (<a class="code" href="ccp4plugin_8C.html#a0">M_PI</a> / 180.0) * cellAngles[2];
00210 
00211   xaxis[0] = xScale;
00212   xaxis[1] = 0;
00213   xaxis[2] = 0;
00214 
00215   yaxis[0] = cos(gamma) * yScale;
00216   yaxis[1] = sin(gamma) * yScale;
00217   yaxis[2] = 0;
00218 
00219   z1 = cos(beta);
00220   z2 = (cos(alpha) - cos(beta)*cos(gamma)) / sin(gamma);
00221   z3 = sqrt(1.0 - z1*z1 - z2*z2);
00222   zaxis[0] = z1 * zScale;
00223   zaxis[1] = z2 * zScale;
00224   zaxis[2] = z3 * zScale;
00225 
00226   ccp4-&gt;<a class="code" href="structccp4__t.html#m5">vol</a>[0].<a class="code" href="structmolfile__volumetric__t.html#m1">origin</a>[0] = xaxis[0] * origin[xIndex] + 
00227                            yaxis[0] * origin[yIndex] +
00228                            zaxis[0] * origin[zIndex];
00229   ccp4-&gt;<a class="code" href="structccp4__t.html#m5">vol</a>[0].<a class="code" href="structmolfile__volumetric__t.html#m1">origin</a>[1] = yaxis[1] * origin[yIndex] +
00230                            zaxis[1] * origin[zIndex];
00231   ccp4-&gt;<a class="code" href="structccp4__t.html#m5">vol</a>[0].<a class="code" href="structmolfile__volumetric__t.html#m1">origin</a>[2] = zaxis[2] * origin[zIndex];
00232 
00233   ccp4-&gt;<a class="code" href="structccp4__t.html#m5">vol</a>[0].<a class="code" href="structmolfile__volumetric__t.html#m2">xaxis</a>[0] = xaxis[0] * (extent[xIndex]-1);
00234   ccp4-&gt;<a class="code" href="structccp4__t.html#m5">vol</a>[0].<a class="code" href="structmolfile__volumetric__t.html#m2">xaxis</a>[1] = 0;
00235   ccp4-&gt;<a class="code" href="structccp4__t.html#m5">vol</a>[0].<a class="code" href="structmolfile__volumetric__t.html#m2">xaxis</a>[2] = 0;
00236 
00237   ccp4-&gt;<a class="code" href="structccp4__t.html#m5">vol</a>[0].<a class="code" href="structmolfile__volumetric__t.html#m3">yaxis</a>[0] = yaxis[0] * (extent[yIndex]-1);
00238   ccp4-&gt;<a class="code" href="structccp4__t.html#m5">vol</a>[0].<a class="code" href="structmolfile__volumetric__t.html#m3">yaxis</a>[1] = yaxis[1] * (extent[yIndex]-1);
00239   ccp4-&gt;<a class="code" href="structccp4__t.html#m5">vol</a>[0].<a class="code" href="structmolfile__volumetric__t.html#m3">yaxis</a>[2] = 0;
00240 
00241   ccp4-&gt;<a class="code" href="structccp4__t.html#m5">vol</a>[0].<a class="code" href="structmolfile__volumetric__t.html#m4">zaxis</a>[0] = zaxis[0] * (extent[zIndex]-1);
00242   ccp4-&gt;<a class="code" href="structccp4__t.html#m5">vol</a>[0].<a class="code" href="structmolfile__volumetric__t.html#m4">zaxis</a>[1] = zaxis[1] * (extent[zIndex]-1);
00243   ccp4-&gt;<a class="code" href="structccp4__t.html#m5">vol</a>[0].<a class="code" href="structmolfile__volumetric__t.html#m4">zaxis</a>[2] = zaxis[2] * (extent[zIndex]-1);
00244 
00245   ccp4-&gt;<a class="code" href="structccp4__t.html#m5">vol</a>[0].<a class="code" href="structmolfile__volumetric__t.html#m5">xsize</a> = extent[xIndex];
00246   ccp4-&gt;<a class="code" href="structccp4__t.html#m5">vol</a>[0].<a class="code" href="structmolfile__volumetric__t.html#m6">ysize</a> = extent[yIndex];
00247   ccp4-&gt;<a class="code" href="structccp4__t.html#m5">vol</a>[0].<a class="code" href="structmolfile__volumetric__t.html#m7">zsize</a> = extent[zIndex];
00248 
00249   ccp4-&gt;<a class="code" href="structccp4__t.html#m5">vol</a>[0].<a class="code" href="structmolfile__volumetric__t.html#m8">has_color</a> = 0;
00250 
00251   <font class="keywordflow">return</font> ccp4;
00252 }
00253 
<a name="l00254"></a><a class="code" href="ccp4plugin_8C.html#a4">00254</a> <font class="keyword">static</font> <font class="keywordtype">int</font> <a class="code" href="ccp4plugin_8C.html#a4">read_ccp4_metadata</a>(<font class="keywordtype">void</font> *v, <font class="keywordtype">int</font> *nsets, 
00255   <a class="code" href="structmolfile__volumetric__t.html">molfile_volumetric_t</a> **metadata) {
00256   <a class="code" href="structccp4__t.html">ccp4_t</a> *ccp4 = (<a class="code" href="structccp4__t.html">ccp4_t</a> *)v;
00257   *nsets = ccp4-&gt;<a class="code" href="structccp4__t.html#m1">nsets</a>; 
00258   *metadata = ccp4-&gt;<a class="code" href="structccp4__t.html#m5">vol</a>;  
00259 
00260   <font class="keywordflow">return</font> <a class="code" href="molfile__plugin_8h.html#a2">MOLFILE_SUCCESS</a>;
00261 }
00262 
<a name="l00263"></a><a class="code" href="ccp4plugin_8C.html#a5">00263</a> <font class="keyword">static</font> <font class="keywordtype">int</font> <a class="code" href="ccp4plugin_8C.html#a5">read_ccp4_data</a>(<font class="keywordtype">void</font> *v, <font class="keywordtype">int</font> set, <font class="keywordtype">float</font> *datablock,
00264                          <font class="keywordtype">float</font> *colorblock) {
00265   <a class="code" href="structccp4__t.html">ccp4_t</a> *ccp4 = (<a class="code" href="structccp4__t.html">ccp4_t</a> *)v;
00266   <font class="keywordtype">float</font> *rowdata;
00267   <font class="keywordtype">int</font> x, y, z, xSize, ySize, zSize, xySize, extent[3], coord[3];
00268   FILE *fd = ccp4-&gt;<a class="code" href="structccp4__t.html#m0">fd</a>;
00269 
00270   xSize = ccp4-&gt;<a class="code" href="structccp4__t.html#m5">vol</a>[0].<a class="code" href="structmolfile__volumetric__t.html#m5">xsize</a>;
00271   ySize = ccp4-&gt;<a class="code" href="structccp4__t.html#m5">vol</a>[0].<a class="code" href="structmolfile__volumetric__t.html#m6">ysize</a>;
00272   zSize = ccp4-&gt;<a class="code" href="structccp4__t.html#m5">vol</a>[0].<a class="code" href="structmolfile__volumetric__t.html#m7">zsize</a>;
00273   xySize = xSize * ySize;
00274 
00275   <font class="comment">// coord = &lt;col, row, sec&gt;</font>
00276   <font class="comment">// extent = &lt;colSize, rowSize, secSize&gt;</font>
00277   extent[ccp4-&gt;<a class="code" href="structccp4__t.html#m3">xyz2crs</a>[0]] = xSize;
00278   extent[ccp4-&gt;<a class="code" href="structccp4__t.html#m3">xyz2crs</a>[1]] = ySize;
00279   extent[ccp4-&gt;<a class="code" href="structccp4__t.html#m3">xyz2crs</a>[2]] = zSize;
00280 
00281   rowdata = <font class="keyword">new</font> <font class="keywordtype">float</font>[extent[0]];
00282 
00283   fseek(fd, ccp4-&gt;<a class="code" href="structccp4__t.html#m4">dataOffset</a>, SEEK_SET);
00284 
00285   <font class="keywordflow">for</font> (coord[2] = 0; coord[2] &lt; extent[2]; coord[2]++) {
00286     <font class="keywordflow">for</font> (coord[1] = 0; coord[1] &lt; extent[1]; coord[1]++) {
00287       <font class="comment">// Read an entire row of data from the file, then write it into the</font>
00288       <font class="comment">// datablock with the correct slice ordering.</font>
00289       <font class="keywordflow">if</font> (feof(fd)) {
00290         printf(<font class="stringliteral">"ccp4plugin) Unexpected end-of-file.\n"</font>);
00291         <font class="keywordflow">return</font> <a class="code" href="molfile__plugin_8h.html#a4">MOLFILE_ERROR</a>;
00292       }
00293       <font class="keywordflow">if</font> (ferror(fd)) {
00294         printf(<font class="stringliteral">"ccp4plugin) Problem reading the file.\n"</font>);
00295         <font class="keywordflow">return</font> <a class="code" href="molfile__plugin_8h.html#a4">MOLFILE_ERROR</a>;
00296       }
00297       <font class="keywordflow">if</font> ( fread(rowdata, <font class="keyword">sizeof</font>(<font class="keywordtype">float</font>), extent[0], fd) != extent[0] ) {
00298         printf(<font class="stringliteral">"ccp4plugin) Error reading data row.\n"</font>);
00299         <font class="keywordflow">return</font> <a class="code" href="molfile__plugin_8h.html#a4">MOLFILE_ERROR</a>;
00300       }
00301 
00302       <font class="keywordflow">for</font> (coord[0] = 0; coord[0] &lt; extent[0]; coord[0]++) {
00303         x = coord[ccp4-&gt;<a class="code" href="structccp4__t.html#m3">xyz2crs</a>[0]];
00304         y = coord[ccp4-&gt;<a class="code" href="structccp4__t.html#m3">xyz2crs</a>[1]];
00305         z = coord[ccp4-&gt;<a class="code" href="structccp4__t.html#m3">xyz2crs</a>[2]];
00306         datablock[x + y*xSize + z*xySize] = rowdata[coord[0]];
00307       }
00308     }
00309   }
00310 
00311   <font class="keywordflow">if</font> (ccp4-&gt;<a class="code" href="structccp4__t.html#m2">swap</a> == 1)
00312     <a class="code" href="endianswap_8h.html#a4">swap4_aligned</a>(datablock, xySize * zSize);
00313 
00314   <font class="keyword">delete</font> [] rowdata;
00315 
00316   <font class="keywordflow">return</font> <a class="code" href="molfile__plugin_8h.html#a2">MOLFILE_SUCCESS</a>;
00317 }
00318 
<a name="l00319"></a><a class="code" href="ccp4plugin_8C.html#a6">00319</a> <font class="keyword">static</font> <font class="keywordtype">void</font> <a class="code" href="ccp4plugin_8C.html#a6">close_ccp4_read</a>(<font class="keywordtype">void</font> *v) {
00320   <a class="code" href="structccp4__t.html">ccp4_t</a> *ccp4 = (<a class="code" href="structccp4__t.html">ccp4_t</a> *)v;
00321 
00322   fclose(ccp4-&gt;<a class="code" href="structccp4__t.html#m0">fd</a>);
00323   <font class="keyword">delete</font> [] ccp4-&gt;<a class="code" href="structccp4__t.html#m5">vol</a>; 
00324   <font class="keyword">delete</font> ccp4;
00325 }
00326 
00327 <font class="comment">/*</font>
00328 <font class="comment"> * Initialization stuff here</font>
00329 <font class="comment"> */</font>
<a name="l00330"></a><a class="code" href="ccp4plugin_8C.html#a2">00330</a> <font class="keyword">static</font> <a class="code" href="structmolfile__plugin__t.html">molfile_plugin_t</a> <a class="code" href="ccp4plugin_8C.html#a2">plugin</a> = {
00331   <a class="code" href="vmdplugin_8h.html#a10">vmdplugin_ABIVERSION</a>,               <font class="comment">// ABI version</font>
00332   <a class="code" href="molfile__plugin_8h.html#a0">MOLFILE_PLUGIN_TYPE</a>,                <font class="comment">// plugin type</font>
00333   <font class="stringliteral">"ccp4"</font>,                             <font class="comment">// short file format description</font>
00334   <font class="stringliteral">"CCP4"</font>,                             <font class="comment">// pretty file format description</font>
00335   <font class="stringliteral">"Eamon Caddigan, John Stone"</font>,       <font class="comment">// author(s)</font>
00336   0,                                  <font class="comment">// major version</font>
00337   8,                                  <font class="comment">// minor version</font>
00338   <a class="code" href="vmdplugin_8h.html#a12">VMDPLUGIN_THREADSAFE</a>,               <font class="comment">// is reentrant</font>
00339   <font class="stringliteral">"ccp4,mrc,map"</font>                      <font class="comment">// filename extension</font>
00340 };
00341 
<a name="l00342"></a><a class="code" href="ccp4plugin_8C.html#a7">00342</a> <a class="code" href="vmdplugin_8h.html#a7">VMDPLUGIN_API</a> <font class="keywordtype">int</font> <a class="code" href="vmdplugin_8h.html#a5">VMDPLUGIN_init</a>(<font class="keywordtype">void</font>) { <font class="keywordflow">return</font> <a class="code" href="vmdplugin_8h.html#a13">VMDPLUGIN_SUCCESS</a>; }
<a name="l00343"></a><a class="code" href="ccp4plugin_8C.html#a8">00343</a> <a class="code" href="vmdplugin_8h.html#a7">VMDPLUGIN_API</a> <font class="keywordtype">int</font> <a class="code" href="vmdplugin_8h.html#a6">VMDPLUGIN_fini</a>(<font class="keywordtype">void</font>) { <font class="keywordflow">return</font> <a class="code" href="vmdplugin_8h.html#a13">VMDPLUGIN_SUCCESS</a>; }
<a name="l00344"></a><a class="code" href="ccp4plugin_8C.html#a9">00344</a> <a class="code" href="vmdplugin_8h.html#a7">VMDPLUGIN_API</a> <font class="keywordtype">int</font> <a class="code" href="vmdplugin_8h.html#a3">VMDPLUGIN_register</a>(<font class="keywordtype">void</font> *v, <a class="code" href="vmdplugin_8h.html#a15">vmdplugin_register_cb</a> cb) {
00345   plugin.<a class="code" href="structmolfile__plugin__t.html#m1">open_file_read</a> = <a class="code" href="ccp4plugin_8C.html#a3">open_ccp4_read</a>;
00346   plugin.<a class="code" href="structmolfile__plugin__t.html#m10">read_volumetric_metadata</a> = <a class="code" href="ccp4plugin_8C.html#a4">read_ccp4_metadata</a>;
00347   plugin.<a class="code" href="structmolfile__plugin__t.html#m11">read_volumetric_data</a> = <a class="code" href="ccp4plugin_8C.html#a5">read_ccp4_data</a>;
00348   plugin.<a class="code" href="structmolfile__plugin__t.html#m5">close_file_read</a> = <a class="code" href="ccp4plugin_8C.html#a6">close_ccp4_read</a>;
00349   (*cb)(v, (<a class="code" href="structvmdplugin__t.html">vmdplugin_t</a> *)&amp;plugin);
00350   <font class="keywordflow">return</font> <a class="code" href="vmdplugin_8h.html#a13">VMDPLUGIN_SUCCESS</a>;
00351 }
00352 
</pre></div><hr><address><small>Generated on Wed Mar 22 13:15:28 2006 for VMD Plugins (current) by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.gif" alt="doxygen" align="middle" border=0 
width=110 height=53></a>1.2.14 written by <a href="mailto:dimitri@stack.nl">Dimitri van Heesch</a>,
 &copy;&nbsp;1997-2002</small></address>
</body>
</html>
