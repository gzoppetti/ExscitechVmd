<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>gamessplugin.c Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.2.14 -->
<center>
<a class="qindex" href="index.html">Main Page</a> &nbsp; <a class="qindex" href="classes.html">Alphabetical List</a> &nbsp; <a class="qindex" href="annotated.html">Compound List</a> &nbsp; <a class="qindex" href="files.html">File List</a> &nbsp; <a class="qindex" href="functions.html">Compound Members</a> &nbsp; <a class="qindex" href="globals.html">File Members</a> &nbsp; <a class="qindex" href="pages.html">Related Pages</a> &nbsp; </center>
<hr><h1>gamessplugin.c</h1><a href="gamessplugin_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 <font class="comment">/***************************************************************************</font>
00002 <font class="comment"> *cr</font>
00003 <font class="comment"> *cr            (C) Copyright 1995-2006 The Board of Trustees of the</font>
00004 <font class="comment"> *cr                        University of Illinois</font>
00005 <font class="comment"> *cr                         All Rights Reserved</font>
00006 <font class="comment"> *cr</font>
00007 <font class="comment"> ***************************************************************************/</font>
00008 
00009 
00010 <font class="comment">/* *******************************************************</font>
00011 <font class="comment"> *</font>
00012 <font class="comment"> *          G A M E S S     P L U G I N </font>
00013 <font class="comment"> *</font>
00014 <font class="comment"> * This plugin allows VMD to read GAMESS log files</font>
00015 <font class="comment"> * currently only single point geometries and trajectories</font>
00016 <font class="comment"> * for optimizations, saddle point runs are supported </font>
00017 <font class="comment"> *</font>
00018 <font class="comment"> * ********************************************************/</font>
00019 
00020 <font class="preprocessor">#include "<a class="code" href="gamessplugin_8h.html">gamessplugin.h</a>"</font>
00021 
00022 <font class="comment">/* </font>
00023 <font class="comment"> * pre-processor macro to activate grid code </font>
00024 <font class="comment"> */</font>
00025 <font class="preprocessor">#ifdef GRID_ACTIVE</font>
00026 <font class="preprocessor"></font><font class="preprocessor">#define GRID 1</font>
00027 <font class="preprocessor"></font><font class="preprocessor">#else</font>
<a name="l00028"></a><a class="code" href="gamessplugin_8c.html#a0">00028</a> <font class="preprocessor"></font><font class="preprocessor">#define GRID 0</font>
00029 <font class="preprocessor"></font><font class="preprocessor">#endif</font>
00030 <font class="preprocessor"></font>
00031 <font class="comment">/*</font>
00032 <font class="comment"> * Error reporting macro for use in DEBUG mode</font>
00033 <font class="comment"> */</font>
00034 <font class="preprocessor">#ifdef GAMESS_DEBUG</font>
00035 <font class="preprocessor"></font><font class="preprocessor">#define PRINTERR fprintf(stderr, "\n In file %s, line %d: \n %s \n \n", \</font>
00036 <font class="preprocessor">                            __FILE__, __LINE__, strerror(errno))</font>
00037 <font class="preprocessor"></font><font class="preprocessor">#else</font>
<a name="l00038"></a><a class="code" href="gamessplugin_8c.html#a1">00038</a> <font class="preprocessor"></font><font class="preprocessor">#define PRINTERR (void)(0)</font>
00039 <font class="preprocessor"></font><font class="preprocessor">#endif</font>
00040 <font class="preprocessor"></font>
00041 <font class="comment">/*</font>
00042 <font class="comment"> * Error reporting macro for the multiple fgets calls in</font>
00043 <font class="comment"> * the code</font>
00044 <font class="comment"> */</font>
<a name="l00045"></a><a class="code" href="gamessplugin_8c.html#a2">00045</a> <font class="preprocessor">#define ERR_FALSE(x) if ( x == NULL ) return FALSE;</font>
00046 <font class="preprocessor"></font>
00047 
00048 
00049 <font class="comment">/***************************************************************</font>
00050 <font class="comment"> *</font>
00051 <font class="comment"> * subroutine doing the initial reading of the GAMESS</font>
00052 <font class="comment"> * input file</font>
00053 <font class="comment"> *</font>
00054 <font class="comment"> * *************************************************************/</font>
<a name="l00055"></a><a class="code" href="gamessplugin_8c.html#a4">00055</a> <font class="keyword">static</font> <font class="keywordtype">void</font> *<a class="code" href="gamessplugin_8c.html#a4">open_gamess_read</a>(<font class="keyword">const</font> <font class="keywordtype">char</font> *filename, 
00056                   <font class="keyword">const</font> <font class="keywordtype">char</font> *filetype, <font class="keywordtype">int</font> *natoms) {
00057 
00058   FILE *fd;
00059   <a class="code" href="structgamessdata.html">gamessdata</a> *data;
00060   <font class="keywordtype">char</font> mytime[BUFSIZ];
00061 
00062   <font class="comment">/* initialize array */</font>
00063   mytime[0] = <font class="charliteral">'\0'</font>;
00064 
00065   
00066   <font class="comment">/* open the input file */</font>
00067   fd = fopen(filename, <font class="stringliteral">"rb"</font>);
00068  
00069   <font class="comment">/* make sure we were able to load the file properly*/</font>
00070   <font class="keywordflow">if</font> (!fd) 
00071   {
00072     <a class="code" href="gamessplugin_8c.html#a1">PRINTERR</a>;
00073     <font class="keywordflow">return</font> NULL;
00074   }
00075 
00076   <font class="comment">/* obtain the current time */</font>
00077   <a class="code" href="gamessplugin_8c.html#a37">get_time</a>(mytime);
00078 
00079   <font class="comment">/* print out a short warning message -- we're very alpha */</font>
00080   printf(<font class="stringliteral">"\n"</font>);
00081   printf(<font class="stringliteral">"     *************************************************\n"</font>);
00082   printf(<font class="stringliteral">"     ***       GAMESSPLUGIN for VMD                ***\n"</font>);
00083   printf(<font class="stringliteral">"     *** %s      ***\n"</font>, mytime);
00084   printf(<font class="stringliteral">"     *** email bugs to vmd@ks.uiuc.edu             ***\n"</font>);
00085   printf(<font class="stringliteral">"     *** v0.3.0-rc1 03/05/2006 (c) Markus Dittrich ***\n"</font>);
00086   printf(<font class="stringliteral">"     *************************************************\n"</font>);
00087   printf(<font class="stringliteral">"\n"</font>);
00088 
00089   <font class="comment">/* allocate memory for main data structure */</font>
00090   data = (<a class="code" href="structgamessdata.html">gamessdata</a> *)calloc(1,<font class="keyword">sizeof</font>(<a class="code" href="structgamessdata.html">gamessdata</a>));
00091 
00092   <font class="comment">/* make sure memory was allocated properly */</font>
00093   <font class="keywordflow">if</font> (data == NULL) 
00094   {
00095     <a class="code" href="gamessplugin_8c.html#a1">PRINTERR</a>;
00096     <font class="keywordflow">return</font> NULL;
00097   }
00098 
00099 
00100   <font class="comment">/**********************************</font>
00101 <font class="comment">   * initialize some variables</font>
00102 <font class="comment">   *********************************/</font>
00103 
00104   <font class="comment">/* volumetric */</font>
00105   data-&gt;<a class="code" href="structgamessdata.html#m59">have_volumetric</a> = 0; 
00106 
00107   <font class="comment">/* runtyp */</font>
00108   data-&gt;<a class="code" href="structgamessdata.html#m2">runtyp</a> = 0;
00109 
00110   <font class="comment">/* have_trajectory flag to 1 */</font>
00111   data-&gt;<a class="code" href="structgamessdata.html#m77">have_trajectory</a> = 1; 
00112 
00113   <font class="comment">/* reset trajectory counter */</font>
00114   data-&gt;<a class="code" href="structgamessdata.html#m78">num_traj_points</a> = 0;
00115 
00116   <font class="comment">/* presence of wavefunction */</font>
00117   data-&gt;<a class="code" href="structgamessdata.html#m73">got_wavefunction</a> = <a class="code" href="gamessplugin_8h.html#a6">FALSE</a>;
00118 
00119   <font class="comment">/* orbital index of HOMO */</font>
00120   data-&gt;<a class="code" href="structgamessdata.html#m71">homo_index</a> = 0;
00121 
00122   <font class="comment">/* flag indicating the presence of</font>
00123 <font class="comment">   * internal coordinates */</font>
00124   data-&gt;<a class="code" href="structgamessdata.html#m37">have_internals</a> = <a class="code" href="gamessplugin_8h.html#a6">FALSE</a>;
00125 
00126   <font class="comment">/* flag indicating the presence of</font>
00127 <font class="comment">   * the cartesian Hessian */</font>
00128   data-&gt;<a class="code" href="structgamessdata.html#m38">have_cart_hessian</a> = <a class="code" href="gamessplugin_8h.html#a6">FALSE</a>;
00129 
00130   <font class="comment">/* initialize the number of imaginary </font>
00131 <font class="comment">   * modes for HESSIAN type runs */</font>
00132   data-&gt;<a class="code" href="structgamessdata.html#m24">nimag</a> = 0;
00133 
00134   <font class="comment">/* initialize the GAMESS version */</font>
00135   data-&gt;<a class="code" href="structgamessdata.html#m16">version</a> = 0;
00136 
00137   <font class="comment">/* initialize the basis set info */</font>
00138   data-&gt;<a class="code" href="structgamessdata.html#m6">ngauss</a> = 0;
00139   data-&gt;<a class="code" href="structgamessdata.html#m7">npfunc</a> = 0;
00140   data-&gt;<a class="code" href="structgamessdata.html#m8">ndfunc</a> = 0;
00141   data-&gt;<a class="code" href="structgamessdata.html#m9">nffunc</a> = 0;
00142   data-&gt;<a class="code" href="structgamessdata.html#m10">diffs</a>  = 0;
00143   data-&gt;<a class="code" href="structgamessdata.html#m11">diffsp</a> = 0;
00144 
00145   <font class="comment">/* initialize the number of scfenergies */</font>
00146   data-&gt;<a class="code" href="structgamessdata.html#m26">num_scfenergies</a> = 0;
00147 
00148   <font class="comment">/* initialize some of the character arrays */</font>
00149   strncpy(data-&gt;<a class="code" href="structgamessdata.html#m3">runtyp_string</a>,<font class="stringliteral">"\0"</font>,<font class="keyword">sizeof</font>(data-&gt;<a class="code" href="structgamessdata.html#m3">runtyp_string</a>));
00150   strncpy(data-&gt;<a class="code" href="structgamessdata.html#m5">basis_string</a>,<font class="stringliteral">"\0"</font>,<font class="keyword">sizeof</font>(data-&gt;<a class="code" href="structgamessdata.html#m5">basis_string</a>));
00151   strncpy(data-&gt;<a class="code" href="structgamessdata.html#m15">version_string</a>,<font class="stringliteral">"\0"</font>,<font class="keyword">sizeof</font>(data-&gt;<a class="code" href="structgamessdata.html#m15">version_string</a>));
00152   strncpy(data-&gt;<a class="code" href="structgamessdata.html#m19">scftyp_string</a>,<font class="stringliteral">"\0"</font>,<font class="keyword">sizeof</font>(data-&gt;<a class="code" href="structgamessdata.html#m19">scftyp_string</a>));
00153   strncpy(data-&gt;<a class="code" href="structgamessdata.html#m32">memory</a>,<font class="stringliteral">"\0"</font>,<font class="keyword">sizeof</font>(data-&gt;<a class="code" href="structgamessdata.html#m32">memory</a>));
00154 
00155   
00156   <font class="comment">/***********************************</font>
00157 <font class="comment">   * done intializing</font>
00158 <font class="comment">   **********************************/</font>
00159 
00160 
00161   <font class="comment">/* store file pointer and filename in gamess</font>
00162 <font class="comment">   * struct */</font>
00163   data-&gt;<a class="code" href="structgamessdata.html#m0">file</a> = fd;
00164   data-&gt;<a class="code" href="structgamessdata.html#m17">file_name</a> = strdup(filename);
00165 
00166 
00167   <font class="comment">/* check if the file is GAMESS format; if yes</font>
00168 <font class="comment">   * parse it, if no exit */</font>
00169   <font class="keywordflow">if</font> ( <a class="code" href="gamessplugin_8h.html#a18">have_gamess</a>(data) == <a class="code" href="gamessplugin_8h.html#a7">TRUE</a> ) 
00170   {
00171     <font class="comment">/* if we're dealing with an unsupported GAMESS</font>
00172 <font class="comment">     * version, we better quit */</font>
00173     <font class="keywordflow">if</font> ( data-&gt;<a class="code" href="structgamessdata.html#m16">version</a> == 0 )
00174     {
00175       printf(<font class="stringliteral">"gamessplugin&gt; GAMESS version %s not supported. \n"</font>,
00176           data-&gt;<a class="code" href="structgamessdata.html#m15">version_string</a>);
00177       printf(<font class="stringliteral">"gamessplugin&gt; .... bombing out! Sorry :( \n"</font>);
00178       <font class="keywordflow">return</font> NULL;
00179     }
00180 
00181     <font class="comment">/* get the "static" information from the log file */</font>    
00182     <font class="keywordflow">if</font> ( <a class="code" href="gamessplugin_8c.html#a13">parse_gamess_log_static</a>(data,natoms) == <a class="code" href="gamessplugin_8h.html#a6">FALSE</a> ) 
00183       <font class="keywordflow">return</font> NULL;
00184   }
00185   <font class="keywordflow">else</font> 
00186   {
00187     <font class="keywordflow">return</font> NULL;
00188   }
00189 
00190 
00191   <font class="comment">/* done with the gamess plugin */</font>
00192   rewind(fd);
00193   printf(<font class="stringliteral">"\n"</font>);
00194 
00195 
00196   <font class="comment">/* copy pointer also in bogus tcl data pointer */</font>
00197   <font class="comment">/* tcl_pointer = data; */</font>
00198 
00199   <font class="keywordflow">return</font> data;
00200 }
00201 
00202 
00203 <font class="comment">/************************************************************</font>
00204 <font class="comment"> * </font>
00205 <font class="comment"> * subroutine reading in the structure of the molecule</font>
00206 <font class="comment"> * in the GAMESS output file</font>
00207 <font class="comment"> *</font>
00208 <font class="comment"> *************************************************************/</font>
<a name="l00209"></a><a class="code" href="gamessplugin_8c.html#a5">00209</a> <font class="keyword">static</font> <font class="keywordtype">int</font> <a class="code" href="gamessplugin_8c.html#a5">read_gamess_structure</a>(<font class="keywordtype">void</font> *mydata, <font class="keywordtype">int</font> *optflags, 
00210                       <a class="code" href="structmolfile__atom__t.html">molfile_atom_t</a> *atoms) 
00211 {
00212   <a class="code" href="structgamessdata.html">gamessdata</a> *data = (<a class="code" href="structgamessdata.html">gamessdata</a> *)mydata;
00213   <a class="code" href="structgamess__temp.html">gamess_temp</a> *temp_atom;
00214   <a class="code" href="structmolfile__atom__t.html">molfile_atom_t</a> *atom;
00215   <font class="keywordtype">unsigned</font> <font class="keywordtype">int</font> i = 0;
00216  
00217   *optflags = <a class="code" href="molfile__plugin_8h.html#a8">MOLFILE_NOOPTIONS</a>; <font class="comment">/* no optional data */</font>
00218 
00219   <font class="comment">/* all the information I need has already been read in</font>
00220 <font class="comment">   * via the initial scan and I simply need to copy </font>
00221 <font class="comment">   * everything from the temporary arrays into the </font>
00222 <font class="comment">   * proper VMD arrays.</font>
00223 <font class="comment">   * Since there are no atom names in the GAMESS output</font>
00224 <font class="comment">   * I use the atom type here --- maybe there is a better</font>
00225 <font class="comment">   * way to do this !!?? */</font>
00226 
00227   <font class="comment">/* get initial pointer for temp arrays */</font>
00228   temp_atom = data-&gt;<a class="code" href="structgamessdata.html#m75">temporary</a>;
00229 
00230   <font class="keywordflow">for</font>(i=0;i&lt;data-&gt;<a class="code" href="structgamessdata.html#m1">numatoms</a>;i++)
00231   {
00232     atom=atoms+i;
00233     strncpy(atom-&gt;<a class="code" href="structmolfile__atom__t.html#m0">name</a>,temp_atom-&gt;<a class="code" href="structgamess__temp.html#m0">type</a>,<font class="keyword">sizeof</font>(atom-&gt;<a class="code" href="structmolfile__atom__t.html#m0">name</a>)); 
00234     strncpy(atom-&gt;<a class="code" href="structmolfile__atom__t.html#m1">type</a>,temp_atom-&gt;<a class="code" href="structgamess__temp.html#m0">type</a>,<font class="keyword">sizeof</font>(atom-&gt;<a class="code" href="structmolfile__atom__t.html#m1">type</a>));
00235     strncpy(atom-&gt;<a class="code" href="structmolfile__atom__t.html#m2">resname</a>,<font class="stringliteral">""</font>,<font class="keyword">sizeof</font>(atom-&gt;<a class="code" href="structmolfile__atom__t.html#m2">resname</a>)); 
00236     atom-&gt;<a class="code" href="structmolfile__atom__t.html#m3">resid</a> = 1;
00237     atom-&gt;<a class="code" href="structmolfile__atom__t.html#m11">charge</a> = temp_atom-&gt;<a class="code" href="structgamess__temp.html#m1">charge</a>;
00238     atom-&gt;<a class="code" href="structmolfile__atom__t.html#m5">chain</a>[0] = <font class="charliteral">'\0'</font>;
00239     atom-&gt;<a class="code" href="structmolfile__atom__t.html#m4">segid</a>[0] = <font class="charliteral">'\0'</font>;
00240    
00241 
00242     temp_atom++;
00243   }
00244  
00245   <font class="keywordflow">return</font> <a class="code" href="molfile__plugin_8h.html#a2">MOLFILE_SUCCESS</a>; 
00246 }
00247 
00248 
00249 <font class="comment">/***********************************************************</font>
00250 <font class="comment"> *</font>
00251 <font class="comment"> * this function reads in the information for the next</font>
00252 <font class="comment"> * timestep</font>
00253 <font class="comment"> *</font>
00254 <font class="comment"> ***********************************************************/</font>
<a name="l00255"></a><a class="code" href="gamessplugin_8c.html#a6">00255</a> <font class="keyword">static</font> <font class="keywordtype">int</font> <a class="code" href="webpdbplugin_8c.html#a8">read_next_timestep</a>(<font class="keywordtype">void</font> *mydata, <font class="keywordtype">int</font> natoms, 
00256     <a class="code" href="structmolfile__timestep__t.html">molfile_timestep_t</a> *ts) 
00257 {
00258   <a class="code" href="structgamessdata.html">gamessdata</a> *data = (<a class="code" href="structgamessdata.html">gamessdata</a> *)mydata;
00259   <a class="code" href="structgamess__temp.html">gamess_temp</a> *temp_atom;
00260   <font class="keywordtype">unsigned</font> <font class="keywordtype">int</font> i = 0;
00261 
00262 <font class="preprocessor">#ifdef ANIMATE_MODE</font>
00263 <font class="preprocessor"></font>  <a class="code" href="structmode__data.html">mode_data</a> *animated_mode = data-&gt;<a class="code" href="structgamessdata.html#m76">animated_mode</a>;
00264 <font class="preprocessor">#endif</font>
00265 <font class="preprocessor"></font>  
00266   <font class="comment">/* Now, if we are not dealing with a trajectory (a single </font>
00267 <font class="comment">   * * point conformation is considered one element of a trajectory</font>
00268 <font class="comment">   */</font>
00269   <font class="keywordflow">if</font> (data-&gt;<a class="code" href="structgamessdata.html#m77">have_trajectory</a> == 0) <font class="keywordflow">return</font> <a class="code" href="molfile__plugin_8h.html#a4">MOLFILE_ERROR</a>;
00270  
00271 
00272   <font class="comment">/* in the case of RUNTYP=ENERGY read data from temp</font>
00273 <font class="comment">   * arrays and that's it;</font>
00274 <font class="comment">   * in the case of RUNTYP=OPTIMIZE and SADPOINT just start with</font>
00275 <font class="comment">   * the first 1NSERCH entry */</font>
00276   <font class="keywordflow">if</font> ( data-&gt;<a class="code" href="structgamessdata.html#m2">runtyp</a> == <a class="code" href="gamessplugin_8h.html#a8">ENERGY</a> ) 
00277   {
00278      <font class="comment">/* initialize pointer for temporary arrays */</font>
00279      temp_atom = data-&gt;<a class="code" href="structgamessdata.html#m75">temporary</a>; 
00280  
00281 
00282      <font class="comment">/* now copy the initial coordinates from the temporary</font>
00283 <font class="comment">      * arrays into the VMD ones */</font>
00284      <font class="keywordflow">for</font>(i=0;i&lt;natoms;i++)  {
00285 
00286        ts-&gt;<a class="code" href="structmolfile__timestep__t.html#m0">coords</a>[3*i  ] = temp_atom-&gt;<a class="code" href="structgamess__temp.html#m2">x</a>;
00287        ts-&gt;<a class="code" href="structmolfile__timestep__t.html#m0">coords</a>[3*i+1] = temp_atom-&gt;<a class="code" href="structgamess__temp.html#m3">y</a>;
00288        ts-&gt;<a class="code" href="structmolfile__timestep__t.html#m0">coords</a>[3*i+2] = temp_atom-&gt;<a class="code" href="structgamess__temp.html#m4">z</a>; 
00289 
00290        temp_atom++;
00291      }    
00292 
00293      <font class="comment">/* Since we are only dealing with a single point which has</font>
00294 <font class="comment">      * just been read we have to make sure to let VMD know </font>
00295 <font class="comment">      * and also register the number of trajectory points as 1 */</font>
00296      data-&gt;<a class="code" href="structgamessdata.html#m77">have_trajectory</a> = 0;
00297 
00298      <font class="keywordflow">return</font> <a class="code" href="molfile__plugin_8h.html#a2">MOLFILE_SUCCESS</a>;
00299   }
00300 
00301 <font class="preprocessor">#ifndef ANIMATE_MODE</font>
00302 <font class="preprocessor"></font>  <font class="keywordflow">else</font> <font class="keywordflow">if</font> ( data-&gt;<a class="code" href="structgamessdata.html#m2">runtyp</a> == <a class="code" href="gamessplugin_8h.html#a11">HESSIAN</a> ) 
00303   {
00304      <font class="comment">/* initialize pointer for temporary arrays */</font>
00305      temp_atom = data-&gt;<a class="code" href="structgamessdata.html#m75">temporary</a>; 
00306  
00307 
00308      <font class="comment">/* now copy the initial coordinates from the temporary</font>
00309 <font class="comment">      * arrays into the VMD ones */</font>
00310      <font class="keywordflow">for</font>(i=0;i&lt;natoms;i++)  {
00311 
00312        ts-&gt;<a class="code" href="structmolfile__timestep__t.html#m0">coords</a>[3*i  ] = temp_atom-&gt;<a class="code" href="structgamess__temp.html#m2">x</a>;
00313        ts-&gt;<a class="code" href="structmolfile__timestep__t.html#m0">coords</a>[3*i+1] = temp_atom-&gt;<a class="code" href="structgamess__temp.html#m3">y</a>;
00314        ts-&gt;<a class="code" href="structmolfile__timestep__t.html#m0">coords</a>[3*i+2] = temp_atom-&gt;<a class="code" href="structgamess__temp.html#m4">z</a>; 
00315 
00316        temp_atom++;
00317      }    
00318 
00319      <font class="comment">/* Since we are only dealing with a single point which has</font>
00320 <font class="comment">      * just been read we have to make sure to let VMD know </font>
00321 <font class="comment">      * and also register the number of trajectory points as 1 */</font>
00322      data-&gt;<a class="code" href="structgamessdata.html#m77">have_trajectory</a> = 0;
00323 
00324      <font class="keywordflow">return</font> <a class="code" href="molfile__plugin_8h.html#a2">MOLFILE_SUCCESS</a>;
00325   }
00326 <font class="preprocessor">#endif</font>
00327 <font class="preprocessor"></font>
00328 <font class="preprocessor">#ifdef ANIMATE_MODE</font>
00329 <font class="preprocessor"></font>  <font class="keywordflow">else</font> <font class="keywordflow">if</font> ( data-&gt;<a class="code" href="structgamessdata.html#m2">runtyp</a> == <a class="code" href="gamessplugin_8h.html#a11">HESSIAN</a> ) 
00330   {
00331     <font class="comment">/* read until we run out of frames for the current mode */</font>
00332     <font class="keywordflow">if</font> ( animated_mode-&gt;<a class="code" href="structmode__data.html#m2">current_mode_frame</a> &lt; 
00333               4*animated_mode-&gt;<a class="code" href="structmode__data.html#m1">mode_num_frames</a>+3 )
00334     {
00335       <font class="comment">/* now copy the initial coordinates from the temporary</font>
00336 <font class="comment">        * arrays into the VMD ones */</font>
00337       <font class="keywordflow">for</font>(i=0; i&lt; natoms; i++)  
00338       {
00339         ts-&gt;<a class="code" href="structmolfile__timestep__t.html#m0">coords</a>[3*i  ] = *(animated_mode-&gt;<a class="code" href="structmode__data.html#m0">mode_frames</a> +
00340             (animated_mode-&gt;<a class="code" href="structmode__data.html#m2">current_mode_frame</a>*3*natoms)+3*i);
00341 
00342         ts-&gt;<a class="code" href="structmolfile__timestep__t.html#m0">coords</a>[3*i+1] = *(animated_mode-&gt;<a class="code" href="structmode__data.html#m0">mode_frames</a> +
00343             (animated_mode-&gt;<a class="code" href="structmode__data.html#m2">current_mode_frame</a>*3*natoms)+3*i+1);
00344 
00345         ts-&gt;<a class="code" href="structmolfile__timestep__t.html#m0">coords</a>[3*i+2] = *(animated_mode-&gt;<a class="code" href="structmode__data.html#m0">mode_frames</a> +
00346             (animated_mode-&gt;<a class="code" href="structmode__data.html#m2">current_mode_frame</a>*3*natoms)+3*i+2);
00347       }    
00348 
00349       <font class="comment">/* increase the trajectory and mode counter */</font> 
00350       (animated_mode-&gt;<a class="code" href="structmode__data.html#m2">current_mode_frame</a>)++;
00351     }
00352     <font class="keywordflow">else</font> 
00353     {
00354       <font class="keywordflow">return</font> <a class="code" href="molfile__plugin_8h.html#a4">MOLFILE_ERROR</a>;
00355     }
00356 
00357     <font class="keywordflow">return</font> <a class="code" href="molfile__plugin_8h.html#a2">MOLFILE_SUCCESS</a>;
00358   }
00359 <font class="preprocessor">#endif</font>
00360 <font class="preprocessor"></font>
00361   <font class="keywordflow">else</font> <font class="keywordflow">if</font> ( data-&gt;<a class="code" href="structgamessdata.html#m2">runtyp</a> == <a class="code" href="gamessplugin_8h.html#a9">OPTIMIZE</a> || data-&gt;<a class="code" href="structgamessdata.html#m2">runtyp</a> == <a class="code" href="gamessplugin_8h.html#a10">SADPOINT</a> ) 
00362   {
00363     <font class="comment">/* call the routine scanning the output file for the</font>
00364 <font class="comment">     * trajectory */</font>
00365     <font class="keywordflow">if</font> ( <a class="code" href="gamessplugin_8c.html#a14">get_trajectory</a>(data,ts,natoms) == <a class="code" href="gamessplugin_8h.html#a6">FALSE</a>) {
00366 
00367       <font class="comment">/* before we return let's check if we have read</font>
00368 <font class="comment">       * any trajectory points whatsoever; if not</font>
00369 <font class="comment">       * this could mean that the file might be</font>
00370 <font class="comment">       * truncated, and in this case we dump the initial</font>
00371 <font class="comment">       * coordinate info, such that the user has something</font>
00372 <font class="comment">       * to look at; */</font>
00373       <font class="keywordflow">if</font> ( data-&gt;<a class="code" href="structgamessdata.html#m78">num_traj_points</a> == 0 ) {
00374 
00375         <font class="comment">/* initialize pointer for temporary arrays */</font>
00376         temp_atom = data-&gt;<a class="code" href="structgamessdata.html#m75">temporary</a>; 
00377  
00378         
00379         <font class="comment">/* now copy the initial coordinates from the temporary</font>
00380 <font class="comment">        * arrays into the VMD ones */</font>
00381         <font class="keywordflow">for</font>(i=0;i&lt;natoms;i++)  {
00382 
00383           ts-&gt;<a class="code" href="structmolfile__timestep__t.html#m0">coords</a>[3*i  ] = temp_atom-&gt;<a class="code" href="structgamess__temp.html#m2">x</a>;
00384           ts-&gt;<a class="code" href="structmolfile__timestep__t.html#m0">coords</a>[3*i+1] = temp_atom-&gt;<a class="code" href="structgamess__temp.html#m3">y</a>;
00385           ts-&gt;<a class="code" href="structmolfile__timestep__t.html#m0">coords</a>[3*i+2] = temp_atom-&gt;<a class="code" href="structgamess__temp.html#m4">z</a>; 
00386 
00387           temp_atom++; }
00388 
00389 
00390         <font class="comment">/* make sure we don't continue reading the</font>
00391 <font class="comment">         * trajectory */</font>
00392         data-&gt;<a class="code" href="structgamessdata.html#m77">have_trajectory</a> = 0;
00393 
00394 
00395         <font class="comment">/* that's all we can do */</font>
00396         <font class="keywordflow">return</font> <a class="code" href="molfile__plugin_8h.html#a2">MOLFILE_SUCCESS</a>;
00397       }
00398 
00399 
00400       <font class="keywordflow">return</font> <a class="code" href="molfile__plugin_8h.html#a4">MOLFILE_ERROR</a>;
00401     }
00402 
00403 
00404     <font class="comment">/* increase the trajectory counter */</font>
00405     (data-&gt;<a class="code" href="structgamessdata.html#m78">num_traj_points</a>)++;
00406    
00407 
00408     <font class="comment">/* success, it seems :) */</font>
00409     <font class="keywordflow">return</font> <a class="code" href="molfile__plugin_8h.html#a2">MOLFILE_SUCCESS</a>;
00410   }
00411 
00412 
00413   <font class="comment">/* all other cases should have been rejected allready</font>
00414 <font class="comment">   * in open_gamess_read;</font>
00415 <font class="comment">   * but just to make sure we return MOLFILE_ERROR </font>
00416 <font class="comment">   * by default */</font>
00417   <font class="keywordflow">return</font> <a class="code" href="molfile__plugin_8h.html#a4">MOLFILE_ERROR</a>;
00418 }
00419 
00420 
00421 <font class="comment">/*********************************************************</font>
00422 <font class="comment"> *</font>
00423 <font class="comment"> * this subroutine makes the volumetric orbital metadata</font>
00424 <font class="comment"> * available to VMD;</font>
00425 <font class="comment"> *</font>
00426 <font class="comment"> ********************************************************/</font>
<a name="l00427"></a><a class="code" href="gamessplugin_8c.html#a7">00427</a> <font class="keyword">static</font> <font class="keywordtype">int</font> <a class="code" href="gamessplugin_8c.html#a7">read_orbital_metadata</a>( <font class="keywordtype">void</font> *mydata, <font class="keywordtype">int</font> *nsets, 
00428                           <a class="code" href="structmolfile__volumetric__t.html">molfile_volumetric_t</a> **metadata) 
00429 {
00430     <a class="code" href="structgamessdata.html">gamessdata</a> *data = (<a class="code" href="structgamessdata.html">gamessdata</a> *)mydata;
00431 
00432     <font class="comment">/* first of all we have to test the presence of</font>
00433 <font class="comment">     * volumetric data; if not set number of volumetric</font>
00434 <font class="comment">     * data sets to zero and return */</font>
00435 
00436     <font class="keywordflow">if</font> ( data-&gt;<a class="code" href="structgamessdata.html#m59">have_volumetric</a> != 1 ) 
00437     {
00438       *nsets = 0;
00439       <font class="keywordflow">return</font> <a class="code" href="molfile__plugin_8h.html#a2">MOLFILE_SUCCESS</a>;
00440     }
00441 
00442     <font class="comment">/* we only have one set of volumetric data */</font>
00443     *nsets = 1; 
00444 
00445     <font class="comment">/* all the necessary data structures have been filled</font>
00446 <font class="comment">     * in the function get_system_dimensions and we only</font>
00447 <font class="comment">     * need to copy the pointer. */</font>
00448     *metadata = data-&gt;<a class="code" href="structgamessdata.html#m60">vol</a>;
00449 
00450     <font class="keywordflow">return</font> <a class="code" href="molfile__plugin_8h.html#a2">MOLFILE_SUCCESS</a>;
00451 }
00452 
00453 
00454 <font class="comment">/**********************************************************</font>
00455 <font class="comment"> *</font>
00456 <font class="comment"> * this subroutine makes the volumetric data available </font>
00457 <font class="comment"> * to VMD</font>
00458 <font class="comment"> *</font>
00459 <font class="comment"> *********************************************************/</font>
<a name="l00460"></a><a class="code" href="gamessplugin_8c.html#a8">00460</a> <font class="keyword">static</font> <font class="keywordtype">int</font> <a class="code" href="gamessplugin_8c.html#a8">read_orbital_data</a>( <font class="keywordtype">void</font> *mydata, <font class="keywordtype">int</font> set, 
00461     <font class="keywordtype">float</font> *datablock, <font class="keywordtype">float</font> *colorblock) 
00462 {
00463   <a class="code" href="structgamessdata.html">gamessdata</a> *data = (<a class="code" href="structgamessdata.html">gamessdata</a> *)mydata;
00464   <a class="code" href="structgamess__temp.html">gamess_temp</a> *temp_data;
00465   <a class="code" href="structmolfile__volumetric__t.html">molfile_volumetric_t</a> *vol_metadata;
00466   <font class="keywordtype">unsigned</font> <font class="keywordtype">int</font> i = 0;
00467   <font class="keywordtype">int</font> numxyz;
00468 
00469   <font class="comment">/* get pointer of temporary data storage */</font>
00470   temp_data = data-&gt;<a class="code" href="structgamessdata.html#m75">temporary</a>; 
00471 
00472   <font class="comment">/* get pointer to volumetric metadata */</font>
00473   vol_metadata = data-&gt;<a class="code" href="structgamessdata.html#m60">vol</a>;
00474 
00475   <font class="comment">/* move array containing volumetric over to datablock </font>
00476 <font class="comment">   * the array contains xsize*ysize*zsize elements */</font>
00477   numxyz = ( vol_metadata-&gt;<a class="code" href="structmolfile__volumetric__t.html#m5">xsize</a> * vol_metadata-&gt;<a class="code" href="structmolfile__volumetric__t.html#m6">ysize</a> * 
00478              vol_metadata-&gt;<a class="code" href="structmolfile__volumetric__t.html#m7">zsize</a> );
00479 
00480   <font class="keywordflow">for</font> ( i = 0 ; i &lt; numxyz ; ++i )
00481   {
00482     *(datablock + i) = *(data-&gt;<a class="code" href="structgamessdata.html#m57">orbital_grid</a>+i);
00483   }
00484 
00485   <font class="keywordflow">return</font> <a class="code" href="molfile__plugin_8h.html#a2">MOLFILE_SUCCESS</a>;
00486 }
00487 
00488 
00489 <font class="comment">/**********************************************************</font>
00490 <font class="comment"> *</font>
00491 <font class="comment"> * clean up when done and free all the memory do avoid</font>
00492 <font class="comment"> * memory leaks</font>
00493 <font class="comment"> *</font>
00494 <font class="comment"> **********************************************************/</font>
<a name="l00495"></a><a class="code" href="gamessplugin_8c.html#a9">00495</a> <font class="keyword">static</font> <font class="keywordtype">void</font> <a class="code" href="gamessplugin_8c.html#a9">close_gamess_read</a>(<font class="keywordtype">void</font> *mydata) {
00496 
00497   <a class="code" href="structgamessdata.html">gamessdata</a> *data = (<a class="code" href="structgamessdata.html">gamessdata</a> *)mydata;
00498   fclose(data-&gt;<a class="code" href="structgamessdata.html#m0">file</a>);
00499 
00500   <font class="comment">/* free memory */</font>
00501   free(data-&gt;<a class="code" href="structgamessdata.html#m75">temporary</a>);
00502   free(data-&gt;<a class="code" href="structgamessdata.html#m61">basis</a>);
00503   free(data-&gt;<a class="code" href="structgamessdata.html#m55">system_dimensions</a>);
00504   free(data-&gt;<a class="code" href="structgamessdata.html#m56">system_center</a>); 
00505   free(data-&gt;<a class="code" href="structgamessdata.html#m57">orbital_grid</a>);
00506   free(data-&gt;<a class="code" href="structgamessdata.html#m62">basis_counter</a>);
00507   free(data-&gt;<a class="code" href="structgamessdata.html#m67">wave_function</a>);
00508   free(data-&gt;<a class="code" href="structgamessdata.html#m66">orbital_symmetry</a>);
00509   free(data-&gt;<a class="code" href="structgamessdata.html#m64">atomic_shells</a>);
00510   free(data-&gt;<a class="code" href="structgamessdata.html#m65">shell_primitives</a>);
00511   free(data-&gt;<a class="code" href="structgamessdata.html#m68">orbital_energy</a>);
00512   free(data-&gt;<a class="code" href="structgamessdata.html#m20">atomic_number</a>);
00513   free(data-&gt;<a class="code" href="structgamessdata.html#m33">mulliken_charges</a>);
00514   free(data-&gt;<a class="code" href="structgamessdata.html#m34">esp_charges</a>);
00515   free(data-&gt;<a class="code" href="structgamessdata.html#m44">bonds</a>);
00516   free(data-&gt;<a class="code" href="structgamessdata.html#m45">angles</a>);
00517   free(data-&gt;<a class="code" href="structgamessdata.html#m46">dihedrals</a>);
00518   free(data-&gt;<a class="code" href="structgamessdata.html#m47">impropers</a>);
00519   free(data-&gt;<a class="code" href="structgamessdata.html#m48">internal_coordinates</a>);
00520   free(data-&gt;<a class="code" href="structgamessdata.html#m49">bond_force_const</a>);
00521   free(data-&gt;<a class="code" href="structgamessdata.html#m50">angle_force_const</a>);
00522   free(data-&gt;<a class="code" href="structgamessdata.html#m51">dihedral_force_const</a>);
00523   free(data-&gt;<a class="code" href="structgamessdata.html#m52">improper_force_const</a>);
00524   free(data-&gt;<a class="code" href="structgamessdata.html#m54">inthessian</a>);
00525   free(data-&gt;<a class="code" href="structgamessdata.html#m53">carthessian</a>);
00526   free(data-&gt;<a class="code" href="structgamessdata.html#m60">vol</a>);
00527   free(data-&gt;<a class="code" href="structgamessdata.html#m27">scfenergies</a>);
00528   free(data-&gt;<a class="code" href="structgamessdata.html#m28">wavenumbers</a>);
00529   free(data-&gt;<a class="code" href="structgamessdata.html#m29">intensities</a>);
00530   free(data-&gt;<a class="code" href="structgamessdata.html#m30">normal_modes</a>);
00531   
00532   <font class="keywordflow">if</font> ( data-&gt;<a class="code" href="structgamessdata.html#m2">runtyp</a> == <a class="code" href="gamessplugin_8h.html#a11">HESSIAN</a> )
00533   {
00534 <font class="preprocessor">#ifdef ANIMATE_MODE</font>
00535 <font class="preprocessor"></font>    free(data-&gt;<a class="code" href="structgamessdata.html#m76">animated_mode</a>-&gt;<a class="code" href="structmode__data.html#m0">mode_frames</a>);
00536     free(data-&gt;<a class="code" href="structgamessdata.html#m76">animated_mode</a>);
00537 <font class="preprocessor">#endif</font>
00538 <font class="preprocessor"></font>  }
00539 
00540   free(data);
00541 }
00542 
00543 
00544 <font class="comment">/*************************************************************</font>
00545 <font class="comment"> *</font>
00546 <font class="comment"> * registration stuff </font>
00547 <font class="comment"> *</font>
00548 <font class="comment"> **************************************************************/</font>
<a name="l00549"></a><a class="code" href="gamessplugin_8c.html#a3">00549</a> <font class="keyword">static</font> <a class="code" href="structmolfile__plugin__t.html">molfile_plugin_t</a> <a class="code" href="gamessplugin_8c.html#a3">gamessplugin</a> = {
00550   <a class="code" href="vmdplugin_8h.html#a10">vmdplugin_ABIVERSION</a>,
00551   <a class="code" href="molfile__plugin_8h.html#a0">MOLFILE_PLUGIN_TYPE</a>,                         <font class="comment">/* type */</font>
00552   <font class="stringliteral">"gamess"</font>,                                    <font class="comment">/* short name */</font>
00553   <font class="stringliteral">"GAMESS"</font>,                                    <font class="comment">/* pretty name */</font>
00554   <font class="stringliteral">"Markus Dittrich"</font>,                           <font class="comment">/* author */</font>
00555   0,                                           <font class="comment">/* major version */</font>
00556   3,                                           <font class="comment">/* minor version */</font>
00557   <a class="code" href="vmdplugin_8h.html#a12">VMDPLUGIN_THREADSAFE</a>,                        <font class="comment">/* is reentrant */</font>
00558   <font class="stringliteral">"log"</font>,
00559   <a class="code" href="gamessplugin_8c.html#a4">open_gamess_read</a>,
00560   <a class="code" href="gamessplugin_8c.html#a5">read_gamess_structure</a>,
00561   0,
00562   <a class="code" href="gamessplugin_8c.html#a6">read_next_timestep</a>,
00563   <a class="code" href="gamessplugin_8c.html#a9">close_gamess_read</a>,
00564   0,
00565   0,
00566   0,
00567   0,
00568   <a class="code" href="gamessplugin_8c.html#a7">read_orbital_metadata</a>,
00569   <a class="code" href="gamessplugin_8c.html#a8">read_orbital_data</a>
00570 };
00571 
00572 
<a name="l00573"></a><a class="code" href="gamessplugin_8c.html#a10">00573</a> <a class="code" href="vmdplugin_8h.html#a7">VMDPLUGIN_API</a> <font class="keywordtype">int</font> <a class="code" href="vmdplugin_8h.html#a5">VMDPLUGIN_init</a>(<font class="keywordtype">void</font>) {
00574   <font class="keywordflow">return</font> <a class="code" href="vmdplugin_8h.html#a13">VMDPLUGIN_SUCCESS</a>;
00575 }
00576 
<a name="l00577"></a><a class="code" href="gamessplugin_8c.html#a11">00577</a> <a class="code" href="vmdplugin_8h.html#a7">VMDPLUGIN_API</a> <font class="keywordtype">int</font> <a class="code" href="vmdplugin_8h.html#a3">VMDPLUGIN_register</a>(<font class="keywordtype">void</font> *v, <a class="code" href="vmdplugin_8h.html#a15">vmdplugin_register_cb</a> cb) {
00578   (*cb)(v, (<a class="code" href="structvmdplugin__t.html">vmdplugin_t</a> *)&amp;gamessplugin);
00579   <font class="keywordflow">return</font> <a class="code" href="vmdplugin_8h.html#a13">VMDPLUGIN_SUCCESS</a>;
00580 }
00581 
<a name="l00582"></a><a class="code" href="gamessplugin_8c.html#a12">00582</a> <a class="code" href="vmdplugin_8h.html#a7">VMDPLUGIN_API</a> <font class="keywordtype">int</font> <a class="code" href="vmdplugin_8h.html#a6">VMDPLUGIN_fini</a>(<font class="keywordtype">void</font>) {
00583   <font class="keywordflow">return</font> <a class="code" href="vmdplugin_8h.html#a13">VMDPLUGIN_SUCCESS</a>;
00584 }
00585 
00586 
00587 
00588 
00589 <font class="comment">/********************************************************</font>
00590 <font class="comment"> *</font>
00591 <font class="comment"> * THE NEXT SECTION CONTAINs THE GAMESS OUTPUT FILE</font>
00592 <font class="comment"> * SPECIFIC SUBROUTINES</font>
00593 <font class="comment"> *</font>
00594 <font class="comment"> ********************************************************/</font>
00595 
00596 
00597 
00598 
00599 
00600 <font class="comment">/********************************************************</font>
00601 <font class="comment"> *</font>
00602 <font class="comment"> * this routine is the main gamess log file</font>
00603 <font class="comment"> * parser responsible for static, i.e. </font>
00604 <font class="comment"> * non-trajectory information </font>
00605 <font class="comment"> *</font>
00606 <font class="comment"> ********************************************************/</font>
<a name="l00607"></a><a class="code" href="gamessplugin_8c.html#a13">00607</a> <font class="keywordtype">int</font> <a class="code" href="gamessplugin_8c.html#a13">parse_gamess_log_static</a>(<font class="keywordtype">void</font> *mydata, <font class="keywordtype">int</font> *natoms) 
00608 {
00609   <a class="code" href="structgamessdata.html">gamessdata</a> *data = (<a class="code" href="structgamessdata.html">gamessdata</a> *)mydata;
00610 
00611   <font class="comment">/* determine the number of procs and the amount</font>
00612 <font class="comment">   * of memory requested */</font>
00613   <font class="keywordflow">if</font> ( <a class="code" href="gamessplugin_8h.html#a28">get_proc_mem</a>(data) == <a class="code" href="gamessplugin_8h.html#a6">FALSE</a> ) <font class="keywordflow">return</font> <a class="code" href="gamessplugin_8h.html#a6">FALSE</a>;
00614 
00615 
00616   <font class="comment">/* determine the GBASIS used for the run */</font>
00617   <font class="keywordflow">if</font> ( <a class="code" href="gamessplugin_8h.html#a19">get_gbasis</a>(data) == <a class="code" href="gamessplugin_8h.html#a6">FALSE</a> ) <font class="keywordflow">return</font> <a class="code" href="gamessplugin_8h.html#a6">FALSE</a>;
00618 
00619 
00620   <font class="comment">/* read the run title */</font>
00621   <font class="keywordflow">if</font> ( <a class="code" href="gamessplugin_8h.html#a25">get_runtitle</a>(data) == <a class="code" href="gamessplugin_8h.html#a6">FALSE</a> ) <font class="keywordflow">return</font> <a class="code" href="gamessplugin_8h.html#a6">FALSE</a>;
00622 
00623 
00624   <font class="comment">/* read the contrl group; here we determine the</font>
00625 <font class="comment">   * RUNTYP and bomb out if we don't support</font>
00626 <font class="comment">   * it; also read in some controlflow related</font>
00627 <font class="comment">   * info as well as the COORD type */</font>
00628   <font class="keywordflow">if</font> ( <a class="code" href="gamessplugin_8h.html#a20">check_contrl</a>(data) == <a class="code" href="gamessplugin_8h.html#a6">FALSE</a> ) <font class="keywordflow">return</font> <a class="code" href="gamessplugin_8h.html#a6">FALSE</a>;
00629 
00630 
00631   <font class="comment">/* now call routine get_initial_info to obtain </font>
00632 <font class="comment">   * the number of atoms, the atom types, and the</font>
00633 <font class="comment">   * coordinates, which will be stored in gamess_temp */</font>
00634   <font class="keywordflow">if</font> ( <a class="code" href="gamessplugin_8c.html#a15">get_initial_info</a>(data) == <a class="code" href="gamessplugin_8h.html#a6">FALSE</a> ) <font class="keywordflow">return</font> <a class="code" href="gamessplugin_8h.html#a6">FALSE</a>;
00635 
00636 
00637   <font class="comment">/* provide VMD with the proper number of atoms */</font>
00638   *natoms = data-&gt;<a class="code" href="structgamessdata.html#m1">numatoms</a>;
00639 
00640 
00641   <font class="comment">/* read in the number of orbitals, charge, </font>
00642 <font class="comment">   * multiplicity, ... */</font>
00643   <font class="keywordflow">if</font> ( <a class="code" href="gamessplugin_8c.html#a25">get_num_orbitals</a>(data) == <a class="code" href="gamessplugin_8h.html#a6">FALSE</a> ) <font class="keywordflow">return</font> <a class="code" href="gamessplugin_8h.html#a6">FALSE</a>;
00644 
00645 
00646   <font class="comment">/* check if the wavefunction and orbital stuff</font>
00647 <font class="comment">   * is suported for current GBASIS; if not stop</font>
00648 <font class="comment">   * here and return data pointer */</font>
00649   <font class="keywordflow">if</font> ( <a class="code" href="gamessplugin_8h.html#a34">have_supported_gbasis</a>(data) == <a class="code" href="gamessplugin_8h.html#a6">FALSE</a>) <font class="keywordflow">return</font> <a class="code" href="gamessplugin_8h.html#a7">TRUE</a>;
00650 
00651 
00652   <font class="comment">/* read in the guess options */</font>
00653   <font class="keywordflow">if</font> ( <a class="code" href="gamessplugin_8c.html#a21">get_guess</a>(data) == <a class="code" href="gamessplugin_8h.html#a6">FALSE</a> ) <font class="keywordflow">return</font> <a class="code" href="gamessplugin_8h.html#a6">FALSE</a>;
00654 
00655   
00656   <font class="comment">/* read in the final wavefunction; do this only for </font>
00657 <font class="comment">   * RUNTYP=ENERGY for now. For the other runs I have to</font>
00658 <font class="comment">   * put in some more infrastructure to make sure to</font>
00659 <font class="comment">   * correlate each of the possible many geometries</font>
00660 <font class="comment">   * during e.g. an optimization run with the correstpoding</font>
00661 <font class="comment">   * wavefunction </font>
00662 <font class="comment">   * for now we also have to restrict reading the wavefunctions</font>
00663 <font class="comment">   * for singlets only, since otherwise the punched wavefunction</font>
00664 <font class="comment">   * output differs;</font>
00665 <font class="comment">   * At least the call to generate orbital grid should</font>
00666 <font class="comment">   * not be done automagically but rather after a TCL call</font>
00667 <font class="comment">   * only */</font>
00668   <font class="keywordflow">if</font> ( data-&gt;<a class="code" href="structgamessdata.html#m2">runtyp</a> == <a class="code" href="gamessplugin_8h.html#a8">ENERGY</a> 
00669          &amp;&amp; data-&gt;<a class="code" href="structgamessdata.html#m69">num_orbitals_A</a> == data-&gt;<a class="code" href="structgamessdata.html#m70">num_orbitals_B</a> 
00670          &amp;&amp; <a class="code" href="gamessplugin_8c.html#a0">GRID</a>)
00671   {
00672     <font class="comment">/* read in the basis set information */</font>
00673     <font class="keywordflow">if</font> ( <a class="code" href="gamessplugin_8c.html#a22">get_basis</a>(data) == <a class="code" href="gamessplugin_8h.html#a6">FALSE</a> ) <font class="keywordflow">return</font> <a class="code" href="gamessplugin_8h.html#a6">FALSE</a>; 
00674 
00675 
00676     <font class="comment">/* read the wavefunction */</font>
00677     <font class="keywordflow">if</font> ( <a class="code" href="gamessplugin_8c.html#a26">get_wavefunction</a>(data) == <a class="code" href="gamessplugin_8h.html#a6">FALSE</a>) <font class="keywordflow">return</font> <a class="code" href="gamessplugin_8h.html#a6">FALSE</a>;  
00678 
00679 
00680     <font class="comment">/* figure out which one of the orbitals is the HOMO */</font>
00681     <font class="keywordflow">if</font> ( <a class="code" href="gamessplugin_8c.html#a27">find_homo</a>(data) == <a class="code" href="gamessplugin_8h.html#a6">FALSE</a>) <font class="keywordflow">return</font> <a class="code" href="gamessplugin_8h.html#a6">FALSE</a>; 
00682 
00683  
00684     <font class="comment">/* generate the grid containing the volumetric data</font>
00685 <font class="comment">     * for an orbital */</font>
00686     <font class="keywordflow">if</font>( <a class="code" href="gamessplugin_8c.html#a28">orbital_grid_driver</a>(data) == <a class="code" href="gamessplugin_8h.html#a6">FALSE</a> ) <font class="keywordflow">return</font> <a class="code" href="gamessplugin_8h.html#a6">FALSE</a>;  
00687 
00688   }
00689 
00690   <font class="keywordflow">return</font> <a class="code" href="gamessplugin_8h.html#a7">TRUE</a>;
00691 }
00692 
00693 
00694 
00695 <font class="comment">/******************************************************</font>
00696 <font class="comment"> *</font>
00697 <font class="comment"> * this function extracts the trajectory information</font>
00698 <font class="comment"> * from the output file</font>
00699 <font class="comment"> *</font>
00700 <font class="comment"> * *****************************************************/</font>
<a name="l00701"></a><a class="code" href="gamessplugin_8c.html#a14">00701</a> <font class="keywordtype">int</font> <a class="code" href="gamessplugin_8c.html#a14">get_trajectory</a>(<font class="keywordtype">void</font> *mydata, <a class="code" href="structmolfile__timestep__t.html">molfile_timestep_t</a> *ts,
00702                    <font class="keywordtype">int</font> natoms) 
00703 {
00704   <a class="code" href="structgamessdata.html">gamessdata</a> *data = (<a class="code" href="structgamessdata.html">gamessdata</a> *)mydata;
00705   <font class="keywordtype">char</font> buffer[BUFSIZ];
00706   <font class="keywordtype">char</font> word[4][BUFSIZ];
00707   <font class="keywordtype">char</font> type[8];
00708   <font class="keywordtype">unsigned</font> <font class="keywordtype">int</font> i = 0;
00709   <font class="keywordtype">float</font> charge,x,y,z;
00710   <font class="keywordtype">double</font> scfenergy = 0.0;
00711 
00712   <font class="comment">/* zero out the word arrays */</font>
00713   buffer[0] = <font class="charliteral">'\0'</font>;
00714   type[0] = <font class="charliteral">'\0'</font>;
00715   <font class="keywordflow">for</font> ( i = 0; i &lt; 4; ++i) word[i][0] = <font class="charliteral">'\0'</font>;
00716 
00717 
00718   <font class="comment">/* search for the first coordinate frame during optimization */</font>
00719   <a class="code" href="gamessplugin_8c.html#a2">ERR_FALSE</a>( fgets(buffer,<font class="keyword">sizeof</font>(buffer),data-&gt;<a class="code" href="structgamessdata.html#m0">file</a>) )
00720 
00721 
00722   <font class="comment">/* at this point we have to distinguish between</font>
00723 <font class="comment">   * pre="27 JUN 2005 (R2)" and "27 JUN 2005 (R2)"</font>
00724 <font class="comment">   * versions since the output format for geometry</font>
00725 <font class="comment">   * optimizations has changed */</font>
00726   <font class="keywordflow">if</font> ( data-&gt;<a class="code" href="structgamessdata.html#m16">version</a> == 1)
00727   {
00728      <font class="comment">/* scan for the next optimized geometry punched in the </font>
00729 <font class="comment">      * logfile */</font>
00730      <font class="keywordflow">do</font> 
00731      {
00732        sscanf(buffer,<font class="stringliteral">"%s %s"</font>,&amp;word[0][0],&amp;word[1][0]); <a class="code" href="gamessplugin_8c.html#a2">ERR_FALSE</a>( fgets(buffer,<font class="keyword">sizeof</font>(buffer),data-&gt;<a class="code" href="structgamessdata.html#m0">file</a>) )
00733 
00734      } <font class="keywordflow">while</font> (strcmp(&amp;word[0][0],<font class="stringliteral">"1NSERCH="</font>));
00735   }
00736   <font class="keywordflow">else</font> <font class="keywordflow">if</font> ( data-&gt;<a class="code" href="structgamessdata.html#m16">version</a> == 2 )
00737   {
00738      <font class="comment">/* scan for the next optimized geometry punched in the </font>
00739 <font class="comment">      * logfile */</font>
00740      <font class="keywordflow">do</font> 
00741      {
00742        sscanf(buffer,<font class="stringliteral">"%s %s %s"</font>,&amp;word[0][0],&amp;word[1][0],
00743             &amp;word[2][0]); 
00744        <a class="code" href="gamessplugin_8c.html#a2">ERR_FALSE</a>( fgets(buffer,<font class="keyword">sizeof</font>(buffer),data-&gt;<a class="code" href="structgamessdata.html#m0">file</a>) )
00745 
00746      } <font class="keywordflow">while</font> (strcmp(&amp;word[0][0],<font class="stringliteral">"BEGINNING"</font>) || 
00747               strcmp(&amp;word[1][0],<font class="stringliteral">"GEOMETRY"</font>)  ||
00748               strcmp(&amp;word[2][0],<font class="stringliteral">"SEARCH"</font>));
00749   }
00750 
00751 
00752   <font class="comment">/* skip the next three lines */</font>
00753   <a class="code" href="xsfplugin_8C.html#a36">eatline</a>(data-&gt;<a class="code" href="structgamessdata.html#m0">file</a>);
00754   <a class="code" href="xsfplugin_8C.html#a36">eatline</a>(data-&gt;<a class="code" href="structgamessdata.html#m0">file</a>);
00755   <a class="code" href="xsfplugin_8C.html#a36">eatline</a>(data-&gt;<a class="code" href="structgamessdata.html#m0">file</a>);
00756   
00757 
00758   <font class="comment">/* read the actual coordinates */</font>
00759   <font class="keywordflow">for</font>(i=0;i&lt;natoms;i++) 
00760   {
00761     <a class="code" href="gamessplugin_8c.html#a2">ERR_FALSE</a>( fgets(buffer,<font class="keyword">sizeof</font>(buffer),data-&gt;<a class="code" href="structgamessdata.html#m0">file</a>) )
00762     sscanf(buffer,<font class="stringliteral">"%s %f %f %f %f"</font>,type,&amp;charge,&amp;x,&amp;y,&amp;z);  
00763 
00764     <font class="comment">/* store the coordinates */</font>
00765     ts-&gt;<a class="code" href="structmolfile__timestep__t.html#m0">coords</a>[3*i  ] = x; 
00766     ts-&gt;<a class="code" href="structmolfile__timestep__t.html#m0">coords</a>[3*i+1] = y;
00767     ts-&gt;<a class="code" href="structmolfile__timestep__t.html#m0">coords</a>[3*i+2] = z; 
00768   }     
00769 
00770 
00771   <font class="comment">/* now we look for the SCF energy of this trajectory </font>
00772 <font class="comment">   * point */</font>
00773    <font class="keywordflow">do</font> 
00774    {
00775     <a class="code" href="gamessplugin_8c.html#a2">ERR_FALSE</a>( fgets(buffer,<font class="keyword">sizeof</font>(buffer),data-&gt;<a class="code" href="structgamessdata.html#m0">file</a>) )
00776     sscanf(buffer,<font class="stringliteral">"%s %s %s %lf"</font>,&amp;word[0][0],&amp;word[1][0],
00777         &amp;word[2][0],&amp;scfenergy); 
00778  
00779     } <font class="keywordflow">while</font> (strcmp(&amp;word[2][0],<font class="stringliteral">"ENERGY="</font>) &amp;&amp; 
00780              strcmp(&amp;word[1][0],<font class="stringliteral">"ENERGY="</font>)); 
00781   
00782   <font class="comment">/* allocate more memory for scfenergy array */</font>
00783   data-&gt;<a class="code" href="structgamessdata.html#m27">scfenergies</a> = (<font class="keywordtype">double</font> *)realloc(data-&gt;<a class="code" href="structgamessdata.html#m27">scfenergies</a>,
00784         (data-&gt;<a class="code" href="structgamessdata.html#m78">num_traj_points</a>+1)*<font class="keyword">sizeof</font>(<font class="keywordtype">double</font>));
00785 
00786 
00787   <font class="comment">/* append current scfenergy to array and increase counter */</font>
00788   *(data-&gt;<a class="code" href="structgamessdata.html#m27">scfenergies</a>+data-&gt;<a class="code" href="structgamessdata.html#m78">num_traj_points</a>) = scfenergy;
00789   data-&gt;<a class="code" href="structgamessdata.html#m26">num_scfenergies</a>++;
00790 
00791 
00792   <font class="comment">/* done with this trajectory point */</font> 
00793   <font class="keywordflow">return</font> <a class="code" href="gamessplugin_8h.html#a7">TRUE</a>;
00794 }
00795 
00796 
00797 
00798 <font class="comment">/******************************************************</font>
00799 <font class="comment"> *</font>
00800 <font class="comment"> * this function performs an initial file read</font>
00801 <font class="comment"> * to check its validity and determine the number</font>
00802 <font class="comment"> * of atoms in the system </font>
00803 <font class="comment"> *</font>
00804 <font class="comment"> * *****************************************************/</font>
<a name="l00805"></a><a class="code" href="gamessplugin_8c.html#a15">00805</a> <font class="keywordtype">int</font> <a class="code" href="gamessplugin_8c.html#a15">get_initial_info</a>(<font class="keywordtype">void</font> *mydata)
00806 {
00807   <a class="code" href="structgamessdata.html">gamessdata</a> *data = (<a class="code" href="structgamessdata.html">gamessdata</a> *)mydata;
00808   <a class="code" href="structgamess__temp.html">gamess_temp</a> *atoms;
00809   <font class="keywordtype">char</font> buffer[BUFSIZ];
00810   <font class="keywordtype">char</font> word[4][BUFSIZ];
00811   <font class="keywordtype">char</font> atname[BUFSIZ];
00812   <font class="keywordtype">float</font> charge;
00813   <font class="keywordtype">float</font> x,y,z;
00814   <font class="keywordtype">unsigned</font> <font class="keywordtype">int</font> numatoms;
00815   <font class="keywordtype">unsigned</font> <font class="keywordtype">int</font> bohr;
00816   <font class="keywordtype">unsigned</font> <font class="keywordtype">int</font> i,n;
00817   <font class="keywordtype">unsigned</font> <font class="keywordtype">int</font> have_normal_modes = <a class="code" href="gamessplugin_8h.html#a7">TRUE</a>;
00818   <font class="keywordtype">double</font> scfenergy;
00819   <font class="keywordtype">char</font> *status;
00820 
00821   <font class="comment">/* initialize buffers */</font>
00822   buffer[0] = <font class="charliteral">'\0'</font>;
00823   atname[0] = <font class="charliteral">'\0'</font>;
00824   <font class="keywordflow">for</font> ( i = 0; i &lt; 4; ++i ) word[i][0] = <font class="charliteral">'\0'</font>;
00825  
00826 
00827   <font class="comment">/* alocate temporary data structure */</font>
00828   atoms = (<a class="code" href="structgamess__temp.html">gamess_temp</a> *)calloc(<a class="code" href="gamessplugin_8h.html#a0">MAXQMATOMS</a>,<font class="keyword">sizeof</font>(<a class="code" href="structgamess__temp.html">gamess_temp</a>));
00829 
00830   <font class="comment">/* make sure memory was allocated properly */</font>
00831   <font class="keywordflow">if</font> ( atoms == NULL) 
00832   {
00833     <a class="code" href="gamessplugin_8c.html#a1">PRINTERR</a>; 
00834     <font class="keywordflow">return</font> <a class="code" href="gamessplugin_8h.html#a6">FALSE</a>;
00835   }
00836 
00837 
00838   <font class="comment">/* save pointer */</font>
00839   data-&gt;<a class="code" href="structgamessdata.html#m75">temporary</a> = atoms;
00840 
00841 
00842   <font class="comment">/* counts the number of atoms in input file */</font>
00843   numatoms=0;  
00844 
00845   <font class="comment">/* look for the initial coordinate section </font>
00846 <font class="comment">   * NOTE: I also have to check if the coordinates are</font>
00847 <font class="comment">   * in Angstrom or Bohr and convert them to A in the</font>
00848 <font class="comment">   * latter case */</font>
00849   rewind(data-&gt;<a class="code" href="structgamessdata.html#m0">file</a>);
00850 
00851   <font class="keywordflow">do</font> 
00852   {
00853     <a class="code" href="gamessplugin_8c.html#a2">ERR_FALSE</a>( fgets(buffer,<font class="keyword">sizeof</font>(buffer),data-&gt;<a class="code" href="structgamessdata.html#m0">file</a>) )
00854     sscanf(buffer,<font class="stringliteral">"%s %s %s %s"</font>,&amp;word[0][0],&amp;word[1][0],
00855         &amp;word[2][0],&amp;word[3][0]);
00856 
00857   } <font class="keywordflow">while</font>(strcmp(&amp;word[0][0],<font class="stringliteral">"ATOM"</font>) || 
00858           strcmp(&amp;word[1][0],<font class="stringliteral">"ATOMIC"</font>));
00859 
00860   
00861   <font class="comment">/* test if coordinate units are Bohr */</font>
00862   bohr = (!strcmp(&amp;word[3][0],<font class="stringliteral">"(BOHR)"</font>));
00863 
00864 
00865   <font class="comment">/* skip next line */</font>
00866   <a class="code" href="xsfplugin_8C.html#a36">eatline</a>(data-&gt;<a class="code" href="structgamessdata.html#m0">file</a>);
00867 
00868 
00869   <font class="comment">/* now read in the coordinates until an empty line is being</font>
00870 <font class="comment">   * encoutered */</font>
00871   <a class="code" href="gamessplugin_8c.html#a2">ERR_FALSE</a>( fgets(buffer,<font class="keyword">sizeof</font>(buffer),data-&gt;<a class="code" href="structgamessdata.html#m0">file</a>) )
00872   n = sscanf(buffer,<font class="stringliteral">"%s %f %f %f %f"</font>,atname,&amp;charge,&amp;x,&amp;y,&amp;z);
00873 
00874   <font class="comment">/* we expect 5 entries per line */</font>
00875   <font class="keywordflow">while</font>( n == 5 ) 
00876   {
00877     strncpy(atoms-&gt;<a class="code" href="structgamess__temp.html#m0">type</a>,atname,<font class="keyword">sizeof</font>(atoms-&gt;<a class="code" href="structgamess__temp.html#m0">type</a>));
00878     atoms-&gt;<a class="code" href="structgamess__temp.html#m1">charge</a> = charge;
00879 
00880 
00881     <font class="comment">/* if coordinates are in Bohr convert them to Angstrom here */</font>
00882     <font class="keywordflow">if</font> (bohr) 
00883     {
00884       x = <a class="code" href="gamessplugin_8h.html#a3">BOHR_TO_ANGS</a> * x;
00885       y = <a class="code" href="gamessplugin_8h.html#a3">BOHR_TO_ANGS</a> * y;
00886       z = <a class="code" href="gamessplugin_8h.html#a3">BOHR_TO_ANGS</a> * z;
00887     }
00888 
00889     atoms-&gt;<a class="code" href="structgamess__temp.html#m2">x</a> = x;
00890     atoms-&gt;<a class="code" href="structgamess__temp.html#m3">y</a> = y;
00891     atoms-&gt;<a class="code" href="structgamess__temp.html#m4">z</a> = z; 
00892 
00893 
00894     atoms++;
00895     numatoms++;
00896 
00897     <a class="code" href="gamessplugin_8c.html#a2">ERR_FALSE</a>( fgets(buffer,<font class="keyword">sizeof</font>(buffer),data-&gt;<a class="code" href="structgamessdata.html#m0">file</a>) )
00898     n = sscanf(buffer,<font class="stringliteral">"%s %f %f %f %f"</font>,atname,&amp;charge,&amp;x,&amp;y,&amp;z);
00899   }
00900 
00901   <font class="comment">/* store number of atoms in data structure */</font>
00902   data-&gt;<a class="code" href="structgamessdata.html#m1">numatoms</a> = numatoms;
00903 
00904 
00905 
00906   <font class="comment">/* save a copy of atom charges in atomic_number array</font>
00907 <font class="comment">   * of gamessdata */</font>
00908 
00909   <font class="comment">/* alocate temporary data structure */</font>
00910   data-&gt;<a class="code" href="structgamessdata.html#m20">atomic_number</a> = (<font class="keywordtype">int</font> *)calloc(numatoms,<font class="keyword">sizeof</font>(<font class="keywordtype">int</font>));
00911 
00912   <font class="comment">/* make sure memory was allocated properly */</font>
00913   <font class="keywordflow">if</font> (data-&gt;<a class="code" href="structgamessdata.html#m20">atomic_number</a> == NULL) 
00914   {
00915     <a class="code" href="gamessplugin_8c.html#a1">PRINTERR</a>; 
00916     <font class="keywordflow">return</font> <a class="code" href="gamessplugin_8h.html#a6">FALSE</a>;
00917   }
00918 
00919   
00920   <font class="comment">/* move data over */</font> 
00921   <font class="keywordflow">for</font> ( n = 0; n &lt; numatoms; n++) 
00922   {
00923     *(data-&gt;<a class="code" href="structgamessdata.html#m20">atomic_number</a> + n) = (int)(data-&gt;<a class="code" href="structgamessdata.html#m75">temporary</a> + n)-&gt;charge;
00924   }
00925 
00926 
00927   <font class="comment">/* at this point we create an empty scfenergy arrar */</font>
00928   data-&gt;<a class="code" href="structgamessdata.html#m27">scfenergies</a> = (<font class="keywordtype">double</font> *)calloc(0,<font class="keyword">sizeof</font>(<font class="keywordtype">double</font>));
00929 
00930 
00931   <font class="comment">/* of we are dealing with a single point energy run </font>
00932 <font class="comment">   * we read in the final SCF energy and store it;</font>
00933 <font class="comment">   * TODO: for now also include HESSIAN runs here even though</font>
00934 <font class="comment">   * this is not completely correct in the case of numerical</font>
00935 <font class="comment">   * runs*/</font>
00936   <font class="keywordflow">if</font> ( (data-&gt;<a class="code" href="structgamessdata.html#m2">runtyp</a> == <a class="code" href="gamessplugin_8h.html#a8">ENERGY</a>) || (data-&gt;<a class="code" href="structgamessdata.html#m2">runtyp</a> == <a class="code" href="gamessplugin_8h.html#a11">HESSIAN</a>) )
00937   {
00938     status = fgets(buffer,<font class="keyword">sizeof</font>(buffer),data-&gt;<a class="code" href="structgamessdata.html#m0">file</a>);
00939      
00940     <font class="keywordflow">while</font> ( strcmp(&amp;word[0][0],<font class="stringliteral">"FINAL"</font>) || 
00941             strcmp(&amp;word[2][0],<font class="stringliteral">"ENERGY"</font>) ||
00942             strcmp(&amp;word[3][0],<font class="stringliteral">"IS"</font>))
00943     {
00944       sscanf(buffer,<font class="stringliteral">"%s %s %s %s %lf"</font>,&amp;word[0][0],&amp;word[1][0],
00945              &amp;word[2][0],&amp;word[3][0],&amp;scfenergy);
00946 
00947       <font class="keywordflow">if</font> ( fgets(buffer,<font class="keyword">sizeof</font>(buffer),data-&gt;<a class="code" href="structgamessdata.html#m0">file</a>) == NULL) <font class="keywordflow">break</font>;
00948     }
00949 
00950     data-&gt;<a class="code" href="structgamessdata.html#m27">scfenergies</a> = (<font class="keywordtype">double</font> *)realloc(data-&gt;<a class="code" href="structgamessdata.html#m27">scfenergies</a>,
00951              <font class="keyword">sizeof</font>(<font class="keywordtype">double</font>));
00952     *(data-&gt;<a class="code" href="structgamessdata.html#m27">scfenergies</a>) = scfenergy;
00953     data-&gt;<a class="code" href="structgamessdata.html#m26">num_scfenergies</a>++;
00954   }
00955 
00956 
00957   <font class="comment">/* next we check for the Mulliken charges; if they are present</font>
00958 <font class="comment">   * we set the have_mulliken charge flag, but don't bomb out */</font>
00959 
00960   <font class="comment">/* set have_mulliken initially to true */</font>
00961   data-&gt;<a class="code" href="structgamessdata.html#m35">have_mulliken</a> = <a class="code" href="gamessplugin_8h.html#a7">TRUE</a>;
00962 
00963   <font class="keywordflow">do</font> 
00964   {
00965     status = fgets(buffer,<font class="keyword">sizeof</font>(buffer),data-&gt;<a class="code" href="structgamessdata.html#m0">file</a>);
00966 
00967     <font class="comment">/* check for EOF */</font>
00968     <font class="keywordflow">if</font> (status == NULL) {
00969      
00970       data-&gt;<a class="code" href="structgamessdata.html#m35">have_mulliken</a> = <a class="code" href="gamessplugin_8h.html#a6">FALSE</a>;
00971       <font class="keywordflow">break</font>;
00972     }
00973 
00974     sscanf(buffer,<font class="stringliteral">"%s %s %s %s"</font>,&amp;word[0][0],&amp;word[1][0],
00975         &amp;word[2][0],&amp;word[3][0]);
00976 
00977   } <font class="keywordflow">while</font>(strcmp(&amp;word[0][0],<font class="stringliteral">"TOTAL"</font>) || 
00978           strcmp(&amp;word[1][0],<font class="stringliteral">"MULLIKEN"</font>) ||
00979           strcmp(&amp;word[2][0],<font class="stringliteral">"AND"</font>)   || 
00980           strcmp(&amp;word[3][0],<font class="stringliteral">"LOWDIN"</font>) );
00981 
00982 
00983   <font class="comment">/* if Mulliken Charges are present read them, if not, rewind</font>
00984 <font class="comment">   * the file and look for the ESP charges */</font>
00985   <font class="keywordflow">if</font> ( data-&gt;<a class="code" href="structgamessdata.html#m35">have_mulliken</a> == <a class="code" href="gamessplugin_8h.html#a7">TRUE</a> ) 
00986   {
00987     <font class="comment">/* reserve memory for dynamically allocated</font>
00988 <font class="comment">     * Mulliken charge array */</font>
00989     data-&gt;<a class="code" href="structgamessdata.html#m33">mulliken_charges</a> = 
00990       (<font class="keywordtype">double</font> *)calloc(numatoms,<font class="keyword">sizeof</font>(<font class="keywordtype">double</font>));
00991 
00992     <font class="comment">/* check for success */</font>
00993     <font class="keywordflow">if</font> (data-&gt;<a class="code" href="structgamessdata.html#m33">mulliken_charges</a> == NULL) 
00994     {
00995       <a class="code" href="gamessplugin_8c.html#a1">PRINTERR</a>; 
00996       <font class="keywordflow">return</font> <a class="code" href="gamessplugin_8h.html#a6">FALSE</a>;
00997     }
00998 
00999 
01000     <font class="comment">/* skip next line */</font>
01001     <a class="code" href="xsfplugin_8C.html#a36">eatline</a>(data-&gt;<a class="code" href="structgamessdata.html#m0">file</a>);
01002 
01003     <font class="keywordflow">for</font> ( n = 0; n &lt; numatoms; ++n) 
01004     {
01005       <font class="comment">/* make sure we don't get nuked by a bad file */</font>
01006       <a class="code" href="gamessplugin_8c.html#a2">ERR_FALSE</a>( fgets(buffer,<font class="keyword">sizeof</font>(buffer),data-&gt;<a class="code" href="structgamessdata.html#m0">file</a>) )
01007 
01008       sscanf(buffer,<font class="stringliteral">"%s %s %s %lf "</font>,&amp;word[0][0], &amp;word[1][0], 
01009           &amp;word[2][0], (data-&gt;<a class="code" href="structgamessdata.html#m33">mulliken_charges</a>+n));
01010     }
01011   }
01012 
01013   <font class="comment">/* no Mulliken charges found; in this case we don't know where</font>
01014 <font class="comment">   * we are in the file; hence rewind file */</font>
01015   <font class="keywordflow">else</font> 
01016   {
01017     rewind(data-&gt;<a class="code" href="structgamessdata.html#m0">file</a>); 
01018   }
01019 
01020 
01021   <font class="comment">/* next we check for the ESP charges; if they are present</font>
01022 <font class="comment">   * we set the have_esp charge flag, but don't bomb out */</font>
01023 
01024   <font class="comment">/* set have_esd initially to true */</font>
01025   data-&gt;<a class="code" href="structgamessdata.html#m36">have_esp</a> = <a class="code" href="gamessplugin_8h.html#a7">TRUE</a>;
01026 
01027   <font class="keywordflow">do</font> 
01028   {
01029     status = fgets(buffer,<font class="keyword">sizeof</font>(buffer),data-&gt;<a class="code" href="structgamessdata.html#m0">file</a>);
01030 
01031     <font class="comment">/* check for EOF */</font>
01032     <font class="keywordflow">if</font> (status == NULL) {
01033      
01034       data-&gt;<a class="code" href="structgamessdata.html#m36">have_esp</a> = <a class="code" href="gamessplugin_8h.html#a6">FALSE</a>;
01035       <font class="keywordflow">break</font>;
01036     }
01037 
01038     sscanf(buffer,<font class="stringliteral">"%s %s %s"</font>,&amp;word[0][0],&amp;word[1][0],&amp;word[2][0]);
01039 
01040   } <font class="keywordflow">while</font>(strcmp(&amp;word[0][0],<font class="stringliteral">"ATOM"</font>) || 
01041           strcmp(&amp;word[1][0],<font class="stringliteral">"CHARGE"</font>) ||
01042           strcmp(&amp;word[2][0],<font class="stringliteral">"E.S.D."</font>) );
01043 
01044 
01045   <font class="comment">/* if ESP Charges are present read them, if not, rewind</font>
01046 <font class="comment">   * the file and return */</font>
01047   <font class="keywordflow">if</font> ( data-&gt;<a class="code" href="structgamessdata.html#m36">have_esp</a> == <a class="code" href="gamessplugin_8h.html#a7">TRUE</a> ) 
01048   {
01049     <font class="comment">/* reserve memory for dynamically allocated</font>
01050 <font class="comment">     * Mulliken charge array */</font>
01051     data-&gt;<a class="code" href="structgamessdata.html#m34">esp_charges</a> = 
01052       (<font class="keywordtype">double</font> *)calloc(numatoms,<font class="keyword">sizeof</font>(<font class="keywordtype">double</font>));
01053 
01054     <font class="comment">/* check for success */</font>
01055     <font class="keywordflow">if</font> (data-&gt;<a class="code" href="structgamessdata.html#m34">esp_charges</a> == NULL) 
01056     {
01057       <a class="code" href="gamessplugin_8c.html#a1">PRINTERR</a>; 
01058       <font class="keywordflow">return</font> <a class="code" href="gamessplugin_8h.html#a6">FALSE</a>;
01059     }
01060 
01061 
01062     <font class="comment">/* skip next line */</font>
01063     <a class="code" href="xsfplugin_8C.html#a36">eatline</a>(data-&gt;<a class="code" href="structgamessdata.html#m0">file</a>);
01064 
01065     <font class="keywordflow">for</font> ( n = 0; n &lt; numatoms; ++n) {
01066 
01067       <font class="comment">/* make sure we don't get nuked by a bad file */</font>
01068       <a class="code" href="gamessplugin_8c.html#a2">ERR_FALSE</a>( fgets(buffer,<font class="keyword">sizeof</font>(buffer),data-&gt;<a class="code" href="structgamessdata.html#m0">file</a>) )
01069       sscanf(buffer,<font class="stringliteral">"%s %lf "</font>,&amp;word[0][0], (data-&gt;<a class="code" href="structgamessdata.html#m34">esp_charges</a>+n));
01070     }
01071   }
01072 
01073   <font class="comment">/* no ESP charges found; in this case we don't know where</font>
01074 <font class="comment">   * we are in the file; hence rewind file */</font>
01075   <font class="keywordflow">else</font> 
01076   {
01077     rewind(data-&gt;<a class="code" href="structgamessdata.html#m0">file</a>); 
01078   }
01079 
01080 
01081   <font class="comment">/* short message */</font> 
01082   printf(<font class="stringliteral">"gamessplugin&gt; Detected %d atoms in the input file. \n"</font>,
01083           data-&gt;<a class="code" href="structgamessdata.html#m1">numatoms</a>);
01084 
01085 
01086   <font class="keywordflow">if</font> ( data-&gt;<a class="code" href="structgamessdata.html#m2">runtyp</a> == <a class="code" href="gamessplugin_8h.html#a11">HESSIAN</a> ) 
01087   {
01088 
01089 <font class="preprocessor">#ifdef ANIMATE_MODE</font>
01090 <font class="preprocessor"></font>    <a class="code" href="gamessplugin_8c.html#a16">initialize_animated_mode</a>(data);
01091 <font class="preprocessor">#endif</font>
01092 <font class="preprocessor"></font>
01093     <font class="comment">/* try reading the hessian matrix in internal and</font>
01094 <font class="comment">     * cartesian coordinates as well as the internal</font>
01095 <font class="comment">     * coordinates together with their associated</font>
01096 <font class="comment">     * force constants */</font>
01097     <font class="keywordflow">if</font> ( <a class="code" href="gamessplugin_8c.html#a20">get_int_coords</a>(data) == <a class="code" href="gamessplugin_8h.html#a7">TRUE</a> ) 
01098     {
01099       data-&gt;<a class="code" href="structgamessdata.html#m37">have_internals</a> = <a class="code" href="gamessplugin_8h.html#a7">TRUE</a>;
01100     }
01101     <font class="keywordflow">else</font> 
01102     {
01103       printf(<font class="stringliteral">"gamessplugin&gt; \n"</font>);
01104       printf(<font class="stringliteral">"gamessplugin&gt; Could not determine the internal \n"</font>);
01105       printf(<font class="stringliteral">"gamessplugin&gt; coordinate and Hessian info!! \n"</font>);
01106       printf(<font class="stringliteral">"gamessplugin&gt; \n"</font>);
01107     }
01108     
01109  
01110     <font class="keywordflow">if</font> ( <a class="code" href="gamessplugin_8c.html#a19">get_cart_hessian</a>(data) == <a class="code" href="gamessplugin_8h.html#a7">TRUE</a> ) 
01111     {
01112       data-&gt;<a class="code" href="structgamessdata.html#m38">have_cart_hessian</a> = <a class="code" href="gamessplugin_8h.html#a7">TRUE</a>;
01113     }
01114     <font class="keywordflow">else</font> 
01115     {
01116       printf(<font class="stringliteral">"gamessplugin&gt; \n"</font>);
01117       printf(<font class="stringliteral">"gamessplugin&gt; Could not determine the cartesian \n"</font>);
01118       printf(<font class="stringliteral">"gamessplugin&gt; Hessian matrix!! \n"</font>);
01119       printf(<font class="stringliteral">"gamessplugin&gt; \n"</font>);
01120     }
01121 
01122 
01123     <font class="comment">/* read the wavenumbers, intensities of the normal modes </font>
01124 <font class="comment">     * as well as the modes themselves */</font>
01125     <font class="keywordflow">if</font> ( <a class="code" href="gamessplugin_8c.html#a18">get_normal_modes</a>(data) == <a class="code" href="gamessplugin_8h.html#a6">FALSE</a> ) 
01126     {
01127       printf(<font class="stringliteral">"gamessplugin&gt; \n"</font>);
01128       printf(<font class="stringliteral">"gamessplugin&gt; Could not scan the normal modes,\n"</font>);
01129       printf(<font class="stringliteral">"gamessplugin&gt; \n"</font>);
01130 
01131       have_normal_modes = <a class="code" href="gamessplugin_8h.html#a6">FALSE</a>;
01132     }
01133 
01134 <font class="preprocessor">#ifdef ANIMATE_MODE</font>
01135 <font class="preprocessor"></font>    <font class="comment">/* generate an animated trajectory for mode i */</font> 
01136     <font class="keywordflow">if</font> (data-&gt;<a class="code" href="structgamessdata.html#m38">have_cart_hessian</a> &amp;&amp; have_normal_modes) 
01137     {
01138       <font class="keywordflow">if</font> ( <a class="code" href="gamessplugin_8c.html#a17">animate_normal_mode</a>(data, 62) == <a class="code" href="gamessplugin_8h.html#a6">FALSE</a> )
01139       {
01140         printf(<font class="stringliteral">"gamessplugin&gt; \n"</font>);
01141         printf(<font class="stringliteral">"gamessplugin&gt; Error generating animated normal mode"</font>);
01142         printf(<font class="stringliteral">"gamessplugin&gt; \n \n"</font>);
01143       }
01144     }
01145 <font class="preprocessor">#endif</font>
01146 <font class="preprocessor"></font>
01147   }
01148 
01149   <font class="comment">/* done with this one */</font>
01150   <font class="keywordflow">return</font> <a class="code" href="gamessplugin_8h.html#a7">TRUE</a>; 
01151 }
01152 
01153 
01154 
01155 <font class="comment">/******************************************************</font>
01156 <font class="comment"> *</font>
01157 <font class="comment"> * this function generates animated frames for normal</font>
01158 <font class="comment"> * mode mode_to_animate</font>
01159 <font class="comment"> *</font>
01160 <font class="comment"> * *****************************************************/</font>
<a name="l01161"></a><a class="code" href="gamessplugin_8c.html#a16">01161</a> <font class="keywordtype">int</font> <a class="code" href="gamessplugin_8c.html#a16">initialize_animated_mode</a>(<font class="keywordtype">void</font> *mydata)
01162 {
01163   <a class="code" href="structgamessdata.html">gamessdata</a> *data = (<a class="code" href="structgamessdata.html">gamessdata</a> *)mydata;
01164   <a class="code" href="structmode__data.html">mode_data</a> *animated_mode;
01165 
01166   <font class="comment">/* allocate memory for a mode_data struct */</font>
01167   animated_mode = (<a class="code" href="structmode__data.html">mode_data</a> *)calloc(1,<font class="keyword">sizeof</font>(<a class="code" href="structmode__data.html">mode_data</a>)); 
01168 
01169   <font class="keywordflow">if</font> ( animated_mode == NULL )
01170   {
01171     <a class="code" href="gamessplugin_8c.html#a1">PRINTERR</a>;
01172     <font class="keywordflow">return</font> <a class="code" href="gamessplugin_8h.html#a6">FALSE</a>;
01173   }
01174 
01175   <font class="comment">/* save pointer in gamessdata struct */</font>
01176   data-&gt;<a class="code" href="structgamessdata.html#m76">animated_mode</a> = animated_mode;
01177 
01178   <font class="comment">/* set the number of frames per animated mode */</font>
01179   animated_mode-&gt;<a class="code" href="structmode__data.html#m1">mode_num_frames</a> = 25;
01180 
01181   <font class="comment">/* initialize the animated mode tracker */</font>
01182   animated_mode-&gt;<a class="code" href="structmode__data.html#m2">current_mode_frame</a> = 0;
01183 
01184   <font class="comment">/* set the scaling factor for the animated mode */</font>
01185   animated_mode-&gt;<a class="code" href="structmode__data.html#m3">mode_scaling</a> = 0.01;
01186 
01187   <font class="comment">/* reserve memory for animated mode trajectory */</font>
01188   animated_mode-&gt;<a class="code" href="structmode__data.html#m0">mode_frames</a> = (<font class="keywordtype">double</font> *)calloc((4 *
01189       animated_mode-&gt;<a class="code" href="structmode__data.html#m1">mode_num_frames</a>+3)*data-&gt;<a class="code" href="structgamessdata.html#m1">numatoms</a>*3, 
01190       <font class="keyword">sizeof</font>(<font class="keywordtype">double</font>));
01191 
01192   <font class="keywordflow">if</font> ( animated_mode-&gt;<a class="code" href="structmode__data.html#m0">mode_frames</a> == NULL )
01193   {
01194     <a class="code" href="gamessplugin_8c.html#a1">PRINTERR</a>;
01195     <font class="keywordflow">return</font> <a class="code" href="gamessplugin_8h.html#a6">FALSE</a>;
01196   }
01197 
01198   <font class="keywordflow">return</font> <a class="code" href="gamessplugin_8h.html#a7">TRUE</a>;
01199 }
01200 
01201 
01202 
01203 <font class="comment">/************************************************************</font>
01204 <font class="comment"> *</font>
01205 <font class="comment"> * this function animates a given normal mode by means of</font>
01206 <font class="comment"> * generating mod_num_frames frames away from the equilibrium</font>
01207 <font class="comment"> * structure in a direction given by the hessiane </font>
01208 <font class="comment"> *</font>
01209 <font class="comment"> ************************************************************/</font>
<a name="l01210"></a><a class="code" href="gamessplugin_8c.html#a17">01210</a> <font class="keywordtype">int</font> <a class="code" href="gamessplugin_8c.html#a17">animate_normal_mode</a>(<font class="keywordtype">void</font> *mydata, <font class="keywordtype">unsigned</font> <font class="keywordtype">int</font> mode)
01211 {
01212   <a class="code" href="structgamessdata.html">gamessdata</a> *data = (<a class="code" href="structgamessdata.html">gamessdata</a> *)mydata;
01213   <a class="code" href="structmode__data.html">mode_data</a> *animated_mode = data-&gt;<a class="code" href="structgamessdata.html#m76">animated_mode</a>;
01214   <font class="keywordtype">double</font> *normal_modes = data-&gt;<a class="code" href="structgamessdata.html#m30">normal_modes</a>;
01215   <font class="keywordtype">double</font> scale = animated_mode-&gt;<a class="code" href="structmode__data.html#m3">mode_scaling</a>;
01216   <font class="keywordtype">unsigned</font> <font class="keywordtype">int</font> i = 0, k = 0; 
01217   <font class="keywordtype">int</font> l = 0, m = 0;
01218   <font class="keywordtype">unsigned</font> <font class="keywordtype">int</font> natoms = data-&gt;<a class="code" href="structgamessdata.html#m1">numatoms</a>;
01219   <font class="keywordtype">unsigned</font> <font class="keywordtype">int</font> num_frames = animated_mode-&gt;<a class="code" href="structmode__data.html#m1">mode_num_frames</a>;
01220 
01221   <font class="comment">/* first sweep to max of interval */</font>
01222   <font class="keywordflow">for</font> ( k = 0; k &lt; num_frames+1; ++k)
01223   {
01224     <font class="keywordflow">for</font> ( i = 0; i &lt; natoms; ++i)
01225     {
01226       *(animated_mode-&gt;<a class="code" href="structmode__data.html#m0">mode_frames</a>+(k*natoms*3)+(3*i)) = 
01227           (data-&gt;<a class="code" href="structgamessdata.html#m75">temporary</a>+i)-&gt;x * (1+( k*scale * 
01228           (*(normal_modes+(mode*natoms*3)+(3*i)))));
01229 
01230       *(animated_mode-&gt;<a class="code" href="structmode__data.html#m0">mode_frames</a>+(k*natoms*3)+(3*i+1)) = 
01231           (data-&gt;<a class="code" href="structgamessdata.html#m75">temporary</a>+i)-&gt;y * (1+( k*scale * 
01232           (*(normal_modes+(mode*natoms*3)+(3*i+1)))));
01233 
01234       *(animated_mode-&gt;<a class="code" href="structmode__data.html#m0">mode_frames</a>+(k*natoms*3)+(3*i+2)) = 
01235           (data-&gt;<a class="code" href="structgamessdata.html#m75">temporary</a>+i)-&gt;z * (1+( k*scale * 
01236           (*(normal_modes+(mode*natoms*3)+(3*i+2)))));
01237     }
01238   }
01239 
01240 
01241   <font class="comment">/* second sweep all the way back to min of interval */</font>
01242   <font class="keywordflow">for</font> ( l = 0; l &lt; 2*num_frames+1; ++l)
01243   {
01244     <font class="keywordflow">for</font> ( i = 0; i &lt; natoms; ++i)
01245     {
01246       *(animated_mode-&gt;<a class="code" href="structmode__data.html#m0">mode_frames</a>+((l+k)*natoms*3)+(3*i)) = 
01247           (data-&gt;<a class="code" href="structgamessdata.html#m75">temporary</a>+i)-&gt;x * (1+((int)(num_frames-l)*scale * 
01248           (*(normal_modes+(mode*natoms*3)+(3*i)))));
01249 
01250       *(animated_mode-&gt;<a class="code" href="structmode__data.html#m0">mode_frames</a>+((l+k)*natoms*3)+(3*i+1)) = 
01251           (data-&gt;<a class="code" href="structgamessdata.html#m75">temporary</a>+i)-&gt;y * (1+((int)(num_frames-l)*scale * 
01252           (*(normal_modes+(mode*natoms*3)+(3*i+1)))));
01253 
01254       *(animated_mode-&gt;<a class="code" href="structmode__data.html#m0">mode_frames</a>+((l+k)*natoms*3)+(3*i+2)) = 
01255           (data-&gt;<a class="code" href="structgamessdata.html#m75">temporary</a>+i)-&gt;z * (1+((int)(num_frames-l)*scale * 
01256           (*(normal_modes+(mode*natoms*3)+(3*i+2)))));
01257     }
01258   }
01259 
01260 
01261   <font class="comment">/* third sweep back to the native starting structure */</font>
01262   <font class="keywordflow">for</font> ( m = 0; m &lt; num_frames+1; ++m)
01263   {
01264     <font class="keywordflow">for</font> ( i = 0; i &lt; natoms; ++i)
01265     {
01266       *(animated_mode-&gt;<a class="code" href="structmode__data.html#m0">mode_frames</a>+((l+k+m)*natoms*3)+(3*i)) = 
01267           (data-&gt;<a class="code" href="structgamessdata.html#m75">temporary</a>+i)-&gt;x * (1+((int)(m-num_frames)*scale * 
01268           (*(normal_modes+(mode*natoms*3)+(3*i)))));
01269 
01270       *(animated_mode-&gt;<a class="code" href="structmode__data.html#m0">mode_frames</a>+((l+k+m)*natoms*3)+(3*i+1)) = 
01271           (data-&gt;<a class="code" href="structgamessdata.html#m75">temporary</a>+i)-&gt;y * (1+((int)(m-num_frames)*scale * 
01272           (*(normal_modes+(mode*natoms*3)+(3*i+1)))));
01273 
01274       *(animated_mode-&gt;<a class="code" href="structmode__data.html#m0">mode_frames</a>+((l+k+m)*natoms*3)+(3*i+2)) = 
01275           (data-&gt;<a class="code" href="structgamessdata.html#m75">temporary</a>+i)-&gt;z * (1+((int)(m-num_frames)*scale * 
01276           (*(normal_modes+(mode*natoms*3)+(3*i+2)))));
01277     }
01278   }
01279 
01280   <font class="comment">/* short message */</font>
01281   printf(<font class="stringliteral">"gamessplugin&gt; Successfully animated mode %d \n"</font>, mode);
01282 
01283   <font class="keywordflow">return</font> <a class="code" href="gamessplugin_8h.html#a7">TRUE</a>;
01284 }
01285 
01286 
01287 
01288 <font class="comment">/***********************************************************</font>
01289 <font class="comment"> *</font>
01290 <font class="comment"> * this function reads in the wavenumbers and intensities of</font>
01291 <font class="comment"> * the normal modes</font>
01292 <font class="comment"> *</font>
01293 <font class="comment"> * *********************************************************/</font>
<a name="l01294"></a><a class="code" href="gamessplugin_8c.html#a18">01294</a> <font class="keywordtype">int</font> <a class="code" href="gamessplugin_8c.html#a18">get_normal_modes</a>(<font class="keywordtype">void</font> *mydata)
01295 {
01296   <a class="code" href="structgamessdata.html">gamessdata</a> *data = (<a class="code" href="structgamessdata.html">gamessdata</a> *)mydata;
01297   <font class="keywordtype">char</font> word[4][BUFSIZ];
01298   <font class="keywordtype">char</font> buffer[BUFSIZ];
01299   <font class="keywordtype">unsigned</font> <font class="keywordtype">int</font> i = 0, k = 0, j = 0;
01300   <font class="keywordtype">unsigned</font> <font class="keywordtype">int</font> remaining_columns;
01301   <font class="keywordtype">double</font> entry[6]; 
01302   <font class="keywordtype">char</font> separator;
01303   <font class="keywordtype">char</font> *item;
01304   <font class="keywordtype">unsigned</font> <font class="keywordtype">int</font> counter;
01305 
01306 
01307   <font class="comment">/* initialize arrays */</font>
01308   buffer[0] = <font class="charliteral">'\0'</font>;
01309   memset(entry, 0, <font class="keyword">sizeof</font>(entry));
01310   <font class="keywordflow">for</font> ( i = 0; i &lt; 4; ++i) word[i][0] = <font class="charliteral">'\0'</font>;
01311 
01312     
01313   <font class="comment">/* reserve memory for dynamically allocated data</font>
01314 <font class="comment">   * arrays */</font>
01315   item = (<font class="keywordtype">char</font> *)calloc(BUFSIZ,<font class="keyword">sizeof</font>(<font class="keywordtype">char</font>));
01316 
01317   <font class="keywordflow">if</font> ( item == NULL )
01318   {
01319     <a class="code" href="gamessplugin_8c.html#a1">PRINTERR</a>;
01320     <font class="keywordflow">return</font> <a class="code" href="gamessplugin_8h.html#a6">FALSE</a>;
01321   }
01322 
01323 
01324   data-&gt;<a class="code" href="structgamessdata.html#m28">wavenumbers</a> = 
01325     (<font class="keywordtype">double</font> *)calloc(data-&gt;<a class="code" href="structgamessdata.html#m1">numatoms</a>*3,<font class="keyword">sizeof</font>(<font class="keywordtype">double</font>));
01326 
01327   <font class="keywordflow">if</font> ( data-&gt;<a class="code" href="structgamessdata.html#m28">wavenumbers</a> == NULL ) 
01328   {
01329     <a class="code" href="gamessplugin_8c.html#a1">PRINTERR</a>;
01330     <font class="keywordflow">return</font> <a class="code" href="gamessplugin_8h.html#a6">FALSE</a>;
01331   }
01332 
01333 
01334   data-&gt;<a class="code" href="structgamessdata.html#m29">intensities</a> = 
01335     (<font class="keywordtype">double</font> *)calloc(data-&gt;<a class="code" href="structgamessdata.html#m1">numatoms</a>*3,<font class="keyword">sizeof</font>(<font class="keywordtype">double</font>));
01336 
01337   <font class="keywordflow">if</font> ( data-&gt;<a class="code" href="structgamessdata.html#m29">intensities</a> == NULL ) 
01338   {
01339     <a class="code" href="gamessplugin_8c.html#a1">PRINTERR</a>;
01340     <font class="keywordflow">return</font> <a class="code" href="gamessplugin_8h.html#a6">FALSE</a>;
01341   }
01342 
01343 
01344   data-&gt;<a class="code" href="structgamessdata.html#m30">normal_modes</a> = 
01345     (<font class="keywordtype">double</font> *)calloc((data-&gt;<a class="code" href="structgamessdata.html#m1">numatoms</a>*3)*(data-&gt;<a class="code" href="structgamessdata.html#m1">numatoms</a>*3),
01346                      <font class="keyword">sizeof</font>(<font class="keywordtype">double</font>));
01347 
01348   <font class="keywordflow">if</font> ( data-&gt;<a class="code" href="structgamessdata.html#m30">normal_modes</a> == NULL ) 
01349   {
01350     <a class="code" href="gamessplugin_8c.html#a1">PRINTERR</a>;
01351     <font class="keywordflow">return</font> <a class="code" href="gamessplugin_8h.html#a6">FALSE</a>;
01352   }
01353 
01354 
01355   <font class="comment">/* look for FREQUENCYs and IR INTENSITIES */</font>
01356   <font class="keywordflow">for</font> ( i = 0; i &lt; (<font class="keywordtype">unsigned</font> <font class="keywordtype">int</font>)(data-&gt;<a class="code" href="structgamessdata.html#m1">numatoms</a>*3/5); ++i) 
01357   {
01358     <font class="keywordflow">do</font> 
01359     {
01360       <a class="code" href="gamessplugin_8c.html#a2">ERR_FALSE</a>( fgets(buffer,<font class="keyword">sizeof</font>(buffer),data-&gt;<a class="code" href="structgamessdata.html#m0">file</a>) )
01361       sscanf(buffer,<font class="stringliteral">"%s "</font>,&amp;word[0][0]);
01362 
01363     } <font class="keywordflow">while</font>(strcmp(&amp;word[0][0],<font class="stringliteral">"FREQUENCY:"</font>));
01364 
01365 
01366     <font class="comment">/* scan the frequencies; </font>
01367 <font class="comment">     * this requires some care since there might</font>
01368 <font class="comment">     * be imaginary modes present which leads to</font>
01369 <font class="comment">     * an additional char per imaginary mode per</font>
01370 <font class="comment">     * line */</font>
01371 
01372     <font class="comment">/* check for imaginary modes */</font>
01373     <font class="keywordflow">if</font> ( strchr(buffer,<font class="charliteral">'I'</font>) != NULL ) 
01374     {
01375       <font class="comment">/* initialize */</font>
01376       separator = <font class="charliteral">' '</font>;
01377       counter = 0;
01378 
01379       <font class="comment">/* read all line elements into individual strings */</font>
01380 
01381       <font class="comment">/* skip first entry "FREQUENCY" */</font>
01382       item = strtok(buffer,&amp;separator);
01383       
01384       <font class="comment">/* start going through the string */</font>
01385       <font class="keywordflow">while</font> ( (item = strtok(NULL,&amp;separator)) != NULL ) 
01386       {
01387         <font class="comment">/* check if item is 'I'; if yes, mark previous mode</font>
01388 <font class="comment">         * as imaginary; otherwise save the mode */</font>
01389         <font class="keywordflow">if</font> ( *item == <font class="charliteral">'I'</font> ) 
01390         {
01391           data-&gt;<a class="code" href="structgamessdata.html#m24">nimag</a>++;
01392         }
01393         <font class="keywordflow">else</font> 
01394         {
01395           <font class="comment">/* save only the first 5 modes - there NEVER should</font>
01396 <font class="comment">           * be more in any case, but just to make sure</font>
01397 <font class="comment">           * we don't overrun the array */</font>
01398           <font class="keywordflow">if</font> ( counter &lt; 5 ) 
01399           {
01400             *(data-&gt;<a class="code" href="structgamessdata.html#m28">wavenumbers</a>+(i*5)+counter) = atof(item);
01401             counter++;
01402           }
01403         }
01404       } 
01405     }
01406 
01407 
01408     <font class="comment">/* no imaginary mode, reading is straightforward */</font>
01409     <font class="keywordflow">else</font> 
01410     {
01411       sscanf(buffer,<font class="stringliteral">"%s %lf %lf %lf %lf %lf"</font>,&amp;word[0][0],
01412         &amp;entry[0],&amp;entry[1],&amp;entry[2],&amp;entry[3],&amp;entry[4]); 
01413     
01414       <font class="comment">/* save 'em */</font>
01415       <font class="keywordflow">for</font> ( k = 0; k &lt; 5; ++k) 
01416       {
01417         *(data-&gt;<a class="code" href="structgamessdata.html#m28">wavenumbers</a>+(i*5)+k) = entry[k]; 
01418       }
01419     }
01420 
01421 
01422     <font class="comment">/* skip next line */</font>
01423     <a class="code" href="xsfplugin_8C.html#a36">eatline</a>(data-&gt;<a class="code" href="structgamessdata.html#m0">file</a>);
01424 
01425 
01426     <font class="comment">/* next line contains the IR INTENSITIES */</font>
01427     <a class="code" href="gamessplugin_8c.html#a2">ERR_FALSE</a>( fgets(buffer,<font class="keyword">sizeof</font>(buffer),data-&gt;<a class="code" href="structgamessdata.html#m0">file</a>) )
01428 
01429     <font class="comment">/* scan the IR INTENSITIES */</font>
01430     sscanf(buffer,<font class="stringliteral">"%s %s %lf %lf %lf %lf %lf"</font>,&amp;word[0][0],&amp;word[1][0],
01431         &amp;entry[0],&amp;entry[1],&amp;entry[2],&amp;entry[3],&amp;entry[4]);
01432  
01433 
01434     <font class="comment">/* save 'em */</font>
01435     <font class="keywordflow">for</font> ( k = 0; k &lt; 5; ++k) 
01436     {
01437       *(data-&gt;<a class="code" href="structgamessdata.html#m29">intensities</a>+(i*5)+k) = entry[k]; 
01438     }
01439 
01440     <font class="comment">/* skip the next line */</font>
01441     <a class="code" href="xsfplugin_8C.html#a36">eatline</a>(data-&gt;<a class="code" href="structgamessdata.html#m0">file</a>);
01442 
01443     <font class="comment">/* read the following five modes */</font>
01444     <font class="keywordflow">for</font> ( k = 0; k &lt; data-&gt;<a class="code" href="structgamessdata.html#m1">numatoms</a>; ++k)
01445     {
01446       <font class="comment">/* x */</font>
01447       <a class="code" href="gamessplugin_8c.html#a2">ERR_FALSE</a>( fgets(buffer,<font class="keyword">sizeof</font>(buffer),data-&gt;<a class="code" href="structgamessdata.html#m0">file</a>) )
01448       sscanf(buffer,<font class="stringliteral">"%s %s %s %lf %lf %lf %lf %lf"</font>,&amp;word[0][0], 
01449           &amp;word[1][0], &amp;word[2][0], &amp;entry[0], &amp;entry[1], &amp;entry[2],
01450           &amp;entry[3], &amp;entry[4]);
01451 
01452       <font class="comment">/* store 'em */</font>
01453       <font class="keywordflow">for</font> ( j = 0; j &lt; 5; ++j)
01454       {
01455         *(data-&gt;<a class="code" href="structgamessdata.html#m30">normal_modes</a>+(3*k)+((i*5+j)*3*data-&gt;<a class="code" href="structgamessdata.html#m1">numatoms</a>)) = 
01456             entry[j];
01457       }
01458 
01459 
01460       <font class="comment">/* y */</font>
01461       <a class="code" href="gamessplugin_8c.html#a2">ERR_FALSE</a>( fgets(buffer,<font class="keyword">sizeof</font>(buffer),data-&gt;<a class="code" href="structgamessdata.html#m0">file</a>) )
01462       sscanf(buffer,<font class="stringliteral">"%s %lf %lf %lf %lf %lf"</font>,&amp;word[0][0], &amp;entry[0],
01463           &amp;entry[1],&amp;entry[2], &amp;entry[3],&amp;entry[4]);
01464 
01465       <font class="comment">/* store 'em */</font>
01466       <font class="keywordflow">for</font> ( j = 0; j &lt; 5; ++j)
01467       {
01468         *(data-&gt;<a class="code" href="structgamessdata.html#m30">normal_modes</a>+(3*k+1)+((i*5+j)*3*data-&gt;<a class="code" href="structgamessdata.html#m1">numatoms</a>)) = 
01469             entry[j];
01470       }
01471 
01472 
01473       <font class="comment">/* z */</font>
01474       <a class="code" href="gamessplugin_8c.html#a2">ERR_FALSE</a>( fgets(buffer,<font class="keyword">sizeof</font>(buffer),data-&gt;<a class="code" href="structgamessdata.html#m0">file</a>) )
01475       sscanf(buffer,<font class="stringliteral">"%s %lf %lf %lf %lf %lf"</font>,&amp;word[0][0], &amp;entry[0],
01476           &amp;entry[1], &amp;entry[2], &amp;entry[3],&amp;entry[4]);
01477 
01478       <font class="comment">/* store 'em */</font>
01479       <font class="keywordflow">for</font> ( j = 0; j &lt; 5; ++j)
01480       {
01481         *(data-&gt;<a class="code" href="structgamessdata.html#m30">normal_modes</a>+(3*k+2)+((i*5+j)*3*data-&gt;<a class="code" href="structgamessdata.html#m1">numatoms</a>)) = 
01482             entry[j];
01483       }
01484     }
01485   }
01486 
01487 
01488   <font class="comment">/* read the remaining columns */</font>
01489   <font class="keywordflow">if</font> ( ( remaining_columns = (data-&gt;<a class="code" href="structgamessdata.html#m1">numatoms</a>*3)%5) != 0 ) { 
01490 
01491     <font class="comment">/* move to next set of modes */</font>
01492     <font class="keywordflow">do</font> 
01493     {
01494       <a class="code" href="gamessplugin_8c.html#a2">ERR_FALSE</a>( fgets(buffer,<font class="keyword">sizeof</font>(buffer),data-&gt;<a class="code" href="structgamessdata.html#m0">file</a>) )
01495       sscanf(buffer,<font class="stringliteral">"%s "</font>,&amp;word[0][0]);
01496 
01497     } <font class="keywordflow">while</font>(strcmp(&amp;word[0][0],<font class="stringliteral">"FREQUENCY:"</font>));
01498 
01499 
01500     <font class="comment">/* scan the frequencies; </font>
01501 <font class="comment">     * this requires some care since there might</font>
01502 <font class="comment">     * be imaginary modes present which leads to</font>
01503 <font class="comment">     * an additional char per imaginary mode per</font>
01504 <font class="comment">     * line */</font>
01505 
01506     <font class="comment">/* check for imaginary modes */</font>
01507     <font class="keywordflow">if</font> ( strchr(buffer,<font class="charliteral">'I'</font>) != NULL ) 
01508     {
01509       <font class="comment">/* initialize */</font>
01510       separator = <font class="charliteral">' '</font>;
01511       counter = 0;
01512 
01513       <font class="comment">/* read all line elements into individual strings */</font>
01514 
01515       <font class="comment">/* skip first entry "FREQUENCY" */</font>
01516       item = strtok(buffer,&amp;separator);
01517 
01518       
01519       <font class="comment">/* start going through the string */</font>
01520       <font class="keywordflow">while</font> ( (item = strtok(NULL,&amp;separator)) != NULL ) 
01521       {
01522         <font class="comment">/* check if item is 'I'; if yes, mark previous mode</font>
01523 <font class="comment">         * as imaginary; otherwise save the mode */</font>
01524         <font class="keywordflow">if</font> ( *item == <font class="charliteral">'I'</font> ) 
01525         {
01526           data-&gt;<a class="code" href="structgamessdata.html#m24">nimag</a>++;
01527         }
01528         <font class="keywordflow">else</font> 
01529         {
01530           <font class="comment">/* save only the first remaining columns modes - </font>
01531 <font class="comment">           * there NEVER should</font>
01532 <font class="comment">           * be more in any case, but just to make sure</font>
01533 <font class="comment">           * we don't overrun the array */</font>
01534           <font class="keywordflow">if</font> ( counter &lt; remaining_columns ) 
01535           {
01536             *(data-&gt;<a class="code" href="structgamessdata.html#m28">wavenumbers</a>+(i*5)+counter) = atof(item);
01537             counter++;
01538           }
01539         }
01540       } 
01541     }
01542 
01543 
01544     <font class="comment">/* no imaginary mode, reading is straightforward */</font>
01545     <font class="keywordflow">else</font> 
01546     {
01547       sscanf(buffer,<font class="stringliteral">"%s %lf %lf %lf %lf %lf"</font>,&amp;word[0][0],
01548         &amp;entry[0],&amp;entry[1],&amp;entry[2],&amp;entry[3],&amp;entry[4]); 
01549  
01550       <font class="comment">/* save 'em */</font>
01551       <font class="keywordflow">for</font> ( k = 0; k &lt; remaining_columns; ++k) 
01552       {
01553         *(data-&gt;<a class="code" href="structgamessdata.html#m28">wavenumbers</a>+(i*5)+k) = entry[k]; 
01554       }
01555     }
01556 
01557 
01558     <font class="comment">/* skip next line */</font>
01559     <a class="code" href="xsfplugin_8C.html#a36">eatline</a>(data-&gt;<a class="code" href="structgamessdata.html#m0">file</a>);
01560 
01561     
01562     <font class="comment">/* next line contains the IR INTENSITIES */</font>
01563     <a class="code" href="gamessplugin_8c.html#a2">ERR_FALSE</a>( fgets(buffer,<font class="keyword">sizeof</font>(buffer),data-&gt;<a class="code" href="structgamessdata.html#m0">file</a>) )
01564 
01565     <font class="comment">/* scan the IR INTENSITIES */</font>
01566     sscanf(buffer,<font class="stringliteral">"%s %s %lf %lf %lf %lf %lf"</font>,&amp;word[0][0],&amp;word[1][0],
01567         &amp;entry[0],&amp;entry[1],&amp;entry[2],&amp;entry[3],&amp;entry[4]);
01568  
01569     <font class="comment">/* save 'em */</font>
01570     <font class="keywordflow">for</font> ( k = 0; k &lt; remaining_columns; ++k) 
01571     {
01572       *(data-&gt;<a class="code" href="structgamessdata.html#m29">intensities</a>+(i*5)+k) = entry[k];
01573     }
01574 
01575 
01576     <font class="comment">/* skip the next line */</font>
01577     <a class="code" href="xsfplugin_8C.html#a36">eatline</a>(data-&gt;<a class="code" href="structgamessdata.html#m0">file</a>);
01578 
01579     <font class="comment">/* read the following five modes */</font>
01580     <font class="keywordflow">for</font> ( k = 0; k &lt; data-&gt;<a class="code" href="structgamessdata.html#m1">numatoms</a>; ++k)
01581     {
01582       <font class="comment">/* x */</font>
01583       <a class="code" href="gamessplugin_8c.html#a2">ERR_FALSE</a>( fgets(buffer,<font class="keyword">sizeof</font>(buffer),data-&gt;<a class="code" href="structgamessdata.html#m0">file</a>) )
01584       sscanf(buffer,<font class="stringliteral">"%s %s %s %lf %lf %lf %lf %lf"</font>,&amp;word[0][0], 
01585           &amp;word[1][0], &amp;word[2][0], &amp;entry[0], &amp;entry[1], &amp;entry[2],
01586           &amp;entry[3], &amp;entry[4]);
01587 
01588       <font class="comment">/* store 'em */</font>
01589       <font class="keywordflow">for</font> ( j = 0; j &lt; remaining_columns; ++j)
01590       {
01591         *(data-&gt;<a class="code" href="structgamessdata.html#m30">normal_modes</a>+(3*k)+((i*5+j)*3*data-&gt;<a class="code" href="structgamessdata.html#m1">numatoms</a>)) = 
01592             entry[j];
01593       }
01594       
01595       <font class="comment">/* y */</font>
01596       <a class="code" href="gamessplugin_8c.html#a2">ERR_FALSE</a>( fgets(buffer,<font class="keyword">sizeof</font>(buffer),data-&gt;<a class="code" href="structgamessdata.html#m0">file</a>) )
01597       sscanf(buffer,<font class="stringliteral">"%s %lf %lf %lf %lf %lf"</font>,&amp;word[0][0], &amp;entry[0],
01598           &amp;entry[1],&amp;entry[2], &amp;entry[3],&amp;entry[4]);
01599       
01600       <font class="comment">/* store 'em */</font>
01601       <font class="keywordflow">for</font> ( j = 0; j &lt; remaining_columns; ++j)
01602       {
01603         *(data-&gt;<a class="code" href="structgamessdata.html#m30">normal_modes</a>+(3*k+1)+((i*5+j)*3*data-&gt;<a class="code" href="structgamessdata.html#m1">numatoms</a>)) = 
01604             entry[j];
01605       }
01606       <font class="comment">/* z */</font>
01607       <a class="code" href="gamessplugin_8c.html#a2">ERR_FALSE</a>( fgets(buffer,<font class="keyword">sizeof</font>(buffer),data-&gt;<a class="code" href="structgamessdata.html#m0">file</a>) )
01608       sscanf(buffer,<font class="stringliteral">"%s %lf %lf %lf %lf %lf"</font>,&amp;word[0][0], &amp;entry[0],
01609           &amp;entry[1], &amp;entry[2], &amp;entry[3],&amp;entry[4]);
01610       
01611       <font class="comment">/* store 'em */</font>
01612       <font class="keywordflow">for</font> ( j = 0; j &lt; remaining_columns; ++j)
01613       {
01614         *(data-&gt;<a class="code" href="structgamessdata.html#m30">normal_modes</a>+(3*k+2)+((i*5+j)*3*data-&gt;<a class="code" href="structgamessdata.html#m1">numatoms</a>)) = 
01615             entry[j];
01616       }
01617     }
01618   }
01619 
01620   <font class="comment">/* release memory that is not needed any more */</font>
01621   free(item);
01622 
01623   <font class="comment">/* print brief message */</font>
01624   printf(<font class="stringliteral">"gamessplugin&gt; Successfully scanned normal modes \n"</font>);
01625 
01626   <font class="keywordflow">return</font> <a class="code" href="gamessplugin_8h.html#a7">TRUE</a>;
01627 }
01628 
01629 
01630 
01631 <font class="comment">/***********************************************************</font>
01632 <font class="comment"> *</font>
01633 <font class="comment"> * this function reads in the cartesian hessian matrix </font>
01634 <font class="comment"> *</font>
01635 <font class="comment"> * *********************************************************/</font>
<a name="l01636"></a><a class="code" href="gamessplugin_8c.html#a19">01636</a> <font class="keywordtype">int</font> <a class="code" href="gamessplugin_8c.html#a19">get_cart_hessian</a>(<font class="keywordtype">void</font> *mydata)
01637 {
01638 
01639   <a class="code" href="structgamessdata.html">gamessdata</a> *data = (<a class="code" href="structgamessdata.html">gamessdata</a> *)mydata;
01640   <font class="keywordtype">char</font> word[4][BUFSIZ];
01641   <font class="keywordtype">char</font> buffer[BUFSIZ];
01642   <font class="keywordtype">char</font> dummy; 
01643   <font class="keywordtype">unsigned</font> <font class="keywordtype">int</font> i,j,k;
01644   <font class="keywordtype">float</font> entry[6]; 
01645 
01646   <font class="comment">/* intitialize arrays */</font>
01647   buffer[0] = <font class="charliteral">'\0'</font>;
01648   memset(entry, 0, <font class="keyword">sizeof</font>(entry));
01649   <font class="keywordflow">for</font> ( i = 0; i &lt; 4; ++i) word[i][0] = <font class="charliteral">'\0'</font>;
01650 
01651 
01652   <font class="comment">/* at this point we need to rewind the file, since</font>
01653 <font class="comment">   * in case that there is no internal Hessian stuff the</font>
01654 <font class="comment">   * previous call to get_int_coords scanned the file</font>
01655 <font class="comment">   * until EOF */</font>
01656   rewind(data-&gt;<a class="code" href="structgamessdata.html#m0">file</a>);
01657 
01658 
01659   <font class="comment">/* look for CARTESIAN FORCE CONSTANT MATRIX */</font>
01660   <font class="keywordflow">do</font> 
01661   {
01662     <a class="code" href="gamessplugin_8c.html#a2">ERR_FALSE</a>( fgets(buffer,<font class="keyword">sizeof</font>(buffer),data-&gt;<a class="code" href="structgamessdata.html#m0">file</a>) )
01663     sscanf(buffer,<font class="stringliteral">"%s %s %s %s"</font>,&amp;word[0][0],&amp;word[1][0],
01664         &amp;word[2][0],&amp;word[3][0]);
01665 
01666   } <font class="keywordflow">while</font>(strcmp(&amp;word[0][0],<font class="stringliteral">"CARTESIAN"</font>) || 
01667           strcmp(&amp;word[1][0],<font class="stringliteral">"FORCE"</font>) ||
01668           strcmp(&amp;word[2][0],<font class="stringliteral">"CONSTANT"</font>) ||
01669           strcmp(&amp;word[3][0],<font class="stringliteral">"MATRIX"</font>));
01670 
01671 
01672   <font class="comment">/* skip next 5 lines */</font>
01673   <font class="keywordflow">for</font> ( i=0; i&lt;5; ++i) <a class="code" href="xsfplugin_8C.html#a36">eatline</a>(data-&gt;<a class="code" href="structgamessdata.html#m0">file</a>);
01674 
01675 
01676   <font class="comment">/* reserve memory for array; </font>
01677 <font class="comment">   * NOTE: this is a lower triangular matrix, but for now</font>
01678 <font class="comment">   * we save it in an square matrix of dim(3Nx3N) to </font>
01679 <font class="comment">   * facilitate element access */</font>
01680   data-&gt;<a class="code" href="structgamessdata.html#m53">carthessian</a> = 
01681     (<font class="keywordtype">double</font> *)calloc((data-&gt;<a class="code" href="structgamessdata.html#m1">numatoms</a>*3)*(data-&gt;<a class="code" href="structgamessdata.html#m1">numatoms</a>*3),
01682                      <font class="keyword">sizeof</font>(<font class="keywordtype">double</font>));
01683 
01684   
01685   <font class="comment">/* make sure memory was allocated properly */</font>
01686   <font class="keywordflow">if</font> (data-&gt;<a class="code" href="structgamessdata.html#m53">carthessian</a> == NULL) 
01687   {
01688     <a class="code" href="gamessplugin_8c.html#a1">PRINTERR</a>;
01689     <font class="keywordflow">return</font> <a class="code" href="gamessplugin_8h.html#a6">FALSE</a>;
01690   }
01691 
01692 
01693   <font class="comment">/* start scanning; the cartesian hessian matrix is a lower</font>
01694 <font class="comment">   * triangular matrix, organized in rows of 6 */</font>
01695 
01696   <font class="comment">/* read blocks with complete rows of 6 */</font>
01697   <font class="keywordflow">for</font> ( i = 0; i &lt; (int)(data-&gt;<a class="code" href="structgamessdata.html#m1">numatoms</a>/2) ; ++i) 
01698   {
01699     <font class="keywordflow">for</font> ( j = 0; j &lt; (data-&gt;<a class="code" href="structgamessdata.html#m1">numatoms</a>*3)-(i*6); ++j) 
01700     {
01701       <a class="code" href="gamessplugin_8c.html#a2">ERR_FALSE</a>( fgets(buffer,<font class="keyword">sizeof</font>(buffer),data-&gt;<a class="code" href="structgamessdata.html#m0">file</a>) )
01702  
01703       <font class="keywordflow">if</font> ( j%3 == 0 ) 
01704       {
01705         sscanf(buffer,<font class="stringliteral">"%s %s %c %f %f %f %f %f %f"</font>,
01706             &amp;word[0][0],&amp;word[1][0],&amp;dummy,&amp;entry[0],&amp;entry[1],
01707             &amp;entry[2],&amp;entry[3],&amp;entry[4],&amp;entry[5]);
01708       }
01709       <font class="keywordflow">else</font> 
01710       {
01711         sscanf(buffer,<font class="stringliteral">"%1s %f %f %f %f %f %f"</font>,
01712           &amp;dummy,&amp;entry[0],&amp;entry[1],&amp;entry[2],&amp;entry[3],&amp;entry[4],
01713           &amp;entry[5]);
01714       }
01715 
01716 
01717       <font class="comment">/* save entries (lower triangular matrix) in a </font>
01718 <font class="comment">       * square matrix */</font>
01719       <font class="keywordflow">for</font> ( k = 0; k &lt;= ( j&lt;5 ? j : 5 ) ; ++k) {
01720         *(data-&gt;<a class="code" href="structgamessdata.html#m53">carthessian</a>+((j+(i*6))*3*data-&gt;<a class="code" href="structgamessdata.html#m1">numatoms</a>)+
01721             (k+(i*6))) = entry[k];
01722       }
01723     }
01724 
01725 
01726     <font class="comment">/* skip the three line separating the matrix entries */</font>
01727     <a class="code" href="xsfplugin_8C.html#a36">eatline</a>(data-&gt;<a class="code" href="structgamessdata.html#m0">file</a>);
01728     <a class="code" href="xsfplugin_8C.html#a36">eatline</a>(data-&gt;<a class="code" href="structgamessdata.html#m0">file</a>);
01729     <a class="code" href="xsfplugin_8C.html#a36">eatline</a>(data-&gt;<a class="code" href="structgamessdata.html#m0">file</a>);
01730     <a class="code" href="xsfplugin_8C.html#a36">eatline</a>(data-&gt;<a class="code" href="structgamessdata.html#m0">file</a>);
01731   }
01732 
01733 
01734 
01735   <font class="comment">/* short message */</font>
01736   printf(<font class="stringliteral">"gamessplugin&gt; Scanned Hessian in CARTESIAN coordinates\n"</font>);
01737 
01738   <font class="keywordflow">return</font> <a class="code" href="gamessplugin_8h.html#a7">TRUE</a>;
01739 }
01740   
01741   
01742   
01743 <font class="comment">/***********************************************************</font>
01744 <font class="comment"> *</font>
01745 <font class="comment"> * this function reads in the hessian in internal coordinates</font>
01746 <font class="comment"> * as well as the internal coordinates </font>
01747 <font class="comment"> *</font>
01748 <font class="comment"> * *********************************************************/</font>
<a name="l01749"></a><a class="code" href="gamessplugin_8c.html#a20">01749</a> <font class="keywordtype">int</font> <a class="code" href="gamessplugin_8c.html#a20">get_int_coords</a>(<font class="keywordtype">void</font> *mydata)
01750 {
01751 
01752   <a class="code" href="structgamessdata.html">gamessdata</a> *data = (<a class="code" href="structgamessdata.html">gamessdata</a> *)mydata;
01753   <font class="keywordtype">char</font> word[5][BUFSIZ];
01754   <font class="keywordtype">char</font> buffer[BUFSIZ];
01755   <font class="keywordtype">long</font> position;
01756   <font class="keywordtype">int</font> first, second, third, fourth;
01757   <font class="keywordtype">double</font> value;
01758   <font class="keywordtype">double</font> hess[5];
01759   <font class="keywordtype">unsigned</font> <font class="keywordtype">int</font> i = 0, j = 0, k = 0, l = 0;
01760   <font class="keywordtype">int</font> n, dummy, remaining_blocks;
01761 
01762 
01763   <font class="comment">/* initialize arrays */</font>
01764   buffer[0] = <font class="charliteral">'\0'</font>;
01765   memset(hess, 0, <font class="keyword">sizeof</font>(hess));
01766   <font class="keywordflow">for</font> ( i = 0; i &lt; 5; ++i) word[i][0] = <font class="charliteral">'\0'</font>;
01767 
01768 
01769   <font class="comment">/* initialize counters */</font>
01770   data-&gt;<a class="code" href="structgamessdata.html#m39">nintcoords</a> = 0;
01771   data-&gt;<a class="code" href="structgamessdata.html#m40">nbonds</a> = 0;
01772   data-&gt;<a class="code" href="structgamessdata.html#m41">nangles</a> = 0;
01773   data-&gt;<a class="code" href="structgamessdata.html#m42">ndiheds</a> = 0;
01774   data-&gt;<a class="code" href="structgamessdata.html#m43">nimprops</a> = 0;
01775 
01776 
01777   <font class="comment">/* look for list of INTERNAL COORDINATES */</font>
01778   <font class="keywordflow">do</font> 
01779   {
01780     <a class="code" href="gamessplugin_8c.html#a2">ERR_FALSE</a>( fgets(buffer,<font class="keyword">sizeof</font>(buffer),data-&gt;<a class="code" href="structgamessdata.html#m0">file</a>) )
01781     sscanf(buffer,<font class="stringliteral">"%s %s "</font>,&amp;word[0][0],&amp;word[1][0]);
01782 
01783   } <font class="keywordflow">while</font>(strcmp(&amp;word[0][0],<font class="stringliteral">"INTERNAL"</font>) || 
01784           strcmp(&amp;word[1][0],<font class="stringliteral">"COORDINATES"</font>));
01785 
01786   
01787   <font class="comment">/* skip next 5 lines */</font>
01788   <font class="keywordflow">for</font> ( i = 0; i &lt; 5; ++i) <a class="code" href="xsfplugin_8C.html#a36">eatline</a>(data-&gt;<a class="code" href="structgamessdata.html#m0">file</a>);
01789 
01790 
01791   <font class="comment">/* remember current position so we can jump back */</font>
01792   position = ftell(data-&gt;<a class="code" href="structgamessdata.html#m0">file</a>);
01793 
01794 
01795   <font class="comment">/* scan the next line */</font>
01796   <a class="code" href="gamessplugin_8c.html#a2">ERR_FALSE</a>( fgets(buffer,<font class="keyword">sizeof</font>(buffer),data-&gt;<a class="code" href="structgamessdata.html#m0">file</a>) )
01797   n = sscanf(buffer,<font class="stringliteral">"%s %s"</font>, &amp;word[0][0], &amp;word[1][0]); 
01798  
01799 
01800   <font class="comment">/* read line by line */</font>
01801   <font class="keywordflow">while</font> ( n != -1) 
01802   {
01803     <font class="comment">/* start counting the number of internal coordinates */</font>
01804     data-&gt;<a class="code" href="structgamessdata.html#m39">nintcoords</a>++;
01805 
01806 
01807     <font class="comment">/* count the number of bonds, angles, dihedrals */</font>
01808     <font class="keywordflow">if</font> (!strcmp(&amp;word[1][0],<font class="stringliteral">"STRETCH"</font>)) 
01809     {
01810       data-&gt;<a class="code" href="structgamessdata.html#m40">nbonds</a>++;
01811     }
01812     <font class="keywordflow">else</font> <font class="keywordflow">if</font> (!strcmp(&amp;word[1][0],<font class="stringliteral">"BEND"</font>)) 
01813     {
01814       data-&gt;<a class="code" href="structgamessdata.html#m41">nangles</a>++;
01815     }
01816     <font class="keywordflow">else</font> <font class="keywordflow">if</font> (!strcmp(&amp;word[1][0],<font class="stringliteral">"TORSION"</font>)) 
01817     {
01818       data-&gt;<a class="code" href="structgamessdata.html#m42">ndiheds</a>++;
01819     }
01820     <font class="keywordflow">else</font> <font class="keywordflow">if</font> (!strcmp(&amp;word[1][0],<font class="stringliteral">"PLA.BEND"</font>)) 
01821     {
01822       data-&gt;<a class="code" href="structgamessdata.html#m43">nimprops</a>++;
01823     }
01824 
01825             
01826     <font class="comment">/* scan next line */</font>
01827     <a class="code" href="gamessplugin_8c.html#a2">ERR_FALSE</a>( fgets(buffer,<font class="keyword">sizeof</font>(buffer),data-&gt;<a class="code" href="structgamessdata.html#m0">file</a>) )
01828     n = sscanf(buffer,<font class="stringliteral">"%s %s"</font>, &amp;word[0][0], &amp;word[1][0]); 
01829   }
01830 
01831   <font class="comment">/* now that we know the number of bonds, angles, etc.</font>
01832 <font class="comment">   * we can read and store the internal coordinates */</font>
01833   fseek(data-&gt;<a class="code" href="structgamessdata.html#m0">file</a>,position,SEEK_SET);
01834 
01835 
01836   <font class="comment">/* reserve memory for the arrays storing the internal</font>
01837 <font class="comment">   * coordinates and their values */</font>
01838   data-&gt;<a class="code" href="structgamessdata.html#m44">bonds</a> = (<font class="keywordtype">int</font> *)calloc(2*data-&gt;<a class="code" href="structgamessdata.html#m40">nbonds</a>,<font class="keyword">sizeof</font>(<font class="keywordtype">int</font>));
01839   data-&gt;<a class="code" href="structgamessdata.html#m45">angles</a> = (<font class="keywordtype">int</font> *)calloc(3*data-&gt;<a class="code" href="structgamessdata.html#m41">nangles</a>,<font class="keyword">sizeof</font>(<font class="keywordtype">int</font>));
01840   data-&gt;<a class="code" href="structgamessdata.html#m46">dihedrals</a> = (<font class="keywordtype">int</font> *)calloc(4*data-&gt;<a class="code" href="structgamessdata.html#m42">ndiheds</a>,<font class="keyword">sizeof</font>(<font class="keywordtype">int</font>));
01841   data-&gt;<a class="code" href="structgamessdata.html#m47">impropers</a> = (<font class="keywordtype">int</font> *)calloc(4*data-&gt;<a class="code" href="structgamessdata.html#m43">nimprops</a>,<font class="keyword">sizeof</font>(<font class="keywordtype">int</font>));
01842   data-&gt;<a class="code" href="structgamessdata.html#m48">internal_coordinates</a> = (<font class="keywordtype">double</font> *)calloc(data-&gt;<a class="code" href="structgamessdata.html#m39">nintcoords</a>,
01843         <font class="keyword">sizeof</font>(<font class="keywordtype">double</font>));
01844 
01845 
01846   <font class="comment">/* check if we have sufficient memory available */</font>
01847   <font class="keywordflow">if</font> ( (data-&gt;<a class="code" href="structgamessdata.html#m44">bonds</a> == NULL) || 
01848        (data-&gt;<a class="code" href="structgamessdata.html#m45">angles</a> == NULL) ||
01849        (data-&gt;<a class="code" href="structgamessdata.html#m46">dihedrals</a> == NULL) || 
01850        (data-&gt;<a class="code" href="structgamessdata.html#m48">internal_coordinates</a> == NULL)) 
01851   {
01852     <a class="code" href="gamessplugin_8c.html#a1">PRINTERR</a>; 
01853     <font class="keywordflow">return</font> <a class="code" href="gamessplugin_8h.html#a6">FALSE</a>;
01854   }
01855 
01856 
01857   <font class="comment">/* now start going through the internal coordinates</font>
01858 <font class="comment">   * and save them in the appropriate arrays; here</font>
01859 <font class="comment">   * I drop all safety check since we went through</font>
01860 <font class="comment">   * this part of the file already once and should</font>
01861 <font class="comment">   * be good */</font>
01862  
01863   <font class="comment">/* scan the STRETCHES */</font>
01864   <font class="keywordflow">for</font> ( i = 0; i &lt; data-&gt;<a class="code" href="structgamessdata.html#m40">nbonds</a>; ++i) 
01865   {
01866     <a class="code" href="gamessplugin_8c.html#a2">ERR_FALSE</a>( fgets(buffer,<font class="keyword">sizeof</font>(buffer),data-&gt;<a class="code" href="structgamessdata.html#m0">file</a>) )
01867     sscanf(buffer,<font class="stringliteral">"%s %s %d %d %lf"</font>, &amp;word[0][0], &amp;word[1][0], 
01868         &amp;first, &amp;second, &amp;value);
01869 
01870     <font class="comment">/* save 'em */</font>
01871     *(data-&gt;<a class="code" href="structgamessdata.html#m44">bonds</a>+2*i) = first;
01872     *(data-&gt;<a class="code" href="structgamessdata.html#m44">bonds</a>+2*i+1) = second;
01873     *(data-&gt;<a class="code" href="structgamessdata.html#m48">internal_coordinates</a>+i) = value;
01874   }
01875 
01876 
01877   <font class="comment">/* scan the BENDS */</font>
01878   <font class="keywordflow">for</font> ( j = 0; j &lt; data-&gt;<a class="code" href="structgamessdata.html#m41">nangles</a>; ++j) 
01879   {
01880     <a class="code" href="gamessplugin_8c.html#a2">ERR_FALSE</a>( fgets(buffer,<font class="keyword">sizeof</font>(buffer),data-&gt;<a class="code" href="structgamessdata.html#m0">file</a>) )
01881     sscanf(buffer,<font class="stringliteral">"%s %s %d %d %d %lf"</font>, &amp;word[0][0], &amp;word[1][0], 
01882         &amp;first, &amp;second, &amp;third, &amp;value);
01883 
01884     <font class="comment">/* save 'em */</font>
01885     *(data-&gt;<a class="code" href="structgamessdata.html#m45">angles</a>+3*j) = first;
01886     *(data-&gt;<a class="code" href="structgamessdata.html#m45">angles</a>+3*j+1) = second;
01887     *(data-&gt;<a class="code" href="structgamessdata.html#m45">angles</a>+3*j+2) = third;
01888     *(data-&gt;<a class="code" href="structgamessdata.html#m48">internal_coordinates</a>+i+j) = value;
01889   }
01890 
01891 
01892   <font class="comment">/* scan the TORSIONS */</font>
01893   <font class="keywordflow">for</font> ( k = 0; k &lt; data-&gt;<a class="code" href="structgamessdata.html#m42">ndiheds</a>; ++k) 
01894   {
01895     <a class="code" href="gamessplugin_8c.html#a2">ERR_FALSE</a>( fgets(buffer,<font class="keyword">sizeof</font>(buffer),data-&gt;<a class="code" href="structgamessdata.html#m0">file</a>) )
01896     sscanf(buffer,<font class="stringliteral">"%s %s %d %d %d %d %lf"</font>, &amp;word[0][0], &amp;word[1][0],
01897         &amp;first, &amp;second, &amp;third, &amp;fourth, &amp;value);
01898 
01899     <font class="comment">/* save 'em */</font>
01900     *(data-&gt;<a class="code" href="structgamessdata.html#m46">dihedrals</a>+4*k) = first;
01901     *(data-&gt;<a class="code" href="structgamessdata.html#m46">dihedrals</a>+4*k+1) = second;
01902     *(data-&gt;<a class="code" href="structgamessdata.html#m46">dihedrals</a>+4*k+2) = third;
01903     *(data-&gt;<a class="code" href="structgamessdata.html#m46">dihedrals</a>+4*k+3) = fourth;
01904     *(data-&gt;<a class="code" href="structgamessdata.html#m48">internal_coordinates</a>+i+j+k) = value;
01905   }
01906 
01907 
01908   <font class="comment">/* scan the IMPROPERS */</font>
01909   <font class="keywordflow">for</font> ( l = 0; l &lt; data-&gt;<a class="code" href="structgamessdata.html#m43">nimprops</a>; ++l) 
01910   {
01911     <a class="code" href="gamessplugin_8c.html#a2">ERR_FALSE</a>( fgets(buffer,<font class="keyword">sizeof</font>(buffer),data-&gt;<a class="code" href="structgamessdata.html#m0">file</a>) )
01912     sscanf(buffer,<font class="stringliteral">"%s %s %d %d %d %d %lf"</font>, &amp;word[0][0], &amp;word[1][0],
01913         &amp;first, &amp;second, &amp;third, &amp;fourth, &amp;value);
01914 
01915     <font class="comment">/* save 'em */</font>
01916     *(data-&gt;<a class="code" href="structgamessdata.html#m47">impropers</a>+4*l) = first;
01917     *(data-&gt;<a class="code" href="structgamessdata.html#m47">impropers</a>+4*l+1) = second;
01918     *(data-&gt;<a class="code" href="structgamessdata.html#m47">impropers</a>+4*l+2) = third;
01919     *(data-&gt;<a class="code" href="structgamessdata.html#m47">impropers</a>+4*l+3) = fourth;
01920     *(data-&gt;<a class="code" href="structgamessdata.html#m48">internal_coordinates</a>+i+j+k+l) = value;
01921   }
01922 
01923 
01924   <font class="comment">/* short message */</font>
01925   printf(<font class="stringliteral">"gamessplugin&gt; Scanned %d INTERNAL coordinates \n"</font>,
01926       data-&gt;<a class="code" href="structgamessdata.html#m39">nintcoords</a>);
01927   printf(<font class="stringliteral">"gamessplugin&gt;    %d BONDS \n"</font>,data-&gt;<a class="code" href="structgamessdata.html#m40">nbonds</a>);
01928   printf(<font class="stringliteral">"gamessplugin&gt;    %d ANGLES \n"</font>,data-&gt;<a class="code" href="structgamessdata.html#m41">nangles</a>);
01929   printf(<font class="stringliteral">"gamessplugin&gt;    %d DIHEDRALS \n"</font>,data-&gt;<a class="code" href="structgamessdata.html#m42">ndiheds</a>);
01930   printf(<font class="stringliteral">"gamessplugin&gt;    %d IMPROPERS \n"</font>,data-&gt;<a class="code" href="structgamessdata.html#m43">nimprops</a>);
01931 
01932 
01933   <font class="comment">/* next read in the hessian in internal coordinates;</font>
01934 <font class="comment">   * we would expect the matrix immediately after the</font>
01935 <font class="comment">   * internal coordinates in the output files;</font>
01936 <font class="comment">   * we check this first */</font>
01937   <a class="code" href="xsfplugin_8C.html#a36">eatline</a>(data-&gt;<a class="code" href="structgamessdata.html#m0">file</a>);
01938 
01939 
01940   <a class="code" href="gamessplugin_8c.html#a2">ERR_FALSE</a>( fgets(buffer,<font class="keyword">sizeof</font>(buffer),data-&gt;<a class="code" href="structgamessdata.html#m0">file</a>) )
01941   sscanf(buffer,<font class="stringliteral">"%s %s %s %s %s"</font>, &amp;word[0][0], &amp;word[1][0], 
01942       &amp;word[2][0], &amp;word[3][0], &amp;word[4][0]);
01943 
01944   <font class="keywordflow">if</font> ( strcmp(&amp;word[0][0],<font class="stringliteral">"HESSIAN"</font>) || 
01945        strcmp(&amp;word[1][0],<font class="stringliteral">"MATRIX"</font>) ||
01946        strcmp(&amp;word[3][0],<font class="stringliteral">"INTERNAL"</font>) || 
01947        strcmp(&amp;word[4][0],<font class="stringliteral">"COORDINATES"</font>)) 
01948   {
01949     <font class="comment">/* apparently we are out of luck - no Hessian in internal</font>
01950 <font class="comment">     * coordinates -- GOOD BYE :) */</font>
01951     <font class="keywordflow">return</font> <a class="code" href="gamessplugin_8h.html#a6">FALSE</a>;
01952   }
01953  
01954 
01955   <font class="comment">/* skip to the hessian arrays */</font>
01956   <font class="keywordflow">while</font> ( sscanf(buffer,<font class="stringliteral">"%d %lf %lf %lf %lf %lf"</font>, 
01957                  &amp;dummy, &amp;hess[0], &amp;hess[1], &amp;hess[2], 
01958                  &amp;hess[3], &amp;hess[4]) != 6 ) 
01959   {
01960     <a class="code" href="gamessplugin_8c.html#a2">ERR_FALSE</a>( fgets(buffer,<font class="keyword">sizeof</font>(buffer),data-&gt;<a class="code" href="structgamessdata.html#m0">file</a>) )
01961   }
01962 
01963   
01964   <font class="comment">/* reserve memory for inthessian array */</font>
01965   data-&gt;<a class="code" href="structgamessdata.html#m54">inthessian</a> = 
01966     (<font class="keywordtype">double</font> *)calloc((data-&gt;<a class="code" href="structgamessdata.html#m39">nintcoords</a>)*(data-&gt;<a class="code" href="structgamessdata.html#m39">nintcoords</a>),
01967                      <font class="keyword">sizeof</font>(<font class="keywordtype">double</font>));
01968 
01969 
01970   <font class="comment">/* make sure memory was allocated properly */</font>
01971   <font class="keywordflow">if</font> (data-&gt;<a class="code" href="structgamessdata.html#m54">inthessian</a> == NULL)  
01972   {
01973     <a class="code" href="gamessplugin_8c.html#a1">PRINTERR</a>;
01974     <font class="keywordflow">return</font> <a class="code" href="gamessplugin_8h.html#a6">FALSE</a>;
01975   }
01976 
01977 
01978   <font class="comment">/* start scanning; GAMESS organized the output of the</font>
01979 <font class="comment">   * internal HESSIAN in rows of 5 */</font>
01980 
01981   <font class="comment">/* read blocks with complete rows of 5 */</font>
01982   <font class="keywordflow">for</font> ( i = 0; i &lt; (int)(data-&gt;<a class="code" href="structgamessdata.html#m39">nintcoords</a>/5); ++i) 
01983   {
01984     <font class="keywordflow">for</font> ( j = 0; j &lt; data-&gt;<a class="code" href="structgamessdata.html#m39">nintcoords</a>; ++j) 
01985     {
01986       sscanf(buffer,<font class="stringliteral">"%d %lf %lf %lf %lf %lf"</font>, &amp;dummy, &amp;hess[0], 
01987               &amp;hess[1], &amp;hess[2], &amp;hess[3], &amp;hess[4]);
01988 
01989       <font class="comment">/* save entries */</font>
01990       <font class="keywordflow">for</font> ( k = 0; k &lt; 5; ++k) 
01991       { 
01992         *(data-&gt;<a class="code" href="structgamessdata.html#m54">inthessian</a>+(j*data-&gt;<a class="code" href="structgamessdata.html#m39">nintcoords</a>)+(i*5)+k) = hess[k];
01993       }
01994 
01995       <font class="comment">/* next line */</font>
01996       <a class="code" href="gamessplugin_8c.html#a2">ERR_FALSE</a>( fgets(buffer,<font class="keyword">sizeof</font>(buffer),data-&gt;<a class="code" href="structgamessdata.html#m0">file</a>) )
01997     }
01998 
01999     <font class="comment">/* skip the two lines separating the matrix entries </font>
02000 <font class="comment">     * and scan next line */</font>
02001     <a class="code" href="xsfplugin_8C.html#a36">eatline</a>(data-&gt;<a class="code" href="structgamessdata.html#m0">file</a>);
02002     <a class="code" href="xsfplugin_8C.html#a36">eatline</a>(data-&gt;<a class="code" href="structgamessdata.html#m0">file</a>);
02003 
02004     <a class="code" href="gamessplugin_8c.html#a2">ERR_FALSE</a>( fgets(buffer,<font class="keyword">sizeof</font>(buffer),data-&gt;<a class="code" href="structgamessdata.html#m0">file</a>) )
02005   }
02006 
02007   
02008   <font class="comment">/* read the remaining block with less then 5 rows</font>
02009 <font class="comment">   * if present */</font>
02010   remaining_blocks = data-&gt;<a class="code" href="structgamessdata.html#m39">nintcoords</a>%5;
02011   
02012   <font class="keywordflow">if</font> ( remaining_blocks != 0 ) 
02013   {
02014     <font class="keywordflow">for</font> ( j = 0; j &lt; data-&gt;<a class="code" href="structgamessdata.html#m39">nintcoords</a>; ++j) 
02015     {
02016       sscanf(buffer,<font class="stringliteral">"%d %lf %lf %lf %lf %lf"</font>, &amp;dummy, &amp;hess[0], 
02017               &amp;hess[1], &amp;hess[2], &amp;hess[3], &amp;hess[4]);
02018 
02019       <font class="keywordflow">for</font> ( k = 0; k &lt; remaining_blocks; ++k) 
02020       { 
02021         *(data-&gt;<a class="code" href="structgamessdata.html#m54">inthessian</a>+(j*data-&gt;<a class="code" href="structgamessdata.html#m39">nintcoords</a>)+(i*5)+k) = hess[k];
02022       }
02023 
02024       <a class="code" href="gamessplugin_8c.html#a2">ERR_FALSE</a>( fgets(buffer,<font class="keyword">sizeof</font>(buffer),data-&gt;<a class="code" href="structgamessdata.html#m0">file</a>) )
02025     }
02026   }
02027 
02028 
02029   <font class="comment">/* short message */</font>
02030   printf(<font class="stringliteral">"gamessplugin&gt; Scanned Hessian in INTERNAL coordinates\n"</font>);
02031 
02032 
02033 
02034   <font class="comment">/* finally, dump the diagonal elements of the hessian into the</font>
02035 <font class="comment">   * force constant arrays, after converting the units </font>
02036 <font class="comment">   * appropriately;</font>
02037 <font class="comment">   * BONDS are in HARTREE/BOHR**2</font>
02038 <font class="comment">   * ANGLES,DIHEDRALS,IMPROPERS are in HARTREE/RADIAN**2 */</font>
02039 
02040   
02041   <font class="comment">/* alocate dynamic arrays */</font>
02042   data-&gt;<a class="code" href="structgamessdata.html#m49">bond_force_const</a> = 
02043     (<font class="keywordtype">double</font> *)calloc(data-&gt;<a class="code" href="structgamessdata.html#m40">nbonds</a>,<font class="keyword">sizeof</font>(<font class="keywordtype">double</font>));
02044  
02045   <font class="keywordflow">if</font> ( data-&gt;<a class="code" href="structgamessdata.html#m49">bond_force_const</a> == NULL ) 
02046   {
02047     <a class="code" href="gamessplugin_8c.html#a1">PRINTERR</a>;
02048     <font class="keywordflow">return</font> <a class="code" href="gamessplugin_8h.html#a6">FALSE</a>;
02049   }
02050 
02051 
02052   data-&gt;<a class="code" href="structgamessdata.html#m50">angle_force_const</a> =
02053     (<font class="keywordtype">double</font> *)calloc(data-&gt;<a class="code" href="structgamessdata.html#m41">nangles</a>,<font class="keyword">sizeof</font>(<font class="keywordtype">double</font>));
02054 
02055   <font class="keywordflow">if</font> ( data-&gt;<a class="code" href="structgamessdata.html#m50">angle_force_const</a> == NULL ) 
02056   {
02057     <a class="code" href="gamessplugin_8c.html#a1">PRINTERR</a>;
02058     <font class="keywordflow">return</font> <a class="code" href="gamessplugin_8h.html#a6">FALSE</a>;
02059   }
02060 
02061 
02062   data-&gt;<a class="code" href="structgamessdata.html#m51">dihedral_force_const</a> =
02063     (<font class="keywordtype">double</font> *)calloc(data-&gt;<a class="code" href="structgamessdata.html#m42">ndiheds</a>,<font class="keyword">sizeof</font>(<font class="keywordtype">double</font>));
02064 
02065   <font class="keywordflow">if</font> ( data-&gt;<a class="code" href="structgamessdata.html#m51">dihedral_force_const</a> == NULL ) 
02066   {
02067     <a class="code" href="gamessplugin_8c.html#a1">PRINTERR</a>;
02068     <font class="keywordflow">return</font> <a class="code" href="gamessplugin_8h.html#a6">FALSE</a>;
02069   }
02070 
02071 
02072   data-&gt;<a class="code" href="structgamessdata.html#m52">improper_force_const</a> =
02073     (<font class="keywordtype">double</font> *)calloc(data-&gt;<a class="code" href="structgamessdata.html#m43">nimprops</a>,<font class="keyword">sizeof</font>(<font class="keywordtype">double</font>));
02074 
02075   <font class="keywordflow">if</font> ( data-&gt;<a class="code" href="structgamessdata.html#m52">improper_force_const</a> == NULL ) 
02076   {
02077     <a class="code" href="gamessplugin_8c.html#a1">PRINTERR</a>;
02078     <font class="keywordflow">return</font> <a class="code" href="gamessplugin_8h.html#a6">FALSE</a>;
02079   }
02080 
02081 
02082   <font class="comment">/* scan the bonds */</font>
02083   <font class="keywordflow">for</font> ( i = 0; i &lt; data-&gt;<a class="code" href="structgamessdata.html#m40">nbonds</a>; ++i) 
02084   {
02085     *(data-&gt;<a class="code" href="structgamessdata.html#m49">bond_force_const</a> + i) = 
02086       *(data-&gt;<a class="code" href="structgamessdata.html#m54">inthessian</a>+(i*data-&gt;<a class="code" href="structgamessdata.html#m39">nintcoords</a>)+i) 
02087       * <a class="code" href="gamessplugin_8h.html#a4">HARTREE_TO_KCAL</a> / <a class="code" href="gamessplugin_8h.html#a3">BOHR_TO_ANGS</a> / <a class="code" href="gamessplugin_8h.html#a3">BOHR_TO_ANGS</a>;
02088 
02089     printf(<font class="stringliteral">"%3d (BOND) %2d - %2d : %lf (CHARMM) %lf \n"</font>,i, 
02090         *(data-&gt;<a class="code" href="structgamessdata.html#m44">bonds</a>+2*i), *(data-&gt;<a class="code" href="structgamessdata.html#m44">bonds</a>+2*i+1),
02091         *(data-&gt;<a class="code" href="structgamessdata.html#m49">bond_force_const</a> +i),
02092         *(data-&gt;<a class="code" href="structgamessdata.html#m49">bond_force_const</a> +i)*0.5); 
02093   }
02094   
02095 
02096   <font class="comment">/* scan the angles */</font>
02097   for ( j = i; j &lt; i+(data-&gt;nangles); ++j) 
02098   {
02099     *(data-&gt;<a class="code" href="structgamessdata.html#m50">angle_force_const</a> + (j-i)) = 
02100       *(data-&gt;<a class="code" href="structgamessdata.html#m54">inthessian</a>+(j*data-&gt;<a class="code" href="structgamessdata.html#m39">nintcoords</a>)+j) 
02101       * <a class="code" href="gamessplugin_8h.html#a4">HARTREE_TO_KCAL</a>;
02102     
02103      printf(<font class="stringliteral">"%3d (ANGLE) %2d - %2d - %2d : %lf (CHARMM) %lf \n"</font>,j,
02104          *(data-&gt;<a class="code" href="structgamessdata.html#m45">angles</a>+3*(j-i)), *(data-&gt;<a class="code" href="structgamessdata.html#m45">angles</a>+3*(j-i)+1), 
02105          *(data-&gt;<a class="code" href="structgamessdata.html#m45">angles</a>+3*(j-i)+2), 
02106          *(data-&gt;<a class="code" href="structgamessdata.html#m50">angle_force_const</a> + (j-i)),
02107          *(data-&gt;<a class="code" href="structgamessdata.html#m50">angle_force_const</a> + (j-i))*0.5);
02108   }
02109 
02110 
02111   <font class="comment">/* scan the dihedrals */</font>
02112   for ( k = j; k &lt; j+(data-&gt;ndiheds); ++k) 
02113   {
02114     *(data-&gt;<a class="code" href="structgamessdata.html#m51">dihedral_force_const</a> + (k-j)) = 
02115       *(data-&gt;<a class="code" href="structgamessdata.html#m54">inthessian</a>+(k*data-&gt;<a class="code" href="structgamessdata.html#m39">nintcoords</a>)+k)
02116       * <a class="code" href="gamessplugin_8h.html#a4">HARTREE_TO_KCAL</a>;
02117     
02118      printf(<font class="stringliteral">"%3d (DIHEDRAL) %2d - %2d - %2d - %2d : %lf \n"</font>,k,
02119          *(data-&gt;<a class="code" href="structgamessdata.html#m46">dihedrals</a>+4*(k-j)), *(data-&gt;<a class="code" href="structgamessdata.html#m46">dihedrals</a>+4*(k-j)+1),
02120          *(data-&gt;<a class="code" href="structgamessdata.html#m46">dihedrals</a>+4*(k-j)+2), *(data-&gt;<a class="code" href="structgamessdata.html#m46">dihedrals</a>+4*(k-j)+3),
02121          *(data-&gt;<a class="code" href="structgamessdata.html#m51">dihedral_force_const</a> + (k-j))); 
02122   }
02123 
02124 
02125   <font class="comment">/* scan the impropers */</font>
02126   <font class="keywordflow">for</font> ( l = k; l &lt; k+(data-&gt;<a class="code" href="structgamessdata.html#m43">nimprops</a>); ++l) 
02127   {
02128     *(data-&gt;<a class="code" href="structgamessdata.html#m52">improper_force_const</a> + (l-k)) = 
02129       *(data-&gt;<a class="code" href="structgamessdata.html#m54">inthessian</a>+(l*data-&gt;<a class="code" href="structgamessdata.html#m39">nintcoords</a>)+l)
02130       * <a class="code" href="gamessplugin_8h.html#a4">HARTREE_TO_KCAL</a>;
02131     
02132    printf(<font class="stringliteral">"%3d (IMPROPERS) %2d - %2d - %2d - %2d : %lf \n"</font>,l,
02133       *(data-&gt;<a class="code" href="structgamessdata.html#m47">impropers</a>+4*(l-k)), *(data-&gt;<a class="code" href="structgamessdata.html#m47">impropers</a>+4*(l-k)+1),
02134       *(data-&gt;<a class="code" href="structgamessdata.html#m47">impropers</a>+4*(l-k)+2), *(data-&gt;<a class="code" href="structgamessdata.html#m47">impropers</a>+4*(l-k)+3),
02135       *(data-&gt;<a class="code" href="structgamessdata.html#m52">improper_force_const</a> + (l-k)));
02136   }
02137 
02138 
02139   <font class="comment">/* DONE */</font>
02140   <font class="keywordflow">return</font> <a class="code" href="gamessplugin_8h.html#a7">TRUE</a>;
02141 }
02142 
02143 
02144 
02145 <font class="comment">/*******************************************************</font>
02146 <font class="comment"> *</font>
02147 <font class="comment"> * this function reads in the guess options</font>
02148 <font class="comment"> *</font>
02149 <font class="comment"> * ******************************************************/</font>
<a name="l02150"></a><a class="code" href="gamessplugin_8c.html#a21">02150</a> <font class="keywordtype">int</font> <a class="code" href="gamessplugin_8c.html#a21">get_guess</a>(<font class="keywordtype">void</font> *mydata)
02151 {
02152   <a class="code" href="structgamessdata.html">gamessdata</a> *data = (<a class="code" href="structgamessdata.html">gamessdata</a> *)mydata;
02153   <font class="keywordtype">char</font> word[2][BUFSIZ];
02154   <font class="keywordtype">char</font> buffer[BUFSIZ];
02155   <font class="keywordtype">unsigned</font> <font class="keywordtype">int</font> i = 0;
02156 
02157   
02158   <font class="comment">/* rewind the file</font>
02159 <font class="comment">   * TODO: check if this is neccessary at this point */</font>
02160   rewind(data-&gt;<a class="code" href="structgamessdata.html#m0">file</a>);
02161 
02162 
02163   <font class="comment">/* initialize buffers */</font>
02164   buffer[0] = <font class="charliteral">'\0'</font>;
02165   <font class="keywordflow">for</font> ( i = 0; i &lt; 2; ++i) word[i][0] = <font class="charliteral">'\0'</font>;
02166 
02167 
02168   <font class="comment">/* parse for GUESS field */</font>
02169   <font class="keywordflow">do</font>
02170   {
02171     <a class="code" href="gamessplugin_8c.html#a2">ERR_FALSE</a>( fgets(buffer,<font class="keyword">sizeof</font>(buffer),data-&gt;<a class="code" href="structgamessdata.html#m0">file</a>) )
02172     sscanf(buffer,<font class="stringliteral">"%s %s"</font>,&amp;word[0][0],&amp;word[1][0]);
02173 
02174   } <font class="keywordflow">while</font>(strcmp(&amp;word[0][0],<font class="stringliteral">"GUESS"</font>) || 
02175           strcmp(&amp;word[1][0],<font class="stringliteral">"OPTIONS"</font>));
02176 
02177 
02178   <font class="comment">/* next line contains all we need */</font>
02179   <a class="code" href="xsfplugin_8C.html#a36">eatline</a>(data-&gt;<a class="code" href="structgamessdata.html#m0">file</a>);
02180   <a class="code" href="gamessplugin_8c.html#a2">ERR_FALSE</a>( fgets(buffer,<font class="keyword">sizeof</font>(buffer),data-&gt;<a class="code" href="structgamessdata.html#m0">file</a>) )
02181   sscanf(buffer,<font class="stringliteral">"%s %s"</font>,&amp;word[0][0],&amp;word[1][0]);
02182 
02183   <font class="comment">/* store it */</font>
02184   strncpy(data-&gt;<a class="code" href="structgamessdata.html#m14">guess</a>,(&amp;word[1][0])+1,<font class="keyword">sizeof</font>(data-&gt;<a class="code" href="structgamessdata.html#m14">guess</a>));
02185 
02186   
02187   <font class="comment">/* short info */</font>
02188   printf(<font class="stringliteral">"gamessplugin&gt; Run was performed with GUESS = %s \n"</font>,
02189           data-&gt;<a class="code" href="structgamessdata.html#m14">guess</a>);
02190 
02191   <font class="keywordflow">return</font> <a class="code" href="gamessplugin_8h.html#a7">TRUE</a>;
02192 }
02193 
02194 
02195 
02196 <font class="comment">/*******************************************************</font>
02197 <font class="comment"> *</font>
02198 <font class="comment"> * this function reads in the basis set data </font>
02199 <font class="comment"> *</font>
02200 <font class="comment"> * ******************************************************/</font>
<a name="l02201"></a><a class="code" href="gamessplugin_8c.html#a22">02201</a> <font class="keywordtype">int</font> <a class="code" href="gamessplugin_8c.html#a22">get_basis</a>(<font class="keywordtype">void</font> *mydata)
02202 {
02203 
02204   <a class="code" href="structgamessdata.html">gamessdata</a> *data = (<a class="code" href="structgamessdata.html">gamessdata</a> *)mydata;
02205   <font class="keywordtype">float</font> *basis;
02206   <font class="keywordtype">int</font> *basis_counter;
02207   <font class="keywordtype">int</font> *atomic_shells;
02208   <font class="keywordtype">int</font> *shell_primitives;
02209   <font class="keywordtype">char</font> *orbital_symmetry;
02210   <font class="keywordtype">char</font> buffer[BUFSIZ];
02211   <font class="keywordtype">char</font> word[3][BUFSIZ];
02212   <font class="keywordtype">unsigned</font> <font class="keywordtype">int</font> i = 0; 
02213   <font class="keywordtype">int</font> counter = 0, oldcounter = 0, nat = 0;
02214 
02215   
02216   <font class="comment">/* initialize buffers */</font>
02217   buffer[0] = <font class="charliteral">'\0'</font>;
02218   <font class="keywordflow">for</font> ( i = 0; i &lt; 3; ++i ) word[i][0] = <font class="charliteral">'\0'</font>;
02219 
02220 
02221   <font class="comment">/* reserve space for pointer to array containing basis</font>
02222 <font class="comment">   * info, i.e. contraction coeficients and expansion </font>
02223 <font class="comment">   * coefficients; need 2 entries per basis function, i.e.</font>
02224 <font class="comment">   * exponent and contraction coefficient; also,</font>
02225 <font class="comment">   * allocate space for the basis_counter (i.e. # of</font>
02226 <font class="comment">   * basis functions per atoms as well as the array</font>
02227 <font class="comment">   * holding the orbital symmetry information per primitive</font>
02228 <font class="comment">   * Gaussian</font>
02229 <font class="comment">   * Finally, initialize the arrays holding the number of </font>
02230 <font class="comment">   * shells per atom and the number of primitives per shell*/</font>
02231   basis = (<font class="keywordtype">float</font> *)calloc(2*<a class="code" href="gamessplugin_8h.html#a1">MAXBASISFUNCTIONS</a>,<font class="keyword">sizeof</font>(<font class="keywordtype">float</font>));
02232 
02233   <font class="comment">/* make sure memory was allocated properly */</font>
02234   <font class="keywordflow">if</font> (basis == NULL) 
02235   {
02236     <a class="code" href="gamessplugin_8c.html#a1">PRINTERR</a>;
02237     <font class="keywordflow">return</font> <a class="code" href="molfile__plugin_8h.html#a4">MOLFILE_ERROR</a>;
02238   }
02239 
02240 
02241   basis_counter = (<font class="keywordtype">int</font> *)calloc(<a class="code" href="gamessplugin_8h.html#a0">MAXQMATOMS</a>,<font class="keyword">sizeof</font>(<font class="keywordtype">int</font>));
02242 
02243   <font class="comment">/* make sure memory was allocated properly */</font>
02244   <font class="keywordflow">if</font> (basis_counter == NULL) 
02245   {
02246     <a class="code" href="gamessplugin_8c.html#a1">PRINTERR</a>;       
02247     <font class="keywordflow">return</font> <a class="code" href="molfile__plugin_8h.html#a4">MOLFILE_ERROR</a>;
02248   }
02249 
02250 
02251   orbital_symmetry = (<font class="keywordtype">char</font> *)calloc(<a class="code" href="gamessplugin_8h.html#a1">MAXBASISFUNCTIONS</a>,
02252                      <font class="keyword">sizeof</font>(<font class="keywordtype">char</font>));
02253   
02254   <font class="comment">/* make sure memory was allocated properly */</font>
02255   <font class="keywordflow">if</font> (orbital_symmetry == NULL) 
02256   {
02257     <a class="code" href="gamessplugin_8c.html#a1">PRINTERR</a>; 
02258     <font class="keywordflow">return</font> <a class="code" href="molfile__plugin_8h.html#a4">MOLFILE_ERROR</a>;
02259   }
02260 
02261   atomic_shells = (<font class="keywordtype">int</font> *)calloc(<a class="code" href="gamessplugin_8h.html#a1">MAXBASISFUNCTIONS</a>, <font class="keyword">sizeof</font>(<font class="keywordtype">int</font>));
02262 
02263   <font class="comment">/* make sure memory was allocated properly */</font>
02264   <font class="keywordflow">if</font> (atomic_shells == NULL) 
02265   {
02266     <a class="code" href="gamessplugin_8c.html#a1">PRINTERR</a>; 
02267     <font class="keywordflow">return</font> <a class="code" href="molfile__plugin_8h.html#a4">MOLFILE_ERROR</a>;
02268   }
02269 
02270 
02271   shell_primitives = (<font class="keywordtype">int</font> *)calloc(<a class="code" href="gamessplugin_8h.html#a1">MAXBASISFUNCTIONS</a>, <font class="keyword">sizeof</font>(<font class="keywordtype">int</font>));
02272 
02273   <font class="comment">/* make sure memory was allocated properly */</font>
02274   <font class="keywordflow">if</font> (shell_primitives == NULL) 
02275   {
02276     <a class="code" href="gamessplugin_8c.html#a1">PRINTERR</a>;       
02277     <font class="keywordflow">return</font> <a class="code" href="molfile__plugin_8h.html#a4">MOLFILE_ERROR</a>;
02278   }
02279 
02280 
02281   <font class="comment">/* store pointers in struct gamessdata */</font>
02282   data-&gt;<a class="code" href="structgamessdata.html#m61">basis</a> = basis;
02283   data-&gt;<a class="code" href="structgamessdata.html#m62">basis_counter</a> = basis_counter;
02284   data-&gt;<a class="code" href="structgamessdata.html#m66">orbital_symmetry</a> = orbital_symmetry;
02285   data-&gt;<a class="code" href="structgamessdata.html#m64">atomic_shells</a> = atomic_shells;
02286   data-&gt;<a class="code" href="structgamessdata.html#m65">shell_primitives</a> = shell_primitives;
02287 
02288   <font class="comment">/* next parse through output file and look for the </font>
02289 <font class="comment">   * atomic basis set, i.e.</font>
02290 <font class="comment">   *</font>
02291 <font class="comment">   * ATOMIC BASIS SET</font>
02292 <font class="comment">   *</font>
02293 <font class="comment">   */</font>
02294 
02295   rewind(data-&gt;<a class="code" href="structgamessdata.html#m0">file</a>);
02296  
02297   <font class="comment">/* initialize the per-atom basis function counter */</font>
02298   oldcounter = 0;
02299   counter = 0;
02300 
02301   <font class="comment">/* start reading the basis function field */</font>
02302   <font class="keywordflow">do</font>
02303   {
02304     <a class="code" href="gamessplugin_8c.html#a2">ERR_FALSE</a>( fgets(buffer,<font class="keyword">sizeof</font>(buffer),data-&gt;<a class="code" href="structgamessdata.html#m0">file</a>) )
02305     sscanf(buffer,<font class="stringliteral">"%s %s %s"</font>,&amp;word[0][0],&amp;word[1][0],&amp;word[2][0]);
02306 
02307   } <font class="keywordflow">while</font>(strcmp(&amp;word[0][0],<font class="stringliteral">"ATOMIC"</font>) || 
02308           strcmp(&amp;word[1][0],<font class="stringliteral">"BASIS"</font>) || 
02309           strcmp(&amp;word[2][0],<font class="stringliteral">"SET"</font>));
02310 
02311 
02312   <font class="comment">/* skip the next 8 lines */</font>
02313   <font class="keywordflow">for</font>(i=0; i&lt;7; i++)
02314   {
02315     <a class="code" href="xsfplugin_8C.html#a36">eatline</a>(data-&gt;<a class="code" href="structgamessdata.html#m0">file</a>);
02316   }
02317 
02318 
02319   <font class="comment">/* the number of atoms determines how often we have</font>
02320 <font class="comment">   * to loop through the basis function array */</font>
02321   nat = data-&gt;<a class="code" href="structgamessdata.html#m1">numatoms</a>;
02322  
02323 
02324   <font class="comment">/* now loop through the basis function section of the</font>
02325 <font class="comment">   * output file and read in the exponents/coefficients */</font>
02326   <font class="keywordflow">for</font>(i=0; i&lt;nat; i++)
02327   {
02328     <font class="comment">/* here I go trough the basis set information on a </font>
02329 <font class="comment">     * per atom basis and put all the exps and coefficients</font>
02330 <font class="comment">     * in the right place */</font>
02331     counter = <a class="code" href="gamessplugin_8c.html#a24">atomic_basis</a>(oldcounter, data, basis, 
02332          orbital_symmetry, atomic_shells,shell_primitives); 
02333 
02334 
02335     <font class="comment">/* if atomic_basis() returns -1 we need to bomb</font>
02336 <font class="comment">     * out */</font>
02337     <font class="keywordflow">if</font> ( counter == -1 ) <font class="keywordflow">return</font> <a class="code" href="gamessplugin_8h.html#a6">FALSE</a>;
02338 
02339 
02340     <font class="comment">/* store number of basis-functions in array</font>
02341 <font class="comment">    * basis_counter */</font>
02342     *basis_counter = counter;
02343 
02344 
02345     <font class="comment">/* increase pointer to next entry */</font>
02346     basis_counter++;
02347 
02348 
02349     <font class="comment">/* update the pointer for the basis arrays */</font> 
02350     oldcounter += counter;
02351 
02352 
02353     <font class="comment">/* increase atomic_shell pointer to hold value for</font>
02354 <font class="comment">    * next atom */</font>
02355     atomic_shells++;
02356   } 
02357 
02358 
02359   <font class="comment">/* store the total number of basis functions */</font>
02360   data-&gt;<a class="code" href="structgamessdata.html#m63">num_basis_funcs</a> = oldcounter;
02361 
02362 
02363   <font class="comment">/* short info */</font> 
02364   printf(<font class="stringliteral">"gamessplugin&gt; Parsed %d uncontracted basis functions. \n"</font>,
02365       data-&gt;<a class="code" href="structgamessdata.html#m63">num_basis_funcs</a>);
02366 
02367   <font class="keywordflow">return</font> <a class="code" href="gamessplugin_8h.html#a7">TRUE</a>;
02368 }
02369 
02370 
02371 
02372 <font class="comment">/*******************************************************</font>
02373 <font class="comment"> *</font>
02374 <font class="comment"> * function renormalizing basis set coefficients of</font>
02375 <font class="comment"> * primitives</font>
02376 <font class="comment"> *</font>
02377 <font class="comment"> *******************************************************/</font>
<a name="l02378"></a><a class="code" href="gamessplugin_8c.html#a23">02378</a> <font class="keywordtype">float</font> <a class="code" href="gamessplugin_8c.html#a23">renorm_coefficient</a>(<font class="keywordtype">float</font> coefficient, <font class="keywordtype">float</font> exponent, 
02379         <font class="keywordtype">char</font> orb)
02380 {
02381   <font class="comment">/* normalization for S shells */</font>
02382   <font class="keywordflow">if</font> ( orb == <font class="charliteral">'S'</font> )
02383   {
02384     <font class="keywordflow">return</font> pow(exponent,1.5) *  pow((8/pow(<a class="code" href="gamessplugin_8h.html#a2">MY_PI</a>,3)),0.5)
02385       * coefficient;
02386   }
02387 
02388   <font class="comment">/* normalization for P shells */</font>
02389   <font class="keywordflow">else</font> <font class="keywordflow">if</font> ( orb == <font class="charliteral">'P'</font> )
02390   {
02391     <font class="keywordflow">return</font> pow(exponent,2.5) * pow((128/pow(<a class="code" href="gamessplugin_8h.html#a2">MY_PI</a>,3)),0.5) 
02392       * coefficient;
02393   }
02394 
02395   <font class="comment">/* TODO: the renormalization factor for D and F shells</font>
02396 <font class="comment">   * are taken from MOLDEN; check them! */</font>
02397 
02398   <font class="comment">/* normalization for D shells */</font>
02399   <font class="keywordflow">else</font> <font class="keywordflow">if</font> ( orb == <font class="charliteral">'D'</font> )
02400   {
02401     <font class="keywordflow">return</font> pow(exponent,3.5) * pow((2048/9/pow(<a class="code" href="gamessplugin_8h.html#a2">MY_PI</a>,3)),0.5)
02402         * coefficient;
02403   }
02404 
02405   <font class="comment">/* normalization for F shells */</font>
02406   <font class="keywordflow">else</font> <font class="keywordflow">if</font> ( orb == <font class="charliteral">'F'</font> )
02407   {
02408     <font class="keywordflow">return</font> pow(exponent,4.5) * 1.875 * pow((512/pow(<a class="code" href="gamessplugin_8h.html#a2">MY_PI</a>,3)),0.5)
02409         * coefficient;
02410   }
02411 
02412 
02413   <font class="comment">/* return 0 otherwise */</font>
02414   <font class="keywordflow">return</font> 0;
02415 }
02416 
02417 
02418 
02419 <font class="comment">/******************************************************</font>
02420 <font class="comment"> *</font>
02421 <font class="comment"> * this function scans a single line in the basis set</font>
02422 <font class="comment"> * data section </font>
02423 <font class="comment"> *</font>
02424 <font class="comment"> * *****************************************************/</font>
<a name="l02425"></a><a class="code" href="gamessplugin_8c.html#a24">02425</a> <font class="keywordtype">int</font> <a class="code" href="gamessplugin_8c.html#a24">atomic_basis</a>(<font class="keywordtype">int</font> oldcounter, <font class="keywordtype">void</font> *mydata, <font class="keywordtype">float</font> *basis, 
02426              <font class="keywordtype">char</font> *orbital_symmetry, <font class="keywordtype">int</font> *atomic_shells, 
02427              <font class="keywordtype">int</font> *shell_primitives)
02428 {
02429   <a class="code" href="structgamessdata.html">gamessdata</a> *data = (<a class="code" href="structgamessdata.html">gamessdata</a> *)mydata;
02430   <font class="keywordtype">char</font> dummy[BUFSIZ];
02431   <font class="keywordtype">char</font> buffer[BUFSIZ];
02432   <font class="keywordtype">char</font> orbsym;
02433   <font class="keywordtype">float</font> exponent = 0.0; 
02434   <font class="keywordtype">float</font> contract_c1 = 0.0, contract_c2 = 0.0;
02435   <font class="keywordtype">int</font> counter, success;
02436   <font class="keyword">static</font> <font class="keywordtype">int</font> prim_count = -1;
02437   <font class="keywordtype">int</font> prev_shell = 0;
02438   <font class="keywordtype">int</font> shell;
02439 
02440 
02441   <font class="comment">/* initialize arrays */</font>
02442   dummy[0] = <font class="charliteral">'\0'</font>;
02443   buffer[0] = <font class="charliteral">'\0'</font>;
02444 
02445 
02446   <font class="comment">/* initialize basis function counter for current atom */</font>
02447   counter = oldcounter;
02448 
02449 
02450   <font class="comment">/* skip one line */</font>
02451   <a class="code" href="xsfplugin_8C.html#a36">eatline</a>(data-&gt;<a class="code" href="structgamessdata.html#m0">file</a>);
02452 
02453 
02454   <font class="comment">/* loop through basis set info for next atom */</font>
02455   <font class="keywordflow">do</font>
02456   {
02457     <a class="code" href="gamessplugin_8c.html#a2">ERR_FALSE</a>( fgets(buffer,<font class="keyword">sizeof</font>(buffer),data-&gt;<a class="code" href="structgamessdata.html#m0">file</a>) )
02458     success = sscanf(buffer,<font class="stringliteral">"%d %c %s %f %f %f"</font>, &amp;shell, \
02459                      &amp;orbsym, dummy, \
02460                      &amp;exponent, &amp;contract_c1, &amp;contract_c2); 
02461 
02462     
02463     <font class="comment">/* make sure we have eiter S, L, P, or D shells;</font>
02464 <font class="comment">     * otherwise we bomb out;</font>
02465 <font class="comment">     * TODO: Add support for F SHELLS */</font>
02466     <font class="keywordflow">if</font> ( (success == 5  || success == 6 ) &amp;&amp; 
02467          (orbsym != <font class="charliteral">'S'</font> &amp;&amp; orbsym != <font class="charliteral">'L'</font> &amp;&amp; orbsym != <font class="charliteral">'P'</font> &amp;&amp; 
02468           orbsym != <font class="charliteral">'D'</font> &amp;&amp; orbsym != <font class="charliteral">'F'</font> ))
02469     {
02470       printf(<font class="stringliteral">"gamessplugin&gt; WARNING ... %c shells are not supported \n"</font>, orbsym);
02471       <font class="keywordflow">return</font> -1;
02472     }
02473 
02474 
02475     <font class="comment">/* when this function is called prev_shell is</font>
02476 <font class="comment">     * initialized to zero;</font>
02477 <font class="comment">     * Next we compare it to the shell number just read in;</font>
02478 <font class="comment">     * in case they are different we increase atomic_shell</font>
02479 <font class="comment">     * by one and then update prev_shell with the new shell</font>
02480 <font class="comment">     * value */</font>
02481    <font class="keywordflow">if</font> ( prev_shell != shell &amp;&amp; success &gt; 0 )
02482     {
02483       prim_count++;
02484       (*atomic_shells)++;
02485       prev_shell = shell;
02486     }
02487    
02488 
02489     <font class="comment">/* store in basis array and increase the counter */</font> 
02490     <font class="keywordflow">switch</font>(success)
02491     {
02492       <font class="keywordflow">case</font>(5):
02493         {
02494           <font class="comment">/* store exponent */</font>
02495           *(basis+(2*counter)) = exponent;
02496 
02497 
02498           <font class="comment">/* renormalize and store coefficient */</font>
02499           *(basis+(2*counter+1)) = 
02500               <a class="code" href="gamessplugin_8c.html#a23">renorm_coefficient</a>(contract_c1,exponent,orbsym);
02501 
02502 
02503           <font class="comment">/* store orbital symmetry */</font>
02504           *(orbital_symmetry+counter) = orbsym;
02505 
02506 
02507           <font class="comment">/* increase counter */</font>
02508           counter++;
02509 
02510 
02511           <font class="comment">/* increase counter for number of primitives</font>
02512 <font class="comment">           * for current shell */</font>
02513           (*(shell_primitives+prim_count))++;
02514 
02515           <font class="keywordflow">break</font>;
02516         }
02517       <font class="keywordflow">case</font>(6):
02518         { 
02519           <font class="comment">/* in the case of two contraction</font>
02520 <font class="comment">           * coefficients we expect "L" as orbital </font>
02521 <font class="comment">           * symmetry, meaning that the first coefficient</font>
02522 <font class="comment">           * has S and the second P symmetry. Otherwise</font>
02523 <font class="comment">           * print a warning */</font>
02524           <font class="keywordflow">if</font> ( orbsym != <font class="charliteral">'L'</font> ) 
02525           {
02526             printf(<font class="stringliteral">"gamessplugin&gt;\n"</font>);
02527             printf(<font class="stringliteral">"gamessplugin&gt; WARNING ... Non SP-Shell %c"</font>, 
02528                 orbsym);
02529             printf(<font class="stringliteral">" interpreted as SP-Shell\n"</font>);
02530             printf(<font class="stringliteral">"gamessplugin&gt;\n"</font>);
02531           }
02532 
02533 
02534           <font class="comment">/* line has two coefficient pairs,</font>
02535 <font class="comment">           * store the first one */</font>
02536           *(basis+(2*counter)) = exponent;
02537 
02538           
02539           <font class="comment">/* renormalize and store coefficient */</font>
02540           *(basis+(2*counter+1)) = 
02541               <a class="code" href="gamessplugin_8c.html#a23">renorm_coefficient</a>(contract_c1,exponent,<font class="charliteral">'S'</font>);
02542 
02543 
02544           <font class="comment">/* the first coefficient has S symmetry */</font>
02545           *(orbital_symmetry+counter) = <font class="charliteral">'S'</font>;
02546 
02547 
02548           <font class="comment">/* increase counter */</font>
02549           counter++;
02550 
02551 
02552           <font class="comment">/* increase counter for number of primitives</font>
02553 <font class="comment">           * for current shell */</font>
02554           (*(shell_primitives+prim_count))++;
02555 
02556           
02557           <font class="comment">/* same procedure for the second pair */</font>
02558           *(basis+(2*counter)) = exponent;
02559 
02560 
02561           <font class="comment">/* renormalize and store coefficient */</font>
02562           *(basis+(2*counter+1)) = 
02563               <a class="code" href="gamessplugin_8c.html#a23">renorm_coefficient</a>(contract_c2,exponent,<font class="charliteral">'P'</font>);
02564 
02565 
02566           <font class="comment">/* the second coefficient has P symmetry */</font>
02567           *(orbital_symmetry+counter) = <font class="charliteral">'P'</font>;
02568 
02569           counter++;
02570           (*(shell_primitives+prim_count))++;
02571 
02572           <font class="keywordflow">break</font>;
02573         }
02574        <font class="keywordflow">case</font>(-1):
02575         {
02576           <font class="keywordflow">break</font>; 
02577         }
02578        <font class="keywordflow">case</font>(0):
02579         {
02580           <font class="keywordflow">break</font>;
02581         }
02582        <font class="keywordflow">case</font>(3):
02583         {
02584           <font class="keywordflow">break</font>; 
02585         } 
02586        <font class="keywordflow">default</font>:    <font class="comment">/* this should never happen */</font>
02587         {
02588         <font class="keywordflow">return</font> <a class="code" href="molfile__plugin_8h.html#a4">MOLFILE_ERROR</a>; 
02589         <font class="keywordflow">break</font>;
02590         }
02591     }
02592   }  <font class="keywordflow">while</font>((success!=0) &amp;&amp; (success!=3));
02593 
02594 
02595   <font class="comment">/* return only the counter difference */</font>
02596   <font class="keywordflow">return</font> (counter - oldcounter);
02597 }
02598 
02599 
02600 <font class="comment">/********************************************************</font>
02601 <font class="comment"> *</font>
02602 <font class="comment"> * this function reads the number of A/B orbitals </font>
02603 <font class="comment"> *</font>
02604 <font class="comment"> ********************************************************/</font>
<a name="l02605"></a><a class="code" href="gamessplugin_8c.html#a25">02605</a> <font class="keywordtype">int</font> <a class="code" href="gamessplugin_8c.html#a25">get_num_orbitals</a>(<font class="keywordtype">void</font> *mydata)
02606 {
02607 
02608   <a class="code" href="structgamessdata.html">gamessdata</a> *data = (<a class="code" href="structgamessdata.html">gamessdata</a> *)mydata; 
02609   <font class="keywordtype">char</font> buffer[BUFSIZ];
02610   <font class="keywordtype">char</font> word[7][BUFSIZ];
02611   <font class="keywordtype">unsigned</font> <font class="keywordtype">int</font> i;
02612 
02613   <font class="comment">/* initialize buffers */</font>
02614   buffer[0] = <font class="charliteral">'\0'</font>;
02615   <font class="keywordflow">for</font> ( i = 0; i &lt; 7; ++i) word[i][0] = <font class="charliteral">'\0'</font>;
02616 
02617 
02618   <font class="comment">/* we start reading the file from the beginning */</font>
02619   rewind(data-&gt;<a class="code" href="structgamessdata.html#m0">file</a>);
02620 
02621 
02622   <font class="comment">/* look for the orbital/charge/... info section */</font>
02623   <font class="keywordflow">do</font>
02624   {
02625     <a class="code" href="gamessplugin_8c.html#a2">ERR_FALSE</a>( fgets(buffer,<font class="keyword">sizeof</font>(buffer),data-&gt;<a class="code" href="structgamessdata.html#m0">file</a>) )
02626     sscanf(buffer,<font class="stringliteral">"%s %s %s %s"</font>,&amp;word[0][0], &amp;word[1][0],
02627         &amp;word[2][0], &amp;word[3][0]);
02628 
02629   } <font class="keywordflow">while</font>(strcmp(&amp;word[0][0],<font class="stringliteral">"TOTAL"</font>) || 
02630           strcmp(&amp;word[1][0],<font class="stringliteral">"NUMBER"</font>) || 
02631           strcmp(&amp;word[2][0],<font class="stringliteral">"OF"</font>)    || 
02632           strcmp(&amp;word[3][0],<font class="stringliteral">"BASIS"</font>));
02633 
02634   
02635   <font class="comment">/* go ahead reading the info */</font>
02636   <a class="code" href="gamessplugin_8c.html#a2">ERR_FALSE</a>( fgets(buffer,<font class="keyword">sizeof</font>(buffer),data-&gt;<a class="code" href="structgamessdata.html#m0">file</a>) )
02637   sscanf(buffer,<font class="stringliteral">"%s %s %s %s %s %s %s %d"</font>, &amp;word[0][0],
02638       &amp;word[1][0], &amp;word[2][0], &amp;word[3][0], &amp;word[4][0],
02639       &amp;word[5][0], &amp;word[6][0], &amp;(data-&gt;<a class="code" href="structgamessdata.html#m72">num_gauss_basis_funcs</a>));
02640 
02641 
02642 
02643   <font class="comment">/* read the number of electrons */</font>
02644   <a class="code" href="gamessplugin_8c.html#a2">ERR_FALSE</a>( fgets(buffer,<font class="keyword">sizeof</font>(buffer),data-&gt;<a class="code" href="structgamessdata.html#m0">file</a>) )
02645   sscanf(buffer,<font class="stringliteral">"%s %s %s %s %d"</font>, &amp;word[0][0], &amp;word[1][0],
02646       &amp;word[2][0], &amp;word[3][0], &amp;(data-&gt;<a class="code" href="structgamessdata.html#m23">num_electrons</a>));
02647 
02648 
02649 
02650   <font class="comment">/* read the charge of the molecule */</font>
02651   <a class="code" href="gamessplugin_8c.html#a2">ERR_FALSE</a>( fgets(buffer,<font class="keyword">sizeof</font>(buffer),data-&gt;<a class="code" href="structgamessdata.html#m0">file</a>) )
02652   sscanf(buffer,<font class="stringliteral">"%s %s %s %s %d"</font>, &amp;word[0][0], &amp;word[1][0],
02653       &amp;word[2][0], &amp;word[3][0], &amp;(data-&gt;<a class="code" href="structgamessdata.html#m21">totalcharge</a>));
02654 
02655 
02656 
02657   <font class="comment">/* read the multiplicity of the molecule */</font>
02658   <a class="code" href="gamessplugin_8c.html#a2">ERR_FALSE</a>( fgets(buffer,<font class="keyword">sizeof</font>(buffer),data-&gt;<a class="code" href="structgamessdata.html#m0">file</a>) )
02659   sscanf(buffer,<font class="stringliteral">"%s %s %s %d"</font>, &amp;word[0][0], &amp;word[1][0],
02660        &amp;word[2][0], &amp;(data-&gt;<a class="code" href="structgamessdata.html#m22">multiplicity</a>));
02661 
02662   
02663   <font class="comment">/* read number of A orbitals */</font>
02664   <a class="code" href="gamessplugin_8c.html#a2">ERR_FALSE</a>( fgets(buffer,<font class="keyword">sizeof</font>(buffer),data-&gt;<a class="code" href="structgamessdata.html#m0">file</a>) )
02665 
02666 
02667   <font class="comment">/* note the different number of items per line for A/B orbitals</font>
02668 <font class="comment">   * due to "(ALPHA)" and "(BETA )" !! */</font>
02669   sscanf(buffer,<font class="stringliteral">"%s %s %s %s %s %s %d"</font>, &amp;word[0][0], &amp;word[1][0],
02670       &amp;word[2][0], &amp;word[3][0], &amp;word[4][0], &amp;word[5][0],
02671       &amp;(data-&gt;<a class="code" href="structgamessdata.html#m69">num_orbitals_A</a>)); 
02672   
02673   
02674   
02675   <font class="comment">/* read number of B orbitals */</font>
02676   <a class="code" href="gamessplugin_8c.html#a2">ERR_FALSE</a>( fgets(buffer,<font class="keyword">sizeof</font>(buffer),data-&gt;<a class="code" href="structgamessdata.html#m0">file</a>) )
02677   sscanf(buffer,<font class="stringliteral">"%s %s %s %s %s %s %s %d"</font>, &amp;word[0][0], &amp;word[1][0],
02678       &amp;word[2][0], &amp;word[3][0], &amp;word[4][0], &amp;word[5][0], 
02679       &amp;word[6][0], &amp;(data-&gt;<a class="code" href="structgamessdata.html#m70">num_orbitals_B</a>)); 
02680 
02681 
02682   
02683   <font class="comment">/* short message */</font>
02684   printf(<font class="stringliteral">"gamessplugin&gt; Number of Electrons: %d \n"</font>,
02685       data-&gt;<a class="code" href="structgamessdata.html#m23">num_electrons</a>);
02686 
02687   printf(<font class="stringliteral">"gamessplugin&gt; Charge of Molecule : %d \n"</font>,
02688       data-&gt;<a class="code" href="structgamessdata.html#m21">totalcharge</a>);
02689 
02690   printf(<font class="stringliteral">"gamessplugin&gt; Multiplicity of Wavefunction: %d \n"</font>,
02691       data-&gt;<a class="code" href="structgamessdata.html#m22">multiplicity</a>);
02692 
02693   printf(<font class="stringliteral">"gamessplugin&gt; Number of A / B orbitals: %d / %d \n"</font>,\
02694       data-&gt;<a class="code" href="structgamessdata.html#m69">num_orbitals_A</a>, data-&gt;<a class="code" href="structgamessdata.html#m70">num_orbitals_B</a>);
02695 
02696   printf(<font class="stringliteral">"gamessplugin&gt; Number of gaussian basis functions: %d \n"</font>,\
02697       data-&gt;<a class="code" href="structgamessdata.html#m72">num_gauss_basis_funcs</a>);
02698 
02699  
02700   <font class="keywordflow">return</font> <a class="code" href="gamessplugin_8h.html#a7">TRUE</a>;
02701 }
02702 
02703 
02704 <font class="comment">/*********************************************************</font>
02705 <font class="comment"> *</font>
02706 <font class="comment"> * this function reads the actual wavefunction, which is</font>
02707 <font class="comment"> * punched at the end of the log file</font>
02708 <font class="comment"> *</font>
02709 <font class="comment"> **********************************************************/</font>
<a name="l02710"></a><a class="code" href="gamessplugin_8c.html#a26">02710</a> <font class="keywordtype">int</font> <a class="code" href="gamessplugin_8c.html#a26">get_wavefunction</a>(<font class="keywordtype">void</font> *mydata)
02711 {
02712   <a class="code" href="structgamessdata.html">gamessdata</a> *data = (<a class="code" href="structgamessdata.html">gamessdata</a> *)mydata; 
02713   <font class="keywordtype">float</font> *wave_function;
02714   <font class="keywordtype">float</font> *orbital_energy;
02715   <font class="keywordtype">char</font> buffer[BUFSIZ];
02716   <font class="keywordtype">char</font> word[5][BUFSIZ];
02717   <font class="keywordtype">char</font> dummy1, dummy2, dummy3, dummy4;
02718   <font class="keywordtype">int</font> orbital_counter = 0;
02719   <font class="keywordtype">unsigned</font> <font class="keywordtype">int</font> i = 0, j = 0, num_values = 0;
02720   <font class="keywordtype">int</font> length = 0;
02721 
02722 
02723   <font class="comment">/* initialize buffers */</font>
02724   buffer[0] = <font class="charliteral">'\0'</font>;
02725   <font class="keywordflow">for</font> ( i = 0; i &lt; 5; ++i ) word[i][0] = <font class="charliteral">'\0'</font>;
02726 
02727   
02728   <font class="comment">/* reserve space for arrays storing wavefunction and orbital</font>
02729 <font class="comment">   * energies </font>
02730 <font class="comment">   * For the wavefunction I reserve twice the number of A orbitals</font>
02731 <font class="comment">   * times MAXBASISFUNCTIONS;</font>
02732 <font class="comment">   * I should check the gamess sources how much are printed out,</font>
02733 <font class="comment">   * but this should cover me for now. </font>
02734 <font class="comment">   * Accordingly, for the energies I use the number of A orbitals */</font>
02735   wave_function = (<font class="keywordtype">float</font> *)calloc(data-&gt;<a class="code" href="structgamessdata.html#m72">num_gauss_basis_funcs</a> * \
02736                   data-&gt;<a class="code" href="structgamessdata.html#m72">num_gauss_basis_funcs</a>,<font class="keyword">sizeof</font>(<font class="keywordtype">float</font>)); 
02737 
02738   <font class="comment">/* make sure memory was allocated properly */</font>
02739   <font class="keywordflow">if</font> (wave_function == NULL) 
02740   {
02741     <a class="code" href="gamessplugin_8c.html#a1">PRINTERR</a>;       
02742     <font class="keywordflow">return</font> <a class="code" href="gamessplugin_8h.html#a6">FALSE</a>;
02743   }
02744   
02745   orbital_energy = (<font class="keywordtype">float</font> *)calloc(data-&gt;<a class="code" href="structgamessdata.html#m72">num_gauss_basis_funcs</a>, \
02746                       <font class="keyword">sizeof</font>(<font class="keywordtype">float</font>));
02747 
02748   <font class="comment">/* make sure memory was allocated properly */</font>
02749   <font class="keywordflow">if</font> (orbital_energy == NULL) 
02750   {
02751     <a class="code" href="gamessplugin_8c.html#a1">PRINTERR</a>; 
02752     <font class="keywordflow">return</font> <a class="code" href="gamessplugin_8h.html#a6">FALSE</a>;
02753   }
02754 
02755   <font class="comment">/* store the pointers in gamessdata */</font>
02756   data-&gt;<a class="code" href="structgamessdata.html#m67">wave_function</a> = wave_function;
02757   data-&gt;<a class="code" href="structgamessdata.html#m68">orbital_energy</a> = orbital_energy;
02758 
02759   
02760   <font class="comment">/* rewind the file before starting to look for</font>
02761 <font class="comment">   * the wavefunction */</font>
02762 
02763   rewind(data-&gt;<a class="code" href="structgamessdata.html#m0">file</a>);
02764   
02765   <font class="keywordflow">do</font>
02766   {
02767     <a class="code" href="gamessplugin_8c.html#a2">ERR_FALSE</a>( fgets(buffer,<font class="keyword">sizeof</font>(buffer),data-&gt;<a class="code" href="structgamessdata.html#m0">file</a>) )
02768     length = sscanf(buffer,<font class="stringliteral">"%s %s"</font>,&amp;word[0][0],&amp;word[1][0]);
02769 
02770   } <font class="keywordflow">while</font>(strcmp(&amp;word[0][0],<font class="stringliteral">"EIGENVECTORS"</font>) || length != 1);
02771 
02772   
02773   <font class="comment">/* skip the next three lines */</font>
02774   <a class="code" href="xsfplugin_8C.html#a36">eatline</a>(data-&gt;<a class="code" href="structgamessdata.html#m0">file</a>);
02775   <a class="code" href="xsfplugin_8C.html#a36">eatline</a>(data-&gt;<a class="code" href="structgamessdata.html#m0">file</a>);
02776   <a class="code" href="xsfplugin_8C.html#a36">eatline</a>(data-&gt;<a class="code" href="structgamessdata.html#m0">file</a>);
02777 
02778 
02779   <font class="comment">/* go ahead */</font>
02780   <a class="code" href="gamessplugin_8c.html#a2">ERR_FALSE</a>( fgets(buffer,<font class="keyword">sizeof</font>(buffer),data-&gt;<a class="code" href="structgamessdata.html#m0">file</a>) )
02781   num_values = sscanf(buffer,<font class="stringliteral">"%s %s %s %s %s"</font>,&amp;word[0][0],
02782       &amp;word[1][0],&amp;word[2][0],&amp;word[3][0],&amp;word[4][0]);
02783 
02784 
02785   <font class="keywordflow">while</font>(strcmp(&amp;word[0][0],<font class="stringliteral">"TOTAL"</font>))
02786   {
02787     <font class="comment">/* store the orbital energies in the appropriate arrays </font>
02788 <font class="comment">     * read them until we encounter an empty string */</font>
02789     <font class="keywordflow">for</font>(i=0; i&lt;num_values; i++)
02790     {
02791       *(orbital_energy+i) = atof(&amp;word[i][0]);
02792       orbital_counter++;
02793     }
02794 
02795     <font class="comment">/* increase orbital energy pointer */</font>
02796     orbital_energy = orbital_energy+5;
02797 
02798     <font class="comment">/* skip the next line */</font>
02799     <a class="code" href="xsfplugin_8C.html#a36">eatline</a>(data-&gt;<a class="code" href="structgamessdata.html#m0">file</a>);
02800 
02801     <font class="comment">/* now read in the wavefunction */</font>
02802     <font class="comment">/* markus: go ahead here, instead of just looping</font>
02803 <font class="comment">     * over the lines actually store them :) */</font>
02804     <font class="keywordflow">for</font>(i=0; i&lt; data-&gt;<a class="code" href="structgamessdata.html#m72">num_gauss_basis_funcs</a>; i++)
02805     {
02806       <a class="code" href="gamessplugin_8c.html#a2">ERR_FALSE</a>( fgets(buffer,<font class="keyword">sizeof</font>(buffer),data-&gt;<a class="code" href="structgamessdata.html#m0">file</a>) )
02807       
02808       <font class="comment">/* now read in the wavefunction coefficients for 5</font>
02809 <font class="comment">       * orbitals at a time line by line */</font>
02810       num_values = sscanf(buffer,<font class="stringliteral">"%s %s %s %s %s %s %s %s %s"</font>, 
02811                  &amp;dummy1,&amp;dummy2,&amp;dummy3,&amp;dummy4,&amp;word[0][0], 
02812                  &amp;word[1][0],&amp;word[2][0],&amp;word[3][0],&amp;word[4][0]);
02813 
02814 
02815       <font class="comment">/* each orbital has data-&gt;num_gauss_basis_funcs entries, </font>
02816 <font class="comment">       * hence we have to use this number as offset when storing </font>
02817 <font class="comment">       * them in groups of five */</font>
02818       <font class="keywordflow">for</font>(j=0 ; j&lt;num_values-4; j++) {
02819 
02820         *(wave_function+(j*data-&gt;<a class="code" href="structgamessdata.html#m72">num_gauss_basis_funcs</a>)+i) \
02821                 = atof(&amp;word[j][0]);
02822       }
02823     }
02824 
02825     <font class="comment">/* move wavefunction pointer to start of next five orbitals */</font>
02826     wave_function = wave_function + 5*data-&gt;<a class="code" href="structgamessdata.html#m72">num_gauss_basis_funcs</a>;
02827 
02828     <font class="comment">/* skip next line */</font>
02829     <a class="code" href="xsfplugin_8C.html#a36">eatline</a>(data-&gt;<a class="code" href="structgamessdata.html#m0">file</a>);
02830     <a class="code" href="xsfplugin_8C.html#a36">eatline</a>(data-&gt;<a class="code" href="structgamessdata.html#m0">file</a>);
02831 
02832 
02833     <font class="comment">/* read next line to allow do/while loop to decide if</font>
02834 <font class="comment">     * wavefunction data is over */</font>
02835     <a class="code" href="gamessplugin_8c.html#a2">ERR_FALSE</a>( fgets(buffer,<font class="keyword">sizeof</font>(buffer),data-&gt;<a class="code" href="structgamessdata.html#m0">file</a>) )
02836     num_values = sscanf(buffer,<font class="stringliteral">"%s %s %s %s %s"</font>,&amp;word[0][0],
02837         &amp;word[1][0], &amp;word[2][0], &amp;word[3][0], &amp;word[4][0]);
02838   } 
02839 
02840   <font class="comment">/* store the number of orbitals read in */</font>
02841   data-&gt;<a class="code" href="structgamessdata.html#m74">orbital_counter</a> = orbital_counter;
02842 
02843   
02844   <font class="comment">/* at this point we should have proper wavefunction information</font>
02845 <font class="comment">   * in our arrays */</font>
02846   data-&gt;<a class="code" href="structgamessdata.html#m73">got_wavefunction</a> = <a class="code" href="gamessplugin_8h.html#a7">TRUE</a>;
02847 
02848   
02849   <font class="comment">/* short message */</font> 
02850   printf(<font class="stringliteral">"gamessplugin&gt; Number of orbitals scanned: %d \n"</font>,\
02851              data-&gt;<a class="code" href="structgamessdata.html#m74">orbital_counter</a>);
02852 
02853 
02854   <font class="keywordflow">return</font> <a class="code" href="gamessplugin_8h.html#a7">TRUE</a>;
02855 }
02856 
02857 
02858 
02859 <font class="comment">/*************************************************************</font>
02860 <font class="comment"> *</font>
02861 <font class="comment"> * this subroutine scans all the orbitals to find the HOMO </font>
02862 <font class="comment"> *</font>
02863 <font class="comment"> *************************************************************/</font>
<a name="l02864"></a><a class="code" href="gamessplugin_8c.html#a27">02864</a> <font class="keywordtype">int</font> <a class="code" href="gamessplugin_8c.html#a27">find_homo</a>(<font class="keywordtype">void</font> *mydata) {
02865 
02866   <a class="code" href="structgamessdata.html">gamessdata</a> *data = (<a class="code" href="structgamessdata.html">gamessdata</a> *)mydata; 
02867   <font class="keywordtype">float</font> *orbital_energy;
02868   <font class="keywordtype">int</font> orbital_counter;
02869 
02870   <font class="comment">/* initialize the counter pointing to the HOMO */</font>
02871   <font class="keywordtype">unsigned</font> <font class="keywordtype">int</font> homo_counter = 0;
02872 
02873   <font class="comment">/* loop through the orbital energies and find the smallest</font>
02874 <font class="comment">   * negative value, i.e. HOMO. Actually, for pathological</font>
02875 <font class="comment">   * systems identifications of the HOMO in this way might</font>
02876 <font class="comment">   * be flawed, since higher energy orbitals could be occupied</font>
02877 <font class="comment">   * as well, but for now this should do */</font>
02878   orbital_energy = data-&gt;<a class="code" href="structgamessdata.html#m68">orbital_energy</a>;
02879   orbital_counter = data-&gt;<a class="code" href="structgamessdata.html#m74">orbital_counter</a>;
02880 
02881   <font class="keywordflow">while</font> ( *orbital_energy &lt; 0 )
02882   {
02883     orbital_energy++;
02884     homo_counter++;
02885   }
02886 
02887   <font class="comment">/* there is probably a lot that can go wrong here;</font>
02888 <font class="comment">   * let's at least check if the HOMO is the last orbital</font>
02889 <font class="comment">   * present in which case there is probably something</font>
02890 <font class="comment">   * fishy going on */</font>
02891   <font class="keywordflow">if</font> ( homo_counter == orbital_counter)
02892   {
02893     printf(<font class="stringliteral">"gamessplugin&gt; WARNING: HOMO is last orbital"</font>);
02894   }
02895 
02896   
02897   <font class="comment">/* store homo index */</font>
02898   data-&gt;<a class="code" href="structgamessdata.html#m71">homo_index</a> = homo_counter;
02899 
02900   
02901   <font class="comment">/* short message */</font>
02902   printf(<font class="stringliteral">"gamessplugin&gt; Identified orbital #%d (%f au) as HOMO \n"</font>,
02903         data-&gt;<a class="code" href="structgamessdata.html#m71">homo_index</a>, 
02904         *(data-&gt;<a class="code" href="structgamessdata.html#m68">orbital_energy</a>+(data-&gt;<a class="code" href="structgamessdata.html#m71">homo_index</a>)-1)); 
02905  
02906 
02907   <font class="keywordflow">return</font> <a class="code" href="gamessplugin_8h.html#a7">TRUE</a>;
02908 }
02909 
02910 
02911 
02912 <font class="comment">/**********************************************************</font>
02913 <font class="comment"> *</font>
02914 <font class="comment"> * this function generates the computational grid for</font>
02915 <font class="comment"> * the orbitals; as a proof of concept case we do the</font>
02916 <font class="comment"> * HOMO first </font>
02917 <font class="comment"> *</font>
02918 <font class="comment"> ***********************************************************/</font>
<a name="l02919"></a><a class="code" href="gamessplugin_8c.html#a28">02919</a> <font class="keywordtype">int</font> <a class="code" href="gamessplugin_8c.html#a28">orbital_grid_driver</a>(<font class="keywordtype">void</font> *mydata)
02920 {
02921   <a class="code" href="structgamessdata.html">gamessdata</a> *data = (<a class="code" href="structgamessdata.html">gamessdata</a> *)mydata; 
02922 
02923   <font class="comment">/* in order to set up the grid properly, we</font>
02924 <font class="comment">   * have to know the dimensions of the system.</font>
02925 <font class="comment">   * Hence let's determine it ! */</font>
02926   <font class="keywordflow">if</font> (<a class="code" href="gamessplugin_8c.html#a30">get_system_dimensions</a>(data) == <a class="code" href="gamessplugin_8h.html#a6">FALSE</a>) <font class="keywordflow">return</font> <a class="code" href="gamessplugin_8h.html#a6">FALSE</a>;
02927  
02928 
02929   <font class="comment">/* finally, we're ready to evaluate the value</font>
02930 <font class="comment">   * of the orbital at the computational grid</font>
02931 <font class="comment">   * points */</font>
02932   <font class="keywordflow">if</font> (<a class="code" href="gamessplugin_8c.html#a29">calculate_orbital</a>(data) == <a class="code" href="gamessplugin_8h.html#a6">FALSE</a> ) <font class="keywordflow">return</font> <a class="code" href="gamessplugin_8h.html#a6">FALSE</a>; 
02933 
02934 
02935   <font class="comment">/* at this point we should have proper volumetric metadata/</font>
02936 <font class="comment">     * data (otherwise it is the fault of generate_orbital_grid)</font>
02937 <font class="comment">     * and can hence allow VMD to parse the apropriate arrays</font>
02938 <font class="comment">     * in the metadata/data routines */</font>
02939   data-&gt;<a class="code" href="structgamessdata.html#m59">have_volumetric</a> = 1; 
02940 
02941 
02942   <font class="keywordflow">return</font> <a class="code" href="gamessplugin_8h.html#a7">TRUE</a>;
02943 }
02944 
02945 
02946 <font class="comment">/*********************************************************</font>
02947 <font class="comment"> *</font>
02948 <font class="comment"> * this function creates the computational grid given the</font>
02949 <font class="comment"> * system dimensions </font>
02950 <font class="comment"> *</font>
02951 <font class="comment"> **********************************************************/</font>
<a name="l02952"></a><a class="code" href="gamessplugin_8c.html#a29">02952</a> <font class="keywordtype">int</font> <a class="code" href="gamessplugin_8c.html#a29">calculate_orbital</a>(<font class="keywordtype">void</font> *mydata) 
02953 {
02954   <a class="code" href="structgamessdata.html">gamessdata</a> *data = (<a class="code" href="structgamessdata.html">gamessdata</a> *)mydata;
02955   <font class="keywordtype">float</font> *orbital_grid;
02956   <font class="keywordtype">float</font> *xyzdim;
02957   <a class="code" href="structmolfile__volumetric__t.html">molfile_volumetric_t</a> *vol_metadata;
02958   <font class="keywordtype">float</font> *wave_function;
02959   <font class="keywordtype">float</font> grid_x = 0.0, grid_y = 0.0, grid_z = 0.0;
02960   <font class="keywordtype">int</font> numx, numy, numz, numxy, maxpoints;
02961   <font class="keywordtype">unsigned</font> <font class="keywordtype">int</font> nx = 0, ny = 0, nz = 0, i = 0;
02962   <font class="keywordtype">float</font> *center;
02963   <font class="keywordtype">int</font> success[3] = { 0, 0, 0};
02964   <font class="keywordtype">float</font> grid_size = 1.0; 
02965   <font class="keywordtype">float</font> buffer_region[3] = {3.0, 3.0, 3.0};
02966   <font class="keywordtype">int</font> grid_bad[3] = { 1, 1, 1};
02967   <font class="keywordtype">float</font> grid_dim[3]; <font class="comment">/* gridsize in A */</font>
02968   <font class="keywordtype">int</font> shrink_grid_size = 0;
02969   <font class="keywordtype">int</font> voxel[3];
02970   <font class="keywordtype">int</font> tot_voxel;
02971 
02972   <font class="comment">/* request memory for volume metadata */</font>
02973   vol_metadata = (<a class="code" href="structmolfile__volumetric__t.html">molfile_volumetric_t</a> *)calloc(1, \
02974                 <font class="keyword">sizeof</font>(<a class="code" href="structmolfile__volumetric__t.html">molfile_volumetric_t</a>)); 
02975 
02976   <font class="comment">/* make sure the call was succesful */</font>
02977   <font class="keywordflow">if</font> (vol_metadata == NULL) 
02978   {
02979      <a class="code" href="gamessplugin_8c.html#a1">PRINTERR</a>;
02980      <font class="keywordflow">return</font> <a class="code" href="gamessplugin_8h.html#a6">FALSE</a>;
02981   }
02982 
02983   <font class="comment">/* store pointer to volumetric metadata */</font>
02984   data-&gt;<a class="code" href="structgamessdata.html#m60">vol</a> = vol_metadata;
02985 
02986 
02987   <font class="comment">/* retrieve the pointer for the temp arrays */</font>
02988   <font class="comment">/* temp_data = data-&gt;temporary; */</font>
02989 
02990 
02991   <font class="comment">/* retrieve array with # of primitives available</font>
02992 <font class="comment">   * for each indivual atom of the system */</font>
02993   <font class="comment">/* basis_counter = data-&gt;basis_counter; */</font>
02994 
02995 
02996   <font class="comment">/* retrieve the pointer for the grid dimensions */</font>
02997   xyzdim = data-&gt;<a class="code" href="structgamessdata.html#m55">system_dimensions</a>;
02998 
02999 
03000   <font class="comment">/* retrieve pointer for wavefunction */</font>
03001   wave_function = data-&gt;<a class="code" href="structgamessdata.html#m67">wave_function</a>;
03002 
03003 
03004   <font class="comment">/* move wavefunction pointer to HOMO */</font>
03005   wave_function += (data-&gt;<a class="code" href="structgamessdata.html#m72">num_gauss_basis_funcs</a>*
03006       (data-&gt;<a class="code" href="structgamessdata.html#m71">homo_index</a> - 1));
03007 
03008 
03009   <font class="comment">/* retrieve orbital symmetry of shel primitives */</font>
03010   <font class="comment">/* orbital_symmetry = data-&gt;orbital_symmetry; */</font>
03011 
03012 
03013   <font class="comment">/* retrieve pointer to system center */</font>
03014   center = data-&gt;<a class="code" href="structgamessdata.html#m56">system_center</a>;
03015 
03016 
03017   <font class="comment">/* now we scan the surface of the grid and see if there</font>
03018 <font class="comment">   * are any values &gt; 0.01; if not, we reduce the buffer</font>
03019 <font class="comment">   * region by 1A and try again */</font>
03020   printf(<font class="stringliteral">"gamessplugin&gt;\n"</font>);
03021   printf(<font class="stringliteral">"gamessplugin&gt; Optimizing size of orbital grid. \n"</font>);
03022  
03023 
03024   <font class="comment">/* determine an optimal grid dimension and grid spacing */</font>
03025   <font class="keywordflow">while</font> ( grid_bad[0] || grid_bad[1] || grid_bad[2] )
03026   {
03027     <font class="comment">/* examine the current grid and shrink it if possible */</font>
03028 
03029     <font class="keywordflow">for</font> ( i = 0 ; i &lt; 3 ; ++i)
03030     {
03031       grid_dim[i] = (xyzdim[i+3] - xyzdim[i]); 
03032 
03033       <font class="comment">/* pad with a buffer region subject to the constraint</font>
03034 <font class="comment">       * the grid_dim[i] has an integer number of voxels */</font>
03035         
03036       grid_dim[i] = grid_dim[i] - fmod(grid_dim[i],2*grid_size) 
03037                     + 2.0 * buffer_region[i]; 
03038 
03039       vol_metadata-&gt;<a class="code" href="structmolfile__volumetric__t.html#m1">origin</a>[i] = center[i] - grid_dim[i]/2.0; 
03040     }
03041 
03042     <font class="comment">/* make results available as volumetric metadata:</font>
03043 <font class="comment">     * the {xyz}axis point in the xyz direction with</font>
03044 <font class="comment">     * lengths determined by the size of the grid in</font>
03045 <font class="comment">     * each direction;</font>
03046 <font class="comment">     * the {xyz}size is given by the size of the grid</font>
03047 <font class="comment">     * plus a buffer region BUFFER_REGION</font>
03048 <font class="comment">     * in the respective direction divided by the</font>
03049 <font class="comment">     * GRIDSIZE (i.e. number of voxels) */</font>
03050       
03051     vol_metadata-&gt;<a class="code" href="structmolfile__volumetric__t.html#m2">xaxis</a>[0] = grid_dim[0];
03052     vol_metadata-&gt;<a class="code" href="structmolfile__volumetric__t.html#m3">yaxis</a>[1] = grid_dim[1];
03053     vol_metadata-&gt;<a class="code" href="structmolfile__volumetric__t.html#m4">zaxis</a>[2] = grid_dim[2];
03054     vol_metadata-&gt;<a class="code" href="structmolfile__volumetric__t.html#m5">xsize</a> = (int)(grid_dim[0] / grid_size)+1;
03055     vol_metadata-&gt;<a class="code" href="structmolfile__volumetric__t.html#m6">ysize</a> = (int)(grid_dim[1] / grid_size)+1;
03056     vol_metadata-&gt;<a class="code" href="structmolfile__volumetric__t.html#m7">zsize</a> = (int)(grid_dim[2] / grid_size)+1; 
03057 
03058     <font class="comment">/* don't have color information */</font>
03059     vol_metadata-&gt;<a class="code" href="structmolfile__volumetric__t.html#m8">has_color</a> = 0;
03060     
03061     <font class="comment">/* default name for data set */</font>
03062     sprintf(vol_metadata-&gt;<a class="code" href="structmolfile__volumetric__t.html#m0">dataname</a>,<font class="stringliteral">"wavefunction data"</font>); 
03063 
03064      
03065     <font class="comment">/* calculate the number of grid points in each dimension</font>
03066 <font class="comment">     * as well as the total number of points needed</font>
03067 <font class="comment">     * in order to dimension the orbital_grid</font>
03068 <font class="comment">     * array properly */</font>
03069     numx = vol_metadata-&gt;<a class="code" href="structmolfile__volumetric__t.html#m5">xsize</a>;
03070     numy = vol_metadata-&gt;<a class="code" href="structmolfile__volumetric__t.html#m6">ysize</a>;
03071     numz = vol_metadata-&gt;<a class="code" href="structmolfile__volumetric__t.html#m7">zsize</a>;
03072 
03073 
03074     <font class="comment">/* scan xy surfaces */</font>
03075     nz = 0;
03076 
03077     <font class="keywordflow">if</font> ( !success[0] )
03078     {
03079       <font class="keywordflow">for</font> ( nx = 0 ; nx &lt; numx ; ++nx)
03080       {
03081         <font class="keywordflow">if</font> ( !success[0] ) 
03082         {
03083           <font class="keywordflow">for</font> ( ny = 0 ; ny &lt; numy ; ++ny)
03084           {
03085             <font class="comment">/* calculate the xyz coordinate of the current</font>
03086 <font class="comment">             * grid point */</font>
03087             grid_x = vol_metadata-&gt;<a class="code" href="structmolfile__volumetric__t.html#m1">origin</a>[0] + nx * grid_size;
03088             grid_y = vol_metadata-&gt;<a class="code" href="structmolfile__volumetric__t.html#m1">origin</a>[1] + ny * grid_size;
03089             grid_z = vol_metadata-&gt;<a class="code" href="structmolfile__volumetric__t.html#m1">origin</a>[2] + nz * grid_size;
03090 
03091         
03092             <font class="comment">/* calculate the value of the wavefunction of the</font>
03093 <font class="comment">             * selected orbital at the current grid point */</font>
03094             <font class="keywordflow">if</font> ( fabs(<a class="code" href="gamessplugin_8c.html#a40">orbital_at_grid_xyz</a>(data, wave_function, 
03095                   grid_size, grid_x, grid_y, grid_z)) &gt; 0.01 )
03096             {
03097               success[0] = 1;
03098               <font class="keywordflow">break</font>;
03099             }
03100           } 
03101         }
03102       }
03103     } 
03104         
03105     <font class="comment">/* scan back side of xy plane */</font>
03106     nz = numz - 1;
03107 
03108     <font class="keywordflow">if</font> ( ! success[0] )
03109     {
03110       <font class="keywordflow">for</font> ( nx = 0 ; nx &lt; numx ; ++nx)
03111       {
03112         <font class="keywordflow">if</font> ( !success[0] ) 
03113         {
03114           <font class="keywordflow">for</font> ( ny = 0 ; ny &lt; numy ; ++ny)
03115           {
03116             <font class="comment">/* calculate the xyz coordinate of the current</font>
03117 <font class="comment">            * grid point */</font>
03118             grid_x = vol_metadata-&gt;<a class="code" href="structmolfile__volumetric__t.html#m1">origin</a>[0] + nx * grid_size;
03119             grid_y = vol_metadata-&gt;<a class="code" href="structmolfile__volumetric__t.html#m1">origin</a>[1] + ny * grid_size;
03120             grid_z = vol_metadata-&gt;<a class="code" href="structmolfile__volumetric__t.html#m1">origin</a>[2] + nz * grid_size;
03121           
03122         
03123             <font class="comment">/* calculate the value of the wavefunction of the</font>
03124 <font class="comment">             * selected orbital at the current grid point */</font>
03125             <font class="keywordflow">if</font> ( fabs(<a class="code" href="gamessplugin_8c.html#a40">orbital_at_grid_xyz</a>(data, wave_function, 
03126                   grid_size, grid_x, grid_y, grid_z)) &gt; 0.01 )
03127             {
03128               success[0] = 1;
03129               <font class="keywordflow">break</font>;
03130             }
03131           } 
03132         }
03133       }
03134     }
03135 
03136 
03137     <font class="comment">/* adjust buffer region in z direction */</font>
03138     <font class="keywordflow">if</font> ( success[0] )
03139     {
03140       grid_bad[2] = 0;
03141 
03142     }
03143     <font class="keywordflow">else</font>
03144     {
03145       buffer_region[2] -= 0.5;
03146     }
03147 
03148 
03149 
03150     <font class="comment">/* scan xz surfaces */</font>
03151     ny = 0;
03152 
03153     <font class="keywordflow">if</font> ( !success[1] )
03154     {
03155       <font class="keywordflow">for</font> ( nx = 0 ; nx &lt; numx ; ++nx)
03156       {
03157         <font class="keywordflow">if</font> ( !success[1] ) 
03158         {
03159           <font class="keywordflow">for</font> ( nz = 0 ; nz &lt; numz ; ++nz)
03160           {
03161             <font class="comment">/* calculate the xyz coordinate of the current</font>
03162 <font class="comment">            * grid point */</font>
03163             grid_x = vol_metadata-&gt;<a class="code" href="structmolfile__volumetric__t.html#m1">origin</a>[0] + nx * grid_size;
03164             grid_y = vol_metadata-&gt;<a class="code" href="structmolfile__volumetric__t.html#m1">origin</a>[1] + ny * grid_size;
03165             grid_z = vol_metadata-&gt;<a class="code" href="structmolfile__volumetric__t.html#m1">origin</a>[2] + nz * grid_size;
03166           
03167         
03168             <font class="comment">/* calculate the value of the wavefunction of the</font>
03169 <font class="comment">             * selected orbital at the current grid point */</font>
03170             <font class="keywordflow">if</font> ( fabs(<a class="code" href="gamessplugin_8c.html#a40">orbital_at_grid_xyz</a>(data, wave_function, 
03171                   grid_size, grid_x, grid_y, grid_z)) &gt; 0.01 )
03172             {
03173               success[1] = 1;
03174               <font class="keywordflow">break</font>;
03175             }
03176           } 
03177         }
03178       }
03179     }
03180 
03181 
03182     <font class="comment">/* scan back side of xz surface */</font>      
03183     ny = numy - 1; 
03184     
03185     <font class="keywordflow">if</font> ( !success[1] )
03186     {
03187       <font class="keywordflow">for</font> ( nx = 0 ; nx &lt; numx ; ++nx)
03188       {
03189         <font class="keywordflow">if</font> ( !success[1] ) 
03190         {
03191           <font class="keywordflow">for</font> ( nz = 0 ; nz &lt; numz ; ++nz)
03192           {
03193             <font class="comment">/* calculate the xyz coordinate of the current</font>
03194 <font class="comment">            * grid point */</font>
03195             grid_x = vol_metadata-&gt;<a class="code" href="structmolfile__volumetric__t.html#m1">origin</a>[0] + nx * grid_size;
03196             grid_y = vol_metadata-&gt;<a class="code" href="structmolfile__volumetric__t.html#m1">origin</a>[1] + ny * grid_size;
03197             grid_z = vol_metadata-&gt;<a class="code" href="structmolfile__volumetric__t.html#m1">origin</a>[2] + nz * grid_size;
03198           
03199         
03200             <font class="comment">/* calculate the value of the wavefunction of the</font>
03201 <font class="comment">             * selected orbital at the current grid point */</font>
03202             <font class="keywordflow">if</font> ( fabs(<a class="code" href="gamessplugin_8c.html#a40">orbital_at_grid_xyz</a>(data, wave_function, 
03203                   grid_size, grid_x, grid_y, grid_z)) &gt; 0.01 )
03204             {
03205               success[1] = 1;
03206               <font class="keywordflow">break</font>;
03207             }
03208           } 
03209         }
03210       }
03211     }
03212 
03213     <font class="comment">/* adjust buffer region in y direction */</font>
03214     <font class="keywordflow">if</font> ( success[1] )
03215     {
03216       grid_bad[1] = 0;
03217     }
03218     <font class="keywordflow">else</font>
03219     {
03220       buffer_region[1] -= 0.5;
03221     }
03222 
03223 
03224     <font class="comment">/* scan yz surfaces */</font>
03225     nx = 0;
03226 
03227     <font class="keywordflow">if</font> ( !success[2] )
03228     {
03229       <font class="keywordflow">for</font> ( ny = 0 ; ny &lt; numy ; ++ny)
03230       {
03231         <font class="keywordflow">if</font> ( !success[2] ) 
03232         {
03233           <font class="keywordflow">for</font> ( nz = 0 ; nz &lt; numz ; ++nz)
03234           {
03235             <font class="comment">/* calculate the xyz coordinate of the current</font>
03236 <font class="comment">            * grid point */</font>
03237             grid_x = vol_metadata-&gt;<a class="code" href="structmolfile__volumetric__t.html#m1">origin</a>[0] + nx * grid_size;
03238             grid_y = vol_metadata-&gt;<a class="code" href="structmolfile__volumetric__t.html#m1">origin</a>[1] + ny * grid_size;
03239             grid_z = vol_metadata-&gt;<a class="code" href="structmolfile__volumetric__t.html#m1">origin</a>[2] + nz * grid_size;
03240           
03241         
03242             <font class="comment">/* calculate the value of the wavefunction of the</font>
03243 <font class="comment">             * selected orbital at the current grid point */</font>
03244             <font class="keywordflow">if</font> ( fabs(<a class="code" href="gamessplugin_8c.html#a40">orbital_at_grid_xyz</a>(data, wave_function, 
03245                   grid_size, grid_x, grid_y, grid_z)) &gt; 0.01 )
03246             {
03247               success[2] = 1;
03248               <font class="keywordflow">break</font>;
03249             }
03250           } 
03251         }
03252       }
03253     }
03254 
03255 
03256     <font class="comment">/* scan back side of yz surface */</font>      
03257     nx = numx - 1; 
03258     
03259     <font class="keywordflow">if</font> ( !success[2] )
03260     {
03261       <font class="keywordflow">for</font> ( ny = 0 ; ny &lt; numy ; ++ny)
03262       {
03263         <font class="keywordflow">if</font> ( !success[2] ) 
03264         {
03265           <font class="keywordflow">for</font> ( nz = 0 ; nz &lt; numz ; ++nz)
03266           {
03267             <font class="comment">/* calculate the xyz coordinate of the current</font>
03268 <font class="comment">            * grid point */</font>
03269             grid_x = vol_metadata-&gt;<a class="code" href="structmolfile__volumetric__t.html#m1">origin</a>[0] + nx * grid_size;
03270             grid_y = vol_metadata-&gt;<a class="code" href="structmolfile__volumetric__t.html#m1">origin</a>[1] + ny * grid_size;
03271             grid_z = vol_metadata-&gt;<a class="code" href="structmolfile__volumetric__t.html#m1">origin</a>[2] + nz * grid_size;
03272           
03273         
03274             <font class="comment">/* calculate the value of the wavefunction of the</font>
03275 <font class="comment">             * selected orbital at the current grid point */</font>
03276             <font class="keywordflow">if</font> ( fabs(<a class="code" href="gamessplugin_8c.html#a40">orbital_at_grid_xyz</a>(data, wave_function, 
03277                   grid_size, grid_x, grid_y, grid_z)) &gt; 0.01 )
03278             {
03279               success[2] = 1;
03280               <font class="keywordflow">break</font>;
03281             }
03282           } 
03283         }
03284       }
03285     }
03286 
03287     <font class="comment">/* adjust buffer region in x direction */</font>
03288     <font class="keywordflow">if</font> ( success[2] )
03289     {
03290       grid_bad[0] = 0;
03291     }
03292     <font class="keywordflow">else</font>
03293     {
03294       buffer_region[0] -= 0.5;
03295     }
03296 
03297   }
03298 
03299   <font class="comment">/* at this point we have optimized the dimensions of</font>
03300 <font class="comment">   * the grid and we can now chose an optimal low value for</font>
03301 <font class="comment">   * the grid size depending such that we either have </font>
03302 <font class="comment">   * less than MAX_GRIDPOINTS or a value of 0.1 A */</font>
03303   shrink_grid_size = 1;
03304 
03305   <font class="keywordflow">while</font> ( shrink_grid_size ) 
03306   {
03307     <font class="keywordflow">for</font> ( i = 0 ; i &lt; 3 ; ++i)
03308     {
03309       grid_dim[i] = (xyzdim[i+3] - xyzdim[i]);
03310 
03311       voxel[i] = (int)((grid_dim[i] + 2.0 * buffer_region[i]) /
03312           grid_size);
03313     }
03314 
03315     tot_voxel = voxel[0] * voxel[1] * voxel[2];
03316 
03317 
03318     <font class="keywordflow">if</font> (tot_voxel &gt; <a class="code" href="gamessplugin_8h.html#a5">MAX_GRIDPOINTS</a>)
03319     {
03320       shrink_grid_size = 0;
03321 
03322       <font class="comment">/* we need to bump up the gridsize again</font>
03323 <font class="comment">       * since at this point we've already gone</font>
03324 <font class="comment">       * beyond MAX_GRIDPOINTS */</font>
03325       grid_size += 0.1;
03326     }
03327     <font class="keywordflow">else</font>
03328     {
03329       <font class="keywordflow">if</font> ( grid_size &gt; 0.1 )
03330       {
03331         grid_size -= 0.1;
03332       }
03333       <font class="keywordflow">else</font>
03334       {
03335         shrink_grid_size = 0;
03336       }
03337     }
03338   }
03339 
03340   <font class="keywordflow">for</font> ( i = 0 ; i &lt; 3 ; ++i)
03341   {
03342     <font class="comment">/* pad with a buffer region subject to the constraint</font>
03343 <font class="comment">     * the grid_dim[i] has an integer number of voxels */</font>
03344         
03345     grid_dim[i] = grid_dim[i] - fmod(grid_dim[i],2*grid_size) 
03346                     + 2.0 * buffer_region[i]; 
03347 
03348     vol_metadata-&gt;<a class="code" href="structmolfile__volumetric__t.html#m1">origin</a>[i] = center[i] - grid_dim[i]/2.0; 
03349   }
03350 
03351   <font class="comment">/* make results available as volumetric metadata:</font>
03352 <font class="comment">   * the {xyz}axis point in the xyz direction with</font>
03353 <font class="comment">   * lengths determined by the size of the grid in</font>
03354 <font class="comment">   * each direction;</font>
03355 <font class="comment">   * the {xyz}size is given by the size of the grid</font>
03356 <font class="comment">   * plus a buffer region BUFFER_REGION</font>
03357 <font class="comment">   * in the respective direction divided by the</font>
03358 <font class="comment">   * GRIDSIZE (i.e. number of voxels) */</font>
03359       
03360   vol_metadata-&gt;<a class="code" href="structmolfile__volumetric__t.html#m2">xaxis</a>[0] = grid_dim[0];
03361   vol_metadata-&gt;<a class="code" href="structmolfile__volumetric__t.html#m3">yaxis</a>[1] = grid_dim[1];
03362   vol_metadata-&gt;<a class="code" href="structmolfile__volumetric__t.html#m4">zaxis</a>[2] = grid_dim[2];
03363   vol_metadata-&gt;<a class="code" href="structmolfile__volumetric__t.html#m5">xsize</a> = (int)(grid_dim[0] / grid_size)+1;
03364   vol_metadata-&gt;<a class="code" href="structmolfile__volumetric__t.html#m6">ysize</a> = (int)(grid_dim[1] / grid_size)+1;
03365   vol_metadata-&gt;<a class="code" href="structmolfile__volumetric__t.html#m7">zsize</a> = (int)(grid_dim[2] / grid_size)+1; 
03366 
03367 
03368   <font class="comment">/* calculate the number of grid points in each dimension</font>
03369 <font class="comment">   * as well as the total number of points needed</font>
03370 <font class="comment">   * in order to dimension the orbital_grid</font>
03371 <font class="comment">   * array properly */</font>
03372   numx = vol_metadata-&gt;<a class="code" href="structmolfile__volumetric__t.html#m5">xsize</a>;
03373   numy = vol_metadata-&gt;<a class="code" href="structmolfile__volumetric__t.html#m6">ysize</a>;
03374   numz = vol_metadata-&gt;<a class="code" href="structmolfile__volumetric__t.html#m7">zsize</a>;
03375   maxpoints = numx * numy * numz;
03376 
03377 
03378   <font class="comment">/* useful shorthand notation needed for storage</font>
03379 <font class="comment">   * of orbital values in an array */</font>
03380   numxy = numx*numy;
03381 
03382 
03383   <font class="comment">/* store number of gridpoints */</font>
03384   data-&gt;<a class="code" href="structgamessdata.html#m58">num_gridpoints</a> = maxpoints;
03385 
03386 
03387   <font class="comment">/* now we can reserve the space for the grid array */</font>
03388   orbital_grid = (<font class="keywordtype">float</font> *)calloc(maxpoints,<font class="keyword">sizeof</font>(<font class="keywordtype">float</font>));
03389 
03390 
03391   <font class="comment">/* make sure we have enough memory */</font>
03392   <font class="keywordflow">if</font> (orbital_grid== NULL) 
03393   {
03394     <a class="code" href="gamessplugin_8c.html#a1">PRINTERR</a>; 
03395     <font class="keywordflow">return</font> <a class="code" href="gamessplugin_8h.html#a6">FALSE</a>;
03396   }
03397 
03398   <font class="comment">/* store the pointer to the grid */</font>
03399   data-&gt;<a class="code" href="structgamessdata.html#m57">orbital_grid</a> = orbital_grid;
03400 
03401 
03402   <font class="comment">/* let's give the user a warning, since the calculation</font>
03403 <font class="comment">   * could take a while, otherwise they might think the</font>
03404 <font class="comment">   * system is borked */</font>
03405   printf(<font class="stringliteral">"gamessplugin&gt; Calculating orbital grid. \n"</font>);
03406   printf(<font class="stringliteral">"              Please be patient ....... \n"</font>);
03407 
03408 
03409   <font class="comment">/* now we start one heck of a large loop going through the</font>
03410 <font class="comment">   * whole grid calculating the value of the orbital at each</font>
03411 <font class="comment">   * point */</font>
03412 
03413   <font class="comment">/* start looping and calculating ........... */</font>
03414   <font class="keywordflow">for</font> ( nx = 0 ; nx &lt; numx ; ++nx)
03415   {
03416     <font class="keywordflow">for</font> ( ny = 0 ; ny &lt; numy ; ++ny)
03417     {
03418       <font class="keywordflow">for</font> ( nz = 0 ; nz &lt; numz ; ++nz)
03419       {
03420 
03421         <font class="comment">/* calculate the xyz coordinate of the current</font>
03422 <font class="comment">         * grid point */</font>
03423         grid_x = vol_metadata-&gt;<a class="code" href="structmolfile__volumetric__t.html#m1">origin</a>[0] + nx * grid_size;
03424         grid_y = vol_metadata-&gt;<a class="code" href="structmolfile__volumetric__t.html#m1">origin</a>[1] + ny * grid_size;
03425         grid_z = vol_metadata-&gt;<a class="code" href="structmolfile__volumetric__t.html#m1">origin</a>[2] + nz * grid_size;
03426 
03427         
03428         <font class="comment">/* calculate the value of the wavefunction of the</font>
03429 <font class="comment">         * selected orbital at the current grid point */</font>
03430         *(orbital_grid + nx + ny*numx + nz*numxy) = 
03431             <a class="code" href="gamessplugin_8c.html#a40">orbital_at_grid_xyz</a>(data, wave_function, grid_size, 
03432                 grid_x, grid_y, grid_z);
03433       }
03434     } 
03435   }
03436 
03437   <font class="comment">/* everything went fine */</font> 
03438   <font class="keywordflow">return</font> <a class="code" href="gamessplugin_8h.html#a7">TRUE</a>;
03439 }
03440 
03441 
03442 
03443 <font class="comment">/*********************************************************</font>
03444 <font class="comment"> *</font>
03445 <font class="comment"> * this function provides the system dimensions </font>
03446 <font class="comment"> *</font>
03447 <font class="comment"> *********************************************************/</font>
<a name="l03448"></a><a class="code" href="gamessplugin_8c.html#a30">03448</a> <font class="keywordtype">int</font> <a class="code" href="gamessplugin_8c.html#a30">get_system_dimensions</a>(<font class="keywordtype">void</font> *mydata) {
03449 
03450   <a class="code" href="structgamessdata.html">gamessdata</a> *data = (<a class="code" href="structgamessdata.html">gamessdata</a> *)mydata; 
03451   <a class="code" href="structgamess__temp.html">gamess_temp</a> *temp_data;
03452   <font class="keywordtype">unsigned</font> <font class="keywordtype">int</font> i = 0;
03453 
03454   <font class="comment">/* array holding geometric center of system */</font>
03455   <font class="keywordtype">float</font> *center;   
03456  
03457   <font class="comment">/* array containing system dimensions in the form</font>
03458 <font class="comment">   * [x_min,y_min,....z_max] */</font>
03459   <font class="keywordtype">float</font> *xyzdim;   
03460   
03461   <font class="comment">/* request memory for center array */</font>
03462   center = (<font class="keywordtype">float</font> *)calloc(3,<font class="keyword">sizeof</font>(<font class="keywordtype">float</font>));
03463 
03464   <font class="comment">/* make sure memory could be allocated */</font>
03465   <font class="keywordflow">if</font> (center == NULL)
03466   {
03467     <a class="code" href="gamessplugin_8c.html#a1">PRINTERR</a>;
03468     <font class="keywordflow">return</font> <a class="code" href="gamessplugin_8h.html#a6">FALSE</a>;
03469   }
03470 
03471 
03472   <font class="comment">/* request memory for xyzdim array */</font>
03473   xyzdim = (<font class="keywordtype">float</font> *)calloc(6,<font class="keyword">sizeof</font>(<font class="keywordtype">float</font>));
03474 
03475   <font class="comment">/* make sure the call was succesful */</font>
03476   <font class="keywordflow">if</font> (xyzdim == NULL) 
03477   {
03478     <a class="code" href="gamessplugin_8c.html#a1">PRINTERR</a>;
03479     <font class="keywordflow">return</font> <a class="code" href="gamessplugin_8h.html#a6">FALSE</a>;
03480   }
03481 
03482 
03483   <font class="comment">/* retrieve pointer of gamess_temp struct */</font>
03484   temp_data = data-&gt;<a class="code" href="structgamessdata.html#m75">temporary</a>;
03485 
03486   <font class="comment">/* store pointer to volumetric metadata */</font>
03487   <font class="comment">/* data-&gt;vol = vol_meta_data; */</font>
03488 
03489   <font class="comment">/* store pointer to center of system */</font>
03490   data-&gt;<a class="code" href="structgamessdata.html#m56">system_center</a> = center;
03491 
03492 
03493   <font class="comment">/* determine the origin of the system; this is needed</font>
03494 <font class="comment">   * to properly initialize the volumetric metadata */</font>
03495   <font class="keywordflow">for</font> ( i = 0 ; i != data-&gt;<a class="code" href="structgamessdata.html#m1">numatoms</a> ; ++i) 
03496   {
03497     center[0] = ( center[0] + (temp_data+i)-&gt;x ); 
03498     center[1] = ( center[1] + (temp_data+i)-&gt;y ); 
03499     center[2] = ( center[2] + (temp_data+i)-&gt;z ); 
03500   }
03501 
03502   <font class="keywordflow">for</font> ( i = 0 ; i &lt; 3; ++i) 
03503   {
03504     center[i] = center[i] / data-&gt;<a class="code" href="structgamessdata.html#m1">numatoms</a>;
03505   }
03506 
03507 
03508   <font class="comment">/* determine the the minimum and maximum {xyz}</font>
03509 <font class="comment">   * coordintes of the system; having that we</font>
03510 <font class="comment">   * can dimension the orbital grid */</font>
03511 
03512   <font class="comment">/* set initial values of temp values to the coordinates</font>
03513 <font class="comment">   * of the first atom */</font>
03514   xyzdim[0] = xyzdim[3] = temp_data-&gt;<a class="code" href="structgamess__temp.html#m2">x</a>;
03515   xyzdim[1] = xyzdim[4] = temp_data-&gt;<a class="code" href="structgamess__temp.html#m3">y</a>;
03516   xyzdim[2] = xyzdim[5] = temp_data-&gt;<a class="code" href="structgamess__temp.html#m4">z</a>;  
03517 
03518   <font class="comment">/* now loop over the rest of the atoms to check if there's</font>
03519 <font class="comment">   * something larger/smaller for the maximum and minimum</font>
03520 <font class="comment">   * respectively */</font>
03521   <font class="keywordflow">for</font>( i = 0 ; i != data-&gt;<a class="code" href="structgamessdata.html#m1">numatoms</a>; ++i)
03522   {
03523     <font class="keywordflow">if</font> ( (temp_data+i)-&gt;x &lt; xyzdim[0] ) 
03524        xyzdim[0] = (temp_data+i)-&gt;x;
03525     <font class="keywordflow">if</font> ( (temp_data+i)-&gt;y &lt; xyzdim[1] )
03526        xyzdim[1] = (temp_data+i)-&gt;y;
03527     <font class="keywordflow">if</font> ( (temp_data+i)-&gt;z &lt; xyzdim[2] ) 
03528        xyzdim[2] = (temp_data+i)-&gt;z;
03529     <font class="keywordflow">if</font> ( (temp_data+i)-&gt;x &gt; xyzdim[3] ) 
03530        xyzdim[3] = (temp_data+i)-&gt;x;
03531     <font class="keywordflow">if</font> ( (temp_data+i)-&gt;y &gt; xyzdim[4] ) 
03532        xyzdim[4] = (temp_data+i)-&gt;y;
03533     <font class="keywordflow">if</font> ( (temp_data+i)-&gt;z &gt; xyzdim[5] )
03534        xyzdim[5] = (temp_data+i)-&gt;z;
03535   }
03536 
03537   <font class="comment">/* store final results in array */</font>
03538   data-&gt;<a class="code" href="structgamessdata.html#m55">system_dimensions</a> = xyzdim;
03539 
03540   <font class="comment">/* done :) */</font>
03541   <font class="keywordflow">return</font> <a class="code" href="gamessplugin_8h.html#a7">TRUE</a>;
03542 }
03543 
03544 
03545 <font class="comment">/**********************************************************</font>
03546 <font class="comment"> *</font>
03547 <font class="comment"> * this subroutine reads the number of procs and the amount</font>
03548 <font class="comment"> * of memory requested</font>
03549 <font class="comment"> *</font>
03550 <font class="comment"> **********************************************************/</font>
<a name="l03551"></a><a class="code" href="gamessplugin_8c.html#a31">03551</a> <font class="keyword">static</font> <font class="keywordtype">int</font> <a class="code" href="gamessplugin_8h.html#a28">get_proc_mem</a>(<font class="keywordtype">void</font> *mydata) {
03552 
03553   <a class="code" href="structgamessdata.html">gamessdata</a> *data = (<a class="code" href="structgamessdata.html">gamessdata</a> *)mydata;
03554   <font class="keywordtype">char</font> word[3][BUFSIZ];
03555   <font class="keywordtype">char</font> buffer[BUFSIZ];
03556   <font class="keywordtype">unsigned</font> <font class="keywordtype">int</font> nproc;
03557   <font class="keywordtype">unsigned</font> <font class="keywordtype">int</font> i;
03558 
03559 
03560   <font class="comment">/* initialize arrays */</font>
03561   buffer[0] = <font class="charliteral">'\0'</font>;
03562   <font class="keywordflow">for</font> ( i = 0; i &lt; 3; ++i) word[i][0] = <font class="charliteral">'\0'</font>;
03563 
03564 
03565   <font class="comment">/* first, we need to rewind the file */</font>
03566   rewind(data-&gt;<a class="code" href="structgamessdata.html#m0">file</a>);
03567 
03568   
03569   <font class="comment">/* scan for the number of processors */</font>
03570   <font class="keywordflow">do</font> 
03571   {
03572     <a class="code" href="gamessplugin_8c.html#a2">ERR_FALSE</a>( fgets(buffer,<font class="keyword">sizeof</font>(buffer),data-&gt;<a class="code" href="structgamessdata.html#m0">file</a>) )
03573     sscanf(buffer,<font class="stringliteral">"%s %d %s"</font>,&amp;word[0][0],&amp;nproc,&amp;word[1][0]);
03574 
03575   } <font class="keywordflow">while</font>( strcmp(&amp;word[0][0],<font class="stringliteral">"Initiating"</font>) || 
03576            strcmp(&amp;word[1][0],<font class="stringliteral">"compute"</font>) );
03577 
03578   
03579   <font class="comment">/* store the number of processors */</font>
03580   data-&gt;<a class="code" href="structgamessdata.html#m31">nproc</a> = nproc;
03581 
03582   
03583   <font class="comment">/* scan for the amount of memory requested */</font>
03584   <font class="keywordflow">do</font> 
03585   {
03586     <a class="code" href="gamessplugin_8c.html#a2">ERR_FALSE</a>( fgets(buffer,<font class="keyword">sizeof</font>(buffer),data-&gt;<a class="code" href="structgamessdata.html#m0">file</a>) )
03587     sscanf(buffer,<font class="stringliteral">"%s %s"</font>,&amp;word[0][0],&amp;word[1][0]);
03588 
03589   } <font class="keywordflow">while</font>( strcmp(&amp;word[0][0],<font class="stringliteral">"$SYSTEM"</font>) || 
03590            strcmp(&amp;word[1][0],<font class="stringliteral">"OPTIONS"</font>) );
03591 
03592    
03593   <font class="comment">/* skip next line */</font>
03594   <a class="code" href="xsfplugin_8C.html#a36">eatline</a>(data-&gt;<a class="code" href="structgamessdata.html#m0">file</a>);
03595 
03596 
03597   <font class="comment">/* next line contains the amount of memory requested */</font>
03598   <a class="code" href="gamessplugin_8c.html#a2">ERR_FALSE</a>( fgets(buffer,<font class="keyword">sizeof</font>(buffer),data-&gt;<a class="code" href="structgamessdata.html#m0">file</a>) )
03599   sscanf(buffer,<font class="stringliteral">"%s %s %s"</font>,&amp;word[0][0],&amp;word[1][0],&amp;word[2][0]);
03600 
03601   <font class="comment">/* store it */</font>
03602   strncpy(data-&gt;<a class="code" href="structgamessdata.html#m32">memory</a>,&amp;word[2][0],<font class="keyword">sizeof</font>(data-&gt;<a class="code" href="structgamessdata.html#m32">memory</a>));
03603 
03604 
03605   <font class="comment">/* short message */</font>
03606   printf(<font class="stringliteral">"gamessplugin&gt; GAMESS used %d compute processes \n"</font>,nproc);
03607   printf(<font class="stringliteral">"gamessplugin&gt; GAMESS used %s words of memory \n"</font>,
03608       data-&gt;<a class="code" href="structgamessdata.html#m32">memory</a>);
03609 
03610 
03611   <font class="comment">/* done here */</font>
03612   <font class="keywordflow">return</font> <a class="code" href="gamessplugin_8h.html#a7">TRUE</a>;
03613 }
03614 
03615 
03616 
03617 <font class="comment">/**********************************************************</font>
03618 <font class="comment"> *</font>
03619 <font class="comment"> * this subroutine checks if the provided files is</font>
03620 <font class="comment"> * actually a GAMESS file;</font>
03621 <font class="comment"> *</font>
03622 <font class="comment"> **********************************************************/</font>
<a name="l03623"></a><a class="code" href="gamessplugin_8c.html#a32">03623</a> <font class="keyword">static</font> <font class="keywordtype">int</font> <a class="code" href="gamessplugin_8h.html#a18">have_gamess</a>(<font class="keywordtype">void</font> *mydata) 
03624 {
03625   <a class="code" href="structgamessdata.html">gamessdata</a> *data = (<a class="code" href="structgamessdata.html">gamessdata</a> *)mydata;
03626   <font class="keywordtype">char</font> word[3][BUFSIZ];
03627   <font class="keywordtype">char</font> buffer[BUFSIZ];
03628   <font class="keywordtype">int</font> day, year;
03629   <font class="keywordtype">char</font> month[BUFSIZ], rev[BUFSIZ];
03630   <font class="keywordtype">unsigned</font> <font class="keywordtype">int</font> i = 0;
03631  
03632 
03633   <font class="comment">/* initialize arrays */</font>
03634   buffer[0] = <font class="charliteral">'\0'</font>;
03635   <font class="keywordflow">for</font> ( i = 0; i &lt; 3; ++i ) word[i][0] = <font class="charliteral">'\0'</font>;
03636 
03637 
03638   <font class="comment">/* check if the file is GAMESS format </font>
03639 <font class="comment">   * for now I just read line by line until </font>
03640 <font class="comment">   * the word GAMESS appears                */</font>
03641   <font class="keywordflow">do</font>
03642   {
03643     <a class="code" href="gamessplugin_8c.html#a2">ERR_FALSE</a>( fgets(buffer,<font class="keyword">sizeof</font>(buffer),data-&gt;<a class="code" href="structgamessdata.html#m0">file</a>) )
03644     sscanf(buffer,<font class="stringliteral">"%s %s %s"</font>,&amp;word[0][0],&amp;word[1][0],&amp;word[2][0]);
03645 
03646   } <font class="keywordflow">while</font>( strcmp(&amp;word[1][0],<font class="stringliteral">"GAMESS"</font>) || 
03647            strcmp(&amp;word[2][0],<font class="stringliteral">"VERSION"</font>) );
03648 
03649 
03650   <font class="comment">/* extract the version number if possible; otherwise</font>
03651 <font class="comment">   * return empty string */</font>
03652   <font class="keywordflow">if</font> ( strstr(buffer,<font class="stringliteral">"="</font>) != NULL ) 
03653   {
03654     strncpy(data-&gt;<a class="code" href="structgamessdata.html#m15">version_string</a>,strstr(buffer,<font class="stringliteral">"="</font>)+2,16); 
03655   }
03656 
03657   
03658   <font class="comment">/* determine if we're dealing with pre-"27 JUN 2005"</font>
03659 <font class="comment">   * version */</font>
03660   sscanf(data-&gt;<a class="code" href="structgamessdata.html#m15">version_string</a>,<font class="stringliteral">"%d %s %d %s"</font>,&amp;day, month, &amp;year, rev);
03661   
03662   <font class="keywordflow">if</font> ( ( year &gt;= 2006 ) ||
03663        ( year == 2005 &amp;&amp; !strcmp(month,<font class="stringliteral">"JUN"</font>) ) ||
03664        ( year == 2005 &amp;&amp; !strcmp(month,<font class="stringliteral">"NOV"</font>) ) ||
03665        ( year == 2005 &amp;&amp; !strcmp(month,<font class="stringliteral">"DEC"</font>) ) )
03666   {
03667     data-&gt;<a class="code" href="structgamessdata.html#m16">version</a> = 2;
03668   }
03669   <font class="keywordflow">else</font>
03670   { 
03671     data-&gt;<a class="code" href="structgamessdata.html#m16">version</a> = 1;
03672   }
03673 
03674 
03675   <font class="comment">/* short messsage to stdout */</font>
03676   printf(<font class="stringliteral">"gamessplugin&gt; Detected GAMESS format :)\n"</font>);
03677   printf(<font class="stringliteral">"gamessplugin&gt; GAMESS version = %s \n"</font>, 
03678       data-&gt;<a class="code" href="structgamessdata.html#m15">version_string</a>);
03679 
03680   <font class="keywordflow">return</font> <a class="code" href="gamessplugin_8h.html#a7">TRUE</a>;
03681 }
03682 
03683 
03684 
03685 <font class="comment">/**********************************************************</font>
03686 <font class="comment"> *</font>
03687 <font class="comment"> * this subroutine extracts the GBASIS</font>
03688 <font class="comment"> *</font>
03689 <font class="comment"> **********************************************************/</font>
<a name="l03690"></a><a class="code" href="gamessplugin_8c.html#a33">03690</a> <font class="keyword">static</font> <font class="keywordtype">int</font> <a class="code" href="gamessplugin_8h.html#a19">get_gbasis</a>(<font class="keywordtype">void</font> *mydata) {
03691 
03692   <a class="code" href="structgamessdata.html">gamessdata</a> *data = (<a class="code" href="structgamessdata.html">gamessdata</a> *)mydata;
03693   <font class="keywordtype">char</font> word[4][BUFSIZ];
03694   <font class="keywordtype">char</font> buffer[BUFSIZ];
03695   <font class="keywordtype">char</font> diffuse[BUFSIZ];
03696   <font class="keywordtype">char</font> polarization[BUFSIZ];
03697   <font class="keywordtype">unsigned</font> <font class="keywordtype">int</font> i = 0;
03698 
03699 
03700   <font class="comment">/* initialize arrays */</font>
03701   buffer[0] = <font class="charliteral">'\0'</font>;
03702   diffuse[0] = <font class="charliteral">'\0'</font>;
03703   polarization[0] = <font class="charliteral">'\0'</font>;
03704   <font class="keywordflow">for</font> ( i = 0; i &lt; 4; ++i) word[i][0] = <font class="charliteral">'\0'</font>;
03705 
03706 
03707   <font class="comment">/* to be safe let's rewind the file */</font>
03708   rewind(data-&gt;<a class="code" href="structgamessdata.html#m0">file</a>);
03709 
03710 
03711   <font class="comment">/* start scanning */</font>
03712   <font class="keywordflow">do</font> 
03713   {
03714     <a class="code" href="gamessplugin_8c.html#a2">ERR_FALSE</a>( fgets(buffer,<font class="keyword">sizeof</font>(buffer),data-&gt;<a class="code" href="structgamessdata.html#m0">file</a>) )
03715     sscanf(buffer,<font class="stringliteral">"%s %s"</font>,&amp;word[0][0],&amp;word[1][0]);
03716 
03717   } <font class="keywordflow">while</font>((strcmp(&amp;word[0][0],<font class="stringliteral">"BASIS"</font>)) || 
03718           (strcmp(&amp;word[1][0],<font class="stringliteral">"OPTIONS"</font>)));
03719 
03720 
03721   <font class="comment">/* skip next line */</font>
03722   <a class="code" href="xsfplugin_8C.html#a36">eatline</a>(data-&gt;<a class="code" href="structgamessdata.html#m0">file</a>);
03723 
03724 
03725   <font class="comment">/* the first string in the current line contains the</font>
03726 <font class="comment">   * GBASIS used; copy it over into the gbasis variable</font>
03727 <font class="comment">   * of gamessdata */</font>
03728   <a class="code" href="gamessplugin_8c.html#a2">ERR_FALSE</a>( fgets(buffer,<font class="keyword">sizeof</font>(buffer),data-&gt;<a class="code" href="structgamessdata.html#m0">file</a>) )
03729   sscanf(buffer,<font class="stringliteral">"%s %s %s"</font>,&amp;word[0][0],&amp;word[1][0],&amp;word[2][0]);
03730  
03731   strncpy(data-&gt;<a class="code" href="structgamessdata.html#m4">gbasis</a>,(&amp;word[0][0])+7,<font class="keyword">sizeof</font>(data-&gt;<a class="code" href="structgamessdata.html#m4">gbasis</a>));
03732 
03733   printf(<font class="stringliteral">"gamessplugin&gt; Run was performed with GBASIS = %s \n"</font>,
03734           data-&gt;<a class="code" href="structgamessdata.html#m4">gbasis</a>);
03735 
03736 
03737   <font class="comment">/* in case we're using a pople style basis set, i.e. </font>
03738 <font class="comment">   * GBASIS=N311,N31,N21 or STO we also scan for the number </font>
03739 <font class="comment">   * of gaussians, as well as p,d,f and diffuse functions</font>
03740 <font class="comment">   * and use this info to assemble a "basis set string" */</font>
03741   <font class="keywordflow">if</font> ( !strncmp(data-&gt;<a class="code" href="structgamessdata.html#m4">gbasis</a>,<font class="stringliteral">"N311"</font>,<font class="keyword">sizeof</font>(data-&gt;<a class="code" href="structgamessdata.html#m4">gbasis</a>)) ||
03742        !strncmp(data-&gt;<a class="code" href="structgamessdata.html#m4">gbasis</a>,<font class="stringliteral">"N31"</font>,<font class="keyword">sizeof</font>(data-&gt;<a class="code" href="structgamessdata.html#m4">gbasis</a>)) ||
03743        !strncmp(data-&gt;<a class="code" href="structgamessdata.html#m4">gbasis</a>,<font class="stringliteral">"N21"</font>,<font class="keyword">sizeof</font>(data-&gt;<a class="code" href="structgamessdata.html#m4">gbasis</a>)) ||
03744        !strncmp(data-&gt;<a class="code" href="structgamessdata.html#m4">gbasis</a>,<font class="stringliteral">"STO"</font>,<font class="keyword">sizeof</font>(data-&gt;<a class="code" href="structgamessdata.html#m4">gbasis</a>)) ) 
03745   {
03746     <font class="comment">/* word[2] read previously should still contain the</font>
03747 <font class="comment">     * number of gaussians used */</font>
03748     data-&gt;<a class="code" href="structgamessdata.html#m6">ngauss</a> = atoi(&amp;word[2][0]);
03749 
03750 
03751     <font class="comment">/* the next line gives us the d,f and diffuse sp</font>
03752 <font class="comment">     * functions */</font>
03753     <a class="code" href="gamessplugin_8c.html#a2">ERR_FALSE</a>( fgets(buffer,<font class="keyword">sizeof</font>(buffer),data-&gt;<a class="code" href="structgamessdata.html#m0">file</a>) )
03754     sscanf(buffer,<font class="stringliteral">"%s %d %s %d %s %s"</font>,&amp;word[0][0],&amp;data-&gt;<a class="code" href="structgamessdata.html#m8">ndfunc</a>,
03755         &amp;word[1][0],&amp;data-&gt;<a class="code" href="structgamessdata.html#m9">nffunc</a>,&amp;word[2][0],&amp;word[3][0]);
03756 
03757     <font class="comment">/* convert GAMESS' .TRUE./.FALSE. for DIFFSP into 1/0 */</font>
03758     <font class="keywordflow">if</font> ( !strncmp(&amp;word[3][0],<font class="stringliteral">"T"</font>,<font class="keyword">sizeof</font>(&amp;word[3][0])) ) 
03759         data-&gt;<a class="code" href="structgamessdata.html#m11">diffsp</a> = <a class="code" href="gamessplugin_8h.html#a7">TRUE</a>;
03760 
03761 
03762     <font class="comment">/* the next line gives us the p and diffuse s</font>
03763 <font class="comment">     * functions */</font>
03764     <a class="code" href="gamessplugin_8c.html#a2">ERR_FALSE</a>( fgets(buffer,<font class="keyword">sizeof</font>(buffer),data-&gt;<a class="code" href="structgamessdata.html#m0">file</a>) )
03765     sscanf(buffer,<font class="stringliteral">"%s %d %s %s"</font>,&amp;word[0][0],&amp;data-&gt;<a class="code" href="structgamessdata.html#m7">npfunc</a>,
03766         &amp;word[1][0],&amp;word[2][0]);
03767 
03768     <font class="comment">/* convert GAMESS' .TRUE./.FALSE. for DIFFSP into 1/0 */</font>
03769     <font class="keywordflow">if</font> ( !strncmp(&amp;word[2][0],<font class="stringliteral">"T"</font>,<font class="keyword">sizeof</font>(&amp;word[3][0])) ) 
03770         data-&gt;<a class="code" href="structgamessdata.html#m10">diffs</a> = <a class="code" href="gamessplugin_8h.html#a7">TRUE</a>;
03771 
03772 
03773     <font class="comment">/* now we need some logic to assemble this info into</font>
03774 <font class="comment">     * some nice looking string a la "6-31G*" */</font>
03775 
03776     <font class="comment">/* create the diffuse function string */</font>
03777     <font class="keywordflow">if</font> ( data-&gt;<a class="code" href="structgamessdata.html#m10">diffs</a> &amp;&amp; data-&gt;<a class="code" href="structgamessdata.html#m11">diffsp</a> )
03778     {
03779         strncpy(diffuse,<font class="stringliteral">"++"</font>,<font class="keyword">sizeof</font>(diffuse));
03780     }
03781     <font class="keywordflow">else</font> <font class="keywordflow">if</font> ( data-&gt;<a class="code" href="structgamessdata.html#m11">diffsp</a> ) 
03782     {
03783         strncpy(diffuse,<font class="stringliteral">"+"</font>,<font class="keyword">sizeof</font>(diffuse));
03784     }
03785     <font class="keywordflow">else</font> 
03786     {
03787         strncpy(diffuse,<font class="stringliteral">""</font>,<font class="keyword">sizeof</font>(diffuse));
03788     }
03789 
03790 
03791     <font class="comment">/* create the polarization function string */</font>
03792     <font class="keywordflow">if</font> ( ( data-&gt;<a class="code" href="structgamessdata.html#m7">npfunc</a> &gt; 0 ) &amp;&amp; ( data-&gt;<a class="code" href="structgamessdata.html#m8">ndfunc</a> &gt; 0) &amp;&amp;
03793          ( data-&gt;<a class="code" href="structgamessdata.html#m9">nffunc</a> &gt; 0 )) 
03794     {
03795 <font class="preprocessor">#if 1</font>
03796 <font class="preprocessor"></font>        <font class="comment">/* Windows doesn't provide snprintf in MSVC 6 */</font>
03797         sprintf(polarization,
03798             <font class="stringliteral">"(%dp,%dd,%df)"</font>, data-&gt;<a class="code" href="structgamessdata.html#m7">npfunc</a>, data-&gt;<a class="code" href="structgamessdata.html#m8">ndfunc</a>,
03799             data-&gt;<a class="code" href="structgamessdata.html#m9">nffunc</a>);
03800 <font class="preprocessor">#else</font>
03801 <font class="preprocessor"></font>        snprintf(polarization,<font class="keyword">sizeof</font>(polarization),
03802             <font class="stringliteral">"(%dp,%dd,%df)"</font>, data-&gt;<a class="code" href="structgamessdata.html#m7">npfunc</a>, data-&gt;<a class="code" href="structgamessdata.html#m8">ndfunc</a>,
03803             data-&gt;<a class="code" href="structgamessdata.html#m9">nffunc</a>);
03804 <font class="preprocessor">#endif</font>
03805 <font class="preprocessor"></font>    }
03806     <font class="keywordflow">else</font> <font class="keywordflow">if</font> ( ( data-&gt;<a class="code" href="structgamessdata.html#m7">npfunc</a> &gt; 0 ) &amp;&amp; ( data-&gt;<a class="code" href="structgamessdata.html#m8">ndfunc</a> &gt; 0) ) 
03807     {
03808 <font class="preprocessor">#if 1</font>
03809 <font class="preprocessor"></font>        <font class="comment">/* Windows doesn't provide snprintf in MSVC 6 */</font>
03810         sprintf(polarization,
03811             <font class="stringliteral">"(%dp,%dd)"</font>, data-&gt;<a class="code" href="structgamessdata.html#m7">npfunc</a>, data-&gt;<a class="code" href="structgamessdata.html#m8">ndfunc</a>);
03812 <font class="preprocessor">#else</font>
03813 <font class="preprocessor"></font>        snprintf(polarization,<font class="keyword">sizeof</font>(polarization),
03814             <font class="stringliteral">"(%dp,%dd)"</font>, data-&gt;<a class="code" href="structgamessdata.html#m7">npfunc</a>, data-&gt;<a class="code" href="structgamessdata.html#m8">ndfunc</a>);
03815 <font class="preprocessor">#endif</font>
03816 <font class="preprocessor"></font>    }
03817     <font class="keywordflow">else</font> <font class="keywordflow">if</font> ( ( data-&gt;<a class="code" href="structgamessdata.html#m7">npfunc</a> &gt; 0 ) )  
03818     {
03819 <font class="preprocessor">#if 1</font>
03820 <font class="preprocessor"></font>        <font class="comment">/* Windows doesn't provide snprintf in MSVC 6 */</font>
03821         sprintf(polarization,
03822             <font class="stringliteral">"(%dp)"</font>, data-&gt;<a class="code" href="structgamessdata.html#m7">npfunc</a>);
03823 <font class="preprocessor">#else</font>
03824 <font class="preprocessor"></font>        snprintf(polarization,<font class="keyword">sizeof</font>(polarization),
03825             <font class="stringliteral">"(%dp)"</font>, data-&gt;<a class="code" href="structgamessdata.html#m7">npfunc</a>);
03826 <font class="preprocessor">#endif</font>
03827 <font class="preprocessor"></font>    }
03828     <font class="keywordflow">else</font> <font class="keywordflow">if</font> ( ( data-&gt;<a class="code" href="structgamessdata.html#m8">ndfunc</a> &gt; 0) ) 
03829     {
03830 <font class="preprocessor">#if 1</font>
03831 <font class="preprocessor"></font>        <font class="comment">/* Windows doesn't provide snprintf in MSVC 6 */</font>
03832         sprintf(polarization,
03833             <font class="stringliteral">"(%dd)"</font>, data-&gt;<a class="code" href="structgamessdata.html#m8">ndfunc</a>);
03834 <font class="preprocessor">#else</font>
03835 <font class="preprocessor"></font>        snprintf(polarization,<font class="keyword">sizeof</font>(polarization),
03836             <font class="stringliteral">"(%dd)"</font>, data-&gt;<a class="code" href="structgamessdata.html#m8">ndfunc</a>);
03837 <font class="preprocessor">#endif</font>
03838 <font class="preprocessor"></font>    } 
03839     <font class="keywordflow">else</font> 
03840     {
03841         strncpy(polarization,<font class="stringliteral">""</font>,<font class="keyword">sizeof</font>(polarization));
03842     } 
03843    
03844 
03845     <font class="comment">/* assemble the bits */</font> 
03846     <font class="keywordflow">if</font> ( !strcmp(data-&gt;<a class="code" href="structgamessdata.html#m4">gbasis</a>,<font class="stringliteral">"STO"</font>) ) 
03847     {
03848 <font class="preprocessor">#if 1</font>
03849 <font class="preprocessor"></font>      <font class="comment">/* Windows doesn't provide snprintf in MSVC 6 */</font>
03850       sprintf(data-&gt;<a class="code" href="structgamessdata.html#m5">basis_string</a>,
03851           <font class="stringliteral">"STO-%dG%s%s"</font>, data-&gt;<a class="code" href="structgamessdata.html#m6">ngauss</a>, diffuse, polarization);
03852 <font class="preprocessor">#else</font>
03853 <font class="preprocessor"></font>      snprintf(data-&gt;<a class="code" href="structgamessdata.html#m5">basis_string</a>,<font class="keyword">sizeof</font>(data-&gt;<a class="code" href="structgamessdata.html#m5">basis_string</a>),
03854           <font class="stringliteral">"STO-%dG%s%s"</font>, data-&gt;<a class="code" href="structgamessdata.html#m6">ngauss</a>, diffuse, polarization);
03855 <font class="preprocessor">#endif</font>
03856 <font class="preprocessor"></font>     }
03857      <font class="keywordflow">else</font> 
03858      {
03859 <font class="preprocessor">#if 1</font>
03860 <font class="preprocessor"></font>      <font class="comment">/* Windows doesn't provide snprintf in MSVC 6 */</font>
03861       sprintf(data-&gt;<a class="code" href="structgamessdata.html#m5">basis_string</a>,
03862           <font class="stringliteral">"%d-%s%sG%s"</font>, data-&gt;<a class="code" href="structgamessdata.html#m6">ngauss</a>, (data-&gt;<a class="code" href="structgamessdata.html#m4">gbasis</a>+1), diffuse, 
03863           polarization);
03864 <font class="preprocessor">#else</font>
03865 <font class="preprocessor"></font>      snprintf(data-&gt;<a class="code" href="structgamessdata.html#m5">basis_string</a>,<font class="keyword">sizeof</font>(data-&gt;<a class="code" href="structgamessdata.html#m5">basis_string</a>),
03866           <font class="stringliteral">"%d-%s%sG%s"</font>, data-&gt;<a class="code" href="structgamessdata.html#m6">ngauss</a>, (data-&gt;<a class="code" href="structgamessdata.html#m4">gbasis</a>+1), diffuse, 
03867           polarization);
03868 <font class="preprocessor">#endif</font>
03869 <font class="preprocessor"></font>     }      
03870   }
03871 
03872   <font class="comment">/* for non pople style basis sets we just use the GBASIS</font>
03873 <font class="comment">   * for the basis string;</font>
03874 <font class="comment">   * TODO: make the basis_string more comprehensive for non</font>
03875 <font class="comment">   *       pople-style basis sets */</font>
03876   <font class="keywordflow">else</font> 
03877   {
03878     strncpy(data-&gt;<a class="code" href="structgamessdata.html#m5">basis_string</a>,data-&gt;<a class="code" href="structgamessdata.html#m4">gbasis</a>,
03879         <font class="keyword">sizeof</font>(data-&gt;<a class="code" href="structgamessdata.html#m5">basis_string</a>));
03880   }
03881 
03882 
03883   <font class="comment">/* short message */</font>
03884   printf(<font class="stringliteral">"gamessplugin&gt; Run was performed with BASIS = %s \n"</font>,
03885       data-&gt;<a class="code" href="structgamessdata.html#m5">basis_string</a>);
03886 
03887 
03888   <font class="keywordflow">return</font> <a class="code" href="gamessplugin_8h.html#a7">TRUE</a>;
03889 }
03890 
03891 
03892 
03893 <font class="comment">/**********************************************************</font>
03894 <font class="comment"> *</font>
03895 <font class="comment"> * this subroutine extracts run title </font>
03896 <font class="comment"> *</font>
03897 <font class="comment"> **********************************************************/</font>
<a name="l03898"></a><a class="code" href="gamessplugin_8c.html#a34">03898</a> <font class="keyword">static</font> <font class="keywordtype">int</font> <a class="code" href="gamessplugin_8h.html#a25">get_runtitle</a>(<font class="keywordtype">void</font> *mydata) 
03899 {
03900   <a class="code" href="structgamessdata.html">gamessdata</a> *data = (<a class="code" href="structgamessdata.html">gamessdata</a> *)mydata;
03901   <font class="keywordtype">char</font> word[2][BUFSIZ];
03902   <font class="keywordtype">char</font> buffer[BUFSIZ];
03903 
03904 
03905   <font class="comment">/* initialize arrays */</font>
03906   word[0][0] = <font class="charliteral">'\0'</font>;
03907   word[1][0] = <font class="charliteral">'\0'</font>;
03908   buffer[0] = <font class="charliteral">'\0'</font>;
03909 
03910   
03911   <font class="comment">/* look for RUN TITLE section */</font>
03912   <font class="keywordflow">do</font> 
03913   {
03914     <a class="code" href="gamessplugin_8c.html#a2">ERR_FALSE</a>( fgets(buffer,<font class="keyword">sizeof</font>(buffer),data-&gt;<a class="code" href="structgamessdata.html#m0">file</a>))
03915     sscanf(buffer,<font class="stringliteral">"%s %s"</font>,&amp;word[0][0],&amp;word[1][0]);
03916 
03917   } <font class="keywordflow">while</font>( (strcmp(&amp;word[0][0],<font class="stringliteral">"RUN"</font>)) || 
03918            (strcmp(&amp;word[1][0],<font class="stringliteral">"TITLE"</font>)));
03919 
03920 
03921   <font class="comment">/* the second to next line has what we want */</font>
03922   <a class="code" href="xsfplugin_8C.html#a36">eatline</a>(data-&gt;<a class="code" href="structgamessdata.html#m0">file</a>);
03923   <a class="code" href="gamessplugin_8c.html#a2">ERR_FALSE</a>( fgets(buffer,<font class="keyword">sizeof</font>(buffer),data-&gt;<a class="code" href="structgamessdata.html#m0">file</a>))
03924   strncpy(data-&gt;<a class="code" href="structgamessdata.html#m12">runtitle</a>,<a class="code" href="gamessplugin_8c.html#a39">chop_string_nl</a>(buffer),<font class="keyword">sizeof</font>(data-&gt;<a class="code" href="structgamessdata.html#m12">runtitle</a>));
03925 
03926   <font class="keywordflow">return</font> <a class="code" href="gamessplugin_8h.html#a7">TRUE</a>;
03927 } 
03928 
03929 
03930 
03931 <font class="comment">/**********************************************************</font>
03932 <font class="comment"> *</font>
03933 <font class="comment"> * this subroutine checks the is we support wavefunction</font>
03934 <font class="comment"> * and orbital stuff for the current gbasis</font>
03935 <font class="comment"> *</font>
03936 <font class="comment"> **********************************************************/</font>
<a name="l03937"></a><a class="code" href="gamessplugin_8c.html#a35">03937</a> <font class="keyword">static</font> <font class="keywordtype">int</font> <a class="code" href="gamessplugin_8h.html#a34">have_supported_gbasis</a>(<font class="keywordtype">void</font> *mydata) {
03938 
03939   <a class="code" href="structgamessdata.html">gamessdata</a> *data = (<a class="code" href="structgamessdata.html">gamessdata</a> *)mydata;
03940 
03941   <font class="comment">/* check for supported gbasis, otherwise don't even attempt</font>
03942 <font class="comment">   * to parse the orbital data/wavefunction */</font>
03943   <font class="keywordflow">if</font> ( !strcmp(data-&gt;<a class="code" href="structgamessdata.html#m4">gbasis</a>,<font class="stringliteral">"MINI"</font>) ||
03944        !strcmp(data-&gt;<a class="code" href="structgamessdata.html#m4">gbasis</a>,<font class="stringliteral">"MIDI"</font>) ||
03945        !strcmp(data-&gt;<a class="code" href="structgamessdata.html#m4">gbasis</a>,<font class="stringliteral">"STO"</font>) ||
03946        !strcmp(data-&gt;<a class="code" href="structgamessdata.html#m4">gbasis</a>,<font class="stringliteral">"N21"</font>) ||
03947        !strcmp(data-&gt;<a class="code" href="structgamessdata.html#m4">gbasis</a>,<font class="stringliteral">"N31"</font>) ||
03948        !strcmp(data-&gt;<a class="code" href="structgamessdata.html#m4">gbasis</a>,<font class="stringliteral">"N311"</font>) ||
03949        !strcmp(data-&gt;<a class="code" href="structgamessdata.html#m4">gbasis</a>,<font class="stringliteral">"DZV"</font>) ||
03950        !strcmp(data-&gt;<a class="code" href="structgamessdata.html#m4">gbasis</a>,<font class="stringliteral">"DH"</font>) ||
03951        !strcmp(data-&gt;<a class="code" href="structgamessdata.html#m4">gbasis</a>,<font class="stringliteral">"TZV"</font>) ||
03952        !strcmp(data-&gt;<a class="code" href="structgamessdata.html#m4">gbasis</a>,<font class="stringliteral">"MC"</font>) ) <font class="keywordflow">return</font> <a class="code" href="gamessplugin_8h.html#a7">TRUE</a>;
03953        
03954 
03955   <font class="comment">/* I guess we dont' support it then */</font>
03956   <font class="keywordflow">return</font> <a class="code" href="gamessplugin_8h.html#a6">FALSE</a>;
03957 }
03958 
03959 
03960 
03961 <font class="comment">/**********************************************************</font>
03962 <font class="comment"> *</font>
03963 <font class="comment"> * this subroutine checks the RUNTYP</font>
03964 <font class="comment"> *</font>
03965 <font class="comment"> **********************************************************/</font>
<a name="l03966"></a><a class="code" href="gamessplugin_8c.html#a36">03966</a> <font class="keyword">static</font> <font class="keywordtype">int</font> <a class="code" href="gamessplugin_8h.html#a20">check_contrl</a>(<font class="keywordtype">void</font> *mydata) {
03967 
03968   <a class="code" href="structgamessdata.html">gamessdata</a> *data = (<a class="code" href="structgamessdata.html">gamessdata</a> *)mydata;
03969   <font class="keywordtype">char</font> word[2][BUFSIZ];
03970   <font class="keywordtype">char</font> buffer[BUFSIZ];
03971 
03972 
03973   <font class="comment">/* initialize buffer */</font>
03974   word[0][0] = <font class="charliteral">'\0'</font>;
03975   word[1][0] = <font class="charliteral">'\0'</font>;
03976   buffer[0] = <font class="charliteral">'\0'</font>;
03977 
03978 
03979   <font class="comment">/* start scanning; currently we support</font>
03980 <font class="comment">   * RUNTYP = ENERGY, OPTIMIZE, SADPOINT, HESSIAN */</font>
03981   <font class="keywordflow">do</font> 
03982   {
03983     <a class="code" href="gamessplugin_8c.html#a2">ERR_FALSE</a>( fgets(buffer,<font class="keyword">sizeof</font>(buffer),data-&gt;<a class="code" href="structgamessdata.html#m0">file</a>) )
03984     sscanf(buffer,<font class="stringliteral">"%s %s"</font>,&amp;word[0][0],&amp;word[1][0]);
03985 
03986   } <font class="keywordflow">while</font>( strcmp(&amp;word[0][0],<font class="stringliteral">"\044CONTRL"</font>) || 
03987            strcmp(&amp;word[1][0],<font class="stringliteral">"OPTIONS"</font>) );
03988 
03989            
03990   <font class="comment">/* skip next line */</font>
03991   <a class="code" href="xsfplugin_8C.html#a36">eatline</a>(data-&gt;<a class="code" href="structgamessdata.html#m0">file</a>);
03992 
03993 
03994   <font class="comment">/* current line contains RUNTYP info; scan it */</font>
03995   <a class="code" href="gamessplugin_8c.html#a2">ERR_FALSE</a>( fgets(buffer,<font class="keyword">sizeof</font>(buffer),data-&gt;<a class="code" href="structgamessdata.html#m0">file</a>) )
03996   sscanf(buffer,<font class="stringliteral">"%s %s"</font>,&amp;word[0][0],&amp;word[1][0]);
03997 
03998 
03999   <font class="comment">/* check for supported RUNTYPs */</font>
04000   <font class="keywordflow">if</font> (!strcmp(&amp;word[1][0],<font class="stringliteral">"RUNTYP=ENERGY"</font>)) 
04001   {
04002     printf(<font class="stringliteral">"gamessplugin&gt; File generated via %s \n"</font>,&amp;word[1][0]);
04003     data-&gt;<a class="code" href="structgamessdata.html#m2">runtyp</a> = <a class="code" href="gamessplugin_8h.html#a8">ENERGY</a>;
04004     strncpy(data-&gt;<a class="code" href="structgamessdata.html#m3">runtyp_string</a>,<font class="stringliteral">"Single point"</font>,
04005             <font class="keyword">sizeof</font>(data-&gt;<a class="code" href="structgamessdata.html#m3">runtyp_string</a>));
04006   }
04007   <font class="keywordflow">else</font> <font class="keywordflow">if</font> (!strcmp(&amp;word[1][0],<font class="stringliteral">"RUNTYP=OPTIMIZE"</font>)) 
04008   {
04009     printf(<font class="stringliteral">"gamessplugin&gt; File generated via %s \n"</font>,&amp;word[1][0]);
04010     data-&gt;<a class="code" href="structgamessdata.html#m2">runtyp</a> = <a class="code" href="gamessplugin_8h.html#a9">OPTIMIZE</a>;
04011     strncpy(data-&gt;<a class="code" href="structgamessdata.html#m3">runtyp_string</a>,<font class="stringliteral">"Geometry optimization"</font>,
04012             <font class="keyword">sizeof</font>(data-&gt;<a class="code" href="structgamessdata.html#m3">runtyp_string</a>));
04013   }
04014   <font class="keywordflow">else</font> <font class="keywordflow">if</font> (!strcmp(&amp;word[1][0],<font class="stringliteral">"RUNTYP=SADPOINT"</font>)) 
04015   {
04016     printf(<font class="stringliteral">"gamessplugin&gt; File generated via %s \n"</font>,&amp;word[1][0]);
04017     data-&gt;<a class="code" href="structgamessdata.html#m2">runtyp</a> = <a class="code" href="gamessplugin_8h.html#a10">SADPOINT</a>;
04018     strncpy(data-&gt;<a class="code" href="structgamessdata.html#m3">runtyp_string</a>,<font class="stringliteral">"Saddle point search"</font>,
04019             <font class="keyword">sizeof</font>(data-&gt;<a class="code" href="structgamessdata.html#m3">runtyp_string</a>));
04020   }
04021   <font class="keywordflow">else</font> <font class="keywordflow">if</font> (!strcmp(&amp;word[1][0],<font class="stringliteral">"RUNTYP=HESSIAN"</font>)) 
04022   {
04023     printf(<font class="stringliteral">"gamessplugin&gt; File generated via %s \n"</font>,&amp;word[1][0]);
04024     data-&gt;<a class="code" href="structgamessdata.html#m2">runtyp</a> = <a class="code" href="gamessplugin_8h.html#a11">HESSIAN</a>;
04025     strncpy(data-&gt;<a class="code" href="structgamessdata.html#m3">runtyp_string</a>,<font class="stringliteral">"Hessian calculation"</font>,
04026             <font class="keyword">sizeof</font>(data-&gt;<a class="code" href="structgamessdata.html#m3">runtyp_string</a>));
04027   }
04028   <font class="keywordflow">else</font> 
04029   {
04030     printf(<font class="stringliteral">"gamessplugin&gt; The %s is currently not supported \n"</font>,
04031             &amp;word[1][0]);
04032     <font class="keywordflow">return</font> <a class="code" href="gamessplugin_8h.html#a6">FALSE</a>;
04033   }
04034 
04035   
04036   <font class="comment">/* reserve memory for scfenergy array */</font>
04037   data-&gt;<a class="code" href="structgamessdata.html#m27">scfenergies</a> = (<font class="keywordtype">double</font> *)calloc(1,<font class="keyword">sizeof</font>(<font class="keywordtype">double</font>));
04038 
04039 
04040   <font class="comment">/* determine SCFTYP */</font>
04041   <font class="keywordflow">if</font> (!strcmp(&amp;word[0][0],<font class="stringliteral">"SCFTYP=RHF"</font>)) 
04042   {
04043     printf(<font class="stringliteral">"gamessplugin&gt; Type of wavefunction used %s \n"</font>,
04044         &amp;word[0][0]);
04045     data-&gt;<a class="code" href="structgamessdata.html#m18">scftyp</a> = <a class="code" href="gamessplugin_8h.html#a12">RHF</a>;
04046     strncpy(data-&gt;<a class="code" href="structgamessdata.html#m19">scftyp_string</a>,<font class="stringliteral">"RHF"</font>,<font class="keyword">sizeof</font>(data-&gt;<a class="code" href="structgamessdata.html#m19">scftyp_string</a>));
04047   }
04048   <font class="keywordflow">else</font> <font class="keywordflow">if</font> (!strcmp(&amp;word[0][0],<font class="stringliteral">"SCFTYP=UHF"</font>)) 
04049   {
04050     printf(<font class="stringliteral">"gamessplugin&gt; Type of wavefunction used %s \n"</font>,
04051         &amp;word[0][0]);
04052     data-&gt;<a class="code" href="structgamessdata.html#m18">scftyp</a> = <a class="code" href="gamessplugin_8h.html#a13">UHF</a>;
04053     strncpy(data-&gt;<a class="code" href="structgamessdata.html#m19">scftyp_string</a>,<font class="stringliteral">"UHF"</font>,<font class="keyword">sizeof</font>(data-&gt;<a class="code" href="structgamessdata.html#m19">scftyp_string</a>));
04054   }
04055   <font class="keywordflow">else</font> <font class="keywordflow">if</font> (!strcmp(&amp;word[0][0],<font class="stringliteral">"SCFTYP=ROHF"</font>)) 
04056   {
04057     printf(<font class="stringliteral">"gamessplugin&gt; Type of wavefunction used %s \n"</font>,
04058         &amp;word[0][0]);
04059     data-&gt;<a class="code" href="structgamessdata.html#m18">scftyp</a> = <a class="code" href="gamessplugin_8h.html#a14">ROHF</a>;
04060     strncpy(data-&gt;<a class="code" href="structgamessdata.html#m19">scftyp_string</a>,<font class="stringliteral">"ROHF"</font>,<font class="keyword">sizeof</font>(data-&gt;<a class="code" href="structgamessdata.html#m19">scftyp_string</a>));
04061   }
04062   <font class="keywordflow">else</font> <font class="keywordflow">if</font> (!strcmp(&amp;word[0][0],<font class="stringliteral">"SCFTYP=GVB"</font>)) 
04063   {
04064     printf(<font class="stringliteral">"gamessplugin&gt; Type of wavefunction used %s \n"</font>,
04065         &amp;word[0][0]);
04066     data-&gt;<a class="code" href="structgamessdata.html#m18">scftyp</a> = <a class="code" href="gamessplugin_8h.html#a15">GVB</a>;
04067     strncpy(data-&gt;<a class="code" href="structgamessdata.html#m19">scftyp_string</a>,<font class="stringliteral">"GVB"</font>,<font class="keyword">sizeof</font>(data-&gt;<a class="code" href="structgamessdata.html#m19">scftyp_string</a>));
04068   }
04069   <font class="keywordflow">else</font> <font class="keywordflow">if</font> (!strcmp(&amp;word[0][0],<font class="stringliteral">"SCFTYP=MCSCF"</font>)) 
04070   {
04071     printf(<font class="stringliteral">"gamessplugin&gt; Type of wavefunction used %s \n"</font>,
04072         &amp;word[0][0]);
04073     data-&gt;<a class="code" href="structgamessdata.html#m18">scftyp</a> = <a class="code" href="gamessplugin_8h.html#a16">MCSCF</a>;
04074     strncpy(data-&gt;<a class="code" href="structgamessdata.html#m19">scftyp_string</a>,<font class="stringliteral">"MCSCF"</font>,<font class="keyword">sizeof</font>(data-&gt;<a class="code" href="structgamessdata.html#m19">scftyp_string</a>));
04075   }
04076   <font class="keywordflow">else</font> 
04077   {
04078     <font class="comment">/* if we don't find a supported SCFTYP we bomb out; this</font>
04079 <font class="comment">     * might be a little drastic */</font>
04080     printf(<font class="stringliteral">"gamessplugin&gt; %s is currently not supported \n"</font>,
04081             &amp;word[0][0]);
04082     strncpy(data-&gt;<a class="code" href="structgamessdata.html#m19">scftyp_string</a>,<font class="stringliteral">"\0"</font>,<font class="keyword">sizeof</font>(data-&gt;<a class="code" href="structgamessdata.html#m19">scftyp_string</a>));
04083     <font class="keywordflow">return</font> <a class="code" href="gamessplugin_8h.html#a6">FALSE</a>;
04084   }
04085 
04086 
04087   <a class="code" href="xsfplugin_8C.html#a36">eatline</a>(data-&gt;<a class="code" href="structgamessdata.html#m0">file</a>);
04088 
04089   <font class="comment">/* next we determine the coord type (i.e. zmatrix, unique ..)</font>
04090 <font class="comment">   * as provided with the COORD keyword */</font>
04091   <a class="code" href="gamessplugin_8c.html#a2">ERR_FALSE</a>( fgets(buffer,<font class="keyword">sizeof</font>(buffer),data-&gt;<a class="code" href="structgamessdata.html#m0">file</a>) )
04092   strcpy(data-&gt;<a class="code" href="structgamessdata.html#m13">geometry</a>,
04093       <a class="code" href="gamessplugin_8c.html#a38">chop_string_all</a>(strstr(buffer,<font class="stringliteral">"COORD ="</font>)+7)); 
04094 
04095 
04096   <font class="comment">/* brief message */</font>
04097   printf(<font class="stringliteral">"gamessplugin&gt; Coordinate type %s used \n"</font>,data-&gt;<a class="code" href="structgamessdata.html#m13">geometry</a>);
04098 
04099 
04100   <font class="comment">/* at this point everything should be in good shape */</font>
04101   <font class="keywordflow">return</font> <a class="code" href="gamessplugin_8h.html#a7">TRUE</a>;
04102 }
04103 
04104 
04105 
04106 
04107 <font class="comment">/********************************************************</font>
04108 <font class="comment"> *</font>
04109 <font class="comment"> * THIS IS THE END OF THE GAMESS SPECIFIC SUBROUTINES</font>
04110 <font class="comment"> *</font>
04111 <font class="comment"> ********************************************************/</font>
04112 
04113 
04114 
04115 
04116 <font class="comment">/*********************************************************</font>
04117 <font class="comment"> *</font>
04118 <font class="comment"> * this function prints the current date and time </font>
04119 <font class="comment"> *</font>
04120 <font class="comment"> *********************************************************/</font>
04121 <font class="keywordtype">void</font> 
<a name="l04122"></a><a class="code" href="gamessplugin_8c.html#a37">04122</a> <a class="code" href="gamessplugin_8c.html#a37">get_time</a>(<font class="keywordtype">char</font> *mytime)
04123 {
04124   time_t current_time;
04125   <font class="keyword">struct </font>tm *curtime;
04126 
04127   <font class="comment">/* get the current time */</font>
04128 
04129   time(&amp; current_time);
04130 
04131   <font class="comment">/* figure out the local time */</font>
04132 
04133   curtime = localtime(&amp; current_time);
04134 
04135   <font class="comment">/* print it */</font>
04136 
04137   (void) strftime(mytime,BUFSIZ, 
04138                   <font class="stringliteral">"programm start: %a, %0d %b %0H:%0M:%0S"</font>, 
04139                   curtime);
04140   
04141   <font class="keywordflow">return</font>;
04142 }
04143 
04144 
04145 
04146 <font class="comment">/********************************************************</font>
04147 <font class="comment"> *</font>
04148 <font class="comment"> * this function removes trailing spaces/newlines off</font>
04149 <font class="comment"> * a character array</font>
04150 <font class="comment"> *</font>
04151 <font class="comment"> ********************************************************/</font>
<a name="l04152"></a><a class="code" href="gamessplugin_8c.html#a38">04152</a> <font class="keywordtype">char</font>* <a class="code" href="gamessplugin_8c.html#a38">chop_string_all</a>( <font class="keywordtype">char</font>* the_string )
04153 {
04154   <font class="keywordtype">int</font> i = 0;
04155 
04156   <font class="keywordflow">while</font> ( (*(the_string+i) != <font class="charliteral">'\n'</font>) &amp;&amp; (*(the_string+i) != <font class="charliteral">' '</font>) &amp;&amp; 
04157           (*(the_string+i) != <font class="charliteral">'\0'</font>)) 
04158   {
04159     ++i;
04160   }
04161 
04162   *(the_string+i) = <font class="charliteral">'\0'</font>;
04163 
04164   <font class="keywordflow">return</font> the_string;
04165 }
04166 
04167 
04168 
04169 <font class="comment">/********************************************************</font>
04170 <font class="comment"> *</font>
04171 <font class="comment"> * this function removes trailing newlines off</font>
04172 <font class="comment"> * a character array</font>
04173 <font class="comment"> *</font>
04174 <font class="comment"> ********************************************************/</font>
<a name="l04175"></a><a class="code" href="gamessplugin_8c.html#a39">04175</a> <font class="keywordtype">char</font>* <a class="code" href="gamessplugin_8c.html#a39">chop_string_nl</a>( <font class="keywordtype">char</font>* the_string )
04176 {
04177   <font class="keywordtype">int</font> i = 0;
04178 
04179   <font class="keywordflow">while</font> ( (*(the_string+i) != <font class="charliteral">'\n'</font>) &amp;&amp; (*(the_string+i) != <font class="charliteral">'\0'</font>)) 
04180   {
04181     ++i;
04182   }
04183   *(the_string+i) = <font class="charliteral">'\0'</font>;
04184 
04185   <font class="keywordflow">return</font> the_string;
04186 }
04187 
04188 
04189 
04190 <font class="comment">/*********************************************************</font>
04191 <font class="comment"> *</font>
04192 <font class="comment"> * this function calculates the value of the wavefunction</font>
04193 <font class="comment"> * corresponding to a particular orbital at grid point</font>
04194 <font class="comment"> * grid_x, grid_y, grid_z</font>
04195 <font class="comment"> *</font>
04196 <font class="comment"> *********************************************************/</font>
<a name="l04197"></a><a class="code" href="gamessplugin_8c.html#a40">04197</a> <font class="keywordtype">float</font> <a class="code" href="gamessplugin_8c.html#a40">orbital_at_grid_xyz</a>(<font class="keywordtype">void</font> *mydata, <font class="keywordtype">float</font> *wave_function,
04198     <font class="keywordtype">float</font> grid_size, <font class="keywordtype">float</font> grid_x, <font class="keywordtype">float</font> grid_y, <font class="keywordtype">float</font> grid_z)
04199 {
04200   <a class="code" href="structgamessdata.html">gamessdata</a> *data = (<a class="code" href="structgamessdata.html">gamessdata</a> *)mydata;
04201   <a class="code" href="structgamess__temp.html">gamess_temp</a> *temp_data;
04202   <font class="keywordtype">int</font> *basis_counter, position;
04203   <font class="keywordtype">float</font> xtemp = 0.0, ytemp = 0.0, ztemp = 0.0;
04204   <font class="keywordtype">float</font> xtemp2 = 0.0, ytemp2 = 0.0, ztemp2 = 0.0;
04205   <font class="keywordtype">char</font> *orbital_symmetry;
04206   <font class="keywordtype">int</font> at;
04207   <font class="keywordtype">int</font> prim, shell;
04208   <font class="keywordtype">int</font> orbital_pointer = 0;
04209   <font class="keywordtype">float</font> dist2 = 0; 
04210   <font class="keywordtype">float</font> value, value_grid;
04211   <font class="keywordtype">int</font> *temp_shell;
04212   <font class="keywordtype">int</font> *temp_prims;
04213   <font class="keywordtype">int</font> sym_counter;
04214   <font class="keywordtype">float</font> temp_p_value, temp_s_value, temp_d_value, temp_f_value;
04215   <font class="keywordtype">int</font> have_s, have_p, have_d, have_f;
04216   <font class="keywordtype">float</font> temp;
04217 
04218     
04219   <font class="comment">/* initialize value of orbital at gridpoint */</font>
04220   value_grid = 0.0;
04221   value = 0.0;
04222 
04223 
04224   <font class="comment">/* retrieve orbital symmetry of shel primitives */</font>
04225   orbital_symmetry = data-&gt;<a class="code" href="structgamessdata.html#m66">orbital_symmetry</a>;
04226 
04227         
04228   <font class="comment">/* retrieve array with # of primitives available</font>
04229 <font class="comment">  * for each indivual atom of the system */</font>
04230   basis_counter = data-&gt;<a class="code" href="structgamessdata.html#m62">basis_counter</a>;
04231 
04232 
04233   <font class="comment">/* retrieve the pointer for the temp arrays */</font>
04234   temp_data = data-&gt;<a class="code" href="structgamessdata.html#m75">temporary</a>;
04235 
04236   <font class="comment">/* initialize the orbital pointer */</font>
04237   orbital_pointer = 0; 
04238 
04239 
04240   <font class="comment">/* initialize the primitive counter */</font>
04241   position = 0;
04242   sym_counter = 0;
04243 
04244 
04245   <font class="comment">/* store shells and primitive counter in</font>
04246 <font class="comment">  * temporary arrays */</font>
04247   temp_shell = data-&gt;<a class="code" href="structgamessdata.html#m64">atomic_shells</a>;
04248   temp_prims = data-&gt;<a class="code" href="structgamessdata.html#m65">shell_primitives</a>;
04249 
04250         
04251   <font class="comment">/* loop over all the QM atoms */</font>
04252   <font class="keywordflow">for</font> ( at = 0 ; at &lt; data-&gt;<a class="code" href="structgamessdata.html#m1">numatoms</a> ; ++at) 
04253   {
04254     <font class="comment">/* at this point we can calculate the</font>
04255 <font class="comment">     * distance of the current grid point</font>
04256 <font class="comment">     * from the center of atom at */</font>
04257     xtemp =  ( grid_x - (temp_data+at)-&gt;x );
04258     ytemp =  ( grid_y - (temp_data+at)-&gt;y );
04259     ztemp =  ( grid_z - (temp_data+at)-&gt;z );
04260 
04261     xtemp2 =  pow(xtemp,2.0);
04262     ytemp2 =  pow(ytemp,2.0);
04263     ztemp2 =  pow(ztemp,2.0);
04264 
04265           
04266     dist2 = xtemp2 + ytemp2 + ztemp2;
04267 
04268     <font class="comment">/* loop over the primitives belonging to</font>
04269 <font class="comment">     * this atom;</font>
04270 <font class="comment">     * the number of shells per atom is encoded</font>
04271 <font class="comment">     * in the array atomic_shells;</font>
04272 <font class="comment">     * the number of primitives per shell is </font>
04273 <font class="comment">     * stored in the array shell_primitives */</font>
04274     <font class="keywordflow">for</font> ( shell = 0; shell &lt; *temp_shell; ++shell)
04275     {
04276 
04277       <font class="comment">/* initialize temp arrays */</font>
04278       temp_p_value = 0.0; 
04279       temp_s_value = 0.0;
04280       temp_d_value = 0.0;
04281       temp_f_value = 0.0;
04282 
04283 
04284       <font class="comment">/* flags keepting track of what orbital</font>
04285 <font class="comment">       * symmetries we parsed in the current </font>
04286 <font class="comment">       * shell */</font>
04287       have_s = <a class="code" href="gamessplugin_8h.html#a6">FALSE</a>;
04288       have_p = <a class="code" href="gamessplugin_8h.html#a6">FALSE</a>;
04289       have_d = <a class="code" href="gamessplugin_8h.html#a6">FALSE</a>;
04290       have_f = <a class="code" href="gamessplugin_8h.html#a6">FALSE</a>;
04291 
04292 
04293       <font class="comment">/* start looping over the shell primitives */</font>
04294       <font class="keywordflow">for</font> ( prim = 0; prim &lt; *temp_prims;  ++prim)
04295       {
04296         temp = *(data-&gt;<a class="code" href="structgamessdata.html#m61">basis</a>+position+1) * 
04297           exp(*(data-&gt;<a class="code" href="structgamessdata.html#m61">basis</a> + position)*-1.0*dist2);
04298 
04299         
04300         <font class="comment">/* compute-routine for S-shells */</font>
04301         <font class="keywordflow">if</font> ( *(orbital_symmetry+sym_counter) == <font class="charliteral">'S'</font> )
04302         {
04303           <font class="comment">/* indicate presence of S shell primitives */</font> 
04304           have_s = <a class="code" href="gamessplugin_8h.html#a7">TRUE</a>;
04305 
04306           <font class="comment">/* add primitive to s shell */</font>
04307           temp_s_value = temp_s_value + temp;
04308 
04309           <font class="comment">/* increase the counter keeping track of the total</font>
04310 <font class="comment">           * number of primitives */</font>
04311           position += 2;
04312         }
04313            
04314         <font class="comment">/* compute-routine for L-shells */</font>
04315         <font class="keywordflow">else</font> <font class="keywordflow">if</font> ( *(orbital_symmetry+sym_counter) == <font class="charliteral">'P'</font> )
04316         {
04317           <font class="comment">/* indicate presence of P shell primitives */</font>
04318           have_p = <a class="code" href="gamessplugin_8h.html#a7">TRUE</a>;
04319                
04320           <font class="comment">/* add primitive to p shell */</font>
04321           temp_p_value = temp_p_value + temp;
04322 
04323 
04324           <font class="comment">/* increase the counter keeping track of the total</font>
04325 <font class="comment">           * number of primitives */</font>
04326           position += 2;
04327         } 
04328                
04329                 
04330         <font class="comment">/* compute-routine for D-shells */</font>
04331         <font class="keywordflow">else</font> <font class="keywordflow">if</font> ( *(orbital_symmetry+sym_counter) == <font class="charliteral">'D'</font> )
04332         {
04333           <font class="comment">/* indicate presence of P shell primitives */</font>
04334           have_d = <a class="code" href="gamessplugin_8h.html#a7">TRUE</a>;
04335                
04336           <font class="comment">/* add primitive to p shell */</font>
04337           temp_d_value = temp_d_value + temp;
04338 
04339 
04340           <font class="comment">/* increase the counter keeping track of the total</font>
04341 <font class="comment">           * number of primitives */</font>
04342           position += 2;
04343         } 
04344 
04345                
04346         <font class="comment">/* compute-routine for F-shells */</font>
04347         <font class="keywordflow">else</font> <font class="keywordflow">if</font> ( *(orbital_symmetry+sym_counter) == <font class="charliteral">'F'</font> )
04348         {
04349           <font class="comment">/* indicate presence of P shell primitives */</font>
04350           have_f = <a class="code" href="gamessplugin_8h.html#a7">TRUE</a>;
04351                
04352           <font class="comment">/* add primitive to p shell */</font>
04353           temp_f_value = temp_f_value + temp;
04354 
04355 
04356           <font class="comment">/* increase the counter keeping track of the total</font>
04357 <font class="comment">           * number of primitives */</font>
04358           position += 2;
04359         }
04360 
04361 
04362         <font class="comment">/* at this point we have fallen through all the</font>
04363 <font class="comment">         * shell types we know and we better quit */</font>
04364         <font class="keywordflow">else</font>
04365         {
04366           printf(<font class="stringliteral">"gamessplugin&gt; WARNING ... "</font>);
04367           printf(<font class="stringliteral">"Encountered unknown shell type %d \n"</font>, 
04368             *(orbital_symmetry+sym_counter));
04369           <font class="keywordflow">return</font> <a class="code" href="gamessplugin_8h.html#a6">FALSE</a>;
04370         }
04371 
04372 
04373         <font class="comment">/* update counter that keeps track of the orbital</font>
04374 <font class="comment">         * symmetry of the current shell */</font>
04375         sym_counter++;   
04376       }
04377 
04378         
04379       <font class="comment">/* multiply with the appropriate wavefunction</font>
04380 <font class="comment">      * coefficient */</font>
04381 
04382       <font class="comment">/* S shells */</font>
04383       <font class="keywordflow">if</font> ( have_s ) 
04384       {
04385         <font class="comment">/* s */</font>
04386         value = *(wave_function + orbital_pointer) * temp_s_value;
04387         orbital_pointer++;
04388       }
04389           
04390 
04391       <font class="comment">/* p shells */</font>
04392       <font class="keywordflow">if</font> ( have_p )
04393       {
04394         <font class="comment">/* px */</font>
04395         value = *(wave_function + orbital_pointer) * temp_p_value * 
04396             xtemp;
04397         orbital_pointer++;
04398 
04399         <font class="comment">/* py */</font>
04400         value = *(wave_function + orbital_pointer) * temp_p_value * 
04401             ytemp;
04402         orbital_pointer++;
04403              
04404         <font class="comment">/* pz */</font> 
04405         value = *(wave_function + orbital_pointer) * temp_p_value * 
04406             ztemp;
04407         orbital_pointer++;
04408       }
04409 
04410             
04411       <font class="comment">/* d shells */</font>
04412       <font class="keywordflow">if</font> ( have_d )
04413       {
04414         <font class="comment">/* d_xx */</font>
04415         value = *(wave_function + orbital_pointer) * temp_d_value * 
04416             xtemp * xtemp;
04417         orbital_pointer++;
04418 
04419         <font class="comment">/* d_yy */</font>
04420         value = *(wave_function + orbital_pointer) * temp_d_value * 
04421             ytemp * ytemp;
04422         orbital_pointer++;
04423 
04424         <font class="comment">/* d_zz */</font>
04425         value = *(wave_function + orbital_pointer) * temp_d_value * 
04426             ztemp * ztemp;
04427         orbital_pointer++;
04428 
04429         <font class="comment">/* d_xy */</font>
04430         value = *(wave_function + orbital_pointer) * temp_d_value * 
04431             xtemp * ytemp;
04432         orbital_pointer++;
04433 
04434         <font class="comment">/* d_xz */</font>
04435         value = *(wave_function + orbital_pointer) * temp_d_value * 
04436             xtemp * ztemp;
04437         orbital_pointer++;
04438 
04439         <font class="comment">/* d_yz */</font>
04440         value = *(wave_function + orbital_pointer) * temp_d_value * 
04441             ytemp * ztemp;
04442         orbital_pointer++;
04443       }
04444 
04445 
04446       <font class="comment">/* f shells */</font>
04447       <font class="keywordflow">if</font> ( have_f )
04448       {
04449         <font class="comment">/* f_xxx */</font>
04450         value = *(wave_function + orbital_pointer) * temp_d_value * 
04451             xtemp * xtemp * xtemp;
04452         orbital_pointer++;
04453 
04454         <font class="comment">/* f_yyy */</font>
04455         value = *(wave_function + orbital_pointer) * temp_d_value * 
04456           ytemp * ytemp * ytemp;
04457         orbital_pointer++;
04458 
04459         <font class="comment">/* f_zzz */</font>
04460         value = *(wave_function + orbital_pointer) * temp_d_value * 
04461             ztemp * ztemp * ztemp;
04462         orbital_pointer++;
04463 
04464         <font class="comment">/* f_xxy */</font>
04465         value = *(wave_function + orbital_pointer) * temp_d_value * 
04466             xtemp * xtemp * ytemp;
04467         orbital_pointer++;
04468 
04469         <font class="comment">/* f_xxz */</font>
04470         value = *(wave_function + orbital_pointer) * temp_d_value * 
04471             xtemp * xtemp * ztemp;
04472         orbital_pointer++;
04473 
04474         <font class="comment">/* f_yyx */</font>
04475         value = *(wave_function + orbital_pointer) * temp_d_value * 
04476             ytemp * ytemp * xtemp;
04477         orbital_pointer++;
04478 
04479         <font class="comment">/* f_yyz */</font>
04480         value = *(wave_function + orbital_pointer) * temp_d_value * 
04481             ytemp * ytemp * ztemp;
04482         orbital_pointer++;
04483 
04484         <font class="comment">/* f_zzx */</font>
04485         value = *(wave_function + orbital_pointer) * temp_d_value * 
04486             ztemp * ztemp * xtemp;
04487         orbital_pointer++;
04488 
04489         <font class="comment">/* f_zzy */</font>
04490         value = *(wave_function + orbital_pointer) * temp_d_value * 
04491             ztemp * ztemp * ytemp;
04492         orbital_pointer++;
04493 
04494         <font class="comment">/* f_xyz */</font>
04495         value = *(wave_function + orbital_pointer) * temp_d_value * 
04496             xtemp * ytemp * ztemp;
04497         orbital_pointer++;
04498       }
04499 
04500 
04501       <font class="comment">/* move primitives pointer to next shell */</font>
04502       ++temp_prims;
04503 
04504 
04505       <font class="comment">/* store value in temporary array, and </font>
04506 <font class="comment">      * reset value */</font>
04507       value_grid = value_grid + value;
04508       value = 0.0; 
04509     } 
04510 
04511 
04512     <font class="comment">/* move shell pointer to next atom */</font>
04513     temp_shell++;
04514   }
04515 
04516   <font class="comment">/* return value at grid point */</font>
04517   <font class="keywordflow">return</font> value_grid;
04518 }
04519 
04520 
</pre></div><hr><address><small>Generated on Wed Mar 22 13:15:29 2006 for VMD Plugins (current) by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.gif" alt="doxygen" align="middle" border=0 
width=110 height=53></a>1.2.14 written by <a href="mailto:dimitri@stack.nl">Dimitri van Heesch</a>,
 &copy;&nbsp;1997-2002</small></address>
</body>
</html>
