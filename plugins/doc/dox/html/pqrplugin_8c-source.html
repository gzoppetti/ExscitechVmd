<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>pqrplugin.c Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.2.14 -->
<center>
<a class="qindex" href="index.html">Main Page</a> &nbsp; <a class="qindex" href="classes.html">Alphabetical List</a> &nbsp; <a class="qindex" href="annotated.html">Compound List</a> &nbsp; <a class="qindex" href="files.html">File List</a> &nbsp; <a class="qindex" href="functions.html">Compound Members</a> &nbsp; <a class="qindex" href="globals.html">File Members</a> &nbsp; <a class="qindex" href="pages.html">Related Pages</a> &nbsp; </center>
<hr><h1>pqrplugin.c</h1><a href="pqrplugin_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 <font class="comment">/***************************************************************************</font>
00002 <font class="comment"> *cr</font>
00003 <font class="comment"> *cr            (C) Copyright 1995-2006 The Board of Trustees of the</font>
00004 <font class="comment"> *cr                        University of Illinois</font>
00005 <font class="comment"> *cr                         All Rights Reserved</font>
00006 <font class="comment"> *cr</font>
00007 <font class="comment"> ***************************************************************************/</font>
00008 
00009 <font class="comment">/***************************************************************************</font>
00010 <font class="comment"> * RCS INFORMATION:</font>
00011 <font class="comment"> *</font>
00012 <font class="comment"> *      $RCSfile: pqrplugin.c,v $</font>
00013 <font class="comment"> *      $Author: johns $       $Locker:  $             $State: Exp $</font>
00014 <font class="comment"> *      $Revision: 1.12 $       $Date: 2006/02/23 19:36:45 $</font>
00015 <font class="comment"> *</font>
00016 <font class="comment"> ***************************************************************************/</font>
00017 
00018 <font class="comment">/*</font>
00019 <font class="comment"> * PQR is be a space-delimited variant of the PDB format, with atom radius</font>
00020 <font class="comment"> * and charge information replacing the B-factor and occupancy columns, and</font>
00021 <font class="comment"> * containing only ATOM records.</font>
00022 <font class="comment"> *</font>
00023 <font class="comment"> * Most of this code is lifted from pdbplugin and readpdb.h</font>
00024 <font class="comment"> */</font>
00025 
00026 <font class="preprocessor">#include "<a class="code" href="molfile__plugin_8h.html">molfile_plugin.h</a>"</font>
00027 <font class="preprocessor">#include &lt;stdio.h&gt;</font>
00028 <font class="preprocessor">#include &lt;stdlib.h&gt;</font>
00029 <font class="preprocessor">#include &lt;string.h&gt;</font>
00030 
<a name="l00031"></a><a class="code" href="pqrplugin_8c.html#a0">00031</a> <font class="preprocessor">#define PQR_RECORD_LENGTH 80</font>
00032 <font class="preprocessor"></font>
00033 <font class="comment">/*  record type defines */</font>
00034 <font class="keyword">enum</font> {<a class="code" href="pqrplugin_8c.html#a23a2">PQR_REMARK</a>, <a class="code" href="pqrplugin_8c.html#a23a3">PQR_ATOM</a>, <a class="code" href="pqrplugin_8c.html#a23a4">PQR_UNKNOWN</a>, <a class="code" href="pqrplugin_8c.html#a23a5">PQR_EOF</a>, <a class="code" href="pqrplugin_8c.html#a23a6">PQR_ERROR</a>};
00035 
00036 <font class="comment">/* </font>
00037 <font class="comment"> * read the next record from the specified pqr file, and put the string</font>
00038 <font class="comment"> * found in the given string pointer (the caller must provide adequate (81</font>
00039 <font class="comment"> * chars) buffer space); return the type of record found</font>
00040 <font class="comment"> */</font>
<a name="l00041"></a><a class="code" href="pqrplugin_8c.html#a7">00041</a> <font class="keyword">static</font> <font class="keywordtype">int</font> <a class="code" href="pqrplugin_8c.html#a7">read_pqr_record</a>(FILE *f, <font class="keywordtype">char</font> *retStr) {
00042 
00043   <font class="keywordtype">char</font> inbuf[<a class="code" href="pqrplugin_8c.html#a0">PQR_RECORD_LENGTH</a>+2];
00044   <font class="keywordtype">int</font> recType = <a class="code" href="pqrplugin_8c.html#a23a4">PQR_UNKNOWN</a>;
00045  
00046   <font class="comment">/* XXX This PQR record reading code breaks with files that use</font>
00047 <font class="comment">   * Mac or DOS style line breaks with ctrl-M characters.  We need</font>
00048 <font class="comment">   * to replace the use of fgets() and comparisons against \n with</font>
00049 <font class="comment">   * code that properly handles the other cases.</font>
00050 <font class="comment">   */</font>
00051  
00052   <font class="comment">/*  read the next line  */</font>
00053   <font class="keywordflow">if</font>(inbuf != fgets(inbuf, <a class="code" href="pqrplugin_8c.html#a0">PQR_RECORD_LENGTH</a>+1, f)) {
00054     retStr[0] = <font class="charliteral">'\0'</font>;
00055     <font class="keywordflow">if</font> (feof(f)) {
00056       recType = <a class="code" href="pqrplugin_8c.html#a23a5">PQR_EOF</a>;
00057     }
00058     <font class="keywordflow">else</font> {
00059       recType = <a class="code" href="pqrplugin_8c.html#a23a6">PQR_ERROR</a>;
00060     }
00061   } 
00062   <font class="keywordflow">else</font> {
00063     <font class="comment">/*  remove the newline character, if there is one */</font>
00064     <font class="keywordflow">if</font>(inbuf[strlen(inbuf)-1] == <font class="charliteral">'\n'</font>)
00065       inbuf[strlen(inbuf)-1] = <font class="charliteral">'\0'</font>;
00066 
00067     <font class="keywordflow">if</font> (!strncmp(inbuf, <font class="stringliteral">"ATOM  "</font>, 6)) {
00068       strcpy(retStr,inbuf);
00069       recType = <a class="code" href="pqrplugin_8c.html#a23a3">PQR_ATOM</a>;
00070     } 
00071     <font class="keywordflow">else</font> {
00072       retStr[0] = <font class="charliteral">'\0'</font>;
00073       recType = <a class="code" href="pqrplugin_8c.html#a23a4">PQR_UNKNOWN</a>;
00074     }
00075   }
00076 
00077   <font class="comment">/* read the '\r', if there was one */</font>
00078   {
00079     <font class="keywordtype">int</font> ch = fgetc(f);
00080     <font class="keywordflow">if</font> (ch != <font class="charliteral">'\r'</font>) {
00081       ungetc(ch, f);
00082     }
00083   }
00084   
00085   <font class="keywordflow">return</font> recType;
00086 }
00087 
00088 <font class="comment">/*</font>
00089 <font class="comment"> * Read the fields in an ATOM line. Return 0 on success, nonzero otherwise.</font>
00090 <font class="comment"> */</font>
<a name="l00091"></a><a class="code" href="pqrplugin_8c.html#a8">00091</a> <font class="keyword">static</font> <font class="keywordtype">int</font> <a class="code" href="pqrplugin_8c.html#a8">get_pqr_fields</a>(<font class="keywordtype">char</font> *record, <font class="keywordtype">char</font> *<a class="code" href="xsfplugin_8C.html#a2">name</a>, <font class="keywordtype">char</font> *resname, <font class="keywordtype">char</font> *chain,
00092     <font class="keywordtype">char</font> *segname, <font class="keywordtype">char</font> *resid,
00093     <font class="keywordtype">float</font> *x, <font class="keywordtype">float</font> *y, <font class="keywordtype">float</font> *z, <font class="keywordtype">float</font> *charge, <font class="keywordtype">float</font> *radius) {
00094 
00095   <font class="comment">/*</font>
00096 <font class="comment">   * PQR files are like pdb files, but not quite.  They're fixed format</font>
00097 <font class="comment">   * for the the identifier data up to resid, but after that it's free-format</font>
00098 <font class="comment">   * for the floating point data.</font>
00099 <font class="comment">   */</font>
00100   strncpy(<a class="code" href="xsfplugin_8C.html#a2">name</a>, record+12, 4);    <a class="code" href="xsfplugin_8C.html#a2">name</a>[4] = 0;
00101   strncpy(resname, record+17, 4); resname[4] = 0;
00102   strncpy(chain, record+21, 1);   chain[1] = 0;
00103   strncpy(resid, record+22, 4);   resid[4] = 0;
00104   <font class="comment">/* XXX what to do about the segid? */</font>
00105   segname[0] = 0;
00106 
00107   <font class="keywordflow">if</font> (sscanf(record+30, <font class="stringliteral">"%f%f%f%f%f"</font>, x, y, z, charge, radius) != 5) {
00108     <font class="keywordflow">return</font> 1;
00109   }
00110   <font class="comment">/* success */</font>
00111   <font class="keywordflow">return</font> 0;
00112 }
00113 
00114 <font class="comment">/*</font>
00115 <font class="comment"> * Read the coordinates in an ATOM line. Return 0 on success, nonzero otherwise.</font>
00116 <font class="comment"> */</font>
<a name="l00117"></a><a class="code" href="pqrplugin_8c.html#a9">00117</a> <font class="keyword">static</font> <font class="keywordtype">int</font> <a class="code" href="pqrplugin_8c.html#a9">get_pqr_coordinates</a>(<font class="keywordtype">char</font> *record, <font class="keywordtype">float</font> *x, <font class="keywordtype">float</font> *y, <font class="keywordtype">float</font> *z) {
00118 
00119   <font class="keywordflow">if</font> (sscanf(record, <font class="stringliteral">"ATOM%*7d  %*4s%*4s%*5s %f%f%f%*f%*f"</font>,
00120              x, y, z) == 3) {
00121     <font class="keywordflow">return</font> 0;
00122   }
00123 
00124   <font class="comment">/* Return an error */</font>
00125   <font class="keywordflow">else</font> {
00126     <font class="keywordflow">return</font> 1;
00127   }
00128 }
00129 
00130 <font class="comment">/*</font>
00131 <font class="comment"> * Return a default radius for the given atom.</font>
00132 <font class="comment"> */</font>
<a name="l00133"></a><a class="code" href="pqrplugin_8c.html#a10">00133</a> <font class="keyword">static</font> <font class="keywordtype">float</font> <a class="code" href="pqrplugin_8c.html#a10">get_atom_radius</a>(<a class="code" href="structmolfile__atom__t.html">molfile_atom_t</a> *atom) {
00134   <font class="keywordtype">char</font> *<a class="code" href="xsfplugin_8C.html#a2">name</a>, *type;
00135   <a class="code" href="xsfplugin_8C.html#a2">name</a> = atom-&gt;<a class="code" href="structmolfile__atom__t.html#m0">name</a>;
00136   type = atom-&gt;<a class="code" href="structmolfile__atom__t.html#m1">type</a>;
00137 
00138   <font class="comment">/* XXX - yeah, this needs to be fixed */</font>
00139   <font class="keywordflow">return</font> 1.0;
00140 }
00141 
00142 <font class="comment">/*</font>
00143 <font class="comment"> * Append a PQR ATOM record to the given file.</font>
00144 <font class="comment"> */</font>
<a name="l00145"></a><a class="code" href="pqrplugin_8c.html#a11">00145</a> <font class="keyword">static</font> <font class="keywordtype">int</font> <a class="code" href="pqrplugin_8c.html#a11">write_pqr_atom</a>(FILE *fd, <font class="keywordtype">int</font> index, <font class="keyword">const</font> <a class="code" href="structmolfile__atom__t.html">molfile_atom_t</a> *atom, 
00146                    <font class="keywordtype">float</font> x, <font class="keywordtype">float</font> y, <font class="keywordtype">float</font> z) {
00147   <font class="keywordtype">int</font> rc;
00148 
00149   rc = fprintf(fd, <font class="stringliteral">"ATOM  %5d %-4s %s %5d    %8.3f%8.3f%8.3f %.3f %.3f\n"</font>,
00150                index, atom-&gt;<a class="code" href="structmolfile__atom__t.html#m0">name</a>, atom-&gt;<a class="code" href="structmolfile__atom__t.html#m2">resname</a>, atom-&gt;<a class="code" href="structmolfile__atom__t.html#m3">resid</a>, 
00151                x, y, z, atom-&gt;<a class="code" href="structmolfile__atom__t.html#m11">charge</a>, atom-&gt;<a class="code" href="structmolfile__atom__t.html#m12">radius</a>);
00152 
00153   <font class="keywordflow">return</font> (rc &gt; 0);
00154 }
00155 
00156 
00157 <font class="comment">/*</font>
00158 <font class="comment"> * API functions start here</font>
00159 <font class="comment"> */</font>
00160 
<a name="l00161"></a><a class="code" href="structpqrdata.html">00161</a> <font class="keyword">typedef</font> <font class="keyword">struct </font>{
<a name="l00162"></a><a class="code" href="structpqrdata.html#m0">00162</a>   FILE *fd;
<a name="l00163"></a><a class="code" href="structpqrdata.html#m1">00163</a>   <font class="keywordtype">int</font> natoms;
<a name="l00164"></a><a class="code" href="structpqrdata.html#m2">00164</a>   <a class="code" href="structmolfile__atom__t.html">molfile_atom_t</a> *atomlist;
00165 } <a class="code" href="structpqrdata.html">pqrdata</a>;
00166 
<a name="l00167"></a><a class="code" href="pqrplugin_8c.html#a12">00167</a> <font class="keyword">static</font> <font class="keywordtype">void</font> *<a class="code" href="pqrplugin_8c.html#a12">open_pqr_read</a>(<font class="keyword">const</font> <font class="keywordtype">char</font> *filepath, <font class="keyword">const</font> <font class="keywordtype">char</font> *filetype, 
00168     <font class="keywordtype">int</font> *natoms) {
00169   FILE *fd;
00170   <a class="code" href="structpqrdata.html">pqrdata</a> *pqr;
00171   <font class="keywordtype">char</font> pqr_record[<a class="code" href="pqrplugin_8c.html#a0">PQR_RECORD_LENGTH</a>+2];
00172   <font class="keywordtype">int</font> record_type;
00173 
00174   fd = fopen(filepath, <font class="stringliteral">"r"</font>);
00175   <font class="keywordflow">if</font> (!fd) 
00176     <font class="keywordflow">return</font> NULL;
00177   pqr = (<a class="code" href="structpqrdata.html">pqrdata</a> *)malloc(<font class="keyword">sizeof</font>(<a class="code" href="structpqrdata.html">pqrdata</a>));
00178   pqr-&gt;<a class="code" href="structpqrdata.html#m0">fd</a> = fd;
00179 
00180   *natoms=0;
00181   <font class="keywordflow">do</font> {
00182     record_type = <a class="code" href="pqrplugin_8c.html#a7">read_pqr_record</a>(pqr-&gt;<a class="code" href="structpqrdata.html#m0">fd</a>, pqr_record);
00183     <font class="keywordflow">if</font> (record_type == <a class="code" href="pqrplugin_8c.html#a23a3">PQR_ATOM</a>)
00184       *natoms += 1;
00185     <font class="keywordflow">else</font> <font class="keywordflow">if</font> (record_type == <a class="code" href="pqrplugin_8c.html#a23a6">PQR_ERROR</a>) {
00186       fprintf(stderr, <font class="stringliteral">"Error reading PQR file after opening.\n"</font>);
00187       free(pqr);
00188       <font class="keywordflow">return</font> NULL;
00189     }
00190     <font class="comment">/* else, do nothing */</font>
00191   } <font class="keywordflow">while</font> (record_type != <a class="code" href="pqrplugin_8c.html#a23a5">PQR_EOF</a>);
00192 
00193   <font class="comment">/* If no atoms were found, this is probably not a PQR file! */</font>
00194   <font class="keywordflow">if</font> (!*natoms) {
00195     fprintf(stderr, <font class="stringliteral">"PQR file '%s' contains no atoms.\n"</font>, filepath);
00196     free(pqr);
00197     <font class="keywordflow">return</font> NULL;
00198   }
00199 
00200   rewind(pqr-&gt;<a class="code" href="structpqrdata.html#m0">fd</a>);
00201   pqr-&gt;<a class="code" href="structpqrdata.html#m1">natoms</a> = *natoms;
00202   <font class="keywordflow">return</font> pqr; 
00203 }
00204 
00205 <font class="comment">/* </font>
00206 <font class="comment"> * Read atom structure, but not coordinate information.</font>
00207 <font class="comment"> */</font>
<a name="l00208"></a><a class="code" href="pqrplugin_8c.html#a13">00208</a> <font class="keyword">static</font> <font class="keywordtype">int</font> <a class="code" href="pqrplugin_8c.html#a13">read_pqr_structure</a>(<font class="keywordtype">void</font> *mydata, <font class="keywordtype">int</font> *optflags, 
00209     <a class="code" href="structmolfile__atom__t.html">molfile_atom_t</a> *atoms) { 
00210   <a class="code" href="structpqrdata.html">pqrdata</a> *pqr = (<a class="code" href="structpqrdata.html">pqrdata</a> *)mydata;
00211   <a class="code" href="structmolfile__atom__t.html">molfile_atom_t</a> *atom;
00212   <font class="keywordtype">char</font> pqr_record[<a class="code" href="pqrplugin_8c.html#a0">PQR_RECORD_LENGTH</a> + 1];
00213   <font class="keywordtype">int</font> i, record_type;
00214   <font class="keywordtype">char</font> ridstr[8];
00215   <font class="keywordtype">float</font> newpos;
00216   <font class="keywordtype">long</font> fpos = ftell(pqr-&gt;<a class="code" href="structpqrdata.html#m0">fd</a>);
00217  
00218   *optflags = <a class="code" href="molfile__plugin_8h.html#a13">MOLFILE_CHARGE</a> | <a class="code" href="molfile__plugin_8h.html#a14">MOLFILE_RADIUS</a>;
00219 
00220   i = 0;
00221   <font class="keywordflow">do</font> {
00222     record_type = <a class="code" href="pqrplugin_8c.html#a7">read_pqr_record</a>(pqr-&gt;<a class="code" href="structpqrdata.html#m0">fd</a>, pqr_record);
00223     <font class="keywordflow">if</font> ( (record_type == <a class="code" href="pqrplugin_8c.html#a23a5">PQR_EOF</a>) &amp;&amp; (i &lt; pqr-&gt;<a class="code" href="structpqrdata.html#m1">natoms</a>) ) {
00224       fprintf(stderr, <font class="stringliteral">"Unexpected end-of-file.\n"</font>);
00225       <font class="keywordflow">return</font> <a class="code" href="molfile__plugin_8h.html#a4">MOLFILE_ERROR</a>;
00226     } 
00227     <font class="keywordflow">else</font> <font class="keywordflow">if</font> (record_type == <a class="code" href="pqrplugin_8c.html#a23a6">PQR_ERROR</a>) {
00228       fprintf(stderr, <font class="stringliteral">"Error reading atom coordinates.\n"</font>);
00229       <font class="keywordflow">return</font> <a class="code" href="molfile__plugin_8h.html#a4">MOLFILE_ERROR</a>;
00230     }
00231     <font class="keywordflow">else</font> <font class="keywordflow">if</font> (record_type == <a class="code" href="pqrplugin_8c.html#a23a3">PQR_ATOM</a>) {
00232       <font class="keywordflow">if</font> (i &gt;= pqr-&gt;<a class="code" href="structpqrdata.html#m1">natoms</a>) {
00233         fprintf(stderr, <font class="stringliteral">"Too many atoms.\n"</font>);
00234         <font class="keywordflow">return</font> <a class="code" href="molfile__plugin_8h.html#a4">MOLFILE_ERROR</a>;
00235       }
00236       atom = atoms+i;
00237       <a class="code" href="pqrplugin_8c.html#a8">get_pqr_fields</a>(pqr_record, atom-&gt;<a class="code" href="structmolfile__atom__t.html#m0">name</a>, atom-&gt;<a class="code" href="structmolfile__atom__t.html#m2">resname</a>, atom-&gt;<a class="code" href="structmolfile__atom__t.html#m5">chain</a>, 
00238           atom-&gt;<a class="code" href="structmolfile__atom__t.html#m4">segid</a>, ridstr,
00239           &amp;newpos, &amp;newpos, &amp;newpos, &amp;atom-&gt;<a class="code" href="structmolfile__atom__t.html#m11">charge</a>, &amp;atom-&gt;<a class="code" href="structmolfile__atom__t.html#m12">radius</a>);
00240       atom-&gt;<a class="code" href="structmolfile__atom__t.html#m3">resid</a> = atoi(ridstr);
00241       strcpy(atom-&gt;<a class="code" href="structmolfile__atom__t.html#m1">type</a>, atom-&gt;<a class="code" href="structmolfile__atom__t.html#m0">name</a>);
00242       i++;
00243     }
00244     <font class="keywordflow">else</font> {
00245       <font class="comment">/* XXX do stuff */</font>
00246     }
00247   } <font class="keywordflow">while</font>(record_type != <a class="code" href="pqrplugin_8c.html#a23a5">PQR_EOF</a>);
00248 
00249   fseek(pqr-&gt;<a class="code" href="structpqrdata.html#m0">fd</a>, fpos, SEEK_SET);
00250 
00251   <font class="keywordflow">return</font> <a class="code" href="molfile__plugin_8h.html#a2">MOLFILE_SUCCESS</a>;
00252 }
00253 
00254 <font class="comment">/* </font>
00255 <font class="comment"> * Read atom coordinates. PQR files contain only a single "timestep".</font>
00256 <font class="comment"> */</font>
<a name="l00257"></a><a class="code" href="pqrplugin_8c.html#a14">00257</a> <font class="keyword">static</font> <font class="keywordtype">int</font> <a class="code" href="pqrplugin_8c.html#a14">read_pqr_timestep</a>(<font class="keywordtype">void</font> *v, <font class="keywordtype">int</font> natoms, <a class="code" href="structmolfile__timestep__t.html">molfile_timestep_t</a> *ts) {
00258   <a class="code" href="structpqrdata.html">pqrdata</a> *pqr = (<a class="code" href="structpqrdata.html">pqrdata</a> *)v;
00259   <font class="keywordtype">char</font> pqr_record[<a class="code" href="pqrplugin_8c.html#a0">PQR_RECORD_LENGTH</a>+2];
00260   <font class="keywordtype">int</font> record_type, i;
00261   <font class="keywordtype">float</font> *x, *y, *z;
00262 
00263   <font class="keywordflow">if</font> (pqr-&gt;<a class="code" href="structpqrdata.html#m1">natoms</a> == 0) 
00264     <font class="keywordflow">return</font> <a class="code" href="molfile__plugin_8h.html#a4">MOLFILE_ERROR</a>; <font class="comment">/* EOF */</font>
00265   <font class="keywordflow">if</font> (ts) {
00266     x = ts-&gt;<a class="code" href="structmolfile__timestep__t.html#m0">coords</a>;
00267     y = x+1;
00268     z = x+2;
00269   } <font class="keywordflow">else</font> {
00270     x = y = z = 0;
00271   }
00272 
00273   i = 0;
00274   <font class="keywordflow">do</font> {
00275     record_type = <a class="code" href="pqrplugin_8c.html#a7">read_pqr_record</a>(pqr-&gt;<a class="code" href="structpqrdata.html#m0">fd</a>, pqr_record);
00276     <font class="keywordflow">if</font> ( (record_type == <a class="code" href="pqrplugin_8c.html#a23a5">PQR_EOF</a>) &amp;&amp; (i &lt; pqr-&gt;<a class="code" href="structpqrdata.html#m1">natoms</a>) ) {
00277       fprintf(stderr, <font class="stringliteral">"Unexpected end-of-file.\n"</font>);
00278       <font class="keywordflow">return</font> <a class="code" href="molfile__plugin_8h.html#a4">MOLFILE_ERROR</a>;
00279     } 
00280     <font class="keywordflow">else</font> <font class="keywordflow">if</font> (record_type == <a class="code" href="pqrplugin_8c.html#a23a6">PQR_ERROR</a>) {
00281       fprintf(stderr, <font class="stringliteral">"Error reading atom coordinates.\n"</font>);
00282       <font class="keywordflow">return</font> <a class="code" href="molfile__plugin_8h.html#a4">MOLFILE_ERROR</a>;
00283     }
00284     <font class="keywordflow">else</font> <font class="keywordflow">if</font> (record_type == <a class="code" href="pqrplugin_8c.html#a23a3">PQR_ATOM</a>) {
00285       <font class="comment">/* just get the coordinates, and store them */</font>
00286       <font class="keywordflow">if</font> (ts) {
00287         <a class="code" href="pqrplugin_8c.html#a9">get_pqr_coordinates</a>(pqr_record, x, y, z);
00288         x += 3;
00289         y += 3;
00290         z += 3;
00291         i++;
00292       } 
00293     }
00294     <font class="keywordflow">else</font> {
00295       <font class="comment">/* XXX do stuff */</font>
00296     }
00297   } <font class="keywordflow">while</font>(i &lt; pqr-&gt;<a class="code" href="structpqrdata.html#m1">natoms</a>);
00298 
00299   <font class="keywordflow">return</font> <a class="code" href="molfile__plugin_8h.html#a2">MOLFILE_SUCCESS</a>;
00300 }
00301 
<a name="l00302"></a><a class="code" href="pqrplugin_8c.html#a15">00302</a> <font class="keyword">static</font> <font class="keywordtype">void</font> <a class="code" href="pqrplugin_8c.html#a15">close_pqr_read</a>(<font class="keywordtype">void</font> *v) { 
00303   <a class="code" href="structpqrdata.html">pqrdata</a> *pqr = (<a class="code" href="structpqrdata.html">pqrdata</a> *)v;
00304   <font class="keywordflow">if</font> (pqr-&gt;<a class="code" href="structpqrdata.html#m0">fd</a>) {
00305     fclose(pqr-&gt;<a class="code" href="structpqrdata.html#m0">fd</a>);
00306     pqr-&gt;<a class="code" href="structpqrdata.html#m0">fd</a> = 0;
00307   }
00308   free(pqr);
00309 }
00310 
<a name="l00311"></a><a class="code" href="pqrplugin_8c.html#a16">00311</a> <font class="keyword">static</font> <font class="keywordtype">void</font> *<a class="code" href="pqrplugin_8c.html#a16">open_pqr_write</a>(<font class="keyword">const</font> <font class="keywordtype">char</font> *path, <font class="keyword">const</font> <font class="keywordtype">char</font> *filetype, 
00312     <font class="keywordtype">int</font> natoms) {
00313   FILE *fd;
00314   <a class="code" href="structpqrdata.html">pqrdata</a> *pqr;
00315   fd = fopen(path, <font class="stringliteral">"w"</font>);
00316   <font class="keywordflow">if</font> (!fd) {
00317     fprintf(stderr, <font class="stringliteral">"Unable to open file %s for writing\n"</font>, path);
00318     <font class="keywordflow">return</font> NULL;
00319   }
00320 
00321   pqr = (<a class="code" href="structpqrdata.html">pqrdata</a> *)malloc(<font class="keyword">sizeof</font>(<a class="code" href="structpqrdata.html">pqrdata</a>));
00322   pqr-&gt;<a class="code" href="structpqrdata.html#m0">fd</a> = fd;
00323   pqr-&gt;<a class="code" href="structpqrdata.html#m1">natoms</a> = natoms; 
00324   pqr-&gt;<a class="code" href="structpqrdata.html#m2">atomlist</a> = NULL;
00325   <font class="keywordflow">return</font> pqr;
00326 }
00327  
<a name="l00328"></a><a class="code" href="pqrplugin_8c.html#a17">00328</a> <font class="keyword">static</font> <font class="keywordtype">int</font> <a class="code" href="pqrplugin_8c.html#a17">write_pqr_structure</a>(<font class="keywordtype">void</font> *v, <font class="keywordtype">int</font> optflags, 
00329     <font class="keyword">const</font> <a class="code" href="structmolfile__atom__t.html">molfile_atom_t</a> *atoms) {
00330   <font class="keywordtype">int</font> i;
00331   <a class="code" href="structpqrdata.html">pqrdata</a> *pqr = (<a class="code" href="structpqrdata.html">pqrdata</a> *)v;
00332   <font class="keywordtype">int</font> natoms = pqr-&gt;<a class="code" href="structpqrdata.html#m1">natoms</a>;
00333   pqr-&gt;<a class="code" href="structpqrdata.html#m2">atomlist</a> = (<a class="code" href="structmolfile__atom__t.html">molfile_atom_t</a> *)malloc(natoms*<font class="keyword">sizeof</font>(<a class="code" href="structmolfile__atom__t.html">molfile_atom_t</a>));
00334 
00335   memcpy(pqr-&gt;<a class="code" href="structpqrdata.html#m2">atomlist</a>, atoms, natoms*<font class="keyword">sizeof</font>(<a class="code" href="structmolfile__atom__t.html">molfile_atom_t</a>));
00336 
00337   <font class="comment">/* If charge and radius aren't given, we assign defaultvalues. */</font>
00338   <font class="keywordflow">if</font> (!(optflags &amp; <a class="code" href="molfile__plugin_8h.html#a13">MOLFILE_CHARGE</a>)) {
00339     <font class="keywordflow">for</font> (i=0; i&lt;natoms; i++) pqr-&gt;<a class="code" href="structpqrdata.html#m2">atomlist</a>[i].<a class="code" href="structmolfile__atom__t.html#m11">charge</a> = 0.0f;
00340   }
00341   <font class="keywordflow">if</font> (!(optflags &amp; <a class="code" href="molfile__plugin_8h.html#a14">MOLFILE_RADIUS</a>)) {
00342     <font class="keywordflow">for</font> (i=0; i&lt;natoms; i++) pqr-&gt;<a class="code" href="structpqrdata.html#m2">atomlist</a>[i].<a class="code" href="structmolfile__atom__t.html#m12">radius</a> = 
00343       <a class="code" href="pqrplugin_8c.html#a10">get_atom_radius</a>(&amp;(pqr-&gt;<a class="code" href="structpqrdata.html#m2">atomlist</a>[i]));
00344   }
00345 
00346   <font class="keywordflow">return</font> <a class="code" href="molfile__plugin_8h.html#a2">MOLFILE_SUCCESS</a>;
00347 }
00348 
<a name="l00349"></a><a class="code" href="pqrplugin_8c.html#a18">00349</a> <font class="keyword">static</font> <font class="keywordtype">int</font> <a class="code" href="pqrplugin_8c.html#a18">write_pqr_timestep</a>(<font class="keywordtype">void</font> *v, <font class="keyword">const</font> <a class="code" href="structmolfile__timestep__t.html">molfile_timestep_t</a> *ts) {
00350   <a class="code" href="structpqrdata.html">pqrdata</a> *pqr = (<a class="code" href="structpqrdata.html">pqrdata</a> *)v; 
00351   <font class="keyword">const</font> <a class="code" href="structmolfile__atom__t.html">molfile_atom_t</a> *atom;
00352   <font class="keyword">const</font> <font class="keywordtype">float</font> *pos;
00353   <font class="keywordtype">int</font> i;
00354 
00355   <font class="keywordflow">if</font> (pqr-&gt;<a class="code" href="structpqrdata.html#m1">natoms</a> == 0)
00356     <font class="keywordflow">return</font> <a class="code" href="molfile__plugin_8h.html#a2">MOLFILE_SUCCESS</a>;
00357 
00358   atom = pqr-&gt;<a class="code" href="structpqrdata.html#m2">atomlist</a>;
00359   pos = ts-&gt;<a class="code" href="structmolfile__timestep__t.html#m0">coords</a>;
00360   <font class="keywordflow">for</font> (i=0; i&lt;pqr-&gt;<a class="code" href="structpqrdata.html#m1">natoms</a>; i++) {
00361     <font class="keywordflow">if</font> (!<a class="code" href="pqrplugin_8c.html#a11">write_pqr_atom</a>(pqr-&gt;<a class="code" href="structpqrdata.html#m0">fd</a>, i+1, atom, pos[0], pos[1], pos[2])) {
00362       fprintf(stderr, 
00363         <font class="stringliteral">"PQR: Error encoutered writing atom %d; file may be incomplete.\n"</font>, 
00364         i+1);
00365       <font class="keywordflow">return</font> <a class="code" href="molfile__plugin_8h.html#a4">MOLFILE_ERROR</a>;
00366     }
00367     atom++;
00368     pos += 3;
00369   }
00370 
00371   <font class="keywordflow">return</font> <a class="code" href="molfile__plugin_8h.html#a2">MOLFILE_SUCCESS</a>;
00372 }
00373  
<a name="l00374"></a><a class="code" href="pqrplugin_8c.html#a19">00374</a> <font class="keyword">static</font> <font class="keywordtype">void</font> <a class="code" href="pqrplugin_8c.html#a19">close_pqr_write</a>(<font class="keywordtype">void</font> *v) {
00375   <a class="code" href="structpqrdata.html">pqrdata</a> *pqr = (<a class="code" href="structpqrdata.html">pqrdata</a> *)v; 
00376   fclose(pqr-&gt;<a class="code" href="structpqrdata.html#m0">fd</a>);
00377   free(pqr-&gt;<a class="code" href="structpqrdata.html#m2">atomlist</a>);
00378   free(pqr);
00379 }
00380 
00381 <font class="comment">/*</font>
00382 <font class="comment"> * Initialization stuff down here</font>
00383 <font class="comment"> */</font>
00384 
<a name="l00385"></a><a class="code" href="pqrplugin_8c.html#a1">00385</a> <font class="keyword">static</font> <a class="code" href="structmolfile__plugin__t.html">molfile_plugin_t</a> <a class="code" href="pqrplugin_8c.html#a1">plugin</a> = {
00386   <a class="code" href="vmdplugin_8h.html#a10">vmdplugin_ABIVERSION</a>,         <font class="comment">/* ABI version */</font>
00387   <a class="code" href="molfile__plugin_8h.html#a0">MOLFILE_PLUGIN_TYPE</a>,          <font class="comment">/* type */</font>
00388   <font class="stringliteral">"pqr"</font>,                        <font class="comment">/* short name */</font>
00389   <font class="stringliteral">"PQR"</font>,                        <font class="comment">/* pretty name */</font>
00390   <font class="stringliteral">"Eamon Caddigan"</font>,             <font class="comment">/* author */</font>
00391   0,                            <font class="comment">/* major version */</font>
00392   1,                            <font class="comment">/* minor version */</font>
00393   <a class="code" href="vmdplugin_8h.html#a12">VMDPLUGIN_THREADSAFE</a>,         <font class="comment">/* is_reentrant */</font>
00394   <font class="stringliteral">"pqr"</font>,                        <font class="comment">/* filename extension */</font>
00395   <a class="code" href="pqrplugin_8c.html#a12">open_pqr_read</a>,
00396   <a class="code" href="pqrplugin_8c.html#a13">read_pqr_structure</a>,
00397   0,
00398   <a class="code" href="pqrplugin_8c.html#a14">read_pqr_timestep</a>,
00399   <a class="code" href="pqrplugin_8c.html#a15">close_pqr_read</a>,
00400   <a class="code" href="pqrplugin_8c.html#a16">open_pqr_write</a>,
00401   <a class="code" href="pqrplugin_8c.html#a17">write_pqr_structure</a>,
00402   <a class="code" href="pqrplugin_8c.html#a18">write_pqr_timestep</a>,
00403   <a class="code" href="pqrplugin_8c.html#a19">close_pqr_write</a>
00404 };
00405  
<a name="l00406"></a><a class="code" href="pqrplugin_8c.html#a20">00406</a> <a class="code" href="vmdplugin_8h.html#a7">VMDPLUGIN_API</a> <font class="keywordtype">int</font> <a class="code" href="vmdplugin_8h.html#a5">VMDPLUGIN_init</a>() {
00407   <font class="keywordflow">return</font> <a class="code" href="vmdplugin_8h.html#a13">VMDPLUGIN_SUCCESS</a>;
00408 }
00409 
<a name="l00410"></a><a class="code" href="pqrplugin_8c.html#a21">00410</a> <a class="code" href="vmdplugin_8h.html#a7">VMDPLUGIN_API</a> <font class="keywordtype">int</font> <a class="code" href="vmdplugin_8h.html#a3">VMDPLUGIN_register</a>(<font class="keywordtype">void</font> *v, <a class="code" href="vmdplugin_8h.html#a15">vmdplugin_register_cb</a> cb) {
00411   (*cb)(v, (<a class="code" href="structvmdplugin__t.html">vmdplugin_t</a> *)&amp;plugin);
00412   <font class="keywordflow">return</font> <a class="code" href="vmdplugin_8h.html#a13">VMDPLUGIN_SUCCESS</a>;
00413 }
00414 
<a name="l00415"></a><a class="code" href="pqrplugin_8c.html#a22">00415</a> <a class="code" href="vmdplugin_8h.html#a7">VMDPLUGIN_API</a> <font class="keywordtype">int</font> <a class="code" href="vmdplugin_8h.html#a6">VMDPLUGIN_fini</a>() {
00416   <font class="keywordflow">return</font> <a class="code" href="vmdplugin_8h.html#a13">VMDPLUGIN_SUCCESS</a>;
00417 }
00418 
</pre></div><hr><address><small>Generated on Wed Mar 22 13:15:31 2006 for VMD Plugins (current) by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.gif" alt="doxygen" align="middle" border=0 
width=110 height=53></a>1.2.14 written by <a href="mailto:dimitri@stack.nl">Dimitri van Heesch</a>,
 &copy;&nbsp;1997-2002</small></address>
</body>
</html>
