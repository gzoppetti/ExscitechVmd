<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>fs4plugin.C Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.2.14 -->
<center>
<a class="qindex" href="index.html">Main Page</a> &nbsp; <a class="qindex" href="classes.html">Alphabetical List</a> &nbsp; <a class="qindex" href="annotated.html">Compound List</a> &nbsp; <a class="qindex" href="files.html">File List</a> &nbsp; <a class="qindex" href="functions.html">Compound Members</a> &nbsp; <a class="qindex" href="globals.html">File Members</a> &nbsp; <a class="qindex" href="pages.html">Related Pages</a> &nbsp; </center>
<hr><h1>fs4plugin.C</h1><a href="fs4plugin_8C.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 <font class="comment">/***************************************************************************</font>
00002 <font class="comment"> *cr</font>
00003 <font class="comment"> *cr            (C) Copyright 1995-2006 The Board of Trustees of the</font>
00004 <font class="comment"> *cr                        University of Illinois</font>
00005 <font class="comment"> *cr                         All Rights Reserved</font>
00006 <font class="comment"> *cr</font>
00007 <font class="comment"> ***************************************************************************/</font>
00008 
00009 <font class="comment">/***************************************************************************</font>
00010 <font class="comment"> * RCS INFORMATION:</font>
00011 <font class="comment"> *</font>
00012 <font class="comment"> *      $RCSfile: fs4plugin.C,v $</font>
00013 <font class="comment"> *      $Author: johns $       $Locker:  $             $State: Exp $</font>
00014 <font class="comment"> *      $Revision: 1.18 $       $Date: 2006/02/23 19:36:44 $</font>
00015 <font class="comment"> *</font>
00016 <font class="comment"> ***************************************************************************/</font>
00017 
00018 <font class="comment">/* </font>
00019 <font class="comment"> * fsfour format density maps</font>
00020 <font class="comment"> *</font>
00021 <font class="comment"> * More info for this format can be found at </font>
00022 <font class="comment"> * &lt;http://www.csb.yale.edu/userguides/datamanip/phases/FSFOUR.html&gt;</font>
00023 <font class="comment"> *</font>
00024 <font class="comment"> * Old versions of the cns2fsfour and ccp2fsfour utilities produced a</font>
00025 <font class="comment"> * slightly broken variant of this format, omitting the data that isn't used</font>
00026 <font class="comment"> * by XTalView. This plugin currently reads these files, but the cell</font>
00027 <font class="comment"> * dimensions will be incorrect.</font>
00028 <font class="comment"> *</font>
00029 <font class="comment"> */</font>
00030 
00031 <font class="preprocessor">#include &lt;stdlib.h&gt;</font>
00032 <font class="preprocessor">#include &lt;stdio.h&gt;</font>
00033 <font class="preprocessor">#include &lt;ctype.h&gt;</font>
00034 <font class="preprocessor">#include &lt;math.h&gt;</font>
00035 <font class="preprocessor">#include &lt;string.h&gt;</font>
00036 
00037 <font class="preprocessor">#if defined(_AIX)</font>
00038 <font class="preprocessor"></font><font class="preprocessor">#include &lt;strings.h&gt;</font>
00039 <font class="preprocessor">#endif</font>
00040 <font class="preprocessor"></font>
00041 <font class="preprocessor">#include "<a class="code" href="molfile__plugin_8h.html">molfile_plugin.h</a>"</font>
00042 <font class="preprocessor">#include "<a class="code" href="endianswap_8h.html">endianswap.h</a>"</font>
00043 <font class="preprocessor">#include "<a class="code" href="fortread_8h.html">fortread.h</a>"</font>
00044 
00045 <font class="preprocessor">#ifndef M_PI</font>
<a name="l00046"></a><a class="code" href="fs4plugin_8C.html#a0">00046</a> <font class="preprocessor"></font><font class="preprocessor">#define M_PI 3.14159265358979323846</font>
00047 <font class="preprocessor"></font><font class="preprocessor">#endif</font>
00048 <font class="preprocessor"></font>
<a name="l00049"></a><a class="code" href="structfs4__t.html">00049</a> <font class="keyword">typedef</font> <font class="keyword">struct </font>{
<a name="l00050"></a><a class="code" href="structfs4__t.html#m0">00050</a>   FILE *fd;
<a name="l00051"></a><a class="code" href="structfs4__t.html#m1">00051</a>   <font class="keywordtype">int</font> nsets;
<a name="l00052"></a><a class="code" href="structfs4__t.html#m2">00052</a>   <font class="keywordtype">int</font> swap;
<a name="l00053"></a><a class="code" href="structfs4__t.html#m8">00053</a>   <font class="keywordtype">int</font> f, m, s, x, y, z; <font class="comment">// indecies mapping fast-medium-slow to x-y-z</font>
<a name="l00054"></a><a class="code" href="structfs4__t.html#m9">00054</a>   <font class="keywordtype">float</font> scale;
<a name="l00055"></a><a class="code" href="structfs4__t.html#m10">00055</a>   <a class="code" href="structmolfile__volumetric__t.html">molfile_volumetric_t</a> *vol;
00056 } <a class="code" href="structfs4__t.html">fs4_t</a>;
00057 
00058 
<a name="l00059"></a><a class="code" href="fs4plugin_8C.html#a2">00059</a> <font class="keyword">static</font> <font class="keywordtype">void</font> *<a class="code" href="fs4plugin_8C.html#a2">open_fs4_read</a>(<font class="keyword">const</font> <font class="keywordtype">char</font> *filepath, <font class="keyword">const</font> <font class="keywordtype">char</font> *filetype,
00060     <font class="keywordtype">int</font> *natoms) {
00061   <a class="code" href="structfs4__t.html">fs4_t</a> *fs4;
00062   FILE *fd;
00063   <font class="keywordtype">float</font> header[32], scale, fmsCellSize[3], alpha, beta, gamma, z1, z2, z3;
00064   <font class="keywordtype">int</font> dataBegin, blocksize, geom[16], fmsGridSize[3], norn, swap=0;
00065 
00066   fd = fopen(filepath, <font class="stringliteral">"rb"</font>);
00067   <font class="keywordflow">if</font> (!fd) {
00068     fprintf(stderr, <font class="stringliteral">"Error opening file.\n"</font>);
00069     <font class="keywordflow">return</font> NULL;
00070   }
00071 
00072   <font class="comment">// Use the first four-byte integer in the file to determine the file's</font>
00073   <font class="comment">// byte-order</font>
00074   fread(&amp;dataBegin, <font class="keyword">sizeof</font>(<font class="keywordtype">int</font>), 1, fd);
00075   <font class="keywordflow">if</font> (dataBegin &gt; 255) {
00076     <font class="comment">// check if the bytes need to be swapped</font>
00077     <a class="code" href="endianswap_8h.html#a4">swap4_aligned</a>(&amp;dataBegin, 1);
00078     <font class="keywordflow">if</font> (dataBegin &lt;= 255) {
00079       swap = 1;
00080     } <font class="keywordflow">else</font> {
00081       fprintf(stderr, <font class="stringliteral">"Cannot read file: header block is too large.\n"</font>);
00082       <font class="keywordflow">return</font> NULL;
00083     }
00084   }
00085 
00086   <font class="comment">// Read the header</font>
00087   rewind(fd);
00088   blocksize = <a class="code" href="fortread_8h.html#a0">fortread_4</a>(header, 32, swap, fd);
00089 
00090   <font class="comment">// Handle files produced by old versions of (cns|ccp)2fsfour</font>
00091   <font class="keywordflow">if</font> (blocksize == 28) {
00092     printf(<font class="stringliteral">"Recognized %s cns2fsfour map.\n"</font>, 
00093         swap ? <font class="stringliteral">"opposite-endian"</font> : <font class="stringliteral">"same-endian"</font>);
00094 
00095     <font class="comment">// Read the geometry block</font>
00096     blocksize = <a class="code" href="fortread_8h.html#a0">fortread_4</a>(geom, 16, swap, fd);
00097     <font class="keywordflow">if</font> (blocksize != 7) {
00098       fprintf(stderr, <font class="stringliteral">"Incorrect size for geometry block.\n"</font>);
00099       <font class="keywordflow">return</font> NULL;
00100     }
00101 
00102     fmsGridSize[0] = geom[0];
00103     fmsGridSize[1] = geom[1];
00104     fmsGridSize[2] = geom[2];
00105     norn = geom[4];
00106 
00107     <font class="comment">// Warn about assumptions</font>
00108     printf(<font class="stringliteral">"Warning: file does not contain unit cell lengths or angles.\n"</font>);
00109 
00110     scale = 50.0;
00111     fmsCellSize[0] = 1.0;
00112     fmsCellSize[1] = 1.0;
00113     fmsCellSize[2] = 1.0;
00114     alpha = 90.0;
00115     beta = 90.0;
00116     gamma = 90.0;
00117   }
00118 
00119   <font class="comment">// Handle standard fsfour files</font>
00120   <font class="keywordflow">else</font> <font class="keywordflow">if</font> (blocksize == 31) {
00121     printf(<font class="stringliteral">"Recognize standard fsfour map.\n"</font>);
00122 
00123     fmsCellSize[0] = header[21];
00124     fmsCellSize[1] = header[22];
00125     fmsCellSize[2] = header[23];
00126     alpha = header[24];
00127     beta = header[25];
00128     gamma = header[26];
00129     
00130     <font class="comment">// Skip the symmetry block if one present</font>
00131     blocksize = <a class="code" href="fortread_8h.html#a0">fortread_4</a>(geom, 16, swap, fd);
00132     <font class="keywordflow">if</font> (blocksize == 9) {
00133       printf(<font class="stringliteral">"Skipping symmetry block.\n"</font>);
00134       blocksize = <a class="code" href="fortread_8h.html#a0">fortread_4</a>(geom, 16, swap, fd);
00135     }
00136 
00137     <font class="comment">// Read the geometry block</font>
00138     <font class="keywordflow">if</font> (blocksize != 13) {
00139       fprintf(stderr, <font class="stringliteral">"Incorrect size for geometry block.\n"</font>);
00140       <font class="keywordflow">return</font> NULL;
00141     }
00142 
00143     fmsGridSize[0] = geom[0];
00144     fmsGridSize[1] = geom[1];
00145     fmsGridSize[2] = geom[2];
00146 
00147     scale = *((<font class="keywordtype">float</font> *) geom + 3);
00148     <font class="keywordflow">if</font> (scale == 0) {
00149       scale = 50;
00150     }
00151 
00152     norn = geom[4];
00153     <font class="keywordflow">if</font> ((norn &lt; 0) || (norn &gt; 2)) {
00154       fprintf(stderr, <font class="stringliteral">"norn out of range.\n"</font>);
00155       <font class="keywordflow">return</font> NULL;
00156     }
00157   }
00158 
00159   <font class="comment">// Unrecognized format</font>
00160   <font class="keywordflow">else</font> {
00161     fprintf(stderr, <font class="stringliteral">"Unrecognized map format.\n"</font>);
00162     <font class="keywordflow">return</font> NULL;
00163   }
00164 
00165   <font class="comment">// Convert degrees to radians</font>
00166   alpha *= <a class="code" href="fs4plugin_8C.html#a0">M_PI</a> / 180.0;
00167   beta  *= <a class="code" href="fs4plugin_8C.html#a0">M_PI</a> / 180.0;
00168   gamma *= <a class="code" href="fs4plugin_8C.html#a0">M_PI</a> / 180.0;
00169 
00170   <font class="comment">// Warn about assumptions</font>
00171   printf(<font class="stringliteral">"Warning: file does not contain molecule center.\nCentering at &lt;0, 0, 0&gt;\n"</font>);
00172 
00173   <font class="comment">// Allocate and initialize the fs4 structure</font>
00174   fs4 = <font class="keyword">new</font> <a class="code" href="structfs4__t.html">fs4_t</a>;
00175   fs4-&gt;<a class="code" href="structfs4__t.html#m0">fd</a> = fd;
00176   fs4-&gt;<a class="code" href="structfs4__t.html#m10">vol</a> = NULL;
00177   *natoms = <a class="code" href="molfile__plugin_8h.html#a7">MOLFILE_NUMATOMS_NONE</a>;
00178   fs4-&gt;<a class="code" href="structfs4__t.html#m1">nsets</a> = 1; <font class="comment">// this file contains only one data set</font>
00179   fs4-&gt;<a class="code" href="structfs4__t.html#m2">swap</a> = swap;
00180   fs4-&gt;<a class="code" href="structfs4__t.html#m9">scale</a> = scale;
00181   <font class="keywordflow">if</font> (norn == 0) {
00182     <font class="comment">// x fast, z medium, y slow</font>
00183     fs4-&gt;<a class="code" href="structfs4__t.html#m6">x</a> = 0;
00184     fs4-&gt;<a class="code" href="structfs4__t.html#m7">y</a> = 2;
00185     fs4-&gt;<a class="code" href="structfs4__t.html#m8">z</a> = 1;
00186     fs4-&gt;<a class="code" href="structfs4__t.html#m3">f</a> = 0;
00187     fs4-&gt;<a class="code" href="structfs4__t.html#m4">m</a> = 2;
00188     fs4-&gt;<a class="code" href="structfs4__t.html#m5">s</a> = 1;
00189   }
00190   <font class="keywordflow">else</font> <font class="keywordflow">if</font> (norn == 1) {
00191     <font class="comment">// y fast, z medium, x slow</font>
00192     fs4-&gt;<a class="code" href="structfs4__t.html#m6">x</a> = 2;
00193     fs4-&gt;<a class="code" href="structfs4__t.html#m7">y</a> = 0;
00194     fs4-&gt;<a class="code" href="structfs4__t.html#m8">z</a> = 1;
00195     fs4-&gt;<a class="code" href="structfs4__t.html#m3">f</a> = 1;
00196     fs4-&gt;<a class="code" href="structfs4__t.html#m4">m</a> = 2;
00197     fs4-&gt;<a class="code" href="structfs4__t.html#m5">s</a> = 0;
00198   }
00199   <font class="keywordflow">else</font> { <font class="comment">// norn ==2</font>
00200     <font class="comment">// x fast, y medium, z slow</font>
00201     fs4-&gt;<a class="code" href="structfs4__t.html#m6">x</a> = 0;
00202     fs4-&gt;<a class="code" href="structfs4__t.html#m7">y</a> = 1;
00203     fs4-&gt;<a class="code" href="structfs4__t.html#m8">z</a> = 2;
00204     fs4-&gt;<a class="code" href="structfs4__t.html#m3">f</a> = 0;
00205     fs4-&gt;<a class="code" href="structfs4__t.html#m4">m</a> = 1;
00206     fs4-&gt;<a class="code" href="structfs4__t.html#m5">s</a> = 2;
00207   }
00208 
00209   fs4-&gt;<a class="code" href="structfs4__t.html#m10">vol</a> = <font class="keyword">new</font> <a class="code" href="structmolfile__volumetric__t.html">molfile_volumetric_t</a>[1];
00210   strcpy(fs4-&gt;<a class="code" href="structfs4__t.html#m10">vol</a>[0].<a class="code" href="structmolfile__volumetric__t.html#m0">dataname</a>, <font class="stringliteral">"Fsfour Electron Density Map"</font>);
00211 
00212   <font class="comment">// Place the origin at {0 0 0}</font>
00213   fs4-&gt;<a class="code" href="structfs4__t.html#m10">vol</a>[0].<a class="code" href="structmolfile__volumetric__t.html#m1">origin</a>[0] = 0.0;
00214   fs4-&gt;<a class="code" href="structfs4__t.html#m10">vol</a>[0].<a class="code" href="structmolfile__volumetric__t.html#m1">origin</a>[1] = 0.0;
00215   fs4-&gt;<a class="code" href="structfs4__t.html#m10">vol</a>[0].<a class="code" href="structmolfile__volumetric__t.html#m1">origin</a>[2] = 0.0;
00216 
00217   fs4-&gt;<a class="code" href="structfs4__t.html#m10">vol</a>[0].<a class="code" href="structmolfile__volumetric__t.html#m2">xaxis</a>[0] = fmsCellSize[0];
00218   fs4-&gt;<a class="code" href="structfs4__t.html#m10">vol</a>[0].<a class="code" href="structmolfile__volumetric__t.html#m2">xaxis</a>[1] = 0.0;
00219   fs4-&gt;<a class="code" href="structfs4__t.html#m10">vol</a>[0].<a class="code" href="structmolfile__volumetric__t.html#m2">xaxis</a>[2] = 0.0;
00220 
00221   fs4-&gt;<a class="code" href="structfs4__t.html#m10">vol</a>[0].<a class="code" href="structmolfile__volumetric__t.html#m3">yaxis</a>[0] = cos(gamma) * fmsCellSize[1];
00222   fs4-&gt;<a class="code" href="structfs4__t.html#m10">vol</a>[0].<a class="code" href="structmolfile__volumetric__t.html#m3">yaxis</a>[1] = sin(gamma) * fmsCellSize[1];
00223   fs4-&gt;<a class="code" href="structfs4__t.html#m10">vol</a>[0].<a class="code" href="structmolfile__volumetric__t.html#m3">yaxis</a>[2] = 0.0;
00224  
00225   z1 = cos(beta);
00226   z2 = (cos(alpha) - cos(beta)*cos(gamma)) / sin(gamma);
00227   z3 = sqrt(1.0 - z1*z1 - z2*z2);
00228   fs4-&gt;<a class="code" href="structfs4__t.html#m10">vol</a>[0].<a class="code" href="structmolfile__volumetric__t.html#m4">zaxis</a>[0] = z1 * fmsCellSize[2];
00229   fs4-&gt;<a class="code" href="structfs4__t.html#m10">vol</a>[0].<a class="code" href="structmolfile__volumetric__t.html#m4">zaxis</a>[1] = z2 * fmsCellSize[2];
00230   fs4-&gt;<a class="code" href="structfs4__t.html#m10">vol</a>[0].<a class="code" href="structmolfile__volumetric__t.html#m4">zaxis</a>[2] = z3 * fmsCellSize[2];
00231 
00232   fs4-&gt;<a class="code" href="structfs4__t.html#m10">vol</a>[0].<a class="code" href="structmolfile__volumetric__t.html#m5">xsize</a> = fmsGridSize[fs4-&gt;<a class="code" href="structfs4__t.html#m6">x</a>];
00233   fs4-&gt;<a class="code" href="structfs4__t.html#m10">vol</a>[0].<a class="code" href="structmolfile__volumetric__t.html#m6">ysize</a> = fmsGridSize[fs4-&gt;<a class="code" href="structfs4__t.html#m7">y</a>];
00234   fs4-&gt;<a class="code" href="structfs4__t.html#m10">vol</a>[0].<a class="code" href="structmolfile__volumetric__t.html#m7">zsize</a> = fmsGridSize[fs4-&gt;<a class="code" href="structfs4__t.html#m8">z</a>];
00235 
00236   fs4-&gt;<a class="code" href="structfs4__t.html#m10">vol</a>[0].<a class="code" href="structmolfile__volumetric__t.html#m8">has_color</a> = 0;
00237 
00238   <font class="keywordflow">return</font> fs4;
00239 }
00240 
00241 
<a name="l00242"></a><a class="code" href="fs4plugin_8C.html#a3">00242</a> <font class="keyword">static</font> <font class="keywordtype">int</font> <a class="code" href="fs4plugin_8C.html#a3">read_fs4_metadata</a>(<font class="keywordtype">void</font> *v, <font class="keywordtype">int</font> *nsets, 
00243   <a class="code" href="structmolfile__volumetric__t.html">molfile_volumetric_t</a> **metadata) {
00244   <a class="code" href="structfs4__t.html">fs4_t</a> *fs4 = (<a class="code" href="structfs4__t.html">fs4_t</a> *)v;
00245   *nsets = fs4-&gt;<a class="code" href="structfs4__t.html#m1">nsets</a>; 
00246   *metadata = fs4-&gt;<a class="code" href="structfs4__t.html#m10">vol</a>;  
00247 
00248   <font class="keywordflow">return</font> <a class="code" href="molfile__plugin_8h.html#a2">MOLFILE_SUCCESS</a>;
00249 }
00250 
00251 
<a name="l00252"></a><a class="code" href="fs4plugin_8C.html#a4">00252</a> <font class="keyword">static</font> <font class="keywordtype">int</font> <a class="code" href="fs4plugin_8C.html#a4">read_fs4_data</a>(<font class="keywordtype">void</font> *v, <font class="keywordtype">int</font> set, <font class="keywordtype">float</font> *dstBlock, 
00253                          <font class="keywordtype">float</font> *colorblock) {
00254   <a class="code" href="structfs4__t.html">fs4_t</a> *fs4 = (<a class="code" href="structfs4__t.html">fs4_t</a> *) v;
00255   <font class="keywordtype">int</font> *srcBlock, index;
00256   <font class="keywordtype">int</font> col, row, plane, colSize, rowSize, planeSize;
00257   <font class="keywordtype">int</font> xyzGridSize[3], xyzIndexIncrement[3];
00258 
00259   xyzGridSize[0] = fs4-&gt;<a class="code" href="structfs4__t.html#m10">vol</a>[0].<a class="code" href="structmolfile__volumetric__t.html#m5">xsize</a>;
00260   xyzGridSize[1] = fs4-&gt;<a class="code" href="structfs4__t.html#m10">vol</a>[0].<a class="code" href="structmolfile__volumetric__t.html#m6">ysize</a>;
00261   xyzGridSize[2] = fs4-&gt;<a class="code" href="structfs4__t.html#m10">vol</a>[0].<a class="code" href="structmolfile__volumetric__t.html#m7">zsize</a>;
00262   xyzIndexIncrement[0] = 1;
00263   xyzIndexIncrement[1] = xyzGridSize[0];
00264   xyzIndexIncrement[2] = xyzGridSize[0] * xyzGridSize[1];
00265 
00266   colSize = xyzGridSize[fs4-&gt;<a class="code" href="structfs4__t.html#m3">f</a>];
00267   rowSize = xyzGridSize[fs4-&gt;<a class="code" href="structfs4__t.html#m4">m</a>];
00268   planeSize = xyzGridSize[fs4-&gt;<a class="code" href="structfs4__t.html#m5">s</a>];
00269 
00270   srcBlock = <font class="keyword">new</font> <font class="keywordtype">int</font>[colSize];
00271 
00272   index = 0;
00273   <font class="keywordflow">for</font> (plane = 0; plane &lt; planeSize; plane++) {
00274     <font class="keywordflow">for</font> (row = 0; row &lt; rowSize; row++) {
00275 
00276       <font class="comment">// Read one row of data</font>
00277       <font class="keywordflow">if</font> (<a class="code" href="fortread_8h.html#a0">fortread_4</a>(srcBlock, colSize, fs4-&gt;<a class="code" href="structfs4__t.html#m2">swap</a>, fs4-&gt;<a class="code" href="structfs4__t.html#m0">fd</a>) != colSize) {
00278         fprintf(stderr, <font class="stringliteral">"Error reading data: incorrect record size.\n"</font>);
00279         <font class="keyword">delete</font> [] srcBlock;
00280         <font class="keywordflow">return</font> <a class="code" href="molfile__plugin_8h.html#a4">MOLFILE_ERROR</a>;
00281       }
00282 
00283       <font class="keywordflow">for</font> (col = 0; col &lt; colSize; col++) {
00284         dstBlock[index] = (float) srcBlock[col] / fs4-&gt;<a class="code" href="structfs4__t.html#m9">scale</a>;
00285         index += xyzIndexIncrement[fs4-&gt;<a class="code" href="structfs4__t.html#m3">f</a>];
00286       }
00287 
00288       index += xyzIndexIncrement[fs4-&gt;<a class="code" href="structfs4__t.html#m4">m</a>] - colSize*xyzIndexIncrement[fs4-&gt;<a class="code" href="structfs4__t.html#m3">f</a>];
00289     } <font class="comment">// end for (row)</font>
00290 
00291     index += xyzIndexIncrement[fs4-&gt;<a class="code" href="structfs4__t.html#m5">s</a>] - rowSize*xyzIndexIncrement[fs4-&gt;<a class="code" href="structfs4__t.html#m4">m</a>];
00292   } <font class="comment">// end for (plane)</font>
00293 
00294   <font class="keyword">delete</font> [] srcBlock;
00295   <font class="keywordflow">return</font> <a class="code" href="molfile__plugin_8h.html#a2">MOLFILE_SUCCESS</a>;
00296 }
00297 
<a name="l00298"></a><a class="code" href="fs4plugin_8C.html#a5">00298</a> <font class="keyword">static</font> <font class="keywordtype">void</font> <a class="code" href="fs4plugin_8C.html#a5">close_fs4_read</a>(<font class="keywordtype">void</font> *v) {
00299   <a class="code" href="structfs4__t.html">fs4_t</a> *fs4 = (<a class="code" href="structfs4__t.html">fs4_t</a> *)v;
00300 
00301   fclose(fs4-&gt;<a class="code" href="structfs4__t.html#m0">fd</a>);
00302   <font class="keywordflow">if</font> (fs4-&gt;<a class="code" href="structfs4__t.html#m10">vol</a> != NULL)
00303     <font class="keyword">delete</font> [] fs4-&gt;<a class="code" href="structfs4__t.html#m10">vol</a>; 
00304   <font class="keyword">delete</font> fs4;
00305 }
00306 
00307 <font class="comment">/*</font>
00308 <font class="comment"> * Initialization stuff here</font>
00309 <font class="comment"> */</font>
<a name="l00310"></a><a class="code" href="fs4plugin_8C.html#a1">00310</a> <font class="keyword">static</font> <a class="code" href="structmolfile__plugin__t.html">molfile_plugin_t</a> <a class="code" href="fs4plugin_8C.html#a1">plugin</a> = {
00311   <a class="code" href="vmdplugin_8h.html#a10">vmdplugin_ABIVERSION</a>,   <font class="comment">// ABI version</font>
00312   <a class="code" href="molfile__plugin_8h.html#a0">MOLFILE_PLUGIN_TYPE</a>,    <font class="comment">// plugin type</font>
00313   <font class="stringliteral">"fs"</font>,                   <font class="comment">// short file format description</font>
00314   <font class="stringliteral">"FS4 Density Map"</font>,      <font class="comment">// pretty file format description</font>
00315   <font class="stringliteral">"Eamon Caddigan"</font>,       <font class="comment">// author(s)</font>
00316   0,                      <font class="comment">// major version</font>
00317   5,                      <font class="comment">// minor version</font>
00318   <a class="code" href="vmdplugin_8h.html#a12">VMDPLUGIN_THREADSAFE</a>,   <font class="comment">// is reentrant</font>
00319   <font class="stringliteral">"fs,fs4"</font>                <font class="comment">// filename extension</font>
00320 };
00321 
<a name="l00322"></a><a class="code" href="fs4plugin_8C.html#a6">00322</a> <a class="code" href="vmdplugin_8h.html#a7">VMDPLUGIN_API</a> <font class="keywordtype">int</font> <a class="code" href="vmdplugin_8h.html#a5">VMDPLUGIN_init</a>(<font class="keywordtype">void</font>) { <font class="keywordflow">return</font> <a class="code" href="vmdplugin_8h.html#a13">VMDPLUGIN_SUCCESS</a>; }
<a name="l00323"></a><a class="code" href="fs4plugin_8C.html#a7">00323</a> <a class="code" href="vmdplugin_8h.html#a7">VMDPLUGIN_API</a> <font class="keywordtype">int</font> <a class="code" href="vmdplugin_8h.html#a6">VMDPLUGIN_fini</a>(<font class="keywordtype">void</font>) { <font class="keywordflow">return</font> <a class="code" href="vmdplugin_8h.html#a13">VMDPLUGIN_SUCCESS</a>; }
<a name="l00324"></a><a class="code" href="fs4plugin_8C.html#a8">00324</a> <a class="code" href="vmdplugin_8h.html#a7">VMDPLUGIN_API</a> <font class="keywordtype">int</font> <a class="code" href="vmdplugin_8h.html#a3">VMDPLUGIN_register</a>(<font class="keywordtype">void</font> *v, <a class="code" href="vmdplugin_8h.html#a15">vmdplugin_register_cb</a> cb) {
00325   plugin.<a class="code" href="structmolfile__plugin__t.html#m1">open_file_read</a> = <a class="code" href="fs4plugin_8C.html#a2">open_fs4_read</a>;
00326   plugin.<a class="code" href="structmolfile__plugin__t.html#m10">read_volumetric_metadata</a> = <a class="code" href="fs4plugin_8C.html#a3">read_fs4_metadata</a>;
00327   plugin.<a class="code" href="structmolfile__plugin__t.html#m11">read_volumetric_data</a> = <a class="code" href="fs4plugin_8C.html#a4">read_fs4_data</a>;
00328   plugin.<a class="code" href="structmolfile__plugin__t.html#m5">close_file_read</a> = <a class="code" href="fs4plugin_8C.html#a5">close_fs4_read</a>;
00329   (*cb)(v, (<a class="code" href="structvmdplugin__t.html">vmdplugin_t</a> *)&amp;plugin);
00330   <font class="keywordflow">return</font> <a class="code" href="vmdplugin_8h.html#a13">VMDPLUGIN_SUCCESS</a>;
00331 }
00332 
00333 <font class="preprocessor">#ifdef TEST_FS4_PLUGIN</font>
00334 <font class="preprocessor"></font>
00335 <font class="keywordtype">int</font> <a class="code" href="main_8c.html#a3">main</a>(<font class="keywordtype">int</font> argc, <font class="keywordtype">char</font> **argv) {
00336   <a class="code" href="structfs4__t.html">fs4_t</a> *fs4;
00337   <font class="keywordtype">int</font> natoms;
00338   <font class="keywordtype">char</font> *filetype;
00339   <font class="keywordtype">float</font> *datablock;
00340   
00341   <font class="keywordflow">while</font> (--argc) {
00342     ++argv;
00343 
00344     fs4 = (<a class="code" href="structfs4__t.html">fs4_t</a>*) <a class="code" href="fs4plugin_8C.html#a2">open_fs4_read</a>(*argv, <font class="stringliteral">"fs"</font>, &amp;natoms);
00345     <font class="keywordflow">if</font> (!fs4) {
00346       fprintf(stderr, <font class="stringliteral">"open_fs4_read failed for file %s\n"</font>, *argv);
00347       <font class="keywordflow">return</font> 1;
00348     }
00349 
00350     printf(<font class="stringliteral">"a:\t%f\nb:\t%f\nc:\t%f\n"</font>,
00351            fs4-&gt;<a class="code" href="structfs4__t.html#m10">vol</a>[0].<a class="code" href="structmolfile__volumetric__t.html#m2">xaxis</a>[0], fs4-&gt;<a class="code" href="structfs4__t.html#m10">vol</a>[0].<a class="code" href="structmolfile__volumetric__t.html#m3">yaxis</a>[1], fs4-&gt;<a class="code" href="structfs4__t.html#m10">vol</a>[0].<a class="code" href="structmolfile__volumetric__t.html#m4">zaxis</a>[2]);
00352     printf(<font class="stringliteral">"ncol:\t%d\nnrow:\t%d\nnplane:\t%d\n"</font>, 
00353            fs4-&gt;<a class="code" href="structfs4__t.html#m10">vol</a>[0].<a class="code" href="structmolfile__volumetric__t.html#m5">xsize</a>, fs4-&gt;<a class="code" href="structfs4__t.html#m10">vol</a>[0].<a class="code" href="structmolfile__volumetric__t.html#m6">ysize</a>, fs4-&gt;<a class="code" href="structfs4__t.html#m10">vol</a>[0].<a class="code" href="structmolfile__volumetric__t.html#m7">zsize</a>);
00354 
00355     datablock = <font class="keyword">new</font> <font class="keywordtype">float</font>[fs4-&gt;<a class="code" href="structfs4__t.html#m10">vol</a>[0].<a class="code" href="structmolfile__volumetric__t.html#m5">xsize</a> * fs4-&gt;<a class="code" href="structfs4__t.html#m10">vol</a>[0].<a class="code" href="structmolfile__volumetric__t.html#m6">ysize</a> * 
00356                           fs4-&gt;<a class="code" href="structfs4__t.html#m10">vol</a>[0].<a class="code" href="structmolfile__volumetric__t.html#m7">zsize</a>];
00357 
00358     <font class="keywordflow">if</font> (<a class="code" href="fs4plugin_8C.html#a4">read_fs4_data</a>(fs4, 0, datablock, NULL) != 0) {
00359       fprintf(stderr, <font class="stringliteral">"read_fs4_data failed for file %s\n"</font>, *argv);
00360       <font class="keywordflow">return</font> 1;
00361     }
00362 
00363     <font class="keyword">delete</font> [] datablock;
00364   }
00365 
00366   <font class="keywordflow">return</font> 0;
00367 }
00368 
00369 <font class="preprocessor"># endif</font>
00370 <font class="preprocessor"></font>
</pre></div><hr><address><small>Generated on Wed Mar 22 13:15:29 2006 for VMD Plugins (current) by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.gif" alt="doxygen" align="middle" border=0 
width=110 height=53></a>1.2.14 written by <a href="mailto:dimitri@stack.nl">Dimitri van Heesch</a>,
 &copy;&nbsp;1997-2002</small></address>
</body>
</html>
