<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>stlplugin.C Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.2.14 -->
<center>
<a class="qindex" href="index.html">Main Page</a> &nbsp; <a class="qindex" href="classes.html">Alphabetical List</a> &nbsp; <a class="qindex" href="annotated.html">Compound List</a> &nbsp; <a class="qindex" href="files.html">File List</a> &nbsp; <a class="qindex" href="functions.html">Compound Members</a> &nbsp; <a class="qindex" href="globals.html">File Members</a> &nbsp; <a class="qindex" href="pages.html">Related Pages</a> &nbsp; </center>
<hr><h1>stlplugin.C</h1><a href="stlplugin_8C.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 <font class="comment">/***************************************************************************</font>
00002 <font class="comment"> *cr</font>
00003 <font class="comment"> *cr            (C) Copyright 1995-2006 The Board of Trustees of the</font>
00004 <font class="comment"> *cr                        University of Illinois</font>
00005 <font class="comment"> *cr                         All Rights Reserved</font>
00006 <font class="comment"> *cr</font>
00007 <font class="comment"> ***************************************************************************/</font>
00008 
00009 <font class="comment">/***************************************************************************</font>
00010 <font class="comment"> * RCS INFORMATION:</font>
00011 <font class="comment"> *</font>
00012 <font class="comment"> *      $RCSfile: stlplugin.C,v $</font>
00013 <font class="comment"> *      $Author: johns $       $Locker:  $             $State: Exp $</font>
00014 <font class="comment"> *      $Revision: 1.11 $       $Date: 2006/02/23 19:36:45 $</font>
00015 <font class="comment"> *</font>
00016 <font class="comment"> ***************************************************************************/</font>
00017 
00018 <font class="comment">/*</font>
00019 <font class="comment"> *  STL files are used by most Automatic Fabricators (3D printers). Only </font>
00020 <font class="comment"> *  triangles are used to represent the geometry. </font>
00021 <font class="comment"> *</font>
00022 <font class="comment"> *  ASCII STL files follow the following format. Files are case insensitive</font>
00023 <font class="comment"> *  and whitespace is ignored.</font>
00024 <font class="comment"> *</font>
00025 <font class="comment"> *  solid name                ("name" is an arbitrary label for the solid)</font>
00026 <font class="comment"> *  facet normal ni nj nk     (&lt;n&gt; is a unit normal of the triangle)</font>
00027 <font class="comment"> *  outer loop</font>
00028 <font class="comment"> *  vertex v1x v1y v1z        (&lt;v1&gt; is the first vertex)</font>
00029 <font class="comment"> *  vertex v2x v2y v2z        (vertices are given in anti-clockwise order)</font>
00030 <font class="comment"> *  vertex v3x v3y v3z        (vertices are given as floating-point values)</font>
00031 <font class="comment"> *  endloop                   (there is no space in the label "endloop")</font>
00032 <font class="comment"> *  endfacet                  (likewise)</font>
00033 <font class="comment"> *  ...                       (additional facets are given as above)</font>
00034 <font class="comment"> *  endsolid name             (this ends the stl file, same name as above)</font>
00035 <font class="comment"> */</font>
00036 
00037 <font class="preprocessor">#include &lt;stdlib.h&gt;</font>
00038 <font class="preprocessor">#include &lt;stdio.h&gt;</font>
00039 <font class="preprocessor">#include &lt;ctype.h&gt;</font>
00040 <font class="preprocessor">#include &lt;math.h&gt;</font>
00041 <font class="preprocessor">#include &lt;string.h&gt;</font>
00042 
00043 <font class="preprocessor">#if defined(_AIX)</font>
00044 <font class="preprocessor"></font><font class="preprocessor">#include &lt;strings.h&gt;</font>
00045 <font class="preprocessor">#endif</font>
00046 <font class="preprocessor"></font>
00047 <font class="preprocessor">#if defined(WIN32) || defined(WIN64)</font>
00048 <font class="preprocessor"></font><font class="preprocessor">#define strcasecmp stricmp</font>
00049 <font class="preprocessor"></font><font class="preprocessor">#endif</font>
00050 <font class="preprocessor"></font>
00051 <font class="preprocessor">#include "<a class="code" href="molfile__plugin_8h.html">molfile_plugin.h</a>"</font>
00052 
<a name="l00053"></a><a class="code" href="structgraphics__list.html">00053</a> <font class="keyword">typedef</font> <font class="keyword">struct </font><a class="code" href="structgraphics__list.html">graphics_list</a> {
<a name="l00054"></a><a class="code" href="structgraphics__list.html#m0">00054</a>   <a class="code" href="structmolfile__graphics__t.html">molfile_graphics_t</a> <a class="code" href="structgraphics__list.html#m0">gItem</a>;
<a name="l00055"></a><a class="code" href="structgraphics__list.html#m1">00055</a>   <font class="keyword">struct </font><a class="code" href="structgraphics__list.html">graphics_list</a> *next;
00056 } <a class="code" href="structgraphics__list.html">molfile_graphics_list</a>;
00057 
<a name="l00058"></a><a class="code" href="structstl__t.html">00058</a> <font class="keyword">typedef</font> <font class="keyword">struct </font>{
<a name="l00059"></a><a class="code" href="structstl__t.html#m0">00059</a>   FILE *fd;
<a name="l00060"></a><a class="code" href="structstl__t.html#m1">00060</a>   <a class="code" href="structmolfile__graphics__t.html">molfile_graphics_t</a> *graphics;
00061 } <a class="code" href="structstl__t.html">stl_t</a>;
00062 
<a name="l00063"></a><a class="code" href="stlplugin_8C.html#a2">00063</a> <font class="keyword">static</font> <font class="keywordtype">void</font> *<a class="code" href="webpdbplugin_8c.html#a5">open_file_read</a>(<font class="keyword">const</font> <font class="keywordtype">char</font> *filepath, <font class="keyword">const</font> <font class="keywordtype">char</font> *filetype,
00064     <font class="keywordtype">int</font> *natoms) {
00065   FILE *fd;
00066   <a class="code" href="structstl__t.html">stl_t</a> *stl;
00067   
00068   fd = fopen(filepath, <font class="stringliteral">"rb"</font>);
00069   <font class="keywordflow">if</font> (!fd) {
00070     fprintf(stderr, <font class="stringliteral">"Error opening file.\n"</font>);
00071     <font class="keywordflow">return</font> NULL;
00072   }
00073   stl = <font class="keyword">new</font> <a class="code" href="structstl__t.html">stl_t</a>;
00074   stl-&gt;<a class="code" href="structstl__t.html#m0">fd</a> = fd;
00075   stl-&gt;<a class="code" href="structstl__t.html#m1">graphics</a> = NULL;
00076   *natoms = 0;
00077   <font class="keywordflow">return</font> stl;
00078 }
00079 
<a name="l00080"></a><a class="code" href="stlplugin_8C.html#a3">00080</a> <font class="keyword">static</font> <font class="keywordtype">int</font> <a class="code" href="stlplugin_8C.html#a3">read_rawgraphics</a>(<font class="keywordtype">void</font> *v, <font class="keywordtype">int</font> *nelem, 
00081     <font class="keyword">const</font> <a class="code" href="structmolfile__graphics__t.html">molfile_graphics_t</a> **data) {
00082     <a class="code" href="structgraphics__list.html">molfile_graphics_list</a> *gListPtr=NULL, *tmpPtr=NULL;
00083     <font class="keywordtype">int</font> i=0, ntriangles=0;
00084     <font class="keywordtype">int</font> error=0;
00085     <a class="code" href="structstl__t.html">stl_t</a> *stl = (<a class="code" href="structstl__t.html">stl_t</a> *)v;
00086     FILE *infile = stl-&gt;<a class="code" href="structstl__t.html#m0">fd</a>;
00087     <font class="keywordtype">char</font> line[81], keyWord[81];
00088 
00089     <font class="comment">// Check your head(er)</font>
00090     <font class="comment">// "solid name"</font>
00091     fgets(line, 80, infile);
00092     sscanf(line, <font class="stringliteral">" %s"</font>, keyWord);
00093     <font class="keywordflow">if</font> (strcasecmp(keyWord, <font class="stringliteral">"solid"</font>) != 0)
00094     {
00095       fprintf(stderr, <font class="stringliteral">"STL file error: expected \"solid\".\n"</font>);
00096       error = 1;
00097     }
00098 
00099     <font class="comment">// "facet normal ni nj nk"</font>
00100     fgets(line, 80, infile);
00101     sscanf(line, <font class="stringliteral">" %s"</font>, keyWord);
00102     <font class="keywordflow">if</font> (strcasecmp(keyWord, <font class="stringliteral">"facet"</font>) != 0)
00103     {
00104       fprintf(stderr, <font class="stringliteral">"STL file error: expected \"facet\".\n"</font>);
00105       error = 1;
00106     }
00107     <font class="keywordflow">else</font>
00108     {
00109       gListPtr = <font class="keyword">new</font> <a class="code" href="structgraphics__list.html">molfile_graphics_list</a>;
00110       gListPtr-&gt;<a class="code" href="structgraphics__list.html#m1">next</a> = NULL;
00111       gListPtr-&gt;<a class="code" href="structgraphics__list.html#m0">gItem</a>.<a class="code" href="structmolfile__graphics__t.html#m0">type</a> = <a class="code" href="molfile__plugin_8h.html#a30a19">MOLFILE_TRIANGLE</a>;
00112       ntriangles++;
00113       tmpPtr = gListPtr;
00114     }
00115 
00116     <font class="keywordflow">while</font> ( !feof(infile) &amp;&amp; (error == 0) )
00117     {
00118       <font class="comment">// "outer loop"</font>
00119       fgets(line, 80, infile);
00120       sscanf(line, <font class="stringliteral">" %s"</font>, keyWord);
00121       <font class="keywordflow">if</font> (strcasecmp(keyWord, <font class="stringliteral">"outer"</font>) != 0)
00122       {
00123         fprintf(stderr, <font class="stringliteral">"STL file error: expected \"outer\".\n"</font>);
00124         error = 1;
00125         <font class="keywordflow">break</font>;
00126       }
00127       <font class="keywordflow">else</font>
00128       {
00129         i = 0;
00130       }
00131         
00132       <font class="comment">// "vertex vx, vy, vz"</font>
00133       <font class="keywordflow">while</font> (i &lt; 9)
00134       {
00135         fgets(line, 80, infile);
00136         sscanf(line, <font class="stringliteral">" %s"</font>, keyWord);
00137         <font class="keywordflow">if</font> (strcasecmp(keyWord, <font class="stringliteral">"vertex"</font>) != 0)
00138         {
00139           fprintf(stderr, <font class="stringliteral">"STL file error: expected \"vertex\".\n"</font>);
00140           error = 1;
00141           <font class="keywordflow">break</font>; 
00142         }
00143         <font class="keywordflow">else</font> <font class="keywordflow">if</font> ( sscanf(line, <font class="stringliteral">" %*s %f %f %f"</font>, &amp;(tmpPtr-&gt;<a class="code" href="structgraphics__list.html#m0">gItem</a>.<a class="code" href="structmolfile__graphics__t.html#m3">data</a>[i++]),
00144                          &amp;(tmpPtr-&gt;<a class="code" href="structgraphics__list.html#m0">gItem</a>.<a class="code" href="structmolfile__graphics__t.html#m3">data</a>[i++]), 
00145                          &amp;(tmpPtr-&gt;<a class="code" href="structgraphics__list.html#m0">gItem</a>.<a class="code" href="structmolfile__graphics__t.html#m3">data</a>[i++])) != 3 )
00146         {
00147           fprintf(stderr, <font class="stringliteral">"STL file error: not enough vertices.\n"</font>);
00148           error = 1;
00149           <font class="keywordflow">break</font>;
00150         }
00151       }
00152       <font class="keywordflow">if</font> (error != 0) <font class="keywordflow">break</font>;
00153 
00154       <font class="comment">// "endloop"</font>
00155       fgets(line, 80, infile);
00156       sscanf(line, <font class="stringliteral">" %s"</font>, keyWord);
00157       <font class="keywordflow">if</font> (strcasecmp(keyWord, <font class="stringliteral">"endloop"</font>) != 0)
00158       {
00159         fprintf(stderr, <font class="stringliteral">"STL file error: expected \"endloop\".\n"</font>);
00160         error = 1;
00161         <font class="keywordflow">break</font>;
00162       }
00163       
00164       <font class="comment">// "endfacet"</font>
00165       fgets(line, 80, infile);
00166       sscanf(line, <font class="stringliteral">" %s"</font>, keyWord);
00167       <font class="keywordflow">if</font> (strcasecmp(keyWord, <font class="stringliteral">"endfacet"</font>) != 0)
00168       {
00169         fprintf(stderr, <font class="stringliteral">"STL file error: expected \"endfacet\".\n"</font>);
00170         error = 1;
00171         <font class="keywordflow">break</font>;
00172       }
00173 
00174       <font class="comment">// "endsolid" or "facet normal ni nj nk"</font>
00175       fgets(line, 80, infile);
00176       sscanf(line, <font class="stringliteral">" %s"</font>, keyWord);
00177       <font class="keywordflow">if</font> (strcasecmp(keyWord, <font class="stringliteral">"endsolid"</font>) == 0)
00178       {
00179         <font class="keywordflow">break</font>;
00180       }
00181       <font class="keywordflow">if</font> (strcasecmp(keyWord, <font class="stringliteral">"facet"</font>) == 0)
00182       {
00183         <font class="comment">// Create a new list item and initialize it.</font>
00184         tmpPtr-&gt;<a class="code" href="structgraphics__list.html#m1">next</a> = <font class="keyword">new</font> <a class="code" href="structgraphics__list.html">molfile_graphics_list</a>;
00185         tmpPtr = tmpPtr-&gt;<a class="code" href="structgraphics__list.html#m1">next</a>;
00186         tmpPtr-&gt;<a class="code" href="structgraphics__list.html#m1">next</a> = NULL;
00187         tmpPtr-&gt;<a class="code" href="structgraphics__list.html#m0">gItem</a>.<a class="code" href="structmolfile__graphics__t.html#m0">type</a> = <a class="code" href="molfile__plugin_8h.html#a30a19">MOLFILE_TRIANGLE</a>;
00188         ntriangles++;
00189       }
00190       <font class="keywordflow">else</font>
00191       {
00192         fprintf(stderr, 
00193                 <font class="stringliteral">"STL file error: expected \"facet\" or \"endsolid\".\n"</font>);
00194         error = 1;
00195         <font class="keywordflow">break</font>;
00196       }
00197 
00198       <font class="comment">// file error</font>
00199       <font class="keywordflow">if</font>(ferror(infile))
00200       {
00201         fprintf(stderr, <font class="stringliteral">"STL file error: problem reading file\n"</font>);
00202         error = 1;
00203         <font class="keywordflow">break</font>;
00204       }
00205     }
00206 
00207 
00208     <font class="comment">// If an error occurred, free the linked list and return MOLFILE_ERROR</font>
00209     <font class="keywordflow">if</font> (error != 0)
00210     {
00211       <font class="keywordflow">while</font> (gListPtr != NULL)
00212       {
00213         tmpPtr = gListPtr-&gt;<a class="code" href="structgraphics__list.html#m1">next</a>;
00214         <font class="keyword">delete</font> gListPtr;
00215         gListPtr = tmpPtr;
00216       }
00217       <font class="keywordflow">return</font> <a class="code" href="molfile__plugin_8h.html#a4">MOLFILE_ERROR</a>;
00218     }
00219 
00220     <font class="comment">// Create the array of molfile_graphics_t, and copy the data from the</font>
00221     <font class="comment">// linked list into it, deleting the list as you go.</font>
00222     stl-&gt;<a class="code" href="structstl__t.html#m1">graphics</a> = <font class="keyword">new</font> <a class="code" href="structmolfile__graphics__t.html">molfile_graphics_t</a>[ntriangles];
00223     i = 0;
00224     <font class="keywordflow">while</font> (gListPtr != NULL)
00225     {
00226       stl-&gt;<a class="code" href="structstl__t.html#m1">graphics</a>[i] = gListPtr-&gt;<a class="code" href="structgraphics__list.html#m0">gItem</a>;
00227       tmpPtr = gListPtr-&gt;<a class="code" href="structgraphics__list.html#m1">next</a>;
00228       <font class="keyword">delete</font> gListPtr;
00229       gListPtr = tmpPtr;
00230       i++;
00231     }
00232 
00233     *nelem = ntriangles;
00234     *data = stl-&gt;<a class="code" href="structstl__t.html#m1">graphics</a>;
00235 
00236     <font class="keywordflow">return</font> <a class="code" href="molfile__plugin_8h.html#a2">MOLFILE_SUCCESS</a>;
00237 }
00238 
<a name="l00239"></a><a class="code" href="stlplugin_8C.html#a4">00239</a> <font class="keyword">static</font> <font class="keywordtype">void</font> <a class="code" href="stlplugin_8C.html#a4">close_file_read</a>(<font class="keywordtype">void</font> *v) {
00240   <a class="code" href="structstl__t.html">stl_t</a> *stl = (<a class="code" href="structstl__t.html">stl_t</a> *)v;
00241   fclose(stl-&gt;<a class="code" href="structstl__t.html#m0">fd</a>);
00242   <font class="keywordflow">if</font> (stl-&gt;<a class="code" href="structstl__t.html#m1">graphics</a> != NULL)
00243     <font class="keyword">delete</font> [] stl-&gt;<a class="code" href="structstl__t.html#m1">graphics</a>;
00244   <font class="keyword">delete</font> stl;
00245 }
00246 
00247 
00248 <font class="comment">/*</font>
00249 <font class="comment"> * Initialization stuff here</font>
00250 <font class="comment"> */</font>
<a name="l00251"></a><a class="code" href="stlplugin_8C.html#a1">00251</a> <font class="keyword">static</font> <a class="code" href="structmolfile__plugin__t.html">molfile_plugin_t</a> <a class="code" href="stlplugin_8C.html#a1">plugin</a> = {
00252   <a class="code" href="vmdplugin_8h.html#a10">vmdplugin_ABIVERSION</a>,   <font class="comment">// ABI version</font>
00253   <a class="code" href="molfile__plugin_8h.html#a0">MOLFILE_PLUGIN_TYPE</a>,    <font class="comment">// type of plugin</font>
00254   <font class="stringliteral">"stl"</font>,                  <font class="comment">// name of plugin</font>
00255   <font class="stringliteral">"STL Stereolithography Triangle Mesh"</font>, <font class="comment">// pretty name of plugin</font>
00256   <font class="stringliteral">"Eamon Caddigan"</font>,       <font class="comment">// author</font>
00257   0,                      <font class="comment">// major version</font>
00258   1,                      <font class="comment">// minor version</font>
00259   <a class="code" href="vmdplugin_8h.html#a12">VMDPLUGIN_THREADSAFE</a>,   <font class="comment">// is reentrant</font>
00260   <font class="stringliteral">"stl"</font>                   <font class="comment">// filename extension </font>
00261 };
00262 
<a name="l00263"></a><a class="code" href="stlplugin_8C.html#a5">00263</a> <a class="code" href="vmdplugin_8h.html#a7">VMDPLUGIN_API</a> <font class="keywordtype">int</font> <a class="code" href="vmdplugin_8h.html#a5">VMDPLUGIN_init</a>(<font class="keywordtype">void</font>) { <font class="keywordflow">return</font> <a class="code" href="vmdplugin_8h.html#a13">VMDPLUGIN_SUCCESS</a>; }
<a name="l00264"></a><a class="code" href="stlplugin_8C.html#a6">00264</a> <a class="code" href="vmdplugin_8h.html#a7">VMDPLUGIN_API</a> <font class="keywordtype">int</font> <a class="code" href="vmdplugin_8h.html#a6">VMDPLUGIN_fini</a>(<font class="keywordtype">void</font>) { <font class="keywordflow">return</font> <a class="code" href="vmdplugin_8h.html#a13">VMDPLUGIN_SUCCESS</a>; }
<a name="l00265"></a><a class="code" href="stlplugin_8C.html#a7">00265</a> <a class="code" href="vmdplugin_8h.html#a7">VMDPLUGIN_API</a> <font class="keywordtype">int</font> <a class="code" href="vmdplugin_8h.html#a3">VMDPLUGIN_register</a>(<font class="keywordtype">void</font> *v, <a class="code" href="vmdplugin_8h.html#a15">vmdplugin_register_cb</a> cb) {
00266   plugin.<a class="code" href="structmolfile__plugin__t.html#m1">open_file_read</a> = <a class="code" href="stlplugin_8C.html#a2">open_file_read</a>;
00267   plugin.<a class="code" href="structmolfile__plugin__t.html#m12">read_rawgraphics</a> = <a class="code" href="stlplugin_8C.html#a3">read_rawgraphics</a>;
00268   plugin.<a class="code" href="structmolfile__plugin__t.html#m5">close_file_read</a> = <a class="code" href="stlplugin_8C.html#a4">close_file_read</a>;
00269   (*cb)(v, (<a class="code" href="structvmdplugin__t.html">vmdplugin_t</a> *)&amp;plugin);
00270   <font class="keywordflow">return</font> <a class="code" href="vmdplugin_8h.html#a13">VMDPLUGIN_SUCCESS</a>;
00271 }
00272 
00273 
</pre></div><hr><address><small>Generated on Wed Mar 22 13:15:31 2006 for VMD Plugins (current) by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.gif" alt="doxygen" align="middle" border=0 
width=110 height=53></a>1.2.14 written by <a href="mailto:dimitri@stack.nl">Dimitri van Heesch</a>,
 &copy;&nbsp;1997-2002</small></address>
</body>
</html>
