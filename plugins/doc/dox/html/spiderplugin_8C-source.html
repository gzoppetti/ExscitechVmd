<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>spiderplugin.C Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.2.14 -->
<center>
<a class="qindex" href="index.html">Main Page</a> &nbsp; <a class="qindex" href="classes.html">Alphabetical List</a> &nbsp; <a class="qindex" href="annotated.html">Compound List</a> &nbsp; <a class="qindex" href="files.html">File List</a> &nbsp; <a class="qindex" href="functions.html">Compound Members</a> &nbsp; <a class="qindex" href="globals.html">File Members</a> &nbsp; <a class="qindex" href="pages.html">Related Pages</a> &nbsp; </center>
<hr><h1>spiderplugin.C</h1><a href="spiderplugin_8C.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 <font class="comment">/***************************************************************************</font>
00002 <font class="comment"> *cr</font>
00003 <font class="comment"> *cr            (C) Copyright 1995-2006 The Board of Trustees of the</font>
00004 <font class="comment"> *cr                        University of Illinois</font>
00005 <font class="comment"> *cr                         All Rights Reserved</font>
00006 <font class="comment"> *cr</font>
00007 <font class="comment"> ***************************************************************************/</font>
00008 
00009 <font class="comment">/***************************************************************************</font>
00010 <font class="comment"> * RCS INFORMATION:</font>
00011 <font class="comment"> *</font>
00012 <font class="comment"> *      $RCSfile: spiderplugin.C,v $</font>
00013 <font class="comment"> *      $Author: johns $       $Locker:  $             $State: Exp $</font>
00014 <font class="comment"> *      $Revision: 1.9 $       $Date: 2006/03/21 08:19:25 $</font>
00015 <font class="comment"> *</font>
00016 <font class="comment"> ***************************************************************************/</font>
00017 
00018 <font class="comment">/* </font>
00019 <font class="comment"> * SPIDER volumetric image datasets</font>
00020 <font class="comment"> *   http://www.wadsworth.org/spider_doc/spider/docs/image_doc.html</font>
00021 <font class="comment"> *</font>
00022 <font class="comment"> * TODO:</font>
00023 <font class="comment"> *  - Add code to determine axis scaling factors, axis angles, offsets, etc</font>
00024 <font class="comment"> */</font>
00025 
00026 <font class="preprocessor">#include &lt;stdlib.h&gt;</font>
00027 <font class="preprocessor">#include &lt;stdio.h&gt;</font>
00028 <font class="preprocessor">#include &lt;ctype.h&gt;</font>
00029 <font class="preprocessor">#include &lt;math.h&gt;</font>
00030 <font class="preprocessor">#include &lt;string.h&gt;</font>
00031 <font class="preprocessor">#include "<a class="code" href="endianswap_8h.html">endianswap.h</a>"</font>
00032 
00033 <font class="preprocessor">#if defined(_AIX)</font>
00034 <font class="preprocessor"></font><font class="preprocessor">#include &lt;strings.h&gt;</font>
00035 <font class="preprocessor">#endif</font>
00036 <font class="preprocessor"></font>
00037 <font class="preprocessor">#if defined(WIN32) || defined(WIN64)</font>
00038 <font class="preprocessor"></font><font class="preprocessor">#define strcasecmp  stricmp</font>
00039 <font class="preprocessor"></font><font class="preprocessor">#define strncasecmp strnicmp</font>
00040 <font class="preprocessor"></font><font class="preprocessor">#endif</font>
00041 <font class="preprocessor"></font>
00042 <font class="preprocessor">#include "<a class="code" href="molfile__plugin_8h.html">molfile_plugin.h</a>"</font>
00043 
<a name="l00044"></a><a class="code" href="spiderplugin_8C.html#a0">00044</a> <font class="preprocessor">#define LINESIZE 85</font>
00045 <font class="preprocessor"></font>
<a name="l00046"></a><a class="code" href="structspider__t.html">00046</a> <font class="keyword">typedef</font> <font class="keyword">struct </font>{
<a name="l00047"></a><a class="code" href="structspider__t.html#m0">00047</a>   FILE *fd;
<a name="l00048"></a><a class="code" href="structspider__t.html#m1">00048</a>   <font class="keywordtype">int</font> nsets;
<a name="l00049"></a><a class="code" href="structspider__t.html#m2">00049</a>   <a class="code" href="structmolfile__volumetric__t.html">molfile_volumetric_t</a> *vol;
<a name="l00050"></a><a class="code" href="structspider__t.html#m3">00050</a>   <font class="keywordtype">int</font> byteswap;
<a name="l00051"></a><a class="code" href="structspider__t.html#m4">00051</a>   <font class="keywordtype">int</font> nslice;
<a name="l00052"></a><a class="code" href="structspider__t.html#m5">00052</a>   <font class="keywordtype">int</font> nrow;
<a name="l00053"></a><a class="code" href="structspider__t.html#m6">00053</a>   <font class="keywordtype">int</font> nlabel;
<a name="l00054"></a><a class="code" href="structspider__t.html#m7">00054</a>   <font class="keywordtype">int</font> iform;
<a name="l00055"></a><a class="code" href="structspider__t.html#m8">00055</a>   <font class="keywordtype">int</font> imami;
<a name="l00056"></a><a class="code" href="structspider__t.html#m9">00056</a>   <font class="keywordtype">float</font> fmax;
<a name="l00057"></a><a class="code" href="structspider__t.html#m10">00057</a>   <font class="keywordtype">float</font> fmin;
<a name="l00058"></a><a class="code" href="structspider__t.html#m11">00058</a>   <font class="keywordtype">float</font> av;
<a name="l00059"></a><a class="code" href="structspider__t.html#m12">00059</a>   <font class="keywordtype">float</font> sig;
<a name="l00060"></a><a class="code" href="structspider__t.html#m13">00060</a>   <font class="keywordtype">int</font> nsam;
<a name="l00061"></a><a class="code" href="structspider__t.html#m14">00061</a>   <font class="keywordtype">int</font> headrec;
<a name="l00062"></a><a class="code" href="structspider__t.html#m15">00062</a>   <font class="keywordtype">int</font> iangle;
<a name="l00063"></a><a class="code" href="structspider__t.html#m16">00063</a>   <font class="keywordtype">float</font> phi;
<a name="l00064"></a><a class="code" href="structspider__t.html#m17">00064</a>   <font class="keywordtype">float</font> theta;
<a name="l00065"></a><a class="code" href="structspider__t.html#m18">00065</a>   <font class="keywordtype">float</font> gamma;
<a name="l00066"></a><a class="code" href="structspider__t.html#m19">00066</a>   <font class="keywordtype">float</font> xoffset;
<a name="l00067"></a><a class="code" href="structspider__t.html#m20">00067</a>   <font class="keywordtype">float</font> yoffset;
<a name="l00068"></a><a class="code" href="structspider__t.html#m21">00068</a>   <font class="keywordtype">float</font> zoffset;
<a name="l00069"></a><a class="code" href="structspider__t.html#m22">00069</a>   <font class="keywordtype">float</font> scale;
<a name="l00070"></a><a class="code" href="structspider__t.html#m23">00070</a>   <font class="keywordtype">int</font> headbyt;
<a name="l00071"></a><a class="code" href="structspider__t.html#m24">00071</a>   <font class="keywordtype">int</font> reclen;
<a name="l00072"></a><a class="code" href="structspider__t.html#m25">00072</a>   <font class="keywordtype">int</font> nstack;
<a name="l00073"></a><a class="code" href="structspider__t.html#m26">00073</a>   <font class="keywordtype">int</font> inuse;
<a name="l00074"></a><a class="code" href="structspider__t.html#m27">00074</a>   <font class="keywordtype">int</font> maxim; 
00075 } <a class="code" href="structspider__t.html">spider_t</a>;
00076 
00077 
<a name="l00078"></a><a class="code" href="spiderplugin_8C.html#a2">00078</a> <font class="keyword">static</font> <font class="keywordtype">void</font> *<a class="code" href="spiderplugin_8C.html#a2">open_spider_read</a>(<font class="keyword">const</font> <font class="keywordtype">char</font> *filepath, <font class="keyword">const</font> <font class="keywordtype">char</font> *filetype,
00079     <font class="keywordtype">int</font> *natoms) {
00080   FILE *fd;
00081   <a class="code" href="structspider__t.html">spider_t</a> *vol;
00082   <font class="keywordtype">int</font> total;
00083   <font class="keywordtype">int</font> rc;
00084 
00085   <font class="comment">/* file header buffer union */</font> 
00086   <font class="keyword">union </font>buffer {
00087     <font class="keywordtype">float</font> fbuf[256];  
00088     <font class="keywordtype">char</font>  cbuf[1024];
00089   } h;
00090  
00091   fd = fopen(filepath, <font class="stringliteral">"rb"</font>);
00092   <font class="keywordflow">if</font> (!fd) {
00093     fprintf(stderr, <font class="stringliteral">"Error opening file.\n"</font>);
00094     <font class="keywordflow">return</font> NULL;
00095   }
00096 
00097   <font class="comment">/* allocate and initialize the spider structure */</font>
00098   vol = <font class="keyword">new</font> <a class="code" href="structspider__t.html">spider_t</a>;
00099   vol-&gt;<a class="code" href="structspider__t.html#m0">fd</a> = fd;
00100   vol-&gt;<a class="code" href="structspider__t.html#m2">vol</a> = NULL;
00101   vol-&gt;<a class="code" href="structspider__t.html#m3">byteswap</a> = 0;
00102   *natoms = <a class="code" href="molfile__plugin_8h.html#a7">MOLFILE_NUMATOMS_NONE</a>;
00103   vol-&gt;<a class="code" href="structspider__t.html#m1">nsets</a> = 1; <font class="comment">/* this file contains only one data set */</font>
00104 
00105   vol-&gt;<a class="code" href="structspider__t.html#m2">vol</a> = <font class="keyword">new</font> <a class="code" href="structmolfile__volumetric__t.html">molfile_volumetric_t</a>[1];
00106   strcpy(vol-&gt;<a class="code" href="structspider__t.html#m2">vol</a>[0].<a class="code" href="structmolfile__volumetric__t.html#m0">dataname</a>, <font class="stringliteral">"SPIDER map"</font>);
00107 
00108   <font class="comment">// read SPIDER file header</font>
00109   <font class="keywordflow">if</font> (fread(&amp;h.cbuf, 1024, 1, fd) &lt; 1) {
00110     printf(<font class="stringliteral">"spiderplugin) failed to read file header\n"</font>);
00111     <font class="keywordflow">return</font> NULL; 
00112   } 
00113 
00114   <font class="comment">// perform sanity checks on header values to see if we </font>
00115   <font class="comment">// need to do byte swapping, or abort.</font>
00116   vol-&gt;<a class="code" href="structspider__t.html#m4">nslice</a>   = (h.fbuf[0] &lt; 0) ? -h.fbuf[0] : h.fbuf[0];
00117   vol-&gt;<a class="code" href="structspider__t.html#m5">nrow</a>     = h.fbuf[1];
00118   vol-&gt;<a class="code" href="structspider__t.html#m13">nsam</a>     = h.fbuf[11];
00119   total = vol-&gt;<a class="code" href="structspider__t.html#m4">nslice</a> * vol-&gt;<a class="code" href="structspider__t.html#m5">nrow</a> * vol-&gt;<a class="code" href="structspider__t.html#m13">nsam</a>;
00120 
00121   <font class="keywordflow">if</font> (total &lt;= 0 || 
00122       vol-&gt;<a class="code" href="structspider__t.html#m13">nsam</a>   &lt;= 0 || vol-&gt;<a class="code" href="structspider__t.html#m13">nsam</a>   &gt; 100000 ||
00123       vol-&gt;<a class="code" href="structspider__t.html#m5">nrow</a>   &lt;= 0 || vol-&gt;<a class="code" href="structspider__t.html#m5">nrow</a>   &gt; 100000 ||
00124       vol-&gt;<a class="code" href="structspider__t.html#m4">nslice</a> &lt;= 0 || vol-&gt;<a class="code" href="structspider__t.html#m4">nslice</a> &gt; 100000) { 
00125 
00126     printf(<font class="stringliteral">"spiderplugin) Non-native endianness or unusual file detected\n"</font>);
00127 
00128     <font class="comment">// byte swap the entire header in hopes of making sense of this gibberish</font>
00129     vol-&gt;<a class="code" href="structspider__t.html#m3">byteswap</a> = 1;
00130     <a class="code" href="endianswap_8h.html#a4">swap4_aligned</a>(&amp;h.fbuf, 256);
00131 
00132     vol-&gt;<a class="code" href="structspider__t.html#m4">nslice</a>   = (h.fbuf[0] &lt; 0) ? -h.fbuf[0] : h.fbuf[0];
00133     vol-&gt;<a class="code" href="structspider__t.html#m5">nrow</a>     = h.fbuf[1];
00134     vol-&gt;<a class="code" href="structspider__t.html#m13">nsam</a>     = h.fbuf[11];
00135     total = vol-&gt;<a class="code" href="structspider__t.html#m4">nslice</a> * vol-&gt;<a class="code" href="structspider__t.html#m5">nrow</a> * vol-&gt;<a class="code" href="structspider__t.html#m13">nsam</a>;
00136 
00137     <font class="comment">// check to see if we still have gibberish or not, bail out if we do.</font>
00138     <font class="keywordflow">if</font> (total &lt;= 0 || 
00139       vol-&gt;<a class="code" href="structspider__t.html#m13">nsam</a>   &lt;= 0 || vol-&gt;<a class="code" href="structspider__t.html#m13">nsam</a>   &gt; 100000 ||
00140       vol-&gt;<a class="code" href="structspider__t.html#m5">nrow</a>   &lt;= 0 || vol-&gt;<a class="code" href="structspider__t.html#m5">nrow</a>   &gt; 100000 ||
00141       vol-&gt;<a class="code" href="structspider__t.html#m4">nslice</a> &lt;= 0 || vol-&gt;<a class="code" href="structspider__t.html#m4">nslice</a> &gt; 100000) { 
00142       printf(<font class="stringliteral">"spiderplugin) bad header values in file fail sanity checks\n"</font>);
00143       <font class="keyword">delete</font> [] vol-&gt;<a class="code" href="structspider__t.html#m2">vol</a>;
00144       <font class="keyword">delete</font> vol;
00145       <font class="keywordflow">return</font> NULL;
00146     }
00147   }
00148   <font class="keywordflow">if</font> (vol-&gt;<a class="code" href="structspider__t.html#m3">byteswap</a>) {
00149     printf(<font class="stringliteral">"spiderplugin) Enabling byte swapping\n"</font>);
00150   }
00151 
00152   vol-&gt;<a class="code" href="structspider__t.html#m6">nlabel</a>   = h.fbuf[3];
00153   vol-&gt;<a class="code" href="structspider__t.html#m7">iform</a>    = h.fbuf[4];
00154   vol-&gt;<a class="code" href="structspider__t.html#m8">imami</a>    = h.fbuf[5];
00155   vol-&gt;<a class="code" href="structspider__t.html#m9">fmax</a>     = h.fbuf[6];
00156   vol-&gt;<a class="code" href="structspider__t.html#m10">fmin</a>     = h.fbuf[7];
00157   vol-&gt;<a class="code" href="structspider__t.html#m11">av</a>       = h.fbuf[8];
00158   vol-&gt;<a class="code" href="structspider__t.html#m12">sig</a>      = h.fbuf[9];
00159   vol-&gt;<a class="code" href="structspider__t.html#m14">headrec</a>  = h.fbuf[12];
00160   vol-&gt;<a class="code" href="structspider__t.html#m15">iangle</a>   = h.fbuf[13];
00161   vol-&gt;<a class="code" href="structspider__t.html#m16">phi</a>      = h.fbuf[14];
00162   vol-&gt;<a class="code" href="structspider__t.html#m17">theta</a>    = h.fbuf[15];
00163   vol-&gt;<a class="code" href="structspider__t.html#m18">gamma</a>    = h.fbuf[16];
00164   vol-&gt;<a class="code" href="structspider__t.html#m19">xoffset</a>  = h.fbuf[17];
00165   vol-&gt;<a class="code" href="structspider__t.html#m20">yoffset</a>  = h.fbuf[18];
00166   vol-&gt;<a class="code" href="structspider__t.html#m21">zoffset</a>  = h.fbuf[19];
00167   vol-&gt;<a class="code" href="structspider__t.html#m22">scale</a>    = h.fbuf[20];
00168   vol-&gt;<a class="code" href="structspider__t.html#m23">headbyt</a>  = h.fbuf[21];
00169   vol-&gt;<a class="code" href="structspider__t.html#m24">reclen</a>   = h.fbuf[22];
00170   vol-&gt;<a class="code" href="structspider__t.html#m25">nstack</a>   = h.fbuf[23];
00171   vol-&gt;<a class="code" href="structspider__t.html#m26">inuse</a>    = h.fbuf[24];
00172   vol-&gt;<a class="code" href="structspider__t.html#m27">maxim</a>    = h.fbuf[25];
00173 
00174 printf(<font class="stringliteral">"spider  nslice: %d\n"</font>, vol-&gt;<a class="code" href="structspider__t.html#m4">nslice</a>);
00175 printf(<font class="stringliteral">"spider    nrow: %d\n"</font>, vol-&gt;<a class="code" href="structspider__t.html#m5">nrow</a>);
00176 printf(<font class="stringliteral">"spider    nsam: %d\n"</font>, vol-&gt;<a class="code" href="structspider__t.html#m13">nsam</a>);
00177 printf(<font class="stringliteral">"spider   iform: %d\n"</font>, vol-&gt;<a class="code" href="structspider__t.html#m7">iform</a>);
00178 printf(<font class="stringliteral">"spider   scale: %f\n"</font>, vol-&gt;<a class="code" href="structspider__t.html#m22">scale</a>);
00179 printf(<font class="stringliteral">"spider xoffset: %f\n"</font>, vol-&gt;<a class="code" href="structspider__t.html#m19">xoffset</a>);
00180 printf(<font class="stringliteral">"spider yoffset: %f\n"</font>, vol-&gt;<a class="code" href="structspider__t.html#m20">yoffset</a>);
00181 printf(<font class="stringliteral">"spider zoffset: %f\n"</font>, vol-&gt;<a class="code" href="structspider__t.html#m21">zoffset</a>);
00182 printf(<font class="stringliteral">"spider    phi: %f\n"</font>, vol-&gt;<a class="code" href="structspider__t.html#m16">phi</a>);
00183 printf(<font class="stringliteral">"spider  theta: %f\n"</font>, vol-&gt;<a class="code" href="structspider__t.html#m17">theta</a>);
00184 printf(<font class="stringliteral">"spider  gamma: %f\n"</font>, vol-&gt;<a class="code" href="structspider__t.html#m18">gamma</a>);
00185 
00186   <font class="comment">/* correct bad headbyt and reclen SPIDER files */</font>
00187   <font class="keywordflow">if</font> (vol-&gt;<a class="code" href="structspider__t.html#m7">iform</a> &lt; 4 &amp;&amp; (vol-&gt;<a class="code" href="structspider__t.html#m24">reclen</a> &lt; (vol-&gt;<a class="code" href="structspider__t.html#m13">nsam</a> * 4)))
00188     vol-&gt;<a class="code" href="structspider__t.html#m24">reclen</a> = vol-&gt;<a class="code" href="structspider__t.html#m13">nsam</a> * 4; 
00189 
00190   <font class="keywordtype">int</font> headrec = 1024 / vol-&gt;<a class="code" href="structspider__t.html#m24">reclen</a>;
00191   <font class="keywordflow">if</font> (vol-&gt;<a class="code" href="structspider__t.html#m24">reclen</a> &lt; 1024 &amp;&amp; (1024 % (vol-&gt;<a class="code" href="structspider__t.html#m24">reclen</a>)) != 0)
00192      headrec++;
00193   <font class="keywordtype">int</font> headbyt = headrec * vol-&gt;<a class="code" href="structspider__t.html#m24">reclen</a>;
00194  
00195   <font class="keywordflow">if</font> (vol-&gt;<a class="code" href="structspider__t.html#m7">iform</a> &lt; 4 &amp;&amp; (vol-&gt;<a class="code" href="structspider__t.html#m23">headbyt</a> &lt; headbyt))
00196     vol-&gt;<a class="code" href="structspider__t.html#m23">headbyt</a> = headbyt;
00197 
00198   <font class="comment">/* seek to data offset */</font>
00199   fseek(fd, vol-&gt;<a class="code" href="structspider__t.html#m23">headbyt</a>, SEEK_SET);
00200 
00201   <font class="comment">/* SPIDER files contain no color information */</font>
00202   vol-&gt;<a class="code" href="structspider__t.html#m2">vol</a>[0].<a class="code" href="structmolfile__volumetric__t.html#m8">has_color</a> = 0;
00203 
00204   vol-&gt;<a class="code" href="structspider__t.html#m2">vol</a>[0].<a class="code" href="structmolfile__volumetric__t.html#m5">xsize</a> = vol-&gt;<a class="code" href="structspider__t.html#m13">nsam</a>;
00205   vol-&gt;<a class="code" href="structspider__t.html#m2">vol</a>[0].<a class="code" href="structmolfile__volumetric__t.html#m6">ysize</a> = vol-&gt;<a class="code" href="structspider__t.html#m5">nrow</a>;
00206   vol-&gt;<a class="code" href="structspider__t.html#m2">vol</a>[0].<a class="code" href="structmolfile__volumetric__t.html#m7">zsize</a> = vol-&gt;<a class="code" href="structspider__t.html#m4">nslice</a>;
00207 
00208   <font class="comment">/* Set the unit cell origin and basis vectors */</font>
00209   <font class="keywordtype">float</font> vz[3] = {0.0, 0.0, 0.0};
00210   memcpy(vol-&gt;<a class="code" href="structspider__t.html#m2">vol</a>[0].<a class="code" href="structmolfile__volumetric__t.html#m2">xaxis</a>, &amp;vz, <font class="keyword">sizeof</font>(vz));
00211   memcpy(vol-&gt;<a class="code" href="structspider__t.html#m2">vol</a>[0].<a class="code" href="structmolfile__volumetric__t.html#m3">yaxis</a>, &amp;vz, <font class="keyword">sizeof</font>(vz));
00212   memcpy(vol-&gt;<a class="code" href="structspider__t.html#m2">vol</a>[0].<a class="code" href="structmolfile__volumetric__t.html#m4">zaxis</a>, &amp;vz, <font class="keyword">sizeof</font>(vz));
00213 
00214   <font class="comment">/* the scale value may be zero, if so, just reset to 1.0 */</font>
00215   <font class="keywordtype">float</font> vscale = vol-&gt;<a class="code" href="structspider__t.html#m22">scale</a>;
00216   <font class="keywordflow">if</font> (vscale == 0.0) 
00217     vscale = 1.0;
00218 
00219   <font class="comment">/* the data is stored in y/x/-z order and coordinate handedness  */</font>
00220   <font class="comment">/* we should probably rewrite the loader loop to shuffle x/y     */</font>
00221   <font class="comment">/* so that future conversions to other formats don't leave it in */</font>
00222   <font class="comment">/* an unusual packing order.  For now this works however         */</font>
00223 
00224   <font class="keywordtype">float</font> xlen = vscale * (vol-&gt;<a class="code" href="structspider__t.html#m2">vol</a>[0].<a class="code" href="structmolfile__volumetric__t.html#m6">ysize</a>-1);
00225   <font class="keywordtype">float</font> ylen = vscale * (vol-&gt;<a class="code" href="structspider__t.html#m2">vol</a>[0].<a class="code" href="structmolfile__volumetric__t.html#m5">xsize</a>-1);
00226   <font class="keywordtype">float</font> zlen = vscale * (vol-&gt;<a class="code" href="structspider__t.html#m2">vol</a>[0].<a class="code" href="structmolfile__volumetric__t.html#m7">zsize</a>-1);
00227 
00228   vol-&gt;<a class="code" href="structspider__t.html#m2">vol</a>[0].<a class="code" href="structmolfile__volumetric__t.html#m2">xaxis</a>[1] =  xlen;
00229   vol-&gt;<a class="code" href="structspider__t.html#m2">vol</a>[0].<a class="code" href="structmolfile__volumetric__t.html#m3">yaxis</a>[0] =  ylen;
00230   vol-&gt;<a class="code" href="structspider__t.html#m2">vol</a>[0].<a class="code" href="structmolfile__volumetric__t.html#m4">zaxis</a>[2] = -zlen;
00231 
00232   vol-&gt;<a class="code" href="structspider__t.html#m2">vol</a>[0].<a class="code" href="structmolfile__volumetric__t.html#m1">origin</a>[0] = vol-&gt;<a class="code" href="structspider__t.html#m20">yoffset</a> - (0.5 * ylen);
00233   vol-&gt;<a class="code" href="structspider__t.html#m2">vol</a>[0].<a class="code" href="structmolfile__volumetric__t.html#m1">origin</a>[1] = vol-&gt;<a class="code" href="structspider__t.html#m19">xoffset</a> - (0.5 * xlen);
00234   vol-&gt;<a class="code" href="structspider__t.html#m2">vol</a>[0].<a class="code" href="structmolfile__volumetric__t.html#m1">origin</a>[2] = vol-&gt;<a class="code" href="structspider__t.html#m21">zoffset</a> + (0.5 * zlen);
00235 
00236 printf(<font class="stringliteral">"spider final offset: (%f, %f, %f)\n"</font>,
00237   vol-&gt;<a class="code" href="structspider__t.html#m2">vol</a>[0].<a class="code" href="structmolfile__volumetric__t.html#m1">origin</a>[0], vol-&gt;<a class="code" href="structspider__t.html#m2">vol</a>[0].<a class="code" href="structmolfile__volumetric__t.html#m1">origin</a>[1], vol-&gt;<a class="code" href="structspider__t.html#m2">vol</a>[0].<a class="code" href="structmolfile__volumetric__t.html#m1">origin</a>[2]);
00238 
00239 printf(<font class="stringliteral">"spider final axes:\n"</font>);
00240 printf(<font class="stringliteral">"  X (%f, %f, %f)\n"</font>,
00241   vol-&gt;<a class="code" href="structspider__t.html#m2">vol</a>[0].<a class="code" href="structmolfile__volumetric__t.html#m2">xaxis</a>[0], 
00242   vol-&gt;<a class="code" href="structspider__t.html#m2">vol</a>[0].<a class="code" href="structmolfile__volumetric__t.html#m2">xaxis</a>[1], 
00243   vol-&gt;<a class="code" href="structspider__t.html#m2">vol</a>[0].<a class="code" href="structmolfile__volumetric__t.html#m2">xaxis</a>[2]);
00244 
00245 printf(<font class="stringliteral">"  Y (%f, %f, %f)\n"</font>,
00246   vol-&gt;<a class="code" href="structspider__t.html#m2">vol</a>[0].<a class="code" href="structmolfile__volumetric__t.html#m3">yaxis</a>[0], 
00247   vol-&gt;<a class="code" href="structspider__t.html#m2">vol</a>[0].<a class="code" href="structmolfile__volumetric__t.html#m3">yaxis</a>[1], 
00248   vol-&gt;<a class="code" href="structspider__t.html#m2">vol</a>[0].<a class="code" href="structmolfile__volumetric__t.html#m3">yaxis</a>[2]);
00249 
00250 printf(<font class="stringliteral">"  Z (%f, %f, %f)\n"</font>,
00251   vol-&gt;<a class="code" href="structspider__t.html#m2">vol</a>[0].<a class="code" href="structmolfile__volumetric__t.html#m4">zaxis</a>[0], 
00252   vol-&gt;<a class="code" href="structspider__t.html#m2">vol</a>[0].<a class="code" href="structmolfile__volumetric__t.html#m4">zaxis</a>[1], 
00253   vol-&gt;<a class="code" href="structspider__t.html#m2">vol</a>[0].<a class="code" href="structmolfile__volumetric__t.html#m4">zaxis</a>[2]);
00254 
00255   <font class="keywordflow">return</font> vol;
00256 }
00257 
<a name="l00258"></a><a class="code" href="spiderplugin_8C.html#a3">00258</a> <font class="keyword">static</font> <font class="keywordtype">int</font> <a class="code" href="spiderplugin_8C.html#a3">read_spider_metadata</a>(<font class="keywordtype">void</font> *v, <font class="keywordtype">int</font> *nsets, 
00259   <a class="code" href="structmolfile__volumetric__t.html">molfile_volumetric_t</a> **metadata) {
00260   <a class="code" href="structspider__t.html">spider_t</a> *vol = (<a class="code" href="structspider__t.html">spider_t</a> *)v;
00261   *nsets = vol-&gt;<a class="code" href="structspider__t.html#m1">nsets</a>;
00262   *metadata = vol-&gt;<a class="code" href="structspider__t.html#m2">vol</a>;  
00263 
00264   <font class="keywordflow">return</font> <a class="code" href="molfile__plugin_8h.html#a2">MOLFILE_SUCCESS</a>;
00265 }
00266 
<a name="l00267"></a><a class="code" href="spiderplugin_8C.html#a4">00267</a> <font class="keyword">static</font> <font class="keywordtype">int</font> <a class="code" href="spiderplugin_8C.html#a4">read_spider_data</a>(<font class="keywordtype">void</font> *v, <font class="keywordtype">int</font> set, <font class="keywordtype">float</font> *datablock,
00268                          <font class="keywordtype">float</font> *colorblock) {
00269   <a class="code" href="structspider__t.html">spider_t</a> *vol = (<a class="code" href="structspider__t.html">spider_t</a> *)v;
00270   FILE *fd = vol-&gt;<a class="code" href="structspider__t.html#m0">fd</a>;
00271   <font class="keywordtype">int</font> x, y, z, xsize, ysize, zsize, xysize, total;
00272 
00273   xsize = vol-&gt;<a class="code" href="structspider__t.html#m2">vol</a>[0].<a class="code" href="structmolfile__volumetric__t.html#m5">xsize</a>;
00274   ysize = vol-&gt;<a class="code" href="structspider__t.html#m2">vol</a>[0].<a class="code" href="structmolfile__volumetric__t.html#m6">ysize</a>;
00275   zsize = vol-&gt;<a class="code" href="structspider__t.html#m2">vol</a>[0].<a class="code" href="structmolfile__volumetric__t.html#m7">zsize</a>;
00276   xysize = xsize * ysize;
00277   total = xysize * zsize;
00278 
00279   <font class="comment">// Read the values from the file</font>
00280   fread(datablock, total * <font class="keyword">sizeof</font>(<font class="keywordtype">float</font>), 1, fd);
00281 
00282   <font class="comment">// perform byte swapping if necessary</font>
00283   <font class="keywordflow">if</font> (vol-&gt;<a class="code" href="structspider__t.html#m3">byteswap</a>) 
00284     <a class="code" href="endianswap_8h.html#a4">swap4_aligned</a>(datablock, total);
00285 
00286   <font class="keywordflow">return</font> <a class="code" href="molfile__plugin_8h.html#a2">MOLFILE_SUCCESS</a>;
00287 }
00288 
<a name="l00289"></a><a class="code" href="spiderplugin_8C.html#a5">00289</a> <font class="keyword">static</font> <font class="keywordtype">void</font> <a class="code" href="spiderplugin_8C.html#a5">close_spider_read</a>(<font class="keywordtype">void</font> *v) {
00290   <a class="code" href="structspider__t.html">spider_t</a> *vol = (<a class="code" href="structspider__t.html">spider_t</a> *)v;
00291   
00292   fclose(vol-&gt;<a class="code" href="structspider__t.html#m0">fd</a>);
00293   <font class="keywordflow">if</font> (vol-&gt;<a class="code" href="structspider__t.html#m2">vol</a> != NULL)
00294     <font class="keyword">delete</font> [] vol-&gt;<a class="code" href="structspider__t.html#m2">vol</a>; 
00295   <font class="keyword">delete</font> vol;
00296 }
00297 
00298 <font class="comment">/*</font>
00299 <font class="comment"> * Initialization stuff here</font>
00300 <font class="comment"> */</font>
<a name="l00301"></a><a class="code" href="spiderplugin_8C.html#a1">00301</a> <font class="keyword">static</font> <a class="code" href="structmolfile__plugin__t.html">molfile_plugin_t</a> <a class="code" href="spiderplugin_8C.html#a1">plugin</a> = {
00302   <a class="code" href="vmdplugin_8h.html#a10">vmdplugin_ABIVERSION</a>,   <font class="comment">/* ABI version */</font>
00303   <a class="code" href="molfile__plugin_8h.html#a0">MOLFILE_PLUGIN_TYPE</a>,    <font class="comment">/* plugin type */</font>
00304   <font class="stringliteral">"spider"</font>,               <font class="comment">/* short file format description */</font>
00305   <font class="stringliteral">"SPIDER Density Map"</font>,   <font class="comment">/* pretty file format description */</font>
00306   <font class="stringliteral">"John Stone"</font>,           <font class="comment">/* author(s) */</font>
00307   0,                      <font class="comment">/* major version */</font>
00308   4,                      <font class="comment">/* minor version */</font>
00309   <a class="code" href="vmdplugin_8h.html#a12">VMDPLUGIN_THREADSAFE</a>,   <font class="comment">/* is reentrant */</font>
00310   <font class="stringliteral">"spider"</font>                <font class="comment">/* filename extension */</font>
00311 };
00312 
<a name="l00313"></a><a class="code" href="spiderplugin_8C.html#a6">00313</a> <a class="code" href="vmdplugin_8h.html#a7">VMDPLUGIN_API</a> <font class="keywordtype">int</font> <a class="code" href="vmdplugin_8h.html#a5">VMDPLUGIN_init</a>(<font class="keywordtype">void</font>) { <font class="keywordflow">return</font> <a class="code" href="vmdplugin_8h.html#a13">VMDPLUGIN_SUCCESS</a>; }
<a name="l00314"></a><a class="code" href="spiderplugin_8C.html#a7">00314</a> <a class="code" href="vmdplugin_8h.html#a7">VMDPLUGIN_API</a> <font class="keywordtype">int</font> <a class="code" href="vmdplugin_8h.html#a6">VMDPLUGIN_fini</a>(<font class="keywordtype">void</font>) { <font class="keywordflow">return</font> <a class="code" href="vmdplugin_8h.html#a13">VMDPLUGIN_SUCCESS</a>; }
<a name="l00315"></a><a class="code" href="spiderplugin_8C.html#a8">00315</a> <a class="code" href="vmdplugin_8h.html#a7">VMDPLUGIN_API</a> <font class="keywordtype">int</font> <a class="code" href="vmdplugin_8h.html#a3">VMDPLUGIN_register</a>(<font class="keywordtype">void</font> *v, <a class="code" href="vmdplugin_8h.html#a15">vmdplugin_register_cb</a> cb) {
00316   plugin.<a class="code" href="structmolfile__plugin__t.html#m1">open_file_read</a> = <a class="code" href="spiderplugin_8C.html#a2">open_spider_read</a>;
00317   plugin.<a class="code" href="structmolfile__plugin__t.html#m10">read_volumetric_metadata</a> = <a class="code" href="spiderplugin_8C.html#a3">read_spider_metadata</a>;
00318   plugin.<a class="code" href="structmolfile__plugin__t.html#m11">read_volumetric_data</a> = <a class="code" href="spiderplugin_8C.html#a4">read_spider_data</a>;
00319   plugin.<a class="code" href="structmolfile__plugin__t.html#m5">close_file_read</a> = <a class="code" href="spiderplugin_8C.html#a5">close_spider_read</a>;
00320   (*cb)(v, (<a class="code" href="structvmdplugin__t.html">vmdplugin_t</a> *)&amp;plugin);
00321   <font class="keywordflow">return</font> <a class="code" href="vmdplugin_8h.html#a13">VMDPLUGIN_SUCCESS</a>;
00322 }
00323 
</pre></div><hr><address><small>Generated on Wed Mar 22 13:15:31 2006 for VMD Plugins (current) by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.gif" alt="doxygen" align="middle" border=0 
width=110 height=53></a>1.2.14 written by <a href="mailto:dimitri@stack.nl">Dimitri van Heesch</a>,
 &copy;&nbsp;1997-2002</small></address>
</body>
</html>
