<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>mdfplugin.C Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.2.14 -->
<center>
<a class="qindex" href="index.html">Main Page</a> &nbsp; <a class="qindex" href="classes.html">Alphabetical List</a> &nbsp; <a class="qindex" href="annotated.html">Compound List</a> &nbsp; <a class="qindex" href="files.html">File List</a> &nbsp; <a class="qindex" href="functions.html">Compound Members</a> &nbsp; <a class="qindex" href="globals.html">File Members</a> &nbsp; <a class="qindex" href="pages.html">Related Pages</a> &nbsp; </center>
<hr><h1>mdfplugin.C</h1><a href="mdfplugin_8C.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 <font class="comment">/***************************************************************************</font>
00002 <font class="comment"> *cr</font>
00003 <font class="comment"> *cr            (C) Copyright 1995-2006 The Board of Trustees of the</font>
00004 <font class="comment"> *cr                        University of Illinois</font>
00005 <font class="comment"> *cr                         All Rights Reserved</font>
00006 <font class="comment"> *cr</font>
00007 <font class="comment"> ***************************************************************************/</font>
00008 
00009 <font class="comment">/***************************************************************************</font>
00010 <font class="comment"> * RCS INFORMATION:</font>
00011 <font class="comment"> *</font>
00012 <font class="comment"> *      $RCSfile: mdfplugin.C,v $</font>
00013 <font class="comment"> *      $Author: johns $       $Locker:  $             $State: Exp $</font>
00014 <font class="comment"> *      $Revision: 1.11 $       $Date: 2006/02/23 19:36:45 $</font>
00015 <font class="comment"> *</font>
00016 <font class="comment"> ***************************************************************************/</font>
00017 
00018 <font class="comment">/*</font>
00019 <font class="comment"> * Molecular data file (.mdf) reader</font>
00020 <font class="comment"> * Insight II, Discover, etc. structure and bond information. This plugin</font>
00021 <font class="comment"> * reads only the topology section, ignoring the optional symmertry and</font>
00022 <font class="comment"> * atomset sections.</font>
00023 <font class="comment"> *</font>
00024 <font class="comment"> * Format specification can be found at:</font>
00025 <font class="comment"> * http://instinct.v24.uthscsa.edu/~hincklab/html/soft_packs/msi_docs/insight980/formats980/File_Formats_1998.html#484257</font>
00026 <font class="comment"> *</font>
00027 <font class="comment"> * TODO: The current code reads the file *four* times -- once on open, once</font>
00028 <font class="comment"> * to read the structure, and twice to read the bonds. Perhaps these could</font>
00029 <font class="comment"> * be consolidated, e.g. by counting the bonds and populating the hash</font>
00030 <font class="comment"> * tables during open or read_structure.</font>
00031 <font class="comment"> *</font>
00032 <font class="comment"> */</font>
00033 
00034 <font class="preprocessor">#include "<a class="code" href="molfile__plugin_8h.html">molfile_plugin.h</a>"</font>
00035 
<a name="l00036"></a><a class="code" href="mdfplugin_8C.html#a0">00036</a> <font class="preprocessor">#define VMDPLUGIN_STATIC</font>
00037 <font class="preprocessor"></font><font class="preprocessor">#include "<a class="code" href="hash_8h.html">hash.h</a>"</font>
00038 
00039 <font class="preprocessor">#include &lt;stdlib.h&gt;</font>
00040 <font class="preprocessor">#include &lt;stdio.h&gt;</font>
00041 <font class="preprocessor">#include &lt;string.h&gt;</font>
00042 <font class="preprocessor">#include &lt;ctype.h&gt;</font>
00043 
00044 <font class="preprocessor">#if defined(_AIX)</font>
00045 <font class="preprocessor"></font><font class="preprocessor">#include &lt;strings.h&gt;</font>
00046 <font class="preprocessor">#endif</font>
00047 <font class="preprocessor"></font>
<a name="l00048"></a><a class="code" href="mdfplugin_8C.html#a1">00048</a> <font class="preprocessor">#define LINESIZE 256</font>
<a name="l00049"></a><a class="code" href="mdfplugin_8C.html#a2">00049</a> <font class="preprocessor"></font><font class="preprocessor">#define NAMESIZE 32</font>
00050 <font class="preprocessor"></font>
<a name="l00051"></a><a class="code" href="structmdfdata.html">00051</a> <font class="keyword">typedef</font> <font class="keyword">struct </font>{
<a name="l00052"></a><a class="code" href="structmdfdata.html#m0">00052</a>   FILE *file;
<a name="l00053"></a><a class="code" href="structmdfdata.html#m4">00053</a>   <font class="keywordtype">int</font> natoms, nmols, *from, *to;
<a name="l00054"></a><a class="code" href="structmdfdata.html#m5">00054</a>   <font class="keywordtype">long</font> mol_data_location;
00055 } <a class="code" href="structmdfdata.html">mdfdata</a>;
00056 
00057 <font class="comment">// Read a line of atom data and store the values in the atom structure</font>
00058 <font class="comment">// Return 1 on success, 0 on error</font>
<a name="l00059"></a><a class="code" href="mdfplugin_8C.html#a4">00059</a> <font class="keyword">static</font> <font class="keywordtype">int</font> <a class="code" href="mdfplugin_8C.html#a4">read_mdf_structure_line</a>(<a class="code" href="structmolfile__atom__t.html">molfile_atom_t</a> *atom, <font class="keyword">const</font> <font class="keywordtype">char</font> *line) {
00060   <font class="comment">// Read pertinent structure information from the line</font>
00061   <font class="keywordflow">if</font> ( sscanf(line, <font class="stringliteral">"%[^:]:%s %s %*s %*s %*d %*s %f %*d %*d %*d %f"</font>,
00062               atom-&gt;<a class="code" href="structmolfile__atom__t.html#m2">resname</a>, atom-&gt;<a class="code" href="structmolfile__atom__t.html#m0">name</a>, atom-&gt;<a class="code" href="structmolfile__atom__t.html#m1">type</a>, 
00063               &amp;atom-&gt;<a class="code" href="structmolfile__atom__t.html#m11">charge</a>, &amp;atom-&gt;<a class="code" href="structmolfile__atom__t.html#m8">occupancy</a>) != 5 ) {
00064     <font class="keywordflow">return</font> 0;
00065   }
00066 
00067   <font class="comment">// Get the resid from the resname</font>
00068   <font class="keywordflow">if</font> ( sscanf(atom-&gt;<a class="code" href="structmolfile__atom__t.html#m2">resname</a>, <font class="stringliteral">"%*[^_]_%d"</font>, &amp;atom-&gt;<a class="code" href="structmolfile__atom__t.html#m3">resid</a>) != 1 ) {
00069     <font class="keywordflow">return</font> 0;
00070   }
00071 
00072   <font class="comment">// Provide defaults for missing values</font>
00073   atom-&gt;<a class="code" href="structmolfile__atom__t.html#m5">chain</a>[0] = <font class="charliteral">'\0'</font>;
00074   atom-&gt;<a class="code" href="structmolfile__atom__t.html#m4">segid</a>[0] = <font class="charliteral">'\0'</font>;
00075 
00076   <font class="keywordflow">return</font> 1;
00077 }
00078 
00079 <font class="comment">// Read the atom info from src and copy the connectivity record to dest.</font>
00080 <font class="comment">// Convert each record to resname_resnumber:atom form</font>
00081 <font class="comment">// Return 1 on success, 0 on error</font>
<a name="l00082"></a><a class="code" href="mdfplugin_8C.html#a5">00082</a> <font class="keyword">static</font> <font class="keywordtype">int</font> <a class="code" href="mdfplugin_8C.html#a5">get_mdf_bonds</a>(<font class="keywordtype">char</font> *dest, <font class="keyword">const</font> <font class="keywordtype">char</font> *src) {
00083   <font class="keywordtype">char</font> resinfo[<a class="code" href="mdfplugin_8C.html#a2">NAMESIZE</a>], bond_records[<a class="code" href="mdfplugin_8C.html#a1">LINESIZE</a>], *curr, *next, *tmp;
00084 
00085   <font class="comment">// Get the connectivity records</font>
00086   <font class="keywordflow">if</font> ( sscanf(src, <font class="stringliteral">"%[^:]:%*s %*s %*s %*s %*d %*s %*f %*d %*d %*d %*f %*f %256c"</font>, resinfo, bond_records) != 2 ) {
00087     <font class="keywordflow">return</font> 0;
00088   }
00089 
00090   <font class="comment">// Append the bonds to the destination string, converting then to the</font>
00091   <font class="comment">// correct format along the way.</font>
00092   dest[0] = <font class="charliteral">'\0'</font>;
00093   <font class="keywordflow">for</font> ( curr = bond_records; (next = strchr(curr, <font class="charliteral">' '</font>)) != NULL;
00094         curr = next + 1 ) {
00095     *next = <font class="charliteral">'\0'</font>;
00096 
00097     <font class="comment">// Prepend the resname and resid to the destination atom name if it's</font>
00098     <font class="comment">// not already present.</font>
00099     <font class="keywordflow">if</font> ( strchr(curr, <font class="charliteral">':'</font>) == NULL ) {
00100       strcat(dest, resinfo);
00101       strcat(dest, <font class="stringliteral">":"</font>);
00102     }
00103 
00104     <font class="comment">// Remove cell/sympop/bondorder information from the bond</font>
00105     <font class="keywordflow">if</font> ( ((tmp = strchr(curr, <font class="charliteral">'%'</font>)) != NULL) ||
00106          ((tmp = strchr(curr, <font class="charliteral">'#'</font>)) != NULL) ||
00107          ((tmp = strchr(curr, <font class="charliteral">'/'</font>)) != NULL) ||
00108          ((tmp = strchr(curr, <font class="charliteral">'\n'</font>)) != NULL) ) {
00109       *tmp = <font class="charliteral">'\0'</font>;
00110     }
00111     strcat(dest, curr);
00112     strcat(dest, <font class="stringliteral">" "</font>);
00113   }
00114 
00115   <font class="keywordflow">return</font> 1;
00116 }
00117 
00118 <font class="comment">// Return the number of bond records on a line</font>
<a name="l00119"></a><a class="code" href="mdfplugin_8C.html#a6">00119</a> <font class="keyword">static</font> <font class="keywordtype">int</font> <a class="code" href="mdfplugin_8C.html#a6">count_mdf_bonds</a>(<font class="keyword">const</font> <font class="keywordtype">char</font> *line) {
00120   <font class="keywordtype">char</font> bond_records[<a class="code" href="mdfplugin_8C.html#a1">LINESIZE</a>];
00121   <font class="keywordtype">int</font> bonds = 0;
00122   <font class="keywordtype">char</font> *tmp;
00123 
00124   <font class="keywordflow">if</font> ( !<a class="code" href="mdfplugin_8C.html#a5">get_mdf_bonds</a>(bond_records, line) ) {
00125     <font class="keywordflow">return</font> -1;
00126   }
00127   
00128   <font class="keywordflow">for</font> ( tmp = bond_records; (tmp = strchr(tmp, <font class="charliteral">' '</font>)) != NULL;
00129         tmp++ ) {
00130     bonds++;
00131   }
00132 
00133   <font class="keywordflow">return</font> bonds;
00134 }
00135 
00136 <font class="comment">// Open the file and create the mdf struct used to pass data to the other</font>
00137 <font class="comment">// functions.</font>
<a name="l00138"></a><a class="code" href="mdfplugin_8C.html#a7">00138</a> <font class="keyword">static</font> <font class="keywordtype">void</font> *<a class="code" href="mdfplugin_8C.html#a7">open_mdf_read</a>(<font class="keyword">const</font> <font class="keywordtype">char</font> *path, <font class="keyword">const</font> <font class="keywordtype">char</font> *filetype, 
00139     <font class="keywordtype">int</font> *natoms) {
00140   FILE *fd;
00141   <a class="code" href="structmdfdata.html">mdfdata</a> *mdf;
00142   <font class="keywordtype">long</font> mol_data_location;
00143   <font class="keywordtype">char</font> line[<a class="code" href="mdfplugin_8C.html#a1">LINESIZE</a>]; 
00144   <font class="keywordtype">int</font> nmols = 0;
00145 
00146   fd = fopen(path, <font class="stringliteral">"r"</font>);
00147   <font class="keywordflow">if</font> (!fd)
00148     <font class="keywordflow">return</font> NULL;
00149   
00150   <font class="comment">// Find the first molecule record</font>
00151   <font class="keywordflow">do</font> {
00152     fgets(line, <a class="code" href="mdfplugin_8C.html#a1">LINESIZE</a>, fd);
00153     <font class="keywordflow">if</font> ( ferror(fd) || feof(fd) ) {
00154       fprintf(stderr, <font class="stringliteral">"mdfplugin: No molecule record found in file.\n"</font>);
00155       <font class="keywordflow">return</font> NULL;
00156     }
00157   } <font class="keywordflow">while</font> ( strncmp(line, <font class="stringliteral">"@molecule"</font>, 9) );
00158 
00159   <font class="comment">// Remember the location of the beginning of the molecule data</font>
00160   mol_data_location = ftell(fd);
00161 
00162   <font class="comment">// Count the atoms in each molecule</font>
00163   <font class="keywordflow">while</font> ( line[0] != <font class="charliteral">'#'</font> ) {
00164     fgets(line, <a class="code" href="mdfplugin_8C.html#a1">LINESIZE</a>, fd);
00165 
00166     <font class="comment">// Count atoms until a new molecule or the end of the section is reached</font>
00167     <font class="keywordflow">while</font> ( (line[0] != <font class="charliteral">'@'</font>) &amp;&amp; (line[0] != <font class="charliteral">'#'</font>) ) {
00168       <font class="comment">// Ignore blank and comment lines</font>
00169       <font class="keywordflow">if</font> ( !isspace(line[0]) &amp;&amp; (line[0] != <font class="charliteral">'!'</font>) )
00170         *natoms = *natoms + 1;
00171       fgets(line, <a class="code" href="mdfplugin_8C.html#a1">LINESIZE</a>, fd);
00172       <font class="keywordflow">if</font> ( ferror(fd) || feof(fd) ) {
00173         fprintf(stderr, <font class="stringliteral">"mdfplugin: Error while counting atoms.\n"</font>);
00174         <font class="keywordflow">return</font> NULL;
00175       }
00176     }
00177     nmols++;
00178   }
00179 
00180   <font class="comment">// Allocate and initialize the mdf structure</font>
00181   mdf = <font class="keyword">new</font> <a class="code" href="structmdfdata.html">mdfdata</a>;
00182   mdf-&gt;<a class="code" href="structmdfdata.html#m0">file</a> = fd;
00183   mdf-&gt;<a class="code" href="structmdfdata.html#m1">natoms</a> = *natoms;
00184   mdf-&gt;<a class="code" href="structmdfdata.html#m2">nmols</a> = nmols;
00185   mdf-&gt;<a class="code" href="structmdfdata.html#m3">from</a> = NULL;
00186   mdf-&gt;<a class="code" href="structmdfdata.html#m4">to</a> = NULL;
00187   mdf-&gt;<a class="code" href="structmdfdata.html#m5">mol_data_location</a> = mol_data_location; 
00188 
00189   <font class="keywordflow">return</font> mdf;
00190 }
00191 
00192 <font class="comment">// Read the atom information for each molecule, but not bonds.</font>
00193 <font class="comment">// XXX - this ignores the column records, which may cause the atom records</font>
00194 <font class="comment">// to be read incorrectly.</font>
<a name="l00195"></a><a class="code" href="mdfplugin_8C.html#a8">00195</a> <font class="keyword">static</font> <font class="keywordtype">int</font> <a class="code" href="mdfplugin_8C.html#a8">read_mdf_structure</a>(<font class="keywordtype">void</font> *v, <font class="keywordtype">int</font> *optflags, <a class="code" href="structmolfile__atom__t.html">molfile_atom_t</a> *atoms) {
00196   <a class="code" href="structmdfdata.html">mdfdata</a> *mdf = (<a class="code" href="structmdfdata.html">mdfdata</a> *)v;
00197   <font class="keywordtype">char</font> line[<a class="code" href="mdfplugin_8C.html#a1">LINESIZE</a>];
00198   <font class="keywordtype">int</font> mol_num;
00199   <a class="code" href="structmolfile__atom__t.html">molfile_atom_t</a> *atom = atoms;
00200 
00201   *optflags = <a class="code" href="molfile__plugin_8h.html#a10">MOLFILE_OCCUPANCY</a> | <a class="code" href="molfile__plugin_8h.html#a13">MOLFILE_CHARGE</a>;
00202 
00203   <font class="comment">// Seek to the first molecule record</font>
00204   fseek(mdf-&gt;<a class="code" href="structmdfdata.html#m0">file</a>, mdf-&gt;<a class="code" href="structmdfdata.html#m5">mol_data_location</a>, SEEK_SET);
00205   line[0] = <font class="charliteral">'\0'</font>;
00206 
00207   <font class="comment">// Read the atom structure for each molecule</font>
00208   mol_num = 0;
00209   <font class="keywordflow">while</font> ( line[0] != <font class="charliteral">'#'</font> ) {
00210     fgets(line, <a class="code" href="mdfplugin_8C.html#a1">LINESIZE</a>, mdf-&gt;<a class="code" href="structmdfdata.html#m0">file</a>);
00211 
00212     <font class="comment">// Read atom structure for the current molecule</font>
00213     <font class="keywordflow">while</font> ( (line[0] != <font class="charliteral">'@'</font>) &amp;&amp; (line[0] != <font class="charliteral">'#'</font>) ) {
00214       <font class="comment">// Ignore blank and comment lines</font>
00215       <font class="keywordflow">if</font> ( !isspace(line[0]) &amp;&amp; (line[0] != <font class="charliteral">'!'</font>) ) {
00216         <font class="keywordflow">if</font> ( !<a class="code" href="mdfplugin_8C.html#a4">read_mdf_structure_line</a>(atom, line) ) {
00217           fprintf(stderr, <font class="stringliteral">"mdfplugin: Improperly formatted atom record encountered while reading structure.\n"</font>);
00218           <font class="keywordflow">return</font> <a class="code" href="molfile__plugin_8h.html#a4">MOLFILE_ERROR</a>;
00219         }
00220 
00221         <font class="comment">// XXX - use the chain name to identify different molecules</font>
00222         sprintf(atom-&gt;<a class="code" href="structmolfile__atom__t.html#m5">chain</a>, <font class="stringliteral">"%d"</font>, mol_num);
00223 
00224         atom++;
00225       }
00226 
00227       fgets(line, <a class="code" href="mdfplugin_8C.html#a1">LINESIZE</a>, mdf-&gt;<a class="code" href="structmdfdata.html#m0">file</a>);
00228       <font class="keywordflow">if</font> ( ferror(mdf-&gt;<a class="code" href="structmdfdata.html#m0">file</a>) || feof(mdf-&gt;<a class="code" href="structmdfdata.html#m0">file</a>) ) {
00229         fprintf(stderr, <font class="stringliteral">"mdfplugin: File error while reading structure.\n"</font>);
00230         <font class="keywordflow">return</font> <a class="code" href="molfile__plugin_8h.html#a4">MOLFILE_ERROR</a>;
00231       }
00232     }
00233     mol_num++;
00234   }
00235 
00236   <font class="keywordflow">return</font> <a class="code" href="molfile__plugin_8h.html#a2">MOLFILE_SUCCESS</a>;
00237 }
00238 
00239 <font class="comment">// Create arrays of one-based bond indicies.</font>
<a name="l00240"></a><a class="code" href="mdfplugin_8C.html#a9">00240</a> <font class="keyword">static</font> <font class="keywordtype">int</font> <a class="code" href="mdfplugin_8C.html#a9">read_mdf_bonds</a>(<font class="keywordtype">void</font> *v, <font class="keywordtype">int</font> *nbonds, <font class="keywordtype">int</font> **from_data, <font class="keywordtype">int</font> **to_data, <font class="keywordtype">float</font> **bondorderptr) {
00241   <a class="code" href="structmdfdata.html">mdfdata</a> *mdf = (<a class="code" href="structmdfdata.html">mdfdata</a> *)v;
00242   <font class="keywordtype">int</font> mol, atom, bond_count, *fromptr, *toptr, tmp_to;
00243   <font class="keywordtype">char</font> *curr, *next, line[<a class="code" href="mdfplugin_8C.html#a1">LINESIZE</a>], bond_records[<a class="code" href="mdfplugin_8C.html#a1">LINESIZE</a>];
00244   char (*atomnames)[<a class="code" href="mdfplugin_8C.html#a2">NAMESIZE</a>]; <font class="comment">// Dynamic array of cstrings</font>
00245   <a class="code" href="structhash__t.html">hash_t</a> *hasharray;           <font class="comment">// Array of hash tables</font>
00246 
00247   <font class="comment">// Allocate and initialize the hash table for each molecule.</font>
00248   hasharray = <font class="keyword">new</font> <a class="code" href="structhash__t.html">hash_t</a>[mdf-&gt;<a class="code" href="structmdfdata.html#m2">nmols</a>];
00249   <font class="keywordflow">for</font> (mol = 0; mol &lt; mdf-&gt;<a class="code" href="structmdfdata.html#m2">nmols</a>; mol++) {
00250     <a class="code" href="hash_8c.html#a3">hash_init</a>(&amp;hasharray[mol], 256);
00251   }
00252   atomnames = <font class="keyword">new</font> <font class="keywordtype">char</font>[mdf-&gt;<a class="code" href="structmdfdata.html#m1">natoms</a>][<a class="code" href="mdfplugin_8C.html#a2">NAMESIZE</a>];
00253 
00254   <font class="comment">// Populate the hash table; key: atom name; value: one-based atom index.</font>
00255   <font class="comment">// Count the bonds, each bond is counted twice.</font>
00256   fseek(mdf-&gt;<a class="code" href="structmdfdata.html#m0">file</a>, mdf-&gt;<a class="code" href="structmdfdata.html#m5">mol_data_location</a>, SEEK_SET);
00257   line[0] = <font class="charliteral">'\0'</font>;
00258   atom = 1;
00259   mol = 0;
00260   bond_count = 0;
00261   <font class="keywordflow">while</font> ( line[0] != <font class="charliteral">'#'</font> ) {
00262     fgets(line, <a class="code" href="mdfplugin_8C.html#a1">LINESIZE</a>, mdf-&gt;<a class="code" href="structmdfdata.html#m0">file</a>);
00263 
00264     <font class="comment">// Read the atom names</font>
00265     <font class="keywordflow">while</font> ( (line[0] != <font class="charliteral">'@'</font>) &amp;&amp; (line[0] != <font class="charliteral">'#'</font>) ) {
00266       <font class="comment">// Ignore blank and comment lines</font>
00267       <font class="keywordflow">if</font> ( !isspace(line[0]) &amp;&amp; (line[0] != <font class="charliteral">'!'</font>) ) {
00268         <font class="keywordflow">if</font> ( sscanf(line, <font class="stringliteral">"%s %*s"</font>, atomnames[atom-1]) != 1 ) {
00269           fprintf(stderr, <font class="stringliteral">"mdfplugin: Improperly formatted atom record encountered while reading bonds.\n"</font>);
00270           <font class="keywordflow">return</font> <a class="code" href="molfile__plugin_8h.html#a4">MOLFILE_ERROR</a>;
00271         }
00272         <font class="keywordflow">if</font> ( <a class="code" href="hash_8c.html#a6">hash_insert</a>(&amp;hasharray[mol], atomnames[atom-1], atom) != <a class="code" href="hash_8h.html#a0">HASH_FAIL</a> ) {
00273           fprintf(stderr, <font class="stringliteral">"mdfplugin: Could not add atom to hash table.\n"</font>);
00274           <font class="keywordflow">return</font> <a class="code" href="molfile__plugin_8h.html#a4">MOLFILE_ERROR</a>;
00275         }
00276 
00277         bond_count += <a class="code" href="mdfplugin_8C.html#a6">count_mdf_bonds</a>(line);
00278         atom++;
00279       }
00280 
00281       fgets(line, <a class="code" href="mdfplugin_8C.html#a1">LINESIZE</a>, mdf-&gt;<a class="code" href="structmdfdata.html#m0">file</a>);
00282       <font class="keywordflow">if</font> ( ferror(mdf-&gt;<a class="code" href="structmdfdata.html#m0">file</a>) || feof(mdf-&gt;<a class="code" href="structmdfdata.html#m0">file</a>) ) {
00283         fprintf(stderr, <font class="stringliteral">"mdfplugin: File error while reading bonds.\n"</font>);
00284         <font class="keywordflow">return</font> <a class="code" href="molfile__plugin_8h.html#a4">MOLFILE_ERROR</a>;
00285       }
00286     }
00287 
00288     mol++;
00289   }
00290 
00291   bond_count /= 2;
00292   mdf-&gt;<a class="code" href="structmdfdata.html#m3">from</a> = <font class="keyword">new</font> <font class="keywordtype">int</font>[bond_count];
00293   mdf-&gt;<a class="code" href="structmdfdata.html#m4">to</a> = <font class="keyword">new</font> <font class="keywordtype">int</font>[bond_count];
00294   fromptr = mdf-&gt;<a class="code" href="structmdfdata.html#m3">from</a>;
00295   toptr = mdf-&gt;<a class="code" href="structmdfdata.html#m4">to</a>;
00296 
00297   <font class="comment">// Read the molecules, storing the bond-indicies in fromptr and toprt</font>
00298   fseek(mdf-&gt;<a class="code" href="structmdfdata.html#m0">file</a>, mdf-&gt;<a class="code" href="structmdfdata.html#m5">mol_data_location</a>, SEEK_SET);
00299   line[0] = <font class="charliteral">'\0'</font>;
00300   atom = 1;
00301   mol = 0;
00302   <font class="keywordflow">while</font> ( line[0] != <font class="charliteral">'#'</font> ) {
00303     fgets(line, <a class="code" href="mdfplugin_8C.html#a1">LINESIZE</a>, mdf-&gt;<a class="code" href="structmdfdata.html#m0">file</a>);
00304 
00305     <font class="comment">// Read the bonds</font>
00306     <font class="keywordflow">while</font> ( (line[0] != <font class="charliteral">'@'</font>) &amp;&amp; (line[0] != <font class="charliteral">'#'</font>) ) {
00307       <font class="comment">// Ignore blank and comment lines</font>
00308       <font class="keywordflow">if</font> ( !isspace(line[0]) &amp;&amp; (line[0] != <font class="charliteral">'!'</font>) ) {
00309         <font class="keywordflow">if</font> ( !<a class="code" href="mdfplugin_8C.html#a5">get_mdf_bonds</a>(bond_records, line) ) {
00310           fprintf(stderr, <font class="stringliteral">"mdfplugin: Error reading bonds from atom data.\n"</font>);
00311           <font class="keywordflow">return</font> <a class="code" href="molfile__plugin_8h.html#a4">MOLFILE_ERROR</a>;
00312         }
00313 
00314         <font class="comment">// Read each bond in the line</font>
00315         <font class="keywordflow">for</font> ( curr = bond_records; (next = strchr(curr, <font class="charliteral">' '</font>)) != NULL; 
00316               curr = next+1 ) {
00317           *next = <font class="charliteral">'\0'</font>;
00318           tmp_to = <a class="code" href="hash_8c.html#a5">hash_lookup</a>(&amp;hasharray[mol], curr);
00319           <font class="keywordflow">if</font> (tmp_to == <a class="code" href="hash_8h.html#a0">HASH_FAIL</a>) {
00320             fprintf(stderr, <font class="stringliteral">"mdfplugin: Could not find atom in hash table.\n"</font>);
00321             <font class="keywordflow">return</font> <a class="code" href="molfile__plugin_8h.html#a4">MOLFILE_ERROR</a>;
00322           }
00323           <font class="keywordflow">else</font> <font class="keywordflow">if</font> (tmp_to &gt; atom) {
00324             <font class="comment">// Only count bonds to atoms greater than the current one, since</font>
00325             <font class="comment">// each bond is listed twice</font>
00326             *fromptr = atom;
00327             *toptr = tmp_to;
00328             fromptr++;
00329             toptr++;
00330           }
00331         }
00332 
00333         atom++;
00334       }
00335 
00336       fgets(line, <a class="code" href="mdfplugin_8C.html#a1">LINESIZE</a>, mdf-&gt;<a class="code" href="structmdfdata.html#m0">file</a>);
00337       <font class="keywordflow">if</font> ( ferror(mdf-&gt;<a class="code" href="structmdfdata.html#m0">file</a>) || feof(mdf-&gt;<a class="code" href="structmdfdata.html#m0">file</a>) ) {
00338         fprintf(stderr, <font class="stringliteral">"mdfplugin: File error while reading bonds.\n"</font>);
00339         <font class="keywordflow">return</font> <a class="code" href="molfile__plugin_8h.html#a4">MOLFILE_ERROR</a>;
00340       }
00341     }
00342 
00343     mol++;
00344   }
00345 
00346   <font class="keywordflow">for</font> (mol = 0; mol &lt; mdf-&gt;<a class="code" href="structmdfdata.html#m2">nmols</a>; mol++) {
00347     <a class="code" href="hash_8c.html#a8">hash_destroy</a>(&amp;hasharray[mol]);
00348   }
00349   <font class="keyword">delete</font> [] hasharray;
00350   <font class="keyword">delete</font> [] atomnames;
00351 
00352   *nbonds = bond_count;
00353   *from_data = mdf-&gt;<a class="code" href="structmdfdata.html#m3">from</a>;
00354   *to_data = mdf-&gt;<a class="code" href="structmdfdata.html#m4">to</a>;
00355   *bondorderptr = NULL; <font class="comment">// not implemented yet</font>
00356 
00357   <font class="keywordflow">return</font> <a class="code" href="molfile__plugin_8h.html#a2">MOLFILE_SUCCESS</a>;
00358 }
00359 
00360 <font class="comment">// Free the memory used by the mdf structure</font>
<a name="l00361"></a><a class="code" href="mdfplugin_8C.html#a10">00361</a> <font class="keyword">static</font> <font class="keywordtype">void</font> <a class="code" href="mdfplugin_8C.html#a10">close_mdf_read</a>(<font class="keywordtype">void</font> *v) {
00362   <a class="code" href="structmdfdata.html">mdfdata</a> *mdf = (<a class="code" href="structmdfdata.html">mdfdata</a> *)v;
00363   <font class="keywordflow">if</font> (mdf) {
00364     <font class="keywordflow">if</font> (mdf-&gt;<a class="code" href="structmdfdata.html#m0">file</a>) fclose(mdf-&gt;<a class="code" href="structmdfdata.html#m0">file</a>);
00365     <font class="keywordflow">if</font> (mdf-&gt;<a class="code" href="structmdfdata.html#m3">from</a>) <font class="keyword">delete</font> [] mdf-&gt;<a class="code" href="structmdfdata.html#m3">from</a>;
00366     <font class="keywordflow">if</font> (mdf-&gt;<a class="code" href="structmdfdata.html#m4">to</a>)   <font class="keyword">delete</font> [] mdf-&gt;<a class="code" href="structmdfdata.html#m4">to</a>;
00367     <font class="keyword">delete</font> mdf;
00368   }
00369 }
00370 
00371 <font class="comment">// Plugin Initialization</font>
<a name="l00372"></a><a class="code" href="mdfplugin_8C.html#a3">00372</a> <font class="keyword">static</font> <a class="code" href="structmolfile__plugin__t.html">molfile_plugin_t</a> <a class="code" href="mdfplugin_8C.html#a3">plugin</a> = {
00373   <a class="code" href="vmdplugin_8h.html#a10">vmdplugin_ABIVERSION</a>,   <font class="comment">/* ABI version */</font>
00374   <a class="code" href="molfile__plugin_8h.html#a0">MOLFILE_PLUGIN_TYPE</a>,    <font class="comment">/* type */</font>
00375   <font class="stringliteral">"mdf"</font>,                  <font class="comment">/* short name */</font>
00376   <font class="stringliteral">"InsightII MDF"</font>,        <font class="comment">/* pretty name */</font>
00377   <font class="stringliteral">"Eamon Caddigan"</font>,       <font class="comment">/* author */</font>
00378   0,                      <font class="comment">/* major version */</font>
00379   2,                      <font class="comment">/* minor version */</font>
00380   <a class="code" href="vmdplugin_8h.html#a12">VMDPLUGIN_THREADSAFE</a>,   <font class="comment">/* is_reentrant */</font>
00381   <font class="stringliteral">"mdf"</font>,                  <font class="comment">/* filename extension */</font>
00382 };
00383 
<a name="l00384"></a><a class="code" href="mdfplugin_8C.html#a11">00384</a> <a class="code" href="vmdplugin_8h.html#a7">VMDPLUGIN_API</a> <font class="keywordtype">int</font> <a class="code" href="vmdplugin_8h.html#a5">VMDPLUGIN_init</a>(<font class="keywordtype">void</font>) { <font class="keywordflow">return</font> <a class="code" href="vmdplugin_8h.html#a13">VMDPLUGIN_SUCCESS</a>; }
<a name="l00385"></a><a class="code" href="mdfplugin_8C.html#a12">00385</a> <a class="code" href="vmdplugin_8h.html#a7">VMDPLUGIN_API</a> <font class="keywordtype">int</font> <a class="code" href="vmdplugin_8h.html#a6">VMDPLUGIN_fini</a>(<font class="keywordtype">void</font>) { <font class="keywordflow">return</font> <a class="code" href="vmdplugin_8h.html#a13">VMDPLUGIN_SUCCESS</a>; }
<a name="l00386"></a><a class="code" href="mdfplugin_8C.html#a13">00386</a> <a class="code" href="vmdplugin_8h.html#a7">VMDPLUGIN_API</a> <font class="keywordtype">int</font> <a class="code" href="vmdplugin_8h.html#a3">VMDPLUGIN_register</a>(<font class="keywordtype">void</font> *v, <a class="code" href="vmdplugin_8h.html#a15">vmdplugin_register_cb</a> cb) {
00387   plugin.<a class="code" href="structmolfile__plugin__t.html#m1">open_file_read</a> = <a class="code" href="mdfplugin_8C.html#a7">open_mdf_read</a>;
00388   plugin.<a class="code" href="structmolfile__plugin__t.html#m2">read_structure</a> = <a class="code" href="mdfplugin_8C.html#a8">read_mdf_structure</a>;
00389   plugin.<a class="code" href="structmolfile__plugin__t.html#m3">read_bonds</a> = <a class="code" href="mdfplugin_8C.html#a9">read_mdf_bonds</a>;
00390   plugin.<a class="code" href="structmolfile__plugin__t.html#m5">close_file_read</a> = <a class="code" href="mdfplugin_8C.html#a10">close_mdf_read</a>;
00391   (*cb)(v, (<a class="code" href="structvmdplugin__t.html">vmdplugin_t</a> *)&amp;plugin);
00392   <font class="keywordflow">return</font> <a class="code" href="vmdplugin_8h.html#a13">VMDPLUGIN_SUCCESS</a>;
00393 }
00394 
</pre></div><hr><address><small>Generated on Wed Mar 22 13:15:30 2006 for VMD Plugins (current) by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.gif" alt="doxygen" align="middle" border=0 
width=110 height=53></a>1.2.14 written by <a href="mailto:dimitri@stack.nl">Dimitri van Heesch</a>,
 &copy;&nbsp;1997-2002</small></address>
</body>
</html>
