<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>cpmdplugin.c Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.2.14 -->
<center>
<a class="qindex" href="index.html">Main Page</a> &nbsp; <a class="qindex" href="classes.html">Alphabetical List</a> &nbsp; <a class="qindex" href="annotated.html">Compound List</a> &nbsp; <a class="qindex" href="files.html">File List</a> &nbsp; <a class="qindex" href="functions.html">Compound Members</a> &nbsp; <a class="qindex" href="globals.html">File Members</a> &nbsp; <a class="qindex" href="pages.html">Related Pages</a> &nbsp; </center>
<hr><h1>cpmdplugin.c</h1><a href="cpmdplugin_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 <font class="comment">/***************************************************************************</font>
00002 <font class="comment"> *cr</font>
00003 <font class="comment"> *cr            (C) Copyright 1995-2006 The Board of Trustees of the</font>
00004 <font class="comment"> *cr                        University of Illinois</font>
00005 <font class="comment"> *cr                         All Rights Reserved</font>
00006 <font class="comment"> *cr</font>
00007 <font class="comment"> ***************************************************************************/</font>
00008 
00009 <font class="comment">/***************************************************************************</font>
00010 <font class="comment"> * RCS INFORMATION:</font>
00011 <font class="comment"> *</font>
00012 <font class="comment"> *      $RCSfile: cpmdplugin.c,v $</font>
00013 <font class="comment"> *      $Author: johns $       $Locker:  $             $State: Exp $</font>
00014 <font class="comment"> *      $Revision: 1.11 $       $Date: 2006/02/23 19:36:44 $</font>
00015 <font class="comment"> *</font>
00016 <font class="comment"> ***************************************************************************/</font>
00017 
00018 <font class="preprocessor">#include "<a class="code" href="largefiles_8h.html">largefiles.h</a>"</font>   <font class="comment">/* platform dependent 64-bit file I/O defines */</font>
00019 
00020 <font class="preprocessor">#include &lt;stdio.h&gt;</font>
00021 <font class="preprocessor">#include &lt;stdlib.h&gt;</font>
00022 <font class="preprocessor">#include &lt;string.h&gt;</font>
00023 <font class="preprocessor">#include "<a class="code" href="molfile__plugin_8h.html">molfile_plugin.h</a>"</font>
00024 
<a name="l00025"></a><a class="code" href="structcpmddata.html">00025</a> <font class="keyword">typedef</font> <font class="keyword">struct </font>{
<a name="l00026"></a><a class="code" href="structcpmddata.html#m0">00026</a>   FILE *file;
<a name="l00027"></a><a class="code" href="structcpmddata.html#m1">00027</a>   <font class="keywordtype">int</font> numatoms;
<a name="l00028"></a><a class="code" href="structcpmddata.html#m2">00028</a>   <font class="keyword">const</font> <font class="keywordtype">char</font> *file_name;
00029 } <a class="code" href="structcpmddata.html">cpmddata</a>;
00030  
<a name="l00031"></a><a class="code" href="cpmdplugin_8c.html#a1">00031</a> <font class="keyword">static</font> <font class="keywordtype">void</font> *<a class="code" href="cpmdplugin_8c.html#a1">open_cpmd_read</a>(<font class="keyword">const</font> <font class="keywordtype">char</font> *filename, <font class="keyword">const</font> <font class="keywordtype">char</font> *filetype, 
00032                            <font class="keywordtype">int</font> *natoms) {
00033   FILE *fd;
00034   <a class="code" href="structcpmddata.html">cpmddata</a> *data;
00035   <font class="keywordtype">char</font> linebuf[255];
00036   <font class="keywordtype">int</font> i, nfi_first, nfi_current, atomcount;
00037  
00038   printf(<font class="stringliteral">"cpmd) trying to open file '%s'\n"</font>,filename);
00039           
00040   fd = fopen(filename, <font class="stringliteral">"rb"</font>);
00041   <font class="keywordflow">if</font> (!fd) <font class="keywordflow">return</font> NULL;
00042   
00043   data = (<a class="code" href="structcpmddata.html">cpmddata</a> *)malloc(<font class="keyword">sizeof</font>(<a class="code" href="structcpmddata.html">cpmddata</a>));
00044   data-&gt;<a class="code" href="structcpmddata.html#m0">file</a> = fd;
00045   data-&gt;<a class="code" href="structcpmddata.html#m2">file_name</a> = filename;
00046 
00047   nfi_first = 0;
00048   nfi_current = 0;
00049 
00050   <font class="comment">/* first column is the current timestep number  */</font>
00051   fgets(linebuf, 255, fd);
00052   i = sscanf(linebuf, <font class="stringliteral">"%d"</font>, &amp;nfi_first);
00053   <font class="keywordflow">if</font> (i &lt; 1) {
00054     fprintf(stderr, <font class="stringliteral">"read) cpmd trajectory file '%s' should have the timestep number "</font>
00055             <font class="stringliteral">"in the first column\n"</font>, filename);
00056     <font class="keywordflow">return</font> NULL;
00057   }
00058   atomcount   = 0;
00059   nfi_current = nfi_first;
00060 
00061   <font class="comment">/* loop through file until the contents of the first column</font>
00062 <font class="comment">     changes, indicating the end of a configuration */</font>
00063   <font class="keywordflow">while</font> ((nfi_first == nfi_current) &amp;&amp; !ferror(fd) &amp;&amp; !feof(fd)) {
00064     ++atomcount;
00065     fgets(linebuf, 255, fd);
00066     i = sscanf(linebuf, <font class="stringliteral">"%d"</font>, &amp;nfi_current);
00067     <font class="keywordflow">if</font> (i &lt; 1) {
00068       fprintf(stderr, <font class="stringliteral">"read) cpmd trajectory file '%s' should have the "</font>
00069               <font class="stringliteral">"timestep number in the first column\n"</font>, filename);
00070       <font class="keywordflow">return</font> NULL;
00071     }
00072   }
00073   printf(<font class="stringliteral">"cpmd) found %d atoms in first timestep\n"</font>,atomcount);
00074   *natoms = atomcount;
00075   data-&gt;<a class="code" href="structcpmddata.html#m1">numatoms</a>=*natoms;
00076 
00077   <font class="comment">/* rewind to the beginning for reading the coordinates elsewhere.*/</font>
00078   rewind(fd);
00079 
00080   <font class="keywordflow">return</font> data;
00081 }
00082 
<a name="l00083"></a><a class="code" href="cpmdplugin_8c.html#a2">00083</a> <font class="keyword">static</font> <font class="keywordtype">int</font> <a class="code" href="cpmdplugin_8c.html#a2">read_cpmd_structure</a>(<font class="keywordtype">void</font> *mydata, <font class="keywordtype">int</font> *optflags, 
00084                               <a class="code" href="structmolfile__atom__t.html">molfile_atom_t</a> *atoms) {
00085   <font class="keywordtype">int</font> i, j;
00086   <font class="keywordtype">char</font> *k;
00087   <font class="keywordtype">float</font> coord;
00088   <a class="code" href="structmolfile__atom__t.html">molfile_atom_t</a> *atom;
00089   <a class="code" href="structcpmddata.html">cpmddata</a> *data = (<a class="code" href="structcpmddata.html">cpmddata</a> *)mydata;
00090   
00091   printf(<font class="stringliteral">"cpmd) trying to read structure\n"</font>);
00092   *optflags = <a class="code" href="molfile__plugin_8h.html#a8">MOLFILE_NOOPTIONS</a>; <font class="comment">/* no optional data */</font>
00093 
00094   <font class="keywordflow">for</font>(i=0;i&lt;data-&gt;<a class="code" href="structcpmddata.html#m1">numatoms</a>;i++) {
00095     <font class="keywordtype">char</font> buffer[1024];
00096     <font class="keywordtype">char</font> fbuffer[1024];
00097     k = fgets(fbuffer, 1024, data-&gt;<a class="code" href="structcpmddata.html#m0">file</a>);
00098     atom = atoms + i;
00099     j=sscanf(fbuffer, <font class="stringliteral">"%s %f %f %f"</font>, buffer, &amp;coord, &amp;coord, &amp;coord);
00100     <font class="keywordflow">if</font> (k == NULL) {
00101       fprintf(stderr, <font class="stringliteral">"cpmd structure) missing atom(s) in file '%s'\n"</font>,data-&gt;<a class="code" href="structcpmddata.html#m2">file_name</a>);
00102       fprintf(stderr, <font class="stringliteral">"cpmd structure) expecting '%d' atoms, found only '%d'\n"</font>,data-&gt;<a class="code" href="structcpmddata.html#m1">numatoms</a>,i+1);
00103       <font class="keywordflow">return</font> <a class="code" href="molfile__plugin_8h.html#a4">MOLFILE_ERROR</a>;
00104     } <font class="keywordflow">else</font> <font class="keywordflow">if</font> (j &lt; 4) {
00105       fprintf(stderr, <font class="stringliteral">"cpmd structure) missing type or coordinate(s) in file '%s' for atom '%d'\n"</font>,data-&gt;<a class="code" href="structcpmddata.html#m2">file_name</a>,i+1);
00106       <font class="keywordflow">return</font> <a class="code" href="molfile__plugin_8h.html#a4">MOLFILE_ERROR</a>;
00107     }
00108 
00109     <font class="comment">/* I don't know what to do with these */</font>
00110     strncpy(atom-&gt;<a class="code" href="structmolfile__atom__t.html#m0">name</a>, buffer, <font class="keyword">sizeof</font>(atom-&gt;<a class="code" href="structmolfile__atom__t.html#m0">name</a>));
00111     strncpy(atom-&gt;<a class="code" href="structmolfile__atom__t.html#m1">type</a>, buffer, <font class="keyword">sizeof</font>(atom-&gt;<a class="code" href="structmolfile__atom__t.html#m1">type</a>));
00112     atom-&gt;<a class="code" href="structmolfile__atom__t.html#m2">resname</a>[0] = <font class="charliteral">'\0'</font>;
00113     atom-&gt;<a class="code" href="structmolfile__atom__t.html#m3">resid</a> = 1;
00114     atom-&gt;<a class="code" href="structmolfile__atom__t.html#m5">chain</a>[0] = <font class="charliteral">'\0'</font>;
00115     atom-&gt;<a class="code" href="structmolfile__atom__t.html#m4">segid</a>[0] = <font class="charliteral">'\0'</font>;
00116     <font class="comment">/* skip to the end of line */</font>
00117   }
00118 
00119   rewind(data-&gt;<a class="code" href="structcpmddata.html#m0">file</a>);
00120   <font class="keywordflow">return</font> <a class="code" href="molfile__plugin_8h.html#a2">MOLFILE_SUCCESS</a>;
00121 }
00122 
<a name="l00123"></a><a class="code" href="cpmdplugin_8c.html#a3">00123</a> <font class="keyword">static</font> <font class="keywordtype">int</font> <a class="code" href="cpmdplugin_8c.html#a3">read_cpmd_timestep</a>(<font class="keywordtype">void</font> *mydata, <font class="keywordtype">int</font> natoms, <a class="code" href="structmolfile__timestep__t.html">molfile_timestep_t</a> *ts) {
00124   <font class="keywordtype">int</font> i, j, nfi_first, nfi_current;
00125   <font class="keywordtype">char</font> fbuffer[1024];
00126   <font class="keywordtype">float</font> x, y, z;
00127   <font class="keyword">const</font> <font class="keywordtype">float</font> bohr=0.529177249;
00128   <font class="keywordtype">char</font> *k;
00129   
00130   <a class="code" href="structcpmddata.html">cpmddata</a> *data = (<a class="code" href="structcpmddata.html">cpmddata</a> *)mydata;
00131   nfi_first = nfi_current = -1;
00132   
00133   <font class="comment">/* read the coordinates */</font>
00134   <font class="keywordflow">for</font> (i=0; i&lt;natoms; i++) {
00135 
00136     k = fgets(fbuffer, 1024, data-&gt;<a class="code" href="structcpmddata.html#m0">file</a>);
00137 
00138     <font class="comment">/* read next line if this is a continuation indicator */</font>
00139     <font class="keywordflow">if</font> (strstr(fbuffer, <font class="stringliteral">"NEW DATA"</font>)) {
00140       k = fgets(fbuffer, 1024, data-&gt;<a class="code" href="structcpmddata.html#m0">file</a>);
00141     }
00142     j = sscanf(fbuffer, <font class="stringliteral">"%d %f %f %f"</font>, &amp;nfi_current, &amp;x, &amp;y, &amp;z);
00143     <font class="keywordflow">if</font> (nfi_first &lt; 0) nfi_first = nfi_current;
00144     
00145     <font class="keywordflow">if</font> (k == NULL) {
00146       <font class="keywordflow">return</font> <a class="code" href="molfile__plugin_8h.html#a4">MOLFILE_ERROR</a>;
00147     } <font class="keywordflow">else</font> <font class="keywordflow">if</font> (j &lt; 4) {
00148       fprintf(stderr, <font class="stringliteral">"cpmd timestep) missing or illegal data in file"</font>
00149               <font class="stringliteral">" '%s' for atom '%d'\n"</font>,data-&gt;<a class="code" href="structcpmddata.html#m2">file_name</a>,i+1);
00150       <font class="keywordflow">return</font> <a class="code" href="molfile__plugin_8h.html#a4">MOLFILE_ERROR</a>;
00151     } <font class="keywordflow">else</font> <font class="keywordflow">if</font> (nfi_first != nfi_current) {
00152       fprintf(stderr, <font class="stringliteral">"cpmd timestep) short record in timestep %d of file"</font>
00153               <font class="stringliteral">" '%s' for atom '%d'\n"</font>,nfi_first, data-&gt;<a class="code" href="structcpmddata.html#m2">file_name</a>,i+1);
00154     }
00155     
00156     ts-&gt;<a class="code" href="structmolfile__timestep__t.html#m0">coords</a>[3*i  ] = x*bohr;
00157     ts-&gt;<a class="code" href="structmolfile__timestep__t.html#m0">coords</a>[3*i+1] = y*bohr;
00158     ts-&gt;<a class="code" href="structmolfile__timestep__t.html#m0">coords</a>[3*i+2] = z*bohr;
00159   }
00160 
00161   <font class="keywordflow">return</font> <a class="code" href="molfile__plugin_8h.html#a2">MOLFILE_SUCCESS</a>;
00162 }
00163     
<a name="l00164"></a><a class="code" href="cpmdplugin_8c.html#a4">00164</a> <font class="keyword">static</font> <font class="keywordtype">void</font> <a class="code" href="cpmdplugin_8c.html#a4">close_cpmd_read</a>(<font class="keywordtype">void</font> *mydata) {
00165   <a class="code" href="structcpmddata.html">cpmddata</a> *data = (<a class="code" href="structcpmddata.html">cpmddata</a> *)mydata;
00166   
00167   fclose(data-&gt;<a class="code" href="structcpmddata.html#m0">file</a>);
00168   free(data);
00169 }
00170 
00171 
00172 <font class="comment">/* registration stuff */</font>
<a name="l00173"></a><a class="code" href="cpmdplugin_8c.html#a0">00173</a> <font class="keyword">static</font> <a class="code" href="structmolfile__plugin__t.html">molfile_plugin_t</a> <a class="code" href="cpmdplugin_8c.html#a0">cpmdplugin</a> = {
00174   <a class="code" href="vmdplugin_8h.html#a10">vmdplugin_ABIVERSION</a>,
00175   <a class="code" href="molfile__plugin_8h.html#a0">MOLFILE_PLUGIN_TYPE</a>,                         <font class="comment">/* type */</font>
00176   <font class="stringliteral">"cpmd"</font>,                                      <font class="comment">/* short name */</font>
00177   <font class="stringliteral">"CPMD"</font>,                                      <font class="comment">/* pretty name */</font>
00178   <font class="stringliteral">"Axel Kohlmeyer, John E. Stone"</font>,             <font class="comment">/* author */</font>
00179   0,                                           <font class="comment">/* major version */</font>
00180   3,                                           <font class="comment">/* minor version */</font>
00181   <a class="code" href="vmdplugin_8h.html#a12">VMDPLUGIN_THREADSAFE</a>,                        <font class="comment">/* is reentrant */</font>
00182   <font class="stringliteral">"cpmd"</font>,
00183   <a class="code" href="cpmdplugin_8c.html#a1">open_cpmd_read</a>,
00184 <font class="comment">/*  read_cpmd_structure */</font>
00185   0,
00186   0,
00187   <a class="code" href="cpmdplugin_8c.html#a3">read_cpmd_timestep</a>,
00188   <a class="code" href="cpmdplugin_8c.html#a4">close_cpmd_read</a>,
00189 <font class="comment">/*  open_cpmd_write, */</font>
00190   0,
00191   0,
00192 <font class="comment">/*  write_cpmd_timestep, */</font>
00193   0,
00194 <font class="comment">/*  close_cpmd_write */</font>
00195   0
00196 };
00197 
<a name="l00198"></a><a class="code" href="cpmdplugin_8c.html#a5">00198</a> <a class="code" href="vmdplugin_8h.html#a7">VMDPLUGIN_API</a> <font class="keywordtype">int</font> <a class="code" href="vmdplugin_8h.html#a5">VMDPLUGIN_init</a>() {
00199   <font class="keywordflow">return</font> <a class="code" href="vmdplugin_8h.html#a13">VMDPLUGIN_SUCCESS</a>;
00200 }
00201 
<a name="l00202"></a><a class="code" href="cpmdplugin_8c.html#a6">00202</a> <a class="code" href="vmdplugin_8h.html#a7">VMDPLUGIN_API</a> <font class="keywordtype">int</font> <a class="code" href="vmdplugin_8h.html#a3">VMDPLUGIN_register</a>(<font class="keywordtype">void</font> *v, <a class="code" href="vmdplugin_8h.html#a15">vmdplugin_register_cb</a> cb) {
00203   (*cb)(v, (<a class="code" href="structvmdplugin__t.html">vmdplugin_t</a> *)&amp;cpmdplugin);
00204   <font class="keywordflow">return</font> <a class="code" href="vmdplugin_8h.html#a13">VMDPLUGIN_SUCCESS</a>;
00205 }
00206 
<a name="l00207"></a><a class="code" href="cpmdplugin_8c.html#a7">00207</a> <a class="code" href="vmdplugin_8h.html#a7">VMDPLUGIN_API</a> <font class="keywordtype">int</font> <a class="code" href="vmdplugin_8h.html#a6">VMDPLUGIN_fini</a>() {
00208   <font class="keywordflow">return</font> <a class="code" href="vmdplugin_8h.html#a13">VMDPLUGIN_SUCCESS</a>;
00209 }
00210 
</pre></div><hr><address><small>Generated on Wed Mar 22 13:15:28 2006 for VMD Plugins (current) by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.gif" alt="doxygen" align="middle" border=0 
width=110 height=53></a>1.2.14 written by <a href="mailto:dimitri@stack.nl">Dimitri van Heesch</a>,
 &copy;&nbsp;1997-2002</small></address>
</body>
</html>
