<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>msmsplugin.C Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.2.14 -->
<center>
<a class="qindex" href="index.html">Main Page</a> &nbsp; <a class="qindex" href="classes.html">Alphabetical List</a> &nbsp; <a class="qindex" href="annotated.html">Compound List</a> &nbsp; <a class="qindex" href="files.html">File List</a> &nbsp; <a class="qindex" href="functions.html">Compound Members</a> &nbsp; <a class="qindex" href="globals.html">File Members</a> &nbsp; <a class="qindex" href="pages.html">Related Pages</a> &nbsp; </center>
<hr><h1>msmsplugin.C</h1><a href="msmsplugin_8C.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 <font class="comment">/***************************************************************************</font>
00002 <font class="comment"> *cr</font>
00003 <font class="comment"> *cr            (C) Copyright 1995-2006 The Board of Trustees of the</font>
00004 <font class="comment"> *cr                        University of Illinois</font>
00005 <font class="comment"> *cr                         All Rights Reserved</font>
00006 <font class="comment"> *cr</font>
00007 <font class="comment"> ***************************************************************************/</font>
00008 
00009 <font class="comment">/***************************************************************************</font>
00010 <font class="comment"> * RCS INFORMATION:</font>
00011 <font class="comment"> *</font>
00012 <font class="comment"> *      $RCSfile: msmsplugin.C,v $</font>
00013 <font class="comment"> *      $Author: johns $       $Locker:  $             $State: Exp $</font>
00014 <font class="comment"> *      $Revision: 1.7 $       $Date: 2006/02/23 19:36:45 $</font>
00015 <font class="comment"> *</font>
00016 <font class="comment"> ***************************************************************************/</font>
00017 
00018 <font class="comment">/* </font>
00019 <font class="comment"> * Reader for MSMS surface files</font>
00020 <font class="comment"> */</font>
00021 <font class="preprocessor">#include &lt;stdio.h&gt;</font>
00022 <font class="preprocessor">#include &lt;stdlib.h&gt;</font>
00023 <font class="comment">//#include &lt;math.h&gt;</font>
00024 <font class="preprocessor">#include &lt;string.h&gt;</font>
00025 <font class="preprocessor">#include "<a class="code" href="molfile__plugin_8h.html">molfile_plugin.h</a>"</font>
00026 
<a name="l00027"></a><a class="code" href="structmsms__t.html">00027</a> <font class="keyword">typedef</font> <font class="keyword">struct </font>{
<a name="l00028"></a><a class="code" href="structmsms__t.html#m0">00028</a>   FILE *ffd;
<a name="l00029"></a><a class="code" href="structmsms__t.html#m1">00029</a>   FILE *vfd;
<a name="l00030"></a><a class="code" href="structmsms__t.html#m2">00030</a>   <a class="code" href="structmolfile__graphics__t.html">molfile_graphics_t</a> *graphics;
00031 } <a class="code" href="structmsms__t.html">msms_t</a>;
00032 
<a name="l00033"></a><a class="code" href="msmsplugin_8C.html#a1">00033</a> <font class="keyword">static</font> <font class="keywordtype">void</font> *<a class="code" href="webpdbplugin_8c.html#a5">open_file_read</a>(<font class="keyword">const</font> <font class="keywordtype">char</font> *filepath, <font class="keyword">const</font> <font class="keywordtype">char</font> *filetype,
00034     <font class="keywordtype">int</font> *natoms) {
00035   FILE *ffd; <font class="comment">// face file</font>
00036   FILE *vfd; <font class="comment">// vertex file</font>
00037   <a class="code" href="structmsms__t.html">msms_t</a> *msms;
00038   <font class="keywordtype">char</font> * facefilepath;
00039   <font class="keywordtype">char</font> * vertfilepath;
00040   <font class="keywordtype">char</font> * cp;
00041 
00042   <font class="keywordtype">int</font> filenamelen = strlen(filepath);
00043   facefilepath = (<font class="keywordtype">char</font> *) malloc(filenamelen + 10);
00044   vertfilepath = (<font class="keywordtype">char</font> *) malloc(filenamelen + 10);
00045   strcpy(facefilepath, filepath);
00046   strcpy(vertfilepath, filepath);
00047 
00048   <font class="comment">// require the MSMS output filenames to match what MSMS does</font>
00049   <font class="comment">// If the user selected the .face file or the .vert file, we should</font>
00050   <font class="comment">// be able to cope either way by assigning the right filenames to the</font>
00051   <font class="comment">// right strings and getting the right files opened accordingly.</font>
00052   cp = strstr(facefilepath, <font class="stringliteral">".face"</font>);
00053   <font class="keywordflow">if</font> (cp == NULL) {
00054     cp = strstr(facefilepath, <font class="stringliteral">".vert"</font>);
00055     <font class="keywordflow">if</font> (cp != NULL) {
00056        strcpy(cp, <font class="stringliteral">".face"</font>);
00057     } <font class="keywordflow">else</font> {
00058       printf(<font class="stringliteral">"msmsplugin) file names don't match expected MSMS output\n"</font>);
00059       free(facefilepath);
00060       free(vertfilepath);
00061       <font class="keywordflow">return</font> NULL;
00062     } 
00063   }
00064   cp = strstr(vertfilepath, <font class="stringliteral">".vert"</font>);
00065   <font class="keywordflow">if</font> (cp == NULL) {
00066     cp = strstr(vertfilepath, <font class="stringliteral">".face"</font>);
00067     <font class="keywordflow">if</font> (cp != NULL) {
00068        strcpy(cp, <font class="stringliteral">".vert"</font>);
00069     } <font class="keywordflow">else</font> {
00070       printf(<font class="stringliteral">"msmsplugin) file names don't match expected MSMS output\n"</font>);
00071       free(facefilepath);
00072       free(vertfilepath);
00073       <font class="keywordflow">return</font> NULL;
00074     } 
00075   }
00076  
00077   ffd = fopen(facefilepath, <font class="stringliteral">"r"</font>);
00078   vfd = fopen(vertfilepath, <font class="stringliteral">"r"</font>);
00079   <font class="keywordflow">if</font> (!ffd || !vfd) { 
00080     printf(<font class="stringliteral">"msmsplugin) failed to open either the MSMS face or vertex file\n"</font>);
00081     <font class="keywordflow">if</font> (ffd) fclose(ffd);
00082     <font class="keywordflow">if</font> (vfd) fclose(vfd);
00083     free(facefilepath);
00084     free(vertfilepath);
00085     <font class="keywordflow">return</font> NULL;
00086   }
00087   msms = <font class="keyword">new</font> <a class="code" href="structmsms__t.html">msms_t</a>;
00088   msms-&gt;<a class="code" href="structmsms__t.html#m0">ffd</a> = ffd;
00089   msms-&gt;<a class="code" href="structmsms__t.html#m1">vfd</a> = vfd;
00090   msms-&gt;<a class="code" href="structmsms__t.html#m2">graphics</a> = NULL;
00091   *natoms = 0;
00092   <font class="keywordflow">return</font> msms;
00093 }
00094 
<a name="l00095"></a><a class="code" href="msmsplugin_8C.html#a2">00095</a> <font class="keyword">static</font> <font class="keywordtype">int</font> <a class="code" href="stlplugin_8C.html#a3">read_rawgraphics</a>(<font class="keywordtype">void</font> *v, <font class="keywordtype">int</font> *nelem, 
00096     <font class="keyword">const</font> <a class="code" href="structmolfile__graphics__t.html">molfile_graphics_t</a> **data) {
00097   <a class="code" href="structmsms__t.html">msms_t</a> *msms = (<a class="code" href="structmsms__t.html">msms_t</a> *)v;
00098   <font class="keywordtype">int</font> i, t;
00099   <font class="keywordtype">float</font> tf;
00100   <font class="keywordtype">int</font> facecount=0;
00101   <font class="keywordtype">int</font> vertexcount=0;
00102   <font class="comment">// count number of faces</font>
00103   <font class="keywordflow">while</font> (fscanf(msms-&gt;<a class="code" href="structmsms__t.html#m0">ffd</a>, <font class="stringliteral">"%d %d %d %d %d"</font>, &amp;t, &amp;t, &amp;t, &amp;t, &amp;t) == 5) 
00104     facecount++;
00105   rewind(msms-&gt;<a class="code" href="structmsms__t.html#m0">ffd</a>);
00106   <font class="comment">// count number of vertices</font>
00107   <font class="keywordflow">while</font> (fscanf(msms-&gt;<a class="code" href="structmsms__t.html#m1">vfd</a>, <font class="stringliteral">"%f %f %f %f %f %f %d %d %d"</font>, 
00108          &amp;tf, &amp;tf, &amp;tf, &amp;tf, &amp;tf, &amp;tf, &amp;t, &amp;t, &amp;t) == 9)
00109     vertexcount++;
00110   rewind(msms-&gt;<a class="code" href="structmsms__t.html#m1">vfd</a>);
00111 
00112   <font class="comment">// simple sanity check to insure we have at least one usable triangle</font>
00113   <font class="keywordflow">if</font> (facecount &lt; 1 || vertexcount &lt; 3) 
00114     <font class="keywordflow">return</font> <a class="code" href="molfile__plugin_8h.html#a4">MOLFILE_ERROR</a>;
00115 
00116   <font class="comment">// allocate storage for vertex and normal data</font>
00117   <font class="keywordtype">float</font> *vertex = <font class="keyword">new</font> <font class="keywordtype">float</font>[3 * vertexcount];
00118   <font class="keywordtype">float</font> *normal = <font class="keyword">new</font> <font class="keywordtype">float</font>[3 * vertexcount];
00119 
00120   <font class="comment">// read in the vertex data</font>
00121   <font class="keywordflow">for</font> (i=0; i&lt;vertexcount; i++) {
00122     <font class="keywordtype">int</font> addr = i * 3;
00123     <font class="keywordtype">int</font> atomid, l0fa, l;
00124     fscanf(msms-&gt;<a class="code" href="structmsms__t.html#m1">vfd</a>, <font class="stringliteral">"%f %f %f %f %f %f %d %d %d"</font>,
00125            &amp;vertex[addr], &amp;vertex[addr+1], &amp;vertex[addr+2], 
00126            &amp;normal[addr], &amp;normal[addr+1], &amp;normal[addr+2], &amp;l0fa, &amp;atomid, &amp;l);
00127   }
00128  
00129   <font class="comment">// allocate the graphics objects, read in the facet data and </font>
00130   <font class="comment">// copy the vertex coordinates into triangles as necessary </font>
00131   msms-&gt;<a class="code" href="structmsms__t.html#m2">graphics</a> = <font class="keyword">new</font> <a class="code" href="structmolfile__graphics__t.html">molfile_graphics_t</a>[2*facecount];
00132 
00133   <font class="comment">// read in the facet data</font>
00134   <font class="keywordflow">for</font> (i=0; i&lt;facecount; i++) {
00135     <font class="keywordtype">int</font> v0, v1, v2, surftype, ana;
00136     <font class="comment">// set the graphics object type</font>
00137     msms-&gt;<a class="code" href="structmsms__t.html#m2">graphics</a>[2*i    ].<a class="code" href="structmolfile__graphics__t.html#m0">type</a> = <a class="code" href="molfile__plugin_8h.html#a30a20">MOLFILE_TRINORM</a>;  
00138     msms-&gt;<a class="code" href="structmsms__t.html#m2">graphics</a>[2*i + 1].<a class="code" href="structmolfile__graphics__t.html#m0">type</a> = <a class="code" href="molfile__plugin_8h.html#a30a21">MOLFILE_NORMS</a>;
00139 
00140     <font class="comment">// read in the next facet</font>
00141     fscanf(msms-&gt;<a class="code" href="structmsms__t.html#m0">ffd</a>, <font class="stringliteral">"%d %d %d %d %d"</font>, &amp;v0, &amp;v1, &amp;v2, &amp;surftype, &amp;ana);
00142     v0--; <font class="comment">// convert from 1-based indexing to 0-based indexing</font>
00143     v1--;
00144     v2--;
00145 
00146     <font class="comment">// copy the triangle vertices</font>
00147     <font class="keywordtype">float</font> *tri = msms-&gt;<a class="code" href="structmsms__t.html#m2">graphics</a>[2*i    ].<a class="code" href="structmolfile__graphics__t.html#m3">data</a>;
00148     <font class="keywordtype">float</font> *nrm = msms-&gt;<a class="code" href="structmsms__t.html#m2">graphics</a>[2*i + 1].<a class="code" href="structmolfile__graphics__t.html#m3">data</a>;
00149     memcpy(tri  , vertex+(3*v0), 3*<font class="keyword">sizeof</font>(<font class="keywordtype">float</font>)); 
00150     memcpy(tri+3, vertex+(3*v1), 3*<font class="keyword">sizeof</font>(<font class="keywordtype">float</font>)); 
00151     memcpy(tri+6, vertex+(3*v2), 3*<font class="keyword">sizeof</font>(<font class="keywordtype">float</font>)); 
00152     memcpy(nrm  , normal+(3*v0), 3*<font class="keyword">sizeof</font>(<font class="keywordtype">float</font>)); 
00153     memcpy(nrm+3, normal+(3*v1), 3*<font class="keyword">sizeof</font>(<font class="keywordtype">float</font>)); 
00154     memcpy(nrm+6, normal+(3*v2), 3*<font class="keyword">sizeof</font>(<font class="keywordtype">float</font>)); 
00155   }
00156 
00157   <font class="comment">// set the result array pointers</font>
00158   *nelem = 2*facecount;
00159   *data = msms-&gt;<a class="code" href="structmsms__t.html#m2">graphics</a>;
00160 
00161   <font class="comment">// delete work area storage</font>
00162   <font class="keyword">delete</font> [] normal;
00163   <font class="keyword">delete</font> [] vertex;
00164 
00165   <font class="keywordflow">return</font> <a class="code" href="molfile__plugin_8h.html#a2">MOLFILE_SUCCESS</a>;
00166 }
00167 
00168 
<a name="l00169"></a><a class="code" href="msmsplugin_8C.html#a3">00169</a> <font class="keyword">static</font> <font class="keywordtype">void</font> <a class="code" href="stlplugin_8C.html#a4">close_file_read</a>(<font class="keywordtype">void</font> *v) {
00170   <a class="code" href="structmsms__t.html">msms_t</a> *msms = (<a class="code" href="structmsms__t.html">msms_t</a> *)v;
00171   fclose(msms-&gt;<a class="code" href="structmsms__t.html#m0">ffd</a>);
00172   fclose(msms-&gt;<a class="code" href="structmsms__t.html#m1">vfd</a>);
00173   <font class="keyword">delete</font> [] msms-&gt;<a class="code" href="structmsms__t.html#m2">graphics</a>;
00174   <font class="keyword">delete</font> msms;
00175 }
00176 
00177 
00178 <font class="comment">/*</font>
00179 <font class="comment"> * Initialization stuff here</font>
00180 <font class="comment"> */</font>
<a name="l00181"></a><a class="code" href="msmsplugin_8C.html#a0">00181</a> <font class="keyword">static</font> <a class="code" href="structmolfile__plugin__t.html">molfile_plugin_t</a> <a class="code" href="msmsplugin_8C.html#a0">plugin</a> = {
00182   <a class="code" href="vmdplugin_8h.html#a10">vmdplugin_ABIVERSION</a>,               <font class="comment">// ABI version</font>
00183   <a class="code" href="molfile__plugin_8h.html#a0">MOLFILE_PLUGIN_TYPE</a>,                <font class="comment">// type of plugin</font>
00184   <font class="stringliteral">"msms"</font>,                             <font class="comment">// short name of plugin</font>
00185   <font class="stringliteral">"MSMS Surface Mesh"</font>,                <font class="comment">// pretty name of plugin</font>
00186   <font class="stringliteral">"John Stone"</font>,                       <font class="comment">// author</font>
00187   0,                                  <font class="comment">// major version</font>
00188   2,                                  <font class="comment">// minor version</font>
00189   <a class="code" href="vmdplugin_8h.html#a12">VMDPLUGIN_THREADSAFE</a>,               <font class="comment">// is reentrant</font>
00190   <font class="stringliteral">"face,vert"</font>                         <font class="comment">// filename extensions </font>
00191 };
00192 
<a name="l00193"></a><a class="code" href="msmsplugin_8C.html#a4">00193</a> <a class="code" href="vmdplugin_8h.html#a7">VMDPLUGIN_API</a> <font class="keywordtype">int</font> <a class="code" href="vmdplugin_8h.html#a5">VMDPLUGIN_init</a>(<font class="keywordtype">void</font>) { <font class="keywordflow">return</font> <a class="code" href="vmdplugin_8h.html#a13">VMDPLUGIN_SUCCESS</a>; }
<a name="l00194"></a><a class="code" href="msmsplugin_8C.html#a5">00194</a> <a class="code" href="vmdplugin_8h.html#a7">VMDPLUGIN_API</a> <font class="keywordtype">int</font> <a class="code" href="vmdplugin_8h.html#a6">VMDPLUGIN_fini</a>(<font class="keywordtype">void</font>) { <font class="keywordflow">return</font> <a class="code" href="vmdplugin_8h.html#a13">VMDPLUGIN_SUCCESS</a>; }
<a name="l00195"></a><a class="code" href="msmsplugin_8C.html#a6">00195</a> <a class="code" href="vmdplugin_8h.html#a7">VMDPLUGIN_API</a> <font class="keywordtype">int</font> <a class="code" href="vmdplugin_8h.html#a3">VMDPLUGIN_register</a>(<font class="keywordtype">void</font> *v, <a class="code" href="vmdplugin_8h.html#a15">vmdplugin_register_cb</a> cb) {
00196   plugin.<a class="code" href="structmolfile__plugin__t.html#m1">open_file_read</a> = <a class="code" href="msmsplugin_8C.html#a1">open_file_read</a>;
00197   plugin.<a class="code" href="structmolfile__plugin__t.html#m12">read_rawgraphics</a> = <a class="code" href="msmsplugin_8C.html#a2">read_rawgraphics</a>;
00198   plugin.<a class="code" href="structmolfile__plugin__t.html#m5">close_file_read</a> = <a class="code" href="msmsplugin_8C.html#a3">close_file_read</a>;
00199   (*cb)(v, (<a class="code" href="structvmdplugin__t.html">vmdplugin_t</a> *)&amp;plugin);
00200   <font class="keywordflow">return</font> <a class="code" href="vmdplugin_8h.html#a13">VMDPLUGIN_SUCCESS</a>;
00201 }
00202 
00203 
</pre></div><hr><address><small>Generated on Wed Mar 22 13:15:30 2006 for VMD Plugins (current) by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.gif" alt="doxygen" align="middle" border=0 
width=110 height=53></a>1.2.14 written by <a href="mailto:dimitri@stack.nl">Dimitri van Heesch</a>,
 &copy;&nbsp;1997-2002</small></address>
</body>
</html>
