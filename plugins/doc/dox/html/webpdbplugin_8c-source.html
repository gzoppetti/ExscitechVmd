<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>webpdbplugin.c Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.2.14 -->
<center>
<a class="qindex" href="index.html">Main Page</a> &nbsp; <a class="qindex" href="classes.html">Alphabetical List</a> &nbsp; <a class="qindex" href="annotated.html">Compound List</a> &nbsp; <a class="qindex" href="files.html">File List</a> &nbsp; <a class="qindex" href="functions.html">Compound Members</a> &nbsp; <a class="qindex" href="globals.html">File Members</a> &nbsp; <a class="qindex" href="pages.html">Related Pages</a> &nbsp; </center>
<hr><h1>webpdbplugin.c</h1><a href="webpdbplugin_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 <font class="comment">/***************************************************************************</font>
00002 <font class="comment"> *cr</font>
00003 <font class="comment"> *cr            (C) Copyright 1995-2006 The Board of Trustees of the</font>
00004 <font class="comment"> *cr                        University of Illinois</font>
00005 <font class="comment"> *cr                         All Rights Reserved</font>
00006 <font class="comment"> *cr</font>
00007 <font class="comment"> ***************************************************************************/</font>
00008 
00009 <font class="comment">/***************************************************************************</font>
00010 <font class="comment"> * RCS INFORMATION:</font>
00011 <font class="comment"> *</font>
00012 <font class="comment"> *      $RCSfile: webpdbplugin.c,v $</font>
00013 <font class="comment"> *      $Author: johns $       $Locker:  $             $State: Exp $</font>
00014 <font class="comment"> *      $Revision: 1.44 $       $Date: 2006/03/01 19:55:25 $</font>
00015 <font class="comment"> *</font>
00016 <font class="comment"> ***************************************************************************/</font>
00017 
00018 <font class="preprocessor">#include &lt;tcl.h&gt;</font>
00019 <font class="preprocessor">#include &lt;stdio.h&gt;</font>
00020 <font class="preprocessor">#include &lt;stdlib.h&gt;</font>
00021 <font class="preprocessor">#include &lt;string.h&gt;</font>
00022 <font class="preprocessor">#include "<a class="code" href="molfile__plugin_8h.html">molfile_plugin.h</a>"</font>
00023 <font class="preprocessor">#include "<a class="code" href="readpdb_8h.html">readpdb.h</a>"</font>
00024 <font class="preprocessor">#include "<a class="code" href="periodic__table_8h.html">periodic_table.h</a>"</font>
00025 
00026 <font class="comment">/*</font>
00027 <font class="comment"> * Load pdb from the RCSB</font>
00028 <font class="comment"> * Uses Tcl</font>
00029 <font class="comment"> */</font>
00030 
00031 <font class="comment">/*</font>
00032 <font class="comment"> * Need my own read_pdb_record because the one in readpdb takes a FILE*.</font>
00033 <font class="comment"> * This one will be better anyway since I don't recopy the string ;-)</font>
00034 <font class="comment"> * Read the given pdb string.  On returning, pos will point to the start of</font>
00035 <font class="comment"> * the next read. </font>
00036 <font class="comment"> */</font> 
<a name="l00037"></a><a class="code" href="webpdbplugin_8c.html#a3">00037</a> <font class="keyword">static</font> <font class="keywordtype">int</font> <a class="code" href="webpdbplugin_8c.html#a3">my_read_pdb_record</a>(<font class="keyword">const</font> <font class="keywordtype">char</font> *pdb, <font class="keywordtype">char</font> **pos) {
00038   <font class="keywordtype">int</font> recType = <a class="code" href="readpdb_8h.html#a19a7">PDB_UNKNOWN</a>;
00039   <font class="keywordtype">char</font> *nlpos;  <font class="comment">/* newline position */</font>
00040 
00041   nlpos = strchr(pdb, <font class="charliteral">'\n'</font>); <font class="comment">/* XXX segv occurs on x86_64 linux */</font>
00042                              <font class="comment">/* loading '1epw' or '1sft'        */</font> 
00043 
00044   <font class="keywordflow">if</font> (!nlpos) {
00045     <font class="keywordflow">return</font> <a class="code" href="readpdb_8h.html#a19a9">PDB_EOF</a>;
00046   } 
00047 
00048   <font class="comment">/* set the next position to the first char after the newline */</font>
00049   *pos = nlpos + 1;
00050 
00051   <font class="comment">/* atom records are the most common */</font>
00052   <font class="keywordflow">if</font> (!strncmp(pdb, <font class="stringliteral">"ATOM "</font>,  5) || !strncmp(pdb, <font class="stringliteral">"HETATM"</font>, 6)) {
00053     <font class="comment">/* Note that by only comparing 5 chars for "ATOM " rather than 6,     */</font>
00054     <font class="comment">/* we allow PDB files containing &gt; 99,999 atoms generated by AMBER    */</font>
00055     <font class="comment">/* to load which would otherwise fail.  Not needed for HETATM since   */</font>
00056     <font class="comment">/* those aren't going to show up in files produced for/by MD engines. */</font>
00057     recType = <a class="code" href="readpdb_8h.html#a19a5">PDB_ATOM</a>;
00058   } <font class="keywordflow">else</font> <font class="keywordflow">if</font> (!strncmp(pdb, <font class="stringliteral">"REMARK"</font>, 6)) {
00059     recType = <a class="code" href="readpdb_8h.html#a19a4">PDB_REMARK</a>;
00060   } <font class="keywordflow">else</font> <font class="keywordflow">if</font> (!strncmp(pdb, <font class="stringliteral">"CRYST1"</font>, 6)) {
00061     recType = <a class="code" href="readpdb_8h.html#a19a10">PDB_CRYST1</a>;
00062   } <font class="keywordflow">else</font> <font class="keywordflow">if</font> (!strncmp(pdb, <font class="stringliteral">"HEADER"</font>, 6)) {
00063     recType = <a class="code" href="readpdb_8h.html#a19a3">PDB_HEADER</a>;
00064   } <font class="keywordflow">else</font> <font class="keywordflow">if</font> (!strncmp(pdb, <font class="stringliteral">"END"</font>, 3)) {  <font class="comment">/* very permissive */</font>
00065     <font class="comment">/* XXX we treat any "ENDxxx" record as an end, to simplify testing */</font>
00066     <font class="comment">/*     since we don't remove trailing '\n' chars                   */</font>
00067 
00068     <font class="comment">/* the only two legal END records are "END   " and "ENDMDL" */</font>
00069     recType = <a class="code" href="readpdb_8h.html#a19a8">PDB_END</a>;
00070   } 
00071 
00072   <font class="keywordflow">return</font> recType;
00073 }
00074 
00075  
00076 <font class="keyword">typedef</font> <font class="keyword">struct </font>{
<a name="l00077"></a><a class="code" href="structpdbdata.html#m16">00077</a>   <font class="keywordtype">char</font> *pdbstr; 
<a name="l00078"></a><a class="code" href="structpdbdata.html#m17">00078</a>   <font class="keywordtype">char</font> *pos;
<a name="l00079"></a><a class="code" href="structpdbdata.html#m1">00079</a>   <font class="keywordtype">int</font> natoms;
<a name="l00080"></a><a class="code" href="structpdbdata.html#m18">00080</a>   <a class="code" href="structmolfile__metadata__t.html">molfile_metadata_t</a> *meta;
<a name="l00081"></a><a class="code" href="structpdbdata.html#m10">00081</a>   <font class="keywordtype">int</font> nconect;
<a name="l00082"></a><a class="code" href="structpdbdata.html#m11">00082</a>   <font class="keywordtype">int</font> nbonds, maxbnum;
<a name="l00083"></a><a class="code" href="structpdbdata.html#m14">00083</a>   <font class="keywordtype">int</font> *from, *to, *idxmap;
00084 } <a class="code" href="structpdbdata.html">pdbdata</a>;
00085 
00086 
<a name="l00087"></a><a class="code" href="webpdbplugin_8c.html#a4">00087</a> <font class="keyword">static</font> <font class="keywordtype">void</font> *<a class="code" href="webpdbplugin_8c.html#a4">pdb_read</a>(<font class="keywordtype">char</font> *pdbstr, <font class="keywordtype">int</font> *natoms) {
00088   <a class="code" href="structpdbdata.html">pdbdata</a> *pdb;
00089   <font class="keywordtype">int</font> indx, nconect;
00090   <font class="keywordtype">char</font> *pos = pdbstr;
00091   <font class="keywordtype">char</font> *next;
00092 
00093   <font class="keywordflow">if</font> (!pdbstr) <font class="keywordflow">return</font> NULL;
00094 
00095   pdb = (<a class="code" href="structpdbdata.html">pdbdata</a> *)malloc(<font class="keyword">sizeof</font>(<a class="code" href="structpdbdata.html">pdbdata</a>));
00096   pdb-&gt;<a class="code" href="structpdbdata.html#m9">meta</a> = (<a class="code" href="structmolfile__metadata__t.html">molfile_metadata_t</a> *) malloc(<font class="keyword">sizeof</font>(<a class="code" href="structmolfile__metadata__t.html">molfile_metadata_t</a>));
00097   memset(pdb-&gt;<a class="code" href="structpdbdata.html#m9">meta</a>, 0, <font class="keyword">sizeof</font>(<a class="code" href="structmolfile__metadata__t.html">molfile_metadata_t</a>));
00098 
00099   pdb-&gt;<a class="code" href="structpdbdata.html#m9">meta</a>-&gt;<a class="code" href="structmolfile__metadata__t.html#m4">remarklen</a> = 0;
00100   pdb-&gt;<a class="code" href="structpdbdata.html#m9">meta</a>-&gt;<a class="code" href="structmolfile__metadata__t.html#m5">remarks</a> = NULL;
00101 
00102   *natoms=0;
00103   nconect=0;
00104   <font class="keywordflow">do</font> {
00105     indx = <a class="code" href="webpdbplugin_8c.html#a3">my_read_pdb_record</a>(pos, &amp;next);
00106     <font class="keywordflow">if</font> (indx == <a class="code" href="readpdb_8h.html#a19a5">PDB_ATOM</a>) {
00107       *natoms += 1;
00108     } <font class="keywordflow">else</font> <font class="keywordflow">if</font> (indx == <a class="code" href="readpdb_8h.html#a19a6">PDB_CONECT</a>) {
00109       nconect++;
00110     } <font class="keywordflow">else</font> <font class="keywordflow">if</font> (indx == <a class="code" href="readpdb_8h.html#a19a3">PDB_HEADER</a>) {
00111       <a class="code" href="readpdb_8h.html#a15">get_pdb_header</a>(pos, pdb-&gt;<a class="code" href="structpdbdata.html#m9">meta</a>-&gt;<a class="code" href="structmolfile__metadata__t.html#m1">accession</a>, pdb-&gt;<a class="code" href="structpdbdata.html#m9">meta</a>-&gt;<a class="code" href="structmolfile__metadata__t.html#m2">date</a>, NULL);
00112       <font class="keywordflow">if</font> (strlen(pdb-&gt;<a class="code" href="structpdbdata.html#m9">meta</a>-&gt;<a class="code" href="structmolfile__metadata__t.html#m1">accession</a>) &gt; 0)
00113         strcpy(pdb-&gt;<a class="code" href="structpdbdata.html#m9">meta</a>-&gt;<a class="code" href="structmolfile__metadata__t.html#m0">database</a>, <font class="stringliteral">"PDB"</font>);
00114     } <font class="keywordflow">else</font> <font class="keywordflow">if</font> (indx == <a class="code" href="readpdb_8h.html#a19a4">PDB_REMARK</a> || indx == <a class="code" href="readpdb_8h.html#a19a7">PDB_UNKNOWN</a>) {
00115       <font class="keywordtype">int</font> len = next - pos;
00116       <font class="keywordtype">int</font> newlen = len + pdb-&gt;<a class="code" href="structpdbdata.html#m9">meta</a>-&gt;<a class="code" href="structmolfile__metadata__t.html#m4">remarklen</a>;
00117 
00118       <font class="keywordtype">char</font> *newstr=realloc(pdb-&gt;<a class="code" href="structpdbdata.html#m9">meta</a>-&gt;<a class="code" href="structmolfile__metadata__t.html#m5">remarks</a>, newlen + 1);
00119       <font class="keywordflow">if</font> (newstr != NULL) {
00120         pdb-&gt;<a class="code" href="structpdbdata.html#m9">meta</a>-&gt;<a class="code" href="structmolfile__metadata__t.html#m5">remarks</a> = newstr;
00121         pdb-&gt;<a class="code" href="structpdbdata.html#m9">meta</a>-&gt;<a class="code" href="structmolfile__metadata__t.html#m5">remarks</a>[pdb-&gt;<a class="code" href="structpdbdata.html#m9">meta</a>-&gt;<a class="code" href="structmolfile__metadata__t.html#m4">remarklen</a>] = <font class="charliteral">'\0'</font>;
00122         memcpy(pdb-&gt;<a class="code" href="structpdbdata.html#m9">meta</a>-&gt;<a class="code" href="structmolfile__metadata__t.html#m5">remarks</a> + pdb-&gt;<a class="code" href="structpdbdata.html#m9">meta</a>-&gt;<a class="code" href="structmolfile__metadata__t.html#m4">remarklen</a>, pos, len);
00123         pdb-&gt;<a class="code" href="structpdbdata.html#m9">meta</a>-&gt;<a class="code" href="structmolfile__metadata__t.html#m5">remarks</a>[newlen] = <font class="charliteral">'\0'</font>;
00124         pdb-&gt;<a class="code" href="structpdbdata.html#m9">meta</a>-&gt;<a class="code" href="structmolfile__metadata__t.html#m4">remarklen</a> = newlen;
00125       }
00126     }
00127 
00128     pos = next;
00129   } <font class="keywordflow">while</font> (indx != <a class="code" href="readpdb_8h.html#a19a8">PDB_END</a> &amp;&amp; indx != <a class="code" href="readpdb_8h.html#a19a9">PDB_EOF</a>);
00130 
00131   pdb-&gt;<a class="code" href="structpdbdata.html#m16">pdbstr</a> = pdbstr;
00132   pdb-&gt;<a class="code" href="structpdbdata.html#m17">pos</a> =    pdbstr;
00133 
00134   pdb-&gt;<a class="code" href="structpdbdata.html#m1">natoms</a> = *natoms;
00135   pdb-&gt;<a class="code" href="structpdbdata.html#m10">nconect</a> = nconect;
00136   pdb-&gt;<a class="code" href="structpdbdata.html#m11">nbonds</a> = 0;
00137   pdb-&gt;<a class="code" href="structpdbdata.html#m12">maxbnum</a> = 0;
00138   pdb-&gt;<a class="code" href="structpdbdata.html#m13">from</a> = NULL;
00139   pdb-&gt;<a class="code" href="structpdbdata.html#m14">to</a> = NULL;
00140   pdb-&gt;<a class="code" href="structpdbdata.html#m15">idxmap</a> = NULL;
00141 
00142 <font class="preprocessor">#if defined(VMDUSECONECTRECORDS)</font>
00143 <font class="preprocessor"></font>  <font class="comment">/* allocate atom index translation table if we have 99,999 atoms or less */</font>
00144   <font class="comment">/* and we have conect records to process                                 */</font>
00145   <font class="keywordflow">if</font> (pdb-&gt;<a class="code" href="structpdbdata.html#m1">natoms</a> &lt; 100000 &amp;&amp; pdb-&gt;<a class="code" href="structpdbdata.html#m10">nconect</a> &gt; 0) {
00146     pdb-&gt;<a class="code" href="structpdbdata.html#m15">idxmap</a> = (<font class="keywordtype">int</font> *) malloc(100000 * <font class="keyword">sizeof</font>(<font class="keywordtype">int</font>));
00147     memset(pdb-&gt;<a class="code" href="structpdbdata.html#m15">idxmap</a>, 0, 100000 * <font class="keyword">sizeof</font>(<font class="keywordtype">int</font>));
00148   }
00149 <font class="preprocessor">#endif</font>
00150 <font class="preprocessor"></font>
00151   <font class="keywordflow">return</font> pdb;
00152 }
00153 
<a name="l00154"></a><a class="code" href="webpdbplugin_8c.html#a0">00154</a> <font class="keyword">static</font> <font class="keyword">const</font> <font class="keywordtype">char</font> *<a class="code" href="webpdbplugin_8c.html#a0">rcsbmsg</a>[] = {
00155   <font class="stringliteral">"  The PDB is supported by RCSB, the NSF, US PHS, NIH, NCRP, NIGMS, NLM,"</font>,
00156   <font class="stringliteral">"and US DoE, who are not liable for the data.  PDB files shall not be"</font>,
00157   <font class="stringliteral">"sold.  See ftp://ftp.rcsb.org/advisory.doc for full details."</font>
00158 };
00159 
<a name="l00160"></a><a class="code" href="webpdbplugin_8c.html#a1">00160</a> <font class="keyword">static</font> <font class="keywordtype">int</font> <a class="code" href="webpdbplugin_8c.html#a1">show_msg</a> = 1;
00161 
<a name="l00162"></a><a class="code" href="webpdbplugin_8c.html#a5">00162</a> <font class="keyword">static</font> <font class="keywordtype">void</font> *<a class="code" href="webpdbplugin_8c.html#a5">open_file_read</a>(<font class="keyword">const</font> <font class="keywordtype">char</font> *filename, <font class="keyword">const</font> <font class="keywordtype">char</font> *filetype,
00163     <font class="keywordtype">int</font> *natoms) {
00164 
00165   Tcl_Interp *interp;
00166   <font class="keywordtype">char</font> url[300];
00167   <font class="keywordtype">char</font> cmd[300]; 
00168   <font class="keywordtype">char</font> *pdbfile;
00169   <font class="keyword">const</font> <font class="keywordtype">char</font> *result;
00170   <font class="keywordtype">void</font> *v;
00171 
00172   <font class="comment">/*</font>
00173 <font class="comment">   * Create and initialize the interpreter</font>
00174 <font class="comment">   */</font>
00175   interp = Tcl_CreateInterp();
00176   <font class="keywordflow">if</font> (!interp) {
00177     fprintf(stderr, <font class="stringliteral">"Could not create new Tcl Interp\n"</font>);
00178     <font class="keywordflow">return</font> NULL; 
00179   }
00180   <font class="keywordflow">if</font> (Tcl_Init(interp) != TCL_OK) {
00181     fprintf(stderr, <font class="stringliteral">"Warning, could not create initialize Tcl Interp\n"</font>);
00182   }
00183   <font class="keywordflow">if</font> (!Tcl_PkgRequire(interp, (<font class="keywordtype">char</font> *)<font class="stringliteral">"http"</font>, (<font class="keywordtype">char</font> *)<font class="stringliteral">"2.0"</font>, 0)) {
00184     fprintf(stderr, <font class="stringliteral">"Could not load http package\n"</font>);
00185     Tcl_DeleteInterp(interp);
00186     <font class="keywordflow">return</font> NULL;
00187   }
00188 
00189   <font class="keywordflow">if</font> (strlen(filename) != 4) {
00190     fprintf(stderr, <font class="stringliteral">"PDB code %s is invalid; PDB accession codes have four letters.\n"</font>, filename);
00191     Tcl_DeleteInterp(interp);
00192     <font class="keywordflow">return</font> NULL;
00193   }
00194 
00195   <font class="keywordflow">if</font> (show_msg) {
00196     <font class="keywordtype">int</font> i;
00197     <a class="code" href="webpdbplugin_8c.html#a1">show_msg</a> = 0;
00198     <font class="keywordflow">for</font> (i=0; i&lt;3; i++) printf(<font class="stringliteral">"%s\n"</font>, <a class="code" href="webpdbplugin_8c.html#a0">rcsbmsg</a>[i]);
00199   }
00200 
00201   <font class="comment">// Adapted to new PDB website layout, changed on 1/1/2006 </font>
00202   sprintf(url, <font class="stringliteral">"http://www.rcsb.org/pdb/downloadFile.do?fileFormat=pdb&amp;compression=NO&amp;structureId=%s"</font>,filename);
00203   sprintf(cmd, <font class="stringliteral">"set token [::http::geturl \"%s\"]"</font>, url);
00204   <font class="keywordflow">if</font> (Tcl_Eval(interp, cmd) != TCL_OK) {
00205     fprintf(stderr, <font class="stringliteral">"Error loading PDB: %s\n"</font>,interp-&gt;result);
00206     Tcl_DeleteInterp(interp);
00207     <font class="keywordflow">return</font> NULL;
00208   } 
00209   sprintf(cmd, <font class="stringliteral">"upvar #0 $token state"</font>);
00210   Tcl_Eval(interp, cmd); 
00211   
00212   result = Tcl_GetVar2(interp, (<font class="keywordtype">char</font> *)<font class="stringliteral">"state"</font>, <font class="stringliteral">"body"</font>, TCL_GLOBAL_ONLY); 
00213   <font class="keywordflow">if</font> (!result) {
00214     fprintf(stderr, <font class="stringliteral">"Error loading PDB: %s\n"</font>, interp-&gt;result);
00215     Tcl_DeleteInterp(interp);
00216     <font class="keywordflow">return</font> NULL;
00217   } 
00218   pdbfile = strdup(result);
00219   Tcl_DeleteInterp(interp);
00220 
00221   <font class="comment">/* XXX this code needs updating still */</font>
00222   <font class="comment">/* pdbfile will be free'd by close_pdb() */</font>
00223   v = <a class="code" href="webpdbplugin_8c.html#a4">pdb_read</a>(pdbfile, natoms); 
00224   <font class="keywordflow">return</font> v;
00225 }
00226    
<a name="l00227"></a><a class="code" href="webpdbplugin_8c.html#a6">00227</a> <font class="keyword">static</font> <font class="keywordtype">int</font> <a class="code" href="webpdbplugin_8c.html#a6">read_pdb_structure</a>(<font class="keywordtype">void</font> *mydata, <font class="keywordtype">int</font> *optflags, 
00228     <a class="code" href="structmolfile__atom__t.html">molfile_atom_t</a> *atoms) {
00229 
00230   <a class="code" href="structpdbdata.html">pdbdata</a> *pdb = (<a class="code" href="structpdbdata.html">pdbdata</a> *)mydata;
00231   <font class="keywordtype">char</font> *pos = pdb-&gt;<a class="code" href="structpdbdata.html#m16">pdbstr</a>;
00232   <font class="keywordtype">char</font> *next;
00233   <font class="keywordtype">int</font> i, rectype, atomserial, pteidx;
00234   <font class="keywordtype">char</font> ridstr[8];
00235   <font class="keywordtype">char</font> elementsymbol[3];
00236   <a class="code" href="structmolfile__atom__t.html">molfile_atom_t</a> *atom;
00237   <font class="keywordtype">int</font> badptecount = 0;
00238   elementsymbol[2]=0;
00239 
00240   *optflags = <a class="code" href="molfile__plugin_8h.html#a9">MOLFILE_INSERTION</a> | <a class="code" href="molfile__plugin_8h.html#a10">MOLFILE_OCCUPANCY</a> | <a class="code" href="molfile__plugin_8h.html#a11">MOLFILE_BFACTOR</a> | 
00241               <a class="code" href="molfile__plugin_8h.html#a15">MOLFILE_ALTLOC</a> | <a class="code" href="molfile__plugin_8h.html#a16">MOLFILE_ATOMICNUMBER</a> | <a class="code" href="molfile__plugin_8h.html#a17">MOLFILE_BONDSSPECIAL</a>;
00242 
00243   i=0; <font class="comment">/* Count atoms */</font>
00244   <font class="keywordflow">do</font> {
00245     rectype = <a class="code" href="webpdbplugin_8c.html#a3">my_read_pdb_record</a>(pos, &amp;next);
00246     <font class="keywordflow">switch</font> (rectype) {
00247     <font class="keywordflow">case</font> <a class="code" href="readpdb_8h.html#a19a5">PDB_ATOM</a>:
00248       atom = atoms+i;
00249       <a class="code" href="readpdb_8h.html#a17">get_pdb_fields</a>(pos, next-pos, &amp;atomserial,
00250           atom-&gt;<a class="code" href="structmolfile__atom__t.html#m0">name</a>, atom-&gt;<a class="code" href="structmolfile__atom__t.html#m2">resname</a>, atom-&gt;<a class="code" href="structmolfile__atom__t.html#m5">chain</a>, atom-&gt;<a class="code" href="structmolfile__atom__t.html#m4">segid</a>, 
00251           ridstr, atom-&gt;<a class="code" href="structmolfile__atom__t.html#m7">insertion</a>, atom-&gt;<a class="code" href="structmolfile__atom__t.html#m6">altloc</a>, elementsymbol,
00252           NULL, NULL, NULL, &amp;atom-&gt;<a class="code" href="structmolfile__atom__t.html#m8">occupancy</a>, &amp;atom-&gt;<a class="code" href="structmolfile__atom__t.html#m9">bfactor</a>);
00253 
00254       <font class="keywordflow">if</font> (pdb-&gt;<a class="code" href="structpdbdata.html#m15">idxmap</a> != NULL &amp;&amp; atomserial &lt; 100000) {
00255         pdb-&gt;<a class="code" href="structpdbdata.html#m15">idxmap</a>[atomserial] = i; <font class="comment">/* record new serial number translation */</font>
00256       }
00257 
00258       atom-&gt;<a class="code" href="structmolfile__atom__t.html#m3">resid</a> = atoi(ridstr);
00259 
00260       <font class="comment">/* determine atomic number from the element symbol */</font>
00261       pteidx = <a class="code" href="periodic__table_8h.html#a8">get_pte_idx_from_string</a>(elementsymbol);
00262       atom-&gt;<a class="code" href="structmolfile__atom__t.html#m13">atomicnumber</a> = pteidx;
00263       <font class="keywordflow">if</font> (pteidx != 0) {
00264         atom-&gt;<a class="code" href="structmolfile__atom__t.html#m10">mass</a> = <a class="code" href="periodic__table_8h.html#a5">get_pte_mass</a>(pteidx);
00265         atom-&gt;<a class="code" href="structmolfile__atom__t.html#m12">radius</a> = <a class="code" href="periodic__table_8h.html#a6">get_pte_vdw_radius</a>(pteidx);
00266       } <font class="keywordflow">else</font> {
00267         badptecount++; <font class="comment">/* unrecognized element */</font>
00268       }
00269 
00270       strcpy(atom-&gt;<a class="code" href="structmolfile__atom__t.html#m1">type</a>, atom-&gt;<a class="code" href="structmolfile__atom__t.html#m0">name</a>);
00271       i++;
00272       <font class="keywordflow">break</font>;
00273 
00274     <font class="keywordflow">case</font> <a class="code" href="readpdb_8h.html#a19a6">PDB_CONECT</a>:
00275       <font class="comment">/* only read CONECT records for structures where we know they can */</font>
00276       <font class="comment">/* be valid for all of the atoms in the structure                 */</font>
00277       <font class="keywordflow">if</font> (pdb-&gt;<a class="code" href="structpdbdata.html#m15">idxmap</a> != NULL) {
00278         <font class="keywordtype">char</font> cbuf[<a class="code" href="readpdb_8h.html#a1">PDB_BUFFER_LENGTH</a>];
00279         <font class="keywordtype">int</font> len = next-pos;
00280 
00281         <font class="keywordflow">if</font> (len &gt; <a class="code" href="readpdb_8h.html#a1">PDB_BUFFER_LENGTH</a>) 
00282           len = <a class="code" href="readpdb_8h.html#a1">PDB_BUFFER_LENGTH</a>;
00283         strncpy(cbuf, pos, len);
00284         <a class="code" href="readpdb_8h.html#a16">get_pdb_conect</a>(cbuf, pdb-&gt;<a class="code" href="structpdbdata.html#m1">natoms</a>, pdb-&gt;<a class="code" href="structpdbdata.html#m15">idxmap</a>,
00285                        &amp;pdb-&gt;<a class="code" href="structpdbdata.html#m12">maxbnum</a>, &amp;pdb-&gt;<a class="code" href="structpdbdata.html#m11">nbonds</a>, &amp;pdb-&gt;<a class="code" href="structpdbdata.html#m13">from</a>, &amp;pdb-&gt;<a class="code" href="structpdbdata.html#m14">to</a>);
00286       }
00287       <font class="keywordflow">break</font>;
00288 
00289     <font class="keywordflow">default</font>:
00290       <font class="comment">/* other record types are ignored in the structure callback */</font>
00291       <font class="comment">/* and are dealt with in the timestep callback or elsewhere */</font>
00292       <font class="keywordflow">break</font>;
00293     }
00294     pos = next;
00295   } <font class="keywordflow">while</font> (rectype != <a class="code" href="readpdb_8h.html#a19a8">PDB_END</a> &amp;&amp; rectype != <a class="code" href="readpdb_8h.html#a19a9">PDB_EOF</a>);
00296 
00297   <font class="comment">/* if all atoms are recognized, set the mass and radius flags too,  */</font>
00298   <font class="comment">/* otherwise let VMD guess these for itself using it's own methods  */</font>
00299   <font class="keywordflow">if</font> (badptecount == 0) {
00300     *optflags |= <a class="code" href="molfile__plugin_8h.html#a12">MOLFILE_MASS</a> | <a class="code" href="molfile__plugin_8h.html#a14">MOLFILE_RADIUS</a>;
00301   }
00302 
00303   <font class="keywordflow">return</font> <a class="code" href="molfile__plugin_8h.html#a2">MOLFILE_SUCCESS</a>;
00304 }
00305 
00306 
<a name="l00307"></a><a class="code" href="webpdbplugin_8c.html#a7">00307</a> <font class="keyword">static</font> <font class="keywordtype">int</font> <a class="code" href="xbgfplugin_8C.html#a11">read_bonds</a>(<font class="keywordtype">void</font> *v, <font class="keywordtype">int</font> *nbonds, <font class="keywordtype">int</font> **fromptr, <font class="keywordtype">int</font> **toptr, <font class="keywordtype">float</font> **bondorder) {
00308   <a class="code" href="structpdbdata.html">pdbdata</a> *pdb = (<a class="code" href="structpdbdata.html">pdbdata</a> *)v;
00309  
00310   *nbonds = 0;
00311   *fromptr = NULL;
00312   *toptr = NULL;
00313   *bondorder = NULL; <font class="comment">/* PDB files don't have bond order information */</font>
00314 
00315 <font class="comment">// The newest plugin API allows us to return CONECT records as</font>
00316 <font class="comment">// additional bonds above and beyond what the distance search returns.</font>
00317 <font class="comment">// Without that feature, we otherwise have to check completeness and</font>
00318 <font class="comment">// ignore them if they don't look to be fully specified for this molecule</font>
00319 <font class="preprocessor">#if !defined(MOLFILE_BONDSSPECIAL)</font>
00320 <font class="preprocessor"></font>  <font class="keywordflow">if</font> (pdb-&gt;<a class="code" href="structpdbdata.html#m1">natoms</a> &gt;= 100000) {
00321     printf(<font class="stringliteral">"webpdbplugin) Warning: more than 99,999 atoms, ignored CONECT records\n"</font>);
00322     <font class="keywordflow">return</font> <a class="code" href="molfile__plugin_8h.html#a2">MOLFILE_SUCCESS</a>;
00323   } <font class="keywordflow">else</font> <font class="keywordflow">if</font> (((float) pdb-&gt;<a class="code" href="structpdbdata.html#m10">nconect</a> / (float) pdb-&gt;<a class="code" href="structpdbdata.html#m1">natoms</a>) &lt;= 0.85) {
00324     printf(<font class="stringliteral">"webpdbplugin) Warning: Probable incomplete bond structure specified,\n"</font>);
00325     printf(<font class="stringliteral">"webpdbplugin)          ignoring CONECT records\n"</font>);
00326     <font class="keywordflow">return</font> <a class="code" href="molfile__plugin_8h.html#a2">MOLFILE_SUCCESS</a>;
00327   } <font class="keywordflow">else</font> <font class="keywordflow">if</font> (pdb-&gt;<a class="code" href="structpdbdata.html#m10">nconect</a> == 0) {
00328     <font class="keywordflow">return</font> <a class="code" href="molfile__plugin_8h.html#a2">MOLFILE_SUCCESS</a>;
00329   }
00330 <font class="preprocessor">#endif</font>
00331 <font class="preprocessor"></font>
00332   *nbonds = pdb-&gt;<a class="code" href="structpdbdata.html#m11">nbonds</a>;
00333   *fromptr = pdb-&gt;<a class="code" href="structpdbdata.html#m13">from</a>;
00334   *toptr = pdb-&gt;<a class="code" href="structpdbdata.html#m14">to</a>;
00335 
00336   <font class="keywordflow">return</font> <a class="code" href="molfile__plugin_8h.html#a2">MOLFILE_SUCCESS</a>;
00337 }
00338 
00339 
<a name="l00340"></a><a class="code" href="webpdbplugin_8c.html#a8">00340</a> <font class="keyword">static</font> <font class="keywordtype">int</font> <a class="code" href="webpdbplugin_8c.html#a8">read_next_timestep</a>(<font class="keywordtype">void</font> *v, <font class="keywordtype">int</font> natoms, <a class="code" href="structmolfile__timestep__t.html">molfile_timestep_t</a> *ts) {
00341   <a class="code" href="structpdbdata.html">pdbdata</a> *pdb = (<a class="code" href="structpdbdata.html">pdbdata</a> *)v;
00342   <font class="keywordtype">char</font> *pos = pdb-&gt;<a class="code" href="structpdbdata.html#m17">pos</a>;
00343   <font class="keywordtype">char</font> *next;
00344   <font class="keywordtype">float</font> *x, *y, *z;
00345   <font class="keywordtype">float</font> occup, bfac;
00346   <font class="keywordtype">int</font> indx, i = 0;
00347 
00348   <font class="keywordflow">if</font> (ts) {
00349     x = ts-&gt;<a class="code" href="structmolfile__timestep__t.html#m0">coords</a>;
00350     y = x+1;
00351     z = x+2;
00352   } <font class="keywordflow">else</font> {
00353     x = y = z = 0;
00354   }
00355   <font class="keywordflow">do</font> {
00356     indx = <a class="code" href="webpdbplugin_8c.html#a3">my_read_pdb_record</a>(pos, &amp;next);
00357     <font class="keywordflow">if</font>((indx == <a class="code" href="readpdb_8h.html#a19a8">PDB_END</a> || indx == <a class="code" href="readpdb_8h.html#a19a9">PDB_EOF</a>) &amp;&amp; (i &lt; pdb-&gt;<a class="code" href="structpdbdata.html#m1">natoms</a>)) {
00358       <font class="keywordflow">return</font> <a class="code" href="molfile__plugin_8h.html#a4">MOLFILE_ERROR</a>;
00359     } <font class="keywordflow">else</font> <font class="keywordflow">if</font>(indx == <a class="code" href="readpdb_8h.html#a19a5">PDB_ATOM</a>) {
00360       <font class="keywordflow">if</font>(i++ &gt;= pdb-&gt;<a class="code" href="structpdbdata.html#m1">natoms</a>) {
00361         <font class="keywordflow">break</font>;
00362       }
00363       <font class="comment">/* just get the coordinates, and store them */</font>
00364       <font class="keywordflow">if</font> (ts) {
00365         <a class="code" href="readpdb_8h.html#a13">get_pdb_coordinates</a>(pos, x, y, z, &amp;occup, &amp;bfac);
00366         x += 3;
00367         y += 3;
00368         z += 3;
00369       }
00370     } <font class="keywordflow">else</font> <font class="keywordflow">if</font> (indx == <a class="code" href="readpdb_8h.html#a19a10">PDB_CRYST1</a>) {
00371       <font class="keywordflow">if</font> (ts) {
00372         <a class="code" href="readpdb_8h.html#a12">get_pdb_cryst1</a>(pos, &amp;ts-&gt;<a class="code" href="structmolfile__timestep__t.html#z4_3">alpha</a>, &amp;ts-&gt;<a class="code" href="structmolfile__timestep__t.html#z4_4">beta</a>, &amp;ts-&gt;<a class="code" href="structmolfile__timestep__t.html#z4_5">gamma</a>,
00373                                &amp;ts-&gt;<a class="code" href="structmolfile__timestep__t.html#z4_0">A</a>, &amp;ts-&gt;<a class="code" href="structmolfile__timestep__t.html#z4_1">B</a>, &amp;ts-&gt;<a class="code" href="structmolfile__timestep__t.html#z4_2">C</a>);
00374       }
00375     }
00376     pos = next;
00377   } <font class="keywordflow">while</font>(!(indx == <a class="code" href="readpdb_8h.html#a19a8">PDB_END</a> || indx == <a class="code" href="readpdb_8h.html#a19a9">PDB_EOF</a>));
00378   pdb-&gt;<a class="code" href="structpdbdata.html#m17">pos</a> = pos;
00379 
00380   <font class="keywordflow">return</font> <a class="code" href="molfile__plugin_8h.html#a2">MOLFILE_SUCCESS</a>;
00381 }
00382 
<a name="l00383"></a><a class="code" href="webpdbplugin_8c.html#a9">00383</a> <font class="keyword">static</font> <font class="keywordtype">void</font> <a class="code" href="webpdbplugin_8c.html#a9">close_pdb_read</a>(<font class="keywordtype">void</font> *v) {
00384   <a class="code" href="structpdbdata.html">pdbdata</a> *pdb = (<a class="code" href="structpdbdata.html">pdbdata</a> *)v;
00385   <font class="keywordflow">if</font> (!pdb) <font class="keywordflow">return</font>;
00386   free(pdb-&gt;<a class="code" href="structpdbdata.html#m16">pdbstr</a>);
00387   <font class="keywordflow">if</font> (pdb-&gt;<a class="code" href="structpdbdata.html#m15">idxmap</a> != NULL)
00388     free(pdb-&gt;<a class="code" href="structpdbdata.html#m15">idxmap</a>);
00389   <font class="keywordflow">if</font> (pdb-&gt;<a class="code" href="structpdbdata.html#m9">meta</a>-&gt;<a class="code" href="structmolfile__metadata__t.html#m5">remarks</a> != NULL)
00390     free(pdb-&gt;<a class="code" href="structpdbdata.html#m9">meta</a>-&gt;<a class="code" href="structmolfile__metadata__t.html#m5">remarks</a>);
00391   <font class="keywordflow">if</font> (pdb-&gt;<a class="code" href="structpdbdata.html#m9">meta</a> != NULL)
00392     free(pdb-&gt;<a class="code" href="structpdbdata.html#m9">meta</a>);
00393   free(pdb);
00394 }
00395 
00396 
<a name="l00397"></a><a class="code" href="webpdbplugin_8c.html#a10">00397</a> <font class="keyword">static</font> <font class="keywordtype">int</font> <a class="code" href="xbgfplugin_8C.html#a16">read_molecule_metadata</a>(<font class="keywordtype">void</font> *v, <a class="code" href="structmolfile__metadata__t.html">molfile_metadata_t</a> **metadata) {
00398   <a class="code" href="structpdbdata.html">pdbdata</a> *pdb = (<a class="code" href="structpdbdata.html">pdbdata</a> *)v;
00399   *metadata = pdb-&gt;<a class="code" href="structpdbdata.html#m9">meta</a>;
00400   <font class="keywordflow">return</font> <a class="code" href="molfile__plugin_8h.html#a2">MOLFILE_SUCCESS</a>;
00401 }
00402 
00403 <font class="comment">/* </font>
00404 <font class="comment"> * Registration stuff</font>
00405 <font class="comment"> */</font>
00406 
<a name="l00407"></a><a class="code" href="webpdbplugin_8c.html#a2">00407</a> <font class="keyword">static</font> <a class="code" href="structmolfile__plugin__t.html">molfile_plugin_t</a> <a class="code" href="webpdbplugin_8c.html#a2">plugin</a> = {
00408   <a class="code" href="vmdplugin_8h.html#a10">vmdplugin_ABIVERSION</a>,             <font class="comment">/* ABI version */</font>
00409   <a class="code" href="molfile__plugin_8h.html#a0">MOLFILE_PLUGIN_TYPE</a>,              <font class="comment">/* type */</font>
00410   <font class="stringliteral">"webpdb"</font>,                         <font class="comment">/* name */</font>
00411   <font class="stringliteral">"Web PDB Download"</font>,               <font class="comment">/* name */</font>
00412   <font class="stringliteral">"Justin Gullingsrud, John Stone"</font>, <font class="comment">/* author */</font>
00413   1,                                <font class="comment">/* major version */</font>
00414   10,                               <font class="comment">/* minor version */</font>
00415   <a class="code" href="vmdplugin_8h.html#a12">VMDPLUGIN_THREADSAFE</a>,             <font class="comment">/* is reentrant */</font>
00416   <font class="stringliteral">""</font>,                               <font class="comment">/* filename extension */</font>
00417   <a class="code" href="webpdbplugin_8c.html#a5">open_file_read</a>,
00418   <a class="code" href="webpdbplugin_8c.html#a6">read_pdb_structure</a>,
00419   <a class="code" href="webpdbplugin_8c.html#a7">read_bonds</a>,
00420   <a class="code" href="webpdbplugin_8c.html#a8">read_next_timestep</a>,
00421   <a class="code" href="webpdbplugin_8c.html#a9">close_pdb_read</a>,
00422   0,
00423   0,
00424   0,
00425   0,
00426   0,
00427   0,
00428   0,
00429   <a class="code" href="webpdbplugin_8c.html#a10">read_molecule_metadata</a>
00430 };
00431 
<a name="l00432"></a><a class="code" href="webpdbplugin_8c.html#a11">00432</a> <a class="code" href="vmdplugin_8h.html#a7">VMDPLUGIN_API</a> <font class="keywordtype">int</font> <a class="code" href="vmdplugin_8h.html#a5">VMDPLUGIN_init</a>() {
00433   <font class="keywordflow">return</font> <a class="code" href="vmdplugin_8h.html#a13">VMDPLUGIN_SUCCESS</a>;
00434 }
00435 
<a name="l00436"></a><a class="code" href="webpdbplugin_8c.html#a12">00436</a> <a class="code" href="vmdplugin_8h.html#a7">VMDPLUGIN_API</a> <font class="keywordtype">int</font> <a class="code" href="vmdplugin_8h.html#a3">VMDPLUGIN_register</a>(<font class="keywordtype">void</font> *v, <a class="code" href="vmdplugin_8h.html#a15">vmdplugin_register_cb</a> cb) {
00437   (*cb)(v, (<a class="code" href="structvmdplugin__t.html">vmdplugin_t</a> *)&amp;plugin);
00438   <font class="keywordflow">return</font> <a class="code" href="vmdplugin_8h.html#a13">VMDPLUGIN_SUCCESS</a>;
00439 }
00440 
<a name="l00441"></a><a class="code" href="webpdbplugin_8c.html#a13">00441</a> <a class="code" href="vmdplugin_8h.html#a7">VMDPLUGIN_API</a> <font class="keywordtype">int</font> <a class="code" href="vmdplugin_8h.html#a6">VMDPLUGIN_fini</a>() {
00442   <font class="keywordflow">return</font> <a class="code" href="vmdplugin_8h.html#a13">VMDPLUGIN_SUCCESS</a>;
00443 }
00444 
00445 
00446 <font class="preprocessor">#ifdef TEST_WEBPDB_PLUGIN</font>
00447 <font class="preprocessor"></font>
00448 <font class="keywordtype">int</font> <a class="code" href="main_8c.html#a3">main</a>(<font class="keywordtype">int</font> argc, <font class="keywordtype">char</font> *argv[]) {
00449   <font class="keywordtype">char</font> *file;
00450   <font class="keywordflow">if</font> (argc &lt; 2) {
00451     fprintf(stderr, <font class="stringliteral">"Usage: %s &lt;pdbcode&gt;\n"</font>, argv[0]);
00452     <font class="keywordflow">return</font> -1;
00453   }
00454   file = (<font class="keywordtype">char</font> *)<a class="code" href="webpdbplugin_8c.html#a5">open_file_read</a>(argv[1], <font class="stringliteral">"webpdb"</font>,  NULL);
00455   printf(<font class="stringliteral">"%s\n"</font>, file);
00456   free(file);
00457   <font class="keywordflow">return</font> 0;
00458 }
00459 
00460 <font class="preprocessor">#endif</font>
</pre></div><hr><address><small>Generated on Wed Mar 22 13:15:31 2006 for VMD Plugins (current) by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.gif" alt="doxygen" align="middle" border=0 
width=110 height=53></a>1.2.14 written by <a href="mailto:dimitri@stack.nl">Dimitri van Heesch</a>,
 &copy;&nbsp;1997-2002</small></address>
</body>
</html>
