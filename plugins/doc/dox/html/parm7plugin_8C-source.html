<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>parm7plugin.C Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.2.14 -->
<center>
<a class="qindex" href="index.html">Main Page</a> &nbsp; <a class="qindex" href="classes.html">Alphabetical List</a> &nbsp; <a class="qindex" href="annotated.html">Compound List</a> &nbsp; <a class="qindex" href="files.html">File List</a> &nbsp; <a class="qindex" href="functions.html">Compound Members</a> &nbsp; <a class="qindex" href="globals.html">File Members</a> &nbsp; <a class="qindex" href="pages.html">Related Pages</a> &nbsp; </center>
<hr><h1>parm7plugin.C</h1><a href="parm7plugin_8C.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 <font class="comment">/***************************************************************************</font>
00002 <font class="comment"> *cr</font>
00003 <font class="comment"> *cr            (C) Copyright 1995-2006 The Board of Trustees of the</font>
00004 <font class="comment"> *cr                        University of Illinois</font>
00005 <font class="comment"> *cr                         All Rights Reserved</font>
00006 <font class="comment"> *cr</font>
00007 <font class="comment"> ***************************************************************************/</font>
00008 
00009 <font class="comment">/***************************************************************************</font>
00010 <font class="comment"> * RCS INFORMATION:</font>
00011 <font class="comment"> *</font>
00012 <font class="comment"> *      $RCSfile: parm7plugin.C,v $</font>
00013 <font class="comment"> *      $Author: johns $       $Locker:  $             $State: Exp $</font>
00014 <font class="comment"> *      $Revision: 1.22 $       $Date: 2006/02/23 19:36:45 $</font>
00015 <font class="comment"> *</font>
00016 <font class="comment"> ***************************************************************************/</font>
00017 
00018 <font class="preprocessor">#include &lt;string.h&gt;</font>
00019 <font class="preprocessor">#include "<a class="code" href="molfile__plugin_8h.html">molfile_plugin.h</a>"</font>
00020 <font class="preprocessor">#include "<a class="code" href="ReadPARM7_8h.html">ReadPARM7.h</a>"</font>
00021 
<a name="l00022"></a><a class="code" href="structparmdata.html">00022</a> <font class="keyword">typedef</font> <font class="keyword">struct </font>{
<a name="l00023"></a><a class="code" href="structparmdata.html#m0">00023</a>   <a class="code" href="structparm.html">parmstruct</a> *prm;
<a name="l00024"></a><a class="code" href="structparmdata.html#m1">00024</a>   <font class="keywordtype">int</font> popn;
<a name="l00025"></a><a class="code" href="structparmdata.html#m2">00025</a>   FILE *fd;
<a name="l00026"></a><a class="code" href="structparmdata.html#m3">00026</a>   <font class="keywordtype">int</font> nbonds;
<a name="l00027"></a><a class="code" href="structparmdata.html#m4">00027</a>   <font class="keywordtype">int</font> *from, *to;
00028 } <a class="code" href="structparmdata.html">parmdata</a>;
00029 
<a name="l00030"></a><a class="code" href="parm7plugin_8C.html#a1">00030</a> <font class="keyword">static</font> <font class="keywordtype">void</font> *<a class="code" href="parm7plugin_8C.html#a1">open_parm7_read</a>(<font class="keyword">const</font> <font class="keywordtype">char</font> *filename, <font class="keyword">const</font> <font class="keywordtype">char</font> *,<font class="keywordtype">int</font> *natoms) {
00031   FILE *fd;
00032   <font class="keywordtype">int</font> popn = 0;
00033   <font class="keywordflow">if</font>(!(fd = <a class="code" href="ReadPARM7_8h.html#a5">open_parm7_file</a>(filename, &amp;popn))) {
00034     fprintf(stderr, <font class="stringliteral">"Cannot open parm file '%s'\n"</font>, filename);
00035     <font class="keywordflow">return</font> NULL;
00036   }
00037   <a class="code" href="structparm.html">parmstruct</a> *prm = <a class="code" href="ReadPARM7_8h.html#a14">read_parm7_header</a>(fd);
00038   <font class="keywordflow">if</font> (!prm) {
00039     <a class="code" href="ReadPARM7_8h.html#a13">close_parm7_file</a>(fd, popn);
00040     <font class="keywordflow">return</font> NULL; 
00041   }
00042 
00043   *natoms = prm-&gt;<a class="code" href="structparm.html#m4">Natom</a>;
00044   <a class="code" href="structparmdata.html">parmdata</a> *p = <font class="keyword">new</font> <a class="code" href="structparmdata.html">parmdata</a>;
00045   memset(p, 0, <font class="keyword">sizeof</font>(parmdata));
00046   p-&gt;<a class="code" href="structparmdata.html#m0">prm</a> = prm;
00047   p-&gt;<a class="code" href="structparmdata.html#m1">popn</a> = popn;
00048   p-&gt;<a class="code" href="structparmdata.html#m2">fd</a> = fd;
00049   p-&gt;<a class="code" href="structparmdata.html#m4">from</a> = <font class="keyword">new</font> <font class="keywordtype">int</font>[prm-&gt;<a class="code" href="structparm.html#m6">Nbonh</a> + prm-&gt;<a class="code" href="structparm.html#m16">Nbona</a>];
00050   p-&gt;<a class="code" href="structparmdata.html#m5">to</a>   = <font class="keyword">new</font> <font class="keywordtype">int</font>[prm-&gt;<a class="code" href="structparm.html#m6">Nbonh</a> + prm-&gt;<a class="code" href="structparm.html#m16">Nbona</a>];
00051   <font class="keywordflow">return</font> p;
00052 }
00053 
<a name="l00054"></a><a class="code" href="parm7plugin_8C.html#a2">00054</a> <font class="keyword">static</font> <font class="keywordtype">int</font> <a class="code" href="parm7plugin_8C.html#a2">read_parm7_structure</a>(<font class="keywordtype">void</font> *mydata, <font class="keywordtype">int</font> *optflags, <a class="code" href="structmolfile__atom__t.html">molfile_atom_t</a> *atoms) {
00055   <a class="code" href="structparmdata.html">parmdata</a> *p = (<a class="code" href="structparmdata.html">parmdata</a> *)mydata;
00056   <font class="keyword">const</font> <a class="code" href="structparm.html">parmstruct</a> *prm = p-&gt;<a class="code" href="structparmdata.html#m0">prm</a>;
00057   FILE *file = p-&gt;<a class="code" href="structparmdata.html#m2">fd</a>;
00058   <font class="keywordtype">char</font> buf[85];
00059   <font class="keywordtype">char</font> field[85];
00060   <font class="keywordtype">char</font> *resnames = NULL;
00061   *optflags = 0;
00062 
00063   <font class="keywordflow">while</font> (fgets(buf, 85, file)) {
00064     <font class="comment">// find the next line starting with %FLAG, indicating a new section</font>
00065     <font class="keywordflow">if</font> (strncmp(buf, <font class="stringliteral">"%FLAG "</font>, 6)) <font class="keywordflow">continue</font>;
00066     <font class="comment">// parse field and format indicators</font>
00067     sscanf(buf+6, <font class="stringliteral">"%s\n"</font>, field); <font class="comment">// type of record</font>
00068     fscanf(file, <font class="stringliteral">"%s\n"</font>, buf);    <font class="comment">// format</font>
00069     <font class="keywordflow">if</font> (!strcmp(field, <font class="stringliteral">"ATOM_NAME"</font>)) {
00070       <font class="keywordflow">if</font> (!<a class="code" href="ReadPARM7_8h.html#a6">parse_parm7_atoms</a>(buf, prm-&gt;<a class="code" href="structparm.html#m4">Natom</a>, atoms, file)) <font class="keywordflow">break</font>;
00071     } <font class="keywordflow">else</font> <font class="keywordflow">if</font> (!strcmp(field, <font class="stringliteral">"CHARGE"</font>)) {
00072       *optflags |= <a class="code" href="molfile__plugin_8h.html#a13">MOLFILE_CHARGE</a>;
00073       <font class="keywordflow">if</font> (!<a class="code" href="ReadPARM7_8h.html#a7">parse_parm7_charge</a>(buf, prm-&gt;<a class="code" href="structparm.html#m4">Natom</a>, atoms, file)) <font class="keywordflow">break</font>;
00074     } <font class="keywordflow">else</font> <font class="keywordflow">if</font> (!strcmp(field, <font class="stringliteral">"MASS"</font>)) {
00075       *optflags |= <a class="code" href="molfile__plugin_8h.html#a12">MOLFILE_MASS</a>;
00076       <font class="keywordflow">if</font> (!<a class="code" href="ReadPARM7_8h.html#a8">parse_parm7_mass</a>(buf, prm-&gt;<a class="code" href="structparm.html#m4">Natom</a>, atoms, file)) <font class="keywordflow">break</font>;
00077     } <font class="keywordflow">else</font> <font class="keywordflow">if</font> (!strcmp(field, <font class="stringliteral">"AMBER_ATOM_TYPE"</font>)) {
00078       <font class="keywordflow">if</font> (!<a class="code" href="ReadPARM7_8h.html#a9">parse_parm7_atype</a>(buf, prm-&gt;<a class="code" href="structparm.html#m4">Natom</a>, atoms, file)) <font class="keywordflow">break</font>;
00079     } <font class="keywordflow">else</font> <font class="keywordflow">if</font> (!strcmp(field, <font class="stringliteral">"RESIDUE_LABEL"</font>)) {
00080       resnames = <font class="keyword">new</font> <font class="keywordtype">char</font>[4*prm-&gt;<a class="code" href="structparm.html#m15">Nres</a>];
00081       <font class="keywordflow">if</font> (!<a class="code" href="ReadPARM7_8h.html#a10">parse_parm7_resnames</a>(buf, prm-&gt;<a class="code" href="structparm.html#m15">Nres</a>, resnames, file)) <font class="keywordflow">break</font>;
00082     } <font class="keywordflow">else</font> <font class="keywordflow">if</font> (!strcmp(field, <font class="stringliteral">"RESIDUE_POINTER"</font>)) {
00083       <font class="keywordflow">if</font> (!resnames) {
00084         fprintf(stderr, 
00085             <font class="stringliteral">"PARM7: cannot parse RESIDUE_POINTER before RESIDUE_LABEL\n"</font>);
00086         <font class="keywordflow">continue</font>;
00087       }
00088       <font class="keywordflow">if</font> (!<a class="code" href="ReadPARM7_8h.html#a11">parse_parm7_respointers</a>(buf, prm-&gt;<a class="code" href="structparm.html#m4">Natom</a>, atoms, 
00089                                    prm-&gt;<a class="code" href="structparm.html#m15">Nres</a>, resnames, file)) 
00090         <font class="keywordflow">break</font>;
00091     } <font class="keywordflow">else</font> <font class="keywordflow">if</font> (!strcmp(field, <font class="stringliteral">"BONDS_WITHOUT_HYDROGEN"</font>)) {
00092       <font class="keywordflow">if</font> (!<a class="code" href="ReadPARM7_8h.html#a12">parse_parm7_bonds</a>(buf, prm-&gt;<a class="code" href="structparm.html#m16">Nbona</a>, p-&gt;<a class="code" href="structparmdata.html#m4">from</a>+p-&gt;<a class="code" href="structparmdata.html#m3">nbonds</a>,
00093             p-&gt;<a class="code" href="structparmdata.html#m5">to</a>+p-&gt;<a class="code" href="structparmdata.html#m3">nbonds</a>, file)) <font class="keywordflow">break</font>;
00094       p-&gt;<a class="code" href="structparmdata.html#m3">nbonds</a> += prm-&gt;<a class="code" href="structparm.html#m16">Nbona</a>;
00095     } <font class="keywordflow">else</font> <font class="keywordflow">if</font> (!strcmp(field, <font class="stringliteral">"BONDS_INC_HYDROGEN"</font>)) {
00096       <font class="keywordflow">if</font> (!<a class="code" href="ReadPARM7_8h.html#a12">parse_parm7_bonds</a>(buf, prm-&gt;<a class="code" href="structparm.html#m6">Nbonh</a>, p-&gt;<a class="code" href="structparmdata.html#m4">from</a>+p-&gt;<a class="code" href="structparmdata.html#m3">nbonds</a>,
00097             p-&gt;<a class="code" href="structparmdata.html#m5">to</a>+p-&gt;<a class="code" href="structparmdata.html#m3">nbonds</a>, file)) <font class="keywordflow">break</font>;
00098       p-&gt;<a class="code" href="structparmdata.html#m3">nbonds</a> += prm-&gt;<a class="code" href="structparm.html#m6">Nbonh</a>;
00099     }
00100   }
00101 
00102   <font class="comment">// unused items</font>
00103   <font class="keywordflow">for</font> (<font class="keywordtype">int</font> i=0; i&lt;prm-&gt;<a class="code" href="structparm.html#m4">Natom</a>; i++) {
00104     atoms[i].<a class="code" href="structmolfile__atom__t.html#m5">chain</a>[0] = <font class="charliteral">'\0'</font>;
00105     atoms[i].<a class="code" href="structmolfile__atom__t.html#m4">segid</a>[0] = <font class="charliteral">'\0'</font>;
00106   }
00107 
00108   <font class="keyword">delete</font> [] resnames;
00109   <font class="keywordflow">return</font> <a class="code" href="molfile__plugin_8h.html#a2">MOLFILE_SUCCESS</a>;
00110 }
00111 
<a name="l00112"></a><a class="code" href="parm7plugin_8C.html#a3">00112</a> <font class="keyword">static</font> <font class="keywordtype">int</font> <a class="code" href="parm7plugin_8C.html#a3">read_parm7_bonds</a>(<font class="keywordtype">void</font> *v, <font class="keywordtype">int</font> *nbonds, <font class="keywordtype">int</font> **fromptr, <font class="keywordtype">int</font> **toptr, <font class="keywordtype">float</font> **bondorderptr){
00113   <a class="code" href="structparmdata.html">parmdata</a> *p = (<a class="code" href="structparmdata.html">parmdata</a> *)v;
00114   *nbonds = p-&gt;<a class="code" href="structparmdata.html#m3">nbonds</a>;
00115   *fromptr = p-&gt;<a class="code" href="structparmdata.html#m4">from</a>;
00116   *toptr = p-&gt;<a class="code" href="structparmdata.html#m5">to</a>;
00117   *bondorderptr = NULL; <font class="comment">// parm files don't contain bond order information</font>
00118   <font class="keywordflow">return</font> <a class="code" href="molfile__plugin_8h.html#a2">MOLFILE_SUCCESS</a>;
00119 }
00120 
<a name="l00121"></a><a class="code" href="parm7plugin_8C.html#a4">00121</a> <font class="keyword">static</font> <font class="keywordtype">void</font> <a class="code" href="parm7plugin_8C.html#a4">close_parm7_read</a>(<font class="keywordtype">void</font> *mydata) {
00122   <a class="code" href="structparmdata.html">parmdata</a> *p = (<a class="code" href="structparmdata.html">parmdata</a> *)mydata;
00123   <a class="code" href="ReadPARM7_8h.html#a13">close_parm7_file</a>(p-&gt;<a class="code" href="structparmdata.html#m2">fd</a>, p-&gt;<a class="code" href="structparmdata.html#m1">popn</a>);
00124   <font class="keyword">delete</font> p-&gt;<a class="code" href="structparmdata.html#m0">prm</a>;
00125   <font class="keyword">delete</font> [] p-&gt;<a class="code" href="structparmdata.html#m4">from</a>;
00126   <font class="keyword">delete</font> [] p-&gt;<a class="code" href="structparmdata.html#m5">to</a>;
00127   <font class="keyword">delete</font> p;
00128 }
00129  
00130 <font class="comment">/*</font>
00131 <font class="comment"> * Initialization stuff down here</font>
00132 <font class="comment"> */</font>
00133 
<a name="l00134"></a><a class="code" href="parm7plugin_8C.html#a0">00134</a> <font class="keyword">static</font> <a class="code" href="structmolfile__plugin__t.html">molfile_plugin_t</a> <a class="code" href="parm7plugin_8C.html#a0">parm7plugin</a> = {
00135   <a class="code" href="vmdplugin_8h.html#a10">vmdplugin_ABIVERSION</a>,          <font class="comment">// ABI Version</font>
00136   <a class="code" href="molfile__plugin_8h.html#a0">MOLFILE_PLUGIN_TYPE</a>,           <font class="comment">// type of plugin</font>
00137   <font class="stringliteral">"parm7"</font>,                       <font class="comment">// short name of plugin</font>
00138   <font class="stringliteral">"AMBER7 Parm"</font>,                 <font class="comment">// pretty name of plugin</font>
00139   <font class="stringliteral">"Brian Bennion, Justin Gullingsrud, John E. Stone"</font>, <font class="comment">// authors</font>
00140   0,                             <font class="comment">// major version</font>
00141   7,                             <font class="comment">// minor version</font>
00142   <a class="code" href="vmdplugin_8h.html#a11">VMDPLUGIN_THREADUNSAFE</a>,        <font class="comment">// is not reentrant</font>
00143   <font class="stringliteral">"prmtop,parm7"</font>,                <font class="comment">// filename extensions</font>
00144   <a class="code" href="parm7plugin_8C.html#a1">open_parm7_read</a>,        
00145   <a class="code" href="parm7plugin_8C.html#a2">read_parm7_structure</a>,  
00146   <a class="code" href="parm7plugin_8C.html#a3">read_parm7_bonds</a>,
00147   0,                             <font class="comment">// read_next_timestep</font>
00148   <a class="code" href="parm7plugin_8C.html#a4">close_parm7_read</a>,     
00149   0,
00150   0,
00151   0,
00152   0,
00153 };
00154 
<a name="l00155"></a><a class="code" href="parm7plugin_8C.html#a5">00155</a> <a class="code" href="vmdplugin_8h.html#a7">VMDPLUGIN_API</a> <font class="keywordtype">int</font> <a class="code" href="vmdplugin_8h.html#a5">VMDPLUGIN_init</a>(){
00156   <font class="keywordflow">return</font> <a class="code" href="vmdplugin_8h.html#a13">VMDPLUGIN_SUCCESS</a>;
00157 }
<a name="l00158"></a><a class="code" href="parm7plugin_8C.html#a6">00158</a> <a class="code" href="vmdplugin_8h.html#a7">VMDPLUGIN_API</a> <font class="keywordtype">int</font> <a class="code" href="vmdplugin_8h.html#a6">VMDPLUGIN_fini</a>(){
00159   <font class="keywordflow">return</font> <a class="code" href="vmdplugin_8h.html#a13">VMDPLUGIN_SUCCESS</a>;
00160 }
<a name="l00161"></a><a class="code" href="parm7plugin_8C.html#a7">00161</a> <a class="code" href="vmdplugin_8h.html#a7">VMDPLUGIN_API</a> <font class="keywordtype">int</font> <a class="code" href="vmdplugin_8h.html#a3">VMDPLUGIN_register</a>(<font class="keywordtype">void</font> *v, <a class="code" href="vmdplugin_8h.html#a15">vmdplugin_register_cb</a> cb) {
00162   (*cb)(v,(<a class="code" href="structvmdplugin__t.html">vmdplugin_t</a> *)&amp;parm7plugin);
00163   <font class="keywordflow">return</font> <a class="code" href="vmdplugin_8h.html#a13">VMDPLUGIN_SUCCESS</a>;
00164 }
</pre></div><hr><address><small>Generated on Wed Mar 22 13:15:30 2006 for VMD Plugins (current) by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.gif" alt="doxygen" align="middle" border=0 
width=110 height=53></a>1.2.14 written by <a href="mailto:dimitri@stack.nl">Dimitri van Heesch</a>,
 &copy;&nbsp;1997-2002</small></address>
</body>
</html>
