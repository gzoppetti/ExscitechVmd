<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>pdbplugin.c Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.2.14 -->
<center>
<a class="qindex" href="index.html">Main Page</a> &nbsp; <a class="qindex" href="classes.html">Alphabetical List</a> &nbsp; <a class="qindex" href="annotated.html">Compound List</a> &nbsp; <a class="qindex" href="files.html">File List</a> &nbsp; <a class="qindex" href="functions.html">Compound Members</a> &nbsp; <a class="qindex" href="globals.html">File Members</a> &nbsp; <a class="qindex" href="pages.html">Related Pages</a> &nbsp; </center>
<hr><h1>pdbplugin.c</h1><a href="pdbplugin_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 <font class="comment">/***************************************************************************</font>
00002 <font class="comment"> *cr</font>
00003 <font class="comment"> *cr            (C) Copyright 1995-2006 The Board of Trustees of the</font>
00004 <font class="comment"> *cr                        University of Illinois</font>
00005 <font class="comment"> *cr                         All Rights Reserved</font>
00006 <font class="comment"> *cr</font>
00007 <font class="comment"> ***************************************************************************/</font>
00008 
00009 <font class="comment">/***************************************************************************</font>
00010 <font class="comment"> * RCS INFORMATION:</font>
00011 <font class="comment"> *</font>
00012 <font class="comment"> *      $RCSfile: pdbplugin.c,v $</font>
00013 <font class="comment"> *      $Author: johns $       $Locker:  $             $State: Exp $</font>
00014 <font class="comment"> *      $Revision: 1.65 $       $Date: 2006/03/01 19:55:24 $</font>
00015 <font class="comment"> *</font>
00016 <font class="comment"> ***************************************************************************/</font>
00017 
00018 <font class="comment">/*</font>
00019 <font class="comment"> * PDB file format specifications:</font>
00020 <font class="comment"> *   http://www.rcsb.org/pdb/static.do?p=file_formats/pdb/index.html</font>
00021 <font class="comment"> */</font>
00022 
00023 <font class="preprocessor">#include "<a class="code" href="largefiles_8h.html">largefiles.h</a>"</font>   <font class="comment">/* platform dependent 64-bit file I/O defines */</font>
00024 
00025 <font class="preprocessor">#include "<a class="code" href="molfile__plugin_8h.html">molfile_plugin.h</a>"</font>
00026 <font class="preprocessor">#include "<a class="code" href="readpdb_8h.html">readpdb.h</a>"</font>
00027 <font class="preprocessor">#include "<a class="code" href="periodic__table_8h.html">periodic_table.h</a>"</font>
00028 <font class="preprocessor">#include &lt;stdio.h&gt;</font>
00029 <font class="preprocessor">#include &lt;stdlib.h&gt;</font>
00030 <font class="preprocessor">#include &lt;string.h&gt;</font>
00031 
00032 <font class="comment">/*</font>
00033 <font class="comment"> * API functions start here</font>
00034 <font class="comment"> */</font>
00035 
00036 <font class="keyword">typedef</font> <font class="keyword">struct </font>{
<a name="l00037"></a><a class="code" href="structpdbdata.html#m6">00037</a>   FILE *fd;
<a name="l00038"></a><a class="code" href="structpdbdata.html#m7">00038</a>   <font class="keywordtype">int</font> first_frame;
00039   <font class="keywordtype">int</font> natoms;
<a name="l00040"></a><a class="code" href="structpdbdata.html#m8">00040</a>   <a class="code" href="structmolfile__atom__t.html">molfile_atom_t</a> *atomlist;
<a name="l00041"></a><a class="code" href="structpdbdata.html#m9">00041</a>   <a class="code" href="structmolfile__metadata__t.html">molfile_metadata_t</a> *meta;
00042   <font class="keywordtype">int</font> nconect;
00043   <font class="keywordtype">int</font> nbonds, maxbnum;
<a name="l00044"></a><a class="code" href="structpdbdata.html#m13">00044</a>   <font class="keywordtype">int</font> *from, *to, *idxmap;
00045 } <a class="code" href="structpdbdata.html">pdbdata</a>;
00046 
<a name="l00047"></a><a class="code" href="pdbplugin_8c.html#a2">00047</a> <font class="keyword">static</font> <font class="keywordtype">void</font> *<a class="code" href="pdbplugin_8c.html#a2">open_pdb_read</a>(<font class="keyword">const</font> <font class="keywordtype">char</font> *filepath, <font class="keyword">const</font> <font class="keywordtype">char</font> *filetype, 
00048     <font class="keywordtype">int</font> *natoms) {
00049   FILE *fd;
00050   <a class="code" href="structpdbdata.html">pdbdata</a> *pdb;
00051   <font class="keywordtype">char</font> pdbstr[<a class="code" href="readpdb_8h.html#a1">PDB_BUFFER_LENGTH</a>];
00052   <font class="keywordtype">int</font> indx, nconect;
00053 
00054   fd = fopen(filepath, <font class="stringliteral">"r"</font>);
00055   <font class="keywordflow">if</font> (!fd) 
00056     <font class="keywordflow">return</font> NULL;
00057   pdb = (<a class="code" href="structpdbdata.html">pdbdata</a> *)malloc(<font class="keyword">sizeof</font>(<a class="code" href="structpdbdata.html">pdbdata</a>));
00058   pdb-&gt;<a class="code" href="structpdbdata.html#m0">fd</a> = fd;
00059   pdb-&gt;<a class="code" href="structpdbdata.html#m9">meta</a> = (<a class="code" href="structmolfile__metadata__t.html">molfile_metadata_t</a> *) malloc(<font class="keyword">sizeof</font>(<a class="code" href="structmolfile__metadata__t.html">molfile_metadata_t</a>));
00060   memset(pdb-&gt;<a class="code" href="structpdbdata.html#m9">meta</a>, 0, <font class="keyword">sizeof</font>(<a class="code" href="structmolfile__metadata__t.html">molfile_metadata_t</a>));
00061 
00062   pdb-&gt;<a class="code" href="structpdbdata.html#m9">meta</a>-&gt;<a class="code" href="structmolfile__metadata__t.html#m4">remarklen</a> = 0;
00063   pdb-&gt;<a class="code" href="structpdbdata.html#m9">meta</a>-&gt;<a class="code" href="structmolfile__metadata__t.html#m5">remarks</a> = NULL;
00064 
00065   *natoms=0;
00066   nconect=0;
00067   <font class="keywordflow">do</font> {
00068     indx = <a class="code" href="readpdb_8h.html#a11">read_pdb_record</a>(pdb-&gt;<a class="code" href="structpdbdata.html#m0">fd</a>, pdbstr);
00069     <font class="keywordflow">if</font> (indx == <a class="code" href="readpdb_8h.html#a19a5">PDB_ATOM</a>) {
00070       *natoms += 1;
00071     } <font class="keywordflow">else</font> <font class="keywordflow">if</font> (indx == <a class="code" href="readpdb_8h.html#a19a6">PDB_CONECT</a>) {
00072       nconect++;
00073     } <font class="keywordflow">else</font> <font class="keywordflow">if</font> (indx == <a class="code" href="readpdb_8h.html#a19a3">PDB_HEADER</a>) {
00074       <a class="code" href="readpdb_8h.html#a15">get_pdb_header</a>(pdbstr, pdb-&gt;<a class="code" href="structpdbdata.html#m9">meta</a>-&gt;<a class="code" href="structmolfile__metadata__t.html#m1">accession</a>, pdb-&gt;<a class="code" href="structpdbdata.html#m9">meta</a>-&gt;<a class="code" href="structmolfile__metadata__t.html#m2">date</a>, NULL);
00075       <font class="keywordflow">if</font> (strlen(pdb-&gt;<a class="code" href="structpdbdata.html#m9">meta</a>-&gt;<a class="code" href="structmolfile__metadata__t.html#m1">accession</a>) &gt; 0) 
00076         strcpy(pdb-&gt;<a class="code" href="structpdbdata.html#m9">meta</a>-&gt;<a class="code" href="structmolfile__metadata__t.html#m0">database</a>, <font class="stringliteral">"PDB"</font>);
00077     } <font class="keywordflow">else</font> <font class="keywordflow">if</font> (indx == <a class="code" href="readpdb_8h.html#a19a4">PDB_REMARK</a> || indx == <a class="code" href="readpdb_8h.html#a19a6">PDB_CONECT</a> || indx == <a class="code" href="readpdb_8h.html#a19a7">PDB_UNKNOWN</a>) {
00078       <font class="keywordtype">int</font> len=strlen(pdbstr);
00079       <font class="keywordtype">int</font> newlen = len + pdb-&gt;<a class="code" href="structpdbdata.html#m9">meta</a>-&gt;<a class="code" href="structmolfile__metadata__t.html#m4">remarklen</a>;
00080 
00081       <font class="keywordtype">char</font> *newstr=realloc(pdb-&gt;<a class="code" href="structpdbdata.html#m9">meta</a>-&gt;<a class="code" href="structmolfile__metadata__t.html#m5">remarks</a>, newlen + 1);
00082       <font class="keywordflow">if</font> (newstr != NULL) {
00083         pdb-&gt;<a class="code" href="structpdbdata.html#m9">meta</a>-&gt;<a class="code" href="structmolfile__metadata__t.html#m5">remarks</a> = newstr;
00084         pdb-&gt;<a class="code" href="structpdbdata.html#m9">meta</a>-&gt;<a class="code" href="structmolfile__metadata__t.html#m5">remarks</a>[pdb-&gt;<a class="code" href="structpdbdata.html#m9">meta</a>-&gt;<a class="code" href="structmolfile__metadata__t.html#m4">remarklen</a>] = <font class="charliteral">'\0'</font>;
00085         memcpy(pdb-&gt;<a class="code" href="structpdbdata.html#m9">meta</a>-&gt;<a class="code" href="structmolfile__metadata__t.html#m5">remarks</a> + pdb-&gt;<a class="code" href="structpdbdata.html#m9">meta</a>-&gt;<a class="code" href="structmolfile__metadata__t.html#m4">remarklen</a>, pdbstr, len);
00086         pdb-&gt;<a class="code" href="structpdbdata.html#m9">meta</a>-&gt;<a class="code" href="structmolfile__metadata__t.html#m5">remarks</a>[newlen] = <font class="charliteral">'\0'</font>;
00087         pdb-&gt;<a class="code" href="structpdbdata.html#m9">meta</a>-&gt;<a class="code" href="structmolfile__metadata__t.html#m4">remarklen</a> = newlen;
00088       }
00089     }
00090  
00091   } <font class="keywordflow">while</font> (indx != <a class="code" href="readpdb_8h.html#a19a8">PDB_END</a> &amp;&amp; indx != <a class="code" href="readpdb_8h.html#a19a9">PDB_EOF</a>);
00092 
00093   <font class="comment">/* If no atoms were found, this is probably not a PDB file! */</font>
00094   <font class="keywordflow">if</font> (!*natoms) {
00095     fprintf(stderr, <font class="stringliteral">"PDB file '%s' contains no atoms.\n"</font>, filepath);
00096     <font class="keywordflow">if</font> (pdb-&gt;<a class="code" href="structpdbdata.html#m9">meta</a>-&gt;<a class="code" href="structmolfile__metadata__t.html#m5">remarks</a> != NULL)
00097       free(pdb-&gt;<a class="code" href="structpdbdata.html#m9">meta</a>-&gt;<a class="code" href="structmolfile__metadata__t.html#m5">remarks</a>);
00098     <font class="keywordflow">if</font> (pdb-&gt;<a class="code" href="structpdbdata.html#m9">meta</a> != NULL)
00099       free(pdb-&gt;<a class="code" href="structpdbdata.html#m9">meta</a>);
00100     free(pdb);
00101     <font class="keywordflow">return</font> NULL;
00102   }
00103 
00104   rewind(pdb-&gt;<a class="code" href="structpdbdata.html#m0">fd</a>); <font class="comment">/* if ok, rewind file and prepare to parse it for real */</font>
00105   pdb-&gt;<a class="code" href="structpdbdata.html#m1">natoms</a> = *natoms;
00106   pdb-&gt;<a class="code" href="structpdbdata.html#m10">nconect</a> = nconect;
00107   pdb-&gt;<a class="code" href="structpdbdata.html#m11">nbonds</a> = 0;
00108   pdb-&gt;<a class="code" href="structpdbdata.html#m12">maxbnum</a> = 0;
00109   pdb-&gt;<a class="code" href="structpdbdata.html#m13">from</a> = NULL;
00110   pdb-&gt;<a class="code" href="structpdbdata.html#m14">to</a> = NULL;
00111   pdb-&gt;<a class="code" href="structpdbdata.html#m15">idxmap</a> = NULL;
00112   pdb-&gt;<a class="code" href="structpdbdata.html#m8">atomlist</a> = NULL;
00113 
00114 <font class="preprocessor">#if defined(VMDUSECONECTRECORDS)</font>
00115 <font class="preprocessor"></font>  <font class="comment">/* allocate atom index translation table if we have 99,999 atoms or less */</font>
00116   <font class="comment">/* and we have conect records to process                                 */</font>
00117   <font class="keywordflow">if</font> (pdb-&gt;<a class="code" href="structpdbdata.html#m1">natoms</a> &lt; 100000 &amp;&amp; pdb-&gt;<a class="code" href="structpdbdata.html#m10">nconect</a> &gt; 0) {
00118     pdb-&gt;<a class="code" href="structpdbdata.html#m15">idxmap</a> = (<font class="keywordtype">int</font> *) malloc(100000 * <font class="keyword">sizeof</font>(<font class="keywordtype">int</font>));
00119     memset(pdb-&gt;<a class="code" href="structpdbdata.html#m15">idxmap</a>, 0, 100000 * <font class="keyword">sizeof</font>(<font class="keywordtype">int</font>));
00120   }
00121 <font class="preprocessor">#endif</font>
00122 <font class="preprocessor"></font> 
00123   <font class="keywordflow">return</font> pdb; 
00124 }
00125 
<a name="l00126"></a><a class="code" href="pdbplugin_8c.html#a3">00126</a> <font class="keyword">static</font> <font class="keywordtype">int</font> <a class="code" href="webpdbplugin_8c.html#a6">read_pdb_structure</a>(<font class="keywordtype">void</font> *mydata, <font class="keywordtype">int</font> *optflags, 
00127     <a class="code" href="structmolfile__atom__t.html">molfile_atom_t</a> *atoms) { 
00128   <a class="code" href="structpdbdata.html">pdbdata</a> *pdb = (<a class="code" href="structpdbdata.html">pdbdata</a> *)mydata;
00129   <a class="code" href="structmolfile__atom__t.html">molfile_atom_t</a> *atom;
00130   <font class="keywordtype">char</font> pdbrec[<a class="code" href="readpdb_8h.html#a1">PDB_BUFFER_LENGTH</a>];
00131   <font class="keywordtype">int</font> i, rectype, atomserial, pteidx;
00132   <font class="keywordtype">char</font> ridstr[8];
00133   <font class="keywordtype">char</font> elementsymbol[3];
00134   <font class="keywordtype">int</font> badptecount = 0;
00135   <font class="keywordtype">long</font> fpos = ftell(pdb-&gt;<a class="code" href="structpdbdata.html#m0">fd</a>);
00136 
00137   *optflags = <a class="code" href="molfile__plugin_8h.html#a9">MOLFILE_INSERTION</a> | <a class="code" href="molfile__plugin_8h.html#a10">MOLFILE_OCCUPANCY</a> | <a class="code" href="molfile__plugin_8h.html#a11">MOLFILE_BFACTOR</a> |
00138               <a class="code" href="molfile__plugin_8h.html#a15">MOLFILE_ALTLOC</a> | <a class="code" href="molfile__plugin_8h.html#a16">MOLFILE_ATOMICNUMBER</a> | <a class="code" href="molfile__plugin_8h.html#a17">MOLFILE_BONDSSPECIAL</a>;
00139 
00140   i = 0;
00141   <font class="keywordflow">do</font> {
00142     rectype = <a class="code" href="readpdb_8h.html#a11">read_pdb_record</a>(pdb-&gt;<a class="code" href="structpdbdata.html#m0">fd</a>, pdbrec);
00143     <font class="keywordflow">switch</font> (rectype) {
00144     <font class="keywordflow">case</font> <a class="code" href="readpdb_8h.html#a19a5">PDB_ATOM</a>:
00145       atom = atoms+i;
00146       <a class="code" href="readpdb_8h.html#a17">get_pdb_fields</a>(pdbrec, strlen(pdbrec), &amp;atomserial, 
00147           atom-&gt;<a class="code" href="structmolfile__atom__t.html#m0">name</a>, atom-&gt;<a class="code" href="structmolfile__atom__t.html#m2">resname</a>, atom-&gt;<a class="code" href="structmolfile__atom__t.html#m5">chain</a>, atom-&gt;<a class="code" href="structmolfile__atom__t.html#m4">segid</a>, 
00148           ridstr, atom-&gt;<a class="code" href="structmolfile__atom__t.html#m7">insertion</a>, atom-&gt;<a class="code" href="structmolfile__atom__t.html#m6">altloc</a>, elementsymbol,
00149           NULL, NULL, NULL, &amp;atom-&gt;<a class="code" href="structmolfile__atom__t.html#m8">occupancy</a>, &amp;atom-&gt;<a class="code" href="structmolfile__atom__t.html#m9">bfactor</a>);
00150 
00151       <font class="keywordflow">if</font> (pdb-&gt;<a class="code" href="structpdbdata.html#m15">idxmap</a> != NULL &amp;&amp; atomserial &lt; 100000) {
00152         pdb-&gt;<a class="code" href="structpdbdata.html#m15">idxmap</a>[atomserial] = i; <font class="comment">/* record new serial number translation */</font> 
00153       }
00154  
00155       atom-&gt;<a class="code" href="structmolfile__atom__t.html#m3">resid</a> = atoi(ridstr);
00156 
00157       <font class="comment">/* determine atomic number from the element symbol */</font>
00158       pteidx = <a class="code" href="periodic__table_8h.html#a8">get_pte_idx_from_string</a>(elementsymbol);
00159       atom-&gt;<a class="code" href="structmolfile__atom__t.html#m13">atomicnumber</a> = pteidx;
00160       <font class="keywordflow">if</font> (pteidx != 0) {
00161         atom-&gt;<a class="code" href="structmolfile__atom__t.html#m10">mass</a> = <a class="code" href="periodic__table_8h.html#a5">get_pte_mass</a>(pteidx);
00162         atom-&gt;<a class="code" href="structmolfile__atom__t.html#m12">radius</a> = <a class="code" href="periodic__table_8h.html#a6">get_pte_vdw_radius</a>(pteidx);
00163       } <font class="keywordflow">else</font> {
00164         badptecount++; <font class="comment">/* unrecognized element */</font>
00165       }
00166  
00167       strcpy(atom-&gt;<a class="code" href="structmolfile__atom__t.html#m1">type</a>, atom-&gt;<a class="code" href="structmolfile__atom__t.html#m0">name</a>);
00168       i++;
00169       <font class="keywordflow">break</font>;
00170 
00171     <font class="keywordflow">case</font> <a class="code" href="readpdb_8h.html#a19a6">PDB_CONECT</a>:
00172       <font class="comment">/* only read CONECT records for structures where we know they can */</font>
00173       <font class="comment">/* be valid for all of the atoms in the structure                 */</font>
00174       <font class="keywordflow">if</font> (pdb-&gt;<a class="code" href="structpdbdata.html#m15">idxmap</a> != NULL) {
00175         <a class="code" href="readpdb_8h.html#a16">get_pdb_conect</a>(pdbrec, pdb-&gt;<a class="code" href="structpdbdata.html#m1">natoms</a>, pdb-&gt;<a class="code" href="structpdbdata.html#m15">idxmap</a>, 
00176                        &amp;pdb-&gt;<a class="code" href="structpdbdata.html#m12">maxbnum</a>, &amp;pdb-&gt;<a class="code" href="structpdbdata.html#m11">nbonds</a>, &amp;pdb-&gt;<a class="code" href="structpdbdata.html#m13">from</a>, &amp;pdb-&gt;<a class="code" href="structpdbdata.html#m14">to</a>);
00177       }
00178       <font class="keywordflow">break</font>;
00179 
00180     <font class="keywordflow">default</font>:
00181       <font class="comment">/* other record types are ignored in the structure callback */</font>
00182       <font class="comment">/* and are dealt with in the timestep callback or elsewhere */</font>
00183       <font class="keywordflow">break</font>;
00184     }
00185   } <font class="keywordflow">while</font> (rectype != <a class="code" href="readpdb_8h.html#a19a8">PDB_END</a> &amp;&amp; rectype != <a class="code" href="readpdb_8h.html#a19a9">PDB_EOF</a>);
00186 
00187   fseek(pdb-&gt;<a class="code" href="structpdbdata.html#m0">fd</a>, fpos, SEEK_SET);
00188 
00189   <font class="comment">/* if all atoms are recognized, set the mass and radius flags too,  */</font>
00190   <font class="comment">/* otherwise let VMD guess these for itself using it's own methods  */</font>
00191   <font class="keywordflow">if</font> (badptecount == 0) {
00192     *optflags |= <a class="code" href="molfile__plugin_8h.html#a12">MOLFILE_MASS</a> | <a class="code" href="molfile__plugin_8h.html#a14">MOLFILE_RADIUS</a>;
00193   }
00194 
00195   <font class="keywordflow">return</font> <a class="code" href="molfile__plugin_8h.html#a2">MOLFILE_SUCCESS</a>;
00196 }
00197 
<a name="l00198"></a><a class="code" href="pdbplugin_8c.html#a4">00198</a> <font class="keyword">static</font> <font class="keywordtype">int</font> <a class="code" href="xbgfplugin_8C.html#a11">read_bonds</a>(<font class="keywordtype">void</font> *v, <font class="keywordtype">int</font> *nbonds, <font class="keywordtype">int</font> **fromptr, <font class="keywordtype">int</font> **toptr, <font class="keywordtype">float</font> **
00199 bondorder) {
00200   <a class="code" href="structpdbdata.html">pdbdata</a> *pdb = (<a class="code" href="structpdbdata.html">pdbdata</a> *)v;
00201   
00202   *nbonds = 0;
00203   *fromptr = NULL;
00204   *toptr = NULL;
00205   *bondorder = NULL; <font class="comment">/* PDB files don't have bond order information */</font>
00206 
00207 <font class="comment">// The newest plugin API allows us to return CONECT records as </font>
00208 <font class="comment">// additional bonds above and beyond what the distance search returns.</font>
00209 <font class="comment">// Without that feature, we otherwise have to check completeness and</font>
00210 <font class="comment">// ignore them if they don't look to be fully specified for this molecule</font>
00211 <font class="preprocessor">#if !defined(MOLFILE_BONDSSPECIAL)</font>
00212 <font class="preprocessor"></font>  <font class="keywordflow">if</font> (pdb-&gt;<a class="code" href="structpdbdata.html#m1">natoms</a> &gt;= 100000) {
00213     printf(<font class="stringliteral">"pdbplugin) Warning: more than 99,999 atoms, ignored CONECT records\n"</font>);
00214     <font class="keywordflow">return</font> <a class="code" href="molfile__plugin_8h.html#a2">MOLFILE_SUCCESS</a>;
00215   } <font class="keywordflow">else</font> <font class="keywordflow">if</font> (((float) pdb-&gt;<a class="code" href="structpdbdata.html#m10">nconect</a> / (float) pdb-&gt;<a class="code" href="structpdbdata.html#m1">natoms</a>) &lt;= 0.85) {
00216     printf(<font class="stringliteral">"pdbplugin) Warning: Probable incomplete bond structure specified,\n"</font>);
00217     printf(<font class="stringliteral">"pdbplugin)          ignoring CONECT records\n"</font>);
00218     <font class="keywordflow">return</font> <a class="code" href="molfile__plugin_8h.html#a2">MOLFILE_SUCCESS</a>;
00219   } <font class="keywordflow">else</font> <font class="keywordflow">if</font> (pdb-&gt;<a class="code" href="structpdbdata.html#m10">nconect</a> == 0) {
00220     <font class="keywordflow">return</font> <a class="code" href="molfile__plugin_8h.html#a2">MOLFILE_SUCCESS</a>;
00221   }
00222 <font class="preprocessor">#endif</font>
00223 <font class="preprocessor"></font>
00224   *nbonds = pdb-&gt;<a class="code" href="structpdbdata.html#m11">nbonds</a>;
00225   *fromptr = pdb-&gt;<a class="code" href="structpdbdata.html#m13">from</a>;
00226   *toptr = pdb-&gt;<a class="code" href="structpdbdata.html#m14">to</a>;
00227 
00228   <font class="keywordflow">return</font> <a class="code" href="molfile__plugin_8h.html#a2">MOLFILE_SUCCESS</a>;
00229 }
00230 
00231 
00232 <font class="comment">/* </font>
00233 <font class="comment"> * </font>
00234 <font class="comment"> */</font>
<a name="l00235"></a><a class="code" href="pdbplugin_8c.html#a5">00235</a> <font class="keyword">static</font> <font class="keywordtype">int</font> <a class="code" href="webpdbplugin_8c.html#a8">read_next_timestep</a>(<font class="keywordtype">void</font> *v, <font class="keywordtype">int</font> natoms, <a class="code" href="structmolfile__timestep__t.html">molfile_timestep_t</a> *ts) {
00236   <a class="code" href="structpdbdata.html">pdbdata</a> *pdb = (<a class="code" href="structpdbdata.html">pdbdata</a> *)v;
00237   <font class="keywordtype">char</font> pdbstr[<a class="code" href="readpdb_8h.html#a1">PDB_BUFFER_LENGTH</a>];
00238   <font class="keywordtype">int</font> indx, i;
00239   <font class="keywordtype">float</font> *x, *y, *z;
00240   <font class="keywordtype">float</font> occup, bfac;
00241   <font class="keywordflow">if</font> (pdb-&gt;<a class="code" href="structpdbdata.html#m1">natoms</a> == 0) 
00242     <font class="keywordflow">return</font> <a class="code" href="molfile__plugin_8h.html#a4">MOLFILE_ERROR</a>; <font class="comment">/* EOF */</font>
00243   <font class="keywordflow">if</font> (ts) {
00244     x = ts-&gt;<a class="code" href="structmolfile__timestep__t.html#m0">coords</a>;
00245     y = x+1;
00246     z = x+2;
00247   } <font class="keywordflow">else</font> {
00248     x = y = z = 0;
00249   } 
00250   i = 0;
00251   <font class="keywordflow">do</font> {
00252     indx = <a class="code" href="readpdb_8h.html#a11">read_pdb_record</a>(pdb-&gt;<a class="code" href="structpdbdata.html#m0">fd</a>, pdbstr);
00253     <font class="keywordflow">if</font>((indx == <a class="code" href="readpdb_8h.html#a19a8">PDB_END</a> || indx == <a class="code" href="readpdb_8h.html#a19a9">PDB_EOF</a>) &amp;&amp; (i &lt; pdb-&gt;<a class="code" href="structpdbdata.html#m1">natoms</a>)) {
00254       <font class="keywordflow">return</font> <a class="code" href="molfile__plugin_8h.html#a4">MOLFILE_ERROR</a>;
00255     } <font class="keywordflow">else</font> <font class="keywordflow">if</font>(indx == <a class="code" href="readpdb_8h.html#a19a5">PDB_ATOM</a>) {
00256       <font class="keywordflow">if</font>(i++ &gt;= pdb-&gt;<a class="code" href="structpdbdata.html#m1">natoms</a>) {
00257         <font class="keywordflow">break</font>;      
00258       }
00259       <font class="comment">/* just get the coordinates, and store them */</font>
00260       <font class="keywordflow">if</font> (ts) {
00261         <a class="code" href="readpdb_8h.html#a13">get_pdb_coordinates</a>(pdbstr, x, y, z, &amp;occup, &amp;bfac);
00262         x += 3;
00263         y += 3;
00264         z += 3;
00265       } 
00266     } <font class="keywordflow">else</font> <font class="keywordflow">if</font> (indx == <a class="code" href="readpdb_8h.html#a19a10">PDB_CRYST1</a>) {
00267       <font class="keywordflow">if</font> (ts) {
00268         <a class="code" href="readpdb_8h.html#a12">get_pdb_cryst1</a>(pdbstr, &amp;ts-&gt;<a class="code" href="structmolfile__timestep__t.html#z4_3">alpha</a>, &amp;ts-&gt;<a class="code" href="structmolfile__timestep__t.html#z4_4">beta</a>, &amp;ts-&gt;<a class="code" href="structmolfile__timestep__t.html#z4_5">gamma</a>,
00269                                &amp;ts-&gt;<a class="code" href="structmolfile__timestep__t.html#z4_0">A</a>, &amp;ts-&gt;<a class="code" href="structmolfile__timestep__t.html#z4_1">B</a>, &amp;ts-&gt;<a class="code" href="structmolfile__timestep__t.html#z4_2">C</a>);
00270       }
00271     }
00272   } <font class="keywordflow">while</font>(!(indx == <a class="code" href="readpdb_8h.html#a19a8">PDB_END</a> || indx == <a class="code" href="readpdb_8h.html#a19a9">PDB_EOF</a>));
00273 
00274   <font class="keywordflow">return</font> <a class="code" href="molfile__plugin_8h.html#a2">MOLFILE_SUCCESS</a>;
00275 }
00276 
<a name="l00277"></a><a class="code" href="pdbplugin_8c.html#a6">00277</a> <font class="keyword">static</font> <font class="keywordtype">void</font> <a class="code" href="webpdbplugin_8c.html#a9">close_pdb_read</a>(<font class="keywordtype">void</font> *v) { 
00278   <a class="code" href="structpdbdata.html">pdbdata</a> *pdb = (<a class="code" href="structpdbdata.html">pdbdata</a> *)v;
00279   <font class="keywordflow">if</font> (pdb-&gt;<a class="code" href="structpdbdata.html#m0">fd</a> != NULL)
00280     fclose(pdb-&gt;<a class="code" href="structpdbdata.html#m0">fd</a>);
00281   <font class="keywordflow">if</font> (pdb-&gt;<a class="code" href="structpdbdata.html#m15">idxmap</a> != NULL)
00282     free(pdb-&gt;<a class="code" href="structpdbdata.html#m15">idxmap</a>);
00283   <font class="keywordflow">if</font> (pdb-&gt;<a class="code" href="structpdbdata.html#m9">meta</a>-&gt;<a class="code" href="structmolfile__metadata__t.html#m5">remarks</a> != NULL)
00284     free(pdb-&gt;<a class="code" href="structpdbdata.html#m9">meta</a>-&gt;<a class="code" href="structmolfile__metadata__t.html#m5">remarks</a>);
00285   <font class="keywordflow">if</font> (pdb-&gt;<a class="code" href="structpdbdata.html#m9">meta</a> != NULL) 
00286     free(pdb-&gt;<a class="code" href="structpdbdata.html#m9">meta</a>);
00287   free(pdb);
00288 }
00289 
<a name="l00290"></a><a class="code" href="pdbplugin_8c.html#a7">00290</a> <font class="keyword">static</font> <font class="keywordtype">void</font> *<a class="code" href="pdbplugin_8c.html#a7">open_file_write</a>(<font class="keyword">const</font> <font class="keywordtype">char</font> *path, <font class="keyword">const</font> <font class="keywordtype">char</font> *filetype, 
00291     <font class="keywordtype">int</font> natoms) {
00292 
00293   FILE *fd;
00294   <a class="code" href="structpdbdata.html">pdbdata</a> *pdb;
00295   fd = fopen(path, <font class="stringliteral">"w"</font>);
00296   <font class="keywordflow">if</font> (!fd) {
00297     fprintf(stderr, <font class="stringliteral">"Unable to open file %s for writing\n"</font>, path);
00298     <font class="keywordflow">return</font> NULL;
00299   }
00300   pdb = (<a class="code" href="structpdbdata.html">pdbdata</a> *)malloc(<font class="keyword">sizeof</font>(<a class="code" href="structpdbdata.html">pdbdata</a>));
00301   pdb-&gt;<a class="code" href="structpdbdata.html#m0">fd</a> = fd;
00302   pdb-&gt;<a class="code" href="structpdbdata.html#m1">natoms</a> = natoms; 
00303   pdb-&gt;<a class="code" href="structpdbdata.html#m8">atomlist</a> = NULL;
00304   pdb-&gt;<a class="code" href="structpdbdata.html#m7">first_frame</a> = 1;
00305   <font class="keywordflow">return</font> pdb;
00306 }
00307  
<a name="l00308"></a><a class="code" href="pdbplugin_8c.html#a8">00308</a> <font class="keyword">static</font> <font class="keywordtype">int</font> <a class="code" href="pdbplugin_8c.html#a8">write_structure</a>(<font class="keywordtype">void</font> *v, <font class="keywordtype">int</font> optflags, 
00309     <font class="keyword">const</font> <a class="code" href="structmolfile__atom__t.html">molfile_atom_t</a> *atoms) {
00310 
00311   <font class="keywordtype">int</font> i;
00312   <a class="code" href="structpdbdata.html">pdbdata</a> *pdb = (<a class="code" href="structpdbdata.html">pdbdata</a> *)v;
00313   <font class="keywordtype">int</font> natoms = pdb-&gt;<a class="code" href="structpdbdata.html#m1">natoms</a>;
00314   pdb-&gt;<a class="code" href="structpdbdata.html#m8">atomlist</a> = (<a class="code" href="structmolfile__atom__t.html">molfile_atom_t</a> *)malloc(natoms*<font class="keyword">sizeof</font>(<a class="code" href="structmolfile__atom__t.html">molfile_atom_t</a>));
00315   memcpy(pdb-&gt;<a class="code" href="structpdbdata.html#m8">atomlist</a>, atoms, natoms*<font class="keyword">sizeof</font>(<a class="code" href="structmolfile__atom__t.html">molfile_atom_t</a>));
00316 
00317   <font class="comment">/* If occ, bfactor, and insertion aren't given, we assign defaultvalues. */</font>
00318   <font class="keywordflow">if</font> (!(optflags &amp; <a class="code" href="molfile__plugin_8h.html#a10">MOLFILE_OCCUPANCY</a>)) {
00319     <font class="keywordflow">for</font> (i=0; i&lt;natoms; i++) pdb-&gt;<a class="code" href="structpdbdata.html#m8">atomlist</a>[i].<a class="code" href="structmolfile__atom__t.html#m8">occupancy</a> = 0.0f;
00320   }
00321   <font class="keywordflow">if</font> (!(optflags &amp; <a class="code" href="molfile__plugin_8h.html#a11">MOLFILE_BFACTOR</a>)) {
00322     <font class="keywordflow">for</font> (i=0; i&lt;natoms; i++) pdb-&gt;<a class="code" href="structpdbdata.html#m8">atomlist</a>[i].<a class="code" href="structmolfile__atom__t.html#m9">bfactor</a>= 0.0f;
00323   }
00324   <font class="keywordflow">if</font> (!(optflags &amp; <a class="code" href="molfile__plugin_8h.html#a9">MOLFILE_INSERTION</a>)) {
00325     <font class="keywordflow">for</font> (i=0; i&lt;natoms; i++) {
00326       pdb-&gt;<a class="code" href="structpdbdata.html#m8">atomlist</a>[i].<a class="code" href="structmolfile__atom__t.html#m7">insertion</a>[0] =<font class="charliteral">' '</font>;
00327       pdb-&gt;<a class="code" href="structpdbdata.html#m8">atomlist</a>[i].<a class="code" href="structmolfile__atom__t.html#m7">insertion</a>[1] =<font class="charliteral">'\0'</font>;
00328     }
00329   }
00330   <font class="keywordflow">if</font> (!(optflags &amp; <a class="code" href="molfile__plugin_8h.html#a15">MOLFILE_ALTLOC</a>)) {
00331     <font class="keywordflow">for</font> (i=0; i&lt;natoms; i++) {
00332       pdb-&gt;<a class="code" href="structpdbdata.html#m8">atomlist</a>[i].<a class="code" href="structmolfile__atom__t.html#m6">altloc</a>[0]=<font class="charliteral">' '</font>;
00333       pdb-&gt;<a class="code" href="structpdbdata.html#m8">atomlist</a>[i].<a class="code" href="structmolfile__atom__t.html#m6">altloc</a>[1]=<font class="charliteral">'\0'</font>;
00334     }
00335   }
00336   <font class="keywordflow">if</font> (!(optflags &amp; <a class="code" href="molfile__plugin_8h.html#a16">MOLFILE_ATOMICNUMBER</a>)) {
00337     <font class="keywordflow">for</font> (i=0; i&lt;natoms; i++) pdb-&gt;<a class="code" href="structpdbdata.html#m8">atomlist</a>[i].<a class="code" href="structmolfile__atom__t.html#m13">atomicnumber</a> = 0;
00338   }
00339 
00340   <font class="comment">/* TODO: put bonds into CONECT records? */</font>
00341   <font class="keywordflow">return</font> <a class="code" href="molfile__plugin_8h.html#a2">MOLFILE_SUCCESS</a>;
00342 }
00343 
00344 <font class="comment">/* SEQRES records look like this:</font>
00345 <font class="comment"></font>
00346 <font class="comment">COLUMNS        DATA TYPE       FIELD         DEFINITION</font>
00347 <font class="comment">---------------------------------------------------------------------------------</font>
00348 <font class="comment"> 1 -  6        Record name     "SEQRES"</font>
00349 <font class="comment"></font>
00350 <font class="comment"> 9 - 10        Integer         serNum        Serial number of the SEQRES record</font>
00351 <font class="comment">                                             for the current chain.  Starts at 1</font>
00352 <font class="comment">                                             and increments by one each line.</font>
00353 <font class="comment">                                             Reset to 1 for each chain.</font>
00354 <font class="comment"></font>
00355 <font class="comment">12             Character       chainID       Chain identifier.  This may be any</font>
00356 <font class="comment">                                             single legal character, including a</font>
00357 <font class="comment">                                             blank which is used if there is</font>
00358 <font class="comment">                                             only one chain.</font>
00359 <font class="comment"></font>
00360 <font class="comment">14 - 17        Integer         numRes        Number of residues in the chain.</font>
00361 <font class="comment">                                             This value is repeated on every</font>
00362 <font class="comment">                                             record.</font>
00363 <font class="comment"></font>
00364 <font class="comment">20 - 22        Residue name    resName       Residue name.</font>
00365 <font class="comment"></font>
00366 <font class="comment">24 - 26        Residue name    resName       Residue name.</font>
00367 <font class="comment"></font>
00368 <font class="comment">... and so forth out to 68-70, for a total of 13 in each line (except possibly</font>
00369 <font class="comment">the last.</font>
00370 <font class="comment"></font>
00371 <font class="comment">source:</font>
00372 <font class="comment">http://www.rcsb.org/pdb/file_formats/pdb/pdbguide2.2/part_35.html</font>
00373 <font class="comment">*/</font>
00374 
00375 <font class="comment">/*</font>
00376 <font class="comment"> * However, we don't use them right now because of several issues that</font>
00377 <font class="comment"> * can't presently be resolved satisfactorily in VMD:</font>
00378 <font class="comment"></font>
00379 <font class="comment">According to the RCSB, SEQRES records have to contain all residues, not</font>
00380 <font class="comment">just those in the structure, which means VMD will usually produce incorrect</font>
00381 <font class="comment">output and there's nothing we can do about it.  The RCSB actually specifies</font>
00382 <font class="comment">that all residues in the chain have to present in the SEQRES records, even</font>
00383 <font class="comment">if they're not in the structure.</font>
00384 <font class="comment">  </font>
00385 <font class="comment">We can never know which residues to output.  Our current system of outputting   </font>
00386 <font class="comment">everything is just terrible when you have 20,000 waters in your system; we</font>
00387 <font class="comment">have to fix this immediately.  We could almost get away with making a hash</font>
00388 <font class="comment">table of the names of protein and nucleic acid residues and only write chains</font>
00389 <font class="comment">containing those residues.  However, there's this little snippet from the</font>
00390 <font class="comment">specification:</font>
00391 <font class="comment">  </font>
00392 <font class="comment">* Heterogens which are integrated into the backbone of the chain are listed</font>
00393 <font class="comment">  as being part of the chain and are included in the SEQRES records for</font>
00394 <font class="comment">  that chain.</font>
00395 <font class="comment">  </font>
00396 <font class="comment">That means that we can never know what might appear in the sequence unless we</font>
00397 <font class="comment">also read HET records and keep track of them in VMD as well.  We shouldn't </font>
00398 <font class="comment">get people depending on such fallible SEQRES records.</font>
00399 <font class="comment">  </font>
00400 <font class="comment">And of course, there's the fact that no other program that we know of besides   </font>
00401 <font class="comment">CE needs these SEQRES records.</font>
00402 <font class="comment"></font>
00403 <font class="comment"> * Uncomment the write_seqres line in write_timestep to turn them back on.</font>
00404 <font class="comment"> */</font>
00405 
00406 
00407 <font class="preprocessor">#if 0</font>
00408 <font class="preprocessor"></font><font class="keyword">static</font> <font class="keywordtype">void</font> write_seqres(FILE * fd, <font class="keywordtype">int</font> natoms, <font class="keyword">const</font> <a class="code" href="structmolfile__atom__t.html">molfile_atom_t</a> *atomlist) {
00409   <font class="keywordtype">int</font> i=0;
00410   <font class="keywordflow">while</font> (i &lt; natoms) {
00411     <font class="keywordtype">int</font> k, serNum;
00412     <font class="keywordtype">int</font> j = i;
00413     <font class="keywordtype">int</font> ires, nres = 1;
00414     <font class="keywordtype">int</font> resid = atomlist[i].<a class="code" href="structmolfile__atom__t.html#m3">resid</a>;
00415     <font class="comment">/* Count up the number of residues in the chain */</font>
00416     <font class="keyword">const</font> <font class="keywordtype">char</font> *chain = atomlist[i].<a class="code" href="structmolfile__atom__t.html#m5">chain</a>;
00417     <font class="keywordflow">while</font> (j &lt; natoms &amp;&amp; !strcmp(chain, atomlist[j].chain)) {
00418       <font class="keywordflow">if</font> (resid != atomlist[j].<a class="code" href="structmolfile__atom__t.html#m3">resid</a>) {
00419         nres++;
00420         resid = atomlist[j].<a class="code" href="structmolfile__atom__t.html#m3">resid</a>;
00421       }
00422       j++;
00423     }
00424     <font class="comment">/* There are nres residues in the chain, from atoms i to j. */</font>
00425     serNum = 1;
00426     ires = 1;
00427     resid = atomlist[i].<a class="code" href="structmolfile__atom__t.html#m3">resid</a>;
00428     fprintf(fd, <font class="stringliteral">"SEQRES  %2d %c %4d  "</font>,  serNum, chain[0], nres);
00429     serNum = 2;
00430     fprintf(fd, <font class="stringliteral">"%3s "</font>, atomlist[i].resname);
00431     <font class="keywordflow">for</font> (k=i; k&lt;j; k++) {
00432       <font class="keywordflow">if</font> (resid != atomlist[k].<a class="code" href="structmolfile__atom__t.html#m3">resid</a>) {
00433         resid = atomlist[k].<a class="code" href="structmolfile__atom__t.html#m3">resid</a>;
00434         <font class="keywordflow">if</font> (!(ires % 13)) {
00435           fprintf(fd, <font class="stringliteral">"\nSEQRES  %2d %c %4d  "</font>,  serNum, chain[0], nres);
00436           serNum++;
00437         }
00438         fprintf(fd, <font class="stringliteral">"%3s "</font>, atomlist[k].resname);
00439         ires++;
00440       }
00441     }
00442     i = j;
00443     fprintf(fd, <font class="stringliteral">"\n"</font>);
00444   }
00445 }
00446 <font class="preprocessor">#endif</font>
00447 <font class="preprocessor"></font>
00448 <font class="comment">/*</font>
00449 <font class="comment">CRYST1 records look like this:</font>
00450 <font class="comment">The CRYST1 record presents the unit cell parameters, space group, and Z value. If the structure was not determined by crystallographic means, CRYST1 simply defines a unit cube. </font>
00451 <font class="comment"></font>
00452 <font class="comment"></font>
00453 <font class="comment">Record Format </font>
00454 <font class="comment"></font>
00455 <font class="comment">COLUMNS       DATA TYPE      FIELD         DEFINITION</font>
00456 <font class="comment">-------------------------------------------------------------</font>
00457 <font class="comment"> 1 -  6       Record name    "CRYST1"</font>
00458 <font class="comment"></font>
00459 <font class="comment"> 7 - 15       Real(9.3)      a             a (Angstroms).</font>
00460 <font class="comment"></font>
00461 <font class="comment">16 - 24       Real(9.3)      b             b (Angstroms).</font>
00462 <font class="comment"></font>
00463 <font class="comment">25 - 33       Real(9.3)      c             c (Angstroms).</font>
00464 <font class="comment"></font>
00465 <font class="comment">34 - 40       Real(7.2)      alpha         alpha (degrees).</font>
00466 <font class="comment"></font>
00467 <font class="comment">41 - 47       Real(7.2)      beta          beta (degrees).</font>
00468 <font class="comment"></font>
00469 <font class="comment">48 - 54       Real(7.2)      gamma         gamma (degrees).</font>
00470 <font class="comment"></font>
00471 <font class="comment">56 - 66       LString        sGroup        Space group.</font>
00472 <font class="comment"></font>
00473 <font class="comment">67 - 70       Integer        z             Z value.</font>
00474 <font class="comment"></font>
00475 <font class="comment">* If the coordinate entry describes a structure determined by a technique</font>
00476 <font class="comment">other than crystallography, CRYST1 contains a = b = c = 1.0, alpha =</font>
00477 <font class="comment">beta = gamma = 90 degrees, space group = P 1, and Z = 1.</font>
00478 <font class="comment"></font>
00479 <font class="comment">We will use "P 1" and "1" for space group and z value, as recommended, but</font>
00480 <font class="comment">we'll populate the other fields with the unit cell information we do have.</font>
00481 <font class="comment"></font>
00482 <font class="comment">*/</font>
00483   
<a name="l00484"></a><a class="code" href="pdbplugin_8c.html#a9">00484</a> <font class="keyword">static</font> <font class="keywordtype">void</font> <a class="code" href="pdbplugin_8c.html#a9">write_cryst1</a>(FILE *fd, <font class="keyword">const</font> <a class="code" href="structmolfile__timestep__t.html">molfile_timestep_t</a> *ts) {
00485   fprintf(fd, <font class="stringliteral">"CRYST1%9.3f%9.3f%9.3f%7.2f%7.2f%7.2f P 1           1\n"</font>, 
00486     ts-&gt;<a class="code" href="structmolfile__timestep__t.html#z4_0">A</a>, ts-&gt;<a class="code" href="structmolfile__timestep__t.html#z4_1">B</a>, ts-&gt;<a class="code" href="structmolfile__timestep__t.html#z4_2">C</a>, ts-&gt;<a class="code" href="structmolfile__timestep__t.html#z4_3">alpha</a>, ts-&gt;<a class="code" href="structmolfile__timestep__t.html#z4_4">beta</a>, ts-&gt;<a class="code" href="structmolfile__timestep__t.html#z4_5">gamma</a>);
00487 }
00488 
00489 
<a name="l00490"></a><a class="code" href="pdbplugin_8c.html#a10">00490</a> <font class="keyword">static</font> <font class="keywordtype">int</font> <a class="code" href="pdbplugin_8c.html#a10">write_timestep</a>(<font class="keywordtype">void</font> *v, <font class="keyword">const</font> <a class="code" href="structmolfile__timestep__t.html">molfile_timestep_t</a> *ts) {
00491   <a class="code" href="structpdbdata.html">pdbdata</a> *pdb = (<a class="code" href="structpdbdata.html">pdbdata</a> *)v; 
00492   <font class="keyword">const</font> <a class="code" href="structmolfile__atom__t.html">molfile_atom_t</a> *atom;
00493   <font class="keyword">const</font> <font class="keywordtype">float</font> *pos;
00494   <font class="keywordtype">int</font> i;
00495   <font class="keywordtype">char</font> elementsymbol[3];
00496 
00497   <font class="keywordflow">if</font> (pdb-&gt;<a class="code" href="structpdbdata.html#m1">natoms</a> == 0)
00498     <font class="keywordflow">return</font> <a class="code" href="molfile__plugin_8h.html#a2">MOLFILE_SUCCESS</a>;
00499 
00500   <font class="keywordflow">if</font> (pdb-&gt;<a class="code" href="structpdbdata.html#m7">first_frame</a>) {
00501     <font class="comment">/* Turn off SEQRES writing for now; see comments above.</font>
00502 <font class="comment">    write_seqres(pdb-&gt;fd, pdb-&gt;natoms, pdb-&gt;atomlist);</font>
00503 <font class="comment">    */</font>
00504     <a class="code" href="pdbplugin_8c.html#a9">write_cryst1</a>(pdb-&gt;<a class="code" href="structpdbdata.html#m0">fd</a>, ts);
00505     pdb-&gt;<a class="code" href="structpdbdata.html#m7">first_frame</a> = 0;
00506   }
00507   atom = pdb-&gt;<a class="code" href="structpdbdata.html#m8">atomlist</a>;
00508   pos = ts-&gt;<a class="code" href="structmolfile__timestep__t.html#m0">coords</a>;
00509   <font class="keywordflow">for</font> (i=0; i&lt;pdb-&gt;<a class="code" href="structpdbdata.html#m1">natoms</a>; i++) {
00510     <font class="comment">/*</font>
00511 <font class="comment">     * The 8.3 format for position, occupancy, and bfactor permits values </font>
00512 <font class="comment">     * only in the range of -999.9994 to 9999.9994 (so that they round</font>
00513 <font class="comment">     * to the range [-999.999, 9999.999]).  If values fall outside of that</font>
00514 <font class="comment">     * range, fail and emit an error message rather than generate a</font>
00515 <font class="comment">     * misformatted PDB file.</font>
00516 <font class="comment">     */</font>
00517 <font class="preprocessor">#define PDBBAD(x) ((x) &lt; -999.9994f || (x) &gt; 9999.9994f)</font>
00518 <font class="preprocessor"></font>    <font class="keywordflow">if</font> (PDBBAD(pos[0]) || PDBBAD(pos[1]) || PDBBAD(pos[2]) ||
00519                 PDBBAD(atom-&gt;<a class="code" href="structmolfile__atom__t.html#m8">occupancy</a>) || PDBBAD(atom-&gt;<a class="code" href="structmolfile__atom__t.html#m9">bfactor</a>)) {
00520             fprintf(stderr, <font class="stringliteral">"PDB WRITE ERROR: Position, occupancy, or b-factor (beta) for atom %d\n"</font>, i);
00521       fprintf(stderr, <font class="stringliteral">"                 cannot be written in PDB format.\n"</font>);
00522       fprintf(stderr, <font class="stringliteral">"                 File will be truncated.\n"</font>);
00523       <font class="keywordflow">return</font> <a class="code" href="molfile__plugin_8h.html#a4">MOLFILE_ERROR</a>;
00524     }
00525 
00526     <font class="comment">/* check the atomicnumber and format the atomic element symbol string */</font>
00527     strcpy(elementsymbol, (atom-&gt;<a class="code" href="structmolfile__atom__t.html#m13">atomicnumber</a> &lt; 1) ? <font class="stringliteral">"  "</font> : get_pte_label(atom-&gt;<a class="code" href="structmolfile__atom__t.html#m13">atomicnumber</a>));
00528     elementsymbol[0] = toupper(elementsymbol[0]);
00529     elementsymbol[1] = toupper(elementsymbol[1]);
00530  
00531     <font class="keywordflow">if</font> (!<a class="code" href="readpdb_8h.html#a18">write_raw_pdb_record</a>(pdb-&gt;<a class="code" href="structpdbdata.html#m0">fd</a>,  
00532         <font class="stringliteral">"ATOM  "</font>, i+1, atom-&gt;<a class="code" href="structmolfile__atom__t.html#m0">name</a>, atom-&gt;<a class="code" href="structmolfile__atom__t.html#m2">resname</a>, atom-&gt;<a class="code" href="structmolfile__atom__t.html#m3">resid</a>, 
00533         atom-&gt;<a class="code" href="structmolfile__atom__t.html#m7">insertion</a>, atom-&gt;<a class="code" href="structmolfile__atom__t.html#m6">altloc</a>, elementsymbol,
00534         pos[0], pos[1], pos[2], 
00535         atom-&gt;<a class="code" href="structmolfile__atom__t.html#m8">occupancy</a>, atom-&gt;<a class="code" href="structmolfile__atom__t.html#m9">bfactor</a>, atom-&gt;<a class="code" href="structmolfile__atom__t.html#m5">chain</a>, atom-&gt;<a class="code" href="structmolfile__atom__t.html#m4">segid</a>)) {
00536       fprintf(stderr, 
00537           <font class="stringliteral">"PDB: Error encoutered writing atom %d; file may be incomplete.\n"</font>, 
00538           i+1);
00539       <font class="keywordflow">return</font> <a class="code" href="molfile__plugin_8h.html#a4">MOLFILE_ERROR</a>;
00540     }
00541     ++atom;
00542     pos += 3;
00543   }
00544   fprintf(pdb-&gt;<a class="code" href="structpdbdata.html#m0">fd</a>, <font class="stringliteral">"END\n"</font>);
00545 
00546   <font class="keywordflow">return</font> <a class="code" href="molfile__plugin_8h.html#a2">MOLFILE_SUCCESS</a>;
00547 }
00548  
<a name="l00549"></a><a class="code" href="pdbplugin_8c.html#a11">00549</a> <font class="keyword">static</font> <font class="keywordtype">void</font> <a class="code" href="pdbplugin_8c.html#a11">close_file_write</a>(<font class="keywordtype">void</font> *v) {
00550   <a class="code" href="structpdbdata.html">pdbdata</a> *pdb = (<a class="code" href="structpdbdata.html">pdbdata</a> *)v; 
00551   fclose(pdb-&gt;<a class="code" href="structpdbdata.html#m0">fd</a>);
00552   free(pdb-&gt;<a class="code" href="structpdbdata.html#m8">atomlist</a>);
00553   free(pdb);
00554 }
00555 
<a name="l00556"></a><a class="code" href="pdbplugin_8c.html#a12">00556</a> <font class="keyword">static</font> <font class="keywordtype">int</font> <a class="code" href="xbgfplugin_8C.html#a16">read_molecule_metadata</a>(<font class="keywordtype">void</font> *v, <a class="code" href="structmolfile__metadata__t.html">molfile_metadata_t</a> **metadata) {
00557   <a class="code" href="structpdbdata.html">pdbdata</a> *pdb = (<a class="code" href="structpdbdata.html">pdbdata</a> *)v; 
00558   *metadata = pdb-&gt;<a class="code" href="structpdbdata.html#m9">meta</a>;
00559   <font class="keywordflow">return</font> <a class="code" href="molfile__plugin_8h.html#a2">MOLFILE_SUCCESS</a>;
00560 }
00561 
00562 <font class="comment">/*</font>
00563 <font class="comment"> * Initialization stuff down here</font>
00564 <font class="comment"> */</font>
00565 
<a name="l00566"></a><a class="code" href="pdbplugin_8c.html#a1">00566</a> <font class="keyword">static</font> <a class="code" href="structmolfile__plugin__t.html">molfile_plugin_t</a> <a class="code" href="pdbplugin_8c.html#a1">plugin</a> = {
00567   <a class="code" href="vmdplugin_8h.html#a10">vmdplugin_ABIVERSION</a>,                     <font class="comment">/* ABI version */</font>
00568   <a class="code" href="molfile__plugin_8h.html#a0">MOLFILE_PLUGIN_TYPE</a>,                      <font class="comment">/* type */</font>
00569   <font class="stringliteral">"pdb"</font>,                                    <font class="comment">/* short name */</font>
00570   <font class="stringliteral">"PDB"</font>,                                    <font class="comment">/* pretty name */</font>
00571   <font class="stringliteral">"Justin Gullingsrud, John Stone"</font>,         <font class="comment">/* author */</font>
00572   1,                                        <font class="comment">/* major version */</font>
00573   11,                                       <font class="comment">/* minor version */</font>
00574   <a class="code" href="vmdplugin_8h.html#a12">VMDPLUGIN_THREADSAFE</a>,                     <font class="comment">/* is_reentrant */</font>
00575   <font class="stringliteral">"pdb,ent"</font>,                                <font class="comment">/* filename extensions */</font>
00576   <a class="code" href="pdbplugin_8c.html#a2">open_pdb_read</a>,
00577   <a class="code" href="pdbplugin_8c.html#a3">read_pdb_structure</a>,
00578   <a class="code" href="pdbplugin_8c.html#a4">read_bonds</a>,                               <font class="comment">/* read bond list */</font>
00579   <a class="code" href="pdbplugin_8c.html#a5">read_next_timestep</a>,
00580   <a class="code" href="pdbplugin_8c.html#a6">close_pdb_read</a>,
00581   <a class="code" href="pdbplugin_8c.html#a7">open_file_write</a>,
00582   <a class="code" href="pdbplugin_8c.html#a8">write_structure</a>,
00583   <a class="code" href="pdbplugin_8c.html#a10">write_timestep</a>,
00584   <a class="code" href="pdbplugin_8c.html#a11">close_file_write</a>,
00585   0,
00586   0,
00587   0,
00588   <a class="code" href="pdbplugin_8c.html#a12">read_molecule_metadata</a>, 
00589 };
00590  
<a name="l00591"></a><a class="code" href="pdbplugin_8c.html#a13">00591</a> <a class="code" href="vmdplugin_8h.html#a7">VMDPLUGIN_API</a> <font class="keywordtype">int</font> <a class="code" href="vmdplugin_8h.html#a5">VMDPLUGIN_init</a>() {
00592   <font class="keywordflow">return</font> <a class="code" href="vmdplugin_8h.html#a13">VMDPLUGIN_SUCCESS</a>;
00593 }
00594 
<a name="l00595"></a><a class="code" href="pdbplugin_8c.html#a14">00595</a> <a class="code" href="vmdplugin_8h.html#a7">VMDPLUGIN_API</a> <font class="keywordtype">int</font> <a class="code" href="vmdplugin_8h.html#a3">VMDPLUGIN_register</a>(<font class="keywordtype">void</font> *v, <a class="code" href="vmdplugin_8h.html#a15">vmdplugin_register_cb</a> cb) {
00596   (*cb)(v, (<a class="code" href="structvmdplugin__t.html">vmdplugin_t</a> *)&amp;plugin);
00597   <font class="keywordflow">return</font> <a class="code" href="vmdplugin_8h.html#a13">VMDPLUGIN_SUCCESS</a>;
00598 }
00599 
<a name="l00600"></a><a class="code" href="pdbplugin_8c.html#a15">00600</a> <a class="code" href="vmdplugin_8h.html#a7">VMDPLUGIN_API</a> <font class="keywordtype">int</font> <a class="code" href="vmdplugin_8h.html#a6">VMDPLUGIN_fini</a>() {
00601   <font class="keywordflow">return</font> <a class="code" href="vmdplugin_8h.html#a13">VMDPLUGIN_SUCCESS</a>;
00602 }
00603 
</pre></div><hr><address><small>Generated on Wed Mar 22 13:15:30 2006 for VMD Plugins (current) by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.gif" alt="doxygen" align="middle" border=0 
width=110 height=53></a>1.2.14 written by <a href="mailto:dimitri@stack.nl">Dimitri van Heesch</a>,
 &copy;&nbsp;1997-2002</small></address>
</body>
</html>
