<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>bgfplugin.C Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.2.14 -->
<center>
<a class="qindex" href="index.html">Main Page</a> &nbsp; <a class="qindex" href="classes.html">Alphabetical List</a> &nbsp; <a class="qindex" href="annotated.html">Compound List</a> &nbsp; <a class="qindex" href="files.html">File List</a> &nbsp; <a class="qindex" href="functions.html">Compound Members</a> &nbsp; <a class="qindex" href="globals.html">File Members</a> &nbsp; <a class="qindex" href="pages.html">Related Pages</a> &nbsp; </center>
<hr><h1>bgfplugin.C</h1><a href="bgfplugin_8C.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 <font class="comment">/***************************************************************************</font>
00002 <font class="comment"> *cr</font>
00003 <font class="comment"> *cr            (C) Copyright 1995-2006 The Board of Trustees of the</font>
00004 <font class="comment"> *cr                        University of Illinois</font>
00005 <font class="comment"> *cr                         All Rights Reserved</font>
00006 <font class="comment"> *cr</font>
00007 <font class="comment"> ***************************************************************************/</font>
00008 
00009 <font class="comment">/***************************************************************************</font>
00010 <font class="comment"> * RCS INFORMATION:</font>
00011 <font class="comment"> *</font>
00012 <font class="comment"> *      $RCSfile: bgfplugin.C,v $</font>
00013 <font class="comment"> *      $Author: johns $       $Locker:  $             $State: Exp $</font>
00014 <font class="comment"> *      $Revision: 1.17 $       $Date: 2006/02/23 19:36:44 $</font>
00015 <font class="comment"> *</font>
00016 <font class="comment"> ***************************************************************************/</font>
00017 
00018 <font class="preprocessor">#include "<a class="code" href="molfile__plugin_8h.html">molfile_plugin.h</a>"</font>
00019 
00020 <font class="preprocessor">#include &lt;stdlib.h&gt;</font>
00021 <font class="preprocessor">#include &lt;stdio.h&gt;</font>
00022 <font class="preprocessor">#include &lt;string.h&gt;</font>
00023 
00024 <font class="preprocessor">#if defined(_AIX)</font>
00025 <font class="preprocessor"></font><font class="preprocessor">#include &lt;strings.h&gt;</font>
00026 <font class="preprocessor">#endif</font>
00027 <font class="preprocessor"></font>
<a name="l00028"></a><a class="code" href="bgfplugin_8C.html#a0">00028</a> <font class="preprocessor">#define LINESIZE 256</font>
00029 <font class="preprocessor"></font>
<a name="l00030"></a><a class="code" href="structbgfdata.html">00030</a> <font class="keyword">typedef</font> <font class="keyword">struct </font>{
<a name="l00031"></a><a class="code" href="structbgfdata.html#m0">00031</a>   FILE *file;
<a name="l00032"></a><a class="code" href="structbgfdata.html#m1">00032</a>   <a class="code" href="structmolfile__atom__t.html">molfile_atom_t</a> *atomlist;
<a name="l00033"></a><a class="code" href="structbgfdata.html#m4">00033</a>   <font class="keywordtype">int</font> natoms, nbonds, optflags, coords_read;
<a name="l00034"></a><a class="code" href="structbgfdata.html#m7">00034</a>   <font class="keywordtype">int</font> *from, *to;
<a name="l00035"></a><a class="code" href="structbgfdata.html#m8">00035</a>   <font class="keywordtype">float</font> *bondorder;
00036 } <a class="code" href="structbgfdata.html">bgfdata</a>;
00037 
00038 <font class="comment">// Open the file and create the bgf struct used to pass data to the other</font>
00039 <font class="comment">// functions.</font>
<a name="l00040"></a><a class="code" href="bgfplugin_8C.html#a2">00040</a> <font class="keyword">static</font> <font class="keywordtype">void</font> *<a class="code" href="xbgfplugin_8C.html#a2">open_bgf_read</a>(<font class="keyword">const</font> <font class="keywordtype">char</font> *path, <font class="keyword">const</font> <font class="keywordtype">char</font> *filetype, 
00041     <font class="keywordtype">int</font> *natoms) {
00042   FILE *fd;
00043   <a class="code" href="structbgfdata.html">bgfdata</a> *bgf;
00044   <font class="keywordtype">char</font> line[<a class="code" href="bgfplugin_8C.html#a0">LINESIZE</a>]; 
00045   <font class="keywordtype">int</font> nbonds, optflags;
00046   <font class="keywordtype">int</font> numat=0;
00047   nbonds=0;
00048   <font class="keywordtype">int</font> nbline; <font class="comment">//Number of bonds in current line</font>
00049 
00050   <font class="keywordflow">if</font> ((fd = fopen(path, <font class="stringliteral">"r"</font>)) == NULL)
00051     <font class="keywordflow">return</font> NULL;
00052 
00053   <font class="keywordflow">do</font> {
00054     fgets(line, <a class="code" href="bgfplugin_8C.html#a0">LINESIZE</a>, fd);
00055     <font class="keywordflow">if</font> ( ferror(fd) || feof(fd) ) {
00056       printf(<font class="stringliteral">"bgfplugin) Improperly terminated bgf file\n"</font>);
00057       <font class="keywordflow">return</font> NULL;
00058     }
00059 
00060     <font class="keywordflow">if</font> ((strncmp(line, <font class="stringliteral">"ATOM"</font>, 4) == 0) || (strncmp(line, <font class="stringliteral">"HETATM"</font>, 6)==0)) 
00061       numat++;
00062 
00063     <font class="keywordflow">if</font> (strncmp(line,<font class="stringliteral">"CONECT"</font>,6)==0) {
00064       nbline=(strlen(line)-1)/6; 
00065       nbline -= 2;
00066       nbonds += nbline;
00067     }
00068 
00069   } <font class="keywordflow">while</font> ( strncmp(line, <font class="stringliteral">"END"</font>, 3) );
00070     
00071   optflags = <a class="code" href="molfile__plugin_8h.html#a9">MOLFILE_INSERTION</a> | <a class="code" href="molfile__plugin_8h.html#a13">MOLFILE_CHARGE</a>; 
00072   *natoms = numat;
00073   rewind(fd);
00074 
00075   <font class="comment">// Allocate and initialize the bgf structure</font>
00076   bgf = <font class="keyword">new</font> <a class="code" href="structbgfdata.html">bgfdata</a>;
00077   bgf-&gt;<a class="code" href="structbgfdata.html#m0">file</a> = fd;
00078   bgf-&gt;<a class="code" href="structbgfdata.html#m2">natoms</a> = *natoms;
00079   bgf-&gt;<a class="code" href="structbgfdata.html#m3">nbonds</a> = nbonds;
00080 
00081   bgf-&gt;<a class="code" href="structbgfdata.html#m4">optflags</a> = optflags;
00082   bgf-&gt;<a class="code" href="structbgfdata.html#m5">coords_read</a> = 0;
00083   bgf-&gt;<a class="code" href="structbgfdata.html#m6">from</a> = NULL;
00084   bgf-&gt;<a class="code" href="structbgfdata.html#m7">to</a> = NULL;
00085   bgf-&gt;<a class="code" href="structbgfdata.html#m8">bondorder</a> = NULL;
00086 
00087   <font class="keywordflow">return</font> bgf;
00088 }
00089 
00090 
<a name="l00091"></a><a class="code" href="bgfplugin_8C.html#a3">00091</a> <font class="keyword">static</font> <font class="keywordtype">void</font> <a class="code" href="xbgfplugin_8C.html#a3">adjust_bgf_field_string</a>(<font class="keywordtype">char</font> *field) {
00092   <font class="keywordtype">int</font> i, len;
00093 
00094   len = strlen(field);
00095   <font class="keywordflow">while</font> (len &gt; 0 &amp;&amp; field[len-1] == <font class="charliteral">' '</font>) {
00096     field[len-1] = <font class="charliteral">'\0'</font>;
00097     len--;
00098   }
00099 
00100   <font class="keywordflow">while</font> (len &gt; 0 &amp;&amp; field[0] == <font class="charliteral">' '</font>) {
00101     <font class="keywordflow">for</font> (i=0; i &lt; len; i++)
00102       field[i] = field[i+1];
00103     len--;
00104   }
00105 }
00106 
00107 
<a name="l00108"></a><a class="code" href="bgfplugin_8C.html#a4">00108</a> <font class="keyword">static</font> <font class="keywordtype">void</font> <a class="code" href="xbgfplugin_8C.html#a4">get_bgf_coordinates</a>(<font class="keyword">const</font> <font class="keywordtype">char</font> *record, 
00109                                 <font class="keywordtype">float</font> *x, <font class="keywordtype">float</font> *y, <font class="keywordtype">float</font> *z) {
00110   <font class="keywordtype">char</font> numstr[50]; <font class="comment">/* store all fields in one array to save memset calls */</font>
00111   memset(numstr, 0, <font class="keyword">sizeof</font>(numstr));
00112   <font class="keywordflow">if</font> (x != NULL) {
00113     strncpy(numstr, record + 31, 10);
00114     *x = (float) atof(numstr);
00115   }
00116 
00117   <font class="keywordflow">if</font> (y != NULL) {
00118     strncpy(numstr+10, record + 41, 10);
00119     *y = (float) atof(numstr+10);
00120   }
00121 
00122   <font class="keywordflow">if</font> (z != NULL) {
00123     strncpy(numstr+20, record + 51, 10);
00124     *z = (float) atof(numstr+20);
00125   }
00126 }
00127 
00128 
<a name="l00129"></a><a class="code" href="bgfplugin_8C.html#a5">00129</a> <font class="keyword">static</font> <font class="keywordtype">void</font> <a class="code" href="xbgfplugin_8C.html#a5">get_bgf_fields</a>(<font class="keyword">const</font> <font class="keywordtype">char</font> *record, <font class="keywordtype">char</font> *<a class="code" href="xsfplugin_8C.html#a2">name</a>, <font class="keywordtype">char</font> *resname, 
00130                            <font class="keywordtype">char</font> *chain, <font class="keywordtype">char</font>* segname,
00131                            <font class="keywordtype">int</font> *resid, <font class="keywordtype">char</font> *type, <font class="keywordtype">float</font> *charge,
00132                            <font class="keywordtype">float</font> *x, <font class="keywordtype">float</font> *y, <font class="keywordtype">float</font> *z) {
00133   <font class="keywordtype">char</font> tempresid[6];
00134   <font class="keywordtype">char</font> tempcharge[9];
00135 
00136   <font class="comment">/* get atom name */</font>
00137   strncpy(<a class="code" href="xsfplugin_8C.html#a2">name</a>, record + 13, 5);
00138   <a class="code" href="xsfplugin_8C.html#a2">name</a>[5] = <font class="charliteral">'\0'</font>;
00139   <a class="code" href="xbgfplugin_8C.html#a3">adjust_bgf_field_string</a>(<a class="code" href="xsfplugin_8C.html#a2">name</a>); <font class="comment">/* remove spaces from the name */</font>
00140 
00141   <font class="comment">/* get residue name */</font>
00142   strncpy(resname, record + 19, 4);
00143   resname[4] = <font class="charliteral">'\0'</font>;
00144   <a class="code" href="xbgfplugin_8C.html#a3">adjust_bgf_field_string</a>(resname); <font class="comment">/* remove spaces from the resname */</font>
00145 
00146   <font class="comment">/* set segname */</font>
00147   segname[0]=<font class="charliteral">'\0'</font>;
00148 
00149   <font class="comment">/* get chain name */</font>
00150   chain[0] = record[23];
00151   chain[1] = <font class="charliteral">'\0'</font>;
00152 
00153   <font class="comment">/* get residue id number */</font>
00154   strncpy(tempresid, record + 26, 5);
00155   tempresid[5] = <font class="charliteral">'\0'</font>;
00156   <a class="code" href="xbgfplugin_8C.html#a3">adjust_bgf_field_string</a>(tempresid); <font class="comment">/* remove spaces from the resid */</font>
00157   *resid=atoi(tempresid);
00158 
00159   <font class="comment">/* get force field type */</font>
00160   strncpy(type, record+61, 5);
00161   type[5]=<font class="charliteral">'\0'</font>;
00162   <a class="code" href="xbgfplugin_8C.html#a3">adjust_bgf_field_string</a>(type);
00163 
00164   <font class="comment">/* get charge*/</font>
00165   strncpy(tempcharge, record + 72, 8);
00166   tempcharge[8] = <font class="charliteral">'\0'</font>;
00167   <a class="code" href="xbgfplugin_8C.html#a3">adjust_bgf_field_string</a>(tempcharge); <font class="comment">/* remove spaces from the charge */</font>
00168   *charge=atof(tempcharge);
00169 
00170   <font class="comment">/* get x, y, and z coordinates */</font>
00171   <a class="code" href="xbgfplugin_8C.html#a4">get_bgf_coordinates</a>(record, x, y, z);
00172 }  
00173 
00174 
00175 <font class="comment">// Read atom information, but not coordinates.</font>
<a name="l00176"></a><a class="code" href="bgfplugin_8C.html#a6">00176</a> <font class="keyword">static</font> <font class="keywordtype">int</font> <a class="code" href="xbgfplugin_8C.html#a6">read_bgf_structure</a>(<font class="keywordtype">void</font> *v, <font class="keywordtype">int</font> *optflags, <a class="code" href="structmolfile__atom__t.html">molfile_atom_t</a> *atoms) {
00177   <a class="code" href="structbgfdata.html">bgfdata</a> *bgf = (<a class="code" href="structbgfdata.html">bgfdata</a> *)v;
00178   <font class="keywordtype">char</font> line[<a class="code" href="bgfplugin_8C.html#a0">LINESIZE</a>]; 
00179   <a class="code" href="structmolfile__atom__t.html">molfile_atom_t</a> *atom;
00180   <font class="keywordtype">int</font> natoms=0;
00181 
00182   *optflags = bgf-&gt;<a class="code" href="structbgfdata.html#m4">optflags</a>;
00183 
00184   <font class="comment">// Find and read the ATOM record</font>
00185   rewind(bgf-&gt;<a class="code" href="structbgfdata.html#m0">file</a>);
00186   <font class="keywordflow">do</font> {
00187     fgets(line, <a class="code" href="bgfplugin_8C.html#a0">LINESIZE</a>, bgf-&gt;<a class="code" href="structbgfdata.html#m0">file</a>);
00188     <font class="keywordflow">if</font> ( ferror(bgf-&gt;<a class="code" href="structbgfdata.html#m0">file</a>) || feof(bgf-&gt;<a class="code" href="structbgfdata.html#m0">file</a>) ) {
00189       printf(<font class="stringliteral">"bgfplugin) FORMAT ATOM record not found in file.\n"</font>);
00190       <font class="keywordflow">return</font> <a class="code" href="molfile__plugin_8h.html#a4">MOLFILE_ERROR</a>;
00191     }
00192   } <font class="keywordflow">while</font> ( strncmp(line, <font class="stringliteral">"FORMAT ATOM"</font>, 11) );
00193 
00194   <font class="comment">// Read the atoms</font>
00195   <font class="keywordflow">do</font> {
00196     fgets(line, <a class="code" href="bgfplugin_8C.html#a0">LINESIZE</a>, bgf-&gt;<a class="code" href="structbgfdata.html#m0">file</a>);
00197     <font class="keywordflow">if</font> ( ferror(bgf-&gt;<a class="code" href="structbgfdata.html#m0">file</a>) || feof(bgf-&gt;<a class="code" href="structbgfdata.html#m0">file</a>) ) {
00198       printf(<font class="stringliteral">"bgfplugin) Error occurred reading atom record.\n"</font>);
00199       <font class="keywordflow">return</font> <a class="code" href="molfile__plugin_8h.html#a4">MOLFILE_ERROR</a>;
00200     }
00201 
00202     <font class="keywordflow">if</font> (strncmp(line, <font class="stringliteral">"ATOM"</font>, 4) &amp;&amp; strncmp(line, <font class="stringliteral">"HETATM"</font>, 6)) 
00203       <font class="keywordflow">continue</font>;
00204 
00205     atom=atoms+natoms;
00206     natoms++;
00207 
00208     <a class="code" href="xbgfplugin_8C.html#a5">get_bgf_fields</a>(line, atom-&gt;<a class="code" href="structmolfile__atom__t.html#m0">name</a>, atom-&gt;<a class="code" href="structmolfile__atom__t.html#m2">resname</a>, atom-&gt;<a class="code" href="structmolfile__atom__t.html#m5">chain</a>, 
00209                    atom-&gt;<a class="code" href="structmolfile__atom__t.html#m4">segid</a>, &amp;atom-&gt;<a class="code" href="structmolfile__atom__t.html#m3">resid</a>, atom-&gt;<a class="code" href="structmolfile__atom__t.html#m1">type</a>, &amp;atom-&gt;<a class="code" href="structmolfile__atom__t.html#m11">charge</a>, 
00210                    NULL, NULL, NULL);
00211   } <font class="keywordflow">while</font> (strncmp(line, <font class="stringliteral">"END"</font>, 3));
00212 
00213   bgf-&gt;<a class="code" href="structbgfdata.html#m2">natoms</a> = natoms;
00214 
00215   <font class="keywordflow">return</font> <a class="code" href="molfile__plugin_8h.html#a2">MOLFILE_SUCCESS</a>;
00216 }
00217 
00218 
00219 <font class="comment">// Read atom coordinates</font>
<a name="l00220"></a><a class="code" href="bgfplugin_8C.html#a7">00220</a> <font class="keyword">static</font> <font class="keywordtype">int</font> <a class="code" href="xbgfplugin_8C.html#a7">read_bgf_timestep</a>(<font class="keywordtype">void</font> *v, <font class="keywordtype">int</font> natoms, <a class="code" href="structmolfile__timestep__t.html">molfile_timestep_t</a> *ts) {
00221   <a class="code" href="structbgfdata.html">bgfdata</a> *bgf = (<a class="code" href="structbgfdata.html">bgfdata</a> *)v;
00222   <font class="keywordtype">char</font> line[<a class="code" href="bgfplugin_8C.html#a0">LINESIZE</a>];
00223   <font class="keywordtype">int</font> i;
00224   <font class="keywordtype">float</font> x, y, z;
00225 
00226   <font class="comment">// Since the file is rewound when coordinates are read, EOF shouldn't</font>
00227   <font class="comment">// happen. Instead, use a flag to indicate that the single timestep has</font>
00228   <font class="comment">// been read</font>
00229   <font class="keywordflow">if</font> (bgf-&gt;<a class="code" href="structbgfdata.html#m5">coords_read</a>) {
00230     <font class="keywordflow">return</font> <a class="code" href="molfile__plugin_8h.html#a3">MOLFILE_EOF</a>;
00231   }
00232 
00233   <font class="comment">// Find and read the ATOM record</font>
00234   rewind(bgf-&gt;<a class="code" href="structbgfdata.html#m0">file</a>);
00235   <font class="keywordflow">do</font> {
00236     fgets(line, <a class="code" href="bgfplugin_8C.html#a0">LINESIZE</a>, bgf-&gt;<a class="code" href="structbgfdata.html#m0">file</a>);
00237     <font class="keywordflow">if</font> ( ferror(bgf-&gt;<a class="code" href="structbgfdata.html#m0">file</a>) || feof(bgf-&gt;<a class="code" href="structbgfdata.html#m0">file</a>) ) {
00238       printf(<font class="stringliteral">"bgfplugin) No FORMAT ATOM record found in file.\n"</font>);
00239       <font class="keywordflow">return</font> <a class="code" href="molfile__plugin_8h.html#a4">MOLFILE_ERROR</a>;
00240     }
00241   } <font class="keywordflow">while</font> ( strncmp(line, <font class="stringliteral">"FORMAT ATOM"</font>, 11) );
00242 
00243   <font class="comment">// Read the atoms</font>
00244   <font class="keywordflow">for</font> (i = 0; i &lt; bgf-&gt;<a class="code" href="structbgfdata.html#m2">natoms</a>; i++) {
00245     fgets(line, <a class="code" href="bgfplugin_8C.html#a0">LINESIZE</a>, bgf-&gt;<a class="code" href="structbgfdata.html#m0">file</a>);
00246     <font class="keywordflow">if</font> ( ferror(bgf-&gt;<a class="code" href="structbgfdata.html#m0">file</a>) || feof(bgf-&gt;<a class="code" href="structbgfdata.html#m0">file</a>) ) {
00247       printf(<font class="stringliteral">"bgfplugin) Error occurred reading atom coordinates.\n"</font>);
00248       <font class="keywordflow">return</font> <a class="code" href="molfile__plugin_8h.html#a4">MOLFILE_ERROR</a>;
00249     }
00250 
00251     <font class="comment">// skip comments and blank lines</font>
00252     <font class="keywordflow">if</font> (strncmp(line,<font class="stringliteral">"ATOM"</font>,4)!=0 &amp;&amp; strncmp(line,<font class="stringliteral">"HETATM"</font>,6)!=0) <font class="keywordflow">continue</font>;
00253 
00254     <a class="code" href="xbgfplugin_8C.html#a4">get_bgf_coordinates</a>(line, &amp;x, &amp;y, &amp;z);
00255 
00256     <font class="keywordflow">if</font> (ts) {
00257       ts-&gt;<a class="code" href="structmolfile__timestep__t.html#m0">coords</a>[3*i  ] = x;
00258       ts-&gt;<a class="code" href="structmolfile__timestep__t.html#m0">coords</a>[3*i+1] = y;
00259       ts-&gt;<a class="code" href="structmolfile__timestep__t.html#m0">coords</a>[3*i+2] = z;
00260     }
00261   }
00262 
00263   bgf-&gt;<a class="code" href="structbgfdata.html#m5">coords_read</a> = 1;
00264   <font class="keywordflow">return</font> <a class="code" href="molfile__plugin_8h.html#a2">MOLFILE_SUCCESS</a>;
00265 }
00266 
00267 
<a name="l00268"></a><a class="code" href="bgfplugin_8C.html#a8">00268</a> <font class="keyword">static</font> <font class="keywordtype">void</font> *<a class="code" href="xbgfplugin_8C.html#a8">open_bgf_write</a>(<font class="keyword">const</font> <font class="keywordtype">char</font> *filename, <font class="keyword">const</font> <font class="keywordtype">char</font> *filetype, 
00269                            <font class="keywordtype">int</font> natoms) {
00270   FILE *fd;
00271   <a class="code" href="structbgfdata.html">bgfdata</a> *data;
00272 
00273   <font class="keywordflow">if</font> ((fd = fopen(filename, <font class="stringliteral">"w"</font>)) == NULL) {
00274     printf(<font class="stringliteral">"Error) Unable to open bgf file %s for writing\n"</font>, filename);
00275     <font class="keywordflow">return</font> NULL;
00276   }
00277   
00278   data = (<a class="code" href="structbgfdata.html">bgfdata</a> *)malloc(<font class="keyword">sizeof</font>(<a class="code" href="structbgfdata.html">bgfdata</a>));
00279   data-&gt;<a class="code" href="structbgfdata.html#m2">natoms</a> = natoms;
00280   data-&gt;<a class="code" href="structbgfdata.html#m0">file</a> = fd;
00281   <font class="keywordflow">return</font> data;
00282 }
00283 
00284 
<a name="l00285"></a><a class="code" href="bgfplugin_8C.html#a9">00285</a> <font class="keyword">static</font> <font class="keywordtype">int</font> <a class="code" href="xbgfplugin_8C.html#a9">write_bgf_structure</a>(<font class="keywordtype">void</font> *mydata, <font class="keywordtype">int</font> optflags, 
00286                                <font class="keyword">const</font> <a class="code" href="structmolfile__atom__t.html">molfile_atom_t</a> *atoms) {
00287   <a class="code" href="structbgfdata.html">bgfdata</a> *data = (<a class="code" href="structbgfdata.html">bgfdata</a> *)mydata;
00288   data-&gt;<a class="code" href="structbgfdata.html#m1">atomlist</a> = (<a class="code" href="structmolfile__atom__t.html">molfile_atom_t</a> *)malloc(data-&gt;<a class="code" href="structbgfdata.html#m2">natoms</a>*<font class="keyword">sizeof</font>(<a class="code" href="structmolfile__atom__t.html">molfile_atom_t</a>));
00289   memcpy(data-&gt;<a class="code" href="structbgfdata.html#m1">atomlist</a>, atoms, data-&gt;<a class="code" href="structbgfdata.html#m2">natoms</a>*<font class="keyword">sizeof</font>(<a class="code" href="structmolfile__atom__t.html">molfile_atom_t</a>));
00290   <font class="keywordflow">return</font> <a class="code" href="molfile__plugin_8h.html#a2">MOLFILE_SUCCESS</a>;
00291 }
00292 
<a name="l00293"></a><a class="code" href="bgfplugin_8C.html#a10">00293</a> <font class="keywordtype">void</font> <a class="code" href="bgfplugin_8C.html#a10">getatomfield</a>(<font class="keywordtype">char</font>* atomfield, <font class="keyword">const</font> <font class="keywordtype">char</font>* resname) {
00294   <font class="keywordflow">if</font> ((strncmp(resname,<font class="stringliteral">"ALA"</font>,3) == 0) || (strncmp(resname,<font class="stringliteral">"ASP"</font>,3) == 0) || (strncmp(resname,<font class="stringliteral">"ARG"</font>,3) == 0) || (strncmp(resname,<font class="stringliteral">"ASN"</font>,3) == 0) || (strncmp(resname,<font class="stringliteral">"CYS"</font>,3) == 0) || (strncmp(resname,<font class="stringliteral">"GLN"</font>,3) == 0) || (strncmp(resname,<font class="stringliteral">"GLU"</font>,3) == 0) || (strncmp(resname,<font class="stringliteral">"GLY"</font>,3) == 0) || (strncmp(resname,<font class="stringliteral">"HIS"</font>,3) == 0) || (strncmp(resname,<font class="stringliteral">"ILE"</font>,3) == 0) || (strncmp(resname,<font class="stringliteral">"LEU"</font>,3) == 0) || (strncmp(resname,<font class="stringliteral">"LYS"</font>,3) == 0) || (strncmp(resname,<font class="stringliteral">"MET"</font>,3) == 0) || (strncmp(resname,<font class="stringliteral">"PHE"</font>,3) == 0) || (strncmp(resname,<font class="stringliteral">"PRO"</font>,3) == 0) || (strncmp(resname,<font class="stringliteral">"SER"</font>,3) == 0) || (strncmp(resname,<font class="stringliteral">"THR"</font>,3) == 0) || (strncmp(resname,<font class="stringliteral">"TRP"</font>,3) == 0) || (strncmp(resname,<font class="stringliteral">"TYR"</font>,3) == 0) || (strncmp(resname,<font class="stringliteral">"VAL"</font>,3) == 0) || (strncmp(resname,<font class="stringliteral">"ADE"</font>,3) == 0) || (strncmp(resname,<font class="stringliteral">"THY"</font>,3) == 0) || (strncmp(resname,<font class="stringliteral">"GUA"</font>,3) == 0) || (strncmp(resname,<font class="stringliteral">"CYT"</font>,3) == 0) || (strncmp(resname,<font class="stringliteral">"URA"</font>,3) == 0) || (strncmp(resname,<font class="stringliteral">"HSD"</font>,3) == 0) || (strncmp(resname,<font class="stringliteral">"HSE"</font>,3) == 0) || (strncmp(resname,<font class="stringliteral">"HSP"</font>,3) == 0)) {
00295     strncpy(atomfield, <font class="stringliteral">"ATOM  \0"</font>, 7);
00296   } <font class="keywordflow">else</font> {
00297     strncpy(atomfield, <font class="stringliteral">"HETATM\0"</font>, 7);
00298   }
00299 }
00300       
<a name="l00301"></a><a class="code" href="bgfplugin_8C.html#a11">00301</a> <font class="keyword">static</font> <font class="keywordtype">void</font> <a class="code" href="bgfplugin_8C.html#a11">getdreiidff</a>(<font class="keywordtype">char</font>* outputtype, <font class="keyword">const</font> <font class="keywordtype">char</font>* psftype, <font class="keywordtype">int</font>&amp; numbonds, <font class="keywordtype">int</font>&amp; lp) {
00302   <font class="comment">//Note that while this function isn't used yet, it actually IS important, and will be enabled in the future pending dicussion with some bgf users</font>
00303   <font class="keywordflow">if</font> (strncmp(psftype,<font class="stringliteral">"H"</font>,1)==0) {
00304     <font class="comment">//It's a hydrogen</font>
00305     <font class="comment">//FIXME: Doesn't properly identify acidic hydrogens yet</font>
00306     strncpy(outputtype, <font class="stringliteral">"H_  "</font>,4);
00307     numbonds=1;
00308     lp=0;
00309     <font class="keywordflow">return</font>;
00310   } <font class="keywordflow">else</font> <font class="keywordflow">if</font> (strncmp(psftype,<font class="stringliteral">"C"</font>,1)==0) {
00311     <font class="comment">//It's a carbon... probably</font>
00312     <font class="keywordflow">if</font> (strncmp(psftype,<font class="stringliteral">"C "</font>,2)==0 || strncmp(psftype,<font class="stringliteral">"CA "</font>,3)==0 || strncmp(psftype,<font class="stringliteral">"CPH"</font>,3)==0 || strncmp(psftype,<font class="stringliteral">"CPT"</font>,3)==0 || strncmp(psftype,<font class="stringliteral">"CC "</font>,3)==0 || strncmp(psftype,<font class="stringliteral">"CD "</font>,3)==0 || strncmp(psftype,<font class="stringliteral">"CN1"</font>,3)==0 || strncmp(psftype,<font class="stringliteral">"CN2"</font>,3)==0 || strncmp(psftype,<font class="stringliteral">"CN3"</font>,3)==0 || strncmp(psftype,<font class="stringliteral">"CN4"</font>,3)==0 || strncmp(psftype,<font class="stringliteral">"CN5"</font>,3)==0 || strncmp(psftype,<font class="stringliteral">"CNA"</font>,3)==0) {
00313       strncpy(outputtype, <font class="stringliteral">"C_2 "</font>,4);
00314       numbonds=3;
00315       lp=0;
00316       <font class="keywordflow">return</font>; 
00317     } <font class="keywordflow">else</font> {
00318       strncpy(outputtype, <font class="stringliteral">"C_3 "</font>,4);
00319       numbonds=4;
00320       lp=0;
00321       <font class="keywordflow">return</font>; 
00322     }  
00323   } <font class="keywordflow">else</font> <font class="keywordflow">if</font> (strncmp(psftype,<font class="stringliteral">"N"</font>,1)==0) {
00324     <font class="comment">//It"s probably nitrogen</font>
00325     <font class="keywordflow">if</font> (strncmp(psftype,<font class="stringliteral">"NR"</font>,2)==0 || strncmp(psftype,<font class="stringliteral">"NH1"</font>,3)==0 || strncmp(psftype,<font class="stringliteral">"NH2"</font>,3)==0 || strncmp(psftype,<font class="stringliteral">"NC2"</font>,3)==0 || strncmp(psftype,<font class="stringliteral">"NY"</font>,2)==0 || (strncmp(psftype,<font class="stringliteral">"NN"</font>,2)==0 &amp;&amp; strncmp(psftype,<font class="stringliteral">"NN6"</font>,3)!=0)) {
00326       strncpy(outputtype, <font class="stringliteral">"N_R"</font>,4);
00327       numbonds=3;
00328       lp=0;
00329       <font class="keywordflow">return</font>;
00330     } <font class="keywordflow">else</font> {
00331       strncpy(outputtype, <font class="stringliteral">"N_3 "</font>,4);
00332       numbonds=3;
00333       lp=1;
00334       <font class="keywordflow">return</font>;
00335     }
00336   } <font class="keywordflow">else</font> <font class="keywordflow">if</font> (strncmp(psftype,<font class="stringliteral">"O"</font>,1)==0) {
00337     <font class="comment">//Probably an oxygen</font>
00338     <font class="keywordflow">if</font> (strncmp(psftype,<font class="stringliteral">"OH1"</font>,3)==0 || strncmp(psftype,<font class="stringliteral">"OS"</font>,2)==0 || strncmp(psftype,<font class="stringliteral">"OT "</font>,3)==0 || strncmp(psftype,<font class="stringliteral">"ON4"</font>,3)==0 || strncmp(psftype,<font class="stringliteral">"ON5"</font>,3)==0 || strncmp(psftype,<font class="stringliteral">"ON6"</font>,3)==0) {
00339       strncpy(outputtype, <font class="stringliteral">"O_3 "</font>,4);
00340       numbonds=2;
00341       lp=2;
00342       <font class="keywordflow">return</font>;
00343    } <font class="keywordflow">else</font> {
00344       strncpy(outputtype, <font class="stringliteral">"O_2 "</font>,4);
00345       numbonds=1;
00346       lp=2;
00347       <font class="keywordflow">return</font>;
00348     }
00349   } <font class="keywordflow">else</font> <font class="keywordflow">if</font> (strncmp(psftype,<font class="stringliteral">"S"</font>,1)==0) {
00350     strncpy(outputtype, <font class="stringliteral">"S_3 "</font>,4);
00351     numbonds=2;
00352     lp=2;
00353     <font class="keywordflow">return</font>;
00354   } <font class="keywordflow">else</font> <font class="keywordflow">if</font> (strncmp(psftype,<font class="stringliteral">"P"</font>,1)==0) {
00355     strncpy(outputtype, <font class="stringliteral">"P_3 "</font>,4);
00356     numbonds=6;
00357     lp=0;
00358     <font class="keywordflow">return</font>;
00359   } <font class="keywordflow">else</font> {
00360     strncpy(outputtype, <font class="stringliteral">"X_  "</font>,4);
00361     numbonds=0;
00362     lp=0;
00363     <font class="keywordflow">return</font>;
00364   }
00365 }
00366 
00367 
<a name="l00368"></a><a class="code" href="bgfplugin_8C.html#a12">00368</a> <font class="keyword">static</font> <font class="keywordtype">int</font> <a class="code" href="xbgfplugin_8C.html#a10">read_bgf_bonds</a>(<font class="keywordtype">void</font> *v, <font class="keywordtype">int</font> *nbonds, <font class="keywordtype">int</font> **fromptr, <font class="keywordtype">int</font> **toptr, <font class="keywordtype">float</font> **bondorderptr) {
00369   <a class="code" href="structbgfdata.html">bgfdata</a> *bgf = (<a class="code" href="structbgfdata.html">bgfdata</a> *)v;
00370   <font class="keywordtype">char</font> line[<a class="code" href="bgfplugin_8C.html#a0">LINESIZE</a>]; 
00371   <font class="keywordtype">char</font> nextline[<a class="code" href="bgfplugin_8C.html#a0">LINESIZE</a>]; 
00372   <font class="keywordflow">if</font> (bgf-&gt;<a class="code" href="structbgfdata.html#m3">nbonds</a> == 0) {
00373     *nbonds = 0;
00374     *fromptr = NULL;
00375     *toptr = NULL;
00376     <font class="keywordflow">return</font> <a class="code" href="molfile__plugin_8h.html#a2">MOLFILE_SUCCESS</a>;
00377   }
00378 
00379   <font class="comment">// Allocate memory for the from and to arrays. This will be freed in</font>
00380   <font class="comment">// close_mol2_read</font>
00381   bgf-&gt;<a class="code" href="structbgfdata.html#m6">from</a> = <font class="keyword">new</font> <font class="keywordtype">int</font>[bgf-&gt;<a class="code" href="structbgfdata.html#m3">nbonds</a>];
00382   bgf-&gt;<a class="code" href="structbgfdata.html#m7">to</a> = <font class="keyword">new</font> <font class="keywordtype">int</font>[bgf-&gt;<a class="code" href="structbgfdata.html#m3">nbonds</a>];
00383   bgf-&gt;<a class="code" href="structbgfdata.html#m8">bondorder</a> = <font class="keyword">new</font> <font class="keywordtype">float</font>[bgf-&gt;<a class="code" href="structbgfdata.html#m3">nbonds</a>];
00384 
00385   <font class="comment">// Find and read the BOND record</font>
00386   rewind(bgf-&gt;<a class="code" href="structbgfdata.html#m0">file</a>);
00387   <font class="keywordflow">do</font> {
00388     <font class="keywordflow">if</font> ( ferror(bgf-&gt;<a class="code" href="structbgfdata.html#m0">file</a>) || feof(bgf-&gt;<a class="code" href="structbgfdata.html#m0">file</a>) ) {
00389       printf(<font class="stringliteral">"bgfplugin) No bond record found in file.\n"</font>);
00390       <font class="keywordflow">return</font> <a class="code" href="molfile__plugin_8h.html#a4">MOLFILE_ERROR</a>;
00391     }
00392     fgets(line, <a class="code" href="bgfplugin_8C.html#a0">LINESIZE</a>, bgf-&gt;<a class="code" href="structbgfdata.html#m0">file</a>);
00393   } <font class="keywordflow">while</font> ( strncmp(line, <font class="stringliteral">"FORMAT CONECT"</font>, 13) != 0 );
00394 
00395   <font class="comment">// Read the bonds</font>
00396   <font class="keywordtype">int</font> j; <font class="comment">//From atom</font>
00397   <font class="keywordtype">int</font> k; <font class="comment">//To atom</font>
00398   <font class="keywordtype">bool</font> conline=<font class="keyword">false</font>; <font class="comment">//true if line after the conect line is an order line</font>
00399   <font class="keywordtype">char</font> currbond[7]=<font class="stringliteral">"xxxxxx"</font>; <font class="comment">//Stores current bond field</font>
00400   <font class="keywordtype">char</font> currcon[7]=<font class="stringliteral">"xxxxxx"</font>; <font class="comment">//Stores current ORDER field</font>
00401   <font class="keywordtype">char</font>* bondptr; <font class="comment">//pointer to current position in bond line</font>
00402   <font class="keywordtype">char</font>* conptr; <font class="comment">//pointer to current position in order line</font>
00403   <font class="keywordtype">int</font> bonds[8]; <font class="comment">//Stores bonds of current atom</font>
00404   <font class="keywordtype">float</font> orders[8]; <font class="comment">//Stores bond orders of current atom</font>
00405   <font class="keywordtype">int</font> numbonds; <font class="comment">//Stores number of bonds of current atom</font>
00406   <font class="keywordtype">int</font> numords; <font class="comment">//Stores number of bond order records of current atom</font>
00407   <font class="keywordtype">float</font> bo; <font class="comment">//current bond order</font>
00408   <font class="keywordtype">int</font> i=0; <font class="comment">//Number of the current bond</font>
00409   <font class="keywordtype">int</font> numfields=0; <font class="comment">//number of fields in the current line</font>
00410   fgets(line, <a class="code" href="bgfplugin_8C.html#a0">LINESIZE</a>, bgf-&gt;<a class="code" href="structbgfdata.html#m0">file</a>);
00411   <font class="keywordflow">while</font> (1) {
00412     <font class="comment">// bondptr=NULL;</font>
00413     <font class="comment">//conptr=NULL;</font>
00414     conline=<font class="keyword">false</font>;
00415 
00416     <font class="keywordflow">if</font> (strncmp(line,<font class="stringliteral">"END"</font>, 3)==0) 
00417       <font class="keywordflow">break</font>;
00418 
00419     fgets(nextline, <a class="code" href="bgfplugin_8C.html#a0">LINESIZE</a>, bgf-&gt;<a class="code" href="structbgfdata.html#m0">file</a>);
00420     <font class="keywordflow">if</font> ( ferror(bgf-&gt;<a class="code" href="structbgfdata.html#m0">file</a>) || feof(bgf-&gt;<a class="code" href="structbgfdata.html#m0">file</a>) ) {
00421       printf(<font class="stringliteral">"bgfplugin) Error occurred reading bond record.\n"</font>);
00422       <font class="keywordflow">return</font> <a class="code" href="molfile__plugin_8h.html#a4">MOLFILE_ERROR</a>;
00423     }
00424 
00425     <font class="keywordflow">if</font> (strncmp(nextline,<font class="stringliteral">"ORDER"</font>,5)==0) 
00426       conline=<font class="keyword">true</font>;
00427 
00428     <font class="keywordflow">if</font> (strncmp(line,<font class="stringliteral">"CONECT"</font>,6)==0) {
00429       numfields=(strlen(line)-1)/6;
00430       bondptr=&amp;line[0];
00431       numfields--;
00432       bondptr += 6;
00433       numbonds=0;
00434       numords=0;
00435       strncpy(currbond,bondptr,6);
00436       j=atoi(currbond);
00437       numfields--;
00438       bondptr += 6;
00439 
00440       <font class="keywordflow">while</font> ((numfields &gt; 0) &amp;&amp; (numbonds &lt; 8)) {
00441         strncpy(currbond,bondptr,6);
00442         numfields--;
00443         bondptr += 6;
00444         bonds[numbonds]=atoi(currbond);
00445         numbonds++;
00446       }
00447 
00448       <font class="keywordflow">if</font> (conline) {
00449         numfields=(strlen(line)-1)/6;
00450         conptr=&amp;nextline[0];
00451         numfields -= 2;
00452         conptr += 12;
00453         numords=0;
00454         <font class="keywordflow">while</font> ((numfields &gt; 0) &amp;&amp; (numords &lt; numbonds)) {
00455           strncpy(currcon,conptr,6);
00456           numfields--;
00457           conptr+=6;
00458           bo=atof(currcon);
00459           orders[numords]=bo;
00460           numords++;
00461         }
00462       }
00463 
00464       <font class="keywordflow">for</font> (<font class="keywordtype">int</font> l=0;l&lt;numbonds;l++) {
00465         k=bonds[l];
00466         <font class="keywordflow">if</font> (j&lt;k) {
00467           bgf-&gt;<a class="code" href="structbgfdata.html#m6">from</a>[i]=j;
00468           bgf-&gt;<a class="code" href="structbgfdata.html#m7">to</a>[i]=k;
00469 
00470           <font class="keywordflow">if</font> (conline) {
00471             bgf-&gt;<a class="code" href="structbgfdata.html#m8">bondorder</a>[i]=orders[l];
00472           } <font class="keywordflow">else</font> {
00473             bgf-&gt;<a class="code" href="structbgfdata.html#m8">bondorder</a>[i]=1.0;
00474           }
00475 
00476           i++;
00477         }
00478       }
00479         
00480       <font class="keywordflow">if</font> (conline) {
00481         fgets(line, <a class="code" href="bgfplugin_8C.html#a0">LINESIZE</a>, bgf-&gt;<a class="code" href="structbgfdata.html#m0">file</a>);
00482       } <font class="keywordflow">else</font> {
00483         strncpy(line,nextline,<a class="code" href="bgfplugin_8C.html#a0">LINESIZE</a>);
00484       }
00485     } <font class="keywordflow">else</font> {
00486       strncpy(line,nextline,<a class="code" href="bgfplugin_8C.html#a0">LINESIZE</a>);
00487     }
00488   }
00489 
00490   *nbonds = i;
00491   *fromptr = bgf-&gt;<a class="code" href="structbgfdata.html#m6">from</a>;
00492   *toptr = bgf-&gt;<a class="code" href="structbgfdata.html#m7">to</a>;
00493   *bondorderptr = bgf-&gt;<a class="code" href="structbgfdata.html#m8">bondorder</a>; 
00494 
00495   <font class="keywordflow">return</font> <a class="code" href="molfile__plugin_8h.html#a2">MOLFILE_SUCCESS</a>;
00496 }
00497 
00498 
<a name="l00499"></a><a class="code" href="bgfplugin_8C.html#a13">00499</a> <font class="keyword">static</font> <font class="keywordtype">int</font> <a class="code" href="xbgfplugin_8C.html#a11">read_bonds</a>(<font class="keywordtype">void</font> *v, <font class="keywordtype">int</font> *nbonds, <font class="keywordtype">int</font> **fromptr, <font class="keywordtype">int</font> **toptr, <font class="keywordtype">float</font> **bondorderptr) {
00500   <a class="code" href="structbgfdata.html">bgfdata</a> *bgf = (<a class="code" href="structbgfdata.html">bgfdata</a> *)v;
00501 
00502   *nbonds=bgf-&gt;<a class="code" href="structbgfdata.html#m3">nbonds</a>;
00503   <font class="keywordflow">if</font> (bgf-&gt;<a class="code" href="structbgfdata.html#m3">nbonds</a> &gt; 0) {
00504     bgf-&gt;<a class="code" href="structbgfdata.html#m6">from</a> = (<font class="keywordtype">int</font> *) malloc(*nbonds*<font class="keyword">sizeof</font>(<font class="keywordtype">int</font>));
00505     bgf-&gt;<a class="code" href="structbgfdata.html#m7">to</a> = (<font class="keywordtype">int</font> *) malloc(*nbonds*<font class="keyword">sizeof</font>(<font class="keywordtype">int</font>));
00506     bgf-&gt;<a class="code" href="structbgfdata.html#m8">bondorder</a> = (<font class="keywordtype">float</font> *) malloc(*nbonds*<font class="keyword">sizeof</font>(<font class="keywordtype">float</font>));
00507 
00508     <font class="keywordflow">if</font> ((<a class="code" href="xbgfplugin_8C.html#a10">read_bgf_bonds</a>(bgf, nbonds, &amp;(bgf-&gt;<a class="code" href="structbgfdata.html#m6">from</a>), &amp;(bgf-&gt;<a class="code" href="structbgfdata.html#m7">to</a>), &amp;(bgf-&gt;<a class="code" href="structbgfdata.html#m8">bondorder</a>))) != <a class="code" href="molfile__plugin_8h.html#a2">MOLFILE_SUCCESS</a>) {
00509       fclose(bgf-&gt;<a class="code" href="structbgfdata.html#m0">file</a>);
00510       bgf-&gt;<a class="code" href="structbgfdata.html#m0">file</a> = NULL;
00511       <font class="keywordflow">return</font> <a class="code" href="molfile__plugin_8h.html#a4">MOLFILE_ERROR</a>;
00512     }
00513 
00514     *fromptr = bgf-&gt;<a class="code" href="structbgfdata.html#m6">from</a>;
00515     *toptr = bgf-&gt;<a class="code" href="structbgfdata.html#m7">to</a>;
00516     *bondorderptr = bgf-&gt;<a class="code" href="structbgfdata.html#m8">bondorder</a>; 
00517   } <font class="keywordflow">else</font> {
00518     printf(<font class="stringliteral">"bgfplugin) WARNING: no bonds defined in bgf file.\n"</font>);
00519     *fromptr = NULL;
00520     *toptr = NULL;
00521     *bondorderptr = NULL;
00522   }
00523 
00524   <font class="keywordflow">return</font> <a class="code" href="molfile__plugin_8h.html#a2">MOLFILE_SUCCESS</a>;
00525 }
00526 
00527 
<a name="l00528"></a><a class="code" href="bgfplugin_8C.html#a14">00528</a> <font class="keyword">static</font> <font class="keywordtype">int</font> <a class="code" href="xbgfplugin_8C.html#a12">write_bgf_timestep</a>(<font class="keywordtype">void</font> *mydata, <font class="keyword">const</font> <a class="code" href="structmolfile__timestep__t.html">molfile_timestep_t</a> *ts) {
00529   <a class="code" href="structbgfdata.html">bgfdata</a> *data = (<a class="code" href="structbgfdata.html">bgfdata</a> *)mydata; 
00530   <font class="keyword">const</font> <a class="code" href="structmolfile__atom__t.html">molfile_atom_t</a> *atom;
00531   <font class="keyword">const</font> <font class="keywordtype">float</font> *pos;
00532   <font class="keywordtype">int</font> i;
00533 
00534   <font class="comment">//print header block</font>
00535   fprintf(data-&gt;<a class="code" href="structbgfdata.html#m0">file</a>, <font class="stringliteral">"BIOGRF  332\n"</font>);
00536   fprintf(data-&gt;<a class="code" href="structbgfdata.html#m0">file</a>, <font class="stringliteral">"REMARK NATOM %4i\n"</font>, data-&gt;<a class="code" href="structbgfdata.html#m2">natoms</a>);
00537   fprintf(data-&gt;<a class="code" href="structbgfdata.html#m0">file</a>, <font class="stringliteral">"FORCEFIELD DREIDING\n"</font>);
00538   fprintf(data-&gt;<a class="code" href="structbgfdata.html#m0">file</a>, <font class="stringliteral">"FORMAT ATOM   (a6,1x,i5,1x,a5,1x,a3,1x,a1,1x,a5,3f10.5,1x,a5,i3,i2,1x,f8.5,i2,i4,f10.5)\n"</font>);
00539 
00540   atom = data-&gt;<a class="code" href="structbgfdata.html#m1">atomlist</a>;
00541   pos = ts-&gt;<a class="code" href="structmolfile__timestep__t.html#m0">coords</a>;
00542   <font class="keywordtype">int</font> numbonds=0;
00543   <font class="keywordtype">int</font> lp=0;
00544   <font class="keywordtype">char</font> atomfield[7];
00545   <font class="keywordflow">for</font> (i = 0; i &lt; data-&gt;<a class="code" href="structbgfdata.html#m2">natoms</a>; i++) {
00546     <a class="code" href="bgfplugin_8C.html#a10">getatomfield</a>(&amp;atomfield[0], atom-&gt;<a class="code" href="structmolfile__atom__t.html#m2">resname</a>);
00547     fprintf(data-&gt;<a class="code" href="structbgfdata.html#m0">file</a>, <font class="stringliteral">"%-6s %5i %5s %3.3s %1s %5i%10.5f%10.5f%10.5f %-5s%3i%2i %8.5f%2i%4i\n"</font>, atomfield, i+1, atom-&gt;<a class="code" href="structmolfile__atom__t.html#m0">name</a>, atom-&gt;<a class="code" href="structmolfile__atom__t.html#m2">resname</a>, atom-&gt;<a class="code" href="structmolfile__atom__t.html#m5">chain</a>, atom-&gt;<a class="code" href="structmolfile__atom__t.html#m3">resid</a>, pos[0], pos[1], pos[2], atom-&gt;<a class="code" href="structmolfile__atom__t.html#m1">type</a>, numbonds, lp, atom-&gt;<a class="code" href="structmolfile__atom__t.html#m11">charge</a>, 0, 0);
00548     ++atom; 
00549     pos += 3;
00550   }
00551 
00552   <font class="comment">//write the connectivity data</font>
00553   fprintf(data-&gt;<a class="code" href="structbgfdata.html#m0">file</a>,<font class="stringliteral">"FORMAT CONECT (a6,14i6) \nFORMAT ORDER (a6,i6,13f6.3)\n"</font>);
00554 
00555   <font class="comment">//iterate through the bond arrays and write them all</font>
00556   <font class="keywordtype">int</font> *bonds    =(<font class="keywordtype">int</font> *)  malloc((data-&gt;<a class="code" href="structbgfdata.html#m2">natoms</a>+1) * <font class="keyword">sizeof</font>(<font class="keywordtype">int</font>) * 6);
00557   <font class="keywordtype">float</font> *orders =(<font class="keywordtype">float</font> *)malloc((data-&gt;<a class="code" href="structbgfdata.html#m2">natoms</a>+1) * <font class="keyword">sizeof</font>(<font class="keywordtype">float</font>) * 6);
00558   <font class="keywordtype">int</font> *numcons  =(<font class="keywordtype">int</font> *)  malloc((data-&gt;<a class="code" href="structbgfdata.html#m2">natoms</a>+1) * <font class="keyword">sizeof</font>(<font class="keywordtype">int</font>));
00559 
00560   <font class="keywordflow">for</font> (i=0;i&lt;data-&gt;<a class="code" href="structbgfdata.html#m2">natoms</a>+1;i++) {
00561     numcons[i]=0;
00562   }
00563 
00564   <font class="keywordtype">int</font> j, k;         <font class="comment">//indices for atoms being bonded</font>
00565   <font class="keywordtype">float</font> o;          <font class="comment">//bond order</font>
00566   <font class="keywordtype">bool</font> printorder;  <font class="comment">//flag to print bond orders</font>
00567   <font class="keywordtype">int</font> l;            <font class="comment">//dummy iterator in bond order loop</font>
00568   <font class="keywordflow">for</font> (i=0;i&lt;data-&gt;<a class="code" href="structbgfdata.html#m3">nbonds</a>;i++) {
00569     j=data-&gt;<a class="code" href="structbgfdata.html#m6">from</a>[i];
00570     k=data-&gt;<a class="code" href="structbgfdata.html#m7">to</a>[i];
00571     o=data-&gt;<a class="code" href="structbgfdata.html#m8">bondorder</a>[i];
00572     numcons[j]++;
00573     numcons[k]++;
00574     <font class="keywordflow">if</font> (numcons[j]&gt;6) {
00575       printf(<font class="stringliteral">"bgfplugin) Warning: Bond overflow. Not all bonds were written\n"</font>);
00576       numcons[j]--;
00577       numcons[k]--;
00578       <font class="keywordflow">continue</font>;
00579     }
00580        
00581     <font class="keywordflow">if</font> (numcons[k]&gt;6) {
00582       printf(<font class="stringliteral">"bgfplugin) Warning: Bond overflow. Not all bonds were written\n"</font>);
00583       numcons[k]--;
00584       numcons[j]--;
00585       <font class="keywordflow">continue</font>;
00586     }
00587     bonds[6*j+numcons[j]-1]=k;
00588     bonds[6*k+numcons[k]-1]=j;
00589     orders[6*j+numcons[j]-1]=o;
00590     orders[6*k+numcons[k]-1]=o;
00591   }
00592 
00593   <font class="keywordflow">for</font> (i=1;i&lt;=data-&gt;<a class="code" href="structbgfdata.html#m2">natoms</a>;i++) {
00594     fprintf(data-&gt;<a class="code" href="structbgfdata.html#m0">file</a>,<font class="stringliteral">"CONECT%6i"</font>,i);
00595     <font class="keywordflow">for</font> (j=0;j&lt;numcons[i];j++) {
00596       fprintf(data-&gt;<a class="code" href="structbgfdata.html#m0">file</a>,<font class="stringliteral">"%6i"</font>,bonds[6*i+j]);
00597     }
00598     fprintf(data-&gt;<a class="code" href="structbgfdata.html#m0">file</a>,<font class="stringliteral">"\n"</font>);
00599     printorder = <font class="keyword">false</font>;
00600     <font class="keywordflow">for</font> (l=0;l&lt;numcons[i];l++) {
00601       <font class="keywordflow">if</font> (orders[6*i+l] != 1.0) {
00602         printorder = <font class="keyword">true</font>;
00603       }
00604     }
00605     <font class="keywordflow">if</font> (printorder) {
00606       fprintf(data-&gt;<a class="code" href="structbgfdata.html#m0">file</a>,<font class="stringliteral">"ORDER %6i"</font>,i);
00607       <font class="keywordflow">for</font> (j=0;j&lt;numcons[i];j++) {
00608         fprintf(data-&gt;<a class="code" href="structbgfdata.html#m0">file</a>,<font class="stringliteral">"%6i"</font>,<font class="keywordtype">int</font>(orders[6*i+j]));
00609       }
00610       fprintf(data-&gt;<a class="code" href="structbgfdata.html#m0">file</a>,<font class="stringliteral">"\n"</font>);
00611     }
00612   }
00613 
00614   free(bonds);
00615   free(orders);
00616   free(numcons);
00617 
00618   fprintf(data-&gt;<a class="code" href="structbgfdata.html#m0">file</a>,<font class="stringliteral">"END\n"</font>);
00619   <font class="keywordflow">return</font> <a class="code" href="molfile__plugin_8h.html#a2">MOLFILE_SUCCESS</a>;
00620 }
00621 
<a name="l00622"></a><a class="code" href="bgfplugin_8C.html#a15">00622</a> <font class="keyword">static</font> <font class="keywordtype">int</font> <a class="code" href="xbgfplugin_8C.html#a13">write_bonds</a>(<font class="keywordtype">void</font> *v, <font class="keywordtype">int</font> nbonds, <font class="keywordtype">int</font> *fromptr, <font class="keywordtype">int</font> *toptr, <font class="keywordtype">float</font> *bondorderptr) {
00623   <a class="code" href="structbgfdata.html">bgfdata</a> *data = (<a class="code" href="structbgfdata.html">bgfdata</a> *)v;
00624   data-&gt;<a class="code" href="structbgfdata.html#m6">from</a> = <font class="keyword">new</font> <font class="keywordtype">int</font>[nbonds];
00625   data-&gt;<a class="code" href="structbgfdata.html#m7">to</a> = <font class="keyword">new</font> <font class="keywordtype">int</font>[nbonds];
00626   data-&gt;<a class="code" href="structbgfdata.html#m8">bondorder</a> = <font class="keyword">new</font> <font class="keywordtype">float</font>[nbonds];
00627 
00628   <font class="comment">//set the pointers for use later</font>
00629   <font class="keywordflow">for</font> (<font class="keywordtype">int</font> i=0;i&lt;nbonds;i++) {
00630     data-&gt;<a class="code" href="structbgfdata.html#m6">from</a>[i]=fromptr[i];
00631     data-&gt;<a class="code" href="structbgfdata.html#m7">to</a>[i]=toptr[i];
00632     data-&gt;<a class="code" href="structbgfdata.html#m8">bondorder</a>[i]=bondorderptr[i];
00633   }
00634 
00635   data-&gt;<a class="code" href="structbgfdata.html#m3">nbonds</a> = nbonds;
00636   <font class="keywordflow">return</font> <a class="code" href="molfile__plugin_8h.html#a2">MOLFILE_SUCCESS</a>;
00637 }
00638 
<a name="l00639"></a><a class="code" href="bgfplugin_8C.html#a16">00639</a> <font class="keyword">static</font> <font class="keywordtype">void</font> <a class="code" href="xbgfplugin_8C.html#a14">close_bgf_write</a>(<font class="keywordtype">void</font> *mydata) {
00640   <a class="code" href="structbgfdata.html">bgfdata</a> *data = (<a class="code" href="structbgfdata.html">bgfdata</a> *)mydata;
00641   <font class="keywordflow">if</font> (data-&gt;<a class="code" href="structbgfdata.html#m0">file</a> != NULL) fclose(data-&gt;<a class="code" href="structbgfdata.html#m0">file</a>);
00642 
00643   <font class="keywordflow">if</font> (data-&gt;<a class="code" href="structbgfdata.html#m1">atomlist</a> != NULL) free(data-&gt;<a class="code" href="structbgfdata.html#m1">atomlist</a>);
00644   <font class="keywordflow">if</font> (data-&gt;<a class="code" href="structbgfdata.html#m6">from</a> != NULL) free(data-&gt;<a class="code" href="structbgfdata.html#m6">from</a>);
00645   <font class="keywordflow">if</font> (data-&gt;<a class="code" href="structbgfdata.html#m7">to</a> != NULL) free(data-&gt;<a class="code" href="structbgfdata.html#m7">to</a>);
00646   <font class="keywordflow">if</font> (data-&gt;<a class="code" href="structbgfdata.html#m8">bondorder</a> != NULL) free(data-&gt;<a class="code" href="structbgfdata.html#m8">bondorder</a>);
00647   free(data);
00648 }
00649 
00650 <font class="comment">//</font>
00651 <font class="comment">// Free the memory used by the bgf structure</font>
<a name="l00652"></a><a class="code" href="bgfplugin_8C.html#a17">00652</a> <font class="keyword">static</font> <font class="keywordtype">void</font> <a class="code" href="xbgfplugin_8C.html#a15">close_bgf_read</a>(<font class="keywordtype">void</font> *v) {
00653   <a class="code" href="structbgfdata.html">bgfdata</a> *bgf = (<a class="code" href="structbgfdata.html">bgfdata</a> *)v;
00654   <font class="keywordflow">if</font> (bgf) {
00655     <font class="keywordflow">if</font> (bgf-&gt;<a class="code" href="structbgfdata.html#m0">file</a> != NULL) fclose(bgf-&gt;<a class="code" href="structbgfdata.html#m0">file</a>);
00656     <font class="keywordflow">if</font> (bgf-&gt;<a class="code" href="structbgfdata.html#m6">from</a> != NULL) free(bgf-&gt;<a class="code" href="structbgfdata.html#m6">from</a>);
00657     <font class="keywordflow">if</font> (bgf-&gt;<a class="code" href="structbgfdata.html#m7">to</a> != NULL)   free(bgf-&gt;<a class="code" href="structbgfdata.html#m7">to</a>);
00658     <font class="keywordflow">if</font> (bgf-&gt;<a class="code" href="structbgfdata.html#m8">bondorder</a> != NULL)   free(bgf-&gt;<a class="code" href="structbgfdata.html#m8">bondorder</a>);
00659     <font class="keyword">delete</font> bgf;
00660   }
00661 }
00662 
00663 
<a name="l00664"></a><a class="code" href="bgfplugin_8C.html#a1">00664</a> <font class="keyword">static</font> <a class="code" href="structmolfile__plugin__t.html">molfile_plugin_t</a> <a class="code" href="bgfplugin_8C.html#a1">bgfplugin</a> = {
00665   <a class="code" href="vmdplugin_8h.html#a10">vmdplugin_ABIVERSION</a>,
00666   <a class="code" href="molfile__plugin_8h.html#a0">MOLFILE_PLUGIN_TYPE</a>,                      
00667   <font class="stringliteral">"bgf"</font>,                                    
00668   <font class="stringliteral">"MSI Biograf Format"</font>,
00669   <font class="stringliteral">"Peter Freddolino "</font>,    
00670   0,                                        
00671   9,                                        
00672   <a class="code" href="vmdplugin_8h.html#a12">VMDPLUGIN_THREADSAFE</a>,                     
00673   <font class="stringliteral">"bgf"</font>,
00674   <a class="code" href="bgfplugin_8C.html#a2">open_bgf_read</a>,
00675   <a class="code" href="bgfplugin_8C.html#a6">read_bgf_structure</a>,
00676   <a class="code" href="bgfplugin_8C.html#a13">read_bonds</a>,
00677   <a class="code" href="bgfplugin_8C.html#a7">read_bgf_timestep</a>,
00678   <a class="code" href="bgfplugin_8C.html#a17">close_bgf_read</a>,
00679   <a class="code" href="bgfplugin_8C.html#a8">open_bgf_write</a>,
00680   <a class="code" href="bgfplugin_8C.html#a9">write_bgf_structure</a>,
00681   <a class="code" href="bgfplugin_8C.html#a14">write_bgf_timestep</a>,
00682   <a class="code" href="bgfplugin_8C.html#a16">close_bgf_write</a>,
00683   0,                            
00684   0,                            
00685   0,
00686   0,
00687   <a class="code" href="bgfplugin_8C.html#a15">write_bonds</a>  
00688 };
00689 
<a name="l00690"></a><a class="code" href="bgfplugin_8C.html#a18">00690</a> <a class="code" href="vmdplugin_8h.html#a7">VMDPLUGIN_API</a> <font class="keywordtype">int</font> <a class="code" href="vmdplugin_8h.html#a5">VMDPLUGIN_init</a>() {
00691   <font class="keywordflow">return</font> <a class="code" href="vmdplugin_8h.html#a13">VMDPLUGIN_SUCCESS</a>;
00692 }
00693 
<a name="l00694"></a><a class="code" href="bgfplugin_8C.html#a19">00694</a> <a class="code" href="vmdplugin_8h.html#a7">VMDPLUGIN_API</a> <font class="keywordtype">int</font> <a class="code" href="vmdplugin_8h.html#a3">VMDPLUGIN_register</a>(<font class="keywordtype">void</font> *v, <a class="code" href="vmdplugin_8h.html#a15">vmdplugin_register_cb</a> cb) {
00695   (*cb)(v, (<a class="code" href="structvmdplugin__t.html">vmdplugin_t</a> *)&amp;bgfplugin);
00696   <font class="keywordflow">return</font> <a class="code" href="vmdplugin_8h.html#a13">VMDPLUGIN_SUCCESS</a>;
00697 }
00698 
<a name="l00699"></a><a class="code" href="bgfplugin_8C.html#a20">00699</a> <a class="code" href="vmdplugin_8h.html#a7">VMDPLUGIN_API</a> <font class="keywordtype">int</font> <a class="code" href="vmdplugin_8h.html#a6">VMDPLUGIN_fini</a>() {
00700   <font class="keywordflow">return</font> <a class="code" href="vmdplugin_8h.html#a13">VMDPLUGIN_SUCCESS</a>;
00701 }
00702 
00703 
</pre></div><hr><address><small>Generated on Wed Mar 22 13:15:28 2006 for VMD Plugins (current) by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.gif" alt="doxygen" align="middle" border=0 
width=110 height=53></a>1.2.14 written by <a href="mailto:dimitri@stack.nl">Dimitri van Heesch</a>,
 &copy;&nbsp;1997-2002</small></address>
</body>
</html>
