<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>psfplugin.c Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.2.14 -->
<center>
<a class="qindex" href="index.html">Main Page</a> &nbsp; <a class="qindex" href="classes.html">Alphabetical List</a> &nbsp; <a class="qindex" href="annotated.html">Compound List</a> &nbsp; <a class="qindex" href="files.html">File List</a> &nbsp; <a class="qindex" href="functions.html">Compound Members</a> &nbsp; <a class="qindex" href="globals.html">File Members</a> &nbsp; <a class="qindex" href="pages.html">Related Pages</a> &nbsp; </center>
<hr><h1>psfplugin.c</h1><a href="psfplugin_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 <font class="comment">/***************************************************************************</font>
00002 <font class="comment"> *cr</font>
00003 <font class="comment"> *cr            (C) Copyright 1995-2006 The Board of Trustees of the</font>
00004 <font class="comment"> *cr                        University of Illinois</font>
00005 <font class="comment"> *cr                         All Rights Reserved</font>
00006 <font class="comment"> *cr</font>
00007 <font class="comment"> ***************************************************************************/</font>
00008 
00009 <font class="comment">/***************************************************************************</font>
00010 <font class="comment"> * RCS INFORMATION:</font>
00011 <font class="comment"> *</font>
00012 <font class="comment"> *      $RCSfile: psfplugin.c,v $</font>
00013 <font class="comment"> *      $Author: johns $       $Locker:  $             $State: Exp $</font>
00014 <font class="comment"> *      $Revision: 1.33 $       $Date: 2006/02/23 19:36:45 $</font>
00015 <font class="comment"> *</font>
00016 <font class="comment"> ***************************************************************************/</font>
00017 
00018 <font class="preprocessor">#include "<a class="code" href="molfile__plugin_8h.html">molfile_plugin.h</a>"</font>
00019 
00020 <font class="preprocessor">#include &lt;stdio.h&gt;</font>
00021 <font class="preprocessor">#include &lt;string.h&gt;</font>
00022 <font class="preprocessor">#include &lt;stdlib.h&gt;</font>
00023 
<a name="l00024"></a><a class="code" href="psfplugin_8c.html#a0">00024</a> <font class="preprocessor">#define PSF_RECORD_LENGTH   160  </font><font class="comment">/* extended to handle Charmm CMAP/CHEQ */</font> 
00025 
<a name="l00026"></a><a class="code" href="structpsfdata.html">00026</a> <font class="keyword">typedef</font> <font class="keyword">struct </font>{
<a name="l00027"></a><a class="code" href="structpsfdata.html#m0">00027</a>   FILE *fp;
<a name="l00028"></a><a class="code" href="structpsfdata.html#m1">00028</a>   <font class="keywordtype">int</font> numatoms;
<a name="l00029"></a><a class="code" href="structpsfdata.html#m2">00029</a>   <font class="keywordtype">int</font> charmmfmt;  <font class="comment">/* whether psf was written in charmm format          */</font>
<a name="l00030"></a><a class="code" href="structpsfdata.html#m3">00030</a>   <font class="keywordtype">int</font> charmmcmap; <font class="comment">/* stuff used by charmm for polarizable force fields */</font>
<a name="l00031"></a><a class="code" href="structpsfdata.html#m4">00031</a>   <font class="keywordtype">int</font> charmmcheq; <font class="comment">/* stuff used by charmm for polarizable force fields */</font>
<a name="l00032"></a><a class="code" href="structpsfdata.html#m5">00032</a>   <font class="keywordtype">int</font> charmmext;  <font class="comment">/* flag used by charmm for IOFOrmat EXTEnded         */</font>
<a name="l00033"></a><a class="code" href="structpsfdata.html#m6">00033</a>   <font class="keywordtype">int</font> nbonds;
<a name="l00034"></a><a class="code" href="structpsfdata.html#m8">00034</a>   <font class="keywordtype">int</font> *from, *to;
00035 } <a class="code" href="structpsfdata.html">psfdata</a>;
00036 
00037 
00038 
00039 <font class="comment">/* Read in the next atom info into the given storage areas; this assumes</font>
00040 <font class="comment">   that file has already been moved to the beginning of the atom records.</font>
00041 <font class="comment">   Returns the serial number of the atom. If there is an error, returns -1.*/</font>
<a name="l00042"></a><a class="code" href="psfplugin_8c.html#a2">00042</a> <font class="keyword">static</font> <font class="keywordtype">int</font> <a class="code" href="psfplugin_8c.html#a2">get_psf_atom</a>(FILE *f, <font class="keywordtype">char</font> *<a class="code" href="xsfplugin_8C.html#a2">name</a>, <font class="keywordtype">char</font> *atype, <font class="keywordtype">char</font> *resname,
00043    <font class="keywordtype">char</font> *segname, <font class="keywordtype">int</font> *resid, <font class="keywordtype">float</font> *q, <font class="keywordtype">float</font> *m, <font class="keywordtype">int</font> charmmext) {
00044   <font class="keywordtype">char</font> inbuf[<a class="code" href="psfplugin_8c.html#a0">PSF_RECORD_LENGTH</a>+2];
00045   <font class="keywordtype">int</font> i,num;
00046 
00047   <font class="keywordflow">if</font> (inbuf != fgets(inbuf, <a class="code" href="psfplugin_8c.html#a0">PSF_RECORD_LENGTH</a>+1, f)) {
00048     <font class="keywordflow">return</font>(-1); <font class="comment">/* failed to read in an atom */</font>
00049   }
00050 
00051   <font class="keywordflow">if</font> (strlen(inbuf) &lt; 50) {
00052     fprintf(stderr, <font class="stringliteral">"Line too short in psf file: \n%s\n"</font>, inbuf);
00053     <font class="keywordflow">return</font> -1;
00054   }
00055 
00056   num = atoi(inbuf); <font class="comment">/* atom index */</font>
00057 
00058   <font class="keywordflow">if</font> (charmmext == 1) {
00059     strncpy(segname, inbuf+11, 7); 
00060     segname[7] = <font class="charliteral">'\0'</font>;
00061     strncpy(resname, inbuf+29, 7);  
00062     resname[7] = <font class="charliteral">'\0'</font>;
00063     strncpy(<a class="code" href="xsfplugin_8C.html#a2">name</a>, inbuf+38, 7);
00064     <a class="code" href="xsfplugin_8C.html#a2">name</a>[7] = <font class="charliteral">'\0'</font>;
00065     strncpy(atype, inbuf+46, 7);
00066     atype[7] = <font class="charliteral">'\0'</font>;
00067     
00068     <font class="comment">/* null terminate any extraneous spaces */</font>
00069     <font class="keywordflow">for</font> (i=7; i &gt;= 0; i--) {
00070       <font class="keywordflow">if</font> (segname[i] == <font class="charliteral">' '</font>)   
00071         segname[i] = <font class="charliteral">'\0'</font>;
00072       <font class="keywordflow">if</font> (resname[i] == <font class="charliteral">' '</font>)   
00073         resname[i] = <font class="charliteral">'\0'</font>;
00074       <font class="keywordflow">if</font> (<a class="code" href="xsfplugin_8C.html#a2">name</a>[i] == <font class="charliteral">' '</font>)      
00075         <a class="code" href="xsfplugin_8C.html#a2">name</a>[i] = <font class="charliteral">'\0'</font>;
00076       <font class="keywordflow">if</font> (atype[i] == <font class="charliteral">' '</font>)     
00077         atype[i] = <font class="charliteral">'\0'</font>;
00078     }
00079 
00080     *resid = atoi(inbuf+20);
00081     *q = (float) atof(inbuf+52);
00082     *m = (float) atof(inbuf+68);
00083   } <font class="keywordflow">else</font> {
00084     strncpy(segname, inbuf+9, 4); 
00085     segname[4] = <font class="charliteral">'\0'</font>;
00086     strncpy(resname, inbuf+19, 4);  
00087     resname[4] = <font class="charliteral">'\0'</font>;
00088     strncpy(<a class="code" href="xsfplugin_8C.html#a2">name</a>, inbuf+24, 4);  
00089     <a class="code" href="xsfplugin_8C.html#a2">name</a>[4] = <font class="charliteral">'\0'</font>;
00090     strncpy(atype, inbuf+29, 4); 
00091     atype[4] = <font class="charliteral">'\0'</font>;
00092 
00093     <font class="comment">/* null terminate any extraneous spaces */</font>
00094     <font class="keywordflow">for</font> (i=3; i &gt;= 0; i--) {
00095       <font class="keywordflow">if</font> (segname[i] == <font class="charliteral">' '</font>)   
00096         segname[i] = <font class="charliteral">'\0'</font>;
00097       <font class="keywordflow">if</font> (resname[i] == <font class="charliteral">' '</font>)   
00098         resname[i] = <font class="charliteral">'\0'</font>;
00099       <font class="keywordflow">if</font> (<a class="code" href="xsfplugin_8C.html#a2">name</a>[i] == <font class="charliteral">' '</font>)      
00100         <a class="code" href="xsfplugin_8C.html#a2">name</a>[i] = <font class="charliteral">'\0'</font>;
00101       <font class="keywordflow">if</font> (atype[i] == <font class="charliteral">' '</font>)     
00102         atype[i] = <font class="charliteral">'\0'</font>;
00103     }
00104 
00105     *resid = atoi(inbuf+13);
00106     *q = (float) atof(inbuf+34);
00107     *m = (float) atof(inbuf+50);
00108   }
00109 
00110 <font class="preprocessor">#if 0</font>
00111 <font class="preprocessor"></font>  <font class="comment">/* if this is a Charmm31 PSF file, there may be two extra */</font>
00112   <font class="comment">/* columns containing polarizable force field data.       */</font>
00113   <font class="keywordflow">if</font> (psf-&gt;charmmcheq) {
00114     <font class="comment">/* do something to read in these columns here */</font>
00115   }
00116 <font class="preprocessor">#endif</font>
00117 <font class="preprocessor"></font>
00118   <font class="keywordflow">return</font> num;
00119 }
00120 
00121 <font class="comment">/* Read in the beginning of the bond information, but don't read in the</font>
00122 <font class="comment">   bonds.  Returns the number of bonds in molecule.  If error, returns (-1). */</font>
<a name="l00123"></a><a class="code" href="psfplugin_8c.html#a3">00123</a> <font class="keyword">static</font> <font class="keywordtype">int</font> <a class="code" href="psfplugin_8c.html#a3">start_psf_bonds</a>(FILE *f) {
00124   <font class="keywordtype">char</font> inbuf[<a class="code" href="psfplugin_8c.html#a0">PSF_RECORD_LENGTH</a>+2];
00125   <font class="keywordtype">int</font> nbond = -1;
00126 
00127   <font class="comment">/* keep reading the next line until a line with NBOND appears */</font>
00128   <font class="keywordflow">do</font> {
00129     <font class="keywordflow">if</font> (inbuf != fgets(inbuf, <a class="code" href="psfplugin_8c.html#a0">PSF_RECORD_LENGTH</a>+1, f)) {
00130       <font class="comment">/* EOF encountered with no NBOND line found ==&gt; error, return (-1) */</font>
00131       <font class="keywordflow">return</font> (-1);
00132     }
00133     <font class="keywordflow">if</font> (strlen(inbuf) &gt; 0 &amp;&amp; strstr(inbuf,<font class="stringliteral">"NBOND"</font>))
00134       nbond = atoi(inbuf);
00135   } <font class="keywordflow">while</font> (nbond == -1);
00136 
00137   <font class="keywordflow">return</font> nbond;
00138 }
00139 
00140 
00141 <font class="comment">/* Read in the bond info into the given integer arrays, one for 'from' and</font>
00142 <font class="comment">   one for 'to' atoms; remember that .psf files use 1-based indices,</font>
00143 <font class="comment">   not 0-based.  Returns 1 if all nbond bonds found; 0 otherwise.  */</font>
<a name="l00144"></a><a class="code" href="psfplugin_8c.html#a4">00144</a> <font class="keyword">static</font> <font class="keywordtype">int</font> <a class="code" href="psfplugin_8c.html#a4">get_psf_bonds</a>(FILE *f, <font class="keywordtype">int</font> nbond, <font class="keywordtype">int</font> fromAtom[], <font class="keywordtype">int</font> toAtom[], <font class="keywordtype">int</font> charmmext) {
00145   <font class="keywordtype">char</font> *bondptr=NULL;
00146   <font class="keywordtype">char</font> inbuf[<a class="code" href="psfplugin_8c.html#a0">PSF_RECORD_LENGTH</a>+2];
00147   <font class="keywordtype">int</font> i=0;
00148   size_t minlinesize;
00149 
00150   <font class="keywordflow">while</font> (i &lt; nbond) {
00151     <font class="keywordflow">if</font> ((i % 4) == 0) {
00152       <font class="comment">/* must read next line */</font>
00153       <font class="keywordflow">if</font> (!fgets(inbuf, <a class="code" href="psfplugin_8c.html#a0">PSF_RECORD_LENGTH</a>+2, f)) {
00154         <font class="comment">/* early EOF encountered */</font>
00155         <font class="keywordflow">break</font>;
00156       }
00157       <font class="comment">/* Check that there is enough space in the line we are about to read */</font>
00158       <font class="keywordflow">if</font> (nbond-i &gt;= 4) {
00159         <font class="keywordflow">if</font>(charmmext == 1) minlinesize = 20*4 ; <font class="keywordflow">else</font> minlinesize = 16*4;
00160       } <font class="keywordflow">else</font> {
00161         <font class="keywordflow">if</font>(charmmext == 1) minlinesize = 20*(nbond-i); <font class="keywordflow">else</font> minlinesize = 16*(nbond-i);
00162       }
00163       <font class="keywordflow">if</font> (strlen(inbuf) &lt; minlinesize) {
00164         fprintf(stderr, <font class="stringliteral">"Bonds line too short in psf file: \n%s\n"</font>, inbuf);
00165         <font class="keywordflow">break</font>;
00166       }
00167       bondptr = inbuf;
00168     }
00169     <font class="keywordflow">if</font> ((fromAtom[i] = atoi(bondptr)) &lt; 1)
00170       <font class="keywordflow">break</font>;
00171     <font class="keywordflow">if</font>(charmmext == 1) bondptr += 10; <font class="keywordflow">else</font> bondptr += 8;
00172     <font class="keywordflow">if</font> ((toAtom[i] = atoi(bondptr)) &lt; 1)
00173       <font class="keywordflow">break</font>;
00174     <font class="keywordflow">if</font>(charmmext == 1) bondptr += 10; <font class="keywordflow">else</font> bondptr += 8;
00175     i++;
00176   }
00177 
00178   <font class="keywordflow">return</font> (i == nbond);
00179 }
00180 
00181 <font class="comment">/*</font>
00182 <font class="comment"> * API functions</font>
00183 <font class="comment"> */</font>
00184 
<a name="l00185"></a><a class="code" href="psfplugin_8c.html#a5">00185</a> <font class="keyword">static</font> <font class="keywordtype">void</font> *<a class="code" href="psfplugin_8c.html#a5">open_psf_read</a>(<font class="keyword">const</font> <font class="keywordtype">char</font> *path, <font class="keyword">const</font> <font class="keywordtype">char</font> *filetype, 
00186     <font class="keywordtype">int</font> *natoms) {
00187   FILE *fp;
00188   <font class="keywordtype">char</font> inbuf[<a class="code" href="psfplugin_8c.html#a0">PSF_RECORD_LENGTH</a>*8+2];
00189   <a class="code" href="structpsfdata.html">psfdata</a> *psf;
00190   
00191   <font class="comment">/* Open the .psf file and skip past the remarks to the first data section.</font>
00192 <font class="comment">   * Returns the file pointer, or NULL if error.  Also puts the number of</font>
00193 <font class="comment">   * atoms in the molecule into the given integer.  </font>
00194 <font class="comment">   */</font>
00195   <font class="keywordflow">if</font> (!path)
00196     <font class="keywordflow">return</font> NULL;
00197 
00198   <font class="keywordflow">if</font> ((fp = fopen(path, <font class="stringliteral">"r"</font>)) == NULL) {
00199     fprintf(stderr, <font class="stringliteral">"Couldn't open psf file %s\n"</font>, path);
00200     <font class="keywordflow">return</font> NULL;
00201   }
00202 
00203   *natoms = <a class="code" href="molfile__plugin_8h.html#a7">MOLFILE_NUMATOMS_NONE</a>; <font class="comment">/* initialize to none */</font>
00204 
00205   psf = (<a class="code" href="structpsfdata.html">psfdata</a> *) malloc(<font class="keyword">sizeof</font>(<a class="code" href="structpsfdata.html">psfdata</a>));
00206   memset(psf, 0, <font class="keyword">sizeof</font>(<a class="code" href="structpsfdata.html">psfdata</a>));
00207   psf-&gt;<a class="code" href="structpsfdata.html#m0">fp</a> = fp;
00208   psf-&gt;<a class="code" href="structpsfdata.html#m2">charmmfmt</a> = 0; <font class="comment">/* off unless we discover otherwise */</font>
00209   psf-&gt;<a class="code" href="structpsfdata.html#m5">charmmext</a> = 0; <font class="comment">/* off unless we discover otherwise */</font>
00210 
00211   <font class="comment">/* read lines until a line with NATOM and without REMARKS appears    */</font>
00212   <font class="keywordflow">do</font> {
00213     <font class="comment">/* be prepared for long lines from CNS remarks */</font>
00214     <font class="keywordflow">if</font> (inbuf != fgets(inbuf, <a class="code" href="psfplugin_8c.html#a0">PSF_RECORD_LENGTH</a>*8+1, fp)) {
00215       <font class="comment">/* EOF encountered with no NATOM line found ==&gt; error, return null */</font>
00216       *natoms = <a class="code" href="molfile__plugin_8h.html#a7">MOLFILE_NUMATOMS_NONE</a>;
00217       fclose(fp);
00218       free(psf);
00219       <font class="keywordflow">return</font> NULL;
00220     }
00221 
00222     <font class="keywordflow">if</font> (strlen(inbuf) &gt; 0) {
00223       <font class="keywordflow">if</font> (!strstr(inbuf, <font class="stringliteral">"REMARKS"</font>)) {
00224         <font class="keywordflow">if</font> (strstr(inbuf, <font class="stringliteral">"PSF"</font>)) {
00225           <font class="keywordflow">if</font> (strstr(inbuf, <font class="stringliteral">"EXT"</font>)) {
00226             psf-&gt;<a class="code" href="structpsfdata.html#m2">charmmfmt</a> = 1; 
00227             psf-&gt;<a class="code" href="structpsfdata.html#m5">charmmext</a> = 1;      
00228           }
00229           <font class="keywordflow">if</font> (strstr(inbuf, <font class="stringliteral">"CHEQ"</font>)) {
00230             psf-&gt;<a class="code" href="structpsfdata.html#m2">charmmfmt</a> = 1; 
00231             psf-&gt;<a class="code" href="structpsfdata.html#m4">charmmcheq</a> = 1;      
00232           }
00233           <font class="keywordflow">if</font> (strstr(inbuf, <font class="stringliteral">"CMAP"</font>)) {
00234             psf-&gt;<a class="code" href="structpsfdata.html#m2">charmmfmt</a> = 1; 
00235             psf-&gt;<a class="code" href="structpsfdata.html#m3">charmmcmap</a> = 1;      
00236           }
00237         } <font class="keywordflow">else</font> <font class="keywordflow">if</font> (strstr(inbuf, <font class="stringliteral">"NATOM"</font>)) {
00238           *natoms = atoi(inbuf);
00239         }
00240       } 
00241     }
00242   } <font class="keywordflow">while</font> (*natoms == <a class="code" href="molfile__plugin_8h.html#a7">MOLFILE_NUMATOMS_NONE</a>);
00243 
00244   <font class="keywordflow">if</font> (psf-&gt;<a class="code" href="structpsfdata.html#m4">charmmcheq</a> || psf-&gt;<a class="code" href="structpsfdata.html#m3">charmmcmap</a>) {
00245     printf(<font class="stringliteral">"psfplugin) Detected a Charmm31 PSF file\n"</font>);
00246   }
00247   <font class="keywordflow">if</font> (psf-&gt;<a class="code" href="structpsfdata.html#m5">charmmext</a>) {
00248     printf(<font class="stringliteral">"psfplugin) Detected a Charmm31 PSF EXTEnded file\n"</font>);
00249   }
00250 
00251   psf-&gt;<a class="code" href="structpsfdata.html#m1">numatoms</a> = *natoms;
00252 
00253   <font class="keywordflow">return</font> psf;
00254 }
00255 
<a name="l00256"></a><a class="code" href="psfplugin_8c.html#a6">00256</a> <font class="keyword">static</font> <font class="keywordtype">int</font> <a class="code" href="psfplugin_8c.html#a6">read_psf</a>(<font class="keywordtype">void</font> *v, <font class="keywordtype">int</font> *optflags, <a class="code" href="structmolfile__atom__t.html">molfile_atom_t</a> *atoms) {
00257   <a class="code" href="structpsfdata.html">psfdata</a> *psf = (<a class="code" href="structpsfdata.html">psfdata</a> *)v;
00258   <font class="keywordtype">int</font> i;
00259   
00260   <font class="comment">/* we read in the optional mass and charge data */</font>
00261   *optflags = <a class="code" href="molfile__plugin_8h.html#a12">MOLFILE_MASS</a> | <a class="code" href="molfile__plugin_8h.html#a13">MOLFILE_CHARGE</a>;
00262 
00263   <font class="keywordflow">for</font> (i=0; i&lt;psf-&gt;<a class="code" href="structpsfdata.html#m1">numatoms</a>; i++) {
00264     <a class="code" href="structmolfile__atom__t.html">molfile_atom_t</a> *atom = atoms+i; 
00265     <font class="keywordflow">if</font> (<a class="code" href="psfplugin_8c.html#a2">get_psf_atom</a>(psf-&gt;<a class="code" href="structpsfdata.html#m0">fp</a>, atom-&gt;<a class="code" href="structmolfile__atom__t.html#m0">name</a>, atom-&gt;<a class="code" href="structmolfile__atom__t.html#m1">type</a>, 
00266                      atom-&gt;<a class="code" href="structmolfile__atom__t.html#m2">resname</a>, atom-&gt;<a class="code" href="structmolfile__atom__t.html#m4">segid</a>, 
00267                      &amp;atom-&gt;<a class="code" href="structmolfile__atom__t.html#m3">resid</a>, &amp;atom-&gt;<a class="code" href="structmolfile__atom__t.html#m11">charge</a>, &amp;atom-&gt;<a class="code" href="structmolfile__atom__t.html#m10">mass</a>, psf-&gt;<a class="code" href="structpsfdata.html#m5">charmmext</a>) &lt; 0) {
00268       fprintf(stderr, <font class="stringliteral">"couldn't read atom %d\n"</font>, i);
00269       fclose(psf-&gt;<a class="code" href="structpsfdata.html#m0">fp</a>);
00270       psf-&gt;<a class="code" href="structpsfdata.html#m0">fp</a> = NULL;
00271       <font class="keywordflow">return</font> <a class="code" href="molfile__plugin_8h.html#a4">MOLFILE_ERROR</a>;
00272     }
00273     atom-&gt;<a class="code" href="structmolfile__atom__t.html#m5">chain</a>[0] = atom-&gt;<a class="code" href="structmolfile__atom__t.html#m4">segid</a>[0];
00274     atom-&gt;<a class="code" href="structmolfile__atom__t.html#m5">chain</a>[1] = <font class="charliteral">'\0'</font>;
00275   }
00276 
00277   <font class="keywordflow">return</font> <a class="code" href="molfile__plugin_8h.html#a2">MOLFILE_SUCCESS</a>;
00278 }
00279 
<a name="l00280"></a><a class="code" href="psfplugin_8c.html#a7">00280</a> <font class="keyword">static</font> <font class="keywordtype">int</font> <a class="code" href="xbgfplugin_8C.html#a11">read_bonds</a>(<font class="keywordtype">void</font> *v, <font class="keywordtype">int</font> *nbonds, <font class="keywordtype">int</font> **fromptr, <font class="keywordtype">int</font> **toptr, <font class="keywordtype">float</font> **bondorder) {
00281   <a class="code" href="structpsfdata.html">psfdata</a> *psf = (<a class="code" href="structpsfdata.html">psfdata</a> *)v;
00282 
00283   <font class="comment">/* now read bond data */</font>
00284   *nbonds = <a class="code" href="psfplugin_8c.html#a3">start_psf_bonds</a>(psf-&gt;<a class="code" href="structpsfdata.html#m0">fp</a>);
00285 
00286   <font class="keywordflow">if</font> (*nbonds &gt; 0) {
00287     psf-&gt;<a class="code" href="structpsfdata.html#m7">from</a> = (<font class="keywordtype">int</font> *) malloc(*nbonds*<font class="keyword">sizeof</font>(<font class="keywordtype">int</font>));
00288     psf-&gt;<a class="code" href="structpsfdata.html#m8">to</a> = (<font class="keywordtype">int</font> *) malloc(*nbonds*<font class="keyword">sizeof</font>(<font class="keywordtype">int</font>));
00289 
00290     <font class="keywordflow">if</font> (!<a class="code" href="psfplugin_8c.html#a4">get_psf_bonds</a>(psf-&gt;<a class="code" href="structpsfdata.html#m0">fp</a>, *nbonds, psf-&gt;<a class="code" href="structpsfdata.html#m7">from</a>, psf-&gt;<a class="code" href="structpsfdata.html#m8">to</a>, psf-&gt;<a class="code" href="structpsfdata.html#m5">charmmext</a>)) {
00291       fclose(psf-&gt;<a class="code" href="structpsfdata.html#m0">fp</a>);
00292       psf-&gt;<a class="code" href="structpsfdata.html#m0">fp</a> = NULL;
00293       <font class="keywordflow">return</font> <a class="code" href="molfile__plugin_8h.html#a4">MOLFILE_ERROR</a>;
00294     }
00295     *fromptr = psf-&gt;<a class="code" href="structpsfdata.html#m7">from</a>;
00296     *toptr = psf-&gt;<a class="code" href="structpsfdata.html#m8">to</a>;
00297     *bondorder = NULL; <font class="comment">/* PSF files don't provide bond order information */</font>
00298   } <font class="keywordflow">else</font> {
00299     printf(<font class="stringliteral">"psfplugin) WARNING: no bonds defined in PSF file.\n"</font>);
00300   }
00301 
00302   <font class="keywordflow">return</font> <a class="code" href="molfile__plugin_8h.html#a2">MOLFILE_SUCCESS</a>;
00303 }
00304 
00305 
<a name="l00306"></a><a class="code" href="psfplugin_8c.html#a8">00306</a> <font class="keyword">static</font> <font class="keywordtype">void</font> <a class="code" href="psfplugin_8c.html#a8">close_psf_read</a>(<font class="keywordtype">void</font> *mydata) {
00307   <a class="code" href="structpsfdata.html">psfdata</a> *psf = (<a class="code" href="structpsfdata.html">psfdata</a> *)mydata;
00308   <font class="keywordflow">if</font> (psf) {
00309     <font class="keywordflow">if</font> (psf-&gt;<a class="code" href="structpsfdata.html#m0">fp</a> != NULL) 
00310       fclose(psf-&gt;<a class="code" href="structpsfdata.html#m0">fp</a>);
00311     <font class="keywordflow">if</font> (psf-&gt;<a class="code" href="structpsfdata.html#m7">from</a> != NULL) 
00312       free(psf-&gt;<a class="code" href="structpsfdata.html#m7">from</a>);
00313     <font class="keywordflow">if</font> (psf-&gt;<a class="code" href="structpsfdata.html#m8">to</a> != NULL) 
00314       free(psf-&gt;<a class="code" href="structpsfdata.html#m8">to</a>);
00315     free(psf);
00316   }
00317 }  
00318 
00319 
<a name="l00320"></a><a class="code" href="psfplugin_8c.html#a9">00320</a> <font class="keyword">static</font> <font class="keywordtype">void</font> *<a class="code" href="psfplugin_8c.html#a9">open_psf_write</a>(<font class="keyword">const</font> <font class="keywordtype">char</font> *path, <font class="keyword">const</font> <font class="keywordtype">char</font> *filetype,
00321     <font class="keywordtype">int</font> natoms) {
00322   FILE *fp;
00323   <a class="code" href="structpsfdata.html">psfdata</a> *psf;
00324 
00325   fp = fopen(path, <font class="stringliteral">"w"</font>);
00326   <font class="keywordflow">if</font> (!fp) {
00327     fprintf(stderr, <font class="stringliteral">"Unable to open file %s for writing\n"</font>, path);
00328     <font class="keywordflow">return</font> NULL;
00329   }
00330   psf = (<a class="code" href="structpsfdata.html">psfdata</a> *) malloc(<font class="keyword">sizeof</font>(<a class="code" href="structpsfdata.html">psfdata</a>));
00331   psf-&gt;<a class="code" href="structpsfdata.html#m0">fp</a> = fp; 
00332   psf-&gt;<a class="code" href="structpsfdata.html#m1">numatoms</a> = natoms;
00333   psf-&gt;<a class="code" href="structpsfdata.html#m2">charmmfmt</a> = 0; <font class="comment">/* initialize to off for now */</font>
00334   psf-&gt;<a class="code" href="structpsfdata.html#m6">nbonds</a> = 0;
00335   psf-&gt;<a class="code" href="structpsfdata.html#m8">to</a> = NULL;
00336   psf-&gt;<a class="code" href="structpsfdata.html#m7">from</a> = NULL;
00337 
00338   <font class="keywordflow">return</font> psf;
00339 }
00340 
<a name="l00341"></a><a class="code" href="psfplugin_8c.html#a10">00341</a> <font class="keyword">static</font> <font class="keywordtype">int</font> <a class="code" href="psfplugin_8c.html#a10">write_psf_structure</a>(<font class="keywordtype">void</font> *v, <font class="keywordtype">int</font> optflags,
00342     <font class="keyword">const</font> <a class="code" href="structmolfile__atom__t.html">molfile_atom_t</a> *atoms) {
00343   <a class="code" href="structpsfdata.html">psfdata</a> *psf = (<a class="code" href="structpsfdata.html">psfdata</a> *)v;
00344   <font class="keyword">const</font> <a class="code" href="structmolfile__atom__t.html">molfile_atom_t</a> *atom;
00345   <font class="keywordtype">int</font> i;
00346 
00347   printf(<font class="stringliteral">"psfplugin) WARNING: PSF file is incomplete, no angles, dihedrals,\n"</font>);
00348   printf(<font class="stringliteral">"psfplugin)          or impropers will be written. \n"</font>);
00349 
00350   fprintf(psf-&gt;<a class="code" href="structpsfdata.html#m0">fp</a>, <font class="stringliteral">"PSF\n\n%8d !NTITLE\n"</font>, 1);
00351 
00352   <font class="keywordflow">if</font> (psf-&gt;<a class="code" href="structpsfdata.html#m2">charmmfmt</a>) {
00353     fprintf(psf-&gt;<a class="code" href="structpsfdata.html#m0">fp</a>,<font class="stringliteral">" REMARKS %s\n"</font>,<font class="stringliteral">"VMD generated structure charmm psf file"</font>);
00354 
00355     printf(<font class="stringliteral">"psfplugin) WARNING: Charmm format PSF file is incomplete, atom type ID\n"</font>);
00356     printf(<font class="stringliteral">"psfplugin)          codes have been emitted as '0'. \n"</font>);
00357   } <font class="keywordflow">else</font> {
00358     fprintf(psf-&gt;<a class="code" href="structpsfdata.html#m0">fp</a>,<font class="stringliteral">" REMARKS %s\n"</font>,<font class="stringliteral">"VMD generated structure x-plor psf file"</font>);
00359   }
00360   fprintf(psf-&gt;<a class="code" href="structpsfdata.html#m0">fp</a>, <font class="stringliteral">"\n"</font>);
00361 
00362   <font class="comment">/* write out total number of atoms */</font>
00363   fprintf(psf-&gt;<a class="code" href="structpsfdata.html#m0">fp</a>, <font class="stringliteral">"%8d !NATOM\n"</font>, psf-&gt;<a class="code" href="structpsfdata.html#m1">numatoms</a>);
00364 
00365   <font class="comment">/* write out all of the atom records */</font>
00366   <font class="keywordflow">for</font> (i=0; i&lt;psf-&gt;<a class="code" href="structpsfdata.html#m1">numatoms</a>; i++) {
00367     <font class="keyword">const</font> <font class="keywordtype">char</font> *atomname; 
00368     atom = &amp;atoms[i];
00369     atomname = atom-&gt;<a class="code" href="structmolfile__atom__t.html#m0">name</a>;
00370 
00371     <font class="comment">/* skip any leading space characters given to us by VMD */</font> 
00372     <font class="keywordflow">while</font> (*atomname == <font class="charliteral">' '</font>)
00373       atomname++;
00374 
00375     <font class="keywordflow">if</font> (psf-&gt;<a class="code" href="structpsfdata.html#m2">charmmfmt</a>) {
00376       <font class="comment">/* XXX replace hard-coded 0 with proper atom type ID code */</font>
00377       fprintf(psf-&gt;<a class="code" href="structpsfdata.html#m0">fp</a>, <font class="stringliteral">"%8d %-4s %-4d %-4s %-4s %4d %10.6f     %9.4f  %10d\n"</font>,
00378               i+1, atom-&gt;<a class="code" href="structmolfile__atom__t.html#m4">segid</a>, atom-&gt;<a class="code" href="structmolfile__atom__t.html#m3">resid</a>, atom-&gt;<a class="code" href="structmolfile__atom__t.html#m2">resname</a>,
00379               atomname, <font class="comment">/* atom-&gt;typeid */</font> 0, atom-&gt;<a class="code" href="structmolfile__atom__t.html#m11">charge</a>, atom-&gt;<a class="code" href="structmolfile__atom__t.html#m10">mass</a>, 0);
00380     } <font class="keywordflow">else</font> {
00381       fprintf(psf-&gt;<a class="code" href="structpsfdata.html#m0">fp</a>, <font class="stringliteral">"%8d %-4s %-4d %-4s %-4s %-4s %10.6f     %9.4f  %10d\n"</font>,
00382               i+1, atom-&gt;<a class="code" href="structmolfile__atom__t.html#m4">segid</a>, atom-&gt;<a class="code" href="structmolfile__atom__t.html#m3">resid</a>, atom-&gt;<a class="code" href="structmolfile__atom__t.html#m2">resname</a>,
00383               atomname, atom-&gt;<a class="code" href="structmolfile__atom__t.html#m1">type</a>, atom-&gt;<a class="code" href="structmolfile__atom__t.html#m11">charge</a>, atom-&gt;<a class="code" href="structmolfile__atom__t.html#m10">mass</a>, 0);
00384     }
00385   } 
00386   fprintf(psf-&gt;<a class="code" href="structpsfdata.html#m0">fp</a>, <font class="stringliteral">"\n"</font>);
00387 
00388   <font class="comment">/* write out bonds if we have bond information */</font>
00389   <font class="keywordflow">if</font> (psf-&gt;<a class="code" href="structpsfdata.html#m6">nbonds</a> &gt; 0 &amp;&amp; psf-&gt;<a class="code" href="structpsfdata.html#m7">from</a> != NULL &amp;&amp; psf-&gt;<a class="code" href="structpsfdata.html#m8">to</a> != NULL) {
00390     fprintf(psf-&gt;<a class="code" href="structpsfdata.html#m0">fp</a>, <font class="stringliteral">"%8d !NBOND: bonds\n"</font>, psf-&gt;<a class="code" href="structpsfdata.html#m6">nbonds</a>);
00391     <font class="keywordflow">for</font> (i=0; i&lt;psf-&gt;<a class="code" href="structpsfdata.html#m6">nbonds</a>; i++) {
00392       fprintf(psf-&gt;<a class="code" href="structpsfdata.html#m0">fp</a>, <font class="stringliteral">"%8d%8d"</font>, psf-&gt;<a class="code" href="structpsfdata.html#m7">from</a>[i], psf-&gt;<a class="code" href="structpsfdata.html#m8">to</a>[i]);
00393       <font class="keywordflow">if</font> ((i % 4) == 3) 
00394         fprintf(psf-&gt;<a class="code" href="structpsfdata.html#m0">fp</a>, <font class="stringliteral">"\n"</font>);
00395     }
00396     <font class="keywordflow">if</font> ((i % 4) != 0) 
00397       fprintf(psf-&gt;<a class="code" href="structpsfdata.html#m0">fp</a>, <font class="stringliteral">"\n"</font>);
00398     fprintf(psf-&gt;<a class="code" href="structpsfdata.html#m0">fp</a>, <font class="stringliteral">"\n"</font>);
00399   } <font class="keywordflow">else</font> {
00400     fprintf(psf-&gt;<a class="code" href="structpsfdata.html#m0">fp</a>, <font class="stringliteral">"%8d !NBOND: bonds\n"</font>, 0);
00401     fprintf(psf-&gt;<a class="code" href="structpsfdata.html#m0">fp</a>, <font class="stringliteral">"\n\n"</font>);
00402   }
00403 
00404   fprintf(psf-&gt;<a class="code" href="structpsfdata.html#m0">fp</a>, <font class="stringliteral">"%8d !NTHETA: angles\n"</font>, 0);
00405   <font class="comment">/* XXX put in code to emit angles here */</font>
00406   fprintf(psf-&gt;<a class="code" href="structpsfdata.html#m0">fp</a>, <font class="stringliteral">"\n\n"</font>);
00407 
00408   fprintf(psf-&gt;<a class="code" href="structpsfdata.html#m0">fp</a>, <font class="stringliteral">"%8d !NPHI: dihedrals\n"</font>, 0);
00409   <font class="comment">/* XXX put in code to emit dihedrals here */</font>
00410   fprintf(psf-&gt;<a class="code" href="structpsfdata.html#m0">fp</a>, <font class="stringliteral">"\n\n"</font>);
00411 
00412   fprintf(psf-&gt;<a class="code" href="structpsfdata.html#m0">fp</a>, <font class="stringliteral">"%8d !NIMPHI: impropers\n"</font>, 0);
00413   <font class="comment">/* XXX put in code to emit impropers here */</font>
00414   fprintf(psf-&gt;<a class="code" href="structpsfdata.html#m0">fp</a>, <font class="stringliteral">"\n\n"</font>);
00415 
00416   fprintf(psf-&gt;<a class="code" href="structpsfdata.html#m0">fp</a>, <font class="stringliteral">"%8d !NDON: donors\n"</font>, 0);
00417   fprintf(psf-&gt;<a class="code" href="structpsfdata.html#m0">fp</a>, <font class="stringliteral">"\n\n"</font>);
00418 
00419   fprintf(psf-&gt;<a class="code" href="structpsfdata.html#m0">fp</a>, <font class="stringliteral">"%8d !NACC: acceptors\n"</font>, 0);
00420   fprintf(psf-&gt;<a class="code" href="structpsfdata.html#m0">fp</a>, <font class="stringliteral">"\n\n"</font>);
00421 
00422   fprintf(psf-&gt;<a class="code" href="structpsfdata.html#m0">fp</a>, <font class="stringliteral">"%8d !NNB\n\n"</font>, 0);
00423   <font class="comment">/* Pad with zeros, one for every atom */</font>
00424   {
00425     <font class="keywordtype">int</font> i, fullrows;
00426     fullrows = psf-&gt;<a class="code" href="structpsfdata.html#m1">numatoms</a>/8;
00427     <font class="keywordflow">for</font> (i=0; i&lt;fullrows; ++i)
00428       fprintf(psf-&gt;<a class="code" href="structpsfdata.html#m0">fp</a>, <font class="stringliteral">"%8d%8d%8d%8d%8d%8d%8d%8d\n"</font>, 0, 0, 0, 0, 0, 0, 0, 0);
00429     <font class="keywordflow">for</font> (i=psf-&gt;<a class="code" href="structpsfdata.html#m1">numatoms</a> - fullrows*8; i; --i)
00430       fprintf(psf-&gt;<a class="code" href="structpsfdata.html#m0">fp</a>, <font class="stringliteral">"%8d"</font>, 0);
00431   }
00432   fprintf(psf-&gt;<a class="code" href="structpsfdata.html#m0">fp</a>, <font class="stringliteral">"\n\n"</font>);
00433 
00434   fprintf(psf-&gt;<a class="code" href="structpsfdata.html#m0">fp</a>, <font class="stringliteral">"%8d %7d !NGRP\n%8d%8d%8d\n"</font>, 1, 0, 0, 0, 0);
00435   fprintf(psf-&gt;<a class="code" href="structpsfdata.html#m0">fp</a>, <font class="stringliteral">"\n"</font>);
00436 
00437   <font class="keywordflow">return</font> <a class="code" href="molfile__plugin_8h.html#a2">MOLFILE_SUCCESS</a>;
00438 }
00439 
<a name="l00440"></a><a class="code" href="psfplugin_8c.html#a11">00440</a> <font class="keyword">static</font> <font class="keywordtype">int</font> <a class="code" href="xbgfplugin_8C.html#a13">write_bonds</a>(<font class="keywordtype">void</font> *v, <font class="keywordtype">int</font> nbonds, <font class="keywordtype">int</font> *fromptr, <font class="keywordtype">int</font> *toptr, <font class="keywordtype">float</font> *bondorderptr) {
00441   <a class="code" href="structpsfdata.html">psfdata</a> *psf = (<a class="code" href="structpsfdata.html">psfdata</a> *)v;
00442   <font class="keywordtype">int</font> i;
00443 
00444   <font class="comment">/* save bond info until we actually write out the structure file */</font>
00445   psf-&gt;<a class="code" href="structpsfdata.html#m6">nbonds</a> = nbonds;
00446   psf-&gt;<a class="code" href="structpsfdata.html#m7">from</a> = (<font class="keywordtype">int</font> *) malloc(nbonds * <font class="keyword">sizeof</font>(<font class="keywordtype">int</font>));
00447   memcpy(psf-&gt;<a class="code" href="structpsfdata.html#m7">from</a>, fromptr, nbonds * <font class="keyword">sizeof</font>(<font class="keywordtype">int</font>));
00448   psf-&gt;<a class="code" href="structpsfdata.html#m8">to</a> = (<font class="keywordtype">int</font> *) malloc(nbonds * <font class="keyword">sizeof</font>(<font class="keywordtype">int</font>));
00449   memcpy(psf-&gt;<a class="code" href="structpsfdata.html#m8">to</a>, toptr, nbonds * <font class="keyword">sizeof</font>(<font class="keywordtype">int</font>));
00450 
00451   <font class="keywordflow">return</font> <a class="code" href="molfile__plugin_8h.html#a2">MOLFILE_SUCCESS</a>;
00452 }
00453 
<a name="l00454"></a><a class="code" href="psfplugin_8c.html#a12">00454</a> <font class="keyword">static</font> <font class="keywordtype">void</font> <a class="code" href="psfplugin_8c.html#a12">close_psf_write</a>(<font class="keywordtype">void</font> *v) {
00455   <a class="code" href="structpsfdata.html">psfdata</a> *psf = (<a class="code" href="structpsfdata.html">psfdata</a> *)v;
00456   fclose(psf-&gt;<a class="code" href="structpsfdata.html#m0">fp</a>);
00457 
00458   <font class="comment">/* free bonds if we have them */</font>
00459   <font class="keywordflow">if</font> (psf-&gt;<a class="code" href="structpsfdata.html#m7">from</a> != NULL) 
00460     free(psf-&gt;<a class="code" href="structpsfdata.html#m7">from</a>);
00461   <font class="keywordflow">if</font> (psf-&gt;<a class="code" href="structpsfdata.html#m8">to</a> != NULL) 
00462     free(psf-&gt;<a class="code" href="structpsfdata.html#m8">to</a>);
00463   free(psf);
00464 }
00465 
00466 
00467 <font class="comment">/*</font>
00468 <font class="comment"> * Initialization stuff down here</font>
00469 <font class="comment"> */</font>
00470 
<a name="l00471"></a><a class="code" href="psfplugin_8c.html#a1">00471</a> <font class="keyword">static</font> <a class="code" href="structmolfile__plugin__t.html">molfile_plugin_t</a> <a class="code" href="psfplugin_8c.html#a1">plugin</a> = {
00472   <a class="code" href="vmdplugin_8h.html#a10">vmdplugin_ABIVERSION</a>,              <font class="comment">/* ABI version              */</font>
00473   <a class="code" href="molfile__plugin_8h.html#a0">MOLFILE_PLUGIN_TYPE</a>,               <font class="comment">/* type                     */</font>
00474   <font class="stringliteral">"psf"</font>,                             <font class="comment">/* short name               */</font>
00475   <font class="stringliteral">"CHARMM,NAMD,XPLOR PSF"</font>,           <font class="comment">/* pretty name              */</font>
00476   <font class="stringliteral">"Justin Gullingsrud, John Stone"</font>,  <font class="comment">/* author                   */</font>
00477   0,                                 <font class="comment">/* major version            */</font>
00478   7,                                 <font class="comment">/* minor version            */</font>
00479   <a class="code" href="vmdplugin_8h.html#a12">VMDPLUGIN_THREADSAFE</a>,              <font class="comment">/* is_reentrant             */</font>
00480   <font class="stringliteral">"psf"</font>,                             <font class="comment">/* filename extension       */</font>
00481   <a class="code" href="psfplugin_8c.html#a5">open_psf_read</a>,                     <font class="comment">/* open_file_read           */</font>
00482   <a class="code" href="psfplugin_8c.html#a6">read_psf</a>,                          <font class="comment">/* read_structure           */</font>
00483   <a class="code" href="psfplugin_8c.html#a7">read_bonds</a>,                        <font class="comment">/* read bond list           */</font>
00484   0,                                 <font class="comment">/* read_next_timestep       */</font>
00485   <a class="code" href="psfplugin_8c.html#a8">close_psf_read</a>,                    <font class="comment">/* close_file_read          */</font>
00486   <a class="code" href="psfplugin_8c.html#a9">open_psf_write</a>,                    <font class="comment">/* open file for writing    */</font>
00487   <a class="code" href="psfplugin_8c.html#a10">write_psf_structure</a>,               <font class="comment">/* write structure          */</font>
00488   0,                                 <font class="comment">/* write timestep           */</font>
00489   <a class="code" href="psfplugin_8c.html#a12">close_psf_write</a>,                   <font class="comment">/* close file for writing   */</font>
00490   0,                                 <font class="comment">/* read volumetric metadata */</font>
00491   0,                                 <font class="comment">/* read volumetric data     */</font>
00492   0,                                 <font class="comment">/* read rawgraphics         */</font>
00493   0,                                 <font class="comment">/* read molecule metadata   */</font>
00494   <a class="code" href="psfplugin_8c.html#a11">write_bonds</a>                        <font class="comment">/* write bonds              */</font>
00495 };
00496 
<a name="l00497"></a><a class="code" href="psfplugin_8c.html#a13">00497</a> <a class="code" href="vmdplugin_8h.html#a7">VMDPLUGIN_API</a> <font class="keywordtype">int</font> <a class="code" href="vmdplugin_8h.html#a5">VMDPLUGIN_init</a>() {
00498   <font class="keywordflow">return</font> <a class="code" href="vmdplugin_8h.html#a13">VMDPLUGIN_SUCCESS</a>;
00499 }
00500 
<a name="l00501"></a><a class="code" href="psfplugin_8c.html#a14">00501</a> <a class="code" href="vmdplugin_8h.html#a7">VMDPLUGIN_API</a> <font class="keywordtype">int</font> <a class="code" href="vmdplugin_8h.html#a3">VMDPLUGIN_register</a>(<font class="keywordtype">void</font> *v, <a class="code" href="vmdplugin_8h.html#a15">vmdplugin_register_cb</a> cb) {
00502   (*cb)(v, (<a class="code" href="structvmdplugin__t.html">vmdplugin_t</a> *)&amp;plugin);
00503   <font class="keywordflow">return</font> <a class="code" href="vmdplugin_8h.html#a13">VMDPLUGIN_SUCCESS</a>;
00504 }
00505 
<a name="l00506"></a><a class="code" href="psfplugin_8c.html#a15">00506</a> <a class="code" href="vmdplugin_8h.html#a7">VMDPLUGIN_API</a> <font class="keywordtype">int</font> <a class="code" href="vmdplugin_8h.html#a6">VMDPLUGIN_fini</a>() {
00507   <font class="keywordflow">return</font> <a class="code" href="vmdplugin_8h.html#a13">VMDPLUGIN_SUCCESS</a>;
00508 }
</pre></div><hr><address><small>Generated on Wed Mar 22 13:15:31 2006 for VMD Plugins (current) by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.gif" alt="doxygen" align="middle" border=0 
width=110 height=53></a>1.2.14 written by <a href="mailto:dimitri@stack.nl">Dimitri van Heesch</a>,
 &copy;&nbsp;1997-2002</small></address>
</body>
</html>
