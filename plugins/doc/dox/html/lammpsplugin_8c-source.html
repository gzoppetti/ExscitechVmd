<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>lammpsplugin.c Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.2.14 -->
<center>
<a class="qindex" href="index.html">Main Page</a> &nbsp; <a class="qindex" href="classes.html">Alphabetical List</a> &nbsp; <a class="qindex" href="annotated.html">Compound List</a> &nbsp; <a class="qindex" href="files.html">File List</a> &nbsp; <a class="qindex" href="functions.html">Compound Members</a> &nbsp; <a class="qindex" href="globals.html">File Members</a> &nbsp; <a class="qindex" href="pages.html">Related Pages</a> &nbsp; </center>
<hr><h1>lammpsplugin.c</h1><a href="lammpsplugin_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 <font class="comment">/***************************************************************************</font>
00002 <font class="comment"> *cr</font>
00003 <font class="comment"> *cr            (C) Copyright 1995-2006 The Board of Trustees of the</font>
00004 <font class="comment"> *cr                        University of Illinois</font>
00005 <font class="comment"> *cr                         All Rights Reserved</font>
00006 <font class="comment"> *cr</font>
00007 <font class="comment"> ***************************************************************************/</font>
00008 
00009 <font class="comment">/***************************************************************************</font>
00010 <font class="comment"> * RCS INFORMATION:</font>
00011 <font class="comment"> *</font>
00012 <font class="comment"> *      $RCSfile: lammpsplugin.c,v $</font>
00013 <font class="comment"> *      $Author: johns $       $Locker:  $             $State: Exp $</font>
00014 <font class="comment"> *      $Revision: 1.14 $       $Date: 2006/02/23 19:36:45 $</font>
00015 <font class="comment"> *</font>
00016 <font class="comment"> ***************************************************************************/</font>
00017 
00018 <font class="comment">/*</font>
00019 <font class="comment"> *  LAMMPS dump file format:</font>
00020 <font class="comment"> *    ITEM: TIMESTEP</font>
00021 <font class="comment"> *      %d (timestep number)</font>
00022 <font class="comment"> *    ITEM: NUMBER OF ATOMS</font>
00023 <font class="comment"> *      %d (number of atoms)</font>
00024 <font class="comment"> *    ITEM: BOX BOUNDS</font>
00025 <font class="comment"> *      %f %f (alpha, a)</font>
00026 <font class="comment"> *      %f %f (beta,  b)</font>
00027 <font class="comment"> *      %f %f (gamma, c)</font>
00028 <font class="comment"> *    ITEM: ATOMS</font>
00029 <font class="comment"> *      %d %d %f %f %f  (atomid, atomtype, x, y, z)</font>
00030 <font class="comment"> *      ...</font>
00031 <font class="comment"> *</font>
00032 <font class="comment"> */</font>
00033 
00034 <font class="preprocessor">#include "<a class="code" href="largefiles_8h.html">largefiles.h</a>"</font>   <font class="comment">/* platform dependent 64-bit file I/O defines */</font>
00035 
00036 <font class="preprocessor">#include &lt;stdio.h&gt;</font>
00037 <font class="preprocessor">#include &lt;stdlib.h&gt;</font>
00038 <font class="preprocessor">#include &lt;string.h&gt;</font>
00039 <font class="preprocessor">#include &lt;ctype.h&gt;</font>
00040 <font class="preprocessor">#include &lt;math.h&gt;</font>
00041 <font class="preprocessor">#include "<a class="code" href="molfile__plugin_8h.html">molfile_plugin.h</a>"</font>
00042 
00043 <font class="preprocessor">#ifndef M_PI_2</font>
<a name="l00044"></a><a class="code" href="lammpsplugin_8c.html#a0">00044</a> <font class="preprocessor"></font><font class="preprocessor">#define M_PI_2 1.57079632679489661922</font>
00045 <font class="preprocessor"></font><font class="preprocessor">#endif</font>
00046 <font class="preprocessor"></font>
<a name="l00047"></a><a class="code" href="structlammpsdata.html">00047</a> <font class="keyword">typedef</font> <font class="keyword">struct </font>{
<a name="l00048"></a><a class="code" href="structlammpsdata.html#m0">00048</a>   FILE *file;
00049   <font class="keywordtype">int</font> numatoms;
<a name="l00050"></a><a class="code" href="structlammpsdata.html#m2">00050</a>   <font class="keywordtype">char</font> *file_name;
<a name="l00051"></a><a class="code" href="structlammpsdata.html#m3">00051</a>   <a class="code" href="structmolfile__atom__t.html">molfile_atom_t</a> *atomlist;
00052 } <a class="code" href="structlammpsdata.html">lammpsdata</a>;
00053  
<a name="l00054"></a><a class="code" href="lammpsplugin_8c.html#a2">00054</a> <font class="keyword">static</font> <font class="keywordtype">void</font> *<a class="code" href="lammpspluginA_8c.html#a4">open_lammps_read</a>(<font class="keyword">const</font> <font class="keywordtype">char</font> *filename, <font class="keyword">const</font> <font class="keywordtype">char</font> *filetype, 
00055                            <font class="keywordtype">int</font> *natoms) {
00056   FILE *fd;
00057   <a class="code" href="structlammpsdata.html">lammpsdata</a> *data;
00058   <font class="keywordtype">int</font> i;
00059 
00060   fd = fopen(filename, <font class="stringliteral">"rb"</font>);
00061   <font class="keywordflow">if</font> (!fd) <font class="keywordflow">return</font> NULL;
00062   
00063   data = (<a class="code" href="structlammpsdata.html">lammpsdata</a> *)malloc(<font class="keyword">sizeof</font>(<a class="code" href="structlammpsdata.html">lammpsdata</a>));
00064   data-&gt;<a class="code" href="structlammpsdata.html#m0">file</a> = fd;
00065   data-&gt;<a class="code" href="structlammpsdata.html#m2">file_name</a> = strdup(filename);
00066 
00067   
00068   <font class="comment">/* skip past first 3 lines */</font>
00069   <font class="keywordflow">while</font> (getc(fd) != <font class="charliteral">'\n'</font>);
00070   <font class="keywordflow">while</font> (getc(fd) != <font class="charliteral">'\n'</font>);
00071   <font class="keywordflow">while</font> (getc(fd) != <font class="charliteral">'\n'</font>);
00072   <font class="comment">/* Fourth line is the number of atoms   */</font>
00073   i = fscanf(data-&gt;<a class="code" href="structlammpsdata.html#m0">file</a>, <font class="stringliteral">"%d"</font>, natoms);
00074   <font class="keywordflow">if</font> (i &lt; 1) {
00075     fprintf(stderr, <font class="stringliteral">"\n\nread) ERROR: lammps dump file '%s' should have the number of atoms in the third line.\n"</font>, filename);
00076     <font class="keywordflow">return</font> NULL;
00077   }
00078   data-&gt;<a class="code" href="structlammpsdata.html#m1">numatoms</a>=*natoms;
00079 
00080   rewind(data-&gt;<a class="code" href="structlammpsdata.html#m0">file</a>); <font class="comment">/* prepare for first read_timestep call */</font>
00081 
00082   <font class="keywordflow">return</font> data;
00083 }
00084 
<a name="l00085"></a><a class="code" href="lammpsplugin_8c.html#a3">00085</a> <font class="keyword">static</font> <font class="keywordtype">int</font> <a class="code" href="lammpspluginA_8c.html#a6">read_lammps_timestep</a>(<font class="keywordtype">void</font> *mydata, <font class="keywordtype">int</font> natoms, <a class="code" href="structmolfile__timestep__t.html">molfile_timestep_t</a> *ts) {
00086   <font class="keywordtype">int</font> i, j;
00087   <font class="keywordtype">char</font> atom_name[1025], fbuffer[1025], *k;
00088   <font class="keywordtype">float</font> x, y, z;
00089   <font class="keywordtype">float</font> alpha, beta, gamma, a, b, c;
00090   <font class="keywordtype">int</font> atomid;
00091   
00092   <a class="code" href="structlammpsdata.html">lammpsdata</a> *data = (<a class="code" href="structlammpsdata.html">lammpsdata</a> *)mydata;
00093 
00094   <font class="comment">/* skip ITEM: TIMESTEP text */</font>
00095   <font class="keywordflow">if</font> (NULL == fgets(fbuffer, 1024, data-&gt;<a class="code" href="structlammpsdata.html#m0">file</a>))  <font class="keywordflow">return</font> <a class="code" href="molfile__plugin_8h.html#a4">MOLFILE_ERROR</a>;
00096   <font class="comment">/* skip timestep value */</font>
00097   <font class="keywordflow">if</font> (NULL == fgets(fbuffer, 1024, data-&gt;<a class="code" href="structlammpsdata.html#m0">file</a>))  <font class="keywordflow">return</font> <a class="code" href="molfile__plugin_8h.html#a4">MOLFILE_ERROR</a>;
00098   <font class="comment">/* skip ITEM: NUMBER OF ATOMS text */</font>
00099   <font class="keywordflow">if</font> (NULL == fgets(fbuffer, 1024, data-&gt;<a class="code" href="structlammpsdata.html#m0">file</a>))  <font class="keywordflow">return</font> <a class="code" href="molfile__plugin_8h.html#a4">MOLFILE_ERROR</a>;
00100   <font class="comment">/* skip atom count value */</font>
00101   <font class="keywordflow">if</font> (NULL == fgets(fbuffer, 1024, data-&gt;<a class="code" href="structlammpsdata.html#m0">file</a>))  <font class="keywordflow">return</font> <a class="code" href="molfile__plugin_8h.html#a4">MOLFILE_ERROR</a>;
00102 
00103   <font class="comment">/* read unit cell information */</font>
00104   <font class="comment">/* skip ITEM: BOX BOUNDS text */</font>
00105   <font class="keywordflow">if</font> (NULL == fgets(fbuffer, 1024, data-&gt;<a class="code" href="structlammpsdata.html#m0">file</a>))  <font class="keywordflow">return</font> <a class="code" href="molfile__plugin_8h.html#a4">MOLFILE_ERROR</a>;
00106   <font class="keywordflow">if</font> (NULL == fgets(fbuffer, 1024, data-&gt;<a class="code" href="structlammpsdata.html#m0">file</a>))  <font class="keywordflow">return</font> <a class="code" href="molfile__plugin_8h.html#a4">MOLFILE_ERROR</a>;
00107   sscanf(fbuffer, <font class="stringliteral">"%f %f"</font>, &amp;alpha, &amp;a);
00108   <font class="keywordflow">if</font> (NULL == fgets(fbuffer, 1024, data-&gt;<a class="code" href="structlammpsdata.html#m0">file</a>))  <font class="keywordflow">return</font> <a class="code" href="molfile__plugin_8h.html#a4">MOLFILE_ERROR</a>;
00109   sscanf(fbuffer, <font class="stringliteral">"%f %f"</font>, &amp;beta, &amp;b);
00110   <font class="keywordflow">if</font> (NULL == fgets(fbuffer, 1024, data-&gt;<a class="code" href="structlammpsdata.html#m0">file</a>))  <font class="keywordflow">return</font> <a class="code" href="molfile__plugin_8h.html#a4">MOLFILE_ERROR</a>;
00111   sscanf(fbuffer, <font class="stringliteral">"%f %f"</font>, &amp;gamma, &amp;c);
00112 
00113   <font class="keywordflow">if</font> (ts != NULL) {
00114     ts-&gt;<a class="code" href="structmolfile__timestep__t.html#z4_0">A</a> = a;
00115     ts-&gt;<a class="code" href="structmolfile__timestep__t.html#z4_1">B</a> = b;
00116     ts-&gt;<a class="code" href="structmolfile__timestep__t.html#z4_2">C</a> = c;
00117     ts-&gt;<a class="code" href="structmolfile__timestep__t.html#z4_3">alpha</a> = 90.0 - asin(alpha) * 90.0 / <a class="code" href="lammpsplugin_8c.html#a0">M_PI_2</a>;
00118     ts-&gt;<a class="code" href="structmolfile__timestep__t.html#z4_4">beta</a>  = 90.0 - asin(beta) * 90.0 / <a class="code" href="lammpsplugin_8c.html#a0">M_PI_2</a>;
00119     ts-&gt;<a class="code" href="structmolfile__timestep__t.html#z4_5">gamma</a> = 90.0 - asin(gamma) * 90.0 / <a class="code" href="lammpsplugin_8c.html#a0">M_PI_2</a>;
00120   }
00121 
00122   <font class="comment">/* skip ITEM: ATOMS text */</font>
00123   <font class="keywordflow">if</font> (NULL == fgets(fbuffer, 1024, data-&gt;<a class="code" href="structlammpsdata.html#m0">file</a>))  <font class="keywordflow">return</font> <a class="code" href="molfile__plugin_8h.html#a4">MOLFILE_ERROR</a>;
00124 
00125   <font class="comment">/* read the coordinates */</font>
00126   <font class="keywordflow">for</font> (i=0; i&lt;natoms; i++) {
00127     k = fgets(fbuffer, 1024, data-&gt;<a class="code" href="structlammpsdata.html#m0">file</a>);
00128 
00129     <font class="comment">/* Read in atom type, X, Y, Z, skipping any remaining data fields */</font>
00130     j = sscanf(fbuffer, <font class="stringliteral">"%d %s %f %f %f"</font>, &amp;atomid, atom_name, &amp;x, &amp;y, &amp;z);
00131     <font class="keywordflow">if</font> (k == NULL) {
00132       <font class="keywordflow">return</font> <a class="code" href="molfile__plugin_8h.html#a4">MOLFILE_ERROR</a>;
00133     } <font class="keywordflow">else</font> <font class="keywordflow">if</font> (j &lt; 5) {
00134       fprintf(stderr, <font class="stringliteral">"lammps timestep) missing type or coordinate(s) in file '%s' for atom '%d'\n"</font>,data-&gt;<a class="code" href="structlammpsdata.html#m2">file_name</a>,i+1);
00135       <font class="keywordflow">return</font> <a class="code" href="molfile__plugin_8h.html#a4">MOLFILE_ERROR</a>;
00136     } <font class="keywordflow">else</font> <font class="keywordflow">if</font> (j == 5) {
00137       <font class="comment">/* only save coords if we're given a timestep pointer, */</font>
00138       <font class="comment">/* otherwise assume that VMD wants us to skip past it. */</font>
00139       <font class="keywordflow">if</font> (ts != NULL) { 
00140         <font class="keywordflow">if</font> (atomid &gt; 0 &amp;&amp; atomid &lt;= natoms) {
00141           <font class="keywordtype">int</font> addr = 3 * (atomid - 1);
00142           <font class="comment">/* LAMMPS coordinates are fractional unit cell coords, */</font>
00143           <font class="comment">/* so they need to be scaled by a/b/c etc              */</font>
00144           ts-&gt;<a class="code" href="structmolfile__timestep__t.html#m0">coords</a>[addr    ] = x * a;
00145           ts-&gt;<a class="code" href="structmolfile__timestep__t.html#m0">coords</a>[addr + 1] = y * b;
00146           ts-&gt;<a class="code" href="structmolfile__timestep__t.html#m0">coords</a>[addr + 2] = z * c;
00147         } <font class="keywordflow">else</font> {
00148           fprintf(stderr, <font class="stringliteral">"lammps timestep) ignoring illegal atom index %d\n"</font>, atomid);
00149         }
00150       }
00151     } 
00152   }
00153   
00154   <font class="keywordflow">return</font> <a class="code" href="molfile__plugin_8h.html#a2">MOLFILE_SUCCESS</a>;
00155 }
00156     
<a name="l00157"></a><a class="code" href="lammpsplugin_8c.html#a4">00157</a> <font class="keyword">static</font> <font class="keywordtype">void</font> <a class="code" href="lammpspluginA_8c.html#a7">close_lammps_read</a>(<font class="keywordtype">void</font> *mydata) {
00158   <a class="code" href="structlammpsdata.html">lammpsdata</a> *data = (<a class="code" href="structlammpsdata.html">lammpsdata</a> *)mydata;
00159   fclose(data-&gt;<a class="code" href="structlammpsdata.html#m0">file</a>);
00160   free(data-&gt;<a class="code" href="structlammpsdata.html#m2">file_name</a>);
00161   free(data);
00162 }
00163 
00164 
00165 <font class="comment">/* registration stuff */</font>
<a name="l00166"></a><a class="code" href="lammpsplugin_8c.html#a1">00166</a> <font class="keyword">static</font> <a class="code" href="structmolfile__plugin__t.html">molfile_plugin_t</a> <a class="code" href="lammpsplugin_8c.html#a1">lammpsplugin</a> = {
00167   <a class="code" href="vmdplugin_8h.html#a10">vmdplugin_ABIVERSION</a>,
00168   <a class="code" href="molfile__plugin_8h.html#a0">MOLFILE_PLUGIN_TYPE</a>,                         <font class="comment">/* type */</font>
00169   <font class="stringliteral">"lammpstrj"</font>,                                 <font class="comment">/* short name */</font>
00170   <font class="stringliteral">"LAMMPS Trajectory"</font>,                         <font class="comment">/* pretty name */</font>
00171   <font class="stringliteral">"John E. Stone"</font>,                             <font class="comment">/* author */</font>
00172   0,                                           <font class="comment">/* major version */</font>
00173   3,                                           <font class="comment">/* minor version */</font>
00174   <a class="code" href="vmdplugin_8h.html#a12">VMDPLUGIN_THREADSAFE</a>,                        <font class="comment">/* is reentrant */</font>
00175   <font class="stringliteral">"lammpstrj"</font>,
00176   <a class="code" href="lammpsplugin_8c.html#a2">open_lammps_read</a>,
00177   0,
00178   0,
00179   <a class="code" href="lammpsplugin_8c.html#a3">read_lammps_timestep</a>,
00180   <a class="code" href="lammpsplugin_8c.html#a4">close_lammps_read</a>,
00181   0,                            <font class="comment">/* write... */</font>
00182   0,
00183   0,
00184   0,
00185   0,                            <font class="comment">/* read_volumetric_metadata */</font>
00186   0,                            <font class="comment">/* read_volumetric_data */</font>
00187   0                             <font class="comment">/* read_rawgraphics */</font>
00188 };
00189 
<a name="l00190"></a><a class="code" href="lammpsplugin_8c.html#a5">00190</a> <a class="code" href="vmdplugin_8h.html#a7">VMDPLUGIN_API</a> <font class="keywordtype">int</font> <a class="code" href="vmdplugin_8h.html#a5">VMDPLUGIN_init</a>() {
00191   <font class="keywordflow">return</font> <a class="code" href="vmdplugin_8h.html#a13">VMDPLUGIN_SUCCESS</a>;
00192 }
00193 
<a name="l00194"></a><a class="code" href="lammpsplugin_8c.html#a6">00194</a> <a class="code" href="vmdplugin_8h.html#a7">VMDPLUGIN_API</a> <font class="keywordtype">int</font> <a class="code" href="vmdplugin_8h.html#a3">VMDPLUGIN_register</a>(<font class="keywordtype">void</font> *v, <a class="code" href="vmdplugin_8h.html#a15">vmdplugin_register_cb</a> cb) {
00195   (*cb)(v, (<a class="code" href="structvmdplugin__t.html">vmdplugin_t</a> *)&amp;lammpsplugin);
00196   <font class="keywordflow">return</font> <a class="code" href="vmdplugin_8h.html#a13">VMDPLUGIN_SUCCESS</a>;
00197 }
00198 
<a name="l00199"></a><a class="code" href="lammpsplugin_8c.html#a7">00199</a> <a class="code" href="vmdplugin_8h.html#a7">VMDPLUGIN_API</a> <font class="keywordtype">int</font> <a class="code" href="vmdplugin_8h.html#a6">VMDPLUGIN_fini</a>() {
00200   <font class="keywordflow">return</font> <a class="code" href="vmdplugin_8h.html#a13">VMDPLUGIN_SUCCESS</a>;
00201 }
00202 
00203 
00204 <font class="preprocessor">#ifdef TEST_PLUGIN</font>
00205 <font class="preprocessor"></font>
00206 <font class="keywordtype">int</font> <a class="code" href="main_8c.html#a3">main</a>(<font class="keywordtype">int</font> argc, <font class="keywordtype">char</font> *argv[]) {
00207   <a class="code" href="structmolfile__timestep__t.html">molfile_timestep_t</a> timestep;
00208   <font class="keywordtype">void</font> *v;
00209   <font class="keywordtype">int</font> natoms;
00210   <font class="keywordtype">int</font> i, nsets, set;
00211 
00212   <font class="keywordflow">while</font> (--argc) {
00213     ++argv;
00214     v = <a class="code" href="lammpspluginA_8c.html#a4">open_lammps_read</a>(*argv, <font class="stringliteral">"lammps"</font>, &amp;natoms);
00215     <font class="keywordflow">if</font> (!v) {
00216       fprintf(stderr, <font class="stringliteral">"open_lammps_read failed for file %s\n"</font>, *argv);
00217       <font class="keywordflow">return</font> 1;
00218     }
00219     fprintf(stderr, <font class="stringliteral">"open_lammps_read succeeded for file %s\n"</font>, *argv);
00220     fprintf(stderr, <font class="stringliteral">"number of atoms: %d\n"</font>, natoms);
00221 
00222     i = 0;
00223     timestep.<a class="code" href="structmolfile__timestep__t.html#m0">coords</a> = (<font class="keywordtype">float</font> *)malloc(3*<font class="keyword">sizeof</font>(<font class="keywordtype">float</font>)*natoms);
00224     <font class="keywordflow">while</font> (!<a class="code" href="lammpspluginA_8c.html#a6">read_lammps_timestep</a>(v, natoms, &amp;timestep)) {
00225       i++;
00226     }
00227     fprintf(stderr, <font class="stringliteral">"ended read_next_timestep on frame %d\n"</font>, i);
00228 
00229     <a class="code" href="lammpspluginA_8c.html#a7">close_lammps_read</a>(v);
00230   }
00231   <font class="keywordflow">return</font> 0;
00232 }
00233 
00234 <font class="preprocessor">#endif</font>
00235 <font class="preprocessor"></font>
</pre></div><hr><address><small>Generated on Wed Mar 22 13:15:30 2006 for VMD Plugins (current) by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.gif" alt="doxygen" align="middle" border=0 
width=110 height=53></a>1.2.14 written by <a href="mailto:dimitri@stack.nl">Dimitri van Heesch</a>,
 &copy;&nbsp;1997-2002</small></address>
</body>
</html>
