<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>cubeplugin.C Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.2.14 -->
<center>
<a class="qindex" href="index.html">Main Page</a> &nbsp; <a class="qindex" href="classes.html">Alphabetical List</a> &nbsp; <a class="qindex" href="annotated.html">Compound List</a> &nbsp; <a class="qindex" href="files.html">File List</a> &nbsp; <a class="qindex" href="functions.html">Compound Members</a> &nbsp; <a class="qindex" href="globals.html">File Members</a> &nbsp; <a class="qindex" href="pages.html">Related Pages</a> &nbsp; </center>
<hr><h1>cubeplugin.C</h1><a href="cubeplugin_8C.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 <font class="comment">/***************************************************************************</font>
00002 <font class="comment"> *cr</font>
00003 <font class="comment"> *cr            (C) Copyright 1995-2006 The Board of Trustees of the</font>
00004 <font class="comment"> *cr                        University of Illinois</font>
00005 <font class="comment"> *cr                         All Rights Reserved</font>
00006 <font class="comment"> *cr</font>
00007 <font class="comment"> ***************************************************************************/</font>
00008 
00009 <font class="comment">/***************************************************************************</font>
00010 <font class="comment"> * RCS INFORMATION:</font>
00011 <font class="comment"> *</font>
00012 <font class="comment"> *      $RCSfile: cubeplugin.C,v $</font>
00013 <font class="comment"> *      $Author: johns $       $Locker:  $             $State: Exp $</font>
00014 <font class="comment"> *      $Revision: 1.23 $       $Date: 2006/01/05 00:05:52 $</font>
00015 <font class="comment"> *</font>
00016 <font class="comment"> ***************************************************************************/</font>
00017 
00018 <font class="comment">//</font>
00019 <font class="comment">// Plugin reader for Gaussian "cube" files</font>
00020 <font class="comment">//</font>
00021 <font class="comment">// Gaussian "cube" file format described here:</font>
00022 <font class="comment">//   http://www.gaussian.com/00000430.htm</font>
00023 <font class="comment">//</font>
00024 
00025 <font class="preprocessor">#include &lt;stdio.h&gt;</font>
00026 <font class="preprocessor">#include &lt;stdlib.h&gt;</font>
00027 <font class="preprocessor">#include &lt;math.h&gt;</font>
00028 <font class="preprocessor">#include &lt;string.h&gt;</font>
00029 
00030 <font class="preprocessor">#include "<a class="code" href="molfile__plugin_8h.html">molfile_plugin.h</a>"</font>
00031 
00032 <font class="preprocessor">#ifndef M_PI_2</font>
<a name="l00033"></a><a class="code" href="cubeplugin_8C.html#a0">00033</a> <font class="preprocessor"></font><font class="preprocessor">#define M_PI_2 1.57079632679489661922</font>
00034 <font class="preprocessor"></font><font class="preprocessor">#endif</font>
00035 <font class="preprocessor"></font>
00036 <font class="preprocessor">#include "<a class="code" href="periodic__table_8h.html">periodic_table.h</a>"</font>
00037 
<a name="l00038"></a><a class="code" href="cubeplugin_8C.html#a1">00038</a> <font class="keyword">static</font> <font class="keyword">const</font> <font class="keywordtype">float</font> <a class="code" href="cubeplugin_8C.html#a1">bohr</a> = 0.529177249;
00039 
00040 <font class="comment">// A format-independent structure to hold unit cell data</font>
<a name="l00041"></a><a class="code" href="structcube__box.html">00041</a> <font class="keyword">typedef</font> <font class="keyword">struct </font>{
<a name="l00042"></a><a class="code" href="structcube__box.html#m5">00042</a>   <font class="keywordtype">float</font> A, B, C, alpha, beta, gamma;
00043 } <a class="code" href="structcube__box.html">cube_box</a>;
00044 
<a name="l00045"></a><a class="code" href="structcube__t.html">00045</a> <font class="keyword">typedef</font> <font class="keyword">struct </font>{
<a name="l00046"></a><a class="code" href="structcube__t.html#m0">00046</a>   FILE *fd;              <font class="comment">// file descriptor</font>
<a name="l00047"></a><a class="code" href="structcube__t.html#m1">00047</a>   <font class="keywordtype">int</font> nsets;             <font class="comment">// number of volume datasets</font>
<a name="l00048"></a><a class="code" href="structcube__t.html#m2">00048</a>   <font class="keywordtype">int</font> numatoms;          <font class="comment">// number of atoms</font>
<a name="l00049"></a><a class="code" href="structcube__t.html#m3">00049</a>   <font class="keywordtype">bool</font> coord;            <font class="comment">// has coordinate data</font>
<a name="l00050"></a><a class="code" href="structcube__t.html#m5">00050</a>   <font class="keywordtype">long</font> crdpos, datapos;  <font class="comment">// seek offsets for coords and data</font>
<a name="l00051"></a><a class="code" href="structcube__t.html#m6">00051</a>   <font class="keywordtype">char</font> *file_name;       <font class="comment">// original filename </font>
<a name="l00052"></a><a class="code" href="structcube__t.html#m7">00052</a>   <font class="keywordtype">float</font> *datacache;      <font class="comment">// temporary cache of orbital data prior to conversion</font>
<a name="l00053"></a><a class="code" href="structcube__t.html#m8">00053</a>   <a class="code" href="structmolfile__volumetric__t.html">molfile_volumetric_t</a> *vol; <font class="comment">// volume data</font>
<a name="l00054"></a><a class="code" href="structcube__t.html#m9">00054</a>   <font class="keywordtype">float</font> origin[3];       <font class="comment">// origin, stored for periodic display hack </font>
<a name="l00055"></a><a class="code" href="structcube__t.html#m10">00055</a>   <font class="keywordtype">float</font> rotmat[3][3];    <font class="comment">// rotation matrix, stored for periodic display hack</font>
<a name="l00056"></a><a class="code" href="structcube__t.html#m11">00056</a>   <a class="code" href="structcube__box.html">cube_box</a> box;          <font class="comment">// unit cell dimensions</font>
00057 } <a class="code" href="structcube__t.html">cube_t</a>;
00058 
00059 <font class="comment">// Converts box basis vectors to A, B, C, alpha, beta, and gamma.  </font>
00060 <font class="comment">// Stores values in cube_box struct, which should be allocated before calling</font>
00061 <font class="comment">// this function.</font>
<a name="l00062"></a><a class="code" href="cubeplugin_8C.html#a3">00062</a> <font class="keyword">static</font> <font class="keywordtype">int</font> <a class="code" href="cubeplugin_8C.html#a3">cube_readbox</a>(<a class="code" href="structcube__box.html">cube_box</a> *box, <font class="keywordtype">float</font> *x, <font class="keywordtype">float</font> *y, <font class="keywordtype">float</font> *z) {
00063   <font class="keywordtype">float</font> A, B, C;
00064 
00065   <font class="keywordflow">if</font> (!box) {
00066     <font class="keywordflow">return</font> 1;
00067   }
00068 
00069   <font class="comment">// provide defaults</font>
00070   box-&gt;<a class="code" href="structcube__box.html#m0">A</a> = 10.0;
00071   box-&gt;<a class="code" href="structcube__box.html#m1">B</a> = 10.0;
00072   box-&gt;<a class="code" href="structcube__box.html#m2">C</a> = 10.0;
00073   box-&gt;<a class="code" href="structcube__box.html#m3">alpha</a> = 90.0;
00074   box-&gt;<a class="code" href="structcube__box.html#m4">beta</a>  = 90.0;
00075   box-&gt;<a class="code" href="structcube__box.html#m5">gamma</a> = 90.0;
00076 
00077   <font class="comment">// A, B, C are the lengths of the x, y, z vectors, respectively</font>
00078   A = sqrt( x[0]*x[0] + x[1]*x[1] + x[2]*x[2] );
00079   B = sqrt( y[0]*y[0] + y[1]*y[1] + y[2]*y[2] );
00080   C = sqrt( z[0]*z[0] + z[1]*z[1] + z[2]*z[2] );
00081   <font class="keywordflow">if</font> ((A&lt;=0) || (B&lt;=0) || (C&lt;=0)) {
00082     <font class="keywordflow">return</font> 1;
00083   }
00084   box-&gt;<a class="code" href="structcube__box.html#m0">A</a> = A;
00085   box-&gt;<a class="code" href="structcube__box.html#m1">B</a> = B;
00086   box-&gt;<a class="code" href="structcube__box.html#m2">C</a> = C;
00087 
00088   <font class="comment">// gamma, beta, alpha are the angles between the x &amp; y, x &amp; z, y &amp; z</font>
00089   <font class="comment">// vectors, respectively</font>
00090   box-&gt;<a class="code" href="structcube__box.html#m5">gamma</a> = acos( (x[0]*y[0]+x[1]*y[1]+x[2]*y[2])/(A*B) ) * 90.0/<a class="code" href="cubeplugin_8C.html#a0">M_PI_2</a>;
00091   box-&gt;<a class="code" href="structcube__box.html#m4">beta</a> = acos( (x[0]*z[0]+x[1]*z[1]+x[2]*z[2])/(A*C) ) * 90.0/<a class="code" href="cubeplugin_8C.html#a0">M_PI_2</a>;
00092   box-&gt;<a class="code" href="structcube__box.html#m3">alpha</a> = acos( (y[0]*z[0]+y[1]*z[1]+y[2]*z[2])/(B*C) ) * 90.0/<a class="code" href="cubeplugin_8C.html#a0">M_PI_2</a>; 
00093 
00094   <font class="keywordflow">return</font> 0;
00095 }
00096 
00097 <font class="comment">// calculate and store origin and rotation matrix to realign everything later.</font>
<a name="l00098"></a><a class="code" href="cubeplugin_8C.html#a4">00098</a> <font class="keyword">static</font> <font class="keywordtype">void</font> <a class="code" href="cubeplugin_8C.html#a4">cube_buildrotmat</a>(<a class="code" href="structcube__t.html">cube_t</a> *cube, <font class="keywordtype">float</font> *o, <font class="keywordtype">float</font> *a, <font class="keywordtype">float</font> *b)
00099 {
00100   <font class="comment">// we rotate first around y and z to align a along the x-axis...</font>
00101   <font class="keyword">const</font> <font class="keywordtype">double</font> len   = sqrt(a[0]*a[0] + a[1]*a[1]);
00102   <font class="keyword">const</font> <font class="keywordtype">double</font> phi   = atan2((<font class="keywordtype">double</font>) a[2], (<font class="keywordtype">double</font>) len);
00103   <font class="keyword">const</font> <font class="keywordtype">double</font> theta = atan2((<font class="keywordtype">double</font>) a[1], (<font class="keywordtype">double</font>) a[0]);
00104 
00105   <font class="keyword">const</font> <font class="keywordtype">double</font> cph = cos(phi);
00106   <font class="keyword">const</font> <font class="keywordtype">double</font> cth = cos(theta);
00107   <font class="keyword">const</font> <font class="keywordtype">double</font> sph = sin(phi);
00108   <font class="keyword">const</font> <font class="keywordtype">double</font> sth = sin(theta);
00109 
00110   <font class="comment">// ...then we rotate around x to put b into the xy-plane.</font>
00111   <font class="keyword">const</font> <font class="keywordtype">double</font> psi = atan2(-sph*cth*b[0] - sph*sth*b[1] + cph*b[2],-sth*b[0] + cth*b[1]);
00112   <font class="keyword">const</font> <font class="keywordtype">double</font> cps = cos(psi);
00113   <font class="keyword">const</font> <font class="keywordtype">double</font> sps = sin(psi);
00114 
00115   <font class="keyword">const</font> <font class="keywordtype">double</font> r[3][3] = { 
00116     {               cph*cth,                    cph*sth,      sph},
00117     {-sth*cps - sph*cth*sps,      cth*cps - sph*sth*sps,  cph*sps},
00118     { sth*sps - sph*cth*cps,     -cth*sps - sph*sth*cps,  cph*cps}
00119   };
00120 
00121   <font class="keywordflow">for</font> (<font class="keywordtype">int</font> i=0; i&lt;3; ++i) {
00122     cube-&gt;<a class="code" href="structcube__t.html#m9">origin</a>[i] = o[i];
00123     <font class="keywordflow">for</font> (<font class="keywordtype">int</font> j=0; j&lt;3; ++j) {
00124       cube-&gt;<a class="code" href="structcube__t.html#m10">rotmat</a>[i][j] = r[i][j];
00125     }
00126   }
00127 }
00128 
00129 
<a name="l00130"></a><a class="code" href="cubeplugin_8C.html#a5">00130</a> <font class="keyword">static</font> <font class="keywordtype">void</font> <a class="code" href="xsfplugin_8C.html#a36">eatline</a>(FILE * fd) {
00131   <font class="keywordtype">char</font> readbuf[1025];
00132   fgets(readbuf, 1024, fd);    <font class="comment">// go on to next line</font>
00133 }  
00134 
00135 <font class="comment">// prototype.</font>
00136 <font class="keyword">static</font> <font class="keywordtype">void</font> <a class="code" href="cubeplugin_8C.html#a6">close_cube_read</a>(<font class="keywordtype">void</font> *v);
00137 
<a name="l00138"></a><a class="code" href="cubeplugin_8C.html#a7">00138</a> <font class="keyword">static</font> <font class="keywordtype">void</font> *<a class="code" href="cubeplugin_8C.html#a7">open_cube_read</a>(<font class="keyword">const</font> <font class="keywordtype">char</font> *filepath, <font class="keyword">const</font> <font class="keywordtype">char</font> *filetype,
00139     <font class="keywordtype">int</font> *natoms) {
00140   FILE *fd;
00141   <a class="code" href="structcube__t.html">cube_t</a> *cube;
00142   <font class="keywordtype">int</font> xsize, ysize, zsize;
00143   <font class="keywordtype">float</font> a[3], b[3], c[3];
00144   <font class="keywordtype">int</font> i;
00145  
00146   fd = fopen(filepath, <font class="stringliteral">"rb"</font>);
00147   <font class="keywordflow">if</font> (!fd) 
00148     <font class="keywordflow">return</font> NULL;
00149 
00150   cube = <font class="keyword">new</font> <a class="code" href="structcube__t.html">cube_t</a>;
00151   cube-&gt;<a class="code" href="structcube__t.html#m0">fd</a> = fd;
00152   cube-&gt;<a class="code" href="structcube__t.html#m8">vol</a> = NULL;
00153   cube-&gt;<a class="code" href="structcube__t.html#m3">coord</a> = <font class="keyword">false</font>;
00154   cube-&gt;<a class="code" href="structcube__t.html#m6">file_name</a> = strdup(filepath);
00155   cube-&gt;<a class="code" href="structcube__t.html#m7">datacache</a> = NULL;
00156 
00157   <font class="comment">// initialize origin and rotmat to sensible defaults.</font>
00158   <font class="keywordflow">for</font> (i=0; i&lt;3; ++i) {
00159       <font class="keywordflow">for</font> (<font class="keywordtype">int</font> j=0; j&lt;3; ++j) {
00160           cube-&gt;<a class="code" href="structcube__t.html#m10">rotmat</a>[i][j] = 0.0;
00161       }
00162   }
00163   <font class="keywordflow">for</font> (i=0; i&lt;3; ++i) {
00164       cube-&gt;<a class="code" href="structcube__t.html#m9">origin</a>[i] = 0.0;
00165       cube-&gt;<a class="code" href="structcube__t.html#m10">rotmat</a>[i][i] = 1.0;
00166   }
00167 
00168   <a class="code" href="structmolfile__volumetric__t.html">molfile_volumetric_t</a> voltmpl; <font class="comment">// base information for all data sets.</font>
00169 
00170   <font class="comment">// read in cube file header information</font>
00171   <font class="keywordtype">char</font> readbuf[256]; 
00172   fgets(readbuf, 256, cube-&gt;<a class="code" href="structcube__t.html#m0">fd</a>);    <font class="comment">// go on to next line</font>
00173 
00174   <font class="comment">// identify this file, and read title string into dataset info</font>
00175   strcpy(voltmpl.<a class="code" href="structmolfile__volumetric__t.html#m0">dataname</a>, <font class="stringliteral">"Gaussian Cube: "</font>);
00176   strncat(voltmpl.<a class="code" href="structmolfile__volumetric__t.html#m0">dataname</a>, readbuf, 240);      <font class="comment">// 240 is max space left after</font>
00177                                                 <font class="comment">//   "Gaussian Cube: "</font>
00178   <a class="code" href="xsfplugin_8C.html#a36">eatline</a>(cube-&gt;<a class="code" href="structcube__t.html#m0">fd</a>);          <font class="comment">// skip second header line </font>
00179 
00180   <font class="comment">// read in number of atoms</font>
00181   <font class="keywordflow">if</font> (fscanf(cube-&gt;<a class="code" href="structcube__t.html#m0">fd</a>, <font class="stringliteral">"%d"</font>, &amp;cube-&gt;<a class="code" href="structcube__t.html#m2">numatoms</a>) != 1) {
00182     <a class="code" href="cubeplugin_8C.html#a6">close_cube_read</a>(cube);
00183     <font class="keywordflow">return</font> NULL;
00184   }
00185 
00186   <font class="keywordflow">if</font> (cube-&gt;<a class="code" href="structcube__t.html#m2">numatoms</a> &gt; 0) {   <font class="comment">// density cube file</font>
00187     cube-&gt;<a class="code" href="structcube__t.html#m1">nsets</a> = 1;          <font class="comment">// this cube file contains only one data set</font>
00188   } <font class="keywordflow">else</font> {
00189     <font class="comment">// cube file with orbitals =&gt; multiple densities.</font>
00190     cube-&gt;<a class="code" href="structcube__t.html#m2">numatoms</a> = - cube-&gt;<a class="code" href="structcube__t.html#m2">numatoms</a>;
00191     cube-&gt;<a class="code" href="structcube__t.html#m1">nsets</a> = 0;          <font class="comment">// we don't know yet how many data sets.</font>
00192   }
00193   *natoms = cube-&gt;<a class="code" href="structcube__t.html#m2">numatoms</a>;
00194 
00195   <font class="comment">// read in cube origin</font>
00196   <font class="keywordflow">if</font> ( fscanf(cube-&gt;<a class="code" href="structcube__t.html#m0">fd</a>, <font class="stringliteral">"%f %f %f"</font>, 
00197          &amp;voltmpl.<a class="code" href="structmolfile__volumetric__t.html#m1">origin</a>[0], 
00198          &amp;voltmpl.<a class="code" href="structmolfile__volumetric__t.html#m1">origin</a>[1], 
00199          &amp;voltmpl.<a class="code" href="structmolfile__volumetric__t.html#m1">origin</a>[2]) != 3 ) {
00200     <a class="code" href="cubeplugin_8C.html#a6">close_cube_read</a>(cube);
00201     <font class="keywordflow">return</font> NULL;
00202   }
00203 
00204   <font class="comment">// read in cube axes and sizes</font>
00205   <font class="keywordflow">if</font> ((fscanf(cube-&gt;<a class="code" href="structcube__t.html#m0">fd</a>, <font class="stringliteral">"%d"</font>, &amp;xsize) != 1) ||
00206       (fscanf(cube-&gt;<a class="code" href="structcube__t.html#m0">fd</a>, <font class="stringliteral">"%f %f %f"</font>, &amp;a[0], &amp;a[1], &amp;a[2]) != 3)) {
00207     <a class="code" href="cubeplugin_8C.html#a6">close_cube_read</a>(cube);
00208     <font class="keywordflow">return</font> NULL;
00209   }
00210 
00211   <font class="keywordflow">if</font> ((fscanf(cube-&gt;<a class="code" href="structcube__t.html#m0">fd</a>, <font class="stringliteral">"%d"</font>, &amp;ysize) != 1) ||
00212       (fscanf(cube-&gt;<a class="code" href="structcube__t.html#m0">fd</a>, <font class="stringliteral">"%f %f %f"</font>, &amp;b[0], &amp;b[1], &amp;b[2]) != 3)) {
00213     <a class="code" href="cubeplugin_8C.html#a6">close_cube_read</a>(cube);
00214     <font class="keywordflow">return</font> NULL;
00215   }
00216 
00217   <font class="keywordflow">if</font> ((fscanf(cube-&gt;<a class="code" href="structcube__t.html#m0">fd</a>, <font class="stringliteral">"%d"</font>, &amp;zsize) != 1) ||
00218       (fscanf(cube-&gt;<a class="code" href="structcube__t.html#m0">fd</a>, <font class="stringliteral">"%f %f %f"</font>, &amp;c[0], &amp;c[1], &amp;c[2]) != 3)) {
00219     <a class="code" href="cubeplugin_8C.html#a6">close_cube_read</a>(cube);
00220     <font class="keywordflow">return</font> NULL;
00221   }
00222 
00223   <font class="comment">// calculate number of samples in each dimension</font>
00224   voltmpl.<a class="code" href="structmolfile__volumetric__t.html#m5">xsize</a> = xsize;
00225   voltmpl.<a class="code" href="structmolfile__volumetric__t.html#m6">ysize</a> = ysize;
00226   voltmpl.<a class="code" href="structmolfile__volumetric__t.html#m7">zsize</a> = zsize;
00227   voltmpl.<a class="code" href="structmolfile__volumetric__t.html#m8">has_color</a> = 0;
00228 
00229   <a class="code" href="xsfplugin_8C.html#a36">eatline</a>(cube-&gt;<a class="code" href="structcube__t.html#m0">fd</a>);     <font class="comment">// skip remaining end of line characters</font>
00230 
00231   <font class="comment">// to make the periodic display work, we need to rotate</font>
00232   <font class="comment">// the cellvectors (and the coordinates) in such a way,</font>
00233   <font class="comment">// that the a-vector is collinear with the x-axis and</font>
00234   <font class="comment">// the b-vector is in the xy-plane. </font>
00235   <a class="code" href="cubeplugin_8C.html#a4">cube_buildrotmat</a>(cube, voltmpl.<a class="code" href="structmolfile__volumetric__t.html#m1">origin</a>, a, b);
00236   <font class="comment">// print warning, if the rotation will be significant:</font>
00237   <font class="keywordflow">if</font> ((fabs((<font class="keywordtype">double</font>) a[1]) + fabs((<font class="keywordtype">double</font>) a[2]) + fabs((<font class="keywordtype">double</font>) b[2]))
00238       &gt; 0.001) {
00239     fprintf(stderr, <font class="stringliteral">"cubeplugin) WARNING: Coordinates will be rotated to comply \n"</font>
00240             <font class="stringliteral">"cubeplugin) with VMD's conventions for periodic display...\n"</font>);
00241   }
00242   
00243 
00244   <font class="comment">// all dimensional units are always in Bohr</font>
00245   <font class="comment">// so scale axes and origin correctly.</font>
00246   <font class="comment">// NOTE: the angstroms are only allowed in input.</font>
00247   voltmpl.<a class="code" href="structmolfile__volumetric__t.html#m1">origin</a>[0] *= <a class="code" href="cubeplugin_8C.html#a1">bohr</a>; 
00248   voltmpl.<a class="code" href="structmolfile__volumetric__t.html#m1">origin</a>[1] *= <a class="code" href="cubeplugin_8C.html#a1">bohr</a>;
00249   voltmpl.<a class="code" href="structmolfile__volumetric__t.html#m1">origin</a>[2] *= <a class="code" href="cubeplugin_8C.html#a1">bohr</a>;
00250 
00251   <font class="comment">// store aligned axes.</font>
00252   <font class="keywordflow">for</font> (i=0; i&lt;3; ++i) {
00253     voltmpl.<a class="code" href="structmolfile__volumetric__t.html#m2">xaxis</a>[i] = cube-&gt;<a class="code" href="structcube__t.html#m10">rotmat</a>[i][0] * a[0] 
00254       + cube-&gt;<a class="code" href="structcube__t.html#m10">rotmat</a>[i][1] * a[1] + cube-&gt;<a class="code" href="structcube__t.html#m10">rotmat</a>[i][2] * a[2];
00255 
00256     voltmpl.<a class="code" href="structmolfile__volumetric__t.html#m3">yaxis</a>[i] = cube-&gt;<a class="code" href="structcube__t.html#m10">rotmat</a>[i][0] * b[0] 
00257       + cube-&gt;<a class="code" href="structcube__t.html#m10">rotmat</a>[i][1] * b[1] + cube-&gt;<a class="code" href="structcube__t.html#m10">rotmat</a>[i][2] * b[2];
00258     
00259     voltmpl.<a class="code" href="structmolfile__volumetric__t.html#m4">zaxis</a>[i] = cube-&gt;<a class="code" href="structcube__t.html#m10">rotmat</a>[i][0] * c[0] 
00260       + cube-&gt;<a class="code" href="structcube__t.html#m10">rotmat</a>[i][1] * c[1] + cube-&gt;<a class="code" href="structcube__t.html#m10">rotmat</a>[i][2] * c[2];
00261   }
00262 
00263   voltmpl.<a class="code" href="structmolfile__volumetric__t.html#m2">xaxis</a>[0] *= <a class="code" href="cubeplugin_8C.html#a1">bohr</a> * xsize;
00264   voltmpl.<a class="code" href="structmolfile__volumetric__t.html#m2">xaxis</a>[1] *= <a class="code" href="cubeplugin_8C.html#a1">bohr</a> * xsize; 
00265   voltmpl.<a class="code" href="structmolfile__volumetric__t.html#m2">xaxis</a>[2] *= <a class="code" href="cubeplugin_8C.html#a1">bohr</a> * xsize; 
00266 
00267   voltmpl.<a class="code" href="structmolfile__volumetric__t.html#m3">yaxis</a>[0] *= <a class="code" href="cubeplugin_8C.html#a1">bohr</a> * ysize; 
00268   voltmpl.<a class="code" href="structmolfile__volumetric__t.html#m3">yaxis</a>[1] *= <a class="code" href="cubeplugin_8C.html#a1">bohr</a> * ysize; 
00269   voltmpl.<a class="code" href="structmolfile__volumetric__t.html#m3">yaxis</a>[2] *= <a class="code" href="cubeplugin_8C.html#a1">bohr</a> * ysize; 
00270 
00271   voltmpl.<a class="code" href="structmolfile__volumetric__t.html#m4">zaxis</a>[0] *= <a class="code" href="cubeplugin_8C.html#a1">bohr</a> * zsize; 
00272   voltmpl.<a class="code" href="structmolfile__volumetric__t.html#m4">zaxis</a>[1] *= <a class="code" href="cubeplugin_8C.html#a1">bohr</a> * zsize; 
00273   voltmpl.<a class="code" href="structmolfile__volumetric__t.html#m4">zaxis</a>[2] *= <a class="code" href="cubeplugin_8C.html#a1">bohr</a> * zsize; 
00274 
00275 <font class="preprocessor">#if 1</font>
00276 <font class="preprocessor"></font>  <font class="comment">/*   As of VMD version 1.8.3, volumetric data points are </font>
00277 <font class="comment">   *   expected to represent the center of a grid box. cube format </font>
00278 <font class="comment">   *   volumetric data represents the value at the edges of the </font>
00279 <font class="comment">   *   grid boxes, so we need to shift the internal origin by half</font>
00280 <font class="comment">   *   a grid box diagonal to have the data at the correct position.</font>
00281 <font class="comment">   *   This will need to be changed again when the plugin interface </font>
00282 <font class="comment">   *   is updated to explicitly allow point/face-centered data sets.</font>
00283 <font class="comment">   */</font>
00284   voltmpl.<a class="code" href="structmolfile__volumetric__t.html#m1">origin</a>[0] -= 0.5 * ( voltmpl.<a class="code" href="structmolfile__volumetric__t.html#m2">xaxis</a>[0] / (double) xsize
00285                         + voltmpl.<a class="code" href="structmolfile__volumetric__t.html#m3">yaxis</a>[0] / (double) ysize
00286                         + voltmpl.<a class="code" href="structmolfile__volumetric__t.html#m4">zaxis</a>[0] / (double) zsize);
00287   voltmpl.<a class="code" href="structmolfile__volumetric__t.html#m1">origin</a>[1] -= 0.5 * ( voltmpl.<a class="code" href="structmolfile__volumetric__t.html#m2">xaxis</a>[1] / (double) xsize
00288                         + voltmpl.<a class="code" href="structmolfile__volumetric__t.html#m3">yaxis</a>[1] / (double) ysize
00289                         + voltmpl.<a class="code" href="structmolfile__volumetric__t.html#m4">zaxis</a>[1] / (double) zsize);
00290   voltmpl.<a class="code" href="structmolfile__volumetric__t.html#m1">origin</a>[2] -= 0.5 * ( voltmpl.<a class="code" href="structmolfile__volumetric__t.html#m2">xaxis</a>[2] / (double) xsize
00291                         + voltmpl.<a class="code" href="structmolfile__volumetric__t.html#m3">yaxis</a>[2] / (double) ysize
00292                         + voltmpl.<a class="code" href="structmolfile__volumetric__t.html#m4">zaxis</a>[2] / (double) zsize);
00293 <font class="preprocessor">#endif</font>
00294 <font class="preprocessor"></font>
00295 <font class="preprocessor">#if defined(TEST_PLUGIN)</font>
00296 <font class="preprocessor"></font>  printf(<font class="stringliteral">"cell before rotation:\n"</font>);
00297   printf(<font class="stringliteral">"a: %12.8f %12.8f %12.8f\n"</font>, a[0]*xsize*<a class="code" href="cubeplugin_8C.html#a1">bohr</a>, a[1]*ysize*<a class="code" href="cubeplugin_8C.html#a1">bohr</a>, a[2]*zsize*<a class="code" href="cubeplugin_8C.html#a1">bohr</a>);
00298   printf(<font class="stringliteral">"b: %12.8f %12.8f %12.8f\n"</font>, b[0]*xsize*<a class="code" href="cubeplugin_8C.html#a1">bohr</a>, b[1]*ysize*<a class="code" href="cubeplugin_8C.html#a1">bohr</a>, b[2]*zsize*<a class="code" href="cubeplugin_8C.html#a1">bohr</a>);
00299   printf(<font class="stringliteral">"c: %12.8f %12.8f %12.8f\n"</font>, c[0]*xsize*<a class="code" href="cubeplugin_8C.html#a1">bohr</a>, c[1]*ysize*<a class="code" href="cubeplugin_8C.html#a1">bohr</a>, c[2]*zsize*<a class="code" href="cubeplugin_8C.html#a1">bohr</a>);
00300 
00301   printf(<font class="stringliteral">"cell after rotation:\n"</font>);
00302   printf(<font class="stringliteral">"x: %12.8f %12.8f %12.8f\n"</font>, voltmpl.<a class="code" href="structmolfile__volumetric__t.html#m2">xaxis</a>[0], voltmpl.<a class="code" href="structmolfile__volumetric__t.html#m2">xaxis</a>[1], voltmpl.<a class="code" href="structmolfile__volumetric__t.html#m2">xaxis</a>[2]);
00303   printf(<font class="stringliteral">"y: %12.8f %12.8f %12.8f\n"</font>, voltmpl.<a class="code" href="structmolfile__volumetric__t.html#m3">yaxis</a>[0], voltmpl.<a class="code" href="structmolfile__volumetric__t.html#m3">yaxis</a>[1], voltmpl.<a class="code" href="structmolfile__volumetric__t.html#m3">yaxis</a>[2]);
00304   printf(<font class="stringliteral">"z: %12.8f %12.8f %12.8f\n"</font>, voltmpl.<a class="code" href="structmolfile__volumetric__t.html#m4">zaxis</a>[0], voltmpl.<a class="code" href="structmolfile__volumetric__t.html#m4">zaxis</a>[1], voltmpl.<a class="code" href="structmolfile__volumetric__t.html#m4">zaxis</a>[2]);
00305 <font class="preprocessor">#endif</font>
00306 <font class="preprocessor"></font>
00307   <font class="comment">// store the unit cell information for later perusal.</font>
00308   <font class="keywordflow">if</font> (<a class="code" href="cubeplugin_8C.html#a3">cube_readbox</a>(&amp;(cube-&gt;<a class="code" href="structcube__t.html#m11">box</a>), voltmpl.<a class="code" href="structmolfile__volumetric__t.html#m2">xaxis</a>, voltmpl.<a class="code" href="structmolfile__volumetric__t.html#m3">yaxis</a>, voltmpl.<a class="code" href="structmolfile__volumetric__t.html#m4">zaxis</a>)) {
00309           fprintf(stderr, <font class="stringliteral">"cubeplugin) Calculation of unit cell size failed. Trying to continue...\n"</font>);
00310   }
00311 
00312   cube-&gt;<a class="code" href="structcube__t.html#m4">crdpos</a> = ftell(cube-&gt;<a class="code" href="structcube__t.html#m0">fd</a>); <font class="comment">// and record beginning of coordinates</font>
00313   <font class="comment">// XXX fseek()/ftell() are incompatible with 64-bit LFS I/O implementations, </font>
00314   <font class="comment">// hope we don't read any files &gt;= 2GB...</font>
00315 
00316   <font class="keywordflow">if</font> (cube-&gt;<a class="code" href="structcube__t.html#m1">nsets</a> &gt;0) { 
00317     <font class="keywordtype">int</font> i;
00318 
00319     <font class="comment">// density cube file, copy voltmpl into the cube struct.</font>
00320     cube-&gt;<a class="code" href="structcube__t.html#m8">vol</a> = <font class="keyword">new</font> <a class="code" href="structmolfile__volumetric__t.html">molfile_volumetric_t</a>[1];
00321     memcpy(cube-&gt;<a class="code" href="structcube__t.html#m8">vol</a>, &amp;voltmpl, <font class="keyword">sizeof</font>(voltmpl));
00322 
00323     <font class="comment">// skip over coordinates to find the start of volumetric data</font>
00324     <font class="keywordflow">for</font> (i=0; i &lt; cube-&gt;<a class="code" href="structcube__t.html#m2">numatoms</a>; i++) {
00325       <a class="code" href="xsfplugin_8C.html#a36">eatline</a>(cube-&gt;<a class="code" href="structcube__t.html#m0">fd</a>);
00326     }
00327 
00328     cube-&gt;<a class="code" href="structcube__t.html#m5">datapos</a> = ftell(cube-&gt;<a class="code" href="structcube__t.html#m0">fd</a>); <font class="comment">// and record beginning of data</font>
00329     <font class="comment">// XXX fseek()/ftell() are incompatible with 64-bit LFS I/O, </font>
00330     <font class="comment">// hope we don't read any files &gt;= 2GB...</font>
00331   } <font class="keywordflow">else</font> {              
00332     <font class="keywordtype">int</font> i;
00333 
00334     <font class="comment">// orbital cube file. we now have to read the orbitals section</font>
00335     <font class="comment">// skip over coordinates</font>
00336     <font class="keywordflow">for</font> (i=0; i &lt; cube-&gt;<a class="code" href="structcube__t.html#m2">numatoms</a>; i++) {
00337       <a class="code" href="xsfplugin_8C.html#a36">eatline</a>(cube-&gt;<a class="code" href="structcube__t.html#m0">fd</a>);
00338     }
00339       
00340     fscanf(cube-&gt;<a class="code" href="structcube__t.html#m0">fd</a>, <font class="stringliteral">"%d"</font>, &amp;cube-&gt;<a class="code" href="structcube__t.html#m1">nsets</a>);
00341     fprintf(stderr, <font class="stringliteral">"\ncubeplugin) found %d orbitals\n"</font>, cube-&gt;<a class="code" href="structcube__t.html#m1">nsets</a>);
00342     cube-&gt;<a class="code" href="structcube__t.html#m8">vol</a> = <font class="keyword">new</font> <a class="code" href="structmolfile__volumetric__t.html">molfile_volumetric_t</a>[cube-&gt;<a class="code" href="structcube__t.html#m1">nsets</a>];
00343     <font class="keywordflow">for</font> (i=0; i &lt; cube-&gt;<a class="code" href="structcube__t.html#m1">nsets</a>; ++i) {
00344       <font class="keywordtype">int</font> orb;
00345       fscanf(cube-&gt;<a class="code" href="structcube__t.html#m0">fd</a>, <font class="stringliteral">"%d"</font>, &amp;orb);
00346       memcpy(&amp;cube-&gt;<a class="code" href="structcube__t.html#m8">vol</a>[i], &amp;voltmpl, <font class="keyword">sizeof</font>(voltmpl));
00347       sprintf(cube-&gt;<a class="code" href="structcube__t.html#m8">vol</a>[i].<a class="code" href="structmolfile__volumetric__t.html#m0">dataname</a>, <font class="stringliteral">"Gaussian Cube: Orbital %d"</font>, orb);
00348     }
00349       
00350     <a class="code" href="xsfplugin_8C.html#a36">eatline</a>(cube-&gt;<a class="code" href="structcube__t.html#m0">fd</a>);        <font class="comment">// gobble up rest of line</font>
00351     cube-&gt;<a class="code" href="structcube__t.html#m5">datapos</a> = ftell(cube-&gt;<a class="code" href="structcube__t.html#m0">fd</a>); <font class="comment">// and record beginning of data</font>
00352     <font class="comment">// XXX fseek()/ftell() are incompatible with 64-bit LFS I/O, </font>
00353     <font class="comment">// hope we don't read any files &gt;= 2GB...</font>
00354   }
00355 
00356   <font class="keywordflow">return</font> cube;
00357 }
00358 
00359   
<a name="l00360"></a><a class="code" href="cubeplugin_8C.html#a8">00360</a> <font class="keyword">static</font> <font class="keywordtype">int</font> <a class="code" href="cubeplugin_8C.html#a8">read_cube_structure</a>(<font class="keywordtype">void</font> *v, <font class="keywordtype">int</font> *optflags, <a class="code" href="structmolfile__atom__t.html">molfile_atom_t</a> *atoms) {
00361   <font class="keywordtype">int</font> i, j;
00362   <font class="keywordtype">char</font> *k;
00363   <a class="code" href="structmolfile__atom__t.html">molfile_atom_t</a> *atom;
00364 
00365   <a class="code" href="structcube__t.html">cube_t</a> *cube = (<a class="code" href="structcube__t.html">cube_t</a> *)v;
00366 
00367   <font class="comment">// go to coordinates</font>
00368   fseek(cube-&gt;<a class="code" href="structcube__t.html#m0">fd</a>, cube-&gt;<a class="code" href="structcube__t.html#m4">crdpos</a>, SEEK_SET);
00369   <font class="comment">// XXX fseek()/ftell() are incompatible with 64-bit LFS I/O implementations, </font>
00370   <font class="comment">// hope we don't read any files &gt;= 2GB...</font>
00371 
00372   <font class="comment">/* set mass and radius from PTE. */</font>
00373   *optflags = <a class="code" href="molfile__plugin_8h.html#a16">MOLFILE_ATOMICNUMBER</a> | <a class="code" href="molfile__plugin_8h.html#a12">MOLFILE_MASS</a> | <a class="code" href="molfile__plugin_8h.html#a14">MOLFILE_RADIUS</a>; 
00374 
00375   <font class="keywordflow">for</font>(i=0;i&lt;cube-&gt;<a class="code" href="structcube__t.html#m2">numatoms</a>;i++) {
00376     <font class="keywordtype">int</font> idx;
00377     <font class="keywordtype">float</font> chrg, coord;
00378     <font class="keywordtype">char</font> fbuffer[1024];
00379 
00380     atom = atoms + i;
00381 
00382     k = fgets(fbuffer, 1024, cube-&gt;<a class="code" href="structcube__t.html#m0">fd</a>);
00383     j=sscanf(fbuffer, <font class="stringliteral">"%d %f %f %f %f"</font>, &amp;idx, &amp;chrg, &amp;coord, &amp;coord, &amp;coord);
00384     <font class="keywordflow">if</font> (k == NULL) {
00385       fprintf(stderr, <font class="stringliteral">"cube structure) missing atom(s) in "</font>
00386               <font class="stringliteral">"file '%s'\n"</font>,cube-&gt;<a class="code" href="structcube__t.html#m6">file_name</a>);
00387       fprintf(stderr, <font class="stringliteral">"cube structure) expecting '%d' atoms,"</font>
00388               <font class="stringliteral">" found only '%d'\n"</font>,cube-&gt;<a class="code" href="structcube__t.html#m2">numatoms</a>,i+1);
00389       <font class="keywordflow">return</font> <a class="code" href="molfile__plugin_8h.html#a4">MOLFILE_ERROR</a>;
00390     } <font class="keywordflow">else</font> <font class="keywordflow">if</font> (j &lt; 5) {
00391       fprintf(stderr, <font class="stringliteral">"cube structure) missing type or coordinate(s)"</font>
00392               <font class="stringliteral">" in file '%s' for atom '%d'\n"</font>,cube-&gt;<a class="code" href="structcube__t.html#m6">file_name</a>,i+1);
00393       <font class="keywordflow">return</font> <a class="code" href="molfile__plugin_8h.html#a4">MOLFILE_ERROR</a>;
00394     }
00395 
00396     <font class="comment">// assign atom symbol to number. flag unknown or dummy atoms with X.</font>
00397     atom-&gt;<a class="code" href="structmolfile__atom__t.html#m13">atomicnumber</a> = idx;
00398     strncpy(atom-&gt;<a class="code" href="structmolfile__atom__t.html#m0">name</a>, get_pte_label(idx), <font class="keyword">sizeof</font>(atom-&gt;<a class="code" href="structmolfile__atom__t.html#m0">name</a>));
00399     strncpy(atom-&gt;<a class="code" href="structmolfile__atom__t.html#m1">type</a>, atom-&gt;<a class="code" href="structmolfile__atom__t.html#m0">name</a>, <font class="keyword">sizeof</font>(atom-&gt;<a class="code" href="structmolfile__atom__t.html#m1">type</a>));
00400     atom-&gt;<a class="code" href="structmolfile__atom__t.html#m10">mass</a> = <a class="code" href="periodic__table_8h.html#a5">get_pte_mass</a>(idx);
00401     atom-&gt;<a class="code" href="structmolfile__atom__t.html#m12">radius</a> = <a class="code" href="periodic__table_8h.html#a6">get_pte_vdw_radius</a>(idx);
00402     atom-&gt;<a class="code" href="structmolfile__atom__t.html#m2">resname</a>[0] = <font class="charliteral">'\0'</font>;
00403     atom-&gt;<a class="code" href="structmolfile__atom__t.html#m3">resid</a> = 1;
00404     atom-&gt;<a class="code" href="structmolfile__atom__t.html#m5">chain</a>[0] = <font class="charliteral">'\0'</font>;
00405     atom-&gt;<a class="code" href="structmolfile__atom__t.html#m4">segid</a>[0] = <font class="charliteral">'\0'</font>;
00406     <font class="comment">/* skip to the end of line */</font>
00407   }
00408 
00409   <font class="keywordflow">return</font> <a class="code" href="molfile__plugin_8h.html#a2">MOLFILE_SUCCESS</a>;
00410 }
00411 
00412 
<a name="l00413"></a><a class="code" href="cubeplugin_8C.html#a9">00413</a> <font class="keyword">static</font> <font class="keywordtype">int</font> <a class="code" href="cubeplugin_8C.html#a9">read_cube_timestep</a>(<font class="keywordtype">void</font> *v, <font class="keywordtype">int</font> natoms, <a class="code" href="structmolfile__timestep__t.html">molfile_timestep_t</a> *ts) {
00414   <font class="keywordtype">int</font> i, j, n;
00415   <font class="keywordtype">char</font> fbuffer[1024];
00416   <font class="keywordtype">float</font> x, y, z;
00417   <font class="keywordtype">char</font> *k;
00418   
00419   <a class="code" href="structcube__t.html">cube_t</a> *cube = (<a class="code" href="structcube__t.html">cube_t</a> *)v;
00420 
00421   <font class="comment">// there is only one set of coordinates</font>
00422   <font class="keywordflow">if</font> (cube-&gt;<a class="code" href="structcube__t.html#m3">coord</a>) <font class="keywordflow">return</font> <a class="code" href="molfile__plugin_8h.html#a3">MOLFILE_EOF</a>;
00423   cube-&gt;<a class="code" href="structcube__t.html#m3">coord</a> = <font class="keyword">true</font>;
00424 
00425   <font class="comment">// jump to coordinate position</font>
00426   fseek(cube-&gt;<a class="code" href="structcube__t.html#m0">fd</a>, cube-&gt;<a class="code" href="structcube__t.html#m4">crdpos</a>, SEEK_SET);
00427   <font class="comment">// XXX fseek()/ftell() are incompatible with 64-bit LFS I/O implementations, </font>
00428   <font class="comment">// hope we don't read any files &gt;= 2GB...</font>
00429  
00430   <font class="comment">/* read the coordinates */</font>
00431   <font class="keywordflow">for</font> (i=0; i&lt;cube-&gt;<a class="code" href="structcube__t.html#m2">numatoms</a>; i++) {
00432     k = fgets(fbuffer, 1024, cube-&gt;<a class="code" href="structcube__t.html#m0">fd</a>);
00433     j = sscanf(fbuffer, <font class="stringliteral">"%*d %*f %f %f %f"</font>, &amp;x, &amp;y, &amp;z);
00434     
00435     <font class="keywordflow">if</font> (k == NULL) {
00436       <font class="keywordflow">return</font> <a class="code" href="molfile__plugin_8h.html#a4">MOLFILE_ERROR</a>;
00437     } <font class="keywordflow">else</font> <font class="keywordflow">if</font> (j &lt; 3) {
00438       fprintf(stderr, <font class="stringliteral">"cube timestep) missing type or coordinate(s) in file '%s' for atom '%d'\n"</font>,cube-&gt;<a class="code" href="structcube__t.html#m6">file_name</a>,i+1);
00439       <font class="keywordflow">return</font> <a class="code" href="molfile__plugin_8h.html#a4">MOLFILE_ERROR</a>;
00440     } <font class="keywordflow">else</font> <font class="keywordflow">if</font> (j&gt;=3) {
00441       <font class="keywordflow">if</font> (ts != NULL) { 
00442         <font class="comment">// Only save coords if we're given a timestep pointer, </font>
00443         <font class="comment">// otherwise assume that VMD wants us to skip past it.</font>
00444         
00445         <font class="comment">// In order to make the periodic display work, we need to</font>
00446         <font class="comment">// rotate the coordinates around the origin by the stored</font>
00447         <font class="comment">// rotation matrix. All coordinates are in Bohr, so they</font>
00448         <font class="comment">// must be converted to Angstrom, too.</font>
00449         x -= cube-&gt;<a class="code" href="structcube__t.html#m9">origin</a>[0];
00450         y -= cube-&gt;<a class="code" href="structcube__t.html#m9">origin</a>[1];
00451         z -= cube-&gt;<a class="code" href="structcube__t.html#m9">origin</a>[2];
00452         
00453         <font class="keywordflow">for</font> (n=0; n&lt;3; ++n) {
00454           ts-&gt;<a class="code" href="structmolfile__timestep__t.html#m0">coords</a>[3*i + n] = <a class="code" href="cubeplugin_8C.html#a1">bohr</a>*(cube-&gt;<a class="code" href="structcube__t.html#m9">origin</a>[n] 
00455                                       + cube-&gt;<a class="code" href="structcube__t.html#m10">rotmat</a>[n][0] * x
00456                                       + cube-&gt;<a class="code" href="structcube__t.html#m10">rotmat</a>[n][1] * y
00457                                       + cube-&gt;<a class="code" href="structcube__t.html#m10">rotmat</a>[n][2] * z);
00458         }
00459       }
00460     } <font class="keywordflow">else</font> {
00461       <font class="keywordflow">break</font>;
00462     }
00463   }
00464   <font class="comment">// set unitcell dimensions from cached data.</font>
00465   <font class="keywordflow">if</font> (ts != NULL) { 
00466       ts-&gt;<a class="code" href="structmolfile__timestep__t.html#z4_0">A</a> = cube-&gt;<a class="code" href="structcube__t.html#m11">box</a>.<a class="code" href="structcube__box.html#m0">A</a>;
00467       ts-&gt;<a class="code" href="structmolfile__timestep__t.html#z4_1">B</a> = cube-&gt;<a class="code" href="structcube__t.html#m11">box</a>.<a class="code" href="structcube__box.html#m1">B</a>;
00468       ts-&gt;<a class="code" href="structmolfile__timestep__t.html#z4_2">C</a> = cube-&gt;<a class="code" href="structcube__t.html#m11">box</a>.<a class="code" href="structcube__box.html#m2">C</a>;
00469       ts-&gt;<a class="code" href="structmolfile__timestep__t.html#z4_3">alpha</a> = cube-&gt;<a class="code" href="structcube__t.html#m11">box</a>.<a class="code" href="structcube__box.html#m3">alpha</a>;
00470       ts-&gt;<a class="code" href="structmolfile__timestep__t.html#z4_4">beta</a>  = cube-&gt;<a class="code" href="structcube__t.html#m11">box</a>.<a class="code" href="structcube__box.html#m4">beta</a>;
00471       ts-&gt;<a class="code" href="structmolfile__timestep__t.html#z4_5">gamma</a> = cube-&gt;<a class="code" href="structcube__t.html#m11">box</a>.<a class="code" href="structcube__box.html#m5">gamma</a>;
00472   }
00473   
00474   <font class="keywordflow">return</font> <a class="code" href="molfile__plugin_8h.html#a2">MOLFILE_SUCCESS</a>;
00475 }
00476 
<a name="l00477"></a><a class="code" href="cubeplugin_8C.html#a10">00477</a> <font class="keyword">static</font> <font class="keywordtype">int</font> <a class="code" href="cubeplugin_8C.html#a10">read_cube_metadata</a>(<font class="keywordtype">void</font> *v, <font class="keywordtype">int</font> *nsets, 
00478   <a class="code" href="structmolfile__volumetric__t.html">molfile_volumetric_t</a> **metadata) {
00479   <a class="code" href="structcube__t.html">cube_t</a> *cube = (<a class="code" href="structcube__t.html">cube_t</a> *)v;
00480   *nsets = cube-&gt;<a class="code" href="structcube__t.html#m1">nsets</a>; 
00481   *metadata = cube-&gt;<a class="code" href="structcube__t.html#m8">vol</a>;  
00482 
00483   <font class="keywordflow">return</font> <a class="code" href="molfile__plugin_8h.html#a2">MOLFILE_SUCCESS</a>;
00484 }
00485 
<a name="l00486"></a><a class="code" href="cubeplugin_8C.html#a11">00486</a> <font class="keyword">static</font> <font class="keywordtype">int</font> <a class="code" href="cubeplugin_8C.html#a11">read_cube_data</a>(<font class="keywordtype">void</font> *v, <font class="keywordtype">int</font> set, <font class="keywordtype">float</font> *datablock, <font class="keywordtype">float</font> *colorblock) {
00487   <a class="code" href="structcube__t.html">cube_t</a> *cube = (<a class="code" href="structcube__t.html">cube_t</a> *)v;
00488 
00489   fprintf(stderr, <font class="stringliteral">"cubeplugin) trying to read cube data set %d\n"</font>, set);
00490 
00491   <font class="keywordtype">int</font> xsize = cube-&gt;<a class="code" href="structcube__t.html#m8">vol</a>[set].<a class="code" href="structmolfile__volumetric__t.html#m5">xsize</a>; 
00492   <font class="keywordtype">int</font> ysize = cube-&gt;<a class="code" href="structcube__t.html#m8">vol</a>[set].<a class="code" href="structmolfile__volumetric__t.html#m6">ysize</a>;
00493   <font class="keywordtype">int</font> zsize = cube-&gt;<a class="code" href="structcube__t.html#m8">vol</a>[set].<a class="code" href="structmolfile__volumetric__t.html#m7">zsize</a>;
00494   <font class="keywordtype">int</font> xysize = xsize*ysize;
00495   <font class="keywordtype">int</font> nsize = cube-&gt;<a class="code" href="structcube__t.html#m1">nsets</a>;
00496   <font class="keywordtype">int</font> nzsize = nsize*zsize;
00497   <font class="keywordtype">int</font> nyzsize = nsize*zsize*ysize;
00498   <font class="keywordtype">int</font> x, y, z;
00499 
00500   <font class="comment">// go to data</font>
00501   fseek(cube-&gt;<a class="code" href="structcube__t.html#m0">fd</a>, cube-&gt;<a class="code" href="structcube__t.html#m5">datapos</a>, SEEK_SET);
00502   <font class="comment">// XXX fseek()/ftell() are incompatible with 64-bit LFS I/O implementations, </font>
00503   <font class="comment">// hope we don't read any files &gt;= 2GB...</font>
00504 
00505   <font class="comment">// read the data values in </font>
00506   <font class="keywordflow">if</font> (cube-&gt;<a class="code" href="structcube__t.html#m1">nsets</a> == 1) { <font class="comment">// density cube file</font>
00507     <font class="keywordflow">for</font> (x=0; x&lt;xsize; x++) {
00508       <font class="keywordflow">for</font> (y=0; y&lt;ysize; y++) {
00509         <font class="keywordflow">for</font> (z=0; z&lt;zsize; z++) {
00510           <font class="keywordflow">if</font> (fscanf(cube-&gt;<a class="code" href="structcube__t.html#m0">fd</a>, <font class="stringliteral">"%f"</font>, &amp;datablock[z*xysize + y*xsize + x]) != 1) {
00511               <font class="keywordflow">return</font> <a class="code" href="molfile__plugin_8h.html#a4">MOLFILE_ERROR</a>;
00512           }
00513         }
00514       } 
00515     }
00516   } <font class="keywordflow">else</font> {
00517     <font class="comment">// XXX we may wish to examine this strategy for alternatives that provide</font>
00518     <font class="comment">// the same performance but without the extra copy, but it makes sense </font>
00519     <font class="comment">// for now.  </font>
00520 
00521     <font class="comment">// Since the orbital cube file stores the data orb1(a1,b1,c1), orb2(a1,b1,c1), </font>
00522     <font class="comment">// ... orbn(a1,b1,c1), orb1(a1,b1,c2), orb2(a1,a1,c2), ..., orbn(ai,bj,ck)</font>
00523     <font class="comment">// we have to cache the whole data set of have any kind of reasonable performance.</font>
00524     <font class="comment">// otherwise we would have to read (and parse!) the whole file over and over again.</font>
00525     <font class="comment">// this way we have to do it only once at the temporary expense of some memory.</font>
00526     <font class="keywordflow">if</font> (cube-&gt;<a class="code" href="structcube__t.html#m7">datacache</a> == NULL) {
00527       <font class="keywordtype">int</font> points = xsize*ysize*zsize * nsize; <font class="comment">// number of grid cells * nsets</font>
00528       <font class="keywordtype">int</font> i;
00529 
00530       <font class="comment">// let people know what is going on.</font>
00531       fprintf(stderr, <font class="stringliteral">"\ncubeplugin) creating %d MByte cube orbital cache.\n"</font>, 
00532               (<font class="keywordtype">int</font>) (points*<font class="keyword">sizeof</font>(<font class="keywordtype">float</font>)) / 1048576);
00533       cube-&gt;<a class="code" href="structcube__t.html#m7">datacache</a> = <font class="keyword">new</font> <font class="keywordtype">float</font>[points];
00534             
00535       <font class="keywordflow">for</font> (i=0; i &lt; points; ++i) {
00536         <font class="keywordflow">if</font> (fscanf(cube-&gt;<a class="code" href="structcube__t.html#m0">fd</a>, <font class="stringliteral">"%f"</font>, &amp;cube-&gt;<a class="code" href="structcube__t.html#m7">datacache</a>[i]) != 1) {
00537           <font class="keywordflow">return</font> <a class="code" href="molfile__plugin_8h.html#a4">MOLFILE_ERROR</a>;
00538         }
00539 
00540         <font class="comment">// print an ascii progress bar so impatient people do not get scared.</font>
00541         <font class="keywordflow">if</font> ((i % (1048576/<font class="keyword">sizeof</font>(float))) == 0) {  <font class="comment">// one dot per MB.</font>
00542           fprintf(stderr, <font class="stringliteral">"."</font>); 
00543         }
00544       }
00545     }
00546       
00547     <font class="keywordflow">for</font> (x=0; x&lt;xsize; x++) {
00548       <font class="keywordflow">for</font> (y=0; y&lt;ysize; y++) {
00549         <font class="keywordflow">for</font> (z=0; z&lt;zsize; z++) {
00550           datablock[z*xysize + y*xsize + x] = cube-&gt;<a class="code" href="structcube__t.html#m7">datacache</a>[x*nyzsize + y*nzsize + z*nsize + set];
00551         }
00552       }
00553     }
00554   }
00555 
00556   <font class="keywordflow">return</font> <a class="code" href="molfile__plugin_8h.html#a2">MOLFILE_SUCCESS</a>;
00557 }
00558 
<a name="l00559"></a><a class="code" href="cubeplugin_8C.html#a6">00559</a> <font class="keyword">static</font> <font class="keywordtype">void</font> <a class="code" href="cubeplugin_8C.html#a6">close_cube_read</a>(<font class="keywordtype">void</font> *v) {
00560   <a class="code" href="structcube__t.html">cube_t</a> *cube = (<a class="code" href="structcube__t.html">cube_t</a> *)v;
00561 
00562   fclose(cube-&gt;<a class="code" href="structcube__t.html#m0">fd</a>);
00563   <font class="keywordflow">if</font> (cube-&gt;<a class="code" href="structcube__t.html#m8">vol</a>) {
00564     <font class="keyword">delete</font>[] cube-&gt;<a class="code" href="structcube__t.html#m8">vol</a>; 
00565   }
00566   free(cube-&gt;<a class="code" href="structcube__t.html#m6">file_name</a>);
00567   <font class="keywordflow">if</font> (cube-&gt;<a class="code" href="structcube__t.html#m7">datacache</a>) { 
00568     fprintf(stderr, <font class="stringliteral">"\ncubeplugin) freeing cube orbital cache.\n"</font>);
00569     <font class="keyword">delete</font>[] cube-&gt;<a class="code" href="structcube__t.html#m7">datacache</a>; 
00570   }  
00571 
00572   <font class="keyword">delete</font> cube;
00573 }
00574 
00575 <font class="comment">/*</font>
00576 <font class="comment"> * Initialization stuff here</font>
00577 <font class="comment"> */</font>
<a name="l00578"></a><a class="code" href="cubeplugin_8C.html#a2">00578</a> <font class="keyword">static</font> <a class="code" href="structmolfile__plugin__t.html">molfile_plugin_t</a> <a class="code" href="cubeplugin_8C.html#a2">plugin</a> = {
00579   <a class="code" href="vmdplugin_8h.html#a10">vmdplugin_ABIVERSION</a>,   <font class="comment">// ABI version</font>
00580   <a class="code" href="molfile__plugin_8h.html#a0">MOLFILE_PLUGIN_TYPE</a>,    <font class="comment">// plugin type</font>
00581   <font class="stringliteral">"cube"</font>,                 <font class="comment">// short file format description</font>
00582   <font class="stringliteral">"Gaussian Cube"</font>,        <font class="comment">// pretty file format description</font>
00583   <font class="stringliteral">"Axel Kohlmeyer, John E. Stone"</font>, <font class="comment">// author(s)</font>
00584   0,                      <font class="comment">// major version</font>
00585   8,                      <font class="comment">// minor version</font>
00586   <a class="code" href="vmdplugin_8h.html#a12">VMDPLUGIN_THREADSAFE</a>,   <font class="comment">// is reentrant</font>
00587   <font class="stringliteral">"cube"</font>,                 <font class="comment">// filename extension</font>
00588   <a class="code" href="cubeplugin_8C.html#a7">open_cube_read</a>,               
00589   <a class="code" href="cubeplugin_8C.html#a8">read_cube_structure</a>,
00590   0,                      <font class="comment">// read_bonds</font>
00591   <a class="code" href="cubeplugin_8C.html#a9">read_cube_timestep</a>,
00592   <a class="code" href="cubeplugin_8C.html#a6">close_cube_read</a>,
00593   0,                      <font class="comment">// open_file_write</font>
00594   0,                      <font class="comment">// write_structure</font>
00595   0,                      <font class="comment">// write_timestep</font>
00596   0,                      <font class="comment">// close_file_write</font>
00597   <a class="code" href="cubeplugin_8C.html#a10">read_cube_metadata</a>,
00598   <a class="code" href="cubeplugin_8C.html#a11">read_cube_data</a>,
00599   0                       <font class="comment">// read_rawgraphics</font>
00600 };
00601 
<a name="l00602"></a><a class="code" href="cubeplugin_8C.html#a12">00602</a> <font class="keywordtype">int</font> <a class="code" href="vmdplugin_8h.html#a5">VMDPLUGIN_init</a>(<font class="keywordtype">void</font>) { <font class="keywordflow">return</font> <a class="code" href="vmdplugin_8h.html#a13">VMDPLUGIN_SUCCESS</a>; }
<a name="l00603"></a><a class="code" href="cubeplugin_8C.html#a13">00603</a> <font class="keywordtype">int</font> <a class="code" href="vmdplugin_8h.html#a6">VMDPLUGIN_fini</a>(<font class="keywordtype">void</font>) { <font class="keywordflow">return</font> <a class="code" href="vmdplugin_8h.html#a13">VMDPLUGIN_SUCCESS</a>; }
<a name="l00604"></a><a class="code" href="cubeplugin_8C.html#a14">00604</a> <font class="keywordtype">int</font> <a class="code" href="vmdplugin_8h.html#a3">VMDPLUGIN_register</a>(<font class="keywordtype">void</font> *v, <a class="code" href="vmdplugin_8h.html#a15">vmdplugin_register_cb</a> cb) {
00605   (*cb)(v, (<a class="code" href="structvmdplugin__t.html">vmdplugin_t</a> *)&amp;plugin);
00606   <font class="keywordflow">return</font> <a class="code" href="vmdplugin_8h.html#a13">VMDPLUGIN_SUCCESS</a>;
00607 }
00608 
00609 
00610 
00611 <font class="preprocessor">#ifdef TEST_PLUGIN</font>
00612 <font class="preprocessor"></font>
00613 <font class="keywordtype">int</font> <a class="code" href="main_8c.html#a3">main</a>(<font class="keywordtype">int</font> argc, <font class="keywordtype">char</font> *argv[]) {
00614   <font class="keywordtype">int</font> natoms;
00615   <font class="keywordtype">void</font> *v;
00616   <font class="keywordtype">int</font> i, nsets, set;
00617   <a class="code" href="structmolfile__volumetric__t.html">molfile_volumetric_t</a> * meta;
00618 
00619   <font class="keywordflow">while</font> (--argc) {
00620     ++argv;
00621     v = <a class="code" href="cubeplugin_8C.html#a7">open_cube_read</a>(*argv, <font class="stringliteral">"cube"</font>, &amp;natoms);
00622     <font class="keywordflow">if</font> (!v) {
00623       fprintf(stderr, <font class="stringliteral">"open_cube_read failed for file %s\n"</font>, *argv);
00624       <font class="keywordflow">return</font> 1;
00625     }
00626     fprintf(stderr, <font class="stringliteral">"open_cube_read succeeded for file %s\n"</font>, *argv);
00627 
00628     <font class="comment">// try loading the EDM metadata now</font>
00629     <font class="keywordflow">if</font> (<a class="code" href="cubeplugin_8C.html#a10">read_cube_metadata</a>(v, &amp;nsets, &amp;meta)) {
00630       <font class="keywordflow">return</font> 1; <font class="comment">// failed to load cube file</font>
00631     }
00632     fprintf(stderr, <font class="stringliteral">"read_cube_metadata succeeded for file %s\n"</font>, *argv);
00633 
00634     <font class="keywordflow">for</font> (set=0; set&lt;nsets; set++) {
00635       printf(<font class="stringliteral">"Loading volume set: %d\n"</font>, set);   
00636       
00637       <font class="keywordtype">int</font> elements = meta[set].<a class="code" href="structmolfile__volumetric__t.html#m5">xsize</a> * meta[set].<a class="code" href="structmolfile__volumetric__t.html#m6">ysize</a> * meta[set].<a class="code" href="structmolfile__volumetric__t.html#m7">zsize</a>;
00638       printf(<font class="stringliteral">"   Grid Elements: %d\n"</font>, elements);
00639       printf(<font class="stringliteral">" Grid dimensions: X: %d Y: %d Z: %d\n"</font>, 
00640              meta[set].xsize, meta[set].ysize, meta[set].zsize);
00641 
00642       <font class="keywordtype">float</font> * voldata = (<font class="keywordtype">float</font> *) malloc(<font class="keyword">sizeof</font>(<font class="keywordtype">float</font>) * elements);
00643       <font class="keywordtype">float</font> * coldata = NULL;
00644 
00645       <font class="keywordflow">if</font> (meta[set].<a class="code" href="structmolfile__volumetric__t.html#m8">has_color</a>) {
00646         coldata = (<font class="keywordtype">float</font> *) malloc(<font class="keyword">sizeof</font>(<font class="keywordtype">float</font>) * elements * 3);
00647       }
00648 
00649       <font class="comment">// try loading the data sets now</font>
00650       <font class="keywordflow">if</font> (<a class="code" href="cubeplugin_8C.html#a11">read_cube_data</a>(v, set, voldata, coldata)) {
00651         <font class="keywordflow">return</font> 1; <font class="comment">// failed to load cube file</font>
00652       }
00653 
00654       printf(<font class="stringliteral">"First 6 elements:\n   "</font>);
00655       <font class="keywordflow">for</font> (i=0; i&lt;6; i++) {
00656         printf(<font class="stringliteral">"%g, "</font>, voldata[i]);
00657       }
00658       printf(<font class="stringliteral">"\n"</font>); 
00659 
00660       printf(<font class="stringliteral">"Last 6 elements:\n   "</font>);
00661       <font class="keywordflow">for</font> (i=elements - 6; i&lt;elements; i++) {
00662         printf(<font class="stringliteral">"%g, "</font>, voldata[i]);
00663       }
00664       printf(<font class="stringliteral">"\n"</font>); 
00665     }
00666 
00667     <a class="code" href="cubeplugin_8C.html#a6">close_cube_read</a>(v);
00668   }
00669   <font class="keywordflow">return</font> 0;
00670 }
00671 
00672 <font class="preprocessor">#endif</font>
</pre></div><hr><address><small>Generated on Wed Mar 22 13:15:28 2006 for VMD Plugins (current) by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.gif" alt="doxygen" align="middle" border=0 
width=110 height=53></a>1.2.14 written by <a href="mailto:dimitri@stack.nl">Dimitri van Heesch</a>,
 &copy;&nbsp;1997-2002</small></address>
</body>
</html>
