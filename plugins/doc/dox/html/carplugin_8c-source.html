<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>carplugin.c Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.2.14 -->
<center>
<a class="qindex" href="index.html">Main Page</a> &nbsp; <a class="qindex" href="classes.html">Alphabetical List</a> &nbsp; <a class="qindex" href="annotated.html">Compound List</a> &nbsp; <a class="qindex" href="files.html">File List</a> &nbsp; <a class="qindex" href="functions.html">Compound Members</a> &nbsp; <a class="qindex" href="globals.html">File Members</a> &nbsp; <a class="qindex" href="pages.html">Related Pages</a> &nbsp; </center>
<hr><h1>carplugin.c</h1><a href="carplugin_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 <font class="comment">/***************************************************************************</font>
00002 <font class="comment"> *cr</font>
00003 <font class="comment"> *cr            (C) Copyright 1995-2006 The Board of Trustees of the</font>
00004 <font class="comment"> *cr                        University of Illinois</font>
00005 <font class="comment"> *cr                         All Rights Reserved</font>
00006 <font class="comment"> *cr</font>
00007 <font class="comment"> ***************************************************************************/</font>
00008 
00009 <font class="comment">/***************************************************************************</font>
00010 <font class="comment"> * RCS INFORMATION:</font>
00011 <font class="comment"> *</font>
00012 <font class="comment"> *      $RCSfile: carplugin.c,v $</font>
00013 <font class="comment"> *      $Author: johns $       $Locker:  $             $State: Exp $</font>
00014 <font class="comment"> *      $Revision: 1.12 $       $Date: 2006/02/23 19:36:44 $</font>
00015 <font class="comment"> *</font>
00016 <font class="comment"> ***************************************************************************/</font>
00017 
00018 <font class="comment">/*</font>
00019 <font class="comment"> * Plugin for Insight II/Discover car (cartesian coordinate file) file format.</font>
00020 <font class="comment"> * </font>
00021 <font class="comment"> * TODO: </font>
00022 <font class="comment"> * + 2D PBC info (probably just as a simplified 3D PBC)</font>
00023 <font class="comment"> * + HELIX info (not sure how this will be handled)</font>
00024 <font class="comment"> *</font>
00025 <font class="comment"> * File Header:</font>
00026 <font class="comment"> *   !BIOSYM archive 3</font>
00027 <font class="comment"> *   HELIX </font>
00028 <font class="comment"> *     (if HELIX information is present)</font>
00029 <font class="comment"> *   PBC=ON, PBC=OFF, PBC=2D </font>
00030 <font class="comment"> *     (one of these three choices must be present. PBC cannot be "ON" if</font>
00031 <font class="comment"> *     HELIX information is present.)</font>
00032 <font class="comment"> * Coordinate Header:</font>
00033 <font class="comment"> *   Title (this line may be blank, but must be present)</font>
00034 <font class="comment"> *     1-64 title for the system</font>
00035 <font class="comment"> *     65-80 energy</font>
00036 <font class="comment"> *   ! DATE day month date time year</font>
00037 <font class="comment"> *     (day, month, date, time, year are optional)</font>
00038 <font class="comment"> *   PBC information if PBC=ON:</font>
00039 <font class="comment"> *     1-3 PBC</font>
00040 <font class="comment"> *     4-13 a cell vector a in angstroms</font>
00041 <font class="comment"> *     14-23 b cell vector b in angstroms</font>
00042 <font class="comment"> *     24-33 c cell vector c in angstroms</font>
00043 <font class="comment"> *     34-43 alpha cell angle alpha in degrees</font>
00044 <font class="comment"> *     44-53 beta cell angle beta in degrees</font>
00045 <font class="comment"> *     54-63 gamma cell angle gamma in degrees</font>
00046 <font class="comment"> *     64-80 space group name</font>
00047 <font class="comment"> *   PBC information if PBC=2D:</font>
00048 <font class="comment"> *     1-3 PBC</font>
00049 <font class="comment"> *     4-13 k plane vector k in angstroms</font>
00050 <font class="comment"> *     14-23 l plane vector l in angstroms</font>
00051 <font class="comment"> *     24-33 gamma plane angle gamma in degrees</font>
00052 <font class="comment"> *     34-50 plane group name</font>
00053 <font class="comment"> * Molecule Data:</font>
00054 <font class="comment"> *   If helix info is present:</font>
00055 <font class="comment"> *     1-5 HELIX</font>
00056 <font class="comment"> *     6-15 sigma in degrees</font>
00057 <font class="comment"> *     16-25 d in angstroms</font>
00058 <font class="comment"> *     26-35 kappa angle between l axis and helix axis in degrees</font>
00059 <font class="comment"> *     36-45 lambda angle between k axis and helix axis in degrees</font>
00060 <font class="comment"> *     46-55 Tk fractional position of helix axis along k axis</font>
00061 <font class="comment"> *     56-65 Tl fractional position of helix axis along l axis</font>
00062 <font class="comment"> *   Atom data:</font>
00063 <font class="comment"> *     1-5 atom name</font>
00064 <font class="comment"> *     7-20 x Cartesian coordinate of atom in angstroms</font>
00065 <font class="comment"> *     22-35 y Cartesian coordinate of atom in angstroms</font>
00066 <font class="comment"> *     37-50 z Cartesian coordinate of atom in angstroms</font>
00067 <font class="comment"> *     52-55 type of residue containing atom</font>
00068 <font class="comment"> *     57-63 residue sequence name relative to beginning of current</font>
00069 <font class="comment"> *     molecule, left justified</font>
00070 <font class="comment"> *     64-70 potential type of atom left justified</font>
00071 <font class="comment"> *     72-73 element symbol</font>
00072 <font class="comment"> *     75-80 partial charge on atom</font>
00073 <font class="comment"> *   Final line for a given molecule:</font>
00074 <font class="comment"> *     1-3 end</font>
00075 <font class="comment"> * Final line for the entire molecular system input:</font>
00076 <font class="comment"> *     1-3 end</font>
00077 <font class="comment"> *</font>
00078 <font class="comment"> */</font>
00079 
00080 <font class="preprocessor">#include &lt;stdio.h&gt;</font>
00081 <font class="preprocessor">#include &lt;stdlib.h&gt;</font>
00082 <font class="preprocessor">#include &lt;string.h&gt;</font>
00083 <font class="preprocessor">#include &lt;ctype.h&gt;</font>
00084 <font class="preprocessor">#include "<a class="code" href="molfile__plugin_8h.html">molfile_plugin.h</a>"</font>
00085 
<a name="l00086"></a><a class="code" href="carplugin_8c.html#a0">00086</a> <font class="preprocessor">#define LINESIZE 1024</font>
00087 <font class="preprocessor"></font>
00088 <font class="comment">/* possible values for pbc */</font>
00089 <font class="keyword">enum</font> {<a class="code" href="carplugin_8c.html#a14a2">PBC_ON</a>, <a class="code" href="carplugin_8c.html#a14a3">PBC_OFF</a>, <a class="code" href="carplugin_8c.html#a14a4">PBC_2D</a>};
00090 
<a name="l00091"></a><a class="code" href="structcardata.html">00091</a> <font class="keyword">typedef</font> <font class="keyword">struct </font>{
<a name="l00092"></a><a class="code" href="structcardata.html#m0">00092</a>   FILE *file;
<a name="l00093"></a><a class="code" href="structcardata.html#m2">00093</a>   <font class="keywordtype">int</font> numatoms, pbc, helix, eof;
<a name="l00094"></a><a class="code" href="structcardata.html#m5">00094</a>   <font class="keywordtype">long</font> coord_location;
<a name="l00095"></a><a class="code" href="structcardata.html#m6">00095</a>   <a class="code" href="structmolfile__atom__t.html">molfile_atom_t</a> *atomlist;
00096 } <a class="code" href="structcardata.html">cardata</a>;
00097 
00098 <font class="comment">/* Parse a line contianing atom data from a car file and store it in the</font>
00099 <font class="comment"> * atom structure. Returns 1 on success, 0 on failure.</font>
00100 <font class="comment"> */</font>
<a name="l00101"></a><a class="code" href="carplugin_8c.html#a5">00101</a> <font class="keyword">static</font> <font class="keywordtype">int</font> <a class="code" href="carplugin_8c.html#a5">read_car_structure_line</a>(<a class="code" href="structmolfile__atom__t.html">molfile_atom_t</a> *atom, <font class="keywordtype">char</font> *line) {
00102   <font class="keywordtype">char</font> <a class="code" href="xsfplugin_8C.html#a2">name</a>[<a class="code" href="carplugin_8c.html#a0">LINESIZE</a>], type[<a class="code" href="carplugin_8c.html#a0">LINESIZE</a>];
00103   <font class="keywordtype">int</font> resid;
00104   <font class="keywordtype">float</font> charge;
00105 
00106   <font class="keywordflow">if</font> (sscanf(line, <font class="stringliteral">"%s %*f %*f %*f %*s %d %*s %s %f"</font>, <a class="code" href="xsfplugin_8C.html#a2">name</a>, &amp;resid, type, &amp;charge) 
00107       != 4)
00108     <font class="keywordflow">return</font> 0;
00109 
00110   <font class="comment">/* check the length of the name and type strings before copying. */</font>
00111   <font class="keywordflow">if</font> ( (strlen(<a class="code" href="xsfplugin_8C.html#a2">name</a>) &gt;= 8) || (strlen(type) &gt;= 8) )
00112     <font class="keywordflow">return</font> 0;
00113   strcpy(atom-&gt;<a class="code" href="structmolfile__atom__t.html#m0">name</a>, <a class="code" href="xsfplugin_8C.html#a2">name</a>);
00114   strcpy(atom-&gt;<a class="code" href="structmolfile__atom__t.html#m1">type</a>, type);
00115 
00116   <font class="comment">/* Check that the resid won't overflow the resname string, then copy it</font>
00117 <font class="comment">   * over</font>
00118 <font class="comment">   */</font>
00119   <font class="keywordflow">if</font> (resid &gt; 9999999)
00120     atom-&gt;<a class="code" href="structmolfile__atom__t.html#m2">resname</a>[0] = <font class="charliteral">'\0'</font>;
00121   <font class="keywordflow">else</font>
00122     sprintf(atom-&gt;<a class="code" href="structmolfile__atom__t.html#m2">resname</a>, <font class="stringliteral">"%d"</font>, resid);
00123 
00124   atom-&gt;<a class="code" href="structmolfile__atom__t.html#m3">resid</a> = resid;
00125 
00126   atom-&gt;<a class="code" href="structmolfile__atom__t.html#m5">chain</a>[0] = <font class="charliteral">'\0'</font>;
00127   atom-&gt;<a class="code" href="structmolfile__atom__t.html#m4">segid</a>[0] = <font class="charliteral">'\0'</font>;
00128 
00129   atom-&gt;<a class="code" href="structmolfile__atom__t.html#m11">charge</a> = charge;
00130 
00131   <font class="keywordflow">return</font> 1;
00132 }
00133 
00134 <font class="comment">/* Parse a line contianing atom coordinates from a car file and store them</font>
00135 <font class="comment"> * in the array 'coords' in XYZ order. Returns 1 on success, 0 on failure.</font>
00136 <font class="comment"> */</font>
<a name="l00137"></a><a class="code" href="carplugin_8c.html#a6">00137</a> <font class="keyword">static</font> <font class="keywordtype">int</font> <a class="code" href="carplugin_8c.html#a6">read_car_coordinates</a>(<font class="keywordtype">float</font> *coords, <font class="keywordtype">char</font> *line) {
00138   <font class="keywordtype">float</font> x, y, z;
00139 
00140   <font class="keywordflow">if</font> (sscanf(line, <font class="stringliteral">"%*s %f %f %f %*s %*d %*s %*s %*f"</font>, &amp;x, &amp;y, &amp;z) 
00141       != 3)
00142     <font class="keywordflow">return</font> 0;
00143 
00144   coords[0] = x;
00145   coords[1] = y;
00146   coords[2] = z;
00147 
00148   <font class="keywordflow">return</font> 1;
00149 }
00150 
<a name="l00151"></a><a class="code" href="carplugin_8c.html#a7">00151</a> <font class="keyword">static</font> <font class="keywordtype">void</font> *<a class="code" href="carplugin_8c.html#a7">open_car_read</a>(<font class="keyword">const</font> <font class="keywordtype">char</font> *filename, <font class="keyword">const</font> <font class="keywordtype">char</font> *filetype, 
00152                            <font class="keywordtype">int</font> *natoms) {
00153   FILE *fd;
00154   <a class="code" href="structcardata.html">cardata</a> *data;
00155   <font class="keywordtype">char</font> line[<a class="code" href="carplugin_8c.html#a0">LINESIZE</a>];
00156 
00157   fd = fopen(filename, <font class="stringliteral">"rb"</font>); <font class="keywordflow">if</font> (!fd) <font class="keywordflow">return</font> NULL;
00158   
00159   data = (<a class="code" href="structcardata.html">cardata</a> *)malloc(<font class="keyword">sizeof</font>(<a class="code" href="structcardata.html">cardata</a>));
00160   data-&gt;<a class="code" href="structcardata.html#m4">eof</a> = 0;
00161   data-&gt;<a class="code" href="structcardata.html#m0">file</a> = fd;
00162 
00163   <font class="comment">/* First line: "!BIOSYM archive n", where n indicates the file format */</font>
00164   fgets(line, <a class="code" href="carplugin_8c.html#a0">LINESIZE</a>, fd);
00165   <font class="keywordflow">if</font> (strncmp(line, <font class="stringliteral">"!BIOSYM archive"</font>, 15)) {
00166     fprintf(stderr, <font class="stringliteral">"ERROR) badly formatted/missing header.\n"</font>);
00167     <font class="keywordflow">return</font> NULL;
00168   }
00169 
00170   <font class="comment">/* Second line: "HELIX" if helix information is present. Followed by PBC</font>
00171 <font class="comment">   * info on the next line: "PBC=ON|OFF|2D". </font>
00172 <font class="comment">   * If HELIX is present, PBC cannot be "ON": return an error if this happens. </font>
00173 <font class="comment">   */</font>
00174   fgets(line, <a class="code" href="carplugin_8c.html#a0">LINESIZE</a>, fd);
00175   <font class="keywordflow">if</font> (!strncmp(line, <font class="stringliteral">"HELIX"</font>, 5)) {
00176     data-&gt;<a class="code" href="structcardata.html#m3">helix</a> = 1;
00177     fgets(line, <a class="code" href="carplugin_8c.html#a0">LINESIZE</a>, fd);
00178     fprintf(stdout, <font class="stringliteral">"WARNING) ignoring helix information.\n"</font>);
00179   }
00180   <font class="keywordflow">else</font> {
00181     data-&gt;<a class="code" href="structcardata.html#m3">helix</a> = 0;
00182   }
00183 
00184   <font class="keywordflow">if</font> (!strncmp(line, <font class="stringliteral">"PBC=ON"</font>, 6)) {
00185     data-&gt;<a class="code" href="structcardata.html#m2">pbc</a> = <a class="code" href="carplugin_8c.html#a14a2">PBC_ON</a>;
00186   }
00187   <font class="keywordflow">else</font> <font class="keywordflow">if</font> (!strncmp(line, <font class="stringliteral">"PBC=OFF"</font>, 7)) {
00188     data-&gt;<a class="code" href="structcardata.html#m2">pbc</a> = <a class="code" href="carplugin_8c.html#a14a3">PBC_OFF</a>;
00189   }
00190   <font class="keywordflow">else</font> <font class="keywordflow">if</font> (!strncmp(line, <font class="stringliteral">"PBC=2D"</font>, 6)) {
00191     data-&gt;<a class="code" href="structcardata.html#m2">pbc</a> = <a class="code" href="carplugin_8c.html#a14a4">PBC_2D</a>;
00192     fprintf(stdout, <font class="stringliteral">"WARNING) ignoring 2D PBC information.\n"</font>);
00193   }
00194   <font class="keywordflow">else</font> {
00195     fprintf(stderr, <font class="stringliteral">"ERROR) badly formatted/missing PBC info.\n"</font>);
00196     <font class="keywordflow">return</font> NULL;
00197   }
00198 
00199   <font class="keywordflow">if</font> (data-&gt;<a class="code" href="structcardata.html#m3">helix</a> &amp;&amp; (data-&gt;<a class="code" href="structcardata.html#m2">pbc</a> == <a class="code" href="carplugin_8c.html#a14a2">PBC_ON</a>)) {
00200     fprintf(stderr, <font class="stringliteral">"ERROR) car file contains helix and 3D PBC information."</font>);
00201     <font class="keywordflow">return</font> NULL;
00202   }
00203 
00204   <font class="comment">/* Next line: title/energy for the system. Skipped. */</font>
00205   fgets(line, <a class="code" href="carplugin_8c.html#a0">LINESIZE</a>, fd);
00206 
00207   <font class="comment">/* Next line: "!DATE [day month date time year]". */</font>
00208   fgets(line, <a class="code" href="carplugin_8c.html#a0">LINESIZE</a>, fd);
00209   <font class="keywordflow">if</font> (strncmp(line, <font class="stringliteral">"!DATE"</font>, 5)) {
00210     fprintf(stderr, <font class="stringliteral">"ERROR) badly formatted/missing date.\n"</font>);
00211     <font class="keywordflow">return</font> NULL;
00212   }
00213     
00214   <font class="comment">/* Store the location of the beginning of the PBC/coordinate data. */</font>
00215   data-&gt;<a class="code" href="structcardata.html#m5">coord_location</a> = ftell(fd);
00216 
00217   <font class="comment">/* Skip the PBC and HELIX entries, if present */</font>
00218   <font class="keywordflow">if</font> (data-&gt;<a class="code" href="structcardata.html#m2">pbc</a> != <a class="code" href="carplugin_8c.html#a14a3">PBC_OFF</a>) 
00219     fgets(line, <a class="code" href="carplugin_8c.html#a0">LINESIZE</a>, fd);
00220   <font class="keywordflow">if</font> (data-&gt;<a class="code" href="structcardata.html#m3">helix</a>)
00221     fgets(line, <a class="code" href="carplugin_8c.html#a0">LINESIZE</a>, fd);
00222 
00223   <font class="comment">/* Count the atoms in all molecules*/</font>
00224   data-&gt;<a class="code" href="structcardata.html#m1">numatoms</a> = 0;
00225   fgets(line, <a class="code" href="carplugin_8c.html#a0">LINESIZE</a>, fd);
00226   <font class="keywordflow">while</font>(strncmp(line, <font class="stringliteral">"end"</font>, 3)) {
00227     <font class="keywordflow">while</font>(strncmp(line, <font class="stringliteral">"end"</font>, 3)) {
00228       data-&gt;<a class="code" href="structcardata.html#m1">numatoms</a>++;
00229       fgets(line, <a class="code" href="carplugin_8c.html#a0">LINESIZE</a>, fd);
00230 
00231       <font class="keywordflow">if</font> (feof(fd)) {
00232         fprintf(stderr, <font class="stringliteral">"ERROR) unexpected end-of-file.\n"</font>);
00233         <font class="keywordflow">return</font> NULL;
00234       }
00235       <font class="keywordflow">if</font> (ferror(fd)) {
00236         fprintf(stderr, <font class="stringliteral">"ERROR) error reading car file.\n"</font>);
00237         <font class="keywordflow">return</font> NULL;
00238       }
00239     }
00240     fgets(line, <a class="code" href="carplugin_8c.html#a0">LINESIZE</a>, fd);
00241   }
00242   *natoms = data-&gt;<a class="code" href="structcardata.html#m1">numatoms</a>;
00243 
00244   <font class="keywordflow">return</font> data;
00245 }
00246 
<a name="l00247"></a><a class="code" href="carplugin_8c.html#a8">00247</a> <font class="keyword">static</font> <font class="keywordtype">int</font> <a class="code" href="carplugin_8c.html#a8">read_car_structure</a>(<font class="keywordtype">void</font> *mydata, <font class="keywordtype">int</font> *optflags, 
00248                               <a class="code" href="structmolfile__atom__t.html">molfile_atom_t</a> *atoms) {
00249   <font class="keywordtype">int</font> mol_num;
00250   <font class="keywordtype">char</font> line[<a class="code" href="carplugin_8c.html#a0">LINESIZE</a>];
00251   <a class="code" href="structmolfile__atom__t.html">molfile_atom_t</a> *atom;
00252   <a class="code" href="structcardata.html">cardata</a> *data = (<a class="code" href="structcardata.html">cardata</a> *)mydata;
00253 
00254   *optflags = <a class="code" href="molfile__plugin_8h.html#a13">MOLFILE_CHARGE</a>; <font class="comment">/* car files contain partial charges */</font>
00255 
00256   <font class="comment">/* move to the beginning of the atom data in the file, skipping any PBC or</font>
00257 <font class="comment">   * HELIX information that may be present</font>
00258 <font class="comment">   */</font>
00259   fseek(data-&gt;<a class="code" href="structcardata.html#m0">file</a>, data-&gt;<a class="code" href="structcardata.html#m5">coord_location</a>, SEEK_SET);
00260   <font class="keywordflow">if</font> (data-&gt;<a class="code" href="structcardata.html#m2">pbc</a> != <a class="code" href="carplugin_8c.html#a14a3">PBC_OFF</a>) 
00261     fgets(line, <a class="code" href="carplugin_8c.html#a0">LINESIZE</a>, data-&gt;<a class="code" href="structcardata.html#m0">file</a>);
00262   <font class="keywordflow">if</font> (data-&gt;<a class="code" href="structcardata.html#m3">helix</a>)
00263     fgets(line, <a class="code" href="carplugin_8c.html#a0">LINESIZE</a>, data-&gt;<a class="code" href="structcardata.html#m0">file</a>);
00264 
00265   mol_num = 0;
00266   atom = atoms;
00267   fgets(line, <a class="code" href="carplugin_8c.html#a0">LINESIZE</a>, data-&gt;<a class="code" href="structcardata.html#m0">file</a>);
00268   <font class="comment">/* Loop through all molecules */</font>
00269   <font class="keywordflow">while</font>(strncmp(line, <font class="stringliteral">"end"</font>, 3)) {
00270     <font class="comment">/* Read the structure for each molecule */</font>
00271     <font class="keywordflow">while</font>(strncmp(line, <font class="stringliteral">"end"</font>, 3)) {
00272       <font class="keywordflow">if</font> (!<a class="code" href="carplugin_8c.html#a5">read_car_structure_line</a>(atom, line)) {
00273         fprintf(stderr, <font class="stringliteral">"ERROR) badly formatted structure line:\n%s\n"</font>, line);
00274         <font class="keywordflow">return</font> <a class="code" href="molfile__plugin_8h.html#a4">MOLFILE_ERROR</a>;
00275       }
00276 
00277       <font class="comment">/* XXX - use the chain name to identify different molecules */</font>
00278       sprintf(atom-&gt;<a class="code" href="structmolfile__atom__t.html#m5">chain</a>, <font class="stringliteral">"%d"</font>, mol_num);
00279 
00280       atom++;
00281       
00282       fgets(line, <a class="code" href="carplugin_8c.html#a0">LINESIZE</a>, data-&gt;<a class="code" href="structcardata.html#m0">file</a>);
00283       <font class="keywordflow">if</font> (feof(data-&gt;<a class="code" href="structcardata.html#m0">file</a>)) {
00284         fprintf(stderr, <font class="stringliteral">"ERROR) unexpected end-of-file while reading structure.\n"</font>);
00285         <font class="keywordflow">return</font> <a class="code" href="molfile__plugin_8h.html#a4">MOLFILE_ERROR</a>;
00286       }
00287       <font class="keywordflow">if</font> (ferror(data-&gt;<a class="code" href="structcardata.html#m0">file</a>)) {
00288         fprintf(stderr, <font class="stringliteral">"ERROR) error reading car file while reading structure.\n"</font>);
00289         <font class="keywordflow">return</font> <a class="code" href="molfile__plugin_8h.html#a4">MOLFILE_ERROR</a>;
00290       }
00291     }
00292     fgets(line, <a class="code" href="carplugin_8c.html#a0">LINESIZE</a>, data-&gt;<a class="code" href="structcardata.html#m0">file</a>);
00293     mol_num++;
00294   }
00295 
00296   <font class="keywordflow">return</font> <a class="code" href="molfile__plugin_8h.html#a2">MOLFILE_SUCCESS</a>;
00297 }
00298 
<a name="l00299"></a><a class="code" href="carplugin_8c.html#a9">00299</a> <font class="keyword">static</font> <font class="keywordtype">int</font> <a class="code" href="carplugin_8c.html#a9">read_car_timestep</a>(<font class="keywordtype">void</font> *mydata, <font class="keywordtype">int</font> natoms, <a class="code" href="structmolfile__timestep__t.html">molfile_timestep_t</a> *ts) {
00300   <font class="keywordtype">char</font> line[<a class="code" href="carplugin_8c.html#a0">LINESIZE</a>];
00301   <a class="code" href="structcardata.html">cardata</a> *data = (<a class="code" href="structcardata.html">cardata</a> *)mydata;
00302   <font class="keywordtype">float</font> *coords = NULL;
00303 
00304   <font class="comment">/* return if coordinates have been read */</font>
00305   <font class="keywordflow">if</font> (data-&gt;<a class="code" href="structcardata.html#m4">eof</a>)
00306     <font class="keywordflow">return</font> <a class="code" href="molfile__plugin_8h.html#a3">MOLFILE_EOF</a>;
00307 
00308   <font class="comment">/* move to the beginning of the atom data in the file */</font>
00309   fseek(data-&gt;<a class="code" href="structcardata.html#m0">file</a>, data-&gt;<a class="code" href="structcardata.html#m5">coord_location</a>, SEEK_SET);
00310 
00311   <font class="comment">/* read the PBC record if present */</font>
00312   <font class="keywordflow">if</font> (data-&gt;<a class="code" href="structcardata.html#m2">pbc</a> == <a class="code" href="carplugin_8c.html#a14a2">PBC_ON</a>) {
00313     fgets(line, <a class="code" href="carplugin_8c.html#a0">LINESIZE</a>, data-&gt;<a class="code" href="structcardata.html#m0">file</a>);
00314 
00315     <font class="keywordflow">if</font> (ts) {
00316       <font class="keywordflow">if</font> ( sscanf(line, <font class="stringliteral">"PBC %f %f %f %f %f %f %*s"</font>, 
00317                   &amp;ts-&gt;<a class="code" href="structmolfile__timestep__t.html#z4_0">A</a>, &amp;ts-&gt;<a class="code" href="structmolfile__timestep__t.html#z4_1">B</a>, &amp;ts-&gt;<a class="code" href="structmolfile__timestep__t.html#z4_2">C</a>, 
00318                   &amp;ts-&gt;<a class="code" href="structmolfile__timestep__t.html#z4_3">alpha</a>, &amp;ts-&gt;<a class="code" href="structmolfile__timestep__t.html#z4_4">beta</a>, &amp;ts-&gt;<a class="code" href="structmolfile__timestep__t.html#z4_5">gamma</a>) != 6 ) {
00319         fprintf(stderr, <font class="stringliteral">"ERROR) badly formatted PBC line:\n%s\n"</font>, line);
00320         <font class="keywordflow">return</font> <a class="code" href="molfile__plugin_8h.html#a4">MOLFILE_ERROR</a>;
00321       }
00322     }
00323   }
00324   <font class="keywordflow">else</font> <font class="keywordflow">if</font> (data-&gt;<a class="code" href="structcardata.html#m2">pbc</a> == <a class="code" href="carplugin_8c.html#a14a4">PBC_2D</a>) {
00325     <font class="comment">/* XXX - Ignore 2D PBC information */</font>
00326     fgets(line, <a class="code" href="carplugin_8c.html#a0">LINESIZE</a>, data-&gt;<a class="code" href="structcardata.html#m0">file</a>);
00327   }
00328 
00329   <font class="comment">/* skip the helix record if present */</font>
00330   <font class="keywordflow">if</font> (data-&gt;<a class="code" href="structcardata.html#m3">helix</a>)
00331     fgets(line, <a class="code" href="carplugin_8c.html#a0">LINESIZE</a>, data-&gt;<a class="code" href="structcardata.html#m0">file</a>);
00332 
00333   <font class="keywordflow">if</font> (ts)
00334     coords = ts-&gt;<a class="code" href="structmolfile__timestep__t.html#m0">coords</a>;
00335 
00336   fgets(line, <a class="code" href="carplugin_8c.html#a0">LINESIZE</a>, data-&gt;<a class="code" href="structcardata.html#m0">file</a>);
00337   <font class="comment">/* Loop through all molecules */</font>
00338   <font class="keywordflow">while</font>(strncmp(line, <font class="stringliteral">"end"</font>, 3)) {
00339     <font class="comment">/* Read the coordinates for each molecule */</font>
00340     <font class="keywordflow">while</font>(strncmp(line, <font class="stringliteral">"end"</font>, 3)) {
00341       <font class="comment">/* only save coords if we're given a timestep pointer. */</font>
00342       <font class="keywordflow">if</font> (ts) {
00343         <font class="keywordflow">if</font> (!<a class="code" href="carplugin_8c.html#a6">read_car_coordinates</a>(coords, line)) {
00344           fprintf(stderr, <font class="stringliteral">"ERROR) badly formatted coordinate line:\n%s\n"</font>, line);
00345           <font class="keywordflow">return</font> <a class="code" href="molfile__plugin_8h.html#a4">MOLFILE_ERROR</a>;
00346         }
00347         coords += 3;
00348       }
00349 
00350       fgets(line, <a class="code" href="carplugin_8c.html#a0">LINESIZE</a>, data-&gt;<a class="code" href="structcardata.html#m0">file</a>);
00351       <font class="keywordflow">if</font> (feof(data-&gt;<a class="code" href="structcardata.html#m0">file</a>)) {
00352         fprintf(stderr, <font class="stringliteral">"ERROR) unexpected end-of-file while reading coordinates.\n"</font>);
00353         <font class="keywordflow">return</font> <a class="code" href="molfile__plugin_8h.html#a4">MOLFILE_ERROR</a>;
00354       }
00355       <font class="keywordflow">if</font> (ferror(data-&gt;<a class="code" href="structcardata.html#m0">file</a>)) {
00356         fprintf(stderr, <font class="stringliteral">"ERROR) file error while reading coordinates.\n"</font>);
00357         <font class="keywordflow">return</font> <a class="code" href="molfile__plugin_8h.html#a4">MOLFILE_ERROR</a>;
00358       }
00359     }
00360     fgets(line, <a class="code" href="carplugin_8c.html#a0">LINESIZE</a>, data-&gt;<a class="code" href="structcardata.html#m0">file</a>);
00361   }
00362 
00363   <font class="comment">/* set eof since this file contians only one "timestep" */</font>
00364   data-&gt;<a class="code" href="structcardata.html#m4">eof</a> = 1;
00365 
00366   <font class="keywordflow">return</font> <a class="code" href="molfile__plugin_8h.html#a2">MOLFILE_SUCCESS</a>;
00367 }
00368     
<a name="l00369"></a><a class="code" href="carplugin_8c.html#a10">00369</a> <font class="keyword">static</font> <font class="keywordtype">void</font> <a class="code" href="carplugin_8c.html#a10">close_car_read</a>(<font class="keywordtype">void</font> *mydata) {
00370   <font class="keywordflow">if</font> (mydata) {
00371     <a class="code" href="structcardata.html">cardata</a> *data = (<a class="code" href="structcardata.html">cardata</a> *)mydata;
00372     fclose(data-&gt;<a class="code" href="structcardata.html#m0">file</a>);
00373     free(data);
00374   }
00375 }
00376 
00377 
00378 <font class="comment">/* registration stuff */</font>
<a name="l00379"></a><a class="code" href="carplugin_8c.html#a1">00379</a> <font class="keyword">static</font> <a class="code" href="structmolfile__plugin__t.html">molfile_plugin_t</a> <a class="code" href="carplugin_8c.html#a1">carplugin</a> = {
00380   <a class="code" href="vmdplugin_8h.html#a10">vmdplugin_ABIVERSION</a>,
00381   <a class="code" href="molfile__plugin_8h.html#a0">MOLFILE_PLUGIN_TYPE</a>,                         <font class="comment">/* type */</font>
00382   <font class="stringliteral">"car"</font>,                                       <font class="comment">/* short name */</font>
00383   <font class="stringliteral">"InsightII car"</font>,                             <font class="comment">/* pretty name */</font>
00384   <font class="stringliteral">"Eamon Caddigan"</font>,                            <font class="comment">/* author */</font>
00385   0,                                           <font class="comment">/* major version */</font>
00386   3,                                           <font class="comment">/* minor version */</font>
00387   <a class="code" href="vmdplugin_8h.html#a12">VMDPLUGIN_THREADSAFE</a>,                        <font class="comment">/* is reentrant */</font>
00388   <font class="stringliteral">"car"</font>,
00389   <a class="code" href="carplugin_8c.html#a7">open_car_read</a>,
00390   <a class="code" href="carplugin_8c.html#a8">read_car_structure</a>,
00391   0,
00392   <a class="code" href="carplugin_8c.html#a9">read_car_timestep</a>,
00393   <a class="code" href="carplugin_8c.html#a10">close_car_read</a>,
00394 };
00395 
<a name="l00396"></a><a class="code" href="carplugin_8c.html#a11">00396</a> <a class="code" href="vmdplugin_8h.html#a7">VMDPLUGIN_API</a> <font class="keywordtype">int</font> <a class="code" href="vmdplugin_8h.html#a5">VMDPLUGIN_init</a>() {
00397   <font class="keywordflow">return</font> <a class="code" href="vmdplugin_8h.html#a13">VMDPLUGIN_SUCCESS</a>;
00398 }
00399 
<a name="l00400"></a><a class="code" href="carplugin_8c.html#a12">00400</a> <a class="code" href="vmdplugin_8h.html#a7">VMDPLUGIN_API</a> <font class="keywordtype">int</font> <a class="code" href="vmdplugin_8h.html#a3">VMDPLUGIN_register</a>(<font class="keywordtype">void</font> *v, <a class="code" href="vmdplugin_8h.html#a15">vmdplugin_register_cb</a> cb) {
00401   (*cb)(v, (<a class="code" href="structvmdplugin__t.html">vmdplugin_t</a> *)&amp;carplugin);
00402   <font class="keywordflow">return</font> <a class="code" href="vmdplugin_8h.html#a13">VMDPLUGIN_SUCCESS</a>;
00403 }
00404 
<a name="l00405"></a><a class="code" href="carplugin_8c.html#a13">00405</a> <a class="code" href="vmdplugin_8h.html#a7">VMDPLUGIN_API</a> <font class="keywordtype">int</font> <a class="code" href="vmdplugin_8h.html#a6">VMDPLUGIN_fini</a>() {
00406   <font class="keywordflow">return</font> <a class="code" href="vmdplugin_8h.html#a13">VMDPLUGIN_SUCCESS</a>;
00407 }
00408 
</pre></div><hr><address><small>Generated on Wed Mar 22 13:15:28 2006 for VMD Plugins (current) by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.gif" alt="doxygen" align="middle" border=0 
width=110 height=53></a>1.2.14 written by <a href="mailto:dimitri@stack.nl">Dimitri van Heesch</a>,
 &copy;&nbsp;1997-2002</small></address>
</body>
</html>
