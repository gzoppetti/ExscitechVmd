<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>cdfplugin.c Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.2.14 -->
<center>
<a class="qindex" href="index.html">Main Page</a> &nbsp; <a class="qindex" href="classes.html">Alphabetical List</a> &nbsp; <a class="qindex" href="annotated.html">Compound List</a> &nbsp; <a class="qindex" href="files.html">File List</a> &nbsp; <a class="qindex" href="functions.html">Compound Members</a> &nbsp; <a class="qindex" href="globals.html">File Members</a> &nbsp; <a class="qindex" href="pages.html">Related Pages</a> &nbsp; </center>
<hr><h1>cdfplugin.c</h1><a href="cdfplugin_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 <font class="comment">/***************************************************************************</font>
00002 <font class="comment"> *cr</font>
00003 <font class="comment"> *cr            (C) Copyright 1995-2006 The Board of Trustees of the</font>
00004 <font class="comment"> *cr                        University of Illinois</font>
00005 <font class="comment"> *cr                         All Rights Reserved</font>
00006 <font class="comment"> *cr</font>
00007 <font class="comment"> ***************************************************************************/</font>
00008 
00009 <font class="comment">/***************************************************************************</font>
00010 <font class="comment"> * RCS INFORMATION:</font>
00011 <font class="comment"> *</font>
00012 <font class="comment"> *      $RCSfile: cdfplugin.c,v $</font>
00013 <font class="comment"> *      $Author: johns $       $Locker:  $             $State: Exp $</font>
00014 <font class="comment"> *      $Revision: 1.16 $       $Date: 2006/03/22 19:08:22 $</font>
00015 <font class="comment"> *</font>
00016 <font class="comment"> ***************************************************************************/</font>
00017 
00018 <font class="comment">/*</font>
00019 <font class="comment"> * NetCDF based trajectories, used by AMBER 9, MMTK, etc.</font>
00020 <font class="comment"> */</font>
00021 
00022 <font class="preprocessor">#include &lt;netcdf.h&gt;</font>
00023 <font class="preprocessor">#include &lt;stdio.h&gt;</font>
00024 <font class="preprocessor">#include &lt;stdlib.h&gt;</font>
00025 <font class="preprocessor">#include &lt;string.h&gt;</font>
00026 <font class="preprocessor">#include &lt;ctype.h&gt;</font>
00027 <font class="preprocessor">#include "<a class="code" href="molfile__plugin_8h.html">molfile_plugin.h</a>"</font>
00028 
<a name="l00029"></a><a class="code" href="cdfplugin_8c.html#a0">00029</a> <font class="preprocessor">#define CDF_TYPE_UNKNOWN 0</font>
<a name="l00030"></a><a class="code" href="cdfplugin_8c.html#a1">00030</a> <font class="preprocessor"></font><font class="preprocessor">#define CDF_TYPE_AMBER   1</font>
<a name="l00031"></a><a class="code" href="cdfplugin_8c.html#a2">00031</a> <font class="preprocessor"></font><font class="preprocessor">#define CDF_TYPE_MMTK    2</font>
00032 <font class="preprocessor"></font>
<a name="l00033"></a><a class="code" href="structmmtkdata.html">00033</a> <font class="keyword">typedef</font> <font class="keyword">struct </font>{
<a name="l00034"></a><a class="code" href="structmmtkdata.html#m0">00034</a>   <font class="keywordtype">int</font> step_numberdimid;
<a name="l00035"></a><a class="code" href="structmmtkdata.html#m1">00035</a>   size_t step_numberdim;
<a name="l00036"></a><a class="code" href="structmmtkdata.html#m2">00036</a>   <font class="keywordtype">int</font> minor_step_numberdimid;
<a name="l00037"></a><a class="code" href="structmmtkdata.html#m3">00037</a>   size_t minor_step_numberdim;
<a name="l00038"></a><a class="code" href="structmmtkdata.html#m4">00038</a>   <font class="keywordtype">int</font> atom_numberdimid;
<a name="l00039"></a><a class="code" href="structmmtkdata.html#m5">00039</a>   size_t atom_numberdim;
<a name="l00040"></a><a class="code" href="structmmtkdata.html#m6">00040</a>   <font class="keywordtype">int</font> xyzdimid;
<a name="l00041"></a><a class="code" href="structmmtkdata.html#m7">00041</a>   size_t xyzdim;
<a name="l00042"></a><a class="code" href="structmmtkdata.html#m8">00042</a>   <font class="keywordtype">int</font> box_size_lengthdimid;
<a name="l00043"></a><a class="code" href="structmmtkdata.html#m9">00043</a>   size_t box_size_lengthdim;
<a name="l00044"></a><a class="code" href="structmmtkdata.html#m10">00044</a>   <font class="keywordtype">int</font> description_lengthdimid;
<a name="l00045"></a><a class="code" href="structmmtkdata.html#m11">00045</a>   size_t description_lengthdim;
<a name="l00046"></a><a class="code" href="structmmtkdata.html#m12">00046</a>   <font class="keywordtype">char</font> *description;
<a name="l00047"></a><a class="code" href="structmmtkdata.html#m13">00047</a>   <font class="keywordtype">int</font> description_id;
<a name="l00048"></a><a class="code" href="structmmtkdata.html#m14">00048</a>   <font class="keywordtype">int</font> step_id;
<a name="l00049"></a><a class="code" href="structmmtkdata.html#m15">00049</a>   <font class="keywordtype">int</font> time_id;
<a name="l00050"></a><a class="code" href="structmmtkdata.html#m16">00050</a>   <font class="keywordtype">int</font> box_size_id;
<a name="l00051"></a><a class="code" href="structmmtkdata.html#m17">00051</a>   <font class="keywordtype">int</font> configuration_id;
<a name="l00052"></a><a class="code" href="structmmtkdata.html#m18">00052</a>   <font class="keywordtype">int</font> has_box;
<a name="l00053"></a><a class="code" href="structmmtkdata.html#m19">00053</a>   <font class="keywordtype">char</font> *comment;
00054 } <a class="code" href="structmmtkdata.html">mmtkdata</a>;
00055 
<a name="l00056"></a><a class="code" href="structamberdata.html">00056</a> <font class="keyword">typedef</font> <font class="keyword">struct </font>{
<a name="l00057"></a><a class="code" href="structamberdata.html#m0">00057</a>   <font class="keywordtype">int</font> has_box;
<a name="l00058"></a><a class="code" href="structamberdata.html#m1">00058</a>   <font class="keywordtype">int</font> atomdimid;
<a name="l00059"></a><a class="code" href="structamberdata.html#m2">00059</a>   size_t atomdim;
<a name="l00060"></a><a class="code" href="structamberdata.html#m3">00060</a>   <font class="keywordtype">int</font> spatialdimid;
<a name="l00061"></a><a class="code" href="structamberdata.html#m4">00061</a>   size_t spatialdim;
<a name="l00062"></a><a class="code" href="structamberdata.html#m5">00062</a>   <font class="keywordtype">int</font> framedimid;
<a name="l00063"></a><a class="code" href="structamberdata.html#m6">00063</a>   size_t framedim;
<a name="l00064"></a><a class="code" href="structamberdata.html#m7">00064</a>   <font class="keywordtype">char</font> *conventionversion;
<a name="l00065"></a><a class="code" href="structamberdata.html#m8">00065</a>   <font class="keywordtype">char</font> *title;
<a name="l00066"></a><a class="code" href="structamberdata.html#m9">00066</a>   <font class="keywordtype">char</font> *application;
<a name="l00067"></a><a class="code" href="structamberdata.html#m10">00067</a>   <font class="keywordtype">char</font> *program;
<a name="l00068"></a><a class="code" href="structamberdata.html#m11">00068</a>   <font class="keywordtype">char</font> *programversion;
<a name="l00069"></a><a class="code" href="structamberdata.html#m12">00069</a>   <font class="keywordtype">int</font> spatial_id;      <font class="comment">/* "xyz" */</font>
<a name="l00070"></a><a class="code" href="structamberdata.html#m13">00070</a>   <font class="keywordtype">int</font> time_id;         <font class="comment">/* frame time in picoseconds */</font>
<a name="l00071"></a><a class="code" href="structamberdata.html#m14">00071</a>   <font class="keywordtype">int</font> coordinates_id;  <font class="comment">/* coords in angstroms */</font>
<a name="l00072"></a><a class="code" href="structamberdata.html#m15">00072</a>   <font class="keywordtype">int</font> cell_lengths_id; <font class="comment">/* cell lengths in angstroms */</font>
<a name="l00073"></a><a class="code" href="structamberdata.html#m16">00073</a>   <font class="keywordtype">int</font> cell_angles_id;  <font class="comment">/* cell angles in degrees */</font>
<a name="l00074"></a><a class="code" href="structamberdata.html#m17">00074</a>   <font class="keywordtype">int</font> velocities_id;   <font class="comment">/* velocities in angstroms/picosecond */</font>
00075 } <a class="code" href="structamberdata.html">amberdata</a>;
00076 
00077 
<a name="l00078"></a><a class="code" href="structcdfdata.html">00078</a> <font class="keyword">typedef</font> <font class="keyword">struct </font>{
00079   <font class="comment">/* sub-format independent data */</font>
<a name="l00080"></a><a class="code" href="structcdfdata.html#m0">00080</a>   <font class="keywordtype">int</font> ncid;
<a name="l00081"></a><a class="code" href="structcdfdata.html#m1">00081</a>   <font class="keywordtype">int</font> type;
<a name="l00082"></a><a class="code" href="structcdfdata.html#m2">00082</a>   <font class="keywordtype">int</font> natoms; 
<a name="l00083"></a><a class="code" href="structcdfdata.html#m3">00083</a>   <font class="keywordtype">int</font> curframe;
<a name="l00084"></a><a class="code" href="structcdfdata.html#m4">00084</a>   <font class="keywordtype">char</font> *conventions;
00085 
00086   <font class="comment">/* stuff used by AMBER */</font>
<a name="l00087"></a><a class="code" href="structcdfdata.html#m5">00087</a>   <a class="code" href="structamberdata.html">amberdata</a> amber;
00088 
00089   <font class="comment">/* stuff used by MMTK */</font>
<a name="l00090"></a><a class="code" href="structcdfdata.html#m6">00090</a>   <a class="code" href="structmmtkdata.html">mmtkdata</a> mmtk;
00091 
00092 } <a class="code" href="structcdfdata.html">cdfdata</a>;
00093 
00094 
<a name="l00095"></a><a class="code" href="cdfplugin_8c.html#a4">00095</a> <font class="keyword">static</font> <font class="keywordtype">void</font> <a class="code" href="cdfplugin_8c.html#a4">close_cdf_read</a>(<font class="keywordtype">void</font> *mydata) {
00096   <a class="code" href="structcdfdata.html">cdfdata</a> *cdf = (<a class="code" href="structcdfdata.html">cdfdata</a> *)mydata;
00097 
00098   nc_close(cdf-&gt;<a class="code" href="structcdfdata.html#m0">ncid</a>);
00099 
00100   <font class="comment">/* AMBER stuff */</font>
00101   <font class="keywordflow">if</font> (cdf-&gt;<a class="code" href="structcdfdata.html#m5">amber</a>.<a class="code" href="structamberdata.html#m8">title</a>)
00102     free(cdf-&gt;<a class="code" href="structcdfdata.html#m5">amber</a>.<a class="code" href="structamberdata.html#m8">title</a>);
00103 
00104   <font class="keywordflow">if</font> (cdf-&gt;<a class="code" href="structcdfdata.html#m5">amber</a>.<a class="code" href="structamberdata.html#m9">application</a>)
00105     free(cdf-&gt;<a class="code" href="structcdfdata.html#m5">amber</a>.<a class="code" href="structamberdata.html#m9">application</a>);
00106 
00107   <font class="keywordflow">if</font> (cdf-&gt;<a class="code" href="structcdfdata.html#m5">amber</a>.<a class="code" href="structamberdata.html#m10">program</a>)
00108     free(cdf-&gt;<a class="code" href="structcdfdata.html#m5">amber</a>.<a class="code" href="structamberdata.html#m10">program</a>);
00109 
00110   <font class="keywordflow">if</font> (cdf-&gt;<a class="code" href="structcdfdata.html#m5">amber</a>.<a class="code" href="structamberdata.html#m11">programversion</a>)
00111     free(cdf-&gt;<a class="code" href="structcdfdata.html#m5">amber</a>.<a class="code" href="structamberdata.html#m11">programversion</a>);
00112 
00113   <font class="keywordflow">if</font> (cdf-&gt;<a class="code" href="structcdfdata.html#m5">amber</a>.<a class="code" href="structamberdata.html#m7">conventionversion</a>)
00114     free(cdf-&gt;<a class="code" href="structcdfdata.html#m5">amber</a>.<a class="code" href="structamberdata.html#m7">conventionversion</a>);
00115 
00116   <font class="comment">/* MMTK stuff */</font>
00117   <font class="keywordflow">if</font> (cdf-&gt;<a class="code" href="structcdfdata.html#m6">mmtk</a>.<a class="code" href="structmmtkdata.html#m19">comment</a>)
00118     free(cdf-&gt;<a class="code" href="structcdfdata.html#m6">mmtk</a>.<a class="code" href="structmmtkdata.html#m19">comment</a>);
00119 
00120   <font class="comment">/* format independent stuff */</font>
00121   <font class="keywordflow">if</font> (cdf-&gt;<a class="code" href="structcdfdata.html#m4">conventions</a>)
00122     free(cdf-&gt;<a class="code" href="structcdfdata.html#m4">conventions</a>);
00123 
00124   free(cdf);
00125 }
00126 
00127 
00128 
<a name="l00129"></a><a class="code" href="cdfplugin_8c.html#a5">00129</a> <font class="keyword">static</font> <font class="keywordtype">int</font> <a class="code" href="cdfplugin_8c.html#a5">open_amber_cdf_read</a>(<a class="code" href="structcdfdata.html">cdfdata</a> *cdf) {
00130   <font class="keywordtype">int</font> rc;
00131   size_t len; 
00132   <a class="code" href="structamberdata.html">amberdata</a> *amber = &amp;cdf-&gt;<a class="code" href="structcdfdata.html#m5">amber</a>;
00133 
00134   <font class="comment">/* global attrib: "ConventionVersion" -- required */</font>
00135   rc = nc_inq_attlen(cdf-&gt;<a class="code" href="structcdfdata.html#m0">ncid</a>, NC_GLOBAL, <font class="stringliteral">"ConventionVersion"</font>, &amp;len);
00136   <font class="keywordflow">if</font> (rc == NC_NOERR &amp;&amp; len &gt; 0) {
00137     amber-&gt;<a class="code" href="structamberdata.html#m7">conventionversion</a> = (<font class="keywordtype">char</font> *) malloc((len+1) * <font class="keyword">sizeof</font>(<font class="keywordtype">char</font>));
00138     nc_get_att_text(cdf-&gt;<a class="code" href="structcdfdata.html#m0">ncid</a>, NC_GLOBAL, <font class="stringliteral">"ConventionVersion"</font>, amber-&gt;<a class="code" href="structamberdata.html#m7">conventionversion</a>);
00139     amber-&gt;<a class="code" href="structamberdata.html#m7">conventionversion</a>[len] = <font class="charliteral">'\0'</font>;
00140     printf(<font class="stringliteral">"cdfplugin) trajectory follows AMBER conventions version %s\n"</font>, amber-&gt;<a class="code" href="structamberdata.html#m7">conventionversion</a>);
00141   } <font class="keywordflow">else</font> {
00142     <font class="keywordflow">return</font> -1;
00143   }
00144 
00145   <font class="comment">/* at this point we know that this is an AMBER trajectory */</font>
00146   cdf-&gt;<a class="code" href="structcdfdata.html#m1">type</a> = <a class="code" href="cdfplugin_8c.html#a1">CDF_TYPE_AMBER</a>;
00147 
00148   <font class="comment">/* global attrib: "program" -- required */</font>
00149   rc = nc_inq_attlen(cdf-&gt;<a class="code" href="structcdfdata.html#m0">ncid</a>, NC_GLOBAL, <font class="stringliteral">"program"</font>, &amp;len);
00150   <font class="keywordflow">if</font> (rc == NC_NOERR &amp;&amp; len &gt; 0) {
00151     amber-&gt;<a class="code" href="structamberdata.html#m10">program</a> = (<font class="keywordtype">char</font> *) malloc((len+1) * <font class="keyword">sizeof</font>(<font class="keywordtype">char</font>));
00152     nc_get_att_text(cdf-&gt;<a class="code" href="structcdfdata.html#m0">ncid</a>, NC_GLOBAL, <font class="stringliteral">"program"</font>, amber-&gt;<a class="code" href="structamberdata.html#m10">program</a>);
00153     amber-&gt;<a class="code" href="structamberdata.html#m10">program</a>[len] = <font class="charliteral">'\0'</font>;
00154     printf(<font class="stringliteral">"cdfplugin) program %s\n"</font>, amber-&gt;<a class="code" href="structamberdata.html#m10">program</a>);
00155   } <font class="keywordflow">else</font> {
00156     <font class="keywordflow">return</font> -1;
00157   }
00158 
00159 
00160   <font class="comment">/* global attrib: "programVersion" -- required */</font>
00161   rc = nc_inq_attlen(cdf-&gt;<a class="code" href="structcdfdata.html#m0">ncid</a>, NC_GLOBAL, <font class="stringliteral">"programVersion"</font>, &amp;len);
00162   <font class="keywordflow">if</font> (rc == NC_NOERR &amp;&amp; len &gt; 0) {
00163     amber-&gt;<a class="code" href="structamberdata.html#m11">programversion</a> = (<font class="keywordtype">char</font> *) malloc((len+1) * <font class="keyword">sizeof</font>(<font class="keywordtype">char</font>));
00164     nc_get_att_text(cdf-&gt;<a class="code" href="structcdfdata.html#m0">ncid</a>, NC_GLOBAL, <font class="stringliteral">"programVersion"</font>, amber-&gt;<a class="code" href="structamberdata.html#m11">programversion</a>);
00165     amber-&gt;<a class="code" href="structamberdata.html#m11">programversion</a>[len] = <font class="charliteral">'\0'</font>;
00166     printf(<font class="stringliteral">"cdfplugin) program version %s\n"</font>, amber-&gt;<a class="code" href="structamberdata.html#m11">programversion</a>);
00167   } <font class="keywordflow">else</font> {
00168     <font class="keywordflow">return</font> -1;
00169   }
00170 
00171 
00172   <font class="comment">/* global attrib: "title" -- optional */</font>
00173   rc = nc_inq_attlen(cdf-&gt;<a class="code" href="structcdfdata.html#m0">ncid</a>, NC_GLOBAL, <font class="stringliteral">"title"</font>, &amp;len);
00174   <font class="keywordflow">if</font> (rc == NC_NOERR &amp;&amp; len &gt; 0) {
00175     amber-&gt;<a class="code" href="structamberdata.html#m8">title</a> = (<font class="keywordtype">char</font> *) malloc((len+1) * <font class="keyword">sizeof</font>(<font class="keywordtype">char</font>));
00176     nc_get_att_text(cdf-&gt;<a class="code" href="structcdfdata.html#m0">ncid</a>, NC_GLOBAL, <font class="stringliteral">"title"</font>, amber-&gt;<a class="code" href="structamberdata.html#m8">title</a>);
00177     amber-&gt;<a class="code" href="structamberdata.html#m8">title</a>[len] = <font class="charliteral">'\0'</font>;
00178     printf(<font class="stringliteral">"cdfplugin) title: %s\n"</font>, amber-&gt;<a class="code" href="structamberdata.html#m8">title</a>);
00179   } 
00180 
00181 
00182   <font class="comment">/* global attrib: "application" -- optional */</font>
00183   rc = nc_inq_attlen(cdf-&gt;<a class="code" href="structcdfdata.html#m0">ncid</a>, NC_GLOBAL, <font class="stringliteral">"application"</font>, &amp;len);
00184   <font class="keywordflow">if</font> (rc == NC_NOERR &amp;&amp; len &gt; 0) {
00185     amber-&gt;<a class="code" href="structamberdata.html#m9">application</a> = (<font class="keywordtype">char</font> *) malloc((len+1) * <font class="keyword">sizeof</font>(<font class="keywordtype">char</font>));
00186     nc_get_att_text(cdf-&gt;<a class="code" href="structcdfdata.html#m0">ncid</a>, NC_GLOBAL, <font class="stringliteral">"application"</font>, amber-&gt;<a class="code" href="structamberdata.html#m9">application</a>);
00187     amber-&gt;<a class="code" href="structamberdata.html#m9">application</a>[len] = <font class="charliteral">'\0'</font>;
00188     printf(<font class="stringliteral">"cdfplugin) application %s\n"</font>, amber-&gt;<a class="code" href="structamberdata.html#m9">application</a>);
00189   } 
00190 
00191 
00192 <font class="comment">/* XXX lots of additional error checking is needed below... */</font>
00193 
00194   <font class="comment">/* read in spatial dimension */</font>
00195   rc = nc_inq_dimid(cdf-&gt;<a class="code" href="structcdfdata.html#m0">ncid</a>, <font class="stringliteral">"spatial"</font>, &amp;amber-&gt;<a class="code" href="structamberdata.html#m3">spatialdimid</a>);
00196   <font class="keywordflow">if</font> (rc == NC_NOERR) {    
00197     rc = nc_inq_dimlen(cdf-&gt;<a class="code" href="structcdfdata.html#m0">ncid</a>, amber-&gt;<a class="code" href="structamberdata.html#m3">spatialdimid</a>, &amp;amber-&gt;<a class="code" href="structamberdata.html#m4">spatialdim</a>);
00198     <font class="keywordflow">if</font> (rc == NC_NOERR)
00199       printf(<font class="stringliteral">"cdfplugin) spatial dimension: %ld\n"</font>, (<font class="keywordtype">long</font>)amber-&gt;<a class="code" href="structamberdata.html#m4">spatialdim</a>);
00200     <font class="keywordflow">else</font> 
00201       <font class="keywordflow">return</font> -1;
00202   } <font class="keywordflow">else</font> {
00203     <font class="keywordflow">return</font> -1;
00204   }
00205  
00206   <font class="comment">/* read in atom dimension */</font>
00207   rc = nc_inq_dimid(cdf-&gt;<a class="code" href="structcdfdata.html#m0">ncid</a>, <font class="stringliteral">"atom"</font>, &amp;amber-&gt;<a class="code" href="structamberdata.html#m1">atomdimid</a>);
00208   <font class="keywordflow">if</font> (rc == NC_NOERR) {    
00209     rc = nc_inq_dimlen(cdf-&gt;<a class="code" href="structcdfdata.html#m0">ncid</a>, amber-&gt;<a class="code" href="structamberdata.html#m1">atomdimid</a>, &amp;amber-&gt;<a class="code" href="structamberdata.html#m2">atomdim</a>);
00210     <font class="keywordflow">if</font> (rc == NC_NOERR) {
00211       printf(<font class="stringliteral">"cdfplugin) atom dimension: %ld\n"</font>, (<font class="keywordtype">long</font>)amber-&gt;<a class="code" href="structamberdata.html#m2">atomdim</a>);
00212       cdf-&gt;<a class="code" href="structcdfdata.html#m2">natoms</a> = amber-&gt;<a class="code" href="structamberdata.html#m2">atomdim</a>; <font class="comment">/* copy to format independent part */</font>
00213     } <font class="keywordflow">else</font>  {
00214       <font class="keywordflow">return</font> -1;
00215     }
00216   } <font class="keywordflow">else</font> {
00217     <font class="keywordflow">return</font> -1;
00218   }
00219  
00220 
00221   <font class="comment">/* read in frame dimension */</font>
00222   rc = nc_inq_dimid(cdf-&gt;<a class="code" href="structcdfdata.html#m0">ncid</a>, <font class="stringliteral">"frame"</font>, &amp;amber-&gt;<a class="code" href="structamberdata.html#m5">framedimid</a>);
00223   <font class="keywordflow">if</font> (rc == NC_NOERR) {    
00224     rc = nc_inq_dimlen(cdf-&gt;<a class="code" href="structcdfdata.html#m0">ncid</a>, amber-&gt;<a class="code" href="structamberdata.html#m5">framedimid</a>, &amp;amber-&gt;<a class="code" href="structamberdata.html#m6">framedim</a>);
00225     <font class="keywordflow">if</font> (rc == NC_NOERR)
00226       printf(<font class="stringliteral">"cdfplugin) frame dimension: %ld\n"</font>, (<font class="keywordtype">long</font>)amber-&gt;<a class="code" href="structamberdata.html#m6">framedim</a>);
00227     <font class="keywordflow">else</font> 
00228       <font class="keywordflow">return</font> -1;
00229   } <font class="keywordflow">else</font> {
00230     <font class="keywordflow">return</font> -1;
00231   }
00232 
00233   <font class="comment">/* </font>
00234 <font class="comment">   * get ID values for all of the variables we're interested in </font>
00235 <font class="comment">   */</font>
00236 <font class="preprocessor">#if 0</font>
00237 <font class="preprocessor"></font>  <font class="comment">/* VMD can live without this, we're assuming it's always 3 */</font>
00238   rc = nc_inq_varid(cdf-&gt;<a class="code" href="structcdfdata.html#m0">ncid</a>, <font class="stringliteral">"spatial"</font>,       &amp;amber-&gt;<a class="code" href="structamberdata.html#m12">spatial_id</a>);
00239   <font class="keywordflow">if</font> (rc != NC_NOERR)
00240     <font class="keywordflow">return</font> -1;
00241 <font class="preprocessor">#endif</font>
00242 <font class="preprocessor"></font>
00243   <font class="comment">/* VMD requires coordinates at a minimum */</font>
00244   rc = nc_inq_varid(cdf-&gt;<a class="code" href="structcdfdata.html#m0">ncid</a>, <font class="stringliteral">"coordinates"</font>,   &amp;amber-&gt;<a class="code" href="structamberdata.html#m14">coordinates_id</a>);
00245   <font class="keywordflow">if</font> (rc != NC_NOERR)
00246     <font class="keywordflow">return</font> -1;
00247 
00248 <font class="preprocessor">#if 0</font>
00249 <font class="preprocessor"></font>  <font class="comment">/* we don't need velocities at this time */</font>
00250   rc = nc_inq_varid(cdf-&gt;<a class="code" href="structcdfdata.html#m0">ncid</a>, <font class="stringliteral">"velocities"</font>,    &amp;amber-&gt;<a class="code" href="structamberdata.html#m17">velocities_id</a>);
00251   <font class="keywordflow">if</font> (rc != NC_NOERR)
00252     <font class="keywordflow">return</font> -1;
00253 <font class="preprocessor">#endif</font>
00254 <font class="preprocessor"></font>
00255   <font class="comment">/* optional periodic cell info */</font>
00256   rc = nc_inq_varid(cdf-&gt;<a class="code" href="structcdfdata.html#m0">ncid</a>, <font class="stringliteral">"cell_lengths"</font>,  &amp;amber-&gt;<a class="code" href="structamberdata.html#m15">cell_lengths_id</a>);
00257   <font class="keywordflow">if</font> (rc == NC_NOERR) {
00258     rc = nc_inq_varid(cdf-&gt;<a class="code" href="structcdfdata.html#m0">ncid</a>, <font class="stringliteral">"cell_angles"</font>,   &amp;amber-&gt;<a class="code" href="structamberdata.html#m16">cell_angles_id</a>);
00259     <font class="keywordflow">if</font> (rc == NC_NOERR) {
00260       printf(<font class="stringliteral">"cdfplugin) trajectory contains periodic cell information\n"</font>);
00261       amber-&gt;<a class="code" href="structamberdata.html#m0">has_box</a> = 1;
00262     }
00263   }
00264 
00265   <font class="keywordflow">return</font> 0;
00266 }
00267 
00268 
<a name="l00269"></a><a class="code" href="cdfplugin_8c.html#a6">00269</a> <font class="keyword">static</font> <font class="keywordtype">int</font> <a class="code" href="cdfplugin_8c.html#a6">open_mmtk_cdf_read</a>(<a class="code" href="structcdfdata.html">cdfdata</a> *cdf) {
00270   <font class="keywordtype">int</font> rc;
00271   size_t len; 
00272   <a class="code" href="structmmtkdata.html">mmtkdata</a> *mmtk = &amp;cdf-&gt;<a class="code" href="structcdfdata.html#m6">mmtk</a>;
00273 
00274   <font class="comment">/* read in spatial dimension */</font>
00275   rc = nc_inq_dimid(cdf-&gt;<a class="code" href="structcdfdata.html#m0">ncid</a>, <font class="stringliteral">"xyz"</font>, &amp;mmtk-&gt;<a class="code" href="structmmtkdata.html#m6">xyzdimid</a>);
00276   <font class="keywordflow">if</font> (rc == NC_NOERR) {
00277     rc = nc_inq_dimlen(cdf-&gt;<a class="code" href="structcdfdata.html#m0">ncid</a>, mmtk-&gt;<a class="code" href="structmmtkdata.html#m6">xyzdimid</a>, &amp;mmtk-&gt;<a class="code" href="structmmtkdata.html#m7">xyzdim</a>);
00278     <font class="keywordflow">if</font> (rc == NC_NOERR)
00279       printf(<font class="stringliteral">"cdfplugin) xyz dimension: %ld\n"</font>, (<font class="keywordtype">long</font>)mmtk-&gt;<a class="code" href="structmmtkdata.html#m7">xyzdim</a>);
00280     <font class="keywordflow">else</font> 
00281       <font class="keywordflow">return</font> -1;
00282   } <font class="keywordflow">else</font> {
00283     <font class="keywordflow">return</font> -1;
00284   }
00285 
00286 
00287   <font class="comment">/* read in atom dimension */</font>
00288   rc = nc_inq_dimid(cdf-&gt;<a class="code" href="structcdfdata.html#m0">ncid</a>, <font class="stringliteral">"atom_number"</font>, &amp;mmtk-&gt;<a class="code" href="structmmtkdata.html#m4">atom_numberdimid</a>); 
00289   <font class="keywordflow">if</font> (rc == NC_NOERR) {
00290     rc = nc_inq_dimlen(cdf-&gt;<a class="code" href="structcdfdata.html#m0">ncid</a>, mmtk-&gt;<a class="code" href="structmmtkdata.html#m4">atom_numberdimid</a>, &amp;mmtk-&gt;<a class="code" href="structmmtkdata.html#m5">atom_numberdim</a>);
00291     <font class="keywordflow">if</font> (rc == NC_NOERR) {
00292       printf(<font class="stringliteral">"cdfplugin) atom_number dimension: %ld\n"</font>, (<font class="keywordtype">long</font>)mmtk-&gt;<a class="code" href="structmmtkdata.html#m5">atom_numberdim</a>);
00293       cdf-&gt;<a class="code" href="structcdfdata.html#m2">natoms</a> = mmtk-&gt;<a class="code" href="structmmtkdata.html#m5">atom_numberdim</a>; <font class="comment">/* copy to format independent part */</font>
00294     } <font class="keywordflow">else</font> {
00295       <font class="keywordflow">return</font> -1;
00296     }
00297   } <font class="keywordflow">else</font> {
00298     <font class="keywordflow">return</font> -1;
00299   }
00300 
00301 
00302   <font class="comment">/* read in frame dimension */</font>
00303   rc = nc_inq_dimid(cdf-&gt;<a class="code" href="structcdfdata.html#m0">ncid</a>, <font class="stringliteral">"step_number"</font>, &amp;mmtk-&gt;<a class="code" href="structmmtkdata.html#m0">step_numberdimid</a>);
00304   <font class="keywordflow">if</font> (rc == NC_NOERR) {
00305     rc = nc_inq_dimlen(cdf-&gt;<a class="code" href="structcdfdata.html#m0">ncid</a>, mmtk-&gt;<a class="code" href="structmmtkdata.html#m0">step_numberdimid</a>, &amp;mmtk-&gt;<a class="code" href="structmmtkdata.html#m1">step_numberdim</a>);
00306     <font class="keywordflow">if</font> (rc == NC_NOERR)
00307       printf(<font class="stringliteral">"cdfplugin) step_number dimension: %ld\n"</font>, (<font class="keywordtype">long</font>)mmtk-&gt;<a class="code" href="structmmtkdata.html#m1">step_numberdim</a>);
00308     <font class="keywordflow">else</font> 
00309       <font class="keywordflow">return</font> -1;
00310   } <font class="keywordflow">else</font> {
00311     <font class="keywordflow">return</font> -1;
00312   }
00313 
00314 
00315   <font class="comment">/* read in minor step number dimension */</font>
00316   rc = nc_inq_dimid(cdf-&gt;<a class="code" href="structcdfdata.html#m0">ncid</a>, <font class="stringliteral">"minor_step_number"</font>, &amp;mmtk-&gt;<a class="code" href="structmmtkdata.html#m2">minor_step_numberdimid</a>);
00317   <font class="keywordflow">if</font> (rc == NC_NOERR) {
00318     rc = nc_inq_dimlen(cdf-&gt;<a class="code" href="structcdfdata.html#m0">ncid</a>, mmtk-&gt;<a class="code" href="structmmtkdata.html#m2">minor_step_numberdimid</a>, &amp;mmtk-&gt;<a class="code" href="structmmtkdata.html#m3">minor_step_numberdim</a>);
00319     <font class="keywordflow">if</font> (rc == NC_NOERR)
00320       printf(<font class="stringliteral">"cdfplugin) minor_step_number dimension: %ld\n"</font>, (<font class="keywordtype">long</font>)mmtk-&gt;<a class="code" href="structmmtkdata.html#m3">minor_step_numberdim</a>);
00321     <font class="keywordflow">else</font> 
00322       <font class="keywordflow">return</font> -1;
00323   } <font class="keywordflow">else</font> <font class="keywordflow">if</font> (rc == NC_EBADDIM) {
00324     printf(<font class="stringliteral">"cdfplugin) no minor_step_number dimension\n"</font>);
00325     mmtk-&gt;<a class="code" href="structmmtkdata.html#m3">minor_step_numberdim</a> = 0;
00326   } <font class="keywordflow">else</font> {
00327     <font class="keywordflow">return</font> -1;
00328   }
00329 
00330 
00331   <font class="comment">/* read in description_length dimension */</font>
00332   rc = nc_inq_dimid(cdf-&gt;<a class="code" href="structcdfdata.html#m0">ncid</a>, <font class="stringliteral">"description_length"</font>, &amp;mmtk-&gt;<a class="code" href="structmmtkdata.html#m10">description_lengthdimid</a>); 
00333   <font class="keywordflow">if</font> (rc == NC_NOERR) {
00334     rc = nc_inq_dimlen(cdf-&gt;<a class="code" href="structcdfdata.html#m0">ncid</a>, mmtk-&gt;<a class="code" href="structmmtkdata.html#m10">description_lengthdimid</a>, &amp;mmtk-&gt;<a class="code" href="structmmtkdata.html#m11">description_lengthdim</a>);
00335     <font class="keywordflow">if</font> (rc == NC_NOERR)
00336       printf(<font class="stringliteral">"cdfplugin) description_length dimension: %ld\n"</font>, (<font class="keywordtype">long</font>)mmtk-&gt;<a class="code" href="structmmtkdata.html#m11">description_lengthdim</a>);
00337     <font class="keywordflow">else</font>
00338       <font class="keywordflow">return</font> -1;
00339   } <font class="keywordflow">else</font> {
00340     <font class="keywordflow">return</font> -1;
00341   }
00342 
00343 
00344   <font class="comment">/* get ID values for all of the variables we're interested in */</font>
00345   rc = nc_inq_varid(cdf-&gt;<a class="code" href="structcdfdata.html#m0">ncid</a>, <font class="stringliteral">"configuration"</font>, &amp;mmtk-&gt;<a class="code" href="structmmtkdata.html#m17">configuration_id</a>);
00346   <font class="keywordflow">if</font> (rc != NC_NOERR)
00347     <font class="keywordflow">return</font> -1;
00348 
00349   rc = nc_inq_varid(cdf-&gt;<a class="code" href="structcdfdata.html#m0">ncid</a>, <font class="stringliteral">"description"</font>, &amp;mmtk-&gt;<a class="code" href="structmmtkdata.html#m13">description_id</a>);
00350   <font class="keywordflow">if</font> (rc != NC_NOERR)
00351     <font class="keywordflow">return</font> -1;
00352 
00353   <font class="comment">/* check for PBC */</font>
00354   rc = nc_inq_varid(cdf-&gt;<a class="code" href="structcdfdata.html#m0">ncid</a>, <font class="stringliteral">"box_size"</font>, &amp;mmtk-&gt;<a class="code" href="structmmtkdata.html#m16">box_size_id</a>);
00355   <font class="keywordflow">if</font> (rc == NC_NOERR) {
00356     mmtk-&gt;<a class="code" href="structmmtkdata.html#m18">has_box</a> = 1;
00357     printf(<font class="stringliteral">"cdfplugin) system has periodic boundary conditions\n"</font>);
00358   }
00359   <font class="keywordflow">else</font> <font class="keywordflow">if</font> (rc == NC_ENOTVAR)
00360     mmtk-&gt;<a class="code" href="structmmtkdata.html#m18">has_box</a> = 0;
00361   <font class="keywordflow">else</font>
00362     <font class="keywordflow">return</font> -1;
00363 
00364 
00365   <font class="comment">/* global attrib: "comment" -- optional */</font>
00366   rc = nc_inq_attlen(cdf-&gt;<a class="code" href="structcdfdata.html#m0">ncid</a>, NC_GLOBAL, <font class="stringliteral">"comment"</font>, &amp;len);
00367   <font class="keywordflow">if</font> (rc == NC_NOERR &amp;&amp; len &gt; 0) {
00368     mmtk-&gt;<a class="code" href="structmmtkdata.html#m19">comment</a> = (<font class="keywordtype">char</font> *) malloc((len+1) * <font class="keyword">sizeof</font>(<font class="keywordtype">char</font>));
00369     nc_get_att_text(cdf-&gt;<a class="code" href="structcdfdata.html#m0">ncid</a>, NC_GLOBAL, <font class="stringliteral">"comment"</font>, mmtk-&gt;<a class="code" href="structmmtkdata.html#m19">comment</a>);
00370     mmtk-&gt;<a class="code" href="structmmtkdata.html#m19">comment</a>[len] = <font class="charliteral">'\0'</font>;
00371     printf(<font class="stringliteral">"cdfplugin) comment: %s\n"</font>, mmtk-&gt;<a class="code" href="structmmtkdata.html#m19">comment</a>);
00372   } 
00373 
00374   <font class="comment">/* at this point we know that this is an MMTK trajectory */</font>
00375   cdf-&gt;<a class="code" href="structcdfdata.html#m1">type</a> = <a class="code" href="cdfplugin_8c.html#a2">CDF_TYPE_MMTK</a>;
00376 
00377   printf(<font class="stringliteral">"cdfplugin) CDF file appears to be an MMTK trajectory\n"</font>);
00378 
00379   <font class="keywordflow">return</font> 0;
00380 }
00381 
00382  
<a name="l00383"></a><a class="code" href="cdfplugin_8c.html#a7">00383</a> <font class="keyword">static</font> <font class="keywordtype">void</font> *<a class="code" href="cdfplugin_8c.html#a7">open_cdf_read</a>(<font class="keyword">const</font> <font class="keywordtype">char</font> *filename, <font class="keyword">const</font> <font class="keywordtype">char</font> *filetype, 
00384                            <font class="keywordtype">int</font> *natoms) {
00385   <font class="keywordtype">int</font> ncid, rc;
00386   size_t len;
00387   <a class="code" href="structcdfdata.html">cdfdata</a> *cdf;
00388  
00389   rc = nc_open(filename, NC_NOWRITE, &amp;ncid);
00390   <font class="keywordflow">if</font> (rc != NC_NOERR) <font class="keywordflow">return</font> NULL;
00391 
00392   cdf = (<a class="code" href="structcdfdata.html">cdfdata</a> *) malloc(<font class="keyword">sizeof</font>(<a class="code" href="structcdfdata.html">cdfdata</a>));
00393   memset(cdf, 0, <font class="keyword">sizeof</font>(<a class="code" href="structcdfdata.html">cdfdata</a>));
00394 
00395   cdf-&gt;<a class="code" href="structcdfdata.html#m0">ncid</a> = ncid;
00396   cdf-&gt;<a class="code" href="structcdfdata.html#m1">type</a> = <a class="code" href="cdfplugin_8c.html#a0">CDF_TYPE_UNKNOWN</a>;
00397 
00398 
00399   <font class="comment">/* Determine what NetCDF conventions apply to this data, if any */</font>
00400   rc = nc_inq_attlen(cdf-&gt;<a class="code" href="structcdfdata.html#m0">ncid</a>, NC_GLOBAL, <font class="stringliteral">"Conventions"</font>, &amp;len);
00401   <font class="keywordflow">if</font> (rc == NC_NOERR &amp;&amp; len &gt; 0) {
00402     cdf-&gt;<a class="code" href="structcdfdata.html#m4">conventions</a> = (<font class="keywordtype">char</font> *) malloc((len+1) * <font class="keyword">sizeof</font>(<font class="keywordtype">char</font>));
00403     nc_get_att_text(cdf-&gt;<a class="code" href="structcdfdata.html#m0">ncid</a>, NC_GLOBAL, <font class="stringliteral">"Conventions"</font>, cdf-&gt;<a class="code" href="structcdfdata.html#m4">conventions</a>);
00404     cdf-&gt;<a class="code" href="structcdfdata.html#m4">conventions</a>[len] = <font class="charliteral">'\0'</font>;
00405     printf(<font class="stringliteral">"cdfplugin) conventions: '%s'\n"</font>, cdf-&gt;<a class="code" href="structcdfdata.html#m4">conventions</a>);
00406   } <font class="keywordflow">else</font> {
00407     printf(<font class="stringliteral">"cdfplugin) no conventions specified, unknown file structure\n"</font>);
00408   }
00409 
00410   <font class="comment">/* Check if this is a file generated by AMBER */</font>
00411   <font class="keywordflow">if</font> (cdf-&gt;<a class="code" href="structcdfdata.html#m4">conventions</a> != NULL &amp;&amp; strstr(<font class="stringliteral">"AMBER"</font>, cdf-&gt;<a class="code" href="structcdfdata.html#m4">conventions</a>) != NULL) {
00412     <font class="keywordflow">if</font> (!<a class="code" href="cdfplugin_8c.html#a5">open_amber_cdf_read</a>(cdf)) {
00413       *natoms = cdf-&gt;<a class="code" href="structcdfdata.html#m2">natoms</a>;
00414       <font class="keywordflow">return</font> cdf;
00415     }
00416   } 
00417 
00418   <font class="comment">/* If not AMBER, then maybe it's from MMTK */</font>
00419   <font class="keywordflow">if</font> (!<a class="code" href="cdfplugin_8c.html#a6">open_mmtk_cdf_read</a>(cdf)) {
00420     *natoms = cdf-&gt;<a class="code" href="structcdfdata.html#m2">natoms</a>;
00421     <font class="keywordflow">return</font> cdf;
00422   } 
00423 
00424   <font class="comment">/* if no conventions are recognized, then we free everything */</font>
00425   <font class="comment">/* and return failure                                        */</font>
00426   <a class="code" href="cdfplugin_8c.html#a4">close_cdf_read</a>(cdf);
00427 
00428   <font class="keywordflow">return</font> NULL; 
00429 }
00430 
00431 <font class="comment">/* A very basic bracket counter. It assumes that the expression</font>
00432 <font class="comment">   is syntactically correct. */</font>
<a name="l00433"></a><a class="code" href="cdfplugin_8c.html#a8">00433</a> <font class="keyword">static</font> <font class="keywordtype">char</font> *<a class="code" href="cdfplugin_8c.html#a8">find_closing_bracket</a>(<font class="keywordtype">char</font> *s) {
00434   <font class="keywordtype">int</font> count = 1;
00435   <font class="keywordflow">while</font> (*s &amp;&amp; count &gt; 0) {
00436     <font class="keywordflow">if</font> (*s == <font class="charliteral">'('</font> || *s == <font class="charliteral">'['</font>)
00437       count++;
00438     <font class="keywordflow">if</font> (*s == <font class="charliteral">')'</font> || *s == <font class="charliteral">']'</font>)
00439       count--;
00440     s++;
00441   }
00442   <font class="keywordflow">return</font> s;
00443 }
00444 
00445 <font class="comment">/* Simple string replacement routine for fixing atom names. */</font>
<a name="l00446"></a><a class="code" href="cdfplugin_8c.html#a9">00446</a> <font class="keyword">static</font> <font class="keywordtype">void</font> <a class="code" href="cdfplugin_8c.html#a9">atom_name_replace</a>(<font class="keywordtype">char</font> *<a class="code" href="xsfplugin_8C.html#a2">name</a>, <font class="keywordtype">char</font> *substring, <font class="keywordtype">char</font> letter) {
00447   <font class="keywordtype">char</font> *s = strstr(<a class="code" href="xsfplugin_8C.html#a2">name</a>, substring);
00448   <font class="keywordflow">if</font> (s != NULL) {
00449     *s = letter;
00450     strcpy(s+1, s+strlen(substring));
00451   }
00452 }
00453 
<a name="l00454"></a><a class="code" href="cdfplugin_8c.html#a10">00454</a> <font class="keyword">static</font> <font class="keywordtype">void</font> <a class="code" href="cdfplugin_8c.html#a10">atom_name_remove_underscores</a>(<font class="keywordtype">char</font> *<a class="code" href="xsfplugin_8C.html#a2">name</a>) {
00455   <font class="keywordtype">char</font> *s = <a class="code" href="xsfplugin_8C.html#a2">name</a>;
00456   <font class="keywordflow">while</font> (1) {
00457     s = strchr(s, <font class="charliteral">'_'</font>);
00458     <font class="keywordflow">if</font> (s == NULL)
00459       <font class="keywordflow">break</font>;
00460     strcpy(s, s+1);
00461   }
00462 }
00463 
00464 <font class="comment">/* Set chainid, resname, and resnum for a range of atoms</font>
00465 <font class="comment">   and fix atom names. */</font>
<a name="l00466"></a><a class="code" href="cdfplugin_8c.html#a11">00466</a> <font class="keyword">static</font> <font class="keywordtype">void</font> <a class="code" href="cdfplugin_8c.html#a11">set_atom_attributes</a>(<a class="code" href="structmolfile__atom__t.html">molfile_atom_t</a> *atoms, <font class="keywordtype">int</font> natoms,
00467                                 <font class="keywordtype">char</font> **atom_pointers, <font class="keywordtype">char</font> chain_id,
00468                                 <font class="keywordtype">char</font> *resname, <font class="keywordtype">int</font> resnum,
00469                                 <font class="keywordtype">char</font> *start, <font class="keywordtype">char</font> *end,
00470                                 <font class="keywordtype">int</font> name_correction_type) {
00471   <font class="keywordtype">int</font> i;
00472   <font class="keywordflow">for</font> (i=0; i&lt;natoms; i++)
00473     <font class="keywordflow">if</font> (atom_pointers[i] &gt; start &amp;&amp; atom_pointers[i] &lt; end) {
00474       <a class="code" href="structmolfile__atom__t.html">molfile_atom_t</a> *atom = atoms + i;
00475       atom-&gt;<a class="code" href="structmolfile__atom__t.html#m5">chain</a>[0] = chain_id;      
00476       atom-&gt;<a class="code" href="structmolfile__atom__t.html#m5">chain</a>[1] = <font class="charliteral">'\0'</font>;      
00477       strcpy(atom-&gt;<a class="code" href="structmolfile__atom__t.html#m2">resname</a>, resname);
00478       atom-&gt;<a class="code" href="structmolfile__atom__t.html#m3">resid</a> = resnum;
00479       <font class="keywordflow">if</font> (name_correction_type == 1 <font class="comment">/* proteins */</font>) {
00480         <a class="code" href="cdfplugin_8c.html#a9">atom_name_replace</a>(atom-&gt;<a class="code" href="structmolfile__atom__t.html#m0">name</a>, <font class="stringliteral">"_alpha"</font>, <font class="charliteral">'A'</font>);
00481         <a class="code" href="cdfplugin_8c.html#a9">atom_name_replace</a>(atom-&gt;<a class="code" href="structmolfile__atom__t.html#m0">name</a>, <font class="stringliteral">"_beta"</font>, <font class="charliteral">'B'</font>);
00482         <a class="code" href="cdfplugin_8c.html#a9">atom_name_replace</a>(atom-&gt;<a class="code" href="structmolfile__atom__t.html#m0">name</a>, <font class="stringliteral">"_gamma"</font>, <font class="charliteral">'G'</font>);
00483         <a class="code" href="cdfplugin_8c.html#a9">atom_name_replace</a>(atom-&gt;<a class="code" href="structmolfile__atom__t.html#m0">name</a>, <font class="stringliteral">"_delta"</font>, <font class="charliteral">'D'</font>);
00484         <a class="code" href="cdfplugin_8c.html#a9">atom_name_replace</a>(atom-&gt;<a class="code" href="structmolfile__atom__t.html#m0">name</a>, <font class="stringliteral">"_epsilon"</font>, <font class="charliteral">'E'</font>);
00485         <a class="code" href="cdfplugin_8c.html#a9">atom_name_replace</a>(atom-&gt;<a class="code" href="structmolfile__atom__t.html#m0">name</a>, <font class="stringliteral">"_zeta"</font>, <font class="charliteral">'Z'</font>);
00486         <a class="code" href="cdfplugin_8c.html#a9">atom_name_replace</a>(atom-&gt;<a class="code" href="structmolfile__atom__t.html#m0">name</a>, <font class="stringliteral">"_eta"</font>, <font class="charliteral">'H'</font>);
00487         <a class="code" href="cdfplugin_8c.html#a10">atom_name_remove_underscores</a>(atom-&gt;<a class="code" href="structmolfile__atom__t.html#m0">name</a>);
00488       }
00489       <font class="keywordflow">else</font> <font class="keywordflow">if</font> (name_correction_type == 2 <font class="comment">/* nucleic acids */</font>) {
00490         <font class="keywordflow">if</font> (strcmp(atom-&gt;<a class="code" href="structmolfile__atom__t.html#m0">name</a>, <font class="stringliteral">"O_1"</font>) == 0)
00491           strcpy(atom-&gt;<a class="code" href="structmolfile__atom__t.html#m0">name</a>, <font class="stringliteral">"O1P"</font>);
00492         <font class="keywordflow">else</font> <font class="keywordflow">if</font> (strcmp(atom-&gt;<a class="code" href="structmolfile__atom__t.html#m0">name</a>, <font class="stringliteral">"O_2"</font>) == 0)
00493           strcpy(atom-&gt;<a class="code" href="structmolfile__atom__t.html#m0">name</a>, <font class="stringliteral">"O2P"</font>);
00494         <font class="keywordflow">else</font> <font class="keywordflow">if</font> (strcmp(atom-&gt;<a class="code" href="structmolfile__atom__t.html#m0">name</a>, <font class="stringliteral">"C_1"</font>) == 0)
00495           strcpy(atom-&gt;<a class="code" href="structmolfile__atom__t.html#m0">name</a>, <font class="stringliteral">"C1'"</font>);
00496         <font class="keywordflow">else</font> <font class="keywordflow">if</font> (strcmp(atom-&gt;<a class="code" href="structmolfile__atom__t.html#m0">name</a>, <font class="stringliteral">"C_2"</font>) == 0)
00497           strcpy(atom-&gt;<a class="code" href="structmolfile__atom__t.html#m0">name</a>, <font class="stringliteral">"C2'"</font>);
00498         <font class="keywordflow">else</font> <font class="keywordflow">if</font> (strcmp(atom-&gt;<a class="code" href="structmolfile__atom__t.html#m0">name</a>, <font class="stringliteral">"C_3"</font>) == 0)
00499           strcpy(atom-&gt;<a class="code" href="structmolfile__atom__t.html#m0">name</a>, <font class="stringliteral">"C3'"</font>);
00500         <font class="keywordflow">else</font> <font class="keywordflow">if</font> (strcmp(atom-&gt;<a class="code" href="structmolfile__atom__t.html#m0">name</a>, <font class="stringliteral">"O_3"</font>) == 0)
00501           strcpy(atom-&gt;<a class="code" href="structmolfile__atom__t.html#m0">name</a>, <font class="stringliteral">"O3'"</font>);
00502         <font class="keywordflow">else</font> <font class="keywordflow">if</font> (strcmp(atom-&gt;<a class="code" href="structmolfile__atom__t.html#m0">name</a>, <font class="stringliteral">"C_4"</font>) == 0)
00503           strcpy(atom-&gt;<a class="code" href="structmolfile__atom__t.html#m0">name</a>, <font class="stringliteral">"C4'"</font>);
00504         <font class="keywordflow">else</font> <font class="keywordflow">if</font> (strcmp(atom-&gt;<a class="code" href="structmolfile__atom__t.html#m0">name</a>, <font class="stringliteral">"O_4"</font>) == 0)
00505           strcpy(atom-&gt;<a class="code" href="structmolfile__atom__t.html#m0">name</a>, <font class="stringliteral">"O4'"</font>);
00506         <font class="keywordflow">else</font> <font class="keywordflow">if</font> (strcmp(atom-&gt;<a class="code" href="structmolfile__atom__t.html#m0">name</a>, <font class="stringliteral">"C_5"</font>) == 0)
00507           strcpy(atom-&gt;<a class="code" href="structmolfile__atom__t.html#m0">name</a>, <font class="stringliteral">"C5'"</font>);
00508         <font class="keywordflow">else</font> <font class="keywordflow">if</font> (strcmp(atom-&gt;<a class="code" href="structmolfile__atom__t.html#m0">name</a>, <font class="stringliteral">"O_5"</font>) == 0)
00509           strcpy(atom-&gt;<a class="code" href="structmolfile__atom__t.html#m0">name</a>, <font class="stringliteral">"O5'"</font>);
00510       }
00511     }
00512 }
00513 
00514 <font class="comment">/* Get structure from an MMTK trajectory file */</font>
<a name="l00515"></a><a class="code" href="cdfplugin_8c.html#a12">00515</a> <font class="keyword">static</font> <font class="keywordtype">int</font> <a class="code" href="cdfplugin_8c.html#a12">read_mmtk_cdf_structure</a>(<font class="keywordtype">void</font> *mydata, <font class="keywordtype">int</font> *optflags,
00516                                    <a class="code" href="structmolfile__atom__t.html">molfile_atom_t</a> *atoms) {
00517   <font class="keywordtype">int</font> i, rc;
00518   <a class="code" href="structmolfile__atom__t.html">molfile_atom_t</a> *atom;
00519   <a class="code" href="structcdfdata.html">cdfdata</a> *cdf = (<a class="code" href="structcdfdata.html">cdfdata</a> *) mydata;
00520   <a class="code" href="structmmtkdata.html">mmtkdata</a> *mmtk = &amp;cdf-&gt;<a class="code" href="structcdfdata.html#m6">mmtk</a>;
00521   size_t start[3], count[3];
00522   <font class="keywordtype">char</font> *dstr;
00523   <font class="keywordtype">char</font> **atom_pointers;
00524   <font class="keywordtype">int</font> resnum;
00525   <font class="keywordtype">char</font> resname[8];
00526 
00527   *optflags = <a class="code" href="molfile__plugin_8h.html#a8">MOLFILE_NOOPTIONS</a>;
00528 
00529   mmtk-&gt;<a class="code" href="structmmtkdata.html#m12">description</a> = (<font class="keywordtype">char</font> *) malloc((mmtk-&gt;<a class="code" href="structmmtkdata.html#m11">description_lengthdim</a> + 1) * <font class="keyword">sizeof</font>(<font class="keywordtype">char</font>));
00530   <font class="keywordflow">if</font> (mmtk-&gt;<a class="code" href="structmmtkdata.html#m12">description</a> == NULL) 
00531     <font class="keywordflow">return</font> <a class="code" href="molfile__plugin_8h.html#a4">MOLFILE_ERROR</a>;
00532 
00533   start[0] = cdf-&gt;<a class="code" href="structcdfdata.html#m3">curframe</a>; <font class="comment">/* frame */</font>
00534   count[0] = mmtk-&gt;<a class="code" href="structmmtkdata.html#m11">description_lengthdim</a>;
00535 
00536   rc = nc_get_vara_text(cdf-&gt;<a class="code" href="structcdfdata.html#m0">ncid</a>, mmtk-&gt;<a class="code" href="structmmtkdata.html#m13">description_id</a>,
00537                         start, count, mmtk-&gt;<a class="code" href="structmmtkdata.html#m12">description</a>);
00538   <font class="keywordflow">if</font> (rc != NC_NOERR)
00539     <font class="keywordflow">return</font> <a class="code" href="molfile__plugin_8h.html#a4">MOLFILE_ERROR</a>;
00540 
00541   <font class="comment">/* initialize all atoms with name "X" to start with */</font>
00542   <font class="comment">/* indicating unknown atom types etc..              */</font>
00543   <font class="keywordflow">for</font> (i=0; i&lt;cdf-&gt;<a class="code" href="structcdfdata.html#m2">natoms</a>; i++) {
00544     atom = atoms + i;
00545     strncpy(atom-&gt;<a class="code" href="structmolfile__atom__t.html#m0">name</a>, <font class="stringliteral">"X"</font>, <font class="keyword">sizeof</font>(atom-&gt;<a class="code" href="structmolfile__atom__t.html#m0">name</a>)-1);
00546     atom-&gt;<a class="code" href="structmolfile__atom__t.html#m0">name</a>[<font class="keyword">sizeof</font>(atom-&gt;<a class="code" href="structmolfile__atom__t.html#m0">name</a>)] = <font class="charliteral">'\0'</font>;
00547     strncpy(atom-&gt;<a class="code" href="structmolfile__atom__t.html#m1">type</a>, atom-&gt;<a class="code" href="structmolfile__atom__t.html#m0">name</a>, <font class="keyword">sizeof</font>(atom-&gt;<a class="code" href="structmolfile__atom__t.html#m1">type</a>)-1);
00548     atom-&gt;<a class="code" href="structmolfile__atom__t.html#m1">type</a>[<font class="keyword">sizeof</font>(atom-&gt;<a class="code" href="structmolfile__atom__t.html#m1">type</a>)] = <font class="charliteral">'\0'</font>;
00549     atom-&gt;<a class="code" href="structmolfile__atom__t.html#m2">resname</a>[0] = <font class="charliteral">'\0'</font>;
00550     atom-&gt;<a class="code" href="structmolfile__atom__t.html#m3">resid</a> = 1;
00551     atom-&gt;<a class="code" href="structmolfile__atom__t.html#m5">chain</a>[0] = <font class="charliteral">'\0'</font>;
00552     atom-&gt;<a class="code" href="structmolfile__atom__t.html#m4">segid</a>[0] = <font class="charliteral">'\0'</font>;
00553   }
00554 
00555   <font class="comment">/* Allocate a pointer array that will hold each atom's location in</font>
00556 <font class="comment">     the description string. This will be used in a second pass through</font>
00557 <font class="comment">     the description string in which residue names and indices will</font>
00558 <font class="comment">     be assigned. */</font>
00559   atom_pointers = (<font class="keywordtype">char</font> **) malloc(cdf-&gt;<a class="code" href="structcdfdata.html#m2">natoms</a> * <font class="keyword">sizeof</font>(<font class="keywordtype">char</font> *));
00560   <font class="keywordflow">if</font> (atom_pointers == NULL)
00561     <font class="keywordflow">return</font> <a class="code" href="molfile__plugin_8h.html#a4">MOLFILE_ERROR</a>;
00562 
00563 <font class="preprocessor">#if 0</font>
00564 <font class="preprocessor"></font>  printf(<font class="stringliteral">"cdfplugin) MMTK description:\n%s\n"</font>, mmtk-&gt;<a class="code" href="structmmtkdata.html#m12">description</a>);
00565   printf(<font class="stringliteral">"cdfplugin) parsing MMTK structure description...\n"</font>);
00566 <font class="preprocessor">#endif</font>
00567 <font class="preprocessor"></font>
00568   <font class="comment">/* First pass: look only at atoms */</font>
00569   dstr = mmtk-&gt;<a class="code" href="structmmtkdata.html#m12">description</a>;
00570   <font class="keywordflow">while</font> (dstr &lt; (mmtk-&gt;<a class="code" href="structmmtkdata.html#m12">description</a> + mmtk-&gt;<a class="code" href="structmmtkdata.html#m11">description_lengthdim</a>)) {
00571     <font class="keywordtype">char</font> *atomstr;
00572     atomstr = strstr(dstr, <font class="stringliteral">"A('"</font>);
00573 
00574     <font class="keywordflow">if</font> (atomstr != NULL) {
00575       <font class="keywordtype">char</font> <a class="code" href="xsfplugin_8C.html#a2">name</a>[1024];
00576       <font class="keywordtype">char</font> *nmstart = NULL;
00577       <font class="keywordtype">char</font> *nmend = NULL;
00578       <font class="keywordtype">char</font> *indstart = NULL;
00579       <font class="keywordtype">char</font> *endp = NULL;
00580       <font class="keywordtype">int</font> index, len;
00581 
00582       endp = strchr(atomstr, <font class="charliteral">')'</font>);
00583       nmstart = strchr(atomstr, <font class="charliteral">'\''</font>);
00584       <font class="keywordflow">if</font> (nmstart != NULL)
00585         nmend = strchr(nmstart+1, <font class="charliteral">'\''</font>);
00586       indstart = strchr(atomstr, <font class="charliteral">','</font>);
00587       <font class="keywordflow">if</font> (endp == NULL || nmstart == NULL || nmend == NULL || indstart == NULL) {
00588         printf(<font class="stringliteral">"cdfplugin) mmtk_read_structure(): unable to parse atom tag\n"</font>);
00589         <font class="keywordflow">break</font>; <font class="comment">/* something went wrong */</font>
00590       }
00591 
00592       len = nmend - nmstart - 1;
00593       <font class="keywordflow">if</font> (len &gt; <font class="keyword">sizeof</font>(name)) {
00594         printf(<font class="stringliteral">"cdfplugin) mmtk_read_structure(): bad length: %d\n"</font>, len);
00595         <font class="keywordflow">break</font>; <font class="comment">/* something went wrong */</font>
00596       }
00597       memcpy(<a class="code" href="xsfplugin_8C.html#a2">name</a>, nmstart+1, len); 
00598       <a class="code" href="xsfplugin_8C.html#a2">name</a>[len] = <font class="charliteral">'\0'</font>;
00599 
00600       index = -1;
00601       sscanf(indstart, <font class="stringliteral">",%d)"</font>, &amp;index);
00602       atom_pointers[index] = atomstr;
00603 
00604 <font class="preprocessor">#if 0 </font>
00605 <font class="preprocessor"></font>      printf(<font class="stringliteral">"atom: %s, %d\n"</font>, <a class="code" href="xsfplugin_8C.html#a2">name</a>, index);
00606 <font class="preprocessor">#endif</font>
00607 <font class="preprocessor"></font>
00608       <font class="keywordflow">if</font> (index &gt;= 0 &amp;&amp; index &lt; cdf-&gt;<a class="code" href="structcdfdata.html#m2">natoms</a>) {
00609         atom = atoms + index;
00610         strncpy(atom-&gt;<a class="code" href="structmolfile__atom__t.html#m0">name</a>, <a class="code" href="xsfplugin_8C.html#a2">name</a>, <font class="keyword">sizeof</font>(atom-&gt;<a class="code" href="structmolfile__atom__t.html#m0">name</a>)-1);
00611         atom-&gt;<a class="code" href="structmolfile__atom__t.html#m0">name</a>[<font class="keyword">sizeof</font>(atom-&gt;<a class="code" href="structmolfile__atom__t.html#m0">name</a>)] = <font class="charliteral">'\0'</font>;
00612         strncpy(atom-&gt;<a class="code" href="structmolfile__atom__t.html#m1">type</a>, atom-&gt;<a class="code" href="structmolfile__atom__t.html#m0">name</a>, <font class="keyword">sizeof</font>(atom-&gt;<a class="code" href="structmolfile__atom__t.html#m1">type</a>)-1);
00613         atom-&gt;<a class="code" href="structmolfile__atom__t.html#m1">type</a>[<font class="keyword">sizeof</font>(atom-&gt;<a class="code" href="structmolfile__atom__t.html#m1">type</a>)] = <font class="charliteral">'\0'</font>;
00614       }
00615 
00616       dstr = atomstr+1;
00617     } <font class="keywordflow">else</font> {
00618 <font class="preprocessor">#if 0</font>
00619 <font class="preprocessor"></font>      printf(<font class="stringliteral">"no more atom records found\n"</font>);
00620 <font class="preprocessor">#endif</font>
00621 <font class="preprocessor"></font>      <font class="keywordflow">break</font>; <font class="comment">/* nothing found */</font>
00622     }
00623   }
00624 
00625   <font class="comment">/* Second pass: peptide chains */</font>
00626   dstr = mmtk-&gt;<a class="code" href="structmmtkdata.html#m12">description</a>;
00627   <font class="keywordflow">while</font> (dstr &lt; (mmtk-&gt;<a class="code" href="structmmtkdata.html#m12">description</a> + mmtk-&gt;<a class="code" href="structmmtkdata.html#m11">description_lengthdim</a>)) {
00628     <font class="keywordtype">char</font> *peptide, *pend;
00629     <font class="keywordtype">char</font> *group, *gend;
00630     <font class="keywordtype">char</font> *nmstart, *nmend;
00631     <font class="keywordtype">char</font> chain_id = <font class="charliteral">'A'</font>;
00632     <font class="keywordtype">char</font> *s;
00633 
00634     peptide = strstr(dstr, <font class="stringliteral">"S('"</font>);
00635     <font class="keywordflow">if</font> (peptide == NULL)
00636       <font class="keywordflow">break</font>;
00637     pend = <a class="code" href="cdfplugin_8c.html#a8">find_closing_bracket</a>(peptide+2);
00638 
00639     resnum = 1;
00640     group = peptide;
00641     <font class="keywordflow">while</font> (1) {
00642       group = strstr(group, <font class="stringliteral">"G('"</font>);
00643       <font class="keywordflow">if</font> (group == NULL || group &gt;= pend)
00644         <font class="keywordflow">break</font>;
00645       gend = <a class="code" href="cdfplugin_8c.html#a8">find_closing_bracket</a>(group+2);
00646       nmstart = strchr(group, <font class="charliteral">'\''</font>) + 1;
00647       nmend = strchr(nmstart, <font class="charliteral">'\''</font>);
00648       <font class="keywordflow">while</font> (nmend &gt; nmstart &amp;&amp; isdigit(*(nmend-1)))
00649         nmend--;
00650       <font class="keywordflow">if</font> (nmend-nmstart &gt; 7)
00651         nmend = nmstart+7;
00652       strncpy(resname, nmstart, nmend-nmstart);
00653       resname[nmend-nmstart] = <font class="charliteral">'\0'</font>;
00654       s = resname;
00655       <font class="keywordflow">while</font> (*s) {
00656         *s = toupper(*s);
00657         s++;
00658       }
00659 <font class="preprocessor">#if 0</font>
00660 <font class="preprocessor"></font>      printf(<font class="stringliteral">"%s %d\n"</font>, resname, resnum);
00661 <font class="preprocessor">#endif</font>
00662 <font class="preprocessor"></font>      <a class="code" href="cdfplugin_8c.html#a11">set_atom_attributes</a>(atoms, cdf-&gt;<a class="code" href="structcdfdata.html#m2">natoms</a>, atom_pointers,
00663                           chain_id, resname, resnum, group, gend, 1);
00664       group = gend;
00665       resnum++;
00666     }
00667 
00668     <font class="keywordflow">if</font> (chain_id == <font class="charliteral">'Z'</font>)
00669       chain_id = <font class="charliteral">'A'</font>;
00670     <font class="keywordflow">else</font>
00671         chain_id++;
00672     dstr = pend;
00673   }
00674 
00675   <font class="comment">/* Third pass: nucleic acid chains */</font>
00676   dstr = mmtk-&gt;<a class="code" href="structmmtkdata.html#m12">description</a>;
00677   <font class="keywordflow">while</font> (dstr &lt; (mmtk-&gt;<a class="code" href="structmmtkdata.html#m12">description</a> + mmtk-&gt;<a class="code" href="structmmtkdata.html#m11">description_lengthdim</a>)) {
00678     <font class="keywordtype">char</font> *nacid, *nend;
00679     <font class="keywordtype">char</font> *group, *gend;
00680     <font class="keywordtype">char</font> *nmstart, *nmend;
00681     <font class="keywordtype">char</font> chain_id = <font class="charliteral">'a'</font>;
00682     <font class="keywordtype">char</font> *s;
00683 
00684     nacid = strstr(dstr, <font class="stringliteral">"N('"</font>);
00685     <font class="keywordflow">if</font> (nacid == NULL)
00686       <font class="keywordflow">break</font>;
00687     nend = <a class="code" href="cdfplugin_8c.html#a8">find_closing_bracket</a>(nacid+2);
00688 
00689     resnum = 1;
00690     group = nacid;
00691     <font class="keywordflow">while</font> (1) {
00692       group = strstr(group, <font class="stringliteral">"G('"</font>);
00693       <font class="keywordflow">if</font> (group == NULL || group &gt;= nend)
00694         <font class="keywordflow">break</font>;
00695       gend = <a class="code" href="cdfplugin_8c.html#a8">find_closing_bracket</a>(group+2);
00696       nmstart = strchr(group, <font class="charliteral">'\''</font>) + 1;
00697       nmend = strchr(nmstart, <font class="charliteral">'\''</font>);
00698       <font class="keywordflow">while</font> (nmend &gt; nmstart &amp;&amp; isdigit(*(nmend-1)))
00699         nmend--;
00700       <font class="keywordflow">if</font> (nmend &gt; nmstart &amp;&amp; nmend[-1] == <font class="charliteral">'_'</font>)
00701         nmend--;
00702       <font class="keywordflow">if</font> (nmend-nmstart &gt; 7)
00703         nmend = nmstart+7;
00704       strncpy(resname, nmstart, nmend-nmstart);
00705       resname[nmend-nmstart] = <font class="charliteral">'\0'</font>;
00706       s = resname;
00707       <font class="keywordflow">while</font> (*s) {
00708         *s = toupper(*s);
00709         s++;
00710       }
00711       <font class="keywordflow">if</font> (resname[0] == <font class="charliteral">'R'</font> || resname[0] == <font class="charliteral">'D'</font>) {
00712         <font class="keywordflow">switch</font> (resname[1]) {
00713         <font class="keywordflow">case</font> <font class="charliteral">'A'</font>:
00714           strcpy(resname, <font class="stringliteral">"ADE"</font>);
00715           <font class="keywordflow">break</font>;
00716         <font class="keywordflow">case</font> <font class="charliteral">'C'</font>:
00717           strcpy(resname, <font class="stringliteral">"CYT"</font>);
00718           <font class="keywordflow">break</font>;
00719         <font class="keywordflow">case</font> <font class="charliteral">'G'</font>:
00720           strcpy(resname, <font class="stringliteral">"GUA"</font>);
00721           <font class="keywordflow">break</font>;
00722         <font class="keywordflow">case</font> <font class="charliteral">'T'</font>:
00723           strcpy(resname, <font class="stringliteral">"THY"</font>);
00724           <font class="keywordflow">break</font>;
00725         <font class="keywordflow">case</font> <font class="charliteral">'U'</font>:
00726           strcpy(resname, <font class="stringliteral">"URA"</font>);
00727           <font class="keywordflow">break</font>;
00728         }
00729       }
00730 <font class="preprocessor">#if 0</font>
00731 <font class="preprocessor"></font>      printf(<font class="stringliteral">"%s %d\n"</font>, resname, resnum);
00732 <font class="preprocessor">#endif</font>
00733 <font class="preprocessor"></font>      <a class="code" href="cdfplugin_8c.html#a11">set_atom_attributes</a>(atoms, cdf-&gt;<a class="code" href="structcdfdata.html#m2">natoms</a>, atom_pointers,
00734                           chain_id, resname, resnum, group, gend, 2);
00735       group = gend;
00736       resnum++;
00737     }
00738 
00739     <font class="keywordflow">if</font> (chain_id == <font class="charliteral">'z'</font>)
00740       chain_id = <font class="charliteral">'a'</font>;
00741     <font class="keywordflow">else</font>
00742         chain_id++;
00743     dstr = nend;
00744   }
00745 
00746   <font class="comment">/* Fourth pass: non-chain molecules */</font>
00747   resnum = 1;
00748   dstr = mmtk-&gt;<a class="code" href="structmmtkdata.html#m12">description</a>;
00749   <font class="keywordflow">while</font> (dstr &lt; (mmtk-&gt;<a class="code" href="structmmtkdata.html#m12">description</a> + mmtk-&gt;<a class="code" href="structmmtkdata.html#m11">description_lengthdim</a>)) {
00750     <font class="keywordtype">char</font> *molecule, *mend;
00751     <font class="keywordtype">char</font> *nmstart, *nmend;
00752 
00753     molecule = strstr(dstr, <font class="stringliteral">"M('"</font>);
00754     <font class="keywordflow">if</font> (molecule == NULL)
00755       <font class="keywordflow">break</font>;
00756     mend = <a class="code" href="cdfplugin_8c.html#a8">find_closing_bracket</a>(molecule+2);
00757     nmstart = strchr(molecule, <font class="charliteral">'\''</font>) + 1;
00758     nmend = strchr(nmstart, <font class="charliteral">'\''</font>);
00759     <font class="keywordflow">if</font> (strncmp(nmstart, <font class="stringliteral">"water"</font>, 5) == 0)
00760       strcpy(resname, <font class="stringliteral">"HOH"</font>);
00761     <font class="keywordflow">else</font> {
00762       <font class="keywordflow">if</font> (nmend-nmstart &gt; 7)
00763         nmend = nmstart+7;
00764       strncpy(resname, nmstart, nmend-nmstart);
00765       resname[nmend-nmstart] = <font class="charliteral">'\0'</font>;
00766     }
00767 <font class="preprocessor">#if 0</font>
00768 <font class="preprocessor"></font>    printf(<font class="stringliteral">"%s %d\n"</font>, resname, resnum);
00769 <font class="preprocessor">#endif</font>
00770 <font class="preprocessor"></font>    <a class="code" href="cdfplugin_8c.html#a11">set_atom_attributes</a>(atoms, cdf-&gt;<a class="code" href="structcdfdata.html#m2">natoms</a>, atom_pointers,
00771                         <font class="charliteral">'_'</font>, resname, resnum, molecule, mend, 0);
00772     resnum++;
00773     dstr = mend;
00774   }
00775 
00776   free(atom_pointers);
00777 
00778   <font class="keywordflow">return</font> <a class="code" href="molfile__plugin_8h.html#a2">MOLFILE_SUCCESS</a>;
00779 }
00780 
00781 
<a name="l00782"></a><a class="code" href="cdfplugin_8c.html#a13">00782</a> <font class="keyword">static</font> <font class="keywordtype">int</font> <a class="code" href="cdfplugin_8c.html#a13">read_cdf_structure</a>(<font class="keywordtype">void</font> *mydata, <font class="keywordtype">int</font> *optflags,
00783                                    <a class="code" href="structmolfile__atom__t.html">molfile_atom_t</a> *atoms) {
00784   <a class="code" href="structcdfdata.html">cdfdata</a> *cdf = (<a class="code" href="structcdfdata.html">cdfdata</a> *)mydata;
00785 
00786   <font class="keywordflow">switch</font> (cdf-&gt;<a class="code" href="structcdfdata.html#m1">type</a>) {
00787     <font class="keywordflow">case</font> <a class="code" href="cdfplugin_8c.html#a1">CDF_TYPE_AMBER</a>:
00788       <font class="keywordflow">return</font> <a class="code" href="molfile__plugin_8h.html#a5">MOLFILE_NOSTRUCTUREDATA</a>; <font class="comment">/* not an error, just no data */</font>
00789 
00790     <font class="keywordflow">case</font> <a class="code" href="cdfplugin_8c.html#a2">CDF_TYPE_MMTK</a>:
00791       <font class="keywordflow">return</font> <a class="code" href="cdfplugin_8c.html#a12">read_mmtk_cdf_structure</a>(mydata, optflags, atoms);
00792   }
00793 
00794   <font class="keywordflow">return</font> <a class="code" href="molfile__plugin_8h.html#a4">MOLFILE_ERROR</a>;
00795 }
00796 
00797 
<a name="l00798"></a><a class="code" href="cdfplugin_8c.html#a14">00798</a> <font class="keyword">static</font> <font class="keywordtype">int</font> <a class="code" href="cdfplugin_8c.html#a14">read_amber_cdf_timestep</a>(<font class="keywordtype">void</font> *mydata, <font class="keywordtype">int</font> natoms, <a class="code" href="structmolfile__timestep__t.html">molfile_timestep_t</a> *ts) {
00799   <a class="code" href="structcdfdata.html">cdfdata</a> *cdf = (<a class="code" href="structcdfdata.html">cdfdata</a> *)mydata;
00800   <a class="code" href="structamberdata.html">amberdata</a> *amber = &amp;cdf-&gt;<a class="code" href="structcdfdata.html#m5">amber</a>;
00801   <font class="keywordtype">int</font> rc;
00802 
00803   <font class="comment">/* Read in the atom coordinates and unit cell information */</font>
00804   <font class="comment">/* only save coords if we're given a valid ts pointer     */</font> 
00805   <font class="comment">/* otherwise VMD wants us to skip it.                     */</font>
00806   <font class="keywordflow">if</font> (ts != NULL) {
00807     size_t start[3], count[3];
00808 
00809     start[0] = cdf-&gt;<a class="code" href="structcdfdata.html#m3">curframe</a>; <font class="comment">/* frame */</font>
00810     start[1] = 0;             <font class="comment">/* atom */</font>
00811     start[2] = 0;             <font class="comment">/* spatial */</font>
00812 
00813     count[0] = 1;
00814     count[1] = amber-&gt;<a class="code" href="structamberdata.html#m2">atomdim</a>;
00815     count[2] = amber-&gt;<a class="code" href="structamberdata.html#m4">spatialdim</a>;
00816 
00817     rc = nc_get_vara_float(cdf-&gt;<a class="code" href="structcdfdata.html#m0">ncid</a>, amber-&gt;<a class="code" href="structamberdata.html#m14">coordinates_id</a>, 
00818                            start, count, ts-&gt;<a class="code" href="structmolfile__timestep__t.html#m0">coords</a>);
00819     <font class="keywordflow">if</font> (rc != NC_NOERR) 
00820       <font class="keywordflow">return</font> <a class="code" href="molfile__plugin_8h.html#a4">MOLFILE_ERROR</a>;
00821 
00822     <font class="comment">/* Read the PBC box info. */</font>
00823     <font class="keywordflow">if</font> (amber-&gt;<a class="code" href="structamberdata.html#m0">has_box</a>) {
00824       <font class="keywordtype">double</font> lengths[3];
00825       <font class="keywordtype">double</font> angles[3];
00826 
00827       start[0] = cdf-&gt;<a class="code" href="structcdfdata.html#m3">curframe</a>; <font class="comment">/* frame */</font>
00828       start[1] = 0;             <font class="comment">/* spatial */</font>
00829 
00830       count[0] = 1;
00831       count[1] = amber-&gt;<a class="code" href="structamberdata.html#m4">spatialdim</a>;
00832 
00833       rc = nc_get_vara_double(cdf-&gt;<a class="code" href="structcdfdata.html#m0">ncid</a>, amber-&gt;<a class="code" href="structamberdata.html#m15">cell_lengths_id</a>, 
00834                               start, count, lengths);
00835       <font class="keywordflow">if</font> (rc != NC_NOERR) 
00836         <font class="keywordflow">return</font> <a class="code" href="molfile__plugin_8h.html#a4">MOLFILE_ERROR</a>;
00837 
00838       rc = nc_get_vara_double(cdf-&gt;<a class="code" href="structcdfdata.html#m0">ncid</a>, amber-&gt;<a class="code" href="structamberdata.html#m16">cell_angles_id</a>, 
00839                               start, count, angles);
00840       <font class="keywordflow">if</font> (rc != NC_NOERR) 
00841         <font class="keywordflow">return</font> <a class="code" href="molfile__plugin_8h.html#a4">MOLFILE_ERROR</a>;
00842 
00843       ts-&gt;<a class="code" href="structmolfile__timestep__t.html#z4_0">A</a> = lengths[0];
00844       ts-&gt;<a class="code" href="structmolfile__timestep__t.html#z4_1">B</a> = lengths[1];
00845       ts-&gt;<a class="code" href="structmolfile__timestep__t.html#z4_2">C</a> = lengths[2];
00846 
00847       ts-&gt;<a class="code" href="structmolfile__timestep__t.html#z4_3">alpha</a> = angles[0];
00848       ts-&gt;<a class="code" href="structmolfile__timestep__t.html#z4_4">beta</a>  = angles[1];
00849       ts-&gt;<a class="code" href="structmolfile__timestep__t.html#z4_5">gamma</a> = angles[2];
00850     }
00851   }
00852 
00853   cdf-&gt;<a class="code" href="structcdfdata.html#m3">curframe</a>++;
00854   <font class="keywordflow">return</font> <a class="code" href="molfile__plugin_8h.html#a2">MOLFILE_SUCCESS</a>;
00855 }
00856 
00857 
<a name="l00858"></a><a class="code" href="cdfplugin_8c.html#a15">00858</a> <font class="keyword">static</font> <font class="keywordtype">int</font> <a class="code" href="cdfplugin_8c.html#a15">read_mmtk_cdf_timestep</a>(<font class="keywordtype">void</font> *mydata, <font class="keywordtype">int</font> natoms, <a class="code" href="structmolfile__timestep__t.html">molfile_timestep_t</a> *ts) {
00859   <a class="code" href="structcdfdata.html">cdfdata</a> *cdf = (<a class="code" href="structcdfdata.html">cdfdata</a> *)mydata;
00860   <a class="code" href="structmmtkdata.html">mmtkdata</a> *mmtk = &amp;cdf-&gt;<a class="code" href="structcdfdata.html#m6">mmtk</a>;
00861   <font class="keywordtype">int</font> rc;
00862 
00863   <font class="comment">/* Read in the atom coordinates and unit cell information */</font>
00864   <font class="comment">/* only save coords if we're given a valid ts pointer     */</font> 
00865   <font class="comment">/* otherwise VMD wants us to skip it.                     */</font>
00866   <font class="keywordflow">if</font> (ts != NULL) {
00867     size_t start[4], count[4];
00868     <font class="keywordtype">int</font> i;
00869 
00870     <font class="keywordflow">if</font> (mmtk-&gt;<a class="code" href="structmmtkdata.html#m3">minor_step_numberdim</a> == 0) {
00871       start[0] = cdf-&gt;<a class="code" href="structcdfdata.html#m3">curframe</a>; <font class="comment">/* step */</font>
00872       start[1] = 0;             <font class="comment">/* atom */</font>
00873       start[2] = 0;             <font class="comment">/* spatial */</font>
00874       start[3] = 0;             <font class="comment">/* minor step */</font>
00875     }
00876     <font class="keywordflow">else</font> {
00877       start[0] = cdf-&gt;<a class="code" href="structcdfdata.html#m3">curframe</a>/mmtk-&gt;<a class="code" href="structmmtkdata.html#m3">minor_step_numberdim</a>;   <font class="comment">/* step */</font>
00878       start[1] = 0;             <font class="comment">/* atom */</font>
00879       start[2] = 0;             <font class="comment">/* spatial */</font>
00880       start[3] = cdf-&gt;<a class="code" href="structcdfdata.html#m3">curframe</a> % mmtk-&gt;<a class="code" href="structmmtkdata.html#m3">minor_step_numberdim</a>; <font class="comment">/* minor step */</font>
00881     }
00882 
00883     count[0] = 1;
00884     count[1] = mmtk-&gt;<a class="code" href="structmmtkdata.html#m5">atom_numberdim</a>;
00885     count[2] = mmtk-&gt;<a class="code" href="structmmtkdata.html#m7">xyzdim</a>;
00886     count[3] = 1;             <font class="comment">/* only want one minor step, regardless */</font>
00887 
00888     rc = nc_get_vara_float(cdf-&gt;<a class="code" href="structcdfdata.html#m0">ncid</a>, mmtk-&gt;<a class="code" href="structmmtkdata.html#m17">configuration_id</a>, 
00889                            start, count, ts-&gt;<a class="code" href="structmolfile__timestep__t.html#m0">coords</a>);
00890     <font class="keywordflow">if</font> (rc != NC_NOERR) 
00891       <font class="keywordflow">return</font> <a class="code" href="molfile__plugin_8h.html#a4">MOLFILE_ERROR</a>;
00892 
00893     <font class="comment">/* check for allocated but not yet used frame */</font>
00894     <font class="keywordflow">if</font> (ts-&gt;<a class="code" href="structmolfile__timestep__t.html#m0">coords</a>[0] == NC_FILL_FLOAT)
00895       <font class="keywordflow">return</font> <a class="code" href="molfile__plugin_8h.html#a4">MOLFILE_ERROR</a>;
00896 
00897     <font class="comment">/* scale coordinates from nanometers to angstroms */</font>
00898     <font class="keywordflow">for</font> (i=0; i&lt;(3 * mmtk-&gt;<a class="code" href="structmmtkdata.html#m5">atom_numberdim</a>); i++) {
00899       ts-&gt;<a class="code" href="structmolfile__timestep__t.html#m0">coords</a>[i] *= 10.0f;
00900     }
00901 
00902     <font class="comment">/* Read the PBC box info. */</font>
00903     <font class="keywordflow">if</font> (mmtk-&gt;<a class="code" href="structmmtkdata.html#m18">has_box</a>) {
00904       <font class="keywordtype">float</font> lengths[3];
00905 
00906       <font class="keywordflow">if</font> (mmtk-&gt;<a class="code" href="structmmtkdata.html#m3">minor_step_numberdim</a> == 0) {
00907         start[0] = cdf-&gt;<a class="code" href="structcdfdata.html#m3">curframe</a>; <font class="comment">/* step */</font>
00908         start[1] = 0;             <font class="comment">/* box_size */</font>
00909         start[2] = 0;             <font class="comment">/* minor step */</font>
00910       }
00911       <font class="keywordflow">else</font> {
00912         start[0] = cdf-&gt;<a class="code" href="structcdfdata.html#m3">curframe</a>/mmtk-&gt;<a class="code" href="structmmtkdata.html#m3">minor_step_numberdim</a>;   <font class="comment">/* step */</font>
00913         start[1] = 0;             <font class="comment">/* box_size */</font>
00914         start[2] = cdf-&gt;<a class="code" href="structcdfdata.html#m3">curframe</a> % mmtk-&gt;<a class="code" href="structmmtkdata.html#m3">minor_step_numberdim</a>; <font class="comment">/* minor step */</font>
00915       }
00916 
00917       count[0] = 1;
00918       count[1] = 3;
00919       count[2] = 1;
00920 
00921       rc = nc_get_vara_float(cdf-&gt;<a class="code" href="structcdfdata.html#m0">ncid</a>, mmtk-&gt;<a class="code" href="structmmtkdata.html#m16">box_size_id</a>,
00922                              start, count, lengths);
00923       <font class="keywordflow">if</font> (rc != NC_NOERR) 
00924         <font class="keywordflow">return</font> <a class="code" href="molfile__plugin_8h.html#a4">MOLFILE_ERROR</a>;
00925 
00926       ts-&gt;<a class="code" href="structmolfile__timestep__t.html#z4_0">A</a> = 10.*lengths[0];
00927       ts-&gt;<a class="code" href="structmolfile__timestep__t.html#z4_1">B</a> = 10.*lengths[1];
00928       ts-&gt;<a class="code" href="structmolfile__timestep__t.html#z4_2">C</a> = 10.*lengths[2];
00929 
00930       ts-&gt;<a class="code" href="structmolfile__timestep__t.html#z4_3">alpha</a> = 90.;
00931       ts-&gt;<a class="code" href="structmolfile__timestep__t.html#z4_4">beta</a>  = 90.;
00932       ts-&gt;<a class="code" href="structmolfile__timestep__t.html#z4_5">gamma</a> = 90.;
00933     }
00934   }
00935 
00936   cdf-&gt;<a class="code" href="structcdfdata.html#m3">curframe</a>++;
00937   <font class="keywordflow">return</font> <a class="code" href="molfile__plugin_8h.html#a2">MOLFILE_SUCCESS</a>;
00938 }
00939 
00940 
00941 
<a name="l00942"></a><a class="code" href="cdfplugin_8c.html#a16">00942</a> <font class="keyword">static</font> <font class="keywordtype">int</font> <a class="code" href="cdfplugin_8c.html#a16">read_cdf_timestep</a>(<font class="keywordtype">void</font> *mydata, <font class="keywordtype">int</font> natoms, <a class="code" href="structmolfile__timestep__t.html">molfile_timestep_t</a> *ts) {
00943   <a class="code" href="structcdfdata.html">cdfdata</a> *cdf = (<a class="code" href="structcdfdata.html">cdfdata</a> *)mydata;
00944 
00945   <font class="keywordflow">switch</font> (cdf-&gt;<a class="code" href="structcdfdata.html#m1">type</a>) {
00946     <font class="keywordflow">case</font> <a class="code" href="cdfplugin_8c.html#a1">CDF_TYPE_AMBER</a>: 
00947       <font class="keywordflow">return</font> <a class="code" href="cdfplugin_8c.html#a14">read_amber_cdf_timestep</a>(mydata, natoms, ts); 
00948 
00949     <font class="keywordflow">case</font> <a class="code" href="cdfplugin_8c.html#a2">CDF_TYPE_MMTK</a>:
00950       <font class="keywordflow">return</font> <a class="code" href="cdfplugin_8c.html#a15">read_mmtk_cdf_timestep</a>(mydata, natoms, ts); 
00951   }
00952 
00953   <font class="keywordflow">return</font> <a class="code" href="molfile__plugin_8h.html#a4">MOLFILE_ERROR</a>;
00954 }
00955 
00956 
<a name="l00957"></a><a class="code" href="cdfplugin_8c.html#a3">00957</a> <font class="keyword">static</font> <a class="code" href="structmolfile__plugin__t.html">molfile_plugin_t</a> <a class="code" href="cdfplugin_8c.html#a3">cdfplugin</a> = {
00958   <a class="code" href="vmdplugin_8h.html#a10">vmdplugin_ABIVERSION</a>,                         <font class="comment">/* ABI version */</font>
00959   <a class="code" href="molfile__plugin_8h.html#a0">MOLFILE_PLUGIN_TYPE</a>,                          <font class="comment">/* type */</font>
00960   <font class="stringliteral">"netcdf"</font>,                                     <font class="comment">/* short name */</font>
00961   <font class="stringliteral">"NetCDF (AMBER, MMTK)"</font>,                       <font class="comment">/* pretty name */</font>
00962   <font class="stringliteral">"John E. Stone"</font>,                              <font class="comment">/* author */</font>
00963   0,                                            <font class="comment">/* major version */</font>
00964   5,                                            <font class="comment">/* minor version */</font>
00965   <a class="code" href="vmdplugin_8h.html#a12">VMDPLUGIN_THREADSAFE</a>,                         <font class="comment">/* is reentrant */</font>
00966   <font class="stringliteral">"nc"</font>,                                         <font class="comment">/* filename extensions */</font>
00967   <a class="code" href="cdfplugin_8c.html#a7">open_cdf_read</a>,
00968   <a class="code" href="cdfplugin_8c.html#a13">read_cdf_structure</a>,
00969   0,
00970   <a class="code" href="cdfplugin_8c.html#a16">read_cdf_timestep</a>,
00971   <a class="code" href="cdfplugin_8c.html#a4">close_cdf_read</a>,
00972   0,
00973   0,
00974   0,
00975   0,
00976 };
00977 
<a name="l00978"></a><a class="code" href="cdfplugin_8c.html#a17">00978</a> <a class="code" href="vmdplugin_8h.html#a7">VMDPLUGIN_API</a> <font class="keywordtype">int</font> <a class="code" href="vmdplugin_8h.html#a5">VMDPLUGIN_init</a>(<font class="keywordtype">void</font>) { <font class="keywordflow">return</font> <a class="code" href="vmdplugin_8h.html#a13">VMDPLUGIN_SUCCESS</a>; }
<a name="l00979"></a><a class="code" href="cdfplugin_8c.html#a18">00979</a> <a class="code" href="vmdplugin_8h.html#a7">VMDPLUGIN_API</a> <font class="keywordtype">int</font> <a class="code" href="vmdplugin_8h.html#a6">VMDPLUGIN_fini</a>(<font class="keywordtype">void</font>) { <font class="keywordflow">return</font> <a class="code" href="vmdplugin_8h.html#a13">VMDPLUGIN_SUCCESS</a>; }
<a name="l00980"></a><a class="code" href="cdfplugin_8c.html#a19">00980</a> <a class="code" href="vmdplugin_8h.html#a7">VMDPLUGIN_API</a> <font class="keywordtype">int</font> <a class="code" href="vmdplugin_8h.html#a3">VMDPLUGIN_register</a>(<font class="keywordtype">void</font> *v, <a class="code" href="vmdplugin_8h.html#a15">vmdplugin_register_cb</a> cb) {
00981   (*cb)(v, (<a class="code" href="structvmdplugin__t.html">vmdplugin_t</a> *)&amp;cdfplugin);
00982   <font class="keywordflow">return</font> <a class="code" href="vmdplugin_8h.html#a13">VMDPLUGIN_SUCCESS</a>;
00983 }
00984 
</pre></div><hr><address><small>Generated on Wed Mar 22 13:15:28 2006 for VMD Plugins (current) by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.gif" alt="doxygen" align="middle" border=0 
width=110 height=53></a>1.2.14 written by <a href="mailto:dimitri@stack.nl">Dimitri van Heesch</a>,
 &copy;&nbsp;1997-2002</small></address>
</body>
</html>
