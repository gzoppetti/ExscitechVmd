<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>babelplugin.c Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.2.14 -->
<center>
<a class="qindex" href="index.html">Main Page</a> &nbsp; <a class="qindex" href="classes.html">Alphabetical List</a> &nbsp; <a class="qindex" href="annotated.html">Compound List</a> &nbsp; <a class="qindex" href="files.html">File List</a> &nbsp; <a class="qindex" href="functions.html">Compound Members</a> &nbsp; <a class="qindex" href="globals.html">File Members</a> &nbsp; <a class="qindex" href="pages.html">Related Pages</a> &nbsp; </center>
<hr><h1>babelplugin.c</h1><a href="babelplugin_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 <font class="comment">/***************************************************************************</font>
00002 <font class="comment"> *cr</font>
00003 <font class="comment"> *cr            (C) Copyright 1995-2006 The Board of Trustees of the</font>
00004 <font class="comment"> *cr                        University of Illinois</font>
00005 <font class="comment"> *cr                         All Rights Reserved</font>
00006 <font class="comment"> *cr</font>
00007 <font class="comment"> ***************************************************************************/</font>
00008 
00009 <font class="comment">/***************************************************************************</font>
00010 <font class="comment"> * RCS INFORMATION:</font>
00011 <font class="comment"> *</font>
00012 <font class="comment"> *      $RCSfile: babelplugin.c,v $</font>
00013 <font class="comment"> *      $Author: johns $       $Locker:  $             $State: Exp $</font>
00014 <font class="comment"> *      $Revision: 1.43 $       $Date: 2006/02/23 19:36:44 $</font>
00015 <font class="comment"> *</font>
00016 <font class="comment"> ***************************************************************************/</font>
00017 
00018 <font class="comment">/*</font>
00019 <font class="comment"> * Convert files using Babel 1.6</font>
00020 <font class="comment"> *   http://www.eyesopen.com/products/applications/babel.html</font>
00021 <font class="comment"> *</font>
00022 <font class="comment"> * Convert files using Open Babel 1.100.2</font>
00023 <font class="comment"> *   http://openbabel.sourceforge.net/babel.shtml</font>
00024 <font class="comment"> */</font>
00025 
00026 
00027 <font class="preprocessor">#include &lt;stdlib.h&gt;</font>
00028 <font class="preprocessor">#include &lt;ctype.h&gt;</font>
00029 <font class="preprocessor">#include &lt;string.h&gt;</font>
00030 
00031 <font class="preprocessor">#if !defined(_MSC_VER) </font>
00032 <font class="preprocessor"></font><font class="preprocessor">#include &lt;unistd.h&gt;</font>  <font class="comment">/* for getuid */</font>
00033 <font class="preprocessor">#endif</font>
00034 <font class="preprocessor"></font>
00035 <font class="preprocessor">#include "<a class="code" href="molfile__plugin_8h.html">molfile_plugin.h</a>"</font>
00036 <font class="preprocessor">#include "<a class="code" href="readpdb_8h.html">readpdb.h</a>"</font>
00037 <font class="preprocessor">#include "<a class="code" href="vmddir_8h.html">vmddir.h</a>"</font>
00038 <font class="preprocessor">#include "<a class="code" href="periodic__table_8h.html">periodic_table.h</a>"</font>
00039 
<a name="l00040"></a><a class="code" href="structpdbdata.html">00040</a> <font class="keyword">typedef</font> <font class="keyword">struct </font>{
<a name="l00041"></a><a class="code" href="structpdbdata.html#m0">00041</a>   FILE *fd;
00042   <font class="keywordtype">int</font> natoms;
<a name="l00043"></a><a class="code" href="structpdbdata.html#m2">00043</a>   <font class="keywordtype">char</font> *original_file;
<a name="l00044"></a><a class="code" href="structpdbdata.html#m3">00044</a>   <font class="keywordtype">char</font> *current_file;
<a name="l00045"></a><a class="code" href="structpdbdata.html#m4">00045</a>   <font class="keywordtype">int</font> babel_num;
<a name="l00046"></a><a class="code" href="structpdbdata.html#m5">00046</a>   <font class="keywordtype">int</font> babel_i;
00047 } <a class="code" href="structpdbdata.html">pdbdata</a>;
00048 
00049 <font class="comment">/* </font>
00050 <font class="comment"> * I guess this is to try to keep tmp files from clobbering each other</font>
00051 <font class="comment"> */</font>
<a name="l00052"></a><a class="code" href="babelplugin_8c.html#a7">00052</a> <font class="keyword">static</font> <font class="keywordtype">int</font> <a class="code" href="babelplugin_8c.html#a7">vmd_getuid</a>(<font class="keywordtype">void</font>) {
00053 <font class="preprocessor">#if defined(_MSC_VER)</font>
00054 <font class="preprocessor"></font>  <font class="keywordflow">return</font> 0;
00055 <font class="preprocessor">#else</font>
00056 <font class="preprocessor"></font>  <font class="keywordflow">return</font> getuid();
00057 <font class="preprocessor">#endif</font>
00058 <font class="preprocessor"></font>}
00059 
<a name="l00060"></a><a class="code" href="babelplugin_8c.html#a8">00060</a> <font class="keyword">static</font> <font class="keywordtype">int</font> <a class="code" href="babelplugin_8c.html#a8">vmd_delete_file</a>(<font class="keyword">const</font> <font class="keywordtype">char</font> * path) {
00061 <font class="preprocessor">#if defined(_MSC_VER)</font>
00062 <font class="preprocessor"></font>  <font class="keywordflow">if</font> (DeleteFile(path) == 0)
00063     <font class="keywordflow">return</font> -1;
00064   <font class="keywordflow">else</font>
00065     <font class="keywordflow">return</font> 0;
00066 <font class="preprocessor">#else</font>
00067 <font class="preprocessor"></font>  <font class="keywordflow">return</font> unlink(path);
00068 <font class="preprocessor">#endif</font>
00069 <font class="preprocessor"></font>}
00070 
<a name="l00071"></a><a class="code" href="babelplugin_8c.html#a0">00071</a> <font class="preprocessor">#define BABEL_TMPDIR "/tmp/"</font>
00072 <font class="preprocessor"></font>
00073 <font class="comment">/*</font>
00074 <font class="comment"> * Dude, don't even think for a minute that I came up with this code.  It's</font>
00075 <font class="comment"> * copied from BabelConvert.C, ok?</font>
00076 <font class="comment"> * This gets called three times, with has_multi = 1, -2, and -1.  Don't ask</font>
00077 <font class="comment"> * me why.</font>
00078 <font class="comment"> */</font>
<a name="l00079"></a><a class="code" href="babelplugin_8c.html#a9">00079</a> <font class="keyword">static</font> <font class="keywordtype">char</font> *<a class="code" href="babelplugin_8c.html#a9">file</a>(<font class="keyword">const</font> <font class="keywordtype">char</font> *filename, <font class="keywordtype">int</font> idx, <font class="keywordtype">int</font> has_multi) {
00080    <font class="comment">/* temp space to save the filename or glob */</font>
00081    <font class="keywordtype">int</font> i=0;
00082    <font class="keywordtype">char</font> *ptr;
00083    <font class="keywordtype">char</font> *tempspace = (<font class="keywordtype">char</font> *)malloc(513);
00084    <font class="keyword">const</font> <font class="keywordtype">char</font> *s;
00085    <font class="keywordflow">for</font> (s = filename; *s != 0; s++) { 
00086       <font class="keywordflow">if</font> ((*s == <font class="charliteral">'/'</font>) || (*s == <font class="charliteral">'\\'</font>))
00087         i = s-filename+1;
00088    }
00089    <font class="comment">/*</font>
00090 <font class="comment">   // so filename+i points to the actual name</font>
00091 <font class="comment">   // if there are multiple files in the conversion, then the output</font>
00092 <font class="comment">   // looks like "test0041.extensions".  If there was a single file,</font>
00093 <font class="comment">   // the output looks like "test.extensions"</font>
00094 <font class="comment">   */</font>
00095    <font class="keywordflow">if</font> (has_multi == -1) {
00096       sprintf(tempspace, <font class="stringliteral">"%svmdbabel*.u%d.%s"</font>, <a class="code" href="babelplugin_8c.html#a0">BABEL_TMPDIR</a>,
00097               <a class="code" href="babelplugin_8c.html#a7">vmd_getuid</a>(), filename + i);
00098    } <font class="keywordflow">else</font> <font class="keywordflow">if</font> (has_multi == -2) {
00099       <font class="keywordtype">char</font> *reallytemp = (<font class="keywordtype">char</font> *)malloc(strlen(filename+i)+1);
00100       strcpy(reallytemp, filename+i);
00101       *(reallytemp + strlen(reallytemp) - 1) = 0;
00102       sprintf(tempspace, <font class="stringliteral">"vmdbabel%%[0-9.]u%d.%s%%c"</font>,
00103               <a class="code" href="babelplugin_8c.html#a7">vmd_getuid</a>(), reallytemp);
00104       free(reallytemp);
00105    } <font class="keywordflow">else</font> <font class="keywordflow">if</font> (has_multi == 0) {
00106       sprintf(tempspace, <font class="stringliteral">"%svmdbabel.u%d.%s"</font>, <a class="code" href="babelplugin_8c.html#a0">BABEL_TMPDIR</a>,
00107               <a class="code" href="babelplugin_8c.html#a7">vmd_getuid</a>(), filename + i);
00108    } <font class="keywordflow">else</font> {
00109       sprintf(tempspace, <font class="stringliteral">"%svmdbabel%04d.u%d.%s"</font>, <a class="code" href="babelplugin_8c.html#a0">BABEL_TMPDIR</a>, idx+1,
00110               <a class="code" href="babelplugin_8c.html#a7">vmd_getuid</a>(), filename + i);
00111    }
00112    <font class="keywordflow">for</font> (ptr = tempspace; *ptr; ptr++) {  <font class="comment">/* babel makes them lowercase! */</font>
00113       *ptr = tolower(*ptr);              <font class="comment">/* grrrrrrr                    */</font>
00114    }
00115    <font class="keywordflow">return</font> tempspace;
00116 }
00117 
<a name="l00118"></a><a class="code" href="babelplugin_8c.html#a10">00118</a> <font class="keyword">static</font> <font class="keywordtype">void</font> <a class="code" href="babelplugin_8c.html#a10">delete_all</a>(<font class="keyword">const</font> <font class="keywordtype">char</font> *filename) {
00119   <font class="keyword">const</font> <font class="keywordtype">char</font> *s;
00120   <font class="keywordtype">char</font> *t;
00121 
00122   s = <a class="code" href="babelplugin_8c.html#a9">file</a>(filename, 0, -1); <font class="comment">/* puts a '*' in number field */</font>
00123   t = (<font class="keywordtype">char</font> *)malloc(strlen(s) + 35);
00124 <font class="preprocessor">#if defined(_MSC_VER)</font>
00125 <font class="preprocessor"></font>   sprintf(t, <font class="stringliteral">"del %s"</font>, s);
00126 <font class="preprocessor">#else</font>
00127 <font class="preprocessor"></font>   sprintf(t, <font class="stringliteral">"/bin/rm -f \"%s\""</font>, s);
00128 <font class="preprocessor">#endif</font>
00129 <font class="preprocessor"></font>  system(t);
00130   free(t);
00131 }
00132  
<a name="l00133"></a><a class="code" href="babelplugin_8c.html#a11">00133</a> <font class="keyword">static</font> <font class="keywordtype">void</font> *<a class="code" href="pdbplugin_8c.html#a2">open_pdb_read</a>(<font class="keyword">const</font> <font class="keywordtype">char</font> *filepath, <font class="keywordtype">int</font> *natoms) {
00134   FILE *fd;
00135   <a class="code" href="structpdbdata.html">pdbdata</a> *pdb;
00136   <font class="keywordtype">char</font> pdbstr[<a class="code" href="readpdb_8h.html#a1">PDB_BUFFER_LENGTH</a>];
00137   <font class="keywordtype">int</font> indx;
00138   fd = fopen(filepath, <font class="stringliteral">"r"</font>);
00139   <font class="keywordflow">if</font> (!fd) <font class="keywordflow">return</font> NULL;
00140   pdb = (<a class="code" href="structpdbdata.html">pdbdata</a> *)malloc(<font class="keyword">sizeof</font>(<a class="code" href="structpdbdata.html">pdbdata</a>));
00141   pdb-&gt;<a class="code" href="structpdbdata.html#m0">fd</a> = fd;
00142   *natoms = 0;
00143   <font class="keywordflow">do</font> {
00144     <font class="keywordflow">if</font>((indx = <a class="code" href="readpdb_8h.html#a11">read_pdb_record</a>(pdb-&gt;<a class="code" href="structpdbdata.html#m0">fd</a>, pdbstr)) == <a class="code" href="readpdb_8h.html#a19a5">PDB_ATOM</a>)
00145       *natoms += 1;
00146   } <font class="keywordflow">while</font> (indx != <a class="code" href="readpdb_8h.html#a19a8">PDB_END</a> &amp;&amp; indx != <a class="code" href="readpdb_8h.html#a19a9">PDB_EOF</a>);
00147   rewind(pdb-&gt;<a class="code" href="structpdbdata.html#m0">fd</a>);
00148   pdb-&gt;<a class="code" href="structpdbdata.html#m1">natoms</a> = *natoms;
00149   <font class="keywordflow">return</font> pdb;
00150 }
00151 
00152 <font class="comment">/*</font>
00153 <font class="comment"> * Babel 1.6 internal file type names</font>
00154 <font class="comment"> */</font>
<a name="l00155"></a><a class="code" href="babelplugin_8c.html#a1">00155</a> <font class="keyword">static</font> <font class="keyword">const</font> <font class="keywordtype">char</font> *<a class="code" href="babelplugin_8c.html#a1">babel16filetypes</a>[] = {
00156 <font class="stringliteral">"alc"</font>,
00157 <font class="stringliteral">"prep"</font>,
00158 <font class="stringliteral">"bs"</font>,
00159 <font class="stringliteral">"bgf"</font>,
00160 <font class="stringliteral">"car"</font>,
00161 <font class="stringliteral">"boog"</font>,
00162 <font class="stringliteral">"caccrt"</font>,
00163 <font class="stringliteral">"cadpac"</font>,
00164 <font class="stringliteral">"charmm"</font>,
00165 <font class="stringliteral">"c3d1"</font>,
00166 <font class="stringliteral">"c3d2"</font>,
00167 <font class="stringliteral">"cssr"</font>,
00168 <font class="stringliteral">"fdat"</font>,
00169 <font class="stringliteral">"gstat"</font>,
00170 <font class="stringliteral">"dock"</font>,
00171 <font class="stringliteral">"dpdb"</font>,
00172 <font class="stringliteral">"feat"</font>,
00173 <font class="stringliteral">"fract"</font>,
00174 <font class="stringliteral">"gamout"</font>,
00175 <font class="stringliteral">"gzmat"</font>,
00176 <font class="stringliteral">"gauout"</font>,
00177 <font class="stringliteral">"g94"</font>,
00178 <font class="stringliteral">"gr96A"</font>,
00179 <font class="stringliteral">"gr96N"</font>,
00180 <font class="stringliteral">"hin"</font>,
00181 <font class="stringliteral">"sdf"</font>,
00182 <font class="stringliteral">"m3d"</font>,
00183 <font class="stringliteral">"macmol"</font>,
00184 <font class="stringliteral">"macmod"</font>,
00185 <font class="stringliteral">"micro"</font>,
00186 <font class="stringliteral">"mm2in"</font>,
00187 <font class="stringliteral">"mm2out"</font>,
00188 <font class="stringliteral">"mm3"</font>,
00189 <font class="stringliteral">"mmads"</font>,
00190 <font class="stringliteral">"mdl"</font>,
00191 <font class="stringliteral">"molen"</font>,
00192 <font class="stringliteral">"mopcrt"</font>,
00193 <font class="stringliteral">"mopint"</font>,
00194 <font class="stringliteral">"mopout"</font>,
00195 <font class="stringliteral">"pcmod"</font>,
00196 <font class="stringliteral">"psin"</font>,
00197 <font class="stringliteral">"psout"</font>,
00198 <font class="stringliteral">"msf"</font>,
00199 <font class="stringliteral">"schakal"</font>,
00200 <font class="stringliteral">"shelx"</font>,
00201 <font class="stringliteral">"smiles"</font>,
00202 <font class="stringliteral">"spar"</font>,
00203 <font class="stringliteral">"semi"</font>,
00204 <font class="stringliteral">"spmm"</font>,
00205 <font class="stringliteral">"mol"</font>,
00206 <font class="stringliteral">"mol2"</font>,
00207 <font class="stringliteral">"wiz"</font>,
00208 <font class="stringliteral">"unixyz"</font>,
00209 <font class="stringliteral">"xyz"</font>,  
00210 <font class="stringliteral">"xed"</font>,
00211 0
00212 };
00213 
00214 <font class="comment">/*</font>
00215 <font class="comment"> * Plugin names registered in VMD for each Babel 1.6 file type</font>
00216 <font class="comment"> */</font>
<a name="l00217"></a><a class="code" href="babelplugin_8c.html#a2">00217</a> <font class="keyword">static</font> <font class="keyword">const</font> <font class="keywordtype">char</font> *<a class="code" href="babelplugin_8c.html#a2">babel16filetypenames</a>[] = {
00218   <font class="stringliteral">"Alchemy"</font>,          <font class="stringliteral">"AMBERPREP"</font>,       <font class="stringliteral">"BallStick"</font>,      
00219   <font class="stringliteral">"MSIBGF"</font>,           <font class="stringliteral">"BiosymCAR"</font>,       <font class="stringliteral">"Boogie"</font>,
00220   <font class="stringliteral">"Cacao"</font>,            <font class="stringliteral">"CADPAC"</font>,          <font class="stringliteral">"CHARMm"</font>,
00221   <font class="stringliteral">"Chem3d-1"</font>,         <font class="stringliteral">"Chem3d-2"</font>,        <font class="stringliteral">"CSSR"</font>,
00222   <font class="stringliteral">"FDAT"</font>,             <font class="stringliteral">"GSTAT"</font>,           <font class="stringliteral">"Dock"</font>,
00223   <font class="stringliteral">"DockPDB"</font>,          <font class="stringliteral">"Feature"</font>,         <font class="stringliteral">"Fractional"</font>,    
00224   <font class="stringliteral">"GAMESSoutput"</font>,     <font class="stringliteral">"GaussianZmatrix"</font>, <font class="stringliteral">"Gaussian92output"</font>, 
00225   <font class="stringliteral">"Guassian94output"</font>, <font class="stringliteral">"Gromos96A"</font>,       <font class="stringliteral">"Gromos96N"</font>,
00226   <font class="stringliteral">"HyperchemHIN"</font>,     <font class="stringliteral">"IsisSDF"</font>,         <font class="stringliteral">"M3D"</font>,
00227   <font class="stringliteral">"MacMolecule"</font>,      <font class="stringliteral">"Macromodel"</font>,      <font class="stringliteral">"MicroWorld"</font>,
00228   <font class="stringliteral">"MM2Input"</font>,         <font class="stringliteral">"MM2Output"</font>,       <font class="stringliteral">"MM3"</font>,
00229   <font class="stringliteral">"MMADS"</font>,            <font class="stringliteral">"MDLMOL"</font>,          <font class="stringliteral">"MOLIN"</font>,
00230   <font class="stringliteral">"MopacCartesian"</font>,   <font class="stringliteral">"MopacInternal"</font>,   <font class="stringliteral">"MopacOutput"</font>,
00231   <font class="stringliteral">"PCModel"</font>,          <font class="stringliteral">"PSGVBin"</font>,         <font class="stringliteral">"PSGVBout"</font>,
00232   <font class="stringliteral">"QuantaMSF"</font>,        <font class="stringliteral">"Schakal"</font>,         <font class="stringliteral">"ShelX"</font>,
00233   <font class="stringliteral">"SMILES"</font>,
00234   <font class="stringliteral">"Spartan"</font>,          <font class="stringliteral">"SpartanSE"</font>,       <font class="stringliteral">"SpartanMM"</font>,
00235   <font class="stringliteral">"SybylMol"</font>,         <font class="stringliteral">"SybylMol2"</font>,       <font class="stringliteral">"Conjure"</font>,
00236   <font class="stringliteral">"UniChemXYZ"</font>,       <font class="stringliteral">"XYZ"</font>,             <font class="stringliteral">"XED"</font>, 
00237   0
00238 };
00239 
00240 
00241 <font class="comment">/*</font>
00242 <font class="comment"> * Open Babel 1.100.2 internal file type names</font>
00243 <font class="comment"> */</font>
<a name="l00244"></a><a class="code" href="babelplugin_8c.html#a3">00244</a> <font class="keyword">static</font> <font class="keyword">const</font> <font class="keywordtype">char</font> *<a class="code" href="babelplugin_8c.html#a3">openbabel11filetypes</a>[] = {
00245 <font class="stringliteral">"alc"</font>,
00246 <font class="stringliteral">"prep"</font>,
00247 <font class="stringliteral">"bs"</font>,
00248 <font class="stringliteral">"caccrt"</font>,
00249 <font class="stringliteral">"ccc"</font>,
00250 <font class="stringliteral">"c3d1"</font>,
00251 <font class="stringliteral">"c3d2"</font>,
00252 <font class="stringliteral">"cml"</font>,
00253 <font class="stringliteral">"crk2d"</font>,
00254 <font class="stringliteral">"crk3d"</font>,
00255 <font class="stringliteral">"box"</font>,
00256 <font class="stringliteral">"dmol"</font>,
00257 <font class="stringliteral">"feat"</font>,
00258 <font class="stringliteral">"gam"</font>,
00259 <font class="stringliteral">"gpr"</font>,
00260 <font class="stringliteral">"mm1gp"</font>,
00261 <font class="stringliteral">"qm1gp"</font>,
00262 <font class="stringliteral">"hin"</font>,
00263 <font class="stringliteral">"jout"</font>,
00264 <font class="stringliteral">"bin"</font>,
00265 <font class="stringliteral">"mmd"</font>,
00266 <font class="stringliteral">"car"</font>,
00267 <font class="stringliteral">"sdf"</font>,
00268 <font class="stringliteral">"mol"</font>,
00269 <font class="stringliteral">"mopcrt"</font>,
00270 <font class="stringliteral">"mopout"</font>,
00271 <font class="stringliteral">"mmads"</font>,
00272 <font class="stringliteral">"mpqc"</font>,
00273 <font class="stringliteral">"bgf"</font>,
00274 <font class="stringliteral">"nwo"</font>,
00275 <font class="stringliteral">"pqs"</font>,
00276 <font class="stringliteral">"qcout"</font>,
00277 <font class="stringliteral">"res"</font>,
00278 <font class="stringliteral">"smi"</font>,
00279 <font class="stringliteral">"mol2"</font>,
00280 <font class="stringliteral">"unixyz"</font>,
00281 <font class="stringliteral">"vmol"</font>,
00282 <font class="stringliteral">"xyz"</font>,
00283 0
00284 };
00285 
00286 <font class="comment">/*</font>
00287 <font class="comment"> * Plugin names registered in VMD for each Open Babel 1.100.2 file type</font>
00288 <font class="comment"> */</font>
<a name="l00289"></a><a class="code" href="babelplugin_8c.html#a4">00289</a> <font class="keyword">static</font> <font class="keyword">const</font> <font class="keywordtype">char</font> *<a class="code" href="babelplugin_8c.html#a4">openbabel11filetypenames</a>[] = {
00290   <font class="stringliteral">"Alchemy"</font>,          <font class="stringliteral">"AMBERPREP"</font>,       <font class="stringliteral">"BallStick"</font>,      
00291   <font class="stringliteral">"Cacao"</font>,            <font class="stringliteral">"CCC"</font>,           
00292   <font class="stringliteral">"Chem3d-1"</font>,         <font class="stringliteral">"Chem3d-2"</font>,        <font class="stringliteral">"ChemicalMarkup"</font>
00293   <font class="stringliteral">"CRK2D"</font>,            <font class="stringliteral">"CRK3D"</font>,           <font class="stringliteral">"Dock35Box"</font>,
00294   <font class="stringliteral">"Dmol3Coord"</font>,       <font class="stringliteral">"Feature"</font>,         <font class="stringliteral">"GAMESSoutput"</font>,     
00295   <font class="stringliteral">"GhemicalProj"</font>,     <font class="stringliteral">"GhemicalMM"</font>,      <font class="stringliteral">"GhemicalQM"</font>,
00296   <font class="stringliteral">"HyperchemHIN"</font>,     <font class="stringliteral">"JaguarOutput"</font>,    <font class="stringliteral">"OpenEyeBinary"</font>,
00297   <font class="stringliteral">"Macromodel"</font>,       <font class="stringliteral">"BiosymCAR"</font>,       <font class="stringliteral">"IsisSDF"</font>,
00298   <font class="stringliteral">"MDLMOL"</font>,           <font class="stringliteral">"MopacCartesian"</font>,  <font class="stringliteral">"MopacOutput"</font>,     
00299   <font class="stringliteral">"MMADS"</font>,            <font class="stringliteral">"MPQC"</font>,            <font class="stringliteral">"MSIBGF"</font>,  
00300   <font class="stringliteral">"NWChemOutput"</font>,     <font class="stringliteral">"PQS"</font>,             <font class="stringliteral">"QChemOutput"</font>,
00301   <font class="stringliteral">"ShelX"</font>,            <font class="stringliteral">"SMILES"</font>,          <font class="stringliteral">"SybylMol2"</font>,   
00302   <font class="stringliteral">"UniChemXYZ"</font>,       <font class="stringliteral">"ViewMol"</font>,         <font class="stringliteral">"XYZ"</font>,
00303   0
00304 };
00305 
00306 
<a name="l00307"></a><a class="code" href="babelplugin_8c.html#a12">00307</a> <font class="keyword">static</font> <font class="keyword">const</font> <font class="keywordtype">char</font> *<a class="code" href="babelplugin_8c.html#a12">babel16type_from_name</a>(<font class="keyword">const</font> <font class="keywordtype">char</font> *<a class="code" href="xsfplugin_8C.html#a2">name</a>) {
00308   <font class="keyword">const</font> <font class="keywordtype">char</font> **ptr = <a class="code" href="babelplugin_8c.html#a2">babel16filetypenames</a>;
00309   <font class="keywordtype">int</font> i=0; 
00310   <font class="keywordflow">while</font> (*ptr) {
00311     <font class="keywordflow">if</font> (!strcmp(*ptr, <a class="code" href="xsfplugin_8C.html#a2">name</a>))
00312       <font class="keywordflow">return</font> <a class="code" href="babelplugin_8c.html#a1">babel16filetypes</a>[i];
00313     ptr++;
00314     i++;
00315   }
00316   <font class="keywordflow">return</font> NULL;
00317 }
00318 
<a name="l00319"></a><a class="code" href="babelplugin_8c.html#a13">00319</a> <font class="keyword">static</font> <font class="keyword">const</font> <font class="keywordtype">char</font> *<a class="code" href="babelplugin_8c.html#a13">openbabel11type_from_name</a>(<font class="keyword">const</font> <font class="keywordtype">char</font> *<a class="code" href="xsfplugin_8C.html#a2">name</a>) {
00320   <font class="keyword">const</font> <font class="keywordtype">char</font> **ptr = <a class="code" href="babelplugin_8c.html#a4">openbabel11filetypenames</a>;
00321   <font class="keywordtype">int</font> i=0; 
00322   <font class="keywordflow">while</font> (*ptr) {
00323     <font class="keywordflow">if</font> (!strcmp(*ptr, <a class="code" href="xsfplugin_8C.html#a2">name</a>))
00324       <font class="keywordflow">return</font> <a class="code" href="babelplugin_8c.html#a3">openbabel11filetypes</a>[i];
00325     ptr++;
00326     i++;
00327   }
00328   <font class="keywordflow">return</font> NULL;
00329 }
00330 
00331 
00332 <font class="comment">/* </font>
00333 <font class="comment"> * Figure out the file type, call babel, and return a handle if successful.</font>
00334 <font class="comment"> * From this point we're just reading in a pdb file.</font>
00335 <font class="comment"> */</font>
<a name="l00336"></a><a class="code" href="babelplugin_8c.html#a14">00336</a> <font class="keyword">static</font> <font class="keywordtype">void</font> *<a class="code" href="babelplugin_8c.html#a14">open_babel_read</a>(<font class="keyword">const</font> <font class="keywordtype">char</font> *filename, <font class="keyword">const</font> <font class="keywordtype">char</font> *filetypename,
00337     <font class="keywordtype">int</font> *natoms) {
00338 
00339   <font class="keyword">const</font> <font class="keywordtype">char</font> *babelbin;
00340   <font class="keywordtype">char</font> *current_file;
00341   <a class="code" href="structpdbdata.html">pdbdata</a> *pdb;
00342   <font class="keywordtype">char</font> *s;
00343   <font class="keyword">const</font> <font class="keywordtype">char</font> *fmt;
00344   <font class="keywordtype">int</font> count = 0;
00345   <a class="code" href="structVMDDIR.html">VMDDIR</a> *dirp;
00346   <font class="keywordtype">char</font> *dp;
00347   <font class="keywordtype">char</font> temps[100];
00348   <font class="keywordtype">char</font> tempc;
00349   <font class="keywordtype">char</font> lastc;
00350   <font class="keywordtype">int</font> may_have_multi = 0;
00351   <font class="keywordtype">char</font> *tmp_multi = NULL;
00352   <font class="keyword">const</font> <font class="keywordtype">char</font> *filetype;
00353 
00354   babelbin = getenv(<font class="stringliteral">"VMDBABELBIN"</font>);
00355   <font class="keywordflow">if</font> (!babelbin) {
00356     fprintf(stderr, <font class="stringliteral">"Babel plugin needs VMDBABELBIN environment variable\n"</font>
00357                     <font class="stringliteral">"to point to location of Babel executable\n"</font>);
00358     <font class="keywordflow">return</font> NULL;
00359   }
00360 
00361 <font class="preprocessor">#if 0</font>
00362 <font class="preprocessor"></font>  <font class="comment">/* Try Open Babel file type names first... */</font> 
00363   filetype = <a class="code" href="babelplugin_8c.html#a13">openbabel11type_from_name</a>(filetypename);
00364   <font class="keywordflow">if</font> (!filetype) {
00365     fprintf(stderr, <font class="stringliteral">"No Open Babel 1.100.2 file type for '%s'\n"</font>, filetypename);
00366   }
00367 <font class="preprocessor">#endif</font>
00368 <font class="preprocessor"></font>
00369   <font class="comment">/* Try Babel 1.6 file type names if Open Babel didn't match */</font> 
00370   filetype = <a class="code" href="babelplugin_8c.html#a12">babel16type_from_name</a>(filetypename);
00371   <font class="keywordflow">if</font> (!filetype) {
00372     fprintf(stderr, <font class="stringliteral">"No Babel 1.6 file type for '%s'\n"</font>, filetypename);
00373     <font class="keywordflow">return</font> NULL;
00374   }
00375   s = (<font class="keywordtype">char</font> *)malloc(strlen(babelbin) +               
00376               strlen(<font class="stringliteral">" -i       -opdb "</font>) +
00377               strlen(filename) +
00378               strlen(<a class="code" href="babelplugin_8c.html#a9">file</a>(filename, 0, 1)) +
00379               20);
00380  
00381   <font class="comment">/*</font>
00382 <font class="comment">  // On windows its necessary to quote command names due to</font>
00383 <font class="comment">  // the high tendency for paths to have spaces in them.</font>
00384 <font class="comment">  */</font>
00385   sprintf(s, <font class="stringliteral">"\"%s\" -i%s \"%s\" all -opdb \"%s\""</font>,
00386      babelbin, filetype, filename, (<font class="keyword">const</font> <font class="keywordtype">char</font> *)<a class="code" href="babelplugin_8c.html#a9">file</a>(filename, 0, 0));
00387 
00388   <a class="code" href="babelplugin_8c.html#a10">delete_all</a>(filename);       <font class="comment">/* delete any conflicting existing files  */</font>
00389   system(s);                  <font class="comment">/* run the babel command                  */</font>
00390   free(s);
00391 
00392   <font class="comment">/* now find how many frames were printed */</font>
00393   fmt = <a class="code" href="babelplugin_8c.html#a9">file</a>(filename, 0, -2);
00394   dirp = <a class="code" href="vmddir_8h.html#a1">vmd_opendir</a>(<a class="code" href="babelplugin_8c.html#a0">BABEL_TMPDIR</a>);
00395   <font class="keywordflow">if</font> (dirp == NULL) {
00396     <font class="keywordflow">return</font> NULL; <font class="comment">/* failure */</font>
00397   }
00398  
00399    lastc = *(filename + strlen(filename) -1);
00400 
00401    <font class="keywordflow">while</font> ((dp = <a class="code" href="vmddir_8h.html#a2">vmd_readdir</a>(dirp)) != NULL) {
00402       <font class="keywordflow">if</font> (sscanf(dp, fmt, temps, &amp;tempc) &gt; 1 &amp;&amp; lastc == tempc) {
00403      count++;
00404      <font class="comment">/* check if there is 1 element but Babel thinks there are several */</font>
00405      <font class="keywordflow">if</font> (count == 1) {
00406         <font class="keywordflow">if</font> (strstr(dp, <font class="stringliteral">"0001."</font>)) {
00407            may_have_multi = 1;
00408            tmp_multi = strdup(dp);
00409         }
00410      }
00411       }
00412    }
00413    <a class="code" href="vmddir_8h.html#a3">vmd_closedir</a>(dirp);
00414 
00415    <font class="keywordflow">if</font> (may_have_multi &amp;&amp; count == 1) {
00416       <font class="comment">/* then move the test0001.extension file to test.extension */</font>
00417       <font class="keywordtype">char</font> *s2, *t2;
00418       s2 = (<font class="keywordtype">char</font> *)malloc(2*(strlen(tmp_multi)+strlen(<a class="code" href="babelplugin_8c.html#a0">BABEL_TMPDIR</a>))+40);
00419 
00420 <font class="preprocessor">#if defined(_MSC_VER)</font>
00421 <font class="preprocessor"></font>      sprintf(s2, <font class="stringliteral">"move \"%s\\%s\" \"%s\\\""</font>, <a class="code" href="babelplugin_8c.html#a0">BABEL_TMPDIR</a>, tmp_multi, <a class="code" href="babelplugin_8c.html#a0">BABEL_TMPDIR</a>);
00422 <font class="preprocessor">#else</font>
00423 <font class="preprocessor"></font>      sprintf(s2, <font class="stringliteral">"mv \"%s/%s\" \"%s/\""</font>, <a class="code" href="babelplugin_8c.html#a0">BABEL_TMPDIR</a>, tmp_multi, <a class="code" href="babelplugin_8c.html#a0">BABEL_TMPDIR</a>);
00424 <font class="preprocessor">#endif</font>
00425 <font class="preprocessor"></font>
00426       t2 = strstr(tmp_multi, <font class="stringliteral">"0001."</font>);
00427       *t2 = 0;
00428       strcat(s2, tmp_multi);
00429       strcat(s2, t2 + 4);
00430       fprintf(stderr, <font class="stringliteral">"%s\n"</font>, s2);
00431       system(s2);
00432       free(s2);
00433    }
00434 
00435    <font class="keywordflow">if</font> (tmp_multi) {
00436       free(tmp_multi);
00437    }
00438 
00439   <font class="comment">/*</font>
00440 <font class="comment">   * Ok, now that we're done with all that crap, we should have a bunch</font>
00441 <font class="comment">   * of temp files.  Now we need to open the first one to get the</font>
00442 <font class="comment">   * number of atoms.</font>
00443 <font class="comment">   */</font>
00444   <font class="keywordflow">if</font> (count == 0) {
00445     fprintf(stderr, <font class="stringliteral">"Babel molecule file translation failed!\n"</font>);
00446     <font class="keywordflow">return</font> NULL;
00447   }
00448   current_file = <a class="code" href="babelplugin_8c.html#a9">file</a>(filename, 0, count &gt; 1);
00449   pdb = <a class="code" href="pdbplugin_8c.html#a2">open_pdb_read</a>(current_file, natoms);
00450   <font class="keywordflow">if</font> (!pdb) {
00451     fprintf(stderr, <font class="stringliteral">"Couldn't read structure from Babel pdb output\n"</font>);
00452     free(current_file);
00453     <font class="keywordflow">return</font> NULL;
00454   }
00455   pdb-&gt;<a class="code" href="structpdbdata.html#m2">original_file</a> = strdup(filename); 
00456   pdb-&gt;<a class="code" href="structpdbdata.html#m3">current_file</a> = current_file;
00457   pdb-&gt;<a class="code" href="structpdbdata.html#m4">babel_num</a> = count;
00458   pdb-&gt;<a class="code" href="structpdbdata.html#m5">babel_i</a> = 1;
00459   <font class="keywordflow">return</font> pdb;
00460 }
00461 
<a name="l00462"></a><a class="code" href="babelplugin_8c.html#a15">00462</a> <font class="keyword">static</font> <font class="keywordtype">int</font> <a class="code" href="webpdbplugin_8c.html#a6">read_pdb_structure</a>(<font class="keywordtype">void</font> *mydata, <font class="keywordtype">int</font> *optflags, 
00463     <a class="code" href="structmolfile__atom__t.html">molfile_atom_t</a> *atoms) {
00464   <a class="code" href="structpdbdata.html">pdbdata</a> *pdb = (<a class="code" href="structpdbdata.html">pdbdata</a> *)mydata;
00465   <a class="code" href="structmolfile__atom__t.html">molfile_atom_t</a> *atom;
00466   <font class="keywordtype">char</font> pdbrec[<a class="code" href="readpdb_8h.html#a1">PDB_BUFFER_LENGTH</a>];
00467   <font class="keywordtype">int</font> i, rectype, atomserial, pteidx;
00468   <font class="keywordtype">char</font> ridstr[8];
00469   <font class="keywordtype">char</font> elementsymbol[3];
00470   <font class="keywordtype">int</font> badptecount = 0;
00471   <font class="keywordtype">long</font> fpos = ftell(pdb-&gt;<a class="code" href="structpdbdata.html#m0">fd</a>);
00472  
00473   *optflags = <a class="code" href="molfile__plugin_8h.html#a9">MOLFILE_INSERTION</a> | <a class="code" href="molfile__plugin_8h.html#a10">MOLFILE_OCCUPANCY</a> | <a class="code" href="molfile__plugin_8h.html#a11">MOLFILE_BFACTOR</a> | 
00474               <a class="code" href="molfile__plugin_8h.html#a15">MOLFILE_ALTLOC</a> | <a class="code" href="molfile__plugin_8h.html#a16">MOLFILE_ATOMICNUMBER</a>;
00475 
00476   i = 0;
00477   <font class="keywordflow">do</font> {
00478     rectype = <a class="code" href="readpdb_8h.html#a11">read_pdb_record</a>(pdb-&gt;<a class="code" href="structpdbdata.html#m0">fd</a>, pdbrec);
00479     <font class="keywordflow">switch</font> (rectype) {
00480     <font class="keywordflow">case</font> <a class="code" href="readpdb_8h.html#a19a5">PDB_ATOM</a>:
00481       atom = atoms+i;
00482       <a class="code" href="readpdb_8h.html#a17">get_pdb_fields</a>(pdbrec, strlen(pdbrec), &amp;atomserial,
00483           atom-&gt;<a class="code" href="structmolfile__atom__t.html#m0">name</a>, atom-&gt;<a class="code" href="structmolfile__atom__t.html#m2">resname</a>, atom-&gt;<a class="code" href="structmolfile__atom__t.html#m5">chain</a>, atom-&gt;<a class="code" href="structmolfile__atom__t.html#m4">segid</a>, 
00484           ridstr, atom-&gt;<a class="code" href="structmolfile__atom__t.html#m7">insertion</a>, atom-&gt;<a class="code" href="structmolfile__atom__t.html#m6">altloc</a>, elementsymbol,
00485           NULL, NULL, NULL, &amp;atom-&gt;<a class="code" href="structmolfile__atom__t.html#m8">occupancy</a>, &amp;atom-&gt;<a class="code" href="structmolfile__atom__t.html#m9">bfactor</a>);
00486       atom-&gt;<a class="code" href="structmolfile__atom__t.html#m3">resid</a> = atoi(ridstr);
00487 
00488       <font class="comment">/* determine atomic number from the element symbol */</font>
00489       pteidx = <a class="code" href="periodic__table_8h.html#a8">get_pte_idx_from_string</a>(elementsymbol);
00490       atom-&gt;<a class="code" href="structmolfile__atom__t.html#m13">atomicnumber</a> = pteidx;
00491       <font class="keywordflow">if</font> (pteidx != 0) {
00492         atom-&gt;<a class="code" href="structmolfile__atom__t.html#m10">mass</a> = <a class="code" href="periodic__table_8h.html#a5">get_pte_mass</a>(pteidx);
00493         atom-&gt;<a class="code" href="structmolfile__atom__t.html#m12">radius</a> = <a class="code" href="periodic__table_8h.html#a6">get_pte_vdw_radius</a>(pteidx);
00494       } <font class="keywordflow">else</font> {
00495         badptecount++; <font class="comment">/* unrecognized element */</font>
00496       }
00497       strcpy(atom-&gt;<a class="code" href="structmolfile__atom__t.html#m1">type</a>, atom-&gt;<a class="code" href="structmolfile__atom__t.html#m0">name</a>);
00498       i++;
00499       <font class="keywordflow">break</font>;
00500     <font class="keywordflow">default</font>:
00501       <font class="keywordflow">break</font>;
00502     }
00503   } <font class="keywordflow">while</font> (rectype != <a class="code" href="readpdb_8h.html#a19a8">PDB_END</a> &amp;&amp; rectype != <a class="code" href="readpdb_8h.html#a19a9">PDB_EOF</a>);
00504 
00505   fseek(pdb-&gt;<a class="code" href="structpdbdata.html#m0">fd</a>, fpos, SEEK_SET);
00506 
00507   <font class="comment">/* if all atoms are recognized, set the mass and radius flags too,  */</font>
00508   <font class="comment">/* otherwise let VMD guess these for itself using it's own methods  */</font>
00509   <font class="keywordflow">if</font> (badptecount == 0) {
00510     *optflags |= <a class="code" href="molfile__plugin_8h.html#a12">MOLFILE_MASS</a> | <a class="code" href="molfile__plugin_8h.html#a14">MOLFILE_RADIUS</a>;
00511   }
00512 
00513   <font class="keywordflow">return</font> <a class="code" href="molfile__plugin_8h.html#a2">MOLFILE_SUCCESS</a>;
00514 }
00515 
<a name="l00516"></a><a class="code" href="babelplugin_8c.html#a16">00516</a> <font class="keyword">static</font> <font class="keywordtype">int</font> <a class="code" href="webpdbplugin_8c.html#a8">read_next_timestep</a>(<font class="keywordtype">void</font> *v, <font class="keywordtype">int</font> natoms, <a class="code" href="structmolfile__timestep__t.html">molfile_timestep_t</a> *ts) {
00517   <a class="code" href="structpdbdata.html">pdbdata</a> *pdb = (<a class="code" href="structpdbdata.html">pdbdata</a> *)v;
00518   <font class="keywordtype">char</font> pdbstr[<a class="code" href="readpdb_8h.html#a1">PDB_BUFFER_LENGTH</a>];
00519   <font class="keywordtype">int</font> indx, i;
00520   <font class="keywordtype">float</font> *x, *y, *z;
00521   <font class="keywordtype">float</font> occup[1], beta[1];
00522   <font class="keywordflow">if</font> (ts) {
00523     x = ts-&gt;<a class="code" href="structmolfile__timestep__t.html#m0">coords</a>;
00524     y = x+1;
00525     z = x+2;
00526   } <font class="keywordflow">else</font> {
00527     x = y = z = 0;
00528   }
00529   i = 0;
00530   <font class="keywordflow">if</font> (!pdb-&gt;<a class="code" href="structpdbdata.html#m0">fd</a>) 
00531     <font class="keywordflow">return</font> <a class="code" href="molfile__plugin_8h.html#a4">MOLFILE_ERROR</a>;
00532 
00533   <font class="comment">/* Read the rest of the frames in the current fd.  If there aren't any</font>
00534 <font class="comment">   * more close it and go on to the next one.  If there aren't any more frames,</font>
00535 <font class="comment">   * return MOLFILE_ERROR (-1);</font>
00536 <font class="comment">   */</font>
00537   
00538   <font class="keywordflow">while</font> (i &lt; pdb-&gt;<a class="code" href="structpdbdata.html#m1">natoms</a>) {
00539     indx = <a class="code" href="readpdb_8h.html#a11">read_pdb_record</a>(pdb-&gt;<a class="code" href="structpdbdata.html#m0">fd</a>, pdbstr);
00540     <font class="keywordflow">if</font>(indx == <a class="code" href="readpdb_8h.html#a19a5">PDB_ATOM</a>) {
00541       <font class="comment">/* just get the coordinates, and store them */</font>
00542       <font class="keywordflow">if</font> (ts) {
00543         <a class="code" href="readpdb_8h.html#a13">get_pdb_coordinates</a>(pdbstr, x, y, z, occup, beta);
00544         x += 3;
00545         y += 3;
00546         z += 3;
00547         i++;
00548       }
00549     } <font class="keywordflow">else</font> <font class="keywordflow">if</font> (indx == <a class="code" href="readpdb_8h.html#a19a10">PDB_CRYST1</a>) {
00550       <font class="keywordflow">if</font> (ts) {
00551         <a class="code" href="readpdb_8h.html#a12">get_pdb_cryst1</a>(pdbstr, &amp;ts-&gt;<a class="code" href="structmolfile__timestep__t.html#z4_3">alpha</a>, &amp;ts-&gt;<a class="code" href="structmolfile__timestep__t.html#z4_4">beta</a>, &amp;ts-&gt;<a class="code" href="structmolfile__timestep__t.html#z4_5">gamma</a>,
00552                                &amp;ts-&gt;<a class="code" href="structmolfile__timestep__t.html#z4_0">A</a>, &amp;ts-&gt;<a class="code" href="structmolfile__timestep__t.html#z4_1">B</a>, &amp;ts-&gt;<a class="code" href="structmolfile__timestep__t.html#z4_2">C</a>);
00553       }
00554     } <font class="keywordflow">else</font> <font class="keywordflow">if</font> (indx == <a class="code" href="readpdb_8h.html#a19a9">PDB_EOF</a>) {
00555       <font class="keywordflow">if</font> (i == 0) {
00556         <font class="comment">/* Need to start a new frame, if possible */</font>
00557         fclose(pdb-&gt;<a class="code" href="structpdbdata.html#m0">fd</a>);
00558         pdb-&gt;<a class="code" href="structpdbdata.html#m0">fd</a> = 0;
00559         <a class="code" href="babelplugin_8c.html#a8">vmd_delete_file</a>(pdb-&gt;<a class="code" href="structpdbdata.html#m3">current_file</a>);
00560         free(pdb-&gt;<a class="code" href="structpdbdata.html#m3">current_file</a>);
00561         pdb-&gt;<a class="code" href="structpdbdata.html#m3">current_file</a> = 0;
00562         pdb-&gt;<a class="code" href="structpdbdata.html#m5">babel_i</a>++;
00563         <font class="keywordflow">if</font> (pdb-&gt;<a class="code" href="structpdbdata.html#m5">babel_i</a> &gt;= pdb-&gt;<a class="code" href="structpdbdata.html#m4">babel_num</a>) 
00564           <font class="keywordflow">return</font> <a class="code" href="molfile__plugin_8h.html#a4">MOLFILE_ERROR</a>; 
00565         pdb-&gt;<a class="code" href="structpdbdata.html#m3">current_file</a> = <a class="code" href="babelplugin_8c.html#a9">file</a>(pdb-&gt;<a class="code" href="structpdbdata.html#m2">original_file</a>, pdb-&gt;<a class="code" href="structpdbdata.html#m5">babel_i</a>, pdb-&gt;<a class="code" href="structpdbdata.html#m4">babel_num</a> &gt; 1); 
00566         pdb-&gt;<a class="code" href="structpdbdata.html#m0">fd</a> = fopen(pdb-&gt;<a class="code" href="structpdbdata.html#m3">current_file</a>, <font class="stringliteral">"r"</font>);
00567         <font class="keywordflow">if</font> (!pdb-&gt;<a class="code" href="structpdbdata.html#m0">fd</a>) {
00568           fprintf(stderr, 
00569             <font class="stringliteral">"Couldn't read babel output file %s\n"</font>, pdb-&gt;<a class="code" href="structpdbdata.html#m3">current_file</a>); 
00570           free(pdb-&gt;<a class="code" href="structpdbdata.html#m3">current_file</a>);
00571           pdb-&gt;<a class="code" href="structpdbdata.html#m3">current_file</a> = 0;
00572           <font class="keywordflow">return</font> <a class="code" href="molfile__plugin_8h.html#a4">MOLFILE_ERROR</a>; 
00573         } 
00574       } <font class="keywordflow">else</font> {
00575         <font class="comment">/* premature end */</font>
00576         fprintf(stderr, <font class="stringliteral">"PDB file %s contained too few atoms\n"</font>, pdb-&gt;<a class="code" href="structpdbdata.html#m3">current_file</a>);
00577         <font class="keywordflow">return</font> <a class="code" href="molfile__plugin_8h.html#a4">MOLFILE_ERROR</a>;
00578       }
00579     }
00580   }
00581 
00582   <font class="keywordflow">return</font> <a class="code" href="molfile__plugin_8h.html#a2">MOLFILE_SUCCESS</a>; 
00583 }
00584 
00585 <font class="comment">/* </font>
00586 <font class="comment"> * Free the pdb handle, and delete all the babel temp files.</font>
00587 <font class="comment"> */</font>
<a name="l00588"></a><a class="code" href="babelplugin_8c.html#a17">00588</a> <font class="keyword">static</font> <font class="keywordtype">void</font> <a class="code" href="webpdbplugin_8c.html#a9">close_pdb_read</a>(<font class="keywordtype">void</font> *v) {
00589   <a class="code" href="structpdbdata.html">pdbdata</a> *pdb = (<a class="code" href="structpdbdata.html">pdbdata</a> *)v;
00590   <font class="keywordflow">if</font> (!pdb) <font class="keywordflow">return</font>;
00591   <font class="keywordflow">if</font> (pdb-&gt;<a class="code" href="structpdbdata.html#m0">fd</a>) {
00592     fclose(pdb-&gt;<a class="code" href="structpdbdata.html#m0">fd</a>);
00593     pdb-&gt;<a class="code" href="structpdbdata.html#m0">fd</a> = 0;
00594     <a class="code" href="babelplugin_8c.html#a8">vmd_delete_file</a>(pdb-&gt;<a class="code" href="structpdbdata.html#m3">current_file</a>);
00595     free(pdb-&gt;<a class="code" href="structpdbdata.html#m3">current_file</a>);
00596   }
00597   free(pdb);
00598 }
00599 
00600 
00601 
00602 <font class="comment">/*</font>
00603 <font class="comment"> * Initialization stuff down here</font>
00604 <font class="comment"> */</font>
00605 
<a name="l00606"></a><a class="code" href="babelplugin_8c.html#a5">00606</a> <font class="keyword">static</font> <a class="code" href="structmolfile__plugin__t.html">molfile_plugin_t</a> *<a class="code" href="babelplugin_8c.html#a5">plugins</a>;
<a name="l00607"></a><a class="code" href="babelplugin_8c.html#a6">00607</a> <font class="keyword">static</font> <font class="keywordtype">int</font> <a class="code" href="babelplugin_8c.html#a6">nplugins</a>;
00608 
<a name="l00609"></a><a class="code" href="babelplugin_8c.html#a18">00609</a> <a class="code" href="vmdplugin_8h.html#a7">VMDPLUGIN_API</a> <font class="keywordtype">int</font> <a class="code" href="vmdplugin_8h.html#a5">VMDPLUGIN_init</a>() {
00610 <font class="preprocessor">#if defined(_MSC_VER)</font>
00611 <font class="preprocessor"></font>  <font class="keywordflow">return</font> <a class="code" href="vmdplugin_8h.html#a13">VMDPLUGIN_SUCCESS</a>;
00612 <font class="preprocessor">#else</font>
00613 <font class="preprocessor"></font>  <font class="comment">/* register all Babel 1.6 conversion options */</font>
00614   <font class="keyword">const</font> <font class="keywordtype">char</font> **s = <a class="code" href="babelplugin_8c.html#a2">babel16filetypenames</a>;
00615   <font class="keywordtype">int</font> i;
00616   <a class="code" href="babelplugin_8c.html#a6">nplugins</a> = 0;
00617   <font class="keywordflow">while</font> (*s) { <a class="code" href="babelplugin_8c.html#a6">nplugins</a>++; s++; }
00618   plugins = (<a class="code" href="structmolfile__plugin__t.html">molfile_plugin_t</a>*)calloc(<a class="code" href="babelplugin_8c.html#a6">nplugins</a>, <font class="keyword">sizeof</font>(<a class="code" href="structmolfile__plugin__t.html">molfile_plugin_t</a>));
00619   <font class="keywordflow">for</font> (i=0; i&lt;<a class="code" href="babelplugin_8c.html#a6">nplugins</a>; i++) {
00620     plugins[i].abiversion = <a class="code" href="vmdplugin_8h.html#a10">vmdplugin_ABIVERSION</a>;         <font class="comment">/* ABI version */</font>
00621     plugins[i].type = <a class="code" href="molfile__plugin_8h.html#a1">MOLFILE_CONVERTER_PLUGIN_TYPE</a>;      <font class="comment">/* type of plugin */</font>
00622     plugins[i].name = <a class="code" href="babelplugin_8c.html#a2">babel16filetypenames</a>[i];            <font class="comment">/* name of plugin */</font>
00623     plugins[i].prettyname = <a class="code" href="babelplugin_8c.html#a2">babel16filetypenames</a>[i];      <font class="comment">/* name of plugin */</font>
00624     plugins[i].author = <font class="stringliteral">"Justin Gullingsrud, John Stone"</font>; <font class="comment">/* author */</font>
00625     plugins[i].majorv = 1;                                <font class="comment">/* major version */</font>
00626     plugins[i].minorv = 9;                                <font class="comment">/* minor version */</font>
00627     plugins[i].is_reentrant = <a class="code" href="vmdplugin_8h.html#a11">VMDPLUGIN_THREADUNSAFE</a>;     <font class="comment">/* is not reentrant */</font>
00628     plugins[i].<a class="code" href="structmolfile__plugin__t.html#m0">filename_extension</a> = <a class="code" href="babelplugin_8c.html#a1">babel16filetypes</a>[i];  <font class="comment">/* file extension */</font>
00629     plugins[i].<a class="code" href="structmolfile__plugin__t.html#m1">open_file_read</a> = <a class="code" href="babelplugin_8c.html#a14">open_babel_read</a>;
00630     plugins[i].<a class="code" href="structmolfile__plugin__t.html#m2">read_structure</a> = <a class="code" href="babelplugin_8c.html#a15">read_pdb_structure</a>;
00631     plugins[i].<a class="code" href="structmolfile__plugin__t.html#m4">read_next_timestep</a> = <a class="code" href="babelplugin_8c.html#a16">read_next_timestep</a>;
00632     plugins[i].<a class="code" href="structmolfile__plugin__t.html#m5">close_file_read</a> = <a class="code" href="babelplugin_8c.html#a17">close_pdb_read</a>;
00633   }
00634 
00635 <font class="preprocessor">#if 0</font>
00636 <font class="preprocessor"></font>  <font class="comment">/* register all Open Babel 1.100.2 conversion options */</font>
00637   <font class="keyword">const</font> <font class="keywordtype">char</font> **s = <a class="code" href="babelplugin_8c.html#a4">openbabel11filetypenames</a>;
00638   <font class="keywordtype">int</font> i;
00639   <a class="code" href="babelplugin_8c.html#a6">nplugins</a> = 0;
00640   <font class="keywordflow">while</font> (*s) { <a class="code" href="babelplugin_8c.html#a6">nplugins</a>++; s++; }
00641   plugins = (<a class="code" href="structmolfile__plugin__t.html">molfile_plugin_t</a>*)calloc(<a class="code" href="babelplugin_8c.html#a6">nplugins</a>, <font class="keyword">sizeof</font>(<a class="code" href="structmolfile__plugin__t.html">molfile_plugin_t</a>));
00642   <font class="keywordflow">for</font> (i=0; i&lt;<a class="code" href="babelplugin_8c.html#a6">nplugins</a>; i++) {
00643     plugins[i].abiversion = <a class="code" href="vmdplugin_8h.html#a10">vmdplugin_ABIVERSION</a>;         <font class="comment">/* ABI version */</font>
00644     plugins[i].type = <a class="code" href="molfile__plugin_8h.html#a1">MOLFILE_CONVERTER_PLUGIN_TYPE</a>;      <font class="comment">/* type of plugin */</font>
00645     plugins[i].shortname = <a class="code" href="babelplugin_8c.html#a4">openbabel11filetypenames</a>[i];   <font class="comment">/* name of plugin */</font>
00646     plugins[i].prettyname = <a class="code" href="babelplugin_8c.html#a4">openbabel11filetypenames</a>[i];  <font class="comment">/* name of plugin */</font>
00647     plugins[i].author = <font class="stringliteral">"Justin Gullingsrud, John Stone"</font>; <font class="comment">/* author */</font>
00648     plugins[i].majorv = 2;                                <font class="comment">/* major version */</font>
00649     plugins[i].minorv = 8;                                <font class="comment">/* minor version */</font>
00650     plugins[i].is_reentrant = <a class="code" href="vmdplugin_8h.html#a11">VMDPLUGIN_THREADUNSAFE</a>;     <font class="comment">/* is not reentrant */</font>
00651     plugins[i].<a class="code" href="structmolfile__plugin__t.html#m0">filename_extension</a> = <a class="code" href="babelplugin_8c.html#a3">openbabel11filetypes</a>[i];  <font class="comment">/* file extension */</font>
00652     plugins[i].<a class="code" href="structmolfile__plugin__t.html#m1">open_file_read</a> = <a class="code" href="babelplugin_8c.html#a14">open_babel_read</a>;
00653     plugins[i].<a class="code" href="structmolfile__plugin__t.html#m2">read_structure</a> = <a class="code" href="babelplugin_8c.html#a15">read_pdb_structure</a>;
00654     plugins[i].<a class="code" href="structmolfile__plugin__t.html#m4">read_next_timestep</a> = <a class="code" href="babelplugin_8c.html#a16">read_next_timestep</a>;
00655     plugins[i].<a class="code" href="structmolfile__plugin__t.html#m5">close_file_read</a> = <a class="code" href="babelplugin_8c.html#a17">close_pdb_read</a>;
00656   }
00657 <font class="preprocessor">#endif</font>
00658 <font class="preprocessor"></font>
00659   <font class="keywordflow">return</font> <a class="code" href="vmdplugin_8h.html#a13">VMDPLUGIN_SUCCESS</a>;
00660 <font class="preprocessor">#endif</font>
00661 <font class="preprocessor"></font>}
00662 
<a name="l00663"></a><a class="code" href="babelplugin_8c.html#a19">00663</a> <a class="code" href="vmdplugin_8h.html#a7">VMDPLUGIN_API</a> <font class="keywordtype">int</font> <a class="code" href="vmdplugin_8h.html#a3">VMDPLUGIN_register</a>(<font class="keywordtype">void</font> *v, <a class="code" href="vmdplugin_8h.html#a15">vmdplugin_register_cb</a> cb) {
00664 <font class="preprocessor">#if defined(_MSC_VER)</font>
00665 <font class="preprocessor"></font>  <font class="keywordflow">return</font> <a class="code" href="vmdplugin_8h.html#a13">VMDPLUGIN_SUCCESS</a>;
00666 <font class="preprocessor">#else</font>
00667 <font class="preprocessor"></font>  <font class="keywordtype">int</font> i;
00668   <font class="keywordflow">for</font> (i=0; i&lt;<a class="code" href="babelplugin_8c.html#a6">nplugins</a>; i++) {
00669     (*cb)(v, (<a class="code" href="structvmdplugin__t.html">vmdplugin_t</a> *)(plugins+i));
00670   }
00671   <font class="keywordflow">return</font> <a class="code" href="vmdplugin_8h.html#a13">VMDPLUGIN_SUCCESS</a>;
00672 <font class="preprocessor">#endif</font>
00673 <font class="preprocessor"></font>}
00674 
<a name="l00675"></a><a class="code" href="babelplugin_8c.html#a20">00675</a> <a class="code" href="vmdplugin_8h.html#a7">VMDPLUGIN_API</a> <font class="keywordtype">int</font> <a class="code" href="vmdplugin_8h.html#a6">VMDPLUGIN_fini</a>() {
00676 <font class="preprocessor">#if defined(_MSC_VER)</font>
00677 <font class="preprocessor"></font>  <font class="keywordflow">return</font> <a class="code" href="vmdplugin_8h.html#a13">VMDPLUGIN_SUCCESS</a>;
00678 <font class="preprocessor">#else</font>
00679 <font class="preprocessor"></font>  free(plugins);
00680   <a class="code" href="babelplugin_8c.html#a6">nplugins</a> = 0;
00681   plugins = 0;
00682   <font class="keywordflow">return</font> <a class="code" href="vmdplugin_8h.html#a13">VMDPLUGIN_SUCCESS</a>;
00683 <font class="preprocessor">#endif</font>
00684 <font class="preprocessor"></font>}
00685 
00686 
00687 <font class="preprocessor">#ifdef TEST_BABEL_PLUGIN</font>
00688 <font class="preprocessor"></font>
00689 <font class="keywordtype">int</font> <a class="code" href="main_8c.html#a3">main</a>(<font class="keywordtype">int</font> argc, <font class="keywordtype">char</font> *argv[]) {
00690   molfile_header_t header;
00691   <a class="code" href="structmolfile__timestep__t.html">molfile_timestep_t</a> timestep;
00692   <font class="keywordtype">void</font> *v;
00693 
00694   <font class="keywordflow">while</font> (--argc) {
00695     ++argv;
00696     v = <a class="code" href="babelplugin_8c.html#a14">open_babel_read</a>(*argv, <font class="stringliteral">"xyz"</font>, &amp;header);
00697     <font class="keywordflow">if</font> (!v) {
00698       fprintf(stderr, <font class="stringliteral">"open_babel_read failed for file %s\n"</font>, *argv);
00699       <font class="keywordflow">return</font> 1;
00700     }
00701     timestep.<a class="code" href="structmolfile__timestep__t.html#m0">coords</a> = (<font class="keywordtype">float</font> *)malloc(3*<font class="keyword">sizeof</font>(<font class="keywordtype">float</font>)*header.numatoms);
00702     <font class="keywordflow">while</font> (!<a class="code" href="webpdbplugin_8c.html#a8">read_next_timestep</a>(v, &amp;timestep));
00703     <a class="code" href="webpdbplugin_8c.html#a9">close_pdb_read</a>(v);
00704   }
00705   <font class="keywordflow">return</font> 0;
00706 }
00707 
00708 
00709 <font class="preprocessor">#endif</font>
00710 <font class="preprocessor"></font>
00711 
</pre></div><hr><address><small>Generated on Wed Mar 22 13:15:28 2006 for VMD Plugins (current) by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.gif" alt="doxygen" align="middle" border=0 
width=110 height=53></a>1.2.14 written by <a href="mailto:dimitri@stack.nl">Dimitri van Heesch</a>,
 &copy;&nbsp;1997-2002</small></address>
</body>
</html>
