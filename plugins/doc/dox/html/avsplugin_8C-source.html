<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>avsplugin.C Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.2.14 -->
<center>
<a class="qindex" href="index.html">Main Page</a> &nbsp; <a class="qindex" href="classes.html">Alphabetical List</a> &nbsp; <a class="qindex" href="annotated.html">Compound List</a> &nbsp; <a class="qindex" href="files.html">File List</a> &nbsp; <a class="qindex" href="functions.html">Compound Members</a> &nbsp; <a class="qindex" href="globals.html">File Members</a> &nbsp; <a class="qindex" href="pages.html">Related Pages</a> &nbsp; </center>
<hr><h1>avsplugin.C</h1><a href="avsplugin_8C.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 <font class="comment">/***************************************************************************</font>
00002 <font class="comment"> *cr</font>
00003 <font class="comment"> *cr            (C) Copyright 1995-2006 The Board of Trustees of the</font>
00004 <font class="comment"> *cr                        University of Illinois</font>
00005 <font class="comment"> *cr                         All Rights Reserved</font>
00006 <font class="comment"> *cr</font>
00007 <font class="comment"> ***************************************************************************/</font>
00008 
00009 <font class="comment">/***************************************************************************</font>
00010 <font class="comment"> * RCS INFORMATION:</font>
00011 <font class="comment"> *</font>
00012 <font class="comment"> *      $RCSfile: avsplugin.C,v $</font>
00013 <font class="comment"> *      $Author: johns $       $Locker:  $             $State: Exp $</font>
00014 <font class="comment"> *      $Revision: 1.17 $       $Date: 2006/02/23 19:36:43 $</font>
00015 <font class="comment"> *</font>
00016 <font class="comment"> ***************************************************************************/</font>
00017 
00018 <font class="comment">/*</font>
00019 <font class="comment"> * AVS field files</font>
00020 <font class="comment"> *</font>
00021 <font class="comment"> * XXX - This plugin currently only supports the specific subset of AVS field</font>
00022 <font class="comment"> * files that are produced by autodock. 'field' type must be 'uniform',</font>
00023 <font class="comment"> * 'data' must be of type 'float', 'ndim' and 'nspace' must be 3, and</font>
00024 <font class="comment"> * 'filetype' of all files referenced must be 'ascii'. </font>
00025 <font class="comment"> *</font>
00026 <font class="comment"> * XXX - The plugin also expects the values to appear in a certain order,</font>
00027 <font class="comment"> * this should definitely be fixed.</font>
00028 <font class="comment"> *</font>
00029 <font class="comment"> * More info for this format can be found at</font>
00030 <font class="comment"> * &lt;http://astronomy.swin.edu.au/~pbourke/geomformats/field/&gt;</font>
00031 <font class="comment"> *</font>
00032 <font class="comment"> */</font>
00033 
00034 <font class="preprocessor">#include &lt;stdlib.h&gt;</font>
00035 <font class="preprocessor">#include &lt;stdio.h&gt;</font>
00036 <font class="preprocessor">#include &lt;ctype.h&gt;</font>
00037 <font class="preprocessor">#include &lt;string.h&gt;</font>
00038 
00039 <font class="preprocessor">#if defined(_AIX)</font>
00040 <font class="preprocessor"></font><font class="preprocessor">#include &lt;strings.h&gt;</font>
00041 <font class="preprocessor">#endif</font>
00042 <font class="preprocessor"></font>
00043 <font class="preprocessor">#if defined(WIN32) || defined(WIN64)</font>
00044 <font class="preprocessor"></font><font class="preprocessor">#define strcasecmp  stricmp</font>
00045 <font class="preprocessor"></font><font class="preprocessor">#define strncasecmp strnicmp</font>
00046 <font class="preprocessor"></font><font class="preprocessor">#endif</font>
00047 <font class="preprocessor"></font>
00048 <font class="preprocessor">#include "<a class="code" href="molfile__plugin_8h.html">molfile_plugin.h</a>"</font>
00049 
<a name="l00050"></a><a class="code" href="avsplugin_8C.html#a0">00050</a> <font class="preprocessor">#define LINESIZE 256</font>
00051 <font class="preprocessor"></font>
<a name="l00052"></a><a class="code" href="structdatasource__t.html">00052</a> <font class="keyword">typedef</font> <font class="keyword">struct </font>{
<a name="l00053"></a><a class="code" href="structdatasource__t.html#m0">00053</a>   <font class="keywordtype">char</font> filename[256]; <font class="comment">/* XXX - LAME */</font>
<a name="l00054"></a><a class="code" href="structdatasource__t.html#m4">00054</a>   <font class="keywordtype">int</font> filetype, skip, offset, stride;
00055 } <a class="code" href="structdatasource__t.html">datasource_t</a>;
00056 
<a name="l00057"></a><a class="code" href="structavsfield__t.html">00057</a> <font class="keyword">typedef</font> <font class="keyword">struct </font>{
<a name="l00058"></a><a class="code" href="structavsfield__t.html#m0">00058</a>   <font class="keywordtype">int</font> nsets;
<a name="l00059"></a><a class="code" href="structavsfield__t.html#m1">00059</a>   <a class="code" href="structmolfile__volumetric__t.html">molfile_volumetric_t</a> *vol;
<a name="l00060"></a><a class="code" href="structavsfield__t.html#m2">00060</a>   <a class="code" href="structdatasource__t.html">datasource_t</a> *data;
00061 } <a class="code" href="structavsfield__t.html">avsfield_t</a>;
00062 
00063 <font class="keyword">enum</font> {<a class="code" href="avsplugin_8C.html#a19a2">NONE</a>, <a class="code" href="avsplugin_8C.html#a19a3">ASCII</a>, <a class="code" href="avsplugin_8C.html#a19a4">BINARY</a>, <a class="code" href="avsplugin_8C.html#a19a5">UNFORMATTED</a>};  <font class="comment">/* File types */</font>
00064 <font class="keyword">enum</font> {<a class="code" href="avsplugin_8C.html#a20a6">UNIFORM</a>, <a class="code" href="avsplugin_8C.html#a20a7">IRREGULAR</a>, <a class="code" href="avsplugin_8C.html#a20a8">RECTILINEAR</a>};   <font class="comment">/* Field types */</font>
00065 <font class="keyword">enum</font> {<a class="code" href="avsplugin_8C.html#a21a9">AVSFLOAT</a>};                          <font class="comment">/* Data types */</font>
00066 
00067 <font class="comment">/* Reads lines from the stream into the array pointed to by s.</font>
00068 <font class="comment"> * Returns a pointer to s when the first non-comment line is read or NULL on</font>
00069 <font class="comment"> * error.</font>
00070 <font class="comment"> */</font>
<a name="l00071"></a><a class="code" href="avsplugin_8C.html#a10">00071</a> <font class="keyword">static</font> <font class="keywordtype">char</font> *<a class="code" href="avsplugin_8C.html#a10">get_string</a>(<font class="keywordtype">char</font> *s, <font class="keywordtype">int</font> n, FILE *stream) {
00072   <font class="keywordflow">do</font> {
00073     <font class="keywordflow">if</font> (fgets(s, n, stream) == NULL) {
00074       fprintf(stderr, <font class="stringliteral">"Error reading string.\n"</font>);
00075       <font class="keywordflow">return</font> NULL;
00076     }
00077   } <font class="keywordflow">while</font> (s[0] == <font class="charliteral">'#'</font>);
00078   <font class="keywordflow">return</font> s;
00079 }
00080 
00081 <font class="comment">/* Read information from a string and store it into a datasource structure.</font>
00082 <font class="comment"> * Returns 0 on success, 1 on error.</font>
00083 <font class="comment"> */</font>
<a name="l00084"></a><a class="code" href="avsplugin_8C.html#a11">00084</a> <font class="keyword">static</font> <font class="keywordtype">int</font> <a class="code" href="avsplugin_8C.html#a11">read_datasource</a>(<font class="keywordtype">char</font> *s, <a class="code" href="structdatasource__t.html">datasource_t</a> *data) {
00085   <font class="keywordtype">char</font> *src, *tok, *value;
00086   src = strdup(s);
00087   tok = strtok(src, <font class="stringliteral">" \t\n"</font>);
00088 
00089   <font class="comment">/* Load default values -- used if these attributes aren't set */</font>
00090   data-&gt;<a class="code" href="structdatasource__t.html#m2">skip</a> = 0;
00091   data-&gt;<a class="code" href="structdatasource__t.html#m3">offset</a> = 0;
00092   data-&gt;<a class="code" href="structdatasource__t.html#m4">stride</a> = 1;
00093 
00094   <font class="comment">/* Load default values -- must be changed */</font>
00095   data-&gt;<a class="code" href="structdatasource__t.html#m0">filename</a>[0] = <font class="charliteral">'\0'</font>;
00096   data-&gt;<a class="code" href="structdatasource__t.html#m1">filetype</a> = <a class="code" href="avsplugin_8C.html#a19a2">NONE</a>;
00097 
00098   <font class="comment">/* The first word should be "coord" or "variable" */</font>
00099   <font class="keywordflow">if</font> ( (strcasecmp(tok, <font class="stringliteral">"coord"</font>) != 0) &amp;&amp; (strcasecmp(tok, <font class="stringliteral">"variable"</font>) != 0) ) {
00100     fprintf(stderr, <font class="stringliteral">"Improperly formatted header: expected coord or variable.\n"</font>);
00101     free(src);
00102     <font class="keywordflow">return</font> 1;
00103   }
00104 
00105   <font class="comment">/* Next should be the integer ID of the data source */</font>
00106   tok = strtok(NULL, <font class="stringliteral">" \t\n"</font>);
00107   <font class="keywordflow">if</font> (!isdigit(*tok)) {
00108     fprintf(stderr, <font class="stringliteral">"Improperly formatted header: expected ID.\n"</font>);
00109     free(src);
00110     <font class="keywordflow">return</font> 1;
00111   }
00112 
00113   <font class="comment">/* Now read the additional arguments */</font>
00114   tok = strtok(NULL, <font class="stringliteral">" \t\n"</font>);
00115   <font class="keywordflow">while</font>(tok) {
00116     value = strchr(tok, <font class="charliteral">'='</font>);
00117     <font class="keywordflow">if</font> (!value) {
00118       fprintf(stderr, <font class="stringliteral">"Error reading value.\n"</font>);
00119       free(src);
00120       <font class="keywordflow">return</font> 1;
00121     }
00122     value++; <font class="comment">/* Point to the first character after '=' */</font>
00123 
00124     <font class="keywordflow">if</font> (strncasecmp(tok, <font class="stringliteral">"file="</font>, value - tok) == 0) {
00125       <font class="comment">/* XXX - This should be changed to something safer */</font>
00126       strcpy(data-&gt;<a class="code" href="structdatasource__t.html#m0">filename</a>, value);
00127     }
00128     <font class="keywordflow">else</font> <font class="keywordflow">if</font> (strncasecmp(tok, <font class="stringliteral">"filetype="</font>, value - tok) == 0) {
00129       <font class="comment">/* XXX - For now, only ascii files are recognized. Other possible</font>
00130 <font class="comment">       * values are "unformatted" for unformatted Fortran data, and "binary"</font>
00131 <font class="comment">       * for raw binary data.</font>
00132 <font class="comment">       */</font>
00133       <font class="keywordflow">if</font> (strcasecmp(value, <font class="stringliteral">"ascii"</font>) == 0) {
00134         data-&gt;<a class="code" href="structdatasource__t.html#m1">filetype</a> = <a class="code" href="avsplugin_8C.html#a19a3">ASCII</a>;
00135       }
00136       <font class="keywordflow">else</font> {
00137         fprintf(stderr, <font class="stringliteral">"Non-ASCII files are not supported.\n"</font>);
00138         free(src);
00139         <font class="keywordflow">return</font> 1;
00140       }
00141     }
00142     <font class="keywordflow">else</font> <font class="keywordflow">if</font> (strncasecmp(tok, <font class="stringliteral">"skip="</font>, value - tok) == 0) {
00143       <font class="comment">/* XXX - This should probably be more rigorous */</font>
00144       data-&gt;<a class="code" href="structdatasource__t.html#m2">skip</a> = atoi(value);
00145     }
00146     <font class="keywordflow">else</font> <font class="keywordflow">if</font> (strncasecmp(tok, <font class="stringliteral">"offset="</font>, value - tok) == 0) {
00147       <font class="comment">/* XXX - This should probably be more rigorous */</font>
00148       data-&gt;<a class="code" href="structdatasource__t.html#m3">offset</a> = atoi(value);
00149     }
00150     <font class="keywordflow">else</font> <font class="keywordflow">if</font> (strncasecmp(tok, <font class="stringliteral">"stride="</font>, value - tok) == 0) {
00151       <font class="comment">/* XXX - This should definitely be more rigorous -- we don't want</font>
00152 <font class="comment">       * stride set to 0 of the value isn't an integer. */</font>
00153       data-&gt;<a class="code" href="structdatasource__t.html#m4">stride</a> = atoi(value);
00154     }
00155     <font class="keywordflow">else</font> {
00156       <font class="comment">/* XXX - For now, return with an error if there's an unrecognized</font>
00157 <font class="comment">       * argument. This should probably be changed.</font>
00158 <font class="comment">       */</font>
00159       fprintf(stderr, <font class="stringliteral">"Unrecognized argument.\n"</font>);
00160       free(src);
00161       <font class="keywordflow">return</font> 1;
00162     }
00163 
00164     tok = strtok(NULL, <font class="stringliteral">" \t\n"</font>);
00165   }
00166 
00167   free(src);
00168 
00169   <font class="comment">/* Make sure the filename and filetype have been set */</font>
00170   <font class="keywordflow">if</font> ((data-&gt;<a class="code" href="structdatasource__t.html#m0">filename</a>[0] == <font class="charliteral">'\0'</font>) || (data-&gt;<a class="code" href="structdatasource__t.html#m1">filetype</a> == <a class="code" href="avsplugin_8C.html#a19a2">NONE</a>)) {
00171     fprintf(stderr, <font class="stringliteral">"Filename not set in options.\n"</font>);
00172     <font class="keywordflow">return</font> 1;
00173   }
00174   
00175   <font class="keywordflow">return</font> 0;
00176 }
00177 
<a name="l00178"></a><a class="code" href="avsplugin_8C.html#a12">00178</a> <font class="keyword">static</font> <font class="keywordtype">void</font> *<a class="code" href="avsplugin_8C.html#a12">open_avsfield_read</a>(<font class="keyword">const</font> <font class="keywordtype">char</font> *filepath, <font class="keyword">const</font> <font class="keywordtype">char</font> *filetype, <font class="keywordtype">int</font> *natoms) {
00179   <a class="code" href="structavsfield__t.html">avsfield_t</a> *avsfield;
00180   FILE *fd;
00181   <font class="keywordtype">char</font> inbuf[<a class="code" href="avsplugin_8C.html#a0">LINESIZE</a>], current_file[256];
00182   <font class="keywordtype">int</font> ndim, nspace, veclen, xsize, ysize, zsize, 
00183       index, i, coord_count, var_count;
00184   <font class="keywordtype">float</font> value, origin[3], gridlength[3];
00185   <a class="code" href="structdatasource__t.html">datasource_t</a> *coord = NULL, *variable = NULL;
00186 
00187   fd = fopen(filepath, <font class="stringliteral">"rb"</font>);
00188   <font class="keywordflow">if</font> (!fd) {
00189     fprintf(stderr, <font class="stringliteral">"Error opening file.\n"</font>);
00190     <font class="keywordflow">return</font> NULL;
00191   }
00192 
00193   <font class="comment">/* Check for an AVS file */</font>
00194   <font class="keywordflow">if</font> (fgets(inbuf, <a class="code" href="avsplugin_8C.html#a0">LINESIZE</a>, fd) == NULL) {
00195     fclose(fd);
00196     fprintf(stderr, <font class="stringliteral">"Error reading line.\n"</font>);
00197     <font class="keywordflow">return</font> NULL;
00198   }
00199   <font class="keywordflow">if</font> (strncmp(inbuf, <font class="stringliteral">"# AVS"</font>, 5) != 0) {
00200     fclose(fd);
00201     fprintf(stderr, <font class="stringliteral">"Improperly formatted header.\n"</font>);
00202     <font class="keywordflow">return</font> NULL;
00203   }
00204 
00205   <font class="comment">/* Check the number of dimensions */</font>
00206   <font class="keywordflow">if</font> (<a class="code" href="avsplugin_8C.html#a10">get_string</a>(inbuf, <a class="code" href="avsplugin_8C.html#a0">LINESIZE</a>, fd) == NULL) {
00207     fclose(fd);
00208     <font class="keywordflow">return</font> NULL;
00209   }
00210   <font class="keywordflow">if</font> (sscanf(inbuf, <font class="stringliteral">"ndim=%d"</font>, &amp;ndim) != 1) {
00211     fprintf(stderr, <font class="stringliteral">"Error reading ndim.\n"</font>);
00212     fclose(fd);
00213     <font class="keywordflow">return</font> NULL;
00214   }
00215   <font class="keywordflow">if</font> (ndim != 3) {
00216     fprintf(stderr, <font class="stringliteral">"Error: ndim must be 3.\n"</font>);
00217     fclose(fd);
00218     <font class="keywordflow">return</font> NULL;
00219   }
00220 
00221   <font class="comment">/* Find the size of the grid in grid units */</font>
00222   <font class="keywordflow">if</font> (<a class="code" href="avsplugin_8C.html#a10">get_string</a>(inbuf, <a class="code" href="avsplugin_8C.html#a0">LINESIZE</a>, fd) == NULL) {
00223     fclose(fd);
00224     <font class="keywordflow">return</font> NULL;
00225   }
00226   <font class="keywordflow">if</font> (sscanf(inbuf, <font class="stringliteral">"dim1=%d"</font>, &amp;xsize) != 1) {
00227     fprintf(stderr, <font class="stringliteral">"Error reading dim1.\n"</font>);
00228     fclose(fd);
00229     <font class="keywordflow">return</font> NULL;
00230   }
00231   <font class="keywordflow">if</font> (<a class="code" href="avsplugin_8C.html#a10">get_string</a>(inbuf, <a class="code" href="avsplugin_8C.html#a0">LINESIZE</a>, fd) == NULL) {
00232     fclose(fd);
00233     <font class="keywordflow">return</font> NULL;
00234   }
00235   <font class="keywordflow">if</font> (sscanf(inbuf, <font class="stringliteral">"dim2=%d"</font>, &amp;ysize) != 1) {
00236     fprintf(stderr, <font class="stringliteral">"Error reading dim2.\n"</font>);
00237     fclose(fd);
00238     <font class="keywordflow">return</font> NULL;
00239   }
00240   <font class="keywordflow">if</font> (<a class="code" href="avsplugin_8C.html#a10">get_string</a>(inbuf, <a class="code" href="avsplugin_8C.html#a0">LINESIZE</a>, fd) == NULL) {
00241     fclose(fd);
00242     <font class="keywordflow">return</font> NULL;
00243   }
00244   <font class="keywordflow">if</font> (sscanf(inbuf, <font class="stringliteral">"dim3=%d"</font>, &amp;zsize) != 1) {
00245     fprintf(stderr, <font class="stringliteral">"Error reading dim3.\n"</font>);
00246     fclose(fd);
00247     <font class="keywordflow">return</font> NULL;
00248   }
00249 
00250   <font class="comment">/* Check the number of coordinates per point */</font>
00251   <font class="keywordflow">if</font> (<a class="code" href="avsplugin_8C.html#a10">get_string</a>(inbuf, <a class="code" href="avsplugin_8C.html#a0">LINESIZE</a>, fd) == NULL) {
00252     fclose(fd);
00253     <font class="keywordflow">return</font> NULL;
00254   }
00255   <font class="keywordflow">if</font> (sscanf(inbuf, <font class="stringliteral">"nspace=%d"</font>, &amp;nspace) != 1) {
00256     fprintf(stderr, <font class="stringliteral">"Error reading nspace.\n"</font>);
00257     fclose(fd);
00258     <font class="keywordflow">return</font> NULL;
00259   }
00260   <font class="keywordflow">if</font> (nspace != 3) {
00261     fprintf(stderr, <font class="stringliteral">"Error: nspace must be 3.\n"</font>);
00262     fclose(fd);
00263     <font class="keywordflow">return</font> NULL;
00264   }
00265 
00266   <font class="comment">/* Find out how many values are stored for each point (the length of the</font>
00267 <font class="comment">   * vector for the vector field) */</font>
00268   <font class="keywordflow">if</font> (<a class="code" href="avsplugin_8C.html#a10">get_string</a>(inbuf, <a class="code" href="avsplugin_8C.html#a0">LINESIZE</a>, fd) == NULL) {
00269     fclose(fd);
00270     <font class="keywordflow">return</font> NULL;
00271   }
00272   <font class="keywordflow">if</font> (sscanf(inbuf, <font class="stringliteral">"veclen=%d"</font>, &amp;veclen) != 1) {
00273     fprintf(stderr, <font class="stringliteral">"Error reading veclen.\n"</font>);
00274     fclose(fd);
00275     <font class="keywordflow">return</font> NULL;
00276   }
00277 
00278   <font class="comment">/* Check that the data type is "float" */</font>
00279   <font class="keywordflow">if</font> (<a class="code" href="avsplugin_8C.html#a10">get_string</a>(inbuf, <a class="code" href="avsplugin_8C.html#a0">LINESIZE</a>, fd) == NULL) {
00280     fclose(fd);
00281     <font class="keywordflow">return</font> NULL;
00282   }
00283   <font class="keywordflow">if</font> (strncmp(inbuf, <font class="stringliteral">"data=float"</font>, 10) != 0) {
00284     fprintf(stderr, <font class="stringliteral">"Error reading data type.\n"</font>);
00285     fclose(fd);
00286     <font class="keywordflow">return</font> NULL;
00287   }
00288 
00289   <font class="comment">/* Check that the field type is "uniform" */</font>
00290   <font class="keywordflow">if</font> (<a class="code" href="avsplugin_8C.html#a10">get_string</a>(inbuf, <a class="code" href="avsplugin_8C.html#a0">LINESIZE</a>, fd) == NULL) {
00291     fclose(fd);
00292     <font class="keywordflow">return</font> NULL;
00293   }
00294   <font class="keywordflow">if</font> (strncmp(inbuf, <font class="stringliteral">"field=uniform"</font>, 13) != 0) {
00295     fprintf(stderr, <font class="stringliteral">"Error reading field type.\n"</font>);
00296     fclose(fd);
00297     <font class="keywordflow">return</font> NULL;
00298   }
00299 
00300   <font class="comment">/* Allocate space for the coordinate and variable information </font>
00301 <font class="comment">   * coord is deleted in this fuction, variable is deleted when the plugin</font>
00302 <font class="comment">   * is closed.</font>
00303 <font class="comment">   */</font>
00304   coord = <font class="keyword">new</font> <a class="code" href="structdatasource__t.html">datasource_t</a>[ndim];
00305   variable = <font class="keyword">new</font> <a class="code" href="structdatasource__t.html">datasource_t</a>[veclen];
00306 
00307   <font class="comment">/* Find the coordinate information */</font>
00308   <font class="keywordflow">for</font> (i = 0; i &lt; ndim; i++) {
00309     <font class="keywordflow">if</font> (<a class="code" href="avsplugin_8C.html#a10">get_string</a>(inbuf, <a class="code" href="avsplugin_8C.html#a0">LINESIZE</a>, fd) == NULL) {
00310       <font class="keyword">delete</font>[] coord;
00311       fclose(fd);
00312       <font class="keywordflow">return</font> NULL;
00313     }
00314     <font class="keywordflow">if</font> ( (sscanf(inbuf, <font class="stringliteral">"coord %d"</font>, &amp;coord_count) != 1) || (coord_count != i+1) ) {
00315     fprintf(stderr, <font class="stringliteral">"Error reading coord count.\n"</font>);
00316       <font class="keyword">delete</font>[] coord;
00317       fclose(fd);
00318       <font class="keywordflow">return</font> NULL;
00319     }
00320     <font class="keywordflow">if</font> (<a class="code" href="avsplugin_8C.html#a11">read_datasource</a>(inbuf, &amp;coord[i])) {
00321       <font class="keyword">delete</font>[] coord;
00322       fclose(fd);
00323       <font class="keywordflow">return</font> NULL;
00324     }
00325   }
00326 
00327   <font class="comment">/* XXX - Ignore the labels (should be used for vol dataname) */</font>
00328   <font class="keywordflow">for</font> (i = 0; i &lt; veclen; i++) {
00329     <font class="keywordflow">if</font> (<a class="code" href="avsplugin_8C.html#a10">get_string</a>(inbuf, <a class="code" href="avsplugin_8C.html#a0">LINESIZE</a>, fd) == NULL) {
00330       <font class="keyword">delete</font>[] coord;
00331       fclose(fd);
00332       <font class="keywordflow">return</font> NULL;
00333     }
00334   }
00335   
00336   <font class="comment">/* Find the variable information */</font>
00337   <font class="keywordflow">for</font> (i = 0; i &lt; veclen; i++) {
00338     <font class="keywordflow">if</font> (<a class="code" href="avsplugin_8C.html#a10">get_string</a>(inbuf, <a class="code" href="avsplugin_8C.html#a0">LINESIZE</a>, fd) == NULL) {
00339       <font class="keyword">delete</font>[] coord;
00340       fclose(fd);
00341       <font class="keywordflow">return</font> NULL;
00342     }
00343     <font class="keywordflow">if</font> ( (sscanf(inbuf, <font class="stringliteral">"variable %d"</font>, &amp;var_count) != 1) || (var_count != i+1) ) {
00344       fprintf(stderr, <font class="stringliteral">"Error reading variable count.\n"</font>);
00345       <font class="keyword">delete</font>[] coord;
00346       fclose(fd);
00347       <font class="keywordflow">return</font> NULL;
00348     }
00349     <font class="keywordflow">if</font> (<a class="code" href="avsplugin_8C.html#a11">read_datasource</a>(inbuf, &amp;variable[i])) {
00350       <font class="keyword">delete</font>[] coord;
00351       fclose(fd);
00352       <font class="keywordflow">return</font> NULL;
00353     }
00354   }
00355 
00356   <font class="comment">/* Close the AVS file */</font>
00357   fclose(fd);
00358   fd = NULL;
00359 
00360   <font class="comment">/* Read the coordinate file(s) to find the origin and grid size </font>
00361 <font class="comment">   * XXX - this only works for "uniform" fields</font>
00362 <font class="comment">   */</font>
00363   <font class="keywordflow">for</font> (i = 0; i &lt; ndim; i++) {
00364     <font class="keywordflow">if</font> (strcmp(current_file, coord[i].filename) != 0) {
00365       <font class="comment">/* Close the old file if one was open, and open a new one */</font>
00366       <font class="keywordflow">if</font> (fd) {
00367         fclose(fd);
00368         fd = NULL;
00369       }
00370       strcpy(current_file, coord[i].filename); <font class="comment">/* XXX - unsafe */</font>
00371       fd = fopen(current_file, <font class="stringliteral">"rb"</font>);
00372       <font class="keywordflow">if</font> (!fd) {
00373         fprintf(stderr, <font class="stringliteral">"Error opening file.\n"</font>);
00374         <font class="keyword">delete</font>[] coord;
00375         <font class="keywordflow">return</font> NULL;
00376       }
00377     }
00378     <font class="keywordflow">else</font> {
00379       <font class="comment">/* Return to the beginning of the file */</font>
00380       rewind(fd);
00381     }
00382 
00383     <font class="comment">/* Skip the "skip" lines */</font>
00384     <font class="keywordflow">for</font> (index = 0; index &lt; coord[i].<a class="code" href="structdatasource__t.html#m2">skip</a>; index++) {
00385       <font class="keywordflow">if</font> (fgets(inbuf, <a class="code" href="avsplugin_8C.html#a0">LINESIZE</a>, fd) == NULL) {
00386         fprintf(stderr, <font class="stringliteral">"Error reading line.\n"</font>);
00387         fclose(fd);
00388         <font class="keyword">delete</font>[] coord;
00389         <font class="keywordflow">return</font> NULL;
00390       }
00391     }
00392 
00393     <font class="comment">/* Skip the "offset" values */</font>
00394     <font class="keywordflow">for</font> (index = 0; index &lt; coord[i].<a class="code" href="structdatasource__t.html#m3">offset</a>; index++) {
00395       <font class="keywordflow">if</font> (fscanf(fd, <font class="stringliteral">" %f"</font>, &amp;value) != 1) {
00396         fprintf(stderr, <font class="stringliteral">"Error skipping offset.\n"</font>);
00397         fclose(fd);
00398         <font class="keyword">delete</font>[] coord;
00399         <font class="keywordflow">return</font> NULL;
00400       }
00401     }
00402 
00403     <font class="comment">/* Read the origin, skip "stride" values, and read the end */</font>
00404     <font class="keywordflow">if</font> (fscanf(fd, <font class="stringliteral">" %f"</font>, &amp;value) != 1) {
00405       fprintf(stderr, <font class="stringliteral">"Error reading origin.\n"</font>);
00406       fclose(fd);
00407       <font class="keyword">delete</font>[] coord;
00408       <font class="keywordflow">return</font> NULL;
00409     }
00410     origin[i] = value;
00411     <font class="keywordflow">for</font> (index = 0; index &lt; coord[i].<a class="code" href="structdatasource__t.html#m4">stride</a>; index++) {
00412       <font class="keywordflow">if</font> (fscanf(fd, <font class="stringliteral">" %f"</font>, &amp;value) != 1) {
00413         fprintf(stderr, <font class="stringliteral">"Error skipping stride.\n"</font>);
00414         fclose(fd);
00415         <font class="keyword">delete</font>[] coord;
00416         <font class="keywordflow">return</font> NULL;
00417       }
00418     }
00419     gridlength[i] = value - origin[i];
00420   }
00421 
00422   <font class="comment">/* Free the coordinates */</font>
00423   <font class="keyword">delete</font>[] coord;
00424   coord = NULL;
00425   fclose(fd);
00426 
00427   <font class="comment">/* Allocate and initialize the avsfield structure */</font>
00428   avsfield = <font class="keyword">new</font> <a class="code" href="structavsfield__t.html">avsfield_t</a>;
00429   avsfield-&gt;<a class="code" href="structavsfield__t.html#m1">vol</a> = NULL;
00430   *natoms = <a class="code" href="molfile__plugin_8h.html#a7">MOLFILE_NUMATOMS_NONE</a>;
00431 
00432   <font class="comment">/* AVS field files can have an arbitrary number of sets */</font>
00433   avsfield-&gt;<a class="code" href="structavsfield__t.html#m0">nsets</a> = veclen;
00434   avsfield-&gt;<a class="code" href="structavsfield__t.html#m1">vol</a> = <font class="keyword">new</font> <a class="code" href="structmolfile__volumetric__t.html">molfile_volumetric_t</a>[veclen];
00435   avsfield-&gt;<a class="code" href="structavsfield__t.html#m2">data</a> = variable;
00436 
00437   <font class="keywordflow">for</font> (i = 0; i &lt; veclen; i++) {
00438     <font class="comment">/* strcpy(avsfield-&gt;vol[i].dataname, "AVS Field: "); */</font>
00439     sprintf(avsfield-&gt;<a class="code" href="structavsfield__t.html#m1">vol</a>[i].<a class="code" href="structmolfile__volumetric__t.html#m0">dataname</a>, <font class="stringliteral">"AVS Field: %d"</font>, i);
00440 
00441     avsfield-&gt;<a class="code" href="structavsfield__t.html#m1">vol</a>[i].<a class="code" href="structmolfile__volumetric__t.html#m1">origin</a>[0] = origin[0];
00442     avsfield-&gt;<a class="code" href="structavsfield__t.html#m1">vol</a>[i].<a class="code" href="structmolfile__volumetric__t.html#m1">origin</a>[1] = origin[1];
00443     avsfield-&gt;<a class="code" href="structavsfield__t.html#m1">vol</a>[i].<a class="code" href="structmolfile__volumetric__t.html#m1">origin</a>[2] = origin[2];
00444 
00445     avsfield-&gt;<a class="code" href="structavsfield__t.html#m1">vol</a>[i].<a class="code" href="structmolfile__volumetric__t.html#m2">xaxis</a>[0] = gridlength[0];
00446     avsfield-&gt;<a class="code" href="structavsfield__t.html#m1">vol</a>[i].<a class="code" href="structmolfile__volumetric__t.html#m2">xaxis</a>[1] = 0;
00447     avsfield-&gt;<a class="code" href="structavsfield__t.html#m1">vol</a>[i].<a class="code" href="structmolfile__volumetric__t.html#m2">xaxis</a>[2] = 0;
00448 
00449     avsfield-&gt;<a class="code" href="structavsfield__t.html#m1">vol</a>[i].<a class="code" href="structmolfile__volumetric__t.html#m3">yaxis</a>[0] = 0;
00450     avsfield-&gt;<a class="code" href="structavsfield__t.html#m1">vol</a>[i].<a class="code" href="structmolfile__volumetric__t.html#m3">yaxis</a>[1] = gridlength[1];
00451     avsfield-&gt;<a class="code" href="structavsfield__t.html#m1">vol</a>[i].<a class="code" href="structmolfile__volumetric__t.html#m3">yaxis</a>[2] = 0;
00452 
00453     avsfield-&gt;<a class="code" href="structavsfield__t.html#m1">vol</a>[i].<a class="code" href="structmolfile__volumetric__t.html#m4">zaxis</a>[0] = 0;
00454     avsfield-&gt;<a class="code" href="structavsfield__t.html#m1">vol</a>[i].<a class="code" href="structmolfile__volumetric__t.html#m4">zaxis</a>[1] = 0;
00455     avsfield-&gt;<a class="code" href="structavsfield__t.html#m1">vol</a>[i].<a class="code" href="structmolfile__volumetric__t.html#m4">zaxis</a>[2] = gridlength[2];
00456 
00457     avsfield-&gt;<a class="code" href="structavsfield__t.html#m1">vol</a>[i].<a class="code" href="structmolfile__volumetric__t.html#m5">xsize</a> = xsize;
00458     avsfield-&gt;<a class="code" href="structavsfield__t.html#m1">vol</a>[i].<a class="code" href="structmolfile__volumetric__t.html#m6">ysize</a> = ysize;
00459     avsfield-&gt;<a class="code" href="structavsfield__t.html#m1">vol</a>[i].<a class="code" href="structmolfile__volumetric__t.html#m7">zsize</a> = zsize;
00460 
00461     avsfield-&gt;<a class="code" href="structavsfield__t.html#m1">vol</a>[i].<a class="code" href="structmolfile__volumetric__t.html#m8">has_color</a> = 0;
00462   }
00463 
00464   <font class="keywordflow">return</font> avsfield;
00465 }
00466 
<a name="l00467"></a><a class="code" href="avsplugin_8C.html#a13">00467</a> <font class="keyword">static</font> <font class="keywordtype">int</font> <a class="code" href="avsplugin_8C.html#a13">read_avsfield_metadata</a>(<font class="keywordtype">void</font> *v, <font class="keywordtype">int</font> *nsets,
00468   <a class="code" href="structmolfile__volumetric__t.html">molfile_volumetric_t</a> **metadata) {
00469   <a class="code" href="structavsfield__t.html">avsfield_t</a> *avsfield = (<a class="code" href="structavsfield__t.html">avsfield_t</a> *)v;
00470   *nsets = avsfield-&gt;<a class="code" href="structavsfield__t.html#m0">nsets</a>;
00471   *metadata = avsfield-&gt;<a class="code" href="structavsfield__t.html#m1">vol</a>;
00472 
00473   <font class="keywordflow">return</font> <a class="code" href="molfile__plugin_8h.html#a2">MOLFILE_SUCCESS</a>;
00474 }
00475 
<a name="l00476"></a><a class="code" href="avsplugin_8C.html#a14">00476</a> <font class="keyword">static</font> <font class="keywordtype">int</font> <a class="code" href="avsplugin_8C.html#a14">read_avsfield_data</a>(<font class="keywordtype">void</font> *v, <font class="keywordtype">int</font> set, <font class="keywordtype">float</font> *datablock,
00477                          <font class="keywordtype">float</font> *colorblock) {
00478   <a class="code" href="structavsfield__t.html">avsfield_t</a> *avsfield = (<a class="code" href="structavsfield__t.html">avsfield_t</a> *)v;
00479   <font class="keywordtype">int</font> skip, offset, stride, count, ndata, index;
00480   <font class="keywordtype">float</font> value, *cellIndex = datablock;
00481   <font class="keywordtype">char</font> inbuf[<a class="code" href="avsplugin_8C.html#a0">LINESIZE</a>];
00482   FILE *fd;
00483   
00484   fd = fopen(avsfield-&gt;<a class="code" href="structavsfield__t.html#m2">data</a>[set].<a class="code" href="structdatasource__t.html#m0">filename</a>, <font class="stringliteral">"rb"</font>);
00485   <font class="keywordflow">if</font> (!fd) {
00486     fprintf(stderr, <font class="stringliteral">"Error opening file.\n"</font>);
00487     <font class="keywordflow">return</font> <a class="code" href="molfile__plugin_8h.html#a4">MOLFILE_ERROR</a>; 
00488   }
00489 
00490   skip = avsfield-&gt;<a class="code" href="structavsfield__t.html#m2">data</a>[set].<a class="code" href="structdatasource__t.html#m2">skip</a>;
00491   offset = avsfield-&gt;<a class="code" href="structavsfield__t.html#m2">data</a>[set].<a class="code" href="structdatasource__t.html#m3">offset</a>;
00492   stride = avsfield-&gt;<a class="code" href="structavsfield__t.html#m2">data</a>[set].<a class="code" href="structdatasource__t.html#m4">stride</a>;
00493 
00494   count = 0;
00495   ndata = avsfield-&gt;<a class="code" href="structavsfield__t.html#m1">vol</a>[0].<a class="code" href="structmolfile__volumetric__t.html#m5">xsize</a> * avsfield-&gt;<a class="code" href="structavsfield__t.html#m1">vol</a>[0].<a class="code" href="structmolfile__volumetric__t.html#m6">ysize</a> * avsfield-&gt;<a class="code" href="structavsfield__t.html#m1">vol</a>[0].<a class="code" href="structmolfile__volumetric__t.html#m7">zsize</a>;
00496 
00497   <font class="comment">/* Skip the "skip" lines */</font>
00498   <font class="keywordflow">for</font> (index = 0; index &lt; skip; index++) {
00499     <font class="keywordflow">if</font> (fgets(inbuf, <a class="code" href="avsplugin_8C.html#a0">LINESIZE</a>, fd) == NULL) {
00500       fprintf(stderr, <font class="stringliteral">"Error skipping lines.\n"</font>);
00501       fclose(fd);
00502       <font class="keywordflow">return</font> <a class="code" href="molfile__plugin_8h.html#a4">MOLFILE_ERROR</a>;
00503     }
00504   }
00505 
00506   <font class="comment">/* Skip the "offset" values */</font>
00507   <font class="keywordflow">for</font> (index = 0; index &lt; offset; index++) {
00508     <font class="keywordflow">if</font> (fscanf(fd, <font class="stringliteral">" %f"</font>, &amp;value) != 1) {
00509       fprintf(stderr, <font class="stringliteral">"Error skipping offset.\n"</font>);
00510       fclose(fd);
00511       <font class="keywordflow">return</font> <a class="code" href="molfile__plugin_8h.html#a4">MOLFILE_ERROR</a>;
00512     }
00513   }
00514 
00515   <font class="keywordflow">while</font> (count &lt; ndata) {
00516     <font class="comment">/* Read a value into the datablock and skip "stride" values */</font>
00517     <font class="keywordflow">if</font> (fscanf(fd, <font class="stringliteral">" %f"</font>, &amp;value) != 1) {
00518       fprintf(stderr, <font class="stringliteral">"Error reading data.\n"</font>);
00519       fclose(fd);
00520       <font class="keywordflow">return</font> <a class="code" href="molfile__plugin_8h.html#a4">MOLFILE_ERROR</a>;
00521     }
00522     *cellIndex = value;
00523     cellIndex++;
00524     count++;
00525 
00526     <font class="keywordflow">for</font> (index = 0; index &lt; stride-1; index++) {
00527       <font class="keywordflow">if</font> (fscanf(fd, <font class="stringliteral">" %f"</font>, &amp;value) != 1) {
00528         fprintf(stderr, <font class="stringliteral">"Error skipping stride.\n"</font>);
00529         fclose(fd);
00530         <font class="keywordflow">return</font> <a class="code" href="molfile__plugin_8h.html#a4">MOLFILE_ERROR</a>;
00531       }
00532     }
00533   }
00534 
00535   fclose(fd);
00536   <font class="keywordflow">return</font> <a class="code" href="molfile__plugin_8h.html#a2">MOLFILE_SUCCESS</a>;
00537 }
00538 
<a name="l00539"></a><a class="code" href="avsplugin_8C.html#a15">00539</a> <font class="keyword">static</font> <font class="keywordtype">void</font> <a class="code" href="avsplugin_8C.html#a15">close_avsfield_read</a>(<font class="keywordtype">void</font> *v) {
00540   <a class="code" href="structavsfield__t.html">avsfield_t</a> *avsfield = (<a class="code" href="structavsfield__t.html">avsfield_t</a> *)v;
00541 
00542   <font class="keywordflow">if</font> (avsfield-&gt;<a class="code" href="structavsfield__t.html#m1">vol</a> != NULL)
00543     <font class="keyword">delete</font> [] avsfield-&gt;<a class="code" href="structavsfield__t.html#m1">vol</a>;
00544   <font class="keywordflow">if</font> (avsfield-&gt;<a class="code" href="structavsfield__t.html#m2">data</a> != NULL)
00545     <font class="keyword">delete</font> [] avsfield-&gt;<a class="code" href="structavsfield__t.html#m2">data</a>;
00546   <font class="keyword">delete</font> avsfield;
00547 }
00548 
00549 <font class="comment">/*</font>
00550 <font class="comment"> * Initialization stuff here</font>
00551 <font class="comment"> */</font>
<a name="l00552"></a><a class="code" href="avsplugin_8C.html#a1">00552</a> <font class="keyword">static</font> <a class="code" href="structmolfile__plugin__t.html">molfile_plugin_t</a> <a class="code" href="avsplugin_8C.html#a1">plugin</a> = {
00553   <a class="code" href="vmdplugin_8h.html#a10">vmdplugin_ABIVERSION</a>,   <font class="comment">/* ABI version */</font>
00554   <a class="code" href="molfile__plugin_8h.html#a0">MOLFILE_PLUGIN_TYPE</a>,    <font class="comment">/* plugin type */</font>
00555   <font class="stringliteral">"fld"</font>,                  <font class="comment">/* short file format description */</font>
00556   <font class="stringliteral">"AVS Field"</font>,            <font class="comment">/* pretty file format description */</font>
00557   <font class="stringliteral">"Eamon Caddigan"</font>,       <font class="comment">/* author(s) */</font>
00558   0,                      <font class="comment">/* major version */</font>
00559   3,                      <font class="comment">/* minor version */</font>
00560   <a class="code" href="vmdplugin_8h.html#a12">VMDPLUGIN_THREADSAFE</a>,   <font class="comment">/* is reentrant */</font>
00561   <font class="stringliteral">"fld"</font>                   <font class="comment">/* filename extension */</font>
00562 };
00563 
<a name="l00564"></a><a class="code" href="avsplugin_8C.html#a16">00564</a> <a class="code" href="vmdplugin_8h.html#a7">VMDPLUGIN_API</a> <font class="keywordtype">int</font> <a class="code" href="vmdplugin_8h.html#a5">VMDPLUGIN_init</a>(<font class="keywordtype">void</font>) { <font class="keywordflow">return</font> <a class="code" href="vmdplugin_8h.html#a13">VMDPLUGIN_SUCCESS</a>; }
<a name="l00565"></a><a class="code" href="avsplugin_8C.html#a17">00565</a> <a class="code" href="vmdplugin_8h.html#a7">VMDPLUGIN_API</a> <font class="keywordtype">int</font> <a class="code" href="vmdplugin_8h.html#a6">VMDPLUGIN_fini</a>(<font class="keywordtype">void</font>) { <font class="keywordflow">return</font> <a class="code" href="vmdplugin_8h.html#a13">VMDPLUGIN_SUCCESS</a>; }
<a name="l00566"></a><a class="code" href="avsplugin_8C.html#a18">00566</a> <a class="code" href="vmdplugin_8h.html#a7">VMDPLUGIN_API</a> <font class="keywordtype">int</font> <a class="code" href="vmdplugin_8h.html#a3">VMDPLUGIN_register</a>(<font class="keywordtype">void</font> *v, <a class="code" href="vmdplugin_8h.html#a15">vmdplugin_register_cb</a> cb) {
00567   plugin.<a class="code" href="structmolfile__plugin__t.html#m1">open_file_read</a> = <a class="code" href="avsplugin_8C.html#a12">open_avsfield_read</a>;
00568   plugin.<a class="code" href="structmolfile__plugin__t.html#m10">read_volumetric_metadata</a> = <a class="code" href="avsplugin_8C.html#a13">read_avsfield_metadata</a>;
00569   plugin.<a class="code" href="structmolfile__plugin__t.html#m11">read_volumetric_data</a> = <a class="code" href="avsplugin_8C.html#a14">read_avsfield_data</a>;
00570   plugin.<a class="code" href="structmolfile__plugin__t.html#m5">close_file_read</a> = <a class="code" href="avsplugin_8C.html#a15">close_avsfield_read</a>;
00571   (*cb)(v, (<a class="code" href="structvmdplugin__t.html">vmdplugin_t</a> *)&amp;plugin);
00572   <font class="keywordflow">return</font> <a class="code" href="vmdplugin_8h.html#a13">VMDPLUGIN_SUCCESS</a>;
00573 }
00574 
</pre></div><hr><address><small>Generated on Wed Mar 22 13:15:27 2006 for VMD Plugins (current) by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.gif" alt="doxygen" align="middle" border=0 
width=110 height=53></a>1.2.14 written by <a href="mailto:dimitri@stack.nl">Dimitri van Heesch</a>,
 &copy;&nbsp;1997-2002</small></address>
</body>
</html>
