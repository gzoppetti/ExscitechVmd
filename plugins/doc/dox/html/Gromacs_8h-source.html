<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>Gromacs.h Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.2.14 -->
<center>
<a class="qindex" href="index.html">Main Page</a> &nbsp; <a class="qindex" href="classes.html">Alphabetical List</a> &nbsp; <a class="qindex" href="annotated.html">Compound List</a> &nbsp; <a class="qindex" href="files.html">File List</a> &nbsp; <a class="qindex" href="functions.html">Compound Members</a> &nbsp; <a class="qindex" href="globals.html">File Members</a> &nbsp; <a class="qindex" href="pages.html">Related Pages</a> &nbsp; </center>
<hr><h1>Gromacs.h</h1><a href="Gromacs_8h.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 <font class="comment">/***************************************************************************</font>
00002 <font class="comment"> *cr</font>
00003 <font class="comment"> *cr            (C) Copyright 1995-2006 The Board of Trustees of the</font>
00004 <font class="comment"> *cr                        University of Illinois</font>
00005 <font class="comment"> *cr                         All Rights Reserved</font>
00006 <font class="comment"> *cr</font>
00007 <font class="comment"> ***************************************************************************/</font>
00008 <font class="comment">/***************************************************************************</font>
00009 <font class="comment"> * RCS INFORMATION:</font>
00010 <font class="comment"> *      $RCSfile: Gromacs.h,v $</font>
00011 <font class="comment"> *      $Author: johns $       $Locker:  $             $State: Exp $</font>
00012 <font class="comment"> *      $Revision: 1.22 $       $Date: 2006/02/24 00:57:10 $</font>
00013 <font class="comment"> ***************************************************************************/</font>
00014 
00015 <font class="comment">/*</font>
00016 <font class="comment"> * GROMACS file format reader for VMD</font>
00017 <font class="comment"> *</font>
00018 <font class="comment"> * This code provides a high level I/O library for reading</font>
00019 <font class="comment"> * and writing the following file formats:</font>
00020 <font class="comment"> *      gro     GROMACS format or trajectory</font>
00021 <font class="comment"> *      g96     GROMOS-96 format or trajectory</font>
00022 <font class="comment"> *      trj     Trajectory - x, v and f (binary, full precision)</font>
00023 <font class="comment"> *      trr     Trajectory - x, v and f (binary, full precision, portable)</font>
00024 <font class="comment"> *      xtc     Trajectory - x only (compressed, portable, any precision)</font>
00025 <font class="comment"> *      top</font>
00026 <font class="comment"> * Currently supported: gro trj trr g96 [xtc]</font>
00027 <font class="comment"> *</font>
00028 <font class="comment"> * TODO list</font>
00029 <font class="comment"> *   o  velocities are ignored because VMD doesn't use them, but some other </font>
00030 <font class="comment"> *      program might ...</font>
00031 <font class="comment"> *   o  gro_rec() assumes positions in .gro files are nanometers and</font>
00032 <font class="comment"> *      converts to angstroms, whereas they really could be any unit</font>
00033 <font class="comment"> */</font>
00034 
00035 <font class="preprocessor">#ifndef GROMACS_H</font>
00036 <font class="preprocessor"></font><font class="preprocessor">#define GROMACS_H</font>
00037 <font class="preprocessor"></font>
00038 <font class="preprocessor">#include &lt;math.h&gt;</font>
00039 <font class="preprocessor">#include &lt;stdio.h&gt;</font>
00040 <font class="preprocessor">#include &lt;stdlib.h&gt;</font>
00041 <font class="preprocessor">#include &lt;string.h&gt;</font>
00042 <font class="preprocessor">#include &lt;ctype.h&gt;</font>
00043 
00044 <font class="preprocessor">#if defined(_AIX)</font>
00045 <font class="preprocessor"></font><font class="preprocessor">#include &lt;strings.h&gt;</font>
00046 <font class="preprocessor">#endif</font>
00047 <font class="preprocessor"></font>
00048 <font class="preprocessor">#include "<a class="code" href="endianswap_8h.html">endianswap.h</a>"</font>
00049 
00050 <font class="preprocessor">#if defined(WIN32) || defined(WIN64)</font>
00051 <font class="preprocessor"></font><font class="preprocessor">#define strcasecmp stricmp</font>
00052 <font class="preprocessor"></font><font class="preprocessor">#endif</font>
00053 <font class="preprocessor"></font>
00054 <font class="preprocessor">#ifndef M_PI_2</font>
<a name="l00055"></a><a class="code" href="Gromacs_8h.html#a0">00055</a> <font class="preprocessor"></font><font class="preprocessor">#define M_PI_2 1.57079632679489661922</font>
00056 <font class="preprocessor"></font><font class="preprocessor">#endif</font>
00057 <font class="preprocessor"></font>
00058 <font class="comment">// Error codes for mdio_errno</font>
<a name="l00059"></a><a class="code" href="Gromacs_8h.html#a1">00059</a> <font class="preprocessor">#define MDIO_SUCCESS            0</font>
<a name="l00060"></a><a class="code" href="Gromacs_8h.html#a2">00060</a> <font class="preprocessor"></font><font class="preprocessor">#define MDIO_BADFORMAT          1</font>
<a name="l00061"></a><a class="code" href="Gromacs_8h.html#a3">00061</a> <font class="preprocessor"></font><font class="preprocessor">#define MDIO_EOF                2</font>
<a name="l00062"></a><a class="code" href="Gromacs_8h.html#a4">00062</a> <font class="preprocessor"></font><font class="preprocessor">#define MDIO_BADPARAMS          3</font>
<a name="l00063"></a><a class="code" href="Gromacs_8h.html#a5">00063</a> <font class="preprocessor"></font><font class="preprocessor">#define MDIO_IOERROR            4</font>
<a name="l00064"></a><a class="code" href="Gromacs_8h.html#a6">00064</a> <font class="preprocessor"></font><font class="preprocessor">#define MDIO_BADPRECISION       5</font>
<a name="l00065"></a><a class="code" href="Gromacs_8h.html#a7">00065</a> <font class="preprocessor"></font><font class="preprocessor">#define MDIO_BADMALLOC          6</font>
<a name="l00066"></a><a class="code" href="Gromacs_8h.html#a8">00066</a> <font class="preprocessor"></font><font class="preprocessor">#define MDIO_CANTOPEN           7</font>
<a name="l00067"></a><a class="code" href="Gromacs_8h.html#a9">00067</a> <font class="preprocessor"></font><font class="preprocessor">#define MDIO_BADEXTENSION       8</font>
<a name="l00068"></a><a class="code" href="Gromacs_8h.html#a10">00068</a> <font class="preprocessor"></font><font class="preprocessor">#define MDIO_UNKNOWNFMT         9</font>
<a name="l00069"></a><a class="code" href="Gromacs_8h.html#a11">00069</a> <font class="preprocessor"></font><font class="preprocessor">#define MDIO_CANTCLOSE          10</font>
<a name="l00070"></a><a class="code" href="Gromacs_8h.html#a12">00070</a> <font class="preprocessor"></font><font class="preprocessor">#define MDIO_WRONGFORMAT        11</font>
<a name="l00071"></a><a class="code" href="Gromacs_8h.html#a13">00071</a> <font class="preprocessor"></font><font class="preprocessor">#define MDIO_SIZEERROR          12</font>
<a name="l00072"></a><a class="code" href="Gromacs_8h.html#a14">00072</a> <font class="preprocessor"></font><font class="preprocessor">#define MDIO_UNKNOWNERROR       1000</font>
00073 <font class="preprocessor"></font>
<a name="l00074"></a><a class="code" href="Gromacs_8h.html#a15">00074</a> <font class="preprocessor">#define MDIO_READ       0</font>
<a name="l00075"></a><a class="code" href="Gromacs_8h.html#a16">00075</a> <font class="preprocessor"></font><font class="preprocessor">#define MDIO_WRITE      1</font>
00076 <font class="preprocessor"></font>
<a name="l00077"></a><a class="code" href="Gromacs_8h.html#a17">00077</a> <font class="preprocessor">#define MDIO_MAX_ERRVAL         11</font>
00078 <font class="preprocessor"></font>
00079 <font class="comment">// Format extensions</font>
<a name="l00080"></a><a class="code" href="Gromacs_8h.html#a32">00080</a> <font class="keyword">const</font> <font class="keywordtype">char</font> *<a class="code" href="Gromacs_8h.html#a32">mdio_fmtexts</a>[] = {
00081     <font class="stringliteral">""</font>,
00082     <font class="stringliteral">".gro"</font>,
00083     <font class="stringliteral">".trr"</font>,
00084     <font class="stringliteral">".g96"</font>,
00085     <font class="stringliteral">".trj"</font>,
00086     <font class="stringliteral">".xtc"</font>,
00087     NULL
00088 };
00089 
00090 
<a name="l00091"></a><a class="code" href="Gromacs_8h.html#a33">00091</a> <font class="keyword">static</font> <font class="keywordtype">int</font> <a class="code" href="Gromacs_8h.html#a33">mdio_errcode</a>;        <font class="comment">// Last error code</font>
00092 
<a name="l00093"></a><a class="code" href="Gromacs_8h.html#a18">00093</a> <font class="preprocessor">#define TRX_MAGIC       1993    // Magic number for .trX files</font>
<a name="l00094"></a><a class="code" href="Gromacs_8h.html#a19">00094</a> <font class="preprocessor"></font><font class="preprocessor">#define XTC_MAGIC       1995    // Magic number for .xtc files</font>
<a name="l00095"></a><a class="code" href="Gromacs_8h.html#a20">00095</a> <font class="preprocessor"></font><font class="preprocessor">#define MAX_GRO_LINE    500     // Maximum line length of .gro files</font>
<a name="l00096"></a><a class="code" href="Gromacs_8h.html#a21">00096</a> <font class="preprocessor"></font><font class="preprocessor">#define MAX_G96_LINE    500     // Maximum line length of .g96 files</font>
<a name="l00097"></a><a class="code" href="Gromacs_8h.html#a22">00097</a> <font class="preprocessor"></font><font class="preprocessor">#define MAX_TRX_TITLE   80      // Maximum length of a title in .trX</font>
<a name="l00098"></a><a class="code" href="Gromacs_8h.html#a23">00098</a> <font class="preprocessor"></font><font class="preprocessor">#define MAX_MDIO_TITLE  80      // Maximum supported title length</font>
<a name="l00099"></a><a class="code" href="Gromacs_8h.html#a24">00099</a> <font class="preprocessor"></font><font class="preprocessor">#define ANGS_PER_NM     10      // Unit conversion factor</font>
00100 <font class="preprocessor"></font>
00101 
00102 <font class="comment">// All the supported file types and their respective extensions</font>
<a name="l00103"></a><a class="code" href="Gromacs_8h.html#a25">00103</a> <font class="preprocessor">#define MDFMT_GRO               1</font>
<a name="l00104"></a><a class="code" href="Gromacs_8h.html#a26">00104</a> <font class="preprocessor"></font><font class="preprocessor">#define MDFMT_TRR               2</font>
<a name="l00105"></a><a class="code" href="Gromacs_8h.html#a27">00105</a> <font class="preprocessor"></font><font class="preprocessor">#define MDFMT_G96               3</font>
<a name="l00106"></a><a class="code" href="Gromacs_8h.html#a28">00106</a> <font class="preprocessor"></font><font class="preprocessor">#define MDFMT_TRJ               4</font>
<a name="l00107"></a><a class="code" href="Gromacs_8h.html#a29">00107</a> <font class="preprocessor"></font><font class="preprocessor">#define MDFMT_XTC               5</font>
00108 <font class="preprocessor"></font>
00109 
00110 <font class="comment">// A structure to hold .trX file format header information. This</font>
00111 <font class="comment">// is an optional member of the md_file structure that is used</font>
00112 <font class="comment">// when .trX files are being dealt with.</font>
<a name="l00113"></a><a class="code" href="structtrx__hdr.html">00113</a> <font class="keyword">typedef</font> <font class="keyword">struct </font>{
<a name="l00114"></a><a class="code" href="structtrx__hdr.html#m0">00114</a>         <font class="keywordtype">int</font> version;            <font class="comment">// File version number</font>
<a name="l00115"></a><a class="code" href="structtrx__hdr.html#m1">00115</a>         <font class="keywordtype">char</font> title[<a class="code" href="Gromacs_8h.html#a22">MAX_TRX_TITLE</a> + 1];  <font class="comment">// File title</font>
<a name="l00116"></a><a class="code" href="structtrx__hdr.html#m2">00116</a>         <font class="keywordtype">int</font> ir_size;
<a name="l00117"></a><a class="code" href="structtrx__hdr.html#m3">00117</a>         <font class="keywordtype">int</font> e_size;
<a name="l00118"></a><a class="code" href="structtrx__hdr.html#m4">00118</a>         <font class="keywordtype">int</font> box_size;
<a name="l00119"></a><a class="code" href="structtrx__hdr.html#m5">00119</a>         <font class="keywordtype">int</font> vir_size;
<a name="l00120"></a><a class="code" href="structtrx__hdr.html#m6">00120</a>         <font class="keywordtype">int</font> pres_size;
<a name="l00121"></a><a class="code" href="structtrx__hdr.html#m7">00121</a>         <font class="keywordtype">int</font> top_size;
<a name="l00122"></a><a class="code" href="structtrx__hdr.html#m8">00122</a>         <font class="keywordtype">int</font> sym_size;
<a name="l00123"></a><a class="code" href="structtrx__hdr.html#m9">00123</a>         <font class="keywordtype">int</font> x_size;             <font class="comment">// Positions of atoms</font>
<a name="l00124"></a><a class="code" href="structtrx__hdr.html#m10">00124</a>         <font class="keywordtype">int</font> v_size;             <font class="comment">// Velocities of atoms</font>
<a name="l00125"></a><a class="code" href="structtrx__hdr.html#m11">00125</a>         <font class="keywordtype">int</font> f_size;
<a name="l00126"></a><a class="code" href="structtrx__hdr.html#m12">00126</a>         <font class="keywordtype">int</font> natoms;             <font class="comment">// Number of atoms in the system</font>
<a name="l00127"></a><a class="code" href="structtrx__hdr.html#m13">00127</a>         <font class="keywordtype">int</font> step;
<a name="l00128"></a><a class="code" href="structtrx__hdr.html#m14">00128</a>         <font class="keywordtype">int</font> nre;
<a name="l00129"></a><a class="code" href="structtrx__hdr.html#m15">00129</a>         <font class="keywordtype">float</font> t;
<a name="l00130"></a><a class="code" href="structtrx__hdr.html#m16">00130</a>         <font class="keywordtype">float</font> lambda;
00131 } <a class="code" href="structtrx__hdr.html">trx_hdr</a>;
00132 
00133 
00134 <font class="comment">// A generic i/o structure that contains information about the</font>
00135 <font class="comment">// file itself and the input/output state</font>
<a name="l00136"></a><a class="code" href="structmd__file.html">00136</a> <font class="keyword">typedef</font> <font class="keyword">struct </font>{
<a name="l00137"></a><a class="code" href="structmd__file.html#m0">00137</a>         FILE *  f;      <font class="comment">// Pointer to the file</font>
<a name="l00138"></a><a class="code" href="structmd__file.html#m1">00138</a>         <font class="keywordtype">int</font>     fmt;    <font class="comment">// The file format</font>
<a name="l00139"></a><a class="code" href="structmd__file.html#m2">00139</a>         <font class="keywordtype">int</font>     prec;   <font class="comment">// Real number precision</font>
<a name="l00140"></a><a class="code" href="structmd__file.html#m3">00140</a>         <font class="keywordtype">int</font>     rev;    <font class="comment">// Reverse endiannism?</font>
<a name="l00141"></a><a class="code" href="structmd__file.html#m4">00141</a>         <a class="code" href="structtrx__hdr.html">trx_hdr</a> * trx;  <font class="comment">// Trx files require a great deal more</font>
00142                         <font class="comment">// header data to be stored.</font>
00143 } <a class="code" href="structmd__file.html">md_file</a>;
00144 
00145 
00146 <font class="comment">// A format-independent structure to hold header data from files</font>
<a name="l00147"></a><a class="code" href="structmd__header.html">00147</a> <font class="keyword">typedef</font> <font class="keyword">struct </font>{
<a name="l00148"></a><a class="code" href="structmd__header.html#m0">00148</a>         <font class="keywordtype">char</font> title[<a class="code" href="Gromacs_8h.html#a23">MAX_MDIO_TITLE</a> + 1];
<a name="l00149"></a><a class="code" href="structmd__header.html#m1">00149</a>         <font class="keywordtype">int</font> natoms;
<a name="l00150"></a><a class="code" href="structmd__header.html#m2">00150</a>         <font class="keywordtype">float</font> timeval;
00151 } <a class="code" href="structmd__header.html">md_header</a>;
00152 
00153 
00154 <font class="comment">// A format-independent structure to hold unit cell data</font>
<a name="l00155"></a><a class="code" href="structmd__box.html">00155</a> <font class="keyword">typedef</font> <font class="keyword">struct </font>{
<a name="l00156"></a><a class="code" href="structmd__box.html#m5">00156</a>   <font class="keywordtype">float</font> A, B, C, alpha, beta, gamma;
00157 } <a class="code" href="structmd__box.html">md_box</a>;
00158 
00159 
00160 <font class="comment">// Timestep information</font>
<a name="l00161"></a><a class="code" href="structmd__ts.html">00161</a> <font class="keyword">typedef</font> <font class="keyword">struct </font>{
<a name="l00162"></a><a class="code" href="structmd__ts.html#m0">00162</a>         <font class="keywordtype">float</font> *pos;     <font class="comment">// Position array (3 * natoms)</font>
00163         <font class="comment">//float *vel;   // Velocity array ** (VMD doesn't use this) **</font>
00164         <font class="comment">//float *f;     // Force array ** (VMD doesn't use this) **</font>
00165         <font class="comment">//float *box;   // Computational box ** (VMD doesn't use this) **</font>
<a name="l00166"></a><a class="code" href="structmd__ts.html#m1">00166</a>         <font class="keywordtype">int</font> natoms;     <font class="comment">// Number of atoms</font>
<a name="l00167"></a><a class="code" href="structmd__ts.html#m2">00167</a>         <font class="keywordtype">int</font> step;       <font class="comment">// Simulation step</font>
<a name="l00168"></a><a class="code" href="structmd__ts.html#m3">00168</a>         <font class="keywordtype">float</font> time;     <font class="comment">// Time of simulation</font>
<a name="l00169"></a><a class="code" href="structmd__ts.html#m4">00169</a>   <a class="code" href="structmd__box.html">md_box</a> *box;
00170 } <a class="code" href="structmd__ts.html">md_ts</a>;
00171 
00172 
00173 <font class="comment">// Atom information</font>
<a name="l00174"></a><a class="code" href="structmd__atom.html">00174</a> <font class="keyword">typedef</font> <font class="keyword">struct </font>{
<a name="l00175"></a><a class="code" href="structmd__atom.html#m0">00175</a>         <font class="keywordtype">char</font> resid[7];          <font class="comment">// Residue index number</font>
<a name="l00176"></a><a class="code" href="structmd__atom.html#m1">00176</a>         <font class="keywordtype">char</font> resname[7];        <font class="comment">// Residue name</font>
<a name="l00177"></a><a class="code" href="structmd__atom.html#m2">00177</a>         <font class="keywordtype">int</font> atomnum;            <font class="comment">// Atom index number</font>
<a name="l00178"></a><a class="code" href="structmd__atom.html#m3">00178</a>         <font class="keywordtype">char</font> atomname[7];       <font class="comment">// Atom name</font>
<a name="l00179"></a><a class="code" href="structmd__atom.html#m4">00179</a>         <font class="keywordtype">float</font> pos[3];           <font class="comment">// Position array (3 * natoms)</font>
00180         <font class="comment">//float vel[3]; // Velocity array ** (VMD doesn't use this) **</font>
00181 } <a class="code" href="structmd__atom.html">md_atom</a>;
00182 
00183 
00184 <font class="comment">// Open a molecular dynamics file. The second parameter specifies</font>
00185 <font class="comment">// the format of the file. If it is zero, the format is determined</font>
00186 <font class="comment">// from the file extension. the third argument (if given) decides</font>
00187 <font class="comment">// whether to read (==0) or to write (!= 0).</font>
00188 <font class="comment">// using a default argument set to read for backward compatibility.</font>
00189 <font class="keyword">static</font> <a class="code" href="structmd__file.html">md_file</a> *<a class="code" href="Gromacs_8h.html#a36">mdio_open</a>(<font class="keyword">const</font> <font class="keywordtype">char</font> *, <font class="keyword">const</font> <font class="keywordtype">int</font>, <font class="keyword">const</font> <font class="keywordtype">int</font>=<a class="code" href="Gromacs_8h.html#a15">MDIO_READ</a>);
00190 
00191 <font class="comment">// Closes a molecular dynamics file.</font>
00192 <font class="keyword">static</font> <font class="keywordtype">int</font> <a class="code" href="Gromacs_8h.html#a37">mdio_close</a>(<a class="code" href="structmd__file.html">md_file</a> *);
00193 
00194 
00195 <font class="comment">// Format-independent file I/O routines</font>
00196 <font class="keyword">static</font> <font class="keywordtype">int</font> <a class="code" href="Gromacs_8h.html#a38">mdio_header</a>(<a class="code" href="structmd__file.html">md_file</a> *, <a class="code" href="structmd__header.html">md_header</a> *);
00197 <font class="keyword">static</font> <font class="keywordtype">int</font> <a class="code" href="Gromacs_8h.html#a39">mdio_timestep</a>(<a class="code" href="structmd__file.html">md_file</a> *, <a class="code" href="structmd__ts.html">md_ts</a> *);
00198 
00199 
00200 <font class="comment">// .gro file functions</font>
00201 <font class="keyword">static</font> <font class="keywordtype">int</font> <a class="code" href="Gromacs_8h.html#a40">gro_header</a>(<a class="code" href="structmd__file.html">md_file</a> *, <font class="keywordtype">char</font> *, <font class="keywordtype">int</font>, <font class="keywordtype">float</font> *, <font class="keywordtype">int</font> *, <font class="keywordtype">int</font> = 1);
00202 <font class="keyword">static</font> <font class="keywordtype">int</font> <a class="code" href="Gromacs_8h.html#a41">gro_rec</a>(<a class="code" href="structmd__file.html">md_file</a> *, <a class="code" href="structmd__atom.html">md_atom</a> *);
00203 <font class="keyword">static</font> <font class="keywordtype">int</font> <a class="code" href="Gromacs_8h.html#a42">gro_timestep</a>(<a class="code" href="structmd__file.html">md_file</a> *, <a class="code" href="structmd__ts.html">md_ts</a> *);
00204 
00205 
00206 <font class="comment">// .trX file functions</font>
00207 <font class="keyword">static</font> <font class="keywordtype">int</font> <a class="code" href="Gromacs_8h.html#a43">trx_header</a>(<a class="code" href="structmd__file.html">md_file</a> *, <font class="keywordtype">int</font> = 0);
00208 <font class="keyword">static</font> <font class="keywordtype">int</font> <a class="code" href="Gromacs_8h.html#a44">trx_int</a>(<a class="code" href="structmd__file.html">md_file</a> *, <font class="keywordtype">int</font> *);
00209 <font class="keyword">static</font> <font class="keywordtype">int</font> <a class="code" href="Gromacs_8h.html#a45">trx_real</a>(<a class="code" href="structmd__file.html">md_file</a> *, <font class="keywordtype">float</font> *);
00210 
00211 <font class="keyword">static</font> <font class="keywordtype">int</font> <a class="code" href="Gromacs_8h.html#a46">trx_rvector</a>(<a class="code" href="structmd__file.html">md_file</a> *, <font class="keywordtype">float</font> *);
00212 <font class="keyword">static</font> <font class="keywordtype">int</font> <a class="code" href="Gromacs_8h.html#a47">trx_string</a>(<a class="code" href="structmd__file.html">md_file</a> *, <font class="keywordtype">char</font> *, <font class="keywordtype">int</font>);
00213 <font class="keyword">static</font> <font class="keywordtype">int</font> <a class="code" href="Gromacs_8h.html#a48">trx_timestep</a>(<a class="code" href="structmd__file.html">md_file</a> *, <a class="code" href="structmd__ts.html">md_ts</a> *);
00214 
00215 <font class="comment">// .g96 file functions</font>
00216 <font class="keyword">static</font> <font class="keywordtype">int</font> <a class="code" href="Gromacs_8h.html#a49">g96_header</a>(<a class="code" href="structmd__file.html">md_file</a> *, <font class="keywordtype">char</font> *, <font class="keywordtype">int</font>, <font class="keywordtype">float</font> *);
00217 <font class="keyword">static</font> <font class="keywordtype">int</font> <a class="code" href="Gromacs_8h.html#a50">g96_timestep</a>(<a class="code" href="structmd__file.html">md_file</a> *, <a class="code" href="structmd__ts.html">md_ts</a> *);
00218 <font class="keyword">static</font> <font class="keywordtype">int</font> <a class="code" href="Gromacs_8h.html#a51">g96_rec</a>(<a class="code" href="structmd__file.html">md_file</a> *, <a class="code" href="structmd__atom.html">md_atom</a> *);
00219 <font class="keyword">static</font> <font class="keywordtype">int</font> <a class="code" href="Gromacs_8h.html#a52">g96_countatoms</a>(<a class="code" href="structmd__file.html">md_file</a> *);
00220 
00221 
00222 <font class="comment">// .xtc file functions</font>
00223 <font class="keyword">static</font> <font class="keywordtype">int</font> <a class="code" href="Gromacs_8h.html#a53">xtc_int</a>(<a class="code" href="structmd__file.html">md_file</a> *, <font class="keywordtype">int</font> *);
00224 <font class="keyword">static</font> <font class="keywordtype">int</font> <a class="code" href="Gromacs_8h.html#a54">xtc_float</a>(<a class="code" href="structmd__file.html">md_file</a> *, <font class="keywordtype">float</font> *);
00225 <font class="comment">/* </font>
00226 <font class="comment">static int xtc_receivebits(int *, int);</font>
00227 <font class="comment">static void xtc_receiveints(int *, int, int, const unsigned *, int *);</font>
00228 <font class="comment">*/</font>
00229 <font class="keyword">static</font> <font class="keywordtype">int</font> <a class="code" href="Gromacs_8h.html#a55">xtc_timestep</a>(<a class="code" href="structmd__file.html">md_file</a> *, <a class="code" href="structmd__ts.html">md_ts</a> *);
00230 <font class="keyword">static</font> <font class="keywordtype">int</font> <a class="code" href="Gromacs_8h.html#a56">xtc_3dfcoord</a>(<a class="code" href="structmd__file.html">md_file</a> *, <font class="keywordtype">float</font> *, <font class="keywordtype">int</font> *, <font class="keywordtype">float</font> *);
00231 
00232 
00233 <font class="comment">// Error reporting functions</font>
00234 <font class="keyword">static</font> <font class="keywordtype">int</font> <a class="code" href="Gromacs_8h.html#a57">mdio_errno</a>(<font class="keywordtype">void</font>);
00235 <font class="keyword">static</font> <font class="keyword">const</font> <font class="keywordtype">char</font> *<a class="code" href="Gromacs_8h.html#a58">mdio_errmsg</a>(<font class="keywordtype">int</font>);
00236 <font class="keyword">static</font> <font class="keywordtype">int</font> <a class="code" href="Gromacs_8h.html#a59">mdio_seterror</a>(<font class="keywordtype">int</font>);
00237 
00238 
00239 <font class="comment">// Miscellaneous functions</font>
00240 <font class="keyword">static</font> <font class="keywordtype">int</font> <a class="code" href="Gromacs_8h.html#a60">strip_white</a>(<font class="keywordtype">char</font> *);
00241 <font class="keyword">static</font> <font class="keywordtype">int</font> <a class="code" href="Gromacs_8h.html#a61">mdio_readline</a>(<a class="code" href="structmd__file.html">md_file</a> *, <font class="keywordtype">char</font> *, <font class="keywordtype">int</font>, <font class="keywordtype">int</font> = 1);
00242 <font class="keyword">static</font> <font class="keywordtype">int</font> <a class="code" href="Gromacs_8h.html#a62">mdio_tsfree</a>(<a class="code" href="structmd__ts.html">md_ts</a> *, <font class="keywordtype">int</font> = 0);
00243 <font class="keyword">static</font> <font class="keywordtype">int</font> <a class="code" href="Gromacs_8h.html#a63">mdio_readbox</a>(<a class="code" href="structmd__box.html">md_box</a> *, <font class="keywordtype">float</font> *, <font class="keywordtype">float</font> *, <font class="keywordtype">float</font> *);
00244 
00245 
00246 
00247 <font class="keyword">static</font> <font class="keywordtype">int</font> <a class="code" href="Gromacs_8h.html#a64">xtc_receivebits</a>(<font class="keywordtype">int</font> *, <font class="keywordtype">int</font>);
00248 
00249 <font class="comment">// Error descriptions for mdio_errno</font>
<a name="l00250"></a><a class="code" href="Gromacs_8h.html#a34">00250</a> <font class="keyword">static</font> <font class="keyword">const</font> <font class="keywordtype">char</font> *<a class="code" href="Gromacs_8h.html#a34">mdio_errdescs</a>[] = {
00251         <font class="stringliteral">"no error"</font>,
00252         <font class="stringliteral">"file does not match format"</font>,
00253         <font class="stringliteral">"unexpected end-of-file reached"</font>,
00254         <font class="stringliteral">"function called with bad parameters"</font>,
00255         <font class="stringliteral">"file i/o error"</font>,
00256         <font class="stringliteral">"unsupported precision"</font>,
00257         <font class="stringliteral">"out of memory"</font>,
00258         <font class="stringliteral">"cannot open file"</font>,
00259         <font class="stringliteral">"bad file extension"</font>,
00260         <font class="stringliteral">"unknown file format"</font>,
00261         <font class="stringliteral">"cannot close file"</font>,
00262         <font class="stringliteral">"wrong file format for this function"</font>,
00263         <font class="stringliteral">"binary i/o error: sizeof(int) != 4"</font>,
00264         NULL
00265 };
00266 
<a name="l00269"></a><a class="code" href="Gromacs_8h.html#a65">00269</a> <font class="keyword">static</font> <font class="keyword">inline</font> <font class="keywordtype">int</font> <a class="code" href="Gromacs_8h.html#a65">host_is_little_endian</a>(<font class="keywordtype">void</font>) 
00270 {
00271   <font class="keyword">const</font> <font class="keyword">union </font>{ <font class="keywordtype">char</font> c[4]; <font class="keywordtype">unsigned</font> <font class="keywordtype">int</font> i; } 
00272   fixed = { { 0x10 , 0x20 , 0x40 , 0x80 } };
00273   <font class="keyword">const</font> <font class="keywordtype">unsigned</font> <font class="keywordtype">int</font> i = 0x80402010U;
00274         
00275   <font class="keywordflow">if</font> (fixed.i == i) {
00276     <font class="keywordflow">return</font> 1;
00277   }
00278   <font class="keywordflow">return</font> 0;
00279 }
00280 
00281 
00282 
00283 <font class="comment">// Open a molecular dynamics file. The second parameter specifies</font>
00284 <font class="comment">// the format of the file. If it is zero, the format is determined</font>
00285 <font class="comment">// from the file extension.</font>
<a name="l00286"></a><a class="code" href="Gromacs_8h.html#a36">00286</a> <a class="code" href="structmd__file.html">md_file</a> *<a class="code" href="Gromacs_8h.html#a36">mdio_open</a>(<font class="keyword">const</font> <font class="keywordtype">char</font> *fn, <font class="keyword">const</font> <font class="keywordtype">int</font> fmt, <font class="keyword">const</font> <font class="keywordtype">int</font> rw) {
00287         <a class="code" href="structmd__file.html">md_file</a> *mf;
00288 
00289         <font class="keywordflow">if</font> (!fn) {
00290                 <a class="code" href="Gromacs_8h.html#a59">mdio_seterror</a>(<a class="code" href="Gromacs_8h.html#a4">MDIO_BADPARAMS</a>);
00291                 <font class="keywordflow">return</font> NULL;
00292         }
00293 
00294         <font class="comment">// Allocate memory</font>
00295         mf = (<a class="code" href="structmd__file.html">md_file</a> *) malloc(<font class="keyword">sizeof</font>(<a class="code" href="structmd__file.html">md_file</a>));
00296         <font class="keywordflow">if</font> (!mf) {
00297                 <a class="code" href="Gromacs_8h.html#a59">mdio_seterror</a>(<a class="code" href="Gromacs_8h.html#a7">MDIO_BADMALLOC</a>);
00298                 <font class="keywordflow">return</font> NULL;
00299         }
00300 
00301         <font class="comment">// Zero out the structure</font>
00302         memset(mf, 0, <font class="keyword">sizeof</font>(<a class="code" href="structmd__file.html">md_file</a>));
00303 
00304         <font class="comment">// Determine the file type from the extension</font>
00305         <font class="keywordflow">if</font> (!fmt) {
00306                 <font class="keywordtype">char</font> *p;
00307                 <font class="keywordtype">int</font> n;
00308 
00309                 <font class="comment">// Seek to the extension part of the filename</font>
00310                 <font class="keywordflow">for</font> (p = (<font class="keywordtype">char</font> *) &amp;fn[strlen(fn) - 1]; *p != <font class="charliteral">'.'</font> &amp;&amp; p &gt; fn; p--);
00311                 <font class="keywordflow">if</font> (p == fn) {
00312                         free(mf);
00313                         <a class="code" href="Gromacs_8h.html#a59">mdio_seterror</a>(<a class="code" href="Gromacs_8h.html#a9">MDIO_BADEXTENSION</a>);
00314                         <font class="keywordflow">return</font> NULL;
00315                 }
00316 
00317                 <font class="comment">// Check the extension against known extensions</font>
00318                 <font class="keywordflow">for</font> (n = 1; <a class="code" href="Gromacs_8h.html#a32">mdio_fmtexts</a>[n]; n++)
00319                         <font class="keywordflow">if</font> (!strcasecmp(p, <a class="code" href="Gromacs_8h.html#a32">mdio_fmtexts</a>[n])) <font class="keywordflow">break</font>;
00320 
00321                 <font class="comment">// If !mdio_fmtexts[n], we failed (unknown ext)</font>
00322                 <font class="keywordflow">if</font> (!<a class="code" href="Gromacs_8h.html#a32">mdio_fmtexts</a>[n]) {
00323                         free(mf);
00324                         <a class="code" href="Gromacs_8h.html#a59">mdio_seterror</a>(<a class="code" href="Gromacs_8h.html#a10">MDIO_UNKNOWNFMT</a>);
00325                         <font class="keywordflow">return</font> NULL;
00326                 }
00327 
00328                 <font class="comment">// All set</font>
00329                 mf-&gt;<a class="code" href="structmd__file.html#m1">fmt</a> = n;
00330         }
00331         <font class="keywordflow">else</font> {
00332                 mf-&gt;<a class="code" href="structmd__file.html#m1">fmt</a> = fmt;
00333         }
00334 
00335         <font class="comment">// Differentiate between binary and ascii files. Also,</font>
00336         <font class="comment">// .trX files need a header information structure allocated.</font>
00337         <font class="keywordflow">switch</font> (mf-&gt;<a class="code" href="structmd__file.html#m1">fmt</a>) {
00338     <font class="keywordflow">case</font> <a class="code" href="Gromacs_8h.html#a25">MDFMT_GRO</a>:
00339         <font class="keywordflow">case</font> <a class="code" href="Gromacs_8h.html#a27">MDFMT_G96</a>: <font class="comment">/* fallthrough */</font>
00340         <font class="keywordflow">if</font> (rw) 
00341             mf-&gt;<a class="code" href="structmd__file.html#m0">f</a> = fopen(fn, <font class="stringliteral">"wt"</font>);
00342         <font class="keywordflow">else</font>
00343             mf-&gt;<a class="code" href="structmd__file.html#m0">f</a> = fopen(fn, <font class="stringliteral">"rt"</font>);
00344 
00345                 <font class="keywordflow">break</font>;
00346         <font class="keywordflow">case</font> <a class="code" href="Gromacs_8h.html#a26">MDFMT_TRR</a>:
00347         <font class="keywordflow">case</font> <a class="code" href="Gromacs_8h.html#a28">MDFMT_TRJ</a>: <font class="comment">/* fallthrough */</font>
00348                 <font class="comment">// Allocate the trx header data struct</font>
00349                 mf-&gt;<a class="code" href="structmd__file.html#m4">trx</a> = (<a class="code" href="structtrx__hdr.html">trx_hdr</a> *) malloc(<font class="keyword">sizeof</font>(<a class="code" href="structtrx__hdr.html">trx_hdr</a>));
00350                 <font class="keywordflow">if</font> (!mf-&gt;<a class="code" href="structmd__file.html#m4">trx</a>) {
00351                         free(mf);
00352                         <a class="code" href="Gromacs_8h.html#a59">mdio_seterror</a>(<a class="code" href="Gromacs_8h.html#a7">MDIO_BADMALLOC</a>);
00353                         <font class="keywordflow">return</font> NULL;
00354                 }
00355                 memset(mf-&gt;<a class="code" href="structmd__file.html#m4">trx</a>, 0, <font class="keyword">sizeof</font>(<a class="code" href="structtrx__hdr.html">trx_hdr</a>));
00356         <font class="keywordflow">case</font> <a class="code" href="Gromacs_8h.html#a29">MDFMT_XTC</a>:  <font class="comment">/* fallthrough */</font>
00357                 <font class="comment">// Finally, open the file</font>
00358         <font class="keywordflow">if</font> (rw)
00359             mf-&gt;<a class="code" href="structmd__file.html#m0">f</a> = fopen(fn, <font class="stringliteral">"wb"</font>);
00360         <font class="keywordflow">else</font>
00361             mf-&gt;<a class="code" href="structmd__file.html#m0">f</a> = fopen(fn, <font class="stringliteral">"rb"</font>);
00362 
00363                 <font class="keywordflow">break</font>;
00364         <font class="keywordflow">default</font>:
00365                 free(mf);
00366                 <a class="code" href="Gromacs_8h.html#a59">mdio_seterror</a>(<a class="code" href="Gromacs_8h.html#a10">MDIO_UNKNOWNFMT</a>);
00367                 <font class="keywordflow">return</font> NULL;
00368         }
00369 
00370         <font class="comment">// Check for opening error</font>
00371         <font class="keywordflow">if</font> (!mf-&gt;<a class="code" href="structmd__file.html#m0">f</a>) {
00372                 <font class="keywordflow">if</font> (mf-&gt;<a class="code" href="structmd__file.html#m4">trx</a>) free(mf-&gt;<a class="code" href="structmd__file.html#m4">trx</a>);
00373                 free(mf);
00374                 <a class="code" href="Gromacs_8h.html#a59">mdio_seterror</a>(<a class="code" href="Gromacs_8h.html#a8">MDIO_CANTOPEN</a>);
00375                 <font class="keywordflow">return</font> NULL;
00376         }
00377 
00378         <font class="comment">// File is opened, we're all set!</font>
00379         <a class="code" href="Gromacs_8h.html#a59">mdio_seterror</a>(<a class="code" href="Gromacs_8h.html#a1">MDIO_SUCCESS</a>);
00380         <font class="keywordflow">return</font> mf;
00381 }
00382 
00383 
00384 <font class="comment">// Closes a molecular dynamics file.</font>
<a name="l00385"></a><a class="code" href="Gromacs_8h.html#a37">00385</a> <font class="keyword">static</font> <font class="keywordtype">int</font> <a class="code" href="Gromacs_8h.html#a37">mdio_close</a>(<a class="code" href="structmd__file.html">md_file</a> *mf) {
00386         <font class="keywordflow">if</font> (!mf) <font class="keywordflow">return</font> <a class="code" href="Gromacs_8h.html#a59">mdio_seterror</a>(<a class="code" href="Gromacs_8h.html#a4">MDIO_BADPARAMS</a>);
00387 
00388         <font class="keywordflow">if</font> (fclose(mf-&gt;<a class="code" href="structmd__file.html#m0">f</a>) == EOF) <font class="keywordflow">return</font> <a class="code" href="Gromacs_8h.html#a59">mdio_seterror</a>(<a class="code" href="Gromacs_8h.html#a11">MDIO_CANTCLOSE</a>);
00389 
00390         <font class="comment">// Free the dynamically allocated memory</font>
00391         <font class="keywordflow">if</font> (mf-&gt;<a class="code" href="structmd__file.html#m4">trx</a>) free(mf-&gt;<a class="code" href="structmd__file.html#m4">trx</a>);
00392         free(mf);
00393         <font class="keywordflow">return</font> <a class="code" href="Gromacs_8h.html#a59">mdio_seterror</a>(<a class="code" href="Gromacs_8h.html#a1">MDIO_SUCCESS</a>);
00394 }
00395 
00396 
00397 <font class="comment">// Returns the last error code reported by any of the mdio functions</font>
<a name="l00398"></a><a class="code" href="Gromacs_8h.html#a57">00398</a> <font class="keyword">static</font> <font class="keywordtype">int</font> <a class="code" href="Gromacs_8h.html#a57">mdio_errno</a>(<font class="keywordtype">void</font>) {
00399         <font class="keywordflow">return</font> <a class="code" href="Gromacs_8h.html#a33">mdio_errcode</a>;
00400 }
00401 
00402 
00403 <font class="comment">// Returns a textual message regarding an mdio error code</font>
<a name="l00404"></a><a class="code" href="Gromacs_8h.html#a58">00404</a> <font class="keyword">static</font> <font class="keyword">const</font> <font class="keywordtype">char</font> *<a class="code" href="Gromacs_8h.html#a58">mdio_errmsg</a>(<font class="keywordtype">int</font> n) {
00405         <font class="keywordflow">if</font> (n &lt; 0 || n &gt; <a class="code" href="Gromacs_8h.html#a17">MDIO_MAX_ERRVAL</a>) <font class="keywordflow">return</font> (<font class="keywordtype">char</font> *) <font class="stringliteral">"unknown error"</font>;
00406         <font class="keywordflow">else</font> <font class="keywordflow">return</font> <a class="code" href="Gromacs_8h.html#a34">mdio_errdescs</a>[n];
00407 }
00408 
00409 
00410 <font class="comment">// Sets the error code and returns an appropriate return value</font>
00411 <font class="comment">// for the calling function to return to its parent</font>
<a name="l00412"></a><a class="code" href="Gromacs_8h.html#a59">00412</a> <font class="keyword">static</font> <font class="keywordtype">int</font> <a class="code" href="Gromacs_8h.html#a59">mdio_seterror</a>(<font class="keywordtype">int</font> code) {
00413         <a class="code" href="Gromacs_8h.html#a33">mdio_errcode</a> = code;
00414         <font class="keywordflow">return</font> code ? -1 : 0;
00415 }
00416 
00417 
00418 <font class="comment">// Reads a line from the text file, strips leading/trailing whitespace</font>
00419 <font class="comment">// and newline, checks for errors, and returns the number of characters</font>
00420 <font class="comment">// in the string on success or -1 on error.</font>
<a name="l00421"></a><a class="code" href="Gromacs_8h.html#a61">00421</a> <font class="keyword">static</font> <font class="keywordtype">int</font> <a class="code" href="Gromacs_8h.html#a61">mdio_readline</a>(<a class="code" href="structmd__file.html">md_file</a> *mf, <font class="keywordtype">char</font> *buf, <font class="keywordtype">int</font> n, <font class="keywordtype">int</font> strip) {
00422         <font class="keywordflow">if</font> (!buf || n &lt; 1 || !mf) <font class="keywordflow">return</font> <a class="code" href="Gromacs_8h.html#a59">mdio_seterror</a>(<a class="code" href="Gromacs_8h.html#a4">MDIO_BADPARAMS</a>);
00423 
00424         <font class="comment">// Read the line</font>
00425         fgets(buf, n, mf-&gt;<a class="code" href="structmd__file.html#m0">f</a>);
00426 
00427         <font class="comment">// End of file reached?</font>
00428         <font class="keywordflow">if</font> (feof(mf-&gt;<a class="code" href="structmd__file.html#m0">f</a>)) <font class="keywordflow">return</font> <a class="code" href="Gromacs_8h.html#a59">mdio_seterror</a>(<a class="code" href="Gromacs_8h.html#a3">MDIO_EOF</a>);
00429 
00430         <font class="comment">// File I/O error?</font>
00431         <font class="keywordflow">if</font> (ferror(mf-&gt;<a class="code" href="structmd__file.html#m0">f</a>)) <font class="keywordflow">return</font> <a class="code" href="Gromacs_8h.html#a59">mdio_seterror</a>(<a class="code" href="Gromacs_8h.html#a5">MDIO_IOERROR</a>);
00432 
00433         <font class="comment">// Strip whitespace</font>
00434         <font class="keywordflow">if</font> (strip) <a class="code" href="Gromacs_8h.html#a60">strip_white</a>(buf);
00435 
00436         <font class="keywordflow">return</font> strlen(buf);
00437 }
00438 
00439 
00440 <font class="comment">// Strips leading and trailing whitespace from a string. Tabs,</font>
00441 <font class="comment">// spaces, newlines and carriage returns are stripped. Example:</font>
00442 <font class="comment">// "\n   hello\t \r" becomes "hello".</font>
<a name="l00443"></a><a class="code" href="Gromacs_8h.html#a60">00443</a> <font class="keyword">static</font> <font class="keywordtype">int</font> <a class="code" href="Gromacs_8h.html#a60">strip_white</a>(<font class="keywordtype">char</font> *buf) {
00444         <font class="keywordtype">int</font> i, j, k;
00445 
00446         <font class="comment">// Protect against NULL pointer</font>
00447         <font class="keywordflow">if</font> (!buf) <font class="keywordflow">return</font> -1;
00448         <font class="keywordflow">if</font> (!strlen(buf)) <font class="keywordflow">return</font> -1;
00449 
00450         <font class="comment">// Kill trailing whitespace first</font>
00451         <font class="keywordflow">for</font> (i = strlen(buf) - 1;
00452              buf[i] == <font class="charliteral">' '</font> || buf[i] == <font class="charliteral">'\t'</font> ||
00453              buf[i] == <font class="charliteral">'\n'</font> || buf[i] == <font class="charliteral">'\r'</font>;
00454              i--)
00455                 buf[i] = 0;
00456 
00457         <font class="comment">// Skip past leading whitespace</font>
00458         <font class="keywordflow">for</font> (i = 0; buf[i] == <font class="charliteral">' '</font> || buf[i] == <font class="charliteral">'\t'</font> ||
00459              buf[i] == <font class="charliteral">'\n'</font> || buf[i] == <font class="charliteral">'\r'</font>; i++);
00460         <font class="keywordflow">if</font> (i) {
00461                 k = 0;
00462                 <font class="keywordflow">for</font> (j = i; buf[j]; j++)
00463                         buf[k++] = buf[j];
00464                 buf[k] = 0;
00465         }
00466 
00467         <font class="keywordflow">return</font> strlen(buf);
00468 }
00469 
00470 
00471 <font class="comment">// Frees the memory allocated in a ts structure. The holderror</font>
00472 <font class="comment">// parameter defaults to zero. Programs that are calling this</font>
00473 <font class="comment">// function because of an error reported by another function should</font>
00474 <font class="comment">// set holderror so that mdio_tsfree() does not overwrite the error</font>
00475 <font class="comment">// code with mdio_seterror().</font>
<a name="l00476"></a><a class="code" href="Gromacs_8h.html#a62">00476</a> <font class="keyword">static</font> <font class="keywordtype">int</font> <a class="code" href="Gromacs_8h.html#a62">mdio_tsfree</a>(<a class="code" href="structmd__ts.html">md_ts</a> *ts, <font class="keywordtype">int</font> holderror) {
00477         <font class="keywordflow">if</font> (!ts) {
00478                 <font class="keywordflow">if</font> (holderror) <font class="keywordflow">return</font> -1;
00479                 <font class="keywordflow">else</font> <font class="keywordflow">return</font> <a class="code" href="Gromacs_8h.html#a59">mdio_seterror</a>(<a class="code" href="Gromacs_8h.html#a4">MDIO_BADPARAMS</a>);
00480         }
00481 
00482         <font class="keywordflow">if</font> (ts-&gt;<a class="code" href="structmd__ts.html#m0">pos</a> &amp;&amp; ts-&gt;<a class="code" href="structmd__ts.html#m1">natoms</a> &gt; 0) free(ts-&gt;<a class="code" href="structmd__ts.html#m0">pos</a>);
00483 
00484   <font class="keywordflow">if</font> (ts-&gt;<a class="code" href="structmd__ts.html#m4">box</a>) free(ts-&gt;<a class="code" href="structmd__ts.html#m4">box</a>);
00485 
00486         <font class="keywordflow">if</font> (holderror) <font class="keywordflow">return</font> -1;
00487         <font class="keywordflow">else</font> <font class="keywordflow">return</font> <a class="code" href="Gromacs_8h.html#a59">mdio_seterror</a>(<a class="code" href="Gromacs_8h.html#a1">MDIO_SUCCESS</a>);
00488 }
00489 
00490 
00491 <font class="comment">// Converts box basis vectors to A, B, C, alpha, beta, and gamma.  </font>
00492 <font class="comment">// Stores values in md_box struct, which should be allocated before calling</font>
00493 <font class="comment">// this function.</font>
<a name="l00494"></a><a class="code" href="Gromacs_8h.html#a63">00494</a> <font class="keyword">static</font> <font class="keywordtype">int</font> <a class="code" href="Gromacs_8h.html#a63">mdio_readbox</a>(<a class="code" href="structmd__box.html">md_box</a> *box, <font class="keywordtype">float</font> *x, <font class="keywordtype">float</font> *y, <font class="keywordtype">float</font> *z) {
00495   <font class="keywordtype">float</font> A, B, C;
00496 
00497   <font class="keywordflow">if</font> (!box) {
00498     <font class="keywordflow">return</font> <a class="code" href="Gromacs_8h.html#a59">mdio_seterror</a>(<a class="code" href="Gromacs_8h.html#a4">MDIO_BADPARAMS</a>);
00499   }
00500 
00501   <font class="comment">// A, B, C are the lengths of the x, y, z vectors, respectively</font>
00502   A = sqrt( x[0]*x[0] + x[1]*x[1] + x[2]*x[2] ) * <a class="code" href="Gromacs_8h.html#a24">ANGS_PER_NM</a>;
00503   B = sqrt( y[0]*y[0] + y[1]*y[1] + y[2]*y[2] ) * <a class="code" href="Gromacs_8h.html#a24">ANGS_PER_NM</a>;
00504   C = sqrt( z[0]*z[0] + z[1]*z[1] + z[2]*z[2] ) * <a class="code" href="Gromacs_8h.html#a24">ANGS_PER_NM</a>;
00505   <font class="keywordflow">if</font> ((A&lt;=0) || (B&lt;=0) || (C&lt;=0)) {
00506     <font class="comment">/* Use zero-length box size and set angles to 90. */</font>
00507     box-&gt;<a class="code" href="structmd__box.html#m0">A</a> = box-&gt;<a class="code" href="structmd__box.html#m1">B</a> = box-&gt;<a class="code" href="structmd__box.html#m2">C</a> = 0;
00508     box-&gt;<a class="code" href="structmd__box.html#m3">alpha</a> = box-&gt;<a class="code" href="structmd__box.html#m4">beta</a> = box-&gt;<a class="code" href="structmd__box.html#m5">gamma</a> = 90;
00509   } <font class="keywordflow">else</font> {
00510     box-&gt;<a class="code" href="structmd__box.html#m0">A</a> = A;
00511     box-&gt;<a class="code" href="structmd__box.html#m1">B</a> = B;
00512     box-&gt;<a class="code" href="structmd__box.html#m2">C</a> = C;
00513   
00514     <font class="comment">// gamma, beta, alpha are the angles between the x &amp; y, x &amp; z, y &amp; z</font>
00515     <font class="comment">// vectors, respectively</font>
00516     box-&gt;<a class="code" href="structmd__box.html#m5">gamma</a> = acos( (x[0]*y[0]+x[1]*y[1]+x[2]*y[2])/(A*B) ) * 90.0/<a class="code" href="Gromacs_8h.html#a0">M_PI_2</a>;
00517     box-&gt;<a class="code" href="structmd__box.html#m4">beta</a> = acos( (x[0]*z[0]+x[1]*z[1]+x[2]*z[2])/(A*C) ) * 90.0/<a class="code" href="Gromacs_8h.html#a0">M_PI_2</a>;
00518     box-&gt;<a class="code" href="structmd__box.html#m3">alpha</a> = acos( (y[0]*z[0]+y[1]*z[1]+y[2]*z[2])/(B*C) ) * 90.0/<a class="code" href="Gromacs_8h.html#a0">M_PI_2</a>; 
00519   }
00520   <font class="keywordflow">return</font> <a class="code" href="Gromacs_8h.html#a59">mdio_seterror</a>(<a class="code" href="Gromacs_8h.html#a1">MDIO_SUCCESS</a>);
00521 }
00522 
00523 
00524 <font class="comment">// Reads the header of a file (format independent)</font>
<a name="l00525"></a><a class="code" href="Gromacs_8h.html#a38">00525</a> <font class="keyword">static</font> <font class="keywordtype">int</font> <a class="code" href="Gromacs_8h.html#a38">mdio_header</a>(<a class="code" href="structmd__file.html">md_file</a> *mf, <a class="code" href="structmd__header.html">md_header</a> *mdh) {
00526         <font class="keywordtype">int</font> n;
00527         <font class="keywordflow">if</font> (!mf || !mdh) <font class="keywordflow">return</font> <a class="code" href="Gromacs_8h.html#a59">mdio_seterror</a>(<a class="code" href="Gromacs_8h.html#a4">MDIO_BADPARAMS</a>);
00528         <font class="keywordflow">if</font> (!mf-&gt;<a class="code" href="structmd__file.html#m0">f</a>) <font class="keywordflow">return</font> <a class="code" href="Gromacs_8h.html#a59">mdio_seterror</a>(<a class="code" href="Gromacs_8h.html#a4">MDIO_BADPARAMS</a>);
00529 
00530         <font class="keywordflow">switch</font> (mf-&gt;<a class="code" href="structmd__file.html#m1">fmt</a>) {
00531         <font class="keywordflow">case</font> <a class="code" href="Gromacs_8h.html#a25">MDFMT_GRO</a>:
00532                 <font class="keywordflow">if</font> (<a class="code" href="Gromacs_8h.html#a40">gro_header</a>(mf, mdh-&gt;<a class="code" href="structmd__header.html#m0">title</a>, <a class="code" href="Gromacs_8h.html#a23">MAX_MDIO_TITLE</a>,
00533                 &amp;mdh-&gt;<a class="code" href="structmd__header.html#m2">timeval</a>, &amp;mdh-&gt;<a class="code" href="structmd__header.html#m1">natoms</a>, 1) &lt; 0)
00534                         <font class="keywordflow">return</font> -1;
00535                 <font class="keywordflow">return</font> 0;
00536 
00537         <font class="keywordflow">case</font> <a class="code" href="Gromacs_8h.html#a26">MDFMT_TRR</a>:
00538                 <font class="keywordflow">if</font> (<a class="code" href="Gromacs_8h.html#a43">trx_header</a>(mf, 1) &lt; 0) <font class="keywordflow">return</font> -1;
00539                 mdh-&gt;<a class="code" href="structmd__header.html#m1">natoms</a> = mf-&gt;<a class="code" href="structmd__file.html#m4">trx</a>-&gt;<a class="code" href="structtrx__hdr.html#m12">natoms</a>;
00540                 mdh-&gt;<a class="code" href="structmd__header.html#m2">timeval</a> = (float) mf-&gt;<a class="code" href="structmd__file.html#m4">trx</a>-&gt;<a class="code" href="structtrx__hdr.html#m15">t</a>;
00541                 strncpy(mdh-&gt;<a class="code" href="structmd__header.html#m0">title</a>, mf-&gt;<a class="code" href="structmd__file.html#m4">trx</a>-&gt;<a class="code" href="structtrx__hdr.html#m1">title</a>, <a class="code" href="Gromacs_8h.html#a23">MAX_MDIO_TITLE</a>);
00542                 <font class="keywordflow">return</font> 0;
00543 
00544         <font class="keywordflow">case</font> <a class="code" href="Gromacs_8h.html#a27">MDFMT_G96</a>:
00545                 <font class="keywordflow">if</font> (<a class="code" href="Gromacs_8h.html#a49">g96_header</a>(mf, mdh-&gt;<a class="code" href="structmd__header.html#m0">title</a>, <a class="code" href="Gromacs_8h.html#a23">MAX_MDIO_TITLE</a>,
00546                 &amp;mdh-&gt;<a class="code" href="structmd__header.html#m2">timeval</a>) &lt; 0) <font class="keywordflow">return</font> -1;
00547                 mdh-&gt;<a class="code" href="structmd__header.html#m1">natoms</a> = -1;
00548                 <font class="keywordflow">return</font> 0;
00549 
00550         <font class="keywordflow">case</font> <a class="code" href="Gromacs_8h.html#a29">MDFMT_XTC</a>:
00551                 memset(mdh, 0, <font class="keyword">sizeof</font>(<a class="code" href="structmd__header.html">md_header</a>));
00552                 <font class="comment">// Check magic number</font>
00553                 <font class="keywordflow">if</font> (<a class="code" href="Gromacs_8h.html#a53">xtc_int</a>(mf, &amp;n) &lt; 0) <font class="keywordflow">return</font> -1;
00554                 <font class="keywordflow">if</font> (n != <a class="code" href="Gromacs_8h.html#a19">XTC_MAGIC</a>) <font class="keywordflow">return</font> <a class="code" href="Gromacs_8h.html#a59">mdio_seterror</a>(<a class="code" href="Gromacs_8h.html#a2">MDIO_BADFORMAT</a>);
00555 
00556                 <font class="comment">// Get number of atoms</font>
00557                 <font class="keywordflow">if</font> (<a class="code" href="Gromacs_8h.html#a53">xtc_int</a>(mf, &amp;n) &lt; 0) <font class="keywordflow">return</font> -1;
00558                 mdh-&gt;<a class="code" href="structmd__header.html#m1">natoms</a> = n;
00559                 rewind(mf-&gt;<a class="code" href="structmd__file.html#m0">f</a>);
00560                 <font class="keywordflow">return</font> 0;
00561 
00562         <font class="keywordflow">default</font>:
00563                 <font class="keywordflow">return</font> <a class="code" href="Gromacs_8h.html#a59">mdio_seterror</a>(<a class="code" href="Gromacs_8h.html#a10">MDIO_UNKNOWNFMT</a>);
00564         }
00565 }
00566 
00567 
00568 <font class="comment">// Reads in a timestep from a file (format independent)</font>
<a name="l00569"></a><a class="code" href="Gromacs_8h.html#a39">00569</a> <font class="keyword">static</font> <font class="keywordtype">int</font> <a class="code" href="Gromacs_8h.html#a39">mdio_timestep</a>(<a class="code" href="structmd__file.html">md_file</a> *mf, <a class="code" href="structmd__ts.html">md_ts</a> *ts) {
00570         <font class="keywordflow">if</font> (!mf || !ts) <font class="keywordflow">return</font> <a class="code" href="Gromacs_8h.html#a59">mdio_seterror</a>(<a class="code" href="Gromacs_8h.html#a4">MDIO_BADPARAMS</a>);
00571         <font class="keywordflow">if</font> (!mf-&gt;<a class="code" href="structmd__file.html#m0">f</a>) <font class="keywordflow">return</font> <a class="code" href="Gromacs_8h.html#a59">mdio_seterror</a>(<a class="code" href="Gromacs_8h.html#a4">MDIO_BADPARAMS</a>);
00572 
00573         <font class="keywordflow">switch</font> (mf-&gt;<a class="code" href="structmd__file.html#m1">fmt</a>) {
00574         <font class="keywordflow">case</font> <a class="code" href="Gromacs_8h.html#a25">MDFMT_GRO</a>:
00575                 <font class="keywordflow">return</font> <a class="code" href="Gromacs_8h.html#a42">gro_timestep</a>(mf, ts);
00576 
00577         <font class="keywordflow">case</font> <a class="code" href="Gromacs_8h.html#a26">MDFMT_TRR</a>:
00578                 <font class="keywordflow">return</font> <a class="code" href="Gromacs_8h.html#a48">trx_timestep</a>(mf, ts);
00579 
00580         <font class="keywordflow">case</font> <a class="code" href="Gromacs_8h.html#a27">MDFMT_G96</a>:
00581                 <font class="keywordflow">return</font> <a class="code" href="Gromacs_8h.html#a50">g96_timestep</a>(mf, ts);
00582 
00583         <font class="keywordflow">case</font> <a class="code" href="Gromacs_8h.html#a29">MDFMT_XTC</a>:
00584                 <font class="keywordflow">return</font> <a class="code" href="Gromacs_8h.html#a55">xtc_timestep</a>(mf, ts);
00585 
00586         <font class="keywordflow">default</font>:
00587                 <font class="keywordflow">return</font> <a class="code" href="Gromacs_8h.html#a59">mdio_seterror</a>(<a class="code" href="Gromacs_8h.html#a10">MDIO_UNKNOWNFMT</a>);
00588         }
00589 }
00590 
00591 
00592 
<a name="l00593"></a><a class="code" href="Gromacs_8h.html#a49">00593</a> <font class="keyword">static</font> <font class="keywordtype">int</font> <a class="code" href="Gromacs_8h.html#a49">g96_header</a>(<a class="code" href="structmd__file.html">md_file</a> *mf, <font class="keywordtype">char</font> *title, <font class="keywordtype">int</font> titlelen, <font class="keywordtype">float</font> *timeval) {
00594         <font class="keywordtype">char</font> buf[<a class="code" href="Gromacs_8h.html#a21">MAX_G96_LINE</a> + 1];
00595         <font class="keywordtype">char</font> *p;
00596 
00597         <font class="comment">// Check parameters</font>
00598         <font class="keywordflow">if</font> (!mf) <font class="keywordflow">return</font> <a class="code" href="Gromacs_8h.html#a59">mdio_seterror</a>(<a class="code" href="Gromacs_8h.html#a4">MDIO_BADPARAMS</a>);
00599 
00600         <font class="comment">// The header consists of blocks. The title block</font>
00601         <font class="comment">// is mandatory, and a TIMESTEP block is optional.</font>
00602         <font class="comment">// Example:</font>
00603         <font class="comment">//</font>
00604         <font class="comment">// TITLE</font>
00605         <font class="comment">// Generated by trjconv :  t=  90.00000</font>
00606         <font class="comment">// more title info</font>
00607         <font class="comment">// .</font>
00608         <font class="comment">// .</font>
00609         <font class="comment">// .</font>
00610         <font class="comment">// END</font>
00611         <font class="comment">// .</font>
00612         <font class="comment">// .</font>
00613         <font class="comment">// .</font>
00614 
00615         <font class="keywordflow">if</font> (<a class="code" href="Gromacs_8h.html#a61">mdio_readline</a>(mf, buf, <a class="code" href="Gromacs_8h.html#a21">MAX_G96_LINE</a> + 1) &lt; 0) <font class="keywordflow">return</font> -1;
00616         <font class="keywordflow">if</font> (strcasecmp(buf, <font class="stringliteral">"TITLE"</font>)) <font class="keywordflow">return</font> <a class="code" href="Gromacs_8h.html#a59">mdio_seterror</a>(<a class="code" href="Gromacs_8h.html#a2">MDIO_BADFORMAT</a>);
00617 
00618         <font class="comment">// Read in the title itself</font>
00619         <font class="keywordflow">if</font> (<a class="code" href="Gromacs_8h.html#a61">mdio_readline</a>(mf, buf, <a class="code" href="Gromacs_8h.html#a21">MAX_G96_LINE</a> + 1) &lt; 0) <font class="keywordflow">return</font> -1;
00620 
00621         <font class="comment">// The timevalue can be included in the title string</font>
00622         <font class="comment">// after a "t=" prefix.</font>
00623         <font class="keywordflow">if</font> ((p = (<font class="keywordtype">char</font> *) strstr(buf, <font class="stringliteral">"t="</font>))) {
00624                 <font class="keywordtype">char</font> *q = p;
00625                 *(q--) = 0;
00626 
00627                 <font class="comment">// Skip the `t=' and strip whitespace from</font>
00628                 <font class="comment">// the resulting strings</font>
00629                 p += 2;
00630                 <a class="code" href="Gromacs_8h.html#a60">strip_white</a>(p);
00631                 <a class="code" href="Gromacs_8h.html#a60">strip_white</a>(buf);
00632 
00633                 <font class="comment">// Grab the timevalue from the title string</font>
00634                 <font class="keywordflow">if</font> (timeval) *timeval = (float) atof(p);
00635         }
00636         <font class="keywordflow">else</font> {
00637                 <font class="comment">// No timevalue - just copy the string and strip</font>
00638                 <font class="comment">// any leading/trailing whitespace</font>
00639                 <font class="keywordflow">if</font> (timeval) *timeval = 0;
00640                 <a class="code" href="Gromacs_8h.html#a60">strip_white</a>(buf);
00641         }
00642 
00643         <font class="comment">// Copy the title string</font>
00644         <font class="keywordflow">if</font> (title &amp;&amp; titlelen) strncpy(title, buf, titlelen);
00645 
00646         <font class="comment">// Now ignore subsequent title lines and get the END string</font>
00647         <font class="keywordflow">while</font> (strcasecmp(buf, <font class="stringliteral">"END"</font>))
00648                 <font class="keywordflow">if</font> (<a class="code" href="Gromacs_8h.html#a61">mdio_readline</a>(mf, buf, <a class="code" href="Gromacs_8h.html#a21">MAX_G96_LINE</a> + 1) &lt; 0) <font class="keywordflow">return</font> -1;
00649 
00650         <font class="comment">// Done!</font>
00651         <font class="keywordflow">return</font> <a class="code" href="Gromacs_8h.html#a59">mdio_seterror</a>(<a class="code" href="Gromacs_8h.html#a1">MDIO_SUCCESS</a>);
00652 }
00653 
00654 
00655 <font class="comment">// Used to determine the number of atoms in a g96 file, because</font>
00656 <font class="comment">// VMD needs to know this for some reason.</font>
<a name="l00657"></a><a class="code" href="Gromacs_8h.html#a52">00657</a> <font class="keyword">static</font> <font class="keywordtype">int</font> <a class="code" href="Gromacs_8h.html#a52">g96_countatoms</a>(<a class="code" href="structmd__file.html">md_file</a> *mf) {
00658         <font class="keywordtype">char</font> buf[<a class="code" href="Gromacs_8h.html#a21">MAX_G96_LINE</a> + 1];
00659         <font class="keywordtype">int</font> natoms;
00660         <font class="keywordtype">int</font> n;
00661         <font class="keywordtype">long</font> fpos;
00662         <font class="keywordtype">float</font> lastf;
00663 
00664         <font class="keywordflow">if</font> (!mf) <font class="keywordflow">return</font> <a class="code" href="Gromacs_8h.html#a59">mdio_seterror</a>(<a class="code" href="Gromacs_8h.html#a4">MDIO_BADPARAMS</a>);
00665 
00666         fpos = ftell(mf-&gt;<a class="code" href="structmd__file.html#m0">f</a>);
00667 
00668         natoms = 0;
00669         <font class="keywordflow">for</font> (;;) {
00670                 <font class="keywordflow">if</font> (<a class="code" href="Gromacs_8h.html#a61">mdio_readline</a>(mf, buf, <a class="code" href="Gromacs_8h.html#a21">MAX_G96_LINE</a> + 1, 0) &lt; 0)
00671                         <font class="keywordflow">break</font>;
00672                 n = sscanf(buf, <font class="stringliteral">"%*6c%*6c%*6c%*6c %*f %*f %f"</font>, &amp;lastf);
00673                 <font class="keywordflow">if</font> (n == 1) natoms++;
00674                 <font class="keywordflow">else</font> {
00675                         <a class="code" href="Gromacs_8h.html#a60">strip_white</a>(buf);
00676                         <font class="keywordflow">if</font> (!strcasecmp(buf, <font class="stringliteral">"END"</font>)) <font class="keywordflow">break</font>;
00677                 }
00678         }
00679 
00680         fseek(mf-&gt;<a class="code" href="structmd__file.html#m0">f</a>, fpos, SEEK_SET);
00681         <font class="keywordflow">return</font> natoms;
00682 }
00683 
00684 
00685 <font class="comment">// Reads an atom line from the G96 file</font>
<a name="l00686"></a><a class="code" href="Gromacs_8h.html#a51">00686</a> <font class="keyword">static</font> <font class="keywordtype">int</font> <a class="code" href="Gromacs_8h.html#a51">g96_rec</a>(<a class="code" href="structmd__file.html">md_file</a> *mf, <a class="code" href="structmd__atom.html">md_atom</a> *ma) {
00687         <font class="keywordtype">char</font> buf[<a class="code" href="Gromacs_8h.html#a21">MAX_G96_LINE</a> + 1];
00688         <font class="keywordtype">char</font> atomnum[7];
00689         <font class="keywordtype">int</font> n;
00690 
00691         <font class="comment">// Check parameters</font>
00692         <font class="keywordflow">if</font> (!mf || !ma) <font class="keywordflow">return</font> <a class="code" href="Gromacs_8h.html#a59">mdio_seterror</a>(<a class="code" href="Gromacs_8h.html#a4">MDIO_BADPARAMS</a>);
00693 
00694         <font class="comment">// Read in a line, assuming it is an atom line</font>
00695         <font class="keywordflow">do</font> {
00696                 <font class="keywordflow">if</font> (<a class="code" href="Gromacs_8h.html#a61">mdio_readline</a>(mf, buf, <a class="code" href="Gromacs_8h.html#a21">MAX_G96_LINE</a> + 1, 0) &lt; 0) <font class="keywordflow">return</font> -1;
00697         } <font class="keywordflow">while</font> (buf[0] == <font class="charliteral">'#'</font> || strlen(buf) == 0);
00698 
00699         n = sscanf(buf, <font class="stringliteral">"%6c%6c%6c%6c %f %f %f"</font>,
00700                 ma-&gt;<a class="code" href="structmd__atom.html#m0">resid</a>, ma-&gt;<a class="code" href="structmd__atom.html#m1">resname</a>, ma-&gt;<a class="code" href="structmd__atom.html#m3">atomname</a>, atomnum,
00701                 &amp;ma-&gt;<a class="code" href="structmd__atom.html#m4">pos</a>[0], &amp;ma-&gt;<a class="code" href="structmd__atom.html#m4">pos</a>[1], &amp;ma-&gt;<a class="code" href="structmd__atom.html#m4">pos</a>[2]);
00702         <font class="keywordflow">if</font> (n == 7) {
00703                 atomnum[6] = 0;
00704                 ma-&gt;<a class="code" href="structmd__atom.html#m0">resid</a>[6] = 0;
00705                 ma-&gt;<a class="code" href="structmd__atom.html#m1">resname</a>[6] = 0;
00706                 ma-&gt;<a class="code" href="structmd__atom.html#m3">atomname</a>[6] = 0;
00707 
00708                 <a class="code" href="Gromacs_8h.html#a60">strip_white</a>(atomnum);
00709                 <a class="code" href="Gromacs_8h.html#a60">strip_white</a>(ma-&gt;<a class="code" href="structmd__atom.html#m0">resid</a>);
00710                 <a class="code" href="Gromacs_8h.html#a60">strip_white</a>(ma-&gt;<a class="code" href="structmd__atom.html#m1">resname</a>);
00711                 <a class="code" href="Gromacs_8h.html#a60">strip_white</a>(ma-&gt;<a class="code" href="structmd__atom.html#m3">atomname</a>);
00712 
00713                 ma-&gt;<a class="code" href="structmd__atom.html#m2">atomnum</a> = atoi(atomnum);
00714 
00715                 ma-&gt;<a class="code" href="structmd__atom.html#m4">pos</a>[0] *= <a class="code" href="Gromacs_8h.html#a24">ANGS_PER_NM</a>;
00716                 ma-&gt;<a class="code" href="structmd__atom.html#m4">pos</a>[1] *= <a class="code" href="Gromacs_8h.html#a24">ANGS_PER_NM</a>;
00717                 ma-&gt;<a class="code" href="structmd__atom.html#m4">pos</a>[2] *= <a class="code" href="Gromacs_8h.html#a24">ANGS_PER_NM</a>;
00718 
00719                 <font class="keywordflow">return</font> 0;
00720         }
00721 
00722         <font class="keywordflow">return</font> <a class="code" href="Gromacs_8h.html#a59">mdio_seterror</a>(<a class="code" href="Gromacs_8h.html#a2">MDIO_BADFORMAT</a>);
00723 }
00724 
00725 
00726 <font class="comment">// Reads a timestep from a G96 file and stores the data in</font>
00727 <font class="comment">// the generic md_ts structure. Returns 0 on success or a</font>
00728 <font class="comment">// negative number on error and sets mdio_errcode.</font>
<a name="l00729"></a><a class="code" href="Gromacs_8h.html#a50">00729</a> <font class="keyword">static</font> <font class="keywordtype">int</font> <a class="code" href="Gromacs_8h.html#a50">g96_timestep</a>(<a class="code" href="structmd__file.html">md_file</a> *mf, <a class="code" href="structmd__ts.html">md_ts</a> *ts) {
00730         <font class="keywordtype">char</font>            buf[<a class="code" href="Gromacs_8h.html#a21">MAX_G96_LINE</a> + 1];
00731         <font class="keywordtype">char</font>            stripbuf[<a class="code" href="Gromacs_8h.html#a21">MAX_G96_LINE</a> + 1];
00732         <font class="keywordtype">float</font>           pos[3], x[3], y[3], z[3], *currAtom;
00733         <font class="keywordtype">long</font>            fpos;
00734         <font class="keywordtype">int</font>             n, i, boxItems;
00735 
00736         <font class="comment">// Check parameters</font>
00737         <font class="keywordflow">if</font> (!mf || !ts) <font class="keywordflow">return</font> <a class="code" href="Gromacs_8h.html#a59">mdio_seterror</a>(<a class="code" href="Gromacs_8h.html#a4">MDIO_BADPARAMS</a>);
00738 
00739   <font class="comment">// Allocate data space for the timestep, using the number of atoms</font>
00740   <font class="comment">// determined by open_g96_read().</font>
00741         ts-&gt;<a class="code" href="structmd__ts.html#m0">pos</a> = (<font class="keywordtype">float</font> *) malloc(<font class="keyword">sizeof</font>(<font class="keywordtype">float</font>) * 3 * ts-&gt;<a class="code" href="structmd__ts.html#m1">natoms</a>);
00742         <font class="keywordflow">if</font> (!ts-&gt;<a class="code" href="structmd__ts.html#m0">pos</a>) {
00743                 <font class="keywordflow">return</font> <a class="code" href="Gromacs_8h.html#a59">mdio_seterror</a>(<a class="code" href="Gromacs_8h.html#a7">MDIO_BADMALLOC</a>);
00744         }
00745   currAtom = ts-&gt;<a class="code" href="structmd__ts.html#m0">pos</a>;
00746 
00747         <font class="comment">// The timesteps follow the header in a fixed block</font>
00748         <font class="comment">// format:</font>
00749         <font class="comment">//</font>
00750         <font class="comment">// TIMESTEP</font>
00751         <font class="comment">//         &lt;step number&gt; &lt;time value&gt;</font>
00752         <font class="comment">// END</font>
00753         <font class="comment">// POSITIONRED</font>
00754         <font class="comment">//     &lt;x float&gt; &lt;y float&gt; &lt;z float&gt;</font>
00755         <font class="comment">//     .         .         .</font>
00756         <font class="comment">//     .         .         .</font>
00757         <font class="comment">//     .         .         .</font>
00758         <font class="comment">// END</font>
00759         <font class="comment">// VELOCITYRED</font>
00760         <font class="comment">//     &lt;x float&gt; &lt;y float&gt; &lt;z float&gt;</font>
00761         <font class="comment">//     .         .         .</font>
00762         <font class="comment">//     .         .         .</font>
00763         <font class="comment">//     .         .         .</font>
00764         <font class="comment">// END</font>
00765         <font class="comment">// BOX</font>
00766         <font class="comment">//     &lt;x float&gt; &lt;y float&gt; &lt;z float&gt;</font>
00767         <font class="comment">// END</font>
00768         <font class="comment">//</font>
00769         <font class="comment">// -----</font>
00770         <font class="comment">//</font>
00771         <font class="comment">// The TIMESTEP, VELOCITY and BOX blocks are optional.</font>
00772         <font class="comment">// Floats are written in 15.9 precision.</font>
00773         <font class="comment">//</font>
00774         <font class="comment">// Reference: GROMACS 2.0 user manual</font>
00775         <font class="comment">//            http://rugmd4.chem.rug.nl/~gmx/online2.0/g96.html</font>
00776 
00777         <font class="comment">// First, look for an (optional) title block and skip it</font>
00778         <font class="keywordflow">if</font> (<a class="code" href="Gromacs_8h.html#a61">mdio_readline</a>(mf, buf, <a class="code" href="Gromacs_8h.html#a21">MAX_G96_LINE</a> + 1) &lt; 0) <font class="keywordflow">return</font> -1;
00779 
00780   <font class="keywordflow">if</font> (!strcasecmp(buf, <font class="stringliteral">"TITLE"</font>)) {
00781     <font class="comment">// skip over the text until we reach 'END'</font>
00782     <font class="keywordflow">while</font> (strcasecmp(buf, <font class="stringliteral">"END"</font>)) {
00783       <font class="keywordflow">if</font> (<a class="code" href="Gromacs_8h.html#a61">mdio_readline</a>(mf, buf, <a class="code" href="Gromacs_8h.html#a21">MAX_G96_LINE</a> + 1) &lt; 0) <font class="keywordflow">return</font> -1;
00784     }
00785 
00786     <font class="comment">// Read in the next line</font>
00787     <font class="keywordflow">if</font> (<a class="code" href="Gromacs_8h.html#a61">mdio_readline</a>(mf, buf, <a class="code" href="Gromacs_8h.html#a21">MAX_G96_LINE</a> + 1) &lt; 0) <font class="keywordflow">return</font> -1;
00788   }
00789 
00790         <font class="comment">// Next, look for a timestep block</font>
00791         <font class="keywordflow">if</font> (!strcasecmp(buf, <font class="stringliteral">"TIMESTEP"</font>)) {
00792                 <font class="comment">// Read in the value line</font>
00793                 <font class="keywordflow">if</font> (<a class="code" href="Gromacs_8h.html#a61">mdio_readline</a>(mf, buf, <a class="code" href="Gromacs_8h.html#a21">MAX_G96_LINE</a> + 1) &lt; 0) <font class="keywordflow">return</font> -1;
00794 
00795                 <font class="comment">// Extract the time value and the timestep index</font>
00796                 n = sscanf(buf, <font class="stringliteral">"%d %f"</font>, &amp;ts-&gt;<a class="code" href="structmd__ts.html#m2">step</a>, &amp;ts-&gt;<a class="code" href="structmd__ts.html#m3">time</a>);
00797                 <font class="keywordflow">if</font> (n != 2) <font class="keywordflow">return</font> <a class="code" href="Gromacs_8h.html#a59">mdio_seterror</a>(<a class="code" href="Gromacs_8h.html#a2">MDIO_BADFORMAT</a>);
00798 
00799                 <font class="comment">// Read the "END" line</font>
00800                 <font class="keywordflow">if</font> (<a class="code" href="Gromacs_8h.html#a61">mdio_readline</a>(mf, buf, <a class="code" href="Gromacs_8h.html#a21">MAX_G96_LINE</a> + 1) &lt; 0) <font class="keywordflow">return</font> -1;
00801                 <font class="keywordflow">if</font> (strcasecmp(buf, <font class="stringliteral">"END"</font>))
00802                         <font class="keywordflow">return</font> <a class="code" href="Gromacs_8h.html#a59">mdio_seterror</a>(<a class="code" href="Gromacs_8h.html#a2">MDIO_BADFORMAT</a>);
00803 
00804                 <font class="comment">// Read in the next line</font>
00805                 <font class="keywordflow">if</font> (<a class="code" href="Gromacs_8h.html#a61">mdio_readline</a>(mf, buf, <a class="code" href="Gromacs_8h.html#a21">MAX_G96_LINE</a> + 1) &lt; 0) <font class="keywordflow">return</font> -1;
00806         }
00807         <font class="keywordflow">else</font> {
00808                 <font class="comment">// No timestep specified -- set to zero</font>
00809                 ts-&gt;<a class="code" href="structmd__ts.html#m2">step</a> = 0;
00810                 ts-&gt;<a class="code" href="structmd__ts.html#m3">time</a> = 0;
00811         }
00812 
00813         <font class="comment">// At this point a POSITION or POSITIONRED block</font>
00814         <font class="comment">// is REQUIRED by the format</font>
00815         <font class="keywordflow">if</font> (!strcasecmp(buf, <font class="stringliteral">"POSITIONRED"</font>)) {
00816 
00817     <font class="comment">// So now we read in some atoms</font>
00818     i = 0;
00819                 <font class="keywordflow">while</font> (i &lt; ts-&gt;<a class="code" href="structmd__ts.html#m1">natoms</a>) {
00820                         <font class="comment">// Read in an atom</font>
00821                         <font class="keywordflow">if</font> (<a class="code" href="Gromacs_8h.html#a61">mdio_readline</a>(mf, buf, <a class="code" href="Gromacs_8h.html#a21">MAX_G96_LINE</a> + 1) &lt; 0)
00822                                 <font class="keywordflow">return</font> -1;
00823  
00824       <font class="comment">// We shouldn't reach the end yet</font>
00825       <font class="keywordflow">if</font> (!strcasecmp(buf, <font class="stringliteral">"END"</font>))
00826         <font class="keywordflow">return</font> <a class="code" href="Gromacs_8h.html#a59">mdio_seterror</a>(<a class="code" href="Gromacs_8h.html#a2">MDIO_BADFORMAT</a>);
00827 
00828                         <font class="comment">// Get the x,y,z coordinates</font>
00829                         n = sscanf(buf, <font class="stringliteral">"%f %f %f"</font>, &amp;pos[0], &amp;pos[1], &amp;pos[2]);
00830       
00831       <font class="comment">// Ignore improperly formatted lines</font>
00832                         <font class="keywordflow">if</font> (n == 3) {
00833                                 pos[0] *= <a class="code" href="Gromacs_8h.html#a24">ANGS_PER_NM</a>;
00834                                 pos[1] *= <a class="code" href="Gromacs_8h.html#a24">ANGS_PER_NM</a>;
00835                                 pos[2] *= <a class="code" href="Gromacs_8h.html#a24">ANGS_PER_NM</a>;
00836 
00837                                 <font class="comment">// Copy the atom data into the array</font>
00838                                 memcpy(currAtom, pos, <font class="keyword">sizeof</font>(<font class="keywordtype">float</font>) * 3);
00839         currAtom += 3;
00840         i++;
00841                         }
00842                 }
00843         }
00844         <font class="keywordflow">else</font> <font class="keywordflow">if</font> (!strcasecmp(buf, <font class="stringliteral">"POSITION"</font>) || !strcasecmp(buf, <font class="stringliteral">"REFPOSITION"</font>)) {
00845                 <font class="comment">/*</font>
00846 <font class="comment">                char resnum[7];</font>
00847 <font class="comment">                char resname[7];</font>
00848 <font class="comment">                char atomname[7];</font>
00849 <font class="comment">                char atomnum[7];</font>
00850 <font class="comment">                */</font>
00851 
00852                 <font class="comment">// So now we read in some atoms</font>
00853     i = 0;
00854                 <font class="keywordflow">while</font> (i &lt; ts-&gt;<a class="code" href="structmd__ts.html#m1">natoms</a>) {
00855                         <font class="comment">// Read in the first line</font>
00856                         <font class="keywordflow">if</font> (<a class="code" href="Gromacs_8h.html#a61">mdio_readline</a>(mf, buf, <a class="code" href="Gromacs_8h.html#a21">MAX_G96_LINE</a> + 1, 0) &lt; 0)
00857                                 <font class="keywordflow">return</font> -1;
00858  
00859       <font class="comment">// We shouldn't reach the end yet</font>
00860       strcpy(stripbuf, buf);
00861       <a class="code" href="Gromacs_8h.html#a60">strip_white</a>(stripbuf); 
00862       <font class="keywordflow">if</font> (!strcasecmp(stripbuf, <font class="stringliteral">"END"</font>))
00863         <font class="keywordflow">return</font> <a class="code" href="Gromacs_8h.html#a59">mdio_seterror</a>(<a class="code" href="Gromacs_8h.html#a2">MDIO_BADFORMAT</a>);
00864 
00865                         <font class="comment">// Get the x,y,z coordinates and name data</font>
00866                         n = sscanf(buf, <font class="stringliteral">"%*6c%*6c%*6c%*6c %f %f %f"</font>,
00867                                 &amp;pos[0], &amp;pos[1], &amp;pos[2]);
00868 
00869       <font class="comment">// Ignore improperly formatted lines</font>
00870                         <font class="keywordflow">if</font> (n == 3) {
00871                                 pos[0] *= <a class="code" href="Gromacs_8h.html#a24">ANGS_PER_NM</a>;
00872                                 pos[1] *= <a class="code" href="Gromacs_8h.html#a24">ANGS_PER_NM</a>;
00873                                 pos[2] *= <a class="code" href="Gromacs_8h.html#a24">ANGS_PER_NM</a>;
00874 
00875                                 <font class="comment">// Copy the atom data into the linked list item</font>
00876                                 memcpy(currAtom, pos, <font class="keyword">sizeof</font>(<font class="keywordtype">float</font>) * 3);
00877                                 currAtom += 3;
00878         i++;
00879                         }
00880                 }
00881         }
00882         <font class="keywordflow">else</font> {
00883                 <font class="keywordflow">return</font> <a class="code" href="Gromacs_8h.html#a59">mdio_seterror</a>(<a class="code" href="Gromacs_8h.html#a2">MDIO_BADFORMAT</a>);
00884         }
00885 
00886   <font class="comment">// Read the END keyword</font>
00887   <font class="keywordflow">if</font> (<a class="code" href="Gromacs_8h.html#a61">mdio_readline</a>(mf, buf, <a class="code" href="Gromacs_8h.html#a21">MAX_G96_LINE</a> + 1) &lt; 0)
00888     <font class="keywordflow">return</font> -1;
00889   <font class="keywordflow">if</font> (strcasecmp(buf, <font class="stringliteral">"END"</font>))
00890     <font class="keywordflow">return</font> <a class="code" href="Gromacs_8h.html#a59">mdio_seterror</a>(<a class="code" href="Gromacs_8h.html#a2">MDIO_BADFORMAT</a>);
00891 
00892         <font class="comment">// ... another problem: there may or may not be a VELOCITY</font>
00893         <font class="comment">// block or a BOX block, so we need to read one line beyond</font>
00894         <font class="comment">// the POSITION block to determine this. If neither VEL. nor</font>
00895         <font class="comment">// BOX are present we've read a line too far and infringed</font>
00896         <font class="comment">// on the next timestep, so we need to keep track of the</font>
00897         <font class="comment">// position now for a possible fseek() later to backtrack.</font>
00898         fpos = ftell(mf-&gt;<a class="code" href="structmd__file.html#m0">f</a>);
00899 
00900         <font class="comment">// Now we must read in the velocities and the box, if present</font>
00901         <font class="keywordflow">if</font> (<a class="code" href="Gromacs_8h.html#a61">mdio_readline</a>(mf, buf, <a class="code" href="Gromacs_8h.html#a21">MAX_G96_LINE</a> + 1) &lt; 0) {
00902     <font class="comment">// It's okay if we end the file here; any other errors need to be</font>
00903     <font class="comment">// reported.</font>
00904     <font class="keywordflow">if</font> (<a class="code" href="Gromacs_8h.html#a33">mdio_errcode</a> == <a class="code" href="Gromacs_8h.html#a3">MDIO_EOF</a>) 
00905       <font class="keywordflow">return</font> <a class="code" href="Gromacs_8h.html#a59">mdio_seterror</a>(<a class="code" href="Gromacs_8h.html#a1">MDIO_SUCCESS</a>);
00906     <font class="keywordflow">else</font> 
00907       <font class="keywordflow">return</font> -1;
00908   }
00909 
00910         <font class="comment">// Is there a velocity block present ?</font>
00911         <font class="keywordflow">if</font> (!strcasecmp(buf, <font class="stringliteral">"VELOCITY"</font>) || !strcasecmp(buf, <font class="stringliteral">"VELOCITYRED"</font>)) {
00912                 <font class="comment">// Ignore all the coordinates - VMD doesn't use them</font>
00913                 <font class="keywordflow">for</font> (;;) {
00914                         <font class="keywordflow">if</font> (<a class="code" href="Gromacs_8h.html#a61">mdio_readline</a>(mf, buf, <a class="code" href="Gromacs_8h.html#a21">MAX_G96_LINE</a> + 1) &lt; 0)
00915                                 <font class="keywordflow">return</font> -1;
00916                         <font class="keywordflow">if</font> (!strcasecmp(buf, <font class="stringliteral">"END"</font>)) <font class="keywordflow">break</font>;
00917                 }
00918 
00919                 <font class="comment">// Again, record our position because we may need</font>
00920                 <font class="comment">// to fseek here later if we read too far.</font>
00921                 fpos = ftell(mf-&gt;<a class="code" href="structmd__file.html#m0">f</a>);
00922 
00923                 <font class="comment">// Go ahead and read the next line.</font>
00924                 <font class="keywordflow">if</font> (<a class="code" href="Gromacs_8h.html#a61">mdio_readline</a>(mf, buf, <a class="code" href="Gromacs_8h.html#a21">MAX_G96_LINE</a> + 1) &lt; 0) <font class="keywordflow">return</font> -1;
00925         }
00926 
00927         <font class="comment">// Is there a box present ?</font>
00928         <font class="keywordflow">if</font> (!strcasecmp(buf, <font class="stringliteral">"BOX"</font>)) {
00929                 <font class="keywordflow">if</font> (<a class="code" href="Gromacs_8h.html#a61">mdio_readline</a>(mf, buf, <a class="code" href="Gromacs_8h.html#a21">MAX_G96_LINE</a> + 1) &lt; 0) <font class="keywordflow">return</font> -1;
00930     boxItems = sscanf(buf, <font class="stringliteral">" %f %f %f %f %f %f %f %f %f"</font>, 
00931                &amp;x[0], &amp;y[1], &amp;z[2], &amp;x[1], &amp;x[2], &amp;y[0], &amp;y[2], &amp;z[0], &amp;z[1]);
00932     <font class="keywordflow">if</font> (boxItems == 3) {
00933       x[1] = x[2] = 0;
00934       y[0] = y[2] = 0;
00935       z[0] = z[1] = 0;
00936     }
00937     <font class="keywordflow">else</font> <font class="keywordflow">if</font> (boxItems != 9) 
00938       <font class="keywordflow">return</font> <a class="code" href="Gromacs_8h.html#a59">mdio_seterror</a>(<a class="code" href="Gromacs_8h.html#a2">MDIO_BADFORMAT</a>);
00939 
00940     <font class="comment">// Allocate the box and convert the vectors.</font>
00941     ts-&gt;<a class="code" href="structmd__ts.html#m4">box</a> = (<a class="code" href="structmd__box.html">md_box</a> *) malloc(<font class="keyword">sizeof</font>(<a class="code" href="structmd__box.html">md_box</a>));
00942     <font class="keywordflow">if</font> (<a class="code" href="Gromacs_8h.html#a63">mdio_readbox</a>(ts-&gt;<a class="code" href="structmd__ts.html#m4">box</a>, x, y, z) &lt; 0) {
00943       free(ts-&gt;<a class="code" href="structmd__ts.html#m4">box</a>);
00944       ts-&gt;<a class="code" href="structmd__ts.html#m4">box</a> = NULL;
00945       <font class="keywordflow">return</font> <a class="code" href="Gromacs_8h.html#a59">mdio_seterror</a>(<a class="code" href="Gromacs_8h.html#a2">MDIO_BADFORMAT</a>);
00946     }
00947 
00948                 <font class="keywordflow">if</font> (<a class="code" href="Gromacs_8h.html#a61">mdio_readline</a>(mf, buf, <a class="code" href="Gromacs_8h.html#a21">MAX_G96_LINE</a> + 1) &lt; 0) {
00949       free(ts-&gt;<a class="code" href="structmd__ts.html#m4">box</a>);
00950       ts-&gt;<a class="code" href="structmd__ts.html#m4">box</a> = NULL;
00951       <font class="keywordflow">return</font> -1;
00952     }
00953                 <font class="keywordflow">if</font> (strcasecmp(buf, <font class="stringliteral">"END"</font>)) {
00954       free(ts-&gt;<a class="code" href="structmd__ts.html#m4">box</a>);
00955       ts-&gt;<a class="code" href="structmd__ts.html#m4">box</a> = NULL;
00956                         <font class="keywordflow">return</font> <a class="code" href="Gromacs_8h.html#a59">mdio_seterror</a>(<a class="code" href="Gromacs_8h.html#a2">MDIO_BADFORMAT</a>);
00957     }
00958         }
00959         <font class="keywordflow">else</font> {
00960                 <font class="comment">// We have read too far, so fseek back to the</font>
00961                 <font class="comment">// last known safe position so we don't return</font>
00962                 <font class="comment">// with the file pointer set infringing on the</font>
00963                 <font class="comment">// next timestep data.</font>
00964                 fseek(mf-&gt;<a class="code" href="structmd__file.html#m0">f</a>, fpos, SEEK_SET);
00965         }
00966 
00967         <font class="comment">// We're done!</font>
00968         <font class="keywordflow">return</font> <a class="code" href="Gromacs_8h.html#a59">mdio_seterror</a>(<a class="code" href="Gromacs_8h.html#a1">MDIO_SUCCESS</a>);
00969 }
00970 
00971 
00972 <font class="comment">// Attempts to read header data from a GROMACS structure file</font>
00973 <font class="comment">// The GROMACS header format is as follows (fixed, 2 lines ASCII):</font>
00974 <font class="comment">// &lt;title&gt; [ n= &lt;timevalue&gt; ]</font>
00975 <font class="comment">//     &lt;num atoms&gt;</font>
<a name="l00976"></a><a class="code" href="Gromacs_8h.html#a40">00976</a> <font class="keyword">static</font> <font class="keywordtype">int</font> <a class="code" href="Gromacs_8h.html#a40">gro_header</a>(<a class="code" href="structmd__file.html">md_file</a> *mf, <font class="keywordtype">char</font> *title, <font class="keywordtype">int</font> titlelen, <font class="keywordtype">float</font> *timeval,
00977                <font class="keywordtype">int</font> *natoms, <font class="keywordtype">int</font> rewind) {
00978         <font class="keywordtype">char</font> buf[<a class="code" href="Gromacs_8h.html#a20">MAX_GRO_LINE</a> + 1];
00979         <font class="keywordtype">long</font> fpos;
00980         <font class="keywordtype">char</font> *p;
00981 
00982         <font class="comment">// Check parameters</font>
00983         <font class="keywordflow">if</font> (!mf) <font class="keywordflow">return</font> <a class="code" href="Gromacs_8h.html#a59">mdio_seterror</a>(<a class="code" href="Gromacs_8h.html#a4">MDIO_BADPARAMS</a>);
00984 
00985         <font class="comment">// Get the current file position for rewinding later</font>
00986         fpos = ftell(mf-&gt;<a class="code" href="structmd__file.html#m0">f</a>);
00987 
00988         <font class="comment">// The header consists of 2 lines - get the first line</font>
00989         <font class="keywordflow">if</font> (<a class="code" href="Gromacs_8h.html#a61">mdio_readline</a>(mf, buf, <a class="code" href="Gromacs_8h.html#a20">MAX_GRO_LINE</a> + 1) &lt; 0) <font class="keywordflow">return</font> -1;
00990 
00991         <font class="comment">// The timevalue can be included in the title string</font>
00992         <font class="comment">// after a "t=" prefix.</font>
00993         <font class="keywordflow">if</font> ((p = (<font class="keywordtype">char</font> *) strstr(buf, <font class="stringliteral">"t="</font>))) {
00994                 <font class="keywordtype">char</font> *q = p;
00995                 *(q--) = 0;
00996 
00997                 <font class="comment">// Skip the `t=' and strip whitespace from</font>
00998                 <font class="comment">// the resulting strings</font>
00999                 p += 2;
01000                 <a class="code" href="Gromacs_8h.html#a60">strip_white</a>(p);
01001                 <a class="code" href="Gromacs_8h.html#a60">strip_white</a>(buf);
01002 
01003                 <font class="comment">// Grab the timevalue from the title string</font>
01004                 <font class="keywordflow">if</font> (timeval) *timeval = (float) atof(p);
01005         }
01006         <font class="keywordflow">else</font> {
01007                 <font class="comment">// No timevalue - just copy the string</font>
01008                 <font class="keywordflow">if</font> (timeval) *timeval = 0;
01009         }
01010 
01011         <font class="comment">// Copy the title string</font>
01012         <font class="keywordflow">if</font> (title &amp;&amp; titlelen) strncpy(title, buf, titlelen);
01013 
01014         <font class="comment">// Get the second line and grab the number of atoms</font>
01015         <font class="keywordflow">if</font> (<a class="code" href="Gromacs_8h.html#a61">mdio_readline</a>(mf, buf, <a class="code" href="Gromacs_8h.html#a20">MAX_GRO_LINE</a> + 1) &lt; 0) <font class="keywordflow">return</font> -1;
01016 
01017         <font class="comment">// Store the number of atoms</font>
01018         <font class="keywordflow">if</font> (natoms) <font class="keywordflow">if</font> (!(*natoms = atoi(buf)))
01019                 <font class="keywordflow">return</font> <a class="code" href="Gromacs_8h.html#a59">mdio_seterror</a>(<a class="code" href="Gromacs_8h.html#a2">MDIO_BADFORMAT</a>);
01020 
01021         <font class="comment">// Now we rewind the file so that subsequent calls to</font>
01022         <font class="comment">// gro_timestep() will succeed. gro_timestep() requires</font>
01023         <font class="comment">// the header to be at the current file pointer.</font>
01024         <font class="keywordflow">if</font> (rewind) fseek(mf-&gt;<a class="code" href="structmd__file.html#m0">f</a>, fpos, SEEK_SET);
01025 
01026         <font class="comment">// Done!</font>
01027         <font class="keywordflow">return</font> 0;
01028 }
01029 
01030 
01031 <font class="comment">// Reads one atom record from a GROMACS file. Returns GMX_SUCCESS</font>
01032 <font class="comment">// on success or a negative number on error.</font>
01033 <font class="comment">//</font>
01034 <font class="comment">// Record format (one line, fixed):</font>
01035 <font class="comment">//    rrrrrRRRRRaaaaaAAAAA &lt;x pos&gt; &lt;y pos&gt; &lt;z pos&gt; &lt;x vel&gt; &lt;y vel&gt; &lt;z vel&gt;</font>
01036 <font class="comment">//</font>
01037 <font class="comment">//    r = residue number</font>
01038 <font class="comment">//    R = residue name</font>
01039 <font class="comment">//    a = atom name</font>
01040 <font class="comment">//    A = atom number</font>
01041 <font class="comment">//</font>
<a name="l01042"></a><a class="code" href="Gromacs_8h.html#a41">01042</a> <font class="keyword">static</font> <font class="keywordtype">int</font> <a class="code" href="Gromacs_8h.html#a41">gro_rec</a>(<a class="code" href="structmd__file.html">md_file</a> *mf, <a class="code" href="structmd__atom.html">md_atom</a> *ma) {
01043         <font class="keywordtype">char</font>    buf[<a class="code" href="Gromacs_8h.html#a20">MAX_GRO_LINE</a> + 1];
01044         <font class="keywordtype">char</font>    atomnum[6];
01045         <font class="keywordtype">int</font>     n;
01046 
01047         <font class="keywordflow">if</font> (!mf) <font class="keywordflow">return</font> <a class="code" href="Gromacs_8h.html#a59">mdio_seterror</a>(<a class="code" href="Gromacs_8h.html#a4">MDIO_BADPARAMS</a>);
01048 
01049         <font class="keywordflow">do</font> {
01050                 <font class="keywordflow">if</font> (<a class="code" href="Gromacs_8h.html#a61">mdio_readline</a>(mf, buf, <a class="code" href="Gromacs_8h.html#a20">MAX_GRO_LINE</a> + 1, 0) &lt; 0) <font class="keywordflow">return</font> -1;
01051         } <font class="keywordflow">while</font> (buf[0] == <font class="charliteral">'#'</font> || !strlen(buf));
01052 
01053         <font class="comment">// Read in the fields</font>
01054         n = sscanf(buf, <font class="stringliteral">"%5c%5c%5c%5c%f %f %f"</font>, ma-&gt;<a class="code" href="structmd__atom.html#m0">resid</a>,
01055                 ma-&gt;<a class="code" href="structmd__atom.html#m1">resname</a>, ma-&gt;<a class="code" href="structmd__atom.html#m3">atomname</a>, atomnum, ma-&gt;<a class="code" href="structmd__atom.html#m4">pos</a>,
01056                 &amp;ma-&gt;<a class="code" href="structmd__atom.html#m4">pos</a>[1], &amp;ma-&gt;<a class="code" href="structmd__atom.html#m4">pos</a>[2]);
01057         <font class="keywordflow">if</font> (n != 7) <font class="keywordflow">return</font> <a class="code" href="Gromacs_8h.html#a59">mdio_seterror</a>(<a class="code" href="Gromacs_8h.html#a2">MDIO_BADFORMAT</a>);
01058 
01059         <font class="comment">// Null terminate the strings</font>
01060         ma-&gt;<a class="code" href="structmd__atom.html#m1">resname</a>[5] = 0;
01061         ma-&gt;<a class="code" href="structmd__atom.html#m3">atomname</a>[5] = 0;
01062         ma-&gt;<a class="code" href="structmd__atom.html#m0">resid</a>[5] = 0;
01063         atomnum[5] = 0;
01064 
01065         <font class="comment">// Convert strings to numbers</font>
01066         <a class="code" href="Gromacs_8h.html#a60">strip_white</a>(atomnum);
01067         ma-&gt;<a class="code" href="structmd__atom.html#m2">atomnum</a> = atoi(atomnum);
01068 
01069         <font class="comment">// Convert nanometers to angstroms</font>
01070         ma-&gt;<a class="code" href="structmd__atom.html#m4">pos</a>[0] *= <a class="code" href="Gromacs_8h.html#a24">ANGS_PER_NM</a>;
01071         ma-&gt;<a class="code" href="structmd__atom.html#m4">pos</a>[1] *= <a class="code" href="Gromacs_8h.html#a24">ANGS_PER_NM</a>;
01072         ma-&gt;<a class="code" href="structmd__atom.html#m4">pos</a>[2] *= <a class="code" href="Gromacs_8h.html#a24">ANGS_PER_NM</a>;
01073 
01074         <font class="comment">// Strip leading and trailing whitespace</font>
01075         <a class="code" href="Gromacs_8h.html#a60">strip_white</a>(ma-&gt;<a class="code" href="structmd__atom.html#m3">atomname</a>);
01076         <a class="code" href="Gromacs_8h.html#a60">strip_white</a>(ma-&gt;<a class="code" href="structmd__atom.html#m1">resname</a>);
01077         <a class="code" href="Gromacs_8h.html#a60">strip_white</a>(ma-&gt;<a class="code" href="structmd__atom.html#m0">resid</a>);
01078 
01079         <font class="keywordflow">return</font> 0;
01080 }
01081 
01082 
01083 <font class="comment">// Reads in a timestep from a .gro file. Ignores the data</font>
01084 <font class="comment">// not needed for a timestep, so is a little faster than</font>
01085 <font class="comment">// calling gro_rec() for each atom. Also reads in the</font>
01086 <font class="comment">// header block.</font>
01087 <font class="comment">//</font>
<a name="l01088"></a><a class="code" href="Gromacs_8h.html#a42">01088</a> <font class="keyword">static</font> <font class="keywordtype">int</font> <a class="code" href="Gromacs_8h.html#a42">gro_timestep</a>(<a class="code" href="structmd__file.html">md_file</a> *mf, <a class="code" href="structmd__ts.html">md_ts</a> *ts) {
01089         <font class="keywordtype">char</font> buf[<a class="code" href="Gromacs_8h.html#a20">MAX_GRO_LINE</a> + 1];
01090         <font class="keywordtype">long</font> coord;
01091         <font class="keywordtype">int</font> i, n, boxItems;
01092   <font class="keywordtype">float</font> x[3], y[3], z[3];
01093 
01094         <font class="keywordflow">if</font> (!mf || !ts) <font class="keywordflow">return</font> <a class="code" href="Gromacs_8h.html#a59">mdio_seterror</a>(<a class="code" href="Gromacs_8h.html#a4">MDIO_BADPARAMS</a>);
01095 
01096         <font class="keywordflow">if</font> (<a class="code" href="Gromacs_8h.html#a40">gro_header</a>(mf, NULL, 0, &amp;ts-&gt;<a class="code" href="structmd__ts.html#m3">time</a>, &amp;ts-&gt;<a class="code" href="structmd__ts.html#m1">natoms</a>, 0) &lt; 0)
01097                 <font class="keywordflow">return</font> -1;
01098         ts-&gt;<a class="code" href="structmd__ts.html#m0">pos</a> = (<font class="keywordtype">float</font> *) malloc(3 * <font class="keyword">sizeof</font>(<font class="keywordtype">float</font>) * ts-&gt;<a class="code" href="structmd__ts.html#m1">natoms</a>);
01099         <font class="keywordflow">if</font> (!ts-&gt;<a class="code" href="structmd__ts.html#m0">pos</a>)
01100                 <font class="keywordflow">return</font> <a class="code" href="Gromacs_8h.html#a59">mdio_seterror</a>(<a class="code" href="Gromacs_8h.html#a7">MDIO_BADMALLOC</a>);
01101 
01102         coord = 0;
01103         <font class="keywordflow">for</font> (i = 0; i &lt; ts-&gt;<a class="code" href="structmd__ts.html#m1">natoms</a>; i++) {
01104                 <font class="keywordflow">if</font> (<a class="code" href="Gromacs_8h.html#a61">mdio_readline</a>(mf, buf, <a class="code" href="Gromacs_8h.html#a20">MAX_GRO_LINE</a> + 1, 0) &lt; 0) {
01105                         free(ts-&gt;<a class="code" href="structmd__ts.html#m0">pos</a>);
01106                         <font class="keywordflow">return</font> -1;
01107                 }
01108         
01109                 n = sscanf(buf, <font class="stringliteral">"%*5c%*5c%*5c%*5c%f %f %f"</font>,
01110                         &amp;ts-&gt;<a class="code" href="structmd__ts.html#m0">pos</a>[coord], &amp;ts-&gt;<a class="code" href="structmd__ts.html#m0">pos</a>[coord + 1],
01111                         &amp;ts-&gt;<a class="code" href="structmd__ts.html#m0">pos</a>[coord + 2]);
01112 
01113                 ts-&gt;<a class="code" href="structmd__ts.html#m0">pos</a>[coord] *= <a class="code" href="Gromacs_8h.html#a24">ANGS_PER_NM</a>;
01114                 ts-&gt;<a class="code" href="structmd__ts.html#m0">pos</a>[coord + 1] *= <a class="code" href="Gromacs_8h.html#a24">ANGS_PER_NM</a>;
01115                 ts-&gt;<a class="code" href="structmd__ts.html#m0">pos</a>[coord + 2] *= <a class="code" href="Gromacs_8h.html#a24">ANGS_PER_NM</a>;
01116 
01117                 <font class="keywordflow">if</font> (n != 3) <font class="keywordflow">return</font> <a class="code" href="Gromacs_8h.html#a59">mdio_seterror</a>(<a class="code" href="Gromacs_8h.html#a2">MDIO_BADFORMAT</a>);
01118                 coord += 3;
01119         }
01120 
01121         <font class="comment">// Read the box, stored as three vectors representing its edges</font>
01122         <font class="keywordflow">if</font> (<a class="code" href="Gromacs_8h.html#a61">mdio_readline</a>(mf, buf, <a class="code" href="Gromacs_8h.html#a20">MAX_GRO_LINE</a> + 1, 0) &lt; 0) {
01123                 free(ts-&gt;<a class="code" href="structmd__ts.html#m0">pos</a>);
01124                 <font class="keywordflow">return</font> -1;
01125         }
01126   boxItems = sscanf(buf, <font class="stringliteral">" %f %f %f %f %f %f %f %f %f"</font>, 
01127              &amp;x[0], &amp;y[1], &amp;z[2], &amp;x[1], &amp;x[2], &amp;y[0], &amp;y[2], &amp;z[0], &amp;z[1]);
01128   <font class="comment">// File may only include three scalars for the box information -- if</font>
01129   <font class="comment">// that's the case, the box is orthoganal.</font>
01130   <font class="keywordflow">if</font> (boxItems == 3) {
01131     x[1] = x[2] = 0;
01132     y[0] = y[2] = 0;
01133     z[0] = z[1] = 0;
01134   }
01135   <font class="keywordflow">else</font> <font class="keywordflow">if</font> (boxItems != 9) {
01136     free(ts-&gt;<a class="code" href="structmd__ts.html#m0">pos</a>);
01137     <font class="keywordflow">return</font> -1;
01138   }
01139 
01140   <font class="comment">// Allocate the box and convert the vectors.</font>
01141   ts-&gt;<a class="code" href="structmd__ts.html#m4">box</a> = (<a class="code" href="structmd__box.html">md_box</a> *) malloc(<font class="keyword">sizeof</font>(<a class="code" href="structmd__box.html">md_box</a>));
01142   <font class="keywordflow">if</font> (<a class="code" href="Gromacs_8h.html#a63">mdio_readbox</a>(ts-&gt;<a class="code" href="structmd__ts.html#m4">box</a>, x, y, z) &lt; 0) {
01143     free(ts-&gt;<a class="code" href="structmd__ts.html#m0">pos</a>);
01144     free(ts-&gt;<a class="code" href="structmd__ts.html#m4">box</a>);
01145     ts-&gt;<a class="code" href="structmd__ts.html#m4">box</a> = NULL;
01146     <font class="keywordflow">return</font> -1;
01147   }
01148 
01149         <font class="keywordflow">return</font> 0;
01150 }
01151 
01152 
01153 <font class="comment">// Attempts to read header data from a .trX trajectory file</font>
01154 <font class="comment">//</font>
01155 <font class="comment">// The .trX header format is as follows:</font>
01156 <font class="comment">//</font>
01157 <font class="comment">//      4 bytes         - magic number (0x07C9)</font>
01158 <font class="comment">//      ...</font>
01159 <font class="comment">//</font>
<a name="l01160"></a><a class="code" href="Gromacs_8h.html#a43">01160</a> <font class="keyword">static</font> <font class="keywordtype">int</font> <a class="code" href="Gromacs_8h.html#a43">trx_header</a>(<a class="code" href="structmd__file.html">md_file</a> *mf, <font class="keywordtype">int</font> rewind) {
01161         <font class="keywordtype">int</font> magic;
01162         <a class="code" href="structtrx__hdr.html">trx_hdr</a> *hdr;
01163         <font class="keywordtype">long</font> fpos;
01164 
01165         <font class="keywordflow">if</font> (!mf) <font class="keywordflow">return</font> <a class="code" href="Gromacs_8h.html#a59">mdio_seterror</a>(<a class="code" href="Gromacs_8h.html#a4">MDIO_BADPARAMS</a>);
01166 
01167         <font class="comment">// In case we need to rewind</font>
01168         fpos = ftell(mf-&gt;<a class="code" href="structmd__file.html#m0">f</a>);
01169 
01170         <font class="comment">// We need to store some data to the trX header data</font>
01171         <font class="comment">// structure inside the md_file structure</font>
01172         hdr = mf-&gt;<a class="code" href="structmd__file.html#m4">trx</a>;
01173         <font class="keywordflow">if</font> (!mf-&gt;<a class="code" href="structmd__file.html#m4">trx</a>) <font class="keywordflow">return</font> <a class="code" href="Gromacs_8h.html#a59">mdio_seterror</a>(<a class="code" href="Gromacs_8h.html#a4">MDIO_BADPARAMS</a>);
01174 
01175         <font class="comment">// Read the magic number</font>
01176         <font class="keywordflow">if</font> (<a class="code" href="Gromacs_8h.html#a44">trx_int</a>(mf, &amp;magic) &lt; 0) <font class="keywordflow">return</font> -1;
01177         <font class="keywordflow">if</font> (magic != <a class="code" href="Gromacs_8h.html#a18">TRX_MAGIC</a>) {
01178                 <font class="comment">// Try reverse endianism</font>
01179                 <a class="code" href="endianswap_8h.html#a4">swap4_aligned</a>(&amp;magic, 1);
01180                 <font class="keywordflow">if</font> (magic != <a class="code" href="Gromacs_8h.html#a18">TRX_MAGIC</a>) <font class="keywordflow">return</font> <a class="code" href="Gromacs_8h.html#a59">mdio_seterror</a>(<a class="code" href="Gromacs_8h.html#a2">MDIO_BADFORMAT</a>);
01181 
01182                 <font class="comment">// Enable byte swapping (actually works, too!)</font>
01183                 mf-&gt;<a class="code" href="structmd__file.html#m3">rev</a> = 1;
01184         }
01185 
01186         <font class="comment">// Read the version number. </font>
01187         <font class="comment">// XXX. this is not the version number, but the storage size</font>
01188         <font class="comment">// of the following XDR encoded string.</font>
01189         <font class="comment">// the 'title' string is in fact the version identifier.</font>
01190         <font class="comment">// since VMD does not use any of that, it does no harm,</font>
01191         <font class="comment">// but is should still be fixed occasionally. AK 2005/01/08.</font>
01192         <font class="keywordflow">if</font> (<a class="code" href="Gromacs_8h.html#a44">trx_int</a>(mf, &amp;hdr-&gt;<a class="code" href="structtrx__hdr.html#m0">version</a>) &lt; 0) <font class="keywordflow">return</font> -1;
01193 
01194         <font class="comment">// Read in the title string</font>
01195         <font class="keywordflow">if</font> (<a class="code" href="Gromacs_8h.html#a47">trx_string</a>(mf, hdr-&gt;<a class="code" href="structtrx__hdr.html#m1">title</a>, <a class="code" href="Gromacs_8h.html#a22">MAX_TRX_TITLE</a>) &lt; 0)
01196                 <font class="keywordflow">return</font> -1;
01197 
01198         <font class="comment">// Read in some size data</font>
01199         <font class="keywordflow">if</font> (<a class="code" href="Gromacs_8h.html#a44">trx_int</a>(mf, &amp;hdr-&gt;<a class="code" href="structtrx__hdr.html#m2">ir_size</a>) &lt; 0) <font class="keywordflow">return</font> -1;
01200         <font class="keywordflow">if</font> (<a class="code" href="Gromacs_8h.html#a44">trx_int</a>(mf, &amp;hdr-&gt;<a class="code" href="structtrx__hdr.html#m3">e_size</a>) &lt; 0) <font class="keywordflow">return</font> -1;
01201         <font class="keywordflow">if</font> (<a class="code" href="Gromacs_8h.html#a44">trx_int</a>(mf, &amp;hdr-&gt;<a class="code" href="structtrx__hdr.html#m4">box_size</a>) &lt; 0) <font class="keywordflow">return</font> -1;
01202         <font class="keywordflow">if</font> (<a class="code" href="Gromacs_8h.html#a44">trx_int</a>(mf, &amp;hdr-&gt;<a class="code" href="structtrx__hdr.html#m5">vir_size</a>) &lt; 0) <font class="keywordflow">return</font> -1;
01203         <font class="keywordflow">if</font> (<a class="code" href="Gromacs_8h.html#a44">trx_int</a>(mf, &amp;hdr-&gt;<a class="code" href="structtrx__hdr.html#m6">pres_size</a>) &lt; 0) <font class="keywordflow">return</font> -1;
01204         <font class="keywordflow">if</font> (<a class="code" href="Gromacs_8h.html#a44">trx_int</a>(mf, &amp;hdr-&gt;<a class="code" href="structtrx__hdr.html#m7">top_size</a>) &lt; 0) <font class="keywordflow">return</font> -1;
01205         <font class="keywordflow">if</font> (<a class="code" href="Gromacs_8h.html#a44">trx_int</a>(mf, &amp;hdr-&gt;<a class="code" href="structtrx__hdr.html#m8">sym_size</a>) &lt; 0) <font class="keywordflow">return</font> -1;
01206         <font class="keywordflow">if</font> (<a class="code" href="Gromacs_8h.html#a44">trx_int</a>(mf, &amp;hdr-&gt;<a class="code" href="structtrx__hdr.html#m9">x_size</a>) &lt; 0) <font class="keywordflow">return</font> -1;
01207         <font class="keywordflow">if</font> (<a class="code" href="Gromacs_8h.html#a44">trx_int</a>(mf, &amp;hdr-&gt;<a class="code" href="structtrx__hdr.html#m10">v_size</a>) &lt; 0) <font class="keywordflow">return</font> -1;
01208         <font class="keywordflow">if</font> (<a class="code" href="Gromacs_8h.html#a44">trx_int</a>(mf, &amp;hdr-&gt;<a class="code" href="structtrx__hdr.html#m11">f_size</a>) &lt; 0) <font class="keywordflow">return</font> -1;
01209         <font class="keywordflow">if</font> (<a class="code" href="Gromacs_8h.html#a44">trx_int</a>(mf, &amp;hdr-&gt;<a class="code" href="structtrx__hdr.html#m12">natoms</a>) &lt; 0) <font class="keywordflow">return</font> -1;
01210         <font class="keywordflow">if</font> (<a class="code" href="Gromacs_8h.html#a44">trx_int</a>(mf, &amp;hdr-&gt;<a class="code" href="structtrx__hdr.html#m13">step</a>) &lt; 0) <font class="keywordflow">return</font> -1;
01211         <font class="keywordflow">if</font> (<a class="code" href="Gromacs_8h.html#a44">trx_int</a>(mf, &amp;hdr-&gt;<a class="code" href="structtrx__hdr.html#m14">nre</a>) &lt; 0) <font class="keywordflow">return</font> -1;
01212 
01213         <font class="comment">// Make sure there are atoms...</font>
01214         <font class="keywordflow">if</font> (!hdr-&gt;<a class="code" href="structtrx__hdr.html#m12">natoms</a>) <font class="keywordflow">return</font> <a class="code" href="Gromacs_8h.html#a59">mdio_seterror</a>(<a class="code" href="Gromacs_8h.html#a2">MDIO_BADFORMAT</a>);
01215 
01216         <font class="comment">// Try to determine precision (float? double?)</font>
01217         <font class="keywordflow">if</font> (hdr-&gt;<a class="code" href="structtrx__hdr.html#m9">x_size</a>) mf-&gt;<a class="code" href="structmd__file.html#m2">prec</a> = hdr-&gt;<a class="code" href="structtrx__hdr.html#m9">x_size</a> / (hdr-&gt;<a class="code" href="structtrx__hdr.html#m12">natoms</a> * 3);
01218         <font class="keywordflow">else</font> <font class="keywordflow">if</font> (hdr-&gt;<a class="code" href="structtrx__hdr.html#m10">v_size</a>) mf-&gt;<a class="code" href="structmd__file.html#m2">prec</a> = hdr-&gt;<a class="code" href="structtrx__hdr.html#m10">v_size</a> / (hdr-&gt;<a class="code" href="structtrx__hdr.html#m12">natoms</a> * 3);
01219         <font class="keywordflow">else</font> <font class="keywordflow">if</font> (hdr-&gt;<a class="code" href="structtrx__hdr.html#m11">f_size</a>) mf-&gt;<a class="code" href="structmd__file.html#m2">prec</a> = hdr-&gt;<a class="code" href="structtrx__hdr.html#m11">f_size</a> / (hdr-&gt;<a class="code" href="structtrx__hdr.html#m12">natoms</a> * 3);
01220         <font class="keywordflow">else</font> <font class="keywordflow">return</font> <a class="code" href="Gromacs_8h.html#a59">mdio_seterror</a>(<a class="code" href="Gromacs_8h.html#a6">MDIO_BADPRECISION</a>);
01221 
01222         <font class="keywordflow">if</font> (mf-&gt;<a class="code" href="structmd__file.html#m2">prec</a> != <font class="keyword">sizeof</font>(float) &amp;&amp; mf-&gt;<a class="code" href="structmd__file.html#m2">prec</a> != <font class="keyword">sizeof</font>(double)) {
01223                 <font class="comment">// We have no data types this size! The</font>
01224                 <font class="comment">// file must've been generated on another</font>
01225                 <font class="comment">// platform</font>
01226                 <font class="keywordflow">return</font> <a class="code" href="Gromacs_8h.html#a59">mdio_seterror</a>(<a class="code" href="Gromacs_8h.html#a6">MDIO_BADPRECISION</a>);
01227         }
01228 
01229         <font class="comment">// Read in timestep and lambda</font>
01230         <font class="keywordflow">if</font> (<a class="code" href="Gromacs_8h.html#a45">trx_real</a>(mf, &amp;hdr-&gt;<a class="code" href="structtrx__hdr.html#m15">t</a>) &lt; 0) <font class="keywordflow">return</font> -1;
01231         <font class="keywordflow">if</font> (<a class="code" href="Gromacs_8h.html#a45">trx_real</a>(mf, &amp;hdr-&gt;<a class="code" href="structtrx__hdr.html#m16">lambda</a>) &lt; 0) <font class="keywordflow">return</font> -1;
01232 
01233         <font class="comment">// Rewind if necessary</font>
01234         <font class="keywordflow">if</font> (rewind) fseek(mf-&gt;<a class="code" href="structmd__file.html#m0">f</a>, fpos, SEEK_SET);
01235 
01236         <font class="keywordflow">return</font> 0;
01237 }
01238 
01239 
01240 <font class="comment">// Reads in an integer and stores it in y. Returns GMX_SUCCESS</font>
01241 <font class="comment">// on success or a negative number on error.</font>
<a name="l01242"></a><a class="code" href="Gromacs_8h.html#a44">01242</a> <font class="keyword">static</font> <font class="keywordtype">int</font> <a class="code" href="Gromacs_8h.html#a44">trx_int</a>(<a class="code" href="structmd__file.html">md_file</a> *mf, <font class="keywordtype">int</font> *y) {
01243         <font class="keywordflow">if</font> (!mf) <font class="keywordflow">return</font> <a class="code" href="Gromacs_8h.html#a59">mdio_seterror</a>(<a class="code" href="Gromacs_8h.html#a4">MDIO_BADPARAMS</a>);
01244 
01245         <font class="comment">// sanity check.</font>
01246         <font class="keywordflow">if</font> (<font class="keyword">sizeof</font>(int) != 4) <font class="keywordflow">return</font> <a class="code" href="Gromacs_8h.html#a59">mdio_seterror</a>(<a class="code" href="Gromacs_8h.html#a13">MDIO_SIZEERROR</a>);
01247 
01248         <font class="keywordflow">if</font> (y) {
01249                 <font class="keywordflow">if</font> (fread(y, 4, 1, mf-&gt;<a class="code" href="structmd__file.html#m0">f</a>) != 1)
01250                         <font class="keywordflow">return</font> <a class="code" href="Gromacs_8h.html#a59">mdio_seterror</a>(<a class="code" href="Gromacs_8h.html#a5">MDIO_IOERROR</a>);
01251                 <font class="keywordflow">if</font> (mf-&gt;<a class="code" href="structmd__file.html#m3">rev</a>) <a class="code" href="endianswap_8h.html#a4">swap4_aligned</a>(y, 1);
01252         }
01253         <font class="keywordflow">else</font> <font class="keywordflow">if</font> (fseek(mf-&gt;<a class="code" href="structmd__file.html#m0">f</a>, 4, SEEK_CUR) != 0)
01254                 <font class="keywordflow">return</font> <a class="code" href="Gromacs_8h.html#a59">mdio_seterror</a>(<a class="code" href="Gromacs_8h.html#a5">MDIO_IOERROR</a>);
01255 
01256         <font class="keywordflow">return</font> <a class="code" href="Gromacs_8h.html#a59">mdio_seterror</a>(<a class="code" href="Gromacs_8h.html#a1">MDIO_SUCCESS</a>);
01257 }
01258 
01259 
01260 <font class="comment">// Reads in either a float or a double, depending on the</font>
01261 <font class="comment">// precision, and stores that number in y. Returns</font>
01262 <font class="comment">// GMX_SUCCESS on success or a negative number on error.</font>
<a name="l01263"></a><a class="code" href="Gromacs_8h.html#a45">01263</a> <font class="keyword">static</font> <font class="keywordtype">int</font> <a class="code" href="Gromacs_8h.html#a45">trx_real</a>(<a class="code" href="structmd__file.html">md_file</a> *mf, <font class="keywordtype">float</font> *y) {
01264         <font class="keywordtype">double</font> x;
01265 
01266         <font class="keywordflow">if</font> (!mf) <font class="keywordflow">return</font> <a class="code" href="Gromacs_8h.html#a59">mdio_seterror</a>(<a class="code" href="Gromacs_8h.html#a4">MDIO_BADPARAMS</a>);
01267 
01268         <font class="keywordflow">switch</font> (mf-&gt;<a class="code" href="structmd__file.html#m2">prec</a>) {
01269                 <font class="keywordflow">case</font> <font class="keyword">sizeof</font>(float):
01270                         <font class="keywordflow">if</font> (!y) {
01271                                 <font class="keywordflow">if</font> (fseek(mf-&gt;<a class="code" href="structmd__file.html#m0">f</a>, mf-&gt;<a class="code" href="structmd__file.html#m2">prec</a>, SEEK_CUR) != 0)
01272                                         <font class="keywordflow">return</font> <a class="code" href="Gromacs_8h.html#a59">mdio_seterror</a>(<a class="code" href="Gromacs_8h.html#a5">MDIO_IOERROR</a>);
01273                         } <font class="keywordflow">else</font> {
01274                                 <font class="keywordflow">if</font> (fread(y, mf-&gt;<a class="code" href="structmd__file.html#m2">prec</a>, 1, mf-&gt;<a class="code" href="structmd__file.html#m0">f</a>) != 1)
01275                                         <font class="keywordflow">return</font> <a class="code" href="Gromacs_8h.html#a59">mdio_seterror</a>(<a class="code" href="Gromacs_8h.html#a5">MDIO_IOERROR</a>);
01276                                 <font class="keywordflow">if</font> (mf-&gt;<a class="code" href="structmd__file.html#m3">rev</a>) <a class="code" href="endianswap_8h.html#a4">swap4_aligned</a>(y, 1);
01277                         }
01278                         <font class="keywordflow">return</font> <a class="code" href="Gromacs_8h.html#a59">mdio_seterror</a>(<a class="code" href="Gromacs_8h.html#a1">MDIO_SUCCESS</a>);
01279 
01280                 <font class="keywordflow">case</font> <font class="keyword">sizeof</font>(double):
01281                         <font class="keywordflow">if</font> (!y) {
01282                                 <font class="keywordflow">if</font> (fseek(mf-&gt;<a class="code" href="structmd__file.html#m0">f</a>, mf-&gt;<a class="code" href="structmd__file.html#m2">prec</a>, SEEK_CUR) != 0)
01283                                         <font class="keywordflow">return</font> <a class="code" href="Gromacs_8h.html#a59">mdio_seterror</a>(<a class="code" href="Gromacs_8h.html#a5">MDIO_IOERROR</a>);
01284                         } <font class="keywordflow">else</font> {
01285                                 <font class="keywordflow">if</font> (fread(&amp;x, mf-&gt;<a class="code" href="structmd__file.html#m2">prec</a>, 1, mf-&gt;<a class="code" href="structmd__file.html#m0">f</a>) != 1)
01286                                         <font class="keywordflow">return</font> <a class="code" href="Gromacs_8h.html#a59">mdio_seterror</a>(<a class="code" href="Gromacs_8h.html#a5">MDIO_IOERROR</a>);
01287                                 <font class="keywordflow">if</font> (mf-&gt;<a class="code" href="structmd__file.html#m3">rev</a>) <a class="code" href="endianswap_8h.html#a5">swap8_aligned</a>(&amp;x, 1);
01288                                 *y = (float) x;
01289                         }
01290                         <font class="keywordflow">return</font> <a class="code" href="Gromacs_8h.html#a59">mdio_seterror</a>(<a class="code" href="Gromacs_8h.html#a1">MDIO_SUCCESS</a>);
01291 
01292                 <font class="keywordflow">default</font>:
01293                         <font class="keywordflow">return</font> <a class="code" href="Gromacs_8h.html#a59">mdio_seterror</a>(<a class="code" href="Gromacs_8h.html#a6">MDIO_BADPRECISION</a>);
01294         }
01295 
01296 }
01297 
01298 
01299 <font class="comment">// Reads in a real-valued vector (taking precision into account).</font>
01300 <font class="comment">// Stores the vector in vec, and returns GMX_SUCCESS on success</font>
01301 <font class="comment">// or a negative number on error.</font>
<a name="l01302"></a><a class="code" href="Gromacs_8h.html#a46">01302</a> <font class="keyword">static</font> <font class="keywordtype">int</font> <a class="code" href="Gromacs_8h.html#a46">trx_rvector</a>(<a class="code" href="structmd__file.html">md_file</a> *mf, <font class="keywordtype">float</font> *vec) {
01303         <font class="keywordflow">if</font> (!mf) <font class="keywordflow">return</font> <a class="code" href="Gromacs_8h.html#a59">mdio_seterror</a>(<a class="code" href="Gromacs_8h.html#a4">MDIO_BADPARAMS</a>);
01304 
01305         <font class="keywordflow">if</font> (!vec) {
01306                 <font class="keywordflow">if</font> (<a class="code" href="Gromacs_8h.html#a45">trx_real</a>(mf, NULL) &lt; 0) <font class="keywordflow">return</font> -1;
01307                 <font class="keywordflow">if</font> (<a class="code" href="Gromacs_8h.html#a45">trx_real</a>(mf, NULL) &lt; 0) <font class="keywordflow">return</font> -1;
01308                 <font class="keywordflow">if</font> (<a class="code" href="Gromacs_8h.html#a45">trx_real</a>(mf, NULL) &lt; 0) <font class="keywordflow">return</font> -1;
01309                 <font class="keywordflow">return</font> <a class="code" href="Gromacs_8h.html#a59">mdio_seterror</a>(<a class="code" href="Gromacs_8h.html#a1">MDIO_SUCCESS</a>);
01310         } <font class="keywordflow">else</font> {
01311                 <font class="keywordflow">if</font> (<a class="code" href="Gromacs_8h.html#a45">trx_real</a>(mf, &amp;vec[0]) &lt; 0) <font class="keywordflow">return</font> -1;
01312                 <font class="keywordflow">if</font> (<a class="code" href="Gromacs_8h.html#a45">trx_real</a>(mf, &amp;vec[1]) &lt; 0) <font class="keywordflow">return</font> -1;
01313                 <font class="keywordflow">if</font> (<a class="code" href="Gromacs_8h.html#a45">trx_real</a>(mf, &amp;vec[2]) &lt; 0) <font class="keywordflow">return</font> -1;
01314                 <font class="keywordflow">return</font> <a class="code" href="Gromacs_8h.html#a59">mdio_seterror</a>(<a class="code" href="Gromacs_8h.html#a1">MDIO_SUCCESS</a>);
01315         }
01316 }
01317 
01318 
01319 <font class="comment">// Reads in a string by first reading an integer containing the</font>
01320 <font class="comment">// string's length, then reading in the string itself and storing</font>
01321 <font class="comment">// it in str. If the length is greater than max, it is truncated</font>
01322 <font class="comment">// and the rest of the string is skipped in the file. Returns the</font>
01323 <font class="comment">// length of the string on success or a negative number on error.</font>
<a name="l01324"></a><a class="code" href="Gromacs_8h.html#a47">01324</a> <font class="keyword">static</font> <font class="keywordtype">int</font> <a class="code" href="Gromacs_8h.html#a47">trx_string</a>(<a class="code" href="structmd__file.html">md_file</a> *mf, <font class="keywordtype">char</font> *str, <font class="keywordtype">int</font> max) {
01325         <font class="keywordtype">int</font> size;
01326   size_t ssize;
01327 
01328         <font class="keywordflow">if</font> (!mf) <font class="keywordflow">return</font> <a class="code" href="Gromacs_8h.html#a59">mdio_seterror</a>(<a class="code" href="Gromacs_8h.html#a4">MDIO_BADPARAMS</a>);
01329 
01330         <font class="keywordflow">if</font> (<a class="code" href="Gromacs_8h.html#a44">trx_int</a>(mf, &amp;size) &lt; 0) <font class="keywordflow">return</font> -1;
01331   ssize = (size_t)size;
01332 
01333         <font class="keywordflow">if</font> (str &amp;&amp; size &lt;= max) {
01334                 <font class="keywordflow">if</font> (fread(str, 1, size, mf-&gt;<a class="code" href="structmd__file.html#m0">f</a>) != ssize)
01335                         <font class="keywordflow">return</font> <a class="code" href="Gromacs_8h.html#a59">mdio_seterror</a>(<a class="code" href="Gromacs_8h.html#a5">MDIO_IOERROR</a>);
01336                 str[size] = 0;
01337                 <font class="keywordflow">return</font> size;
01338         } <font class="keywordflow">else</font> <font class="keywordflow">if</font> (str) {
01339                 <font class="keywordflow">if</font> (fread(str, 1, max, mf-&gt;<a class="code" href="structmd__file.html#m0">f</a>) != ssize)
01340                         <font class="keywordflow">return</font> <a class="code" href="Gromacs_8h.html#a59">mdio_seterror</a>(<a class="code" href="Gromacs_8h.html#a5">MDIO_IOERROR</a>);
01341                 <font class="keywordflow">if</font> (fseek(mf-&gt;<a class="code" href="structmd__file.html#m0">f</a>, size - max, SEEK_CUR) != 0)
01342                         <font class="keywordflow">return</font> <a class="code" href="Gromacs_8h.html#a59">mdio_seterror</a>(<a class="code" href="Gromacs_8h.html#a5">MDIO_IOERROR</a>);
01343                 str[max] = 0;
01344                 <font class="keywordflow">return</font> max;
01345         } <font class="keywordflow">else</font> {
01346                 <font class="keywordflow">if</font> (fseek(mf-&gt;<a class="code" href="structmd__file.html#m0">f</a>, size, SEEK_CUR) != 0)
01347                         <font class="keywordflow">return</font> <a class="code" href="Gromacs_8h.html#a59">mdio_seterror</a>(<a class="code" href="Gromacs_8h.html#a5">MDIO_IOERROR</a>);
01348                 <font class="keywordflow">return</font> 0;
01349         }
01350 }
01351 
01352 
01353 <font class="comment">// Reads in a timestep frame from the .trX file and returns the</font>
01354 <font class="comment">// data in a timestep structure. Returns NULL on error.</font>
<a name="l01355"></a><a class="code" href="Gromacs_8h.html#a48">01355</a> <font class="keyword">static</font> <font class="keywordtype">int</font> <a class="code" href="Gromacs_8h.html#a48">trx_timestep</a>(<a class="code" href="structmd__file.html">md_file</a> *mf, <a class="code" href="structmd__ts.html">md_ts</a> *ts) {
01356         <font class="keywordtype">int</font> i;
01357   <font class="keywordtype">float</font> x[3], y[3], z[3];
01358         <a class="code" href="structtrx__hdr.html">trx_hdr</a> *hdr;
01359 
01360         <font class="keywordflow">if</font> (!mf || !ts) <font class="keywordflow">return</font> <a class="code" href="Gromacs_8h.html#a59">mdio_seterror</a>(<a class="code" href="Gromacs_8h.html#a4">MDIO_BADPARAMS</a>);
01361         <font class="keywordflow">if</font> (mf-&gt;<a class="code" href="structmd__file.html#m1">fmt</a> != <a class="code" href="Gromacs_8h.html#a28">MDFMT_TRJ</a> &amp;&amp; mf-&gt;<a class="code" href="structmd__file.html#m1">fmt</a> != <a class="code" href="Gromacs_8h.html#a26">MDFMT_TRR</a>)
01362                 <font class="keywordflow">return</font> <a class="code" href="Gromacs_8h.html#a59">mdio_seterror</a>(<a class="code" href="Gromacs_8h.html#a12">MDIO_WRONGFORMAT</a>);
01363 
01364         <font class="comment">// Read the header</font>
01365         <font class="keywordflow">if</font> (<a class="code" href="Gromacs_8h.html#a43">trx_header</a>(mf) &lt; 0) <font class="keywordflow">return</font> -1;
01366 
01367         <font class="comment">// We need some data from the trX header</font>
01368         hdr = mf-&gt;<a class="code" href="structmd__file.html#m4">trx</a>;
01369         <font class="keywordflow">if</font> (!hdr) <font class="keywordflow">return</font> <a class="code" href="Gromacs_8h.html#a59">mdio_seterror</a>(<a class="code" href="Gromacs_8h.html#a4">MDIO_BADPARAMS</a>);
01370 
01371         <font class="keywordflow">if</font> (hdr-&gt;<a class="code" href="structtrx__hdr.html#m4">box_size</a>) { <font class="comment">// XXX need to check value of box_size!!</font>
01372                 <font class="keywordflow">if</font> (<a class="code" href="Gromacs_8h.html#a46">trx_rvector</a>(mf, x) &lt; 0) <font class="keywordflow">return</font> -1;
01373                 <font class="keywordflow">if</font> (<a class="code" href="Gromacs_8h.html#a46">trx_rvector</a>(mf, y) &lt; 0) <font class="keywordflow">return</font> -1;
01374                 <font class="keywordflow">if</font> (<a class="code" href="Gromacs_8h.html#a46">trx_rvector</a>(mf, z) &lt; 0) <font class="keywordflow">return</font> -1;
01375     <font class="comment">// Allocate the box and convert the vectors.</font>
01376     ts-&gt;<a class="code" href="structmd__ts.html#m4">box</a> = (<a class="code" href="structmd__box.html">md_box</a> *) malloc(<font class="keyword">sizeof</font>(<a class="code" href="structmd__box.html">md_box</a>));
01377     <font class="keywordflow">if</font> (<a class="code" href="Gromacs_8h.html#a63">mdio_readbox</a>(ts-&gt;<a class="code" href="structmd__ts.html#m4">box</a>, x, y, z) &lt; 0) {
01378       free(ts-&gt;<a class="code" href="structmd__ts.html#m4">box</a>);
01379       ts-&gt;<a class="code" href="structmd__ts.html#m4">box</a> = NULL;
01380       <font class="keywordflow">return</font> -1;
01381     }
01382         }
01383 
01384         <font class="keywordflow">if</font> (hdr-&gt;<a class="code" href="structtrx__hdr.html#m5">vir_size</a>) {
01385                 <font class="keywordflow">if</font> (<a class="code" href="Gromacs_8h.html#a46">trx_rvector</a>(mf, NULL) &lt; 0) <font class="keywordflow">return</font> -1;
01386                 <font class="keywordflow">if</font> (<a class="code" href="Gromacs_8h.html#a46">trx_rvector</a>(mf, NULL) &lt; 0) <font class="keywordflow">return</font> -1;
01387                 <font class="keywordflow">if</font> (<a class="code" href="Gromacs_8h.html#a46">trx_rvector</a>(mf, NULL) &lt; 0) <font class="keywordflow">return</font> -1;
01388         }
01389 
01390         <font class="keywordflow">if</font> (hdr-&gt;<a class="code" href="structtrx__hdr.html#m6">pres_size</a>) {
01391                 <font class="keywordflow">if</font> (<a class="code" href="Gromacs_8h.html#a46">trx_rvector</a>(mf, NULL) &lt; 0) <font class="keywordflow">return</font> -1;
01392                 <font class="keywordflow">if</font> (<a class="code" href="Gromacs_8h.html#a46">trx_rvector</a>(mf, NULL) &lt; 0) <font class="keywordflow">return</font> -1;
01393                 <font class="keywordflow">if</font> (<a class="code" href="Gromacs_8h.html#a46">trx_rvector</a>(mf, NULL) &lt; 0) <font class="keywordflow">return</font> -1;
01394         }
01395 
01396         <font class="keywordflow">if</font> (hdr-&gt;<a class="code" href="structtrx__hdr.html#m9">x_size</a>) {
01397                 ts-&gt;<a class="code" href="structmd__ts.html#m0">pos</a> = (<font class="keywordtype">float</font> *) malloc(<font class="keyword">sizeof</font>(<font class="keywordtype">float</font>) * 3 * hdr-&gt;<a class="code" href="structtrx__hdr.html#m12">natoms</a>);
01398                 <font class="keywordflow">if</font> (!ts-&gt;<a class="code" href="structmd__ts.html#m0">pos</a>) <font class="keywordflow">return</font> <a class="code" href="Gromacs_8h.html#a59">mdio_seterror</a>(<a class="code" href="Gromacs_8h.html#a7">MDIO_BADMALLOC</a>);
01399 
01400                 ts-&gt;<a class="code" href="structmd__ts.html#m1">natoms</a> = hdr-&gt;<a class="code" href="structtrx__hdr.html#m12">natoms</a>;
01401 
01402                 <font class="keywordflow">for</font> (i = 0; i &lt; hdr-&gt;<a class="code" href="structtrx__hdr.html#m12">natoms</a>; i++) {
01403                         <font class="keywordflow">if</font> (<a class="code" href="Gromacs_8h.html#a46">trx_rvector</a>(mf, &amp;ts-&gt;<a class="code" href="structmd__ts.html#m0">pos</a>[i * 3]) &lt; 0) {
01404                                 <a class="code" href="Gromacs_8h.html#a62">mdio_tsfree</a>(ts, 1);
01405                                 <font class="keywordflow">return</font> -1;
01406                         }
01407                         ts-&gt;<a class="code" href="structmd__ts.html#m0">pos</a>[i * 3] *= <a class="code" href="Gromacs_8h.html#a24">ANGS_PER_NM</a>;
01408                         ts-&gt;<a class="code" href="structmd__ts.html#m0">pos</a>[i * 3 + 1] *= <a class="code" href="Gromacs_8h.html#a24">ANGS_PER_NM</a>;
01409                         ts-&gt;<a class="code" href="structmd__ts.html#m0">pos</a>[i * 3 + 2] *= <a class="code" href="Gromacs_8h.html#a24">ANGS_PER_NM</a>;
01410                 }
01411         }
01412 
01413         <font class="keywordflow">if</font> (hdr-&gt;<a class="code" href="structtrx__hdr.html#m10">v_size</a>) {
01414                 <font class="keywordflow">for</font> (i = 0; i &lt; hdr-&gt;<a class="code" href="structtrx__hdr.html#m12">natoms</a>; i++) {
01415                         <font class="keywordflow">if</font> (<a class="code" href="Gromacs_8h.html#a46">trx_rvector</a>(mf, NULL) &lt; 0) {
01416                                 <a class="code" href="Gromacs_8h.html#a62">mdio_tsfree</a>(ts, 1);
01417                                 <font class="keywordflow">return</font> -1;
01418                         }
01419                 }
01420         }
01421 
01422         <font class="keywordflow">if</font> (hdr-&gt;<a class="code" href="structtrx__hdr.html#m11">f_size</a>) {
01423                 <font class="keywordflow">for</font> (i = 0; i &lt; hdr-&gt;<a class="code" href="structtrx__hdr.html#m12">natoms</a>; i++) {
01424                         <font class="keywordflow">if</font> (<a class="code" href="Gromacs_8h.html#a46">trx_rvector</a>(mf, NULL) &lt; 0) {
01425                                 <a class="code" href="Gromacs_8h.html#a62">mdio_tsfree</a>(ts, 1);
01426                                 <font class="keywordflow">return</font> -1;
01427                         }
01428                 }
01429         }
01430 
01431         <font class="keywordflow">return</font> <a class="code" href="Gromacs_8h.html#a59">mdio_seterror</a>(<a class="code" href="Gromacs_8h.html#a1">MDIO_SUCCESS</a>);
01432 }
01433 
01434 
01435 <font class="comment">// writes an int in big endian. Returns GMX_SUCCESS</font>
01436 <font class="comment">// on success or a negative number on error.</font>
<a name="l01437"></a><a class="code" href="Gromacs_8h.html#a66">01437</a> <font class="keyword">static</font> <font class="keywordtype">int</font> <a class="code" href="Gromacs_8h.html#a66">put_trx_int</a>(<a class="code" href="structmd__file.html">md_file</a> *mf, <font class="keywordtype">int</font> y) {
01438       <font class="keywordflow">if</font> (!mf) <font class="keywordflow">return</font> <a class="code" href="Gromacs_8h.html#a59">mdio_seterror</a>(<a class="code" href="Gromacs_8h.html#a4">MDIO_BADPARAMS</a>);
01439 
01440       <font class="comment">// sanity check.</font>
01441       <font class="keywordflow">if</font> (<font class="keyword">sizeof</font>(int) != 4) <font class="keywordflow">return</font> <a class="code" href="Gromacs_8h.html#a59">mdio_seterror</a>(<a class="code" href="Gromacs_8h.html#a13">MDIO_SIZEERROR</a>);
01442 
01443       <font class="keywordflow">if</font> (mf-&gt;<a class="code" href="structmd__file.html#m3">rev</a>) <a class="code" href="endianswap_8h.html#a4">swap4_aligned</a>(&amp;y, 1);
01444       <font class="keywordflow">if</font> (fwrite(&amp;y, 4, 1, mf-&gt;<a class="code" href="structmd__file.html#m0">f</a>) != 1)
01445     <font class="keywordflow">return</font> <a class="code" href="Gromacs_8h.html#a59">mdio_seterror</a>(<a class="code" href="Gromacs_8h.html#a5">MDIO_IOERROR</a>);
01446 
01447   <font class="keywordflow">return</font> <a class="code" href="Gromacs_8h.html#a59">mdio_seterror</a>(<a class="code" href="Gromacs_8h.html#a1">MDIO_SUCCESS</a>);
01448 }
01449 
01450 <font class="comment">// writes a real in big-endian. Returns GMX_SUCCESS</font>
01451 <font class="comment">// on success or a negative number on error.</font>
<a name="l01452"></a><a class="code" href="Gromacs_8h.html#a67">01452</a> <font class="keyword">static</font> <font class="keywordtype">int</font> <a class="code" href="Gromacs_8h.html#a67">put_trx_real</a>(<a class="code" href="structmd__file.html">md_file</a> *mf, <font class="keywordtype">float</font> y) {
01453       <font class="keywordflow">if</font> (!mf) <font class="keywordflow">return</font> <a class="code" href="Gromacs_8h.html#a59">mdio_seterror</a>(<a class="code" href="Gromacs_8h.html#a4">MDIO_BADPARAMS</a>);
01454 
01455       <font class="keywordflow">if</font> (mf-&gt;<a class="code" href="structmd__file.html#m3">rev</a>) <a class="code" href="endianswap_8h.html#a4">swap4_aligned</a>(&amp;y, 1);
01456       <font class="keywordflow">if</font> (fwrite(&amp;y, 4, 1, mf-&gt;<a class="code" href="structmd__file.html#m0">f</a>) != 1)
01457         <font class="keywordflow">return</font> <a class="code" href="Gromacs_8h.html#a59">mdio_seterror</a>(<a class="code" href="Gromacs_8h.html#a5">MDIO_IOERROR</a>);
01458 
01459       <font class="keywordflow">return</font> <a class="code" href="Gromacs_8h.html#a59">mdio_seterror</a>(<a class="code" href="Gromacs_8h.html#a1">MDIO_SUCCESS</a>);
01460 }
01461 
01462 
01463 <font class="comment">// writes an xdr encoded string. Returns GMX_SUCCESS</font>
01464 <font class="comment">// on success or a negative number on error.</font>
<a name="l01465"></a><a class="code" href="Gromacs_8h.html#a68">01465</a> <font class="keyword">static</font> <font class="keywordtype">int</font> <a class="code" href="Gromacs_8h.html#a68">put_trx_string</a>(<a class="code" href="structmd__file.html">md_file</a> *mf, <font class="keyword">const</font> <font class="keywordtype">char</font> *s) {
01466         <font class="keywordflow">if</font> (!mf || !s) <font class="keywordflow">return</font> <a class="code" href="Gromacs_8h.html#a59">mdio_seterror</a>(<a class="code" href="Gromacs_8h.html#a4">MDIO_BADPARAMS</a>);
01467         
01468         <font class="comment">// write: size of object, string length, string data</font>
01469         size_t len = strlen(s);
01470         <font class="keywordflow">if</font> ( <a class="code" href="Gromacs_8h.html#a66">put_trx_int</a>(mf, len+1)
01471              || <a class="code" href="Gromacs_8h.html#a66">put_trx_int</a>(mf, len)
01472              || (fwrite(s, len, 1, mf-&gt;<a class="code" href="structmd__file.html#m0">f</a>) != 1))
01473           <font class="keywordflow">return</font> <a class="code" href="Gromacs_8h.html#a59">mdio_seterror</a>(<a class="code" href="Gromacs_8h.html#a5">MDIO_IOERROR</a>);
01474 
01475         <font class="keywordflow">return</font> <a class="code" href="Gromacs_8h.html#a59">mdio_seterror</a>(<a class="code" href="Gromacs_8h.html#a1">MDIO_SUCCESS</a>);
01476 }
01477 
01478 
01479 <font class="comment">// xtc_int() - reads an integer from an xtc file</font>
<a name="l01480"></a><a class="code" href="Gromacs_8h.html#a53">01480</a> <font class="keyword">static</font> <font class="keywordtype">int</font> <a class="code" href="Gromacs_8h.html#a53">xtc_int</a>(<a class="code" href="structmd__file.html">md_file</a> *mf, <font class="keywordtype">int</font> *i) {
01481         <font class="keywordtype">unsigned</font> <font class="keywordtype">char</font> c[4];
01482 
01483         <font class="keywordflow">if</font> (!mf) <font class="keywordflow">return</font> <a class="code" href="Gromacs_8h.html#a59">mdio_seterror</a>(<a class="code" href="Gromacs_8h.html#a4">MDIO_BADPARAMS</a>);
01484         <font class="comment">// sanity check.</font>
01485         <font class="keywordflow">if</font> (<font class="keyword">sizeof</font>(int) != 4) <font class="keywordflow">return</font> <a class="code" href="Gromacs_8h.html#a59">mdio_seterror</a>(<a class="code" href="Gromacs_8h.html#a13">MDIO_SIZEERROR</a>);
01486 
01487         <font class="keywordflow">if</font> (fread(c, 1, 4, mf-&gt;<a class="code" href="structmd__file.html#m0">f</a>) != 4) {
01488                 <font class="keywordflow">if</font> (feof(mf-&gt;<a class="code" href="structmd__file.html#m0">f</a>)) <font class="keywordflow">return</font> <a class="code" href="Gromacs_8h.html#a59">mdio_seterror</a>(<a class="code" href="Gromacs_8h.html#a3">MDIO_EOF</a>);
01489                 <font class="keywordflow">else</font> <font class="keywordflow">if</font> (ferror(mf-&gt;<a class="code" href="structmd__file.html#m0">f</a>)) <font class="keywordflow">return</font> <a class="code" href="Gromacs_8h.html#a59">mdio_seterror</a>(<a class="code" href="Gromacs_8h.html#a5">MDIO_IOERROR</a>);
01490                 <font class="keywordflow">else</font> <font class="keywordflow">return</font> <a class="code" href="Gromacs_8h.html#a59">mdio_seterror</a>(<a class="code" href="Gromacs_8h.html#a14">MDIO_UNKNOWNERROR</a>);
01491         }
01492 
01493         <font class="keywordflow">if</font> (i) *i = c[3] + (c[2] &lt;&lt; 8) + (c[1] &lt;&lt; 16) + (c[0] &lt;&lt; 24);
01494         <font class="keywordflow">return</font> <a class="code" href="Gromacs_8h.html#a59">mdio_seterror</a>(<a class="code" href="Gromacs_8h.html#a1">MDIO_SUCCESS</a>);
01495 }
01496 
01497 
01498 <font class="comment">// xtc_float() - reads a float from an xtc file</font>
<a name="l01499"></a><a class="code" href="Gromacs_8h.html#a54">01499</a> <font class="keyword">static</font> <font class="keywordtype">int</font> <a class="code" href="Gromacs_8h.html#a54">xtc_float</a>(<a class="code" href="structmd__file.html">md_file</a> *mf, <font class="keywordtype">float</font> *f) {
01500         <font class="keywordtype">unsigned</font> <font class="keywordtype">char</font> c[4];
01501         <font class="keywordtype">int</font> i;
01502 
01503         <font class="keywordflow">if</font> (!mf) <font class="keywordflow">return</font> <a class="code" href="Gromacs_8h.html#a59">mdio_seterror</a>(<a class="code" href="Gromacs_8h.html#a4">MDIO_BADPARAMS</a>);
01504 
01505         <font class="keywordflow">if</font> (fread(c, 1, 4, mf-&gt;<a class="code" href="structmd__file.html#m0">f</a>) != 4) {
01506                 <font class="keywordflow">if</font> (feof(mf-&gt;<a class="code" href="structmd__file.html#m0">f</a>)) <font class="keywordflow">return</font> <a class="code" href="Gromacs_8h.html#a59">mdio_seterror</a>(<a class="code" href="Gromacs_8h.html#a3">MDIO_EOF</a>);
01507                 <font class="keywordflow">else</font> <font class="keywordflow">if</font> (ferror(mf-&gt;<a class="code" href="structmd__file.html#m0">f</a>)) <font class="keywordflow">return</font> <a class="code" href="Gromacs_8h.html#a59">mdio_seterror</a>(<a class="code" href="Gromacs_8h.html#a5">MDIO_IOERROR</a>);
01508                 <font class="keywordflow">else</font> <font class="keywordflow">return</font> <a class="code" href="Gromacs_8h.html#a59">mdio_seterror</a>(<a class="code" href="Gromacs_8h.html#a14">MDIO_UNKNOWNERROR</a>);
01509         }
01510 
01511         <font class="keywordflow">if</font> (f) {
01512                 <font class="comment">// By reading the number in as an integer and then</font>
01513                 <font class="comment">// copying it to a floating point number we can</font>
01514                 <font class="comment">// ensure proper endianness</font>
01515                 i = c[3] + (c[2] &lt;&lt; 8) + (c[1] &lt;&lt; 16) + (c[0] &lt;&lt; 24);
01516                 memcpy(f, &amp;i, 4);
01517         }
01518         <font class="keywordflow">return</font> <a class="code" href="Gromacs_8h.html#a59">mdio_seterror</a>(<a class="code" href="Gromacs_8h.html#a1">MDIO_SUCCESS</a>);
01519 }
01520 
01521 
01522 <font class="comment">// xtc_data() - reads a specific amount of data from an xtc</font>
01523 <font class="comment">// file using the xdr format.</font>
<a name="l01524"></a><a class="code" href="Gromacs_8h.html#a69">01524</a> <font class="keyword">static</font> <font class="keywordtype">int</font> <a class="code" href="Gromacs_8h.html#a69">xtc_data</a>(<a class="code" href="structmd__file.html">md_file</a> *mf, <font class="keywordtype">char</font> *buf, <font class="keywordtype">int</font> len) {
01525         <font class="keywordflow">if</font> (!mf || len &lt; 1) <font class="keywordflow">return</font> <a class="code" href="Gromacs_8h.html#a59">mdio_seterror</a>(<a class="code" href="Gromacs_8h.html#a4">MDIO_BADPARAMS</a>);
01526   size_t slen = (size_t)len;
01527         <font class="keywordflow">if</font> (buf) {
01528                 <font class="keywordflow">if</font> (fread(buf, 1, slen, mf-&gt;<a class="code" href="structmd__file.html#m0">f</a>) != slen) {
01529                         <font class="keywordflow">if</font> (feof(mf-&gt;<a class="code" href="structmd__file.html#m0">f</a>)) <font class="keywordflow">return</font> <a class="code" href="Gromacs_8h.html#a59">mdio_seterror</a>(<a class="code" href="Gromacs_8h.html#a3">MDIO_EOF</a>);
01530                         <font class="keywordflow">if</font> (ferror(mf-&gt;<a class="code" href="structmd__file.html#m0">f</a>)) <font class="keywordflow">return</font> <a class="code" href="Gromacs_8h.html#a59">mdio_seterror</a>(<a class="code" href="Gromacs_8h.html#a5">MDIO_IOERROR</a>);
01531                         <font class="keywordflow">else</font> <font class="keywordflow">return</font> <a class="code" href="Gromacs_8h.html#a59">mdio_seterror</a>(<a class="code" href="Gromacs_8h.html#a14">MDIO_UNKNOWNERROR</a>);
01532                 }
01533                 <font class="keywordflow">if</font> (len % 4) {
01534                         <font class="keywordflow">if</font> (fseek(mf-&gt;<a class="code" href="structmd__file.html#m0">f</a>, 4 - (len % 4), SEEK_CUR)) {
01535                                 <font class="keywordflow">if</font> (feof(mf-&gt;<a class="code" href="structmd__file.html#m0">f</a>)) <font class="keywordflow">return</font> <a class="code" href="Gromacs_8h.html#a59">mdio_seterror</a>(<a class="code" href="Gromacs_8h.html#a3">MDIO_EOF</a>);
01536                                 <font class="keywordflow">if</font> (ferror(mf-&gt;<a class="code" href="structmd__file.html#m0">f</a>)) <font class="keywordflow">return</font> <a class="code" href="Gromacs_8h.html#a59">mdio_seterror</a>(<a class="code" href="Gromacs_8h.html#a5">MDIO_IOERROR</a>);
01537                                 <font class="keywordflow">else</font> <font class="keywordflow">return</font> <a class="code" href="Gromacs_8h.html#a59">mdio_seterror</a>(<a class="code" href="Gromacs_8h.html#a14">MDIO_UNKNOWNERROR</a>);
01538                         }
01539                 }
01540         }
01541         <font class="keywordflow">else</font> {
01542                 <font class="keywordtype">int</font> newlen;
01543                 newlen = len;
01544                 <font class="keywordflow">if</font> (len % 4) newlen += (4 - (len % 4));
01545                 <font class="keywordflow">if</font> (fseek(mf-&gt;<a class="code" href="structmd__file.html#m0">f</a>, newlen, SEEK_CUR)) {
01546                         <font class="keywordflow">if</font> (feof(mf-&gt;<a class="code" href="structmd__file.html#m0">f</a>)) <font class="keywordflow">return</font> <a class="code" href="Gromacs_8h.html#a59">mdio_seterror</a>(<a class="code" href="Gromacs_8h.html#a3">MDIO_EOF</a>);
01547                         <font class="keywordflow">if</font> (ferror(mf-&gt;<a class="code" href="structmd__file.html#m0">f</a>)) <font class="keywordflow">return</font> <a class="code" href="Gromacs_8h.html#a59">mdio_seterror</a>(<a class="code" href="Gromacs_8h.html#a5">MDIO_IOERROR</a>);
01548                         <font class="keywordflow">else</font> <font class="keywordflow">return</font> <a class="code" href="Gromacs_8h.html#a59">mdio_seterror</a>(<a class="code" href="Gromacs_8h.html#a14">MDIO_UNKNOWNERROR</a>);
01549                 }
01550         }
01551         <font class="keywordflow">return</font> len;
01552 }
01553 
01554 
01555 <font class="comment">// xtc_timestep() - reads a timestep from an .xtc file.</font>
<a name="l01556"></a><a class="code" href="Gromacs_8h.html#a55">01556</a> <font class="keyword">static</font> <font class="keywordtype">int</font> <a class="code" href="Gromacs_8h.html#a55">xtc_timestep</a>(<a class="code" href="structmd__file.html">md_file</a> *mf, <a class="code" href="structmd__ts.html">md_ts</a> *ts) {
01557         <font class="keywordtype">int</font> n;
01558         <font class="keywordtype">float</font> f, x[3], y[3], z[3];
01559 
01560         <font class="keywordtype">int</font> size = 0; <font class="comment">// explicitly initialized to zero.</font>
01561         <font class="keywordtype">float</font> precision;
01562 
01563         <font class="keywordflow">if</font> (!mf || !ts) <font class="keywordflow">return</font> <a class="code" href="Gromacs_8h.html#a59">mdio_seterror</a>(<a class="code" href="Gromacs_8h.html#a4">MDIO_BADPARAMS</a>);
01564         <font class="keywordflow">if</font> (!mf-&gt;<a class="code" href="structmd__file.html#m0">f</a>) <font class="keywordflow">return</font> <a class="code" href="Gromacs_8h.html#a59">mdio_seterror</a>(<a class="code" href="Gromacs_8h.html#a4">MDIO_BADPARAMS</a>);
01565         <font class="keywordflow">if</font> (mf-&gt;<a class="code" href="structmd__file.html#m1">fmt</a> != <a class="code" href="Gromacs_8h.html#a29">MDFMT_XTC</a>) <font class="keywordflow">return</font> <a class="code" href="Gromacs_8h.html#a59">mdio_seterror</a>(<a class="code" href="Gromacs_8h.html#a12">MDIO_WRONGFORMAT</a>);
01566 
01567         <font class="comment">// Check magic number</font>
01568         <font class="keywordflow">if</font> (<a class="code" href="Gromacs_8h.html#a53">xtc_int</a>(mf, &amp;n) &lt; 0) <font class="keywordflow">return</font> -1;
01569         <font class="keywordflow">if</font> (n != <a class="code" href="Gromacs_8h.html#a19">XTC_MAGIC</a>) <font class="keywordflow">return</font> <a class="code" href="Gromacs_8h.html#a59">mdio_seterror</a>(<a class="code" href="Gromacs_8h.html#a2">MDIO_BADFORMAT</a>);
01570 
01571         <font class="comment">// Get number of atoms</font>
01572         <font class="keywordflow">if</font> (<a class="code" href="Gromacs_8h.html#a53">xtc_int</a>(mf, &amp;n) &lt; 0) <font class="keywordflow">return</font> -1;
01573         ts-&gt;<a class="code" href="structmd__ts.html#m1">natoms</a> = n;
01574 
01575         <font class="comment">// Get the simulation step</font>
01576         <font class="keywordflow">if</font> (<a class="code" href="Gromacs_8h.html#a53">xtc_int</a>(mf, &amp;n) &lt; 0) <font class="keywordflow">return</font> -1;
01577         ts-&gt;<a class="code" href="structmd__ts.html#m2">step</a> = n;
01578 
01579         <font class="comment">// Get the time value</font>
01580         <font class="keywordflow">if</font> (<a class="code" href="Gromacs_8h.html#a54">xtc_float</a>(mf, &amp;f) &lt; 0) <font class="keywordflow">return</font> -1;
01581         ts-&gt;<a class="code" href="structmd__ts.html#m3">time</a> = f;
01582 
01583         <font class="comment">// Read the basis vectors of the box</font>
01584   <font class="keywordflow">if</font> ( (<a class="code" href="Gromacs_8h.html#a54">xtc_float</a>(mf, &amp;x[0]) &lt; 0) ||
01585        (<a class="code" href="Gromacs_8h.html#a54">xtc_float</a>(mf, &amp;x[1]) &lt; 0) ||
01586        (<a class="code" href="Gromacs_8h.html#a54">xtc_float</a>(mf, &amp;x[2]) &lt; 0) ||
01587        (<a class="code" href="Gromacs_8h.html#a54">xtc_float</a>(mf, &amp;y[0]) &lt; 0) ||
01588        (<a class="code" href="Gromacs_8h.html#a54">xtc_float</a>(mf, &amp;y[1]) &lt; 0) ||
01589        (<a class="code" href="Gromacs_8h.html#a54">xtc_float</a>(mf, &amp;y[2]) &lt; 0) ||
01590        (<a class="code" href="Gromacs_8h.html#a54">xtc_float</a>(mf, &amp;z[0]) &lt; 0) ||
01591        (<a class="code" href="Gromacs_8h.html#a54">xtc_float</a>(mf, &amp;z[1]) &lt; 0) ||
01592        (<a class="code" href="Gromacs_8h.html#a54">xtc_float</a>(mf, &amp;z[2]) &lt; 0) )
01593     <font class="keywordflow">return</font> -1;
01594   <font class="comment">// Allocate the box and convert the vectors.</font>
01595   ts-&gt;<a class="code" href="structmd__ts.html#m4">box</a> = (<a class="code" href="structmd__box.html">md_box</a> *) malloc(<font class="keyword">sizeof</font>(<a class="code" href="structmd__box.html">md_box</a>));
01596   <font class="keywordflow">if</font> (<a class="code" href="Gromacs_8h.html#a63">mdio_readbox</a>(ts-&gt;<a class="code" href="structmd__ts.html#m4">box</a>, x, y, z) &lt; 0) {
01597     free(ts-&gt;<a class="code" href="structmd__ts.html#m4">box</a>);
01598     ts-&gt;<a class="code" href="structmd__ts.html#m4">box</a> = NULL;
01599     <font class="keywordflow">return</font> -1;
01600   }
01601 
01602         ts-&gt;<a class="code" href="structmd__ts.html#m0">pos</a> = (<font class="keywordtype">float</font> *) malloc(<font class="keyword">sizeof</font>(<font class="keywordtype">float</font>) * 3 * ts-&gt;<a class="code" href="structmd__ts.html#m1">natoms</a>);
01603         <font class="keywordflow">if</font> (!ts-&gt;<a class="code" href="structmd__ts.html#m0">pos</a>) <font class="keywordflow">return</font> <a class="code" href="Gromacs_8h.html#a59">mdio_seterror</a>(<a class="code" href="Gromacs_8h.html#a7">MDIO_BADMALLOC</a>);
01604         n = <a class="code" href="Gromacs_8h.html#a56">xtc_3dfcoord</a>(mf, ts-&gt;<a class="code" href="structmd__ts.html#m0">pos</a>, &amp;size, &amp;precision);
01605         <font class="keywordflow">if</font> (n &lt; 0) <font class="keywordflow">return</font> -1;
01606 
01607         <font class="comment">/* Now we're left with the job of scaling... */</font>
01608         <font class="keywordflow">for</font> (n = 0; n &lt; ts-&gt;<a class="code" href="structmd__ts.html#m1">natoms</a> * 3; n++)
01609                 ts-&gt;<a class="code" href="structmd__ts.html#m0">pos</a>[n] *= <a class="code" href="Gromacs_8h.html#a24">ANGS_PER_NM</a>;
01610 
01611         <font class="keywordflow">return</font> <a class="code" href="Gromacs_8h.html#a59">mdio_seterror</a>(<a class="code" href="Gromacs_8h.html#a1">MDIO_SUCCESS</a>);
01612 }
01613 
01614 
01616 <font class="comment">// This algorithm is an implementation of the 3dfcoord algorithm</font>
01617 <font class="comment">// written by Frans van Hoesel (hoesel@chem.rug.nl) as part of the</font>
01618 <font class="comment">// Europort project in 1995.</font>
01620 <font class="comment"></font>
01621 <font class="comment">// integer table used in decompression</font>
<a name="l01622"></a><a class="code" href="Gromacs_8h.html#a35">01622</a> <font class="keyword">static</font> <font class="keywordtype">int</font> <a class="code" href="Gromacs_8h.html#a35">xtc_magicints</a>[] = {
01623         0, 0, 0, 0, 0, 0, 0, 0, 0,8, 10, 12, 16, 20, 25, 32, 40, 50, 64,
01624         80, 101, 128, 161, 203, 256, 322, 406, 512, 645, 812, 1024, 1290,
01625         1625, 2048, 2580, 3250, 4096, 5060, 6501, 8192, 10321, 13003, 16384,
01626         20642, 26007, 32768, 41285, 52015, 65536, 82570, 104031, 131072,
01627         165140, 208063, 262144, 330280, 416127, 524287, 660561, 832255,
01628         1048576, 1321122, 1664510, 2097152, 2642245, 3329021, 4194304,
01629         5284491, 6658042, 8388607, 10568983, 13316085, 16777216 };
01630 
<a name="l01631"></a><a class="code" href="Gromacs_8h.html#a30">01631</a> <font class="preprocessor">#define FIRSTIDX 9</font>
01632 <font class="preprocessor"></font><font class="comment">/* note that magicints[FIRSTIDX-1] == 0 */</font>
<a name="l01633"></a><a class="code" href="Gromacs_8h.html#a31">01633</a> <font class="preprocessor">#define LASTIDX (sizeof(xtc_magicints) / sizeof(*xtc_magicints))</font>
01634 <font class="preprocessor"></font>
01635 
01636 <font class="comment">// returns the number of bits in the binary expansion of</font>
01637 <font class="comment">// the given integer.</font>
<a name="l01638"></a><a class="code" href="Gromacs_8h.html#a70">01638</a> <font class="keyword">static</font> <font class="keywordtype">int</font> <a class="code" href="Gromacs_8h.html#a70">xtc_sizeofint</a>(<font class="keywordtype">int</font> size) {
01639         <font class="keywordtype">unsigned</font> <font class="keywordtype">int</font> num = 1;
01640   <font class="keywordtype">unsigned</font> <font class="keywordtype">int</font> ssize = (<font class="keywordtype">unsigned</font> <font class="keywordtype">int</font>)size;
01641         <font class="keywordtype">int</font> nbits = 0;
01642 
01643         <font class="keywordflow">while</font> (ssize &gt;= num &amp;&amp; nbits &lt; 32) {
01644                 nbits++;
01645                 num &lt;&lt;= 1;
01646         }
01647         <font class="keywordflow">return</font> nbits;
01648 }
01649 
01650 <font class="comment">// calculates the number of bits a set of integers, when compressed,</font>
01651 <font class="comment">// will take up.</font>
<a name="l01652"></a><a class="code" href="Gromacs_8h.html#a71">01652</a> <font class="keyword">static</font> <font class="keywordtype">int</font> <a class="code" href="Gromacs_8h.html#a71">xtc_sizeofints</a>(<font class="keywordtype">int</font> nints, <font class="keywordtype">unsigned</font> <font class="keywordtype">int</font> *sizes) {
01653         <font class="keywordtype">int</font> i;
01654   <font class="keywordtype">unsigned</font> <font class="keywordtype">int</font> num;
01655         <font class="keywordtype">unsigned</font> <font class="keywordtype">int</font> nbytes, nbits, bytes[32], bytecnt, tmp;
01656         nbytes = 1;
01657         bytes[0] = 1;
01658         nbits = 0;
01659         <font class="keywordflow">for</font> (i=0; i &lt; nints; i++) {     
01660                 tmp = 0;
01661                 <font class="keywordflow">for</font> (bytecnt = 0; bytecnt &lt; nbytes; bytecnt++) {
01662                         tmp = bytes[bytecnt] * sizes[i] + tmp;
01663                         bytes[bytecnt] = tmp &amp; 0xff;
01664                         tmp &gt;&gt;= 8;
01665                 }
01666                 <font class="keywordflow">while</font> (tmp != 0) {
01667                         bytes[bytecnt++] = tmp &amp; 0xff;
01668                         tmp &gt;&gt;= 8;
01669                 }
01670                 nbytes = bytecnt;
01671         }
01672         num = 1;
01673         nbytes--;
01674         <font class="keywordflow">while</font> (bytes[nbytes] &gt;= num) {
01675                 nbits++;
01676                 num *= 2;
01677         }
01678         <font class="keywordflow">return</font> nbits + nbytes * 8;
01679 }
01680 
01681 <font class="comment">// reads bits from a buffer.    </font>
<a name="l01682"></a><a class="code" href="Gromacs_8h.html#a64">01682</a> <font class="keyword">static</font> <font class="keywordtype">int</font> <a class="code" href="Gromacs_8h.html#a64">xtc_receivebits</a>(<font class="keywordtype">int</font> *buf, <font class="keywordtype">int</font> nbits) {
01683         <font class="keywordtype">int</font> cnt, num; 
01684         <font class="keywordtype">unsigned</font> <font class="keywordtype">int</font> lastbits, lastbyte;
01685         <font class="keywordtype">unsigned</font> <font class="keywordtype">char</font> * cbuf;
01686         <font class="keywordtype">int</font> mask = (1 &lt;&lt; nbits) -1;
01687 
01688         cbuf = ((<font class="keywordtype">unsigned</font> <font class="keywordtype">char</font> *)buf) + 3 * <font class="keyword">sizeof</font>(*buf);
01689         cnt = buf[0];
01690         lastbits = (<font class="keywordtype">unsigned</font> <font class="keywordtype">int</font>) buf[1];
01691         lastbyte = (<font class="keywordtype">unsigned</font> <font class="keywordtype">int</font>) buf[2];
01692 
01693         num = 0;
01694         <font class="keywordflow">while</font> (nbits &gt;= 8) {
01695                 lastbyte = ( lastbyte &lt;&lt; 8 ) | cbuf[cnt++];
01696                 num |=  (lastbyte &gt;&gt; lastbits) &lt;&lt; (nbits - 8);
01697                 nbits -=8;
01698         }
01699         <font class="keywordflow">if</font> (nbits &gt; 0) {
01700                 <font class="keywordflow">if</font> (lastbits &lt; (<font class="keywordtype">unsigned</font> <font class="keywordtype">int</font>)nbits) {
01701                         lastbits += 8;
01702                         lastbyte = (lastbyte &lt;&lt; 8) | cbuf[cnt++];
01703                 }
01704                 lastbits -= nbits;
01705                 num |= (lastbyte &gt;&gt; lastbits) &amp; ((1 &lt;&lt; nbits) -1);
01706         }
01707         num &amp;= mask;
01708         buf[0] = cnt;
01709         buf[1] = lastbits;
01710         buf[2] = lastbyte;
01711         <font class="keywordflow">return</font> num; 
01712 }
01713 
01714 <font class="comment">// decompresses small integers from the buffer</font>
<a name="l01715"></a><a class="code" href="Gromacs_8h.html#a72">01715</a> <font class="keyword">static</font> <font class="keywordtype">void</font> <a class="code" href="Gromacs_8h.html#a72">xtc_receiveints</a>(<font class="keywordtype">int</font> *buf, <font class="keyword">const</font> <font class="keywordtype">int</font> nints, <font class="keywordtype">int</font> nbits,
01716                         <font class="keywordtype">unsigned</font> <font class="keywordtype">int</font> *sizes, <font class="keywordtype">int</font> *nums) {
01717         <font class="keywordtype">int</font> bytes[32];
01718         <font class="keywordtype">int</font> i, j, nbytes, p, num;
01719 
01720         bytes[1] = bytes[2] = bytes[3] = 0;
01721         nbytes = 0;
01722         <font class="keywordflow">while</font> (nbits &gt; 8) {
01723                 bytes[nbytes++] = <a class="code" href="Gromacs_8h.html#a64">xtc_receivebits</a>(buf, 8);
01724                 nbits -= 8;
01725         }
01726         <font class="keywordflow">if</font> (nbits &gt; 0) {
01727                 bytes[nbytes++] = <a class="code" href="Gromacs_8h.html#a64">xtc_receivebits</a>(buf, nbits);
01728         }
01729         <font class="keywordflow">for</font> (i = nints-1; i &gt; 0; i--) {
01730                 num = 0;
01731                 <font class="keywordflow">for</font> (j = nbytes-1; j &gt;=0; j--) {
01732                         num = (num &lt;&lt; 8) | bytes[j];
01733                         p = num / sizes[i];
01734                         bytes[j] = p;
01735                         num = num - p * sizes[i];
01736                 }
01737                 nums[i] = num;
01738         }
01739         nums[0] = bytes[0] | (bytes[1] &lt;&lt; 8) | (bytes[2] &lt;&lt; 16) | (bytes[3] &lt;&lt; 24);
01740 }
01741 
01742 <font class="comment">// function that actually reads and writes compressed coordinates    </font>
<a name="l01743"></a><a class="code" href="Gromacs_8h.html#a56">01743</a> <font class="keyword">static</font> <font class="keywordtype">int</font> <a class="code" href="Gromacs_8h.html#a56">xtc_3dfcoord</a>(<a class="code" href="structmd__file.html">md_file</a> *mf, <font class="keywordtype">float</font> *fp, <font class="keywordtype">int</font> *size, <font class="keywordtype">float</font> *precision) {
01744         <font class="keyword">static</font> <font class="keywordtype">int</font> *ip = NULL;
01745         <font class="keyword">static</font> <font class="keywordtype">int</font> oldsize;
01746         <font class="keyword">static</font> <font class="keywordtype">int</font> *buf;
01747 
01748         <font class="keywordtype">int</font> minint[3], maxint[3], *lip;
01749         <font class="keywordtype">int</font> smallidx;
01750         <font class="keywordtype">unsigned</font> sizeint[3], sizesmall[3], bitsizeint[3], size3;
01751         <font class="keywordtype">int</font> flag, k;
01752         <font class="keywordtype">int</font> small, smaller, i, is_smaller, run;
01753         <font class="keywordtype">float</font> *lfp;
01754         <font class="keywordtype">int</font> tmp, *thiscoord,  prevcoord[3];
01755 
01756         <font class="keywordtype">int</font> bufsize, lsize;
01757         <font class="keywordtype">unsigned</font> <font class="keywordtype">int</font> bitsize;
01758         <font class="keywordtype">float</font> inv_precision;
01759 
01760 
01761         <font class="keywordflow">if</font> (<a class="code" href="Gromacs_8h.html#a53">xtc_int</a>(mf, &amp;lsize) &lt; 0) <font class="keywordflow">return</font> -1;
01762 
01763         <font class="keywordflow">if</font> (*size != 0 &amp;&amp; lsize != *size) <font class="keywordflow">return</font> <a class="code" href="Gromacs_8h.html#a59">mdio_seterror</a>(<a class="code" href="Gromacs_8h.html#a2">MDIO_BADFORMAT</a>);
01764 
01765         *size = lsize;
01766         size3 = *size * 3;
01767         <font class="keywordflow">if</font> (*size &lt;= 9) {
01768                 <font class="keywordflow">for</font> (i = 0; i &lt; *size; i++) {
01769                         <font class="keywordflow">if</font> (<a class="code" href="Gromacs_8h.html#a54">xtc_float</a>(mf, fp + (3 * i)) &lt; 0) <font class="keywordflow">return</font> -1;
01770                         <font class="keywordflow">if</font> (<a class="code" href="Gromacs_8h.html#a54">xtc_float</a>(mf, fp + (3 * i) + 1) &lt; 0) <font class="keywordflow">return</font> -1;
01771                         <font class="keywordflow">if</font> (<a class="code" href="Gromacs_8h.html#a54">xtc_float</a>(mf, fp + (3 * i) + 2) &lt; 0) <font class="keywordflow">return</font> -1;
01772                 }
01773                 <font class="keywordflow">return</font> *size;
01774         }
01775         <a class="code" href="Gromacs_8h.html#a54">xtc_float</a>(mf, precision);
01776         <font class="keywordflow">if</font> (ip == NULL) {
01777                 ip = (<font class="keywordtype">int</font> *)malloc(size3 * <font class="keyword">sizeof</font>(*ip));
01778                 <font class="keywordflow">if</font> (ip == NULL) <font class="keywordflow">return</font> <a class="code" href="Gromacs_8h.html#a59">mdio_seterror</a>(<a class="code" href="Gromacs_8h.html#a7">MDIO_BADMALLOC</a>);
01779                 bufsize = (int) (size3 * 1.2);
01780                 buf = (<font class="keywordtype">int</font> *)malloc(bufsize * <font class="keyword">sizeof</font>(*buf));
01781                 <font class="keywordflow">if</font> (buf == NULL) <font class="keywordflow">return</font> <a class="code" href="Gromacs_8h.html#a59">mdio_seterror</a>(<a class="code" href="Gromacs_8h.html#a7">MDIO_BADMALLOC</a>);
01782                 oldsize = *size;
01783         } <font class="keywordflow">else</font> <font class="keywordflow">if</font> (*size &gt; oldsize) {
01784                 ip = (<font class="keywordtype">int</font> *)realloc(ip, size3 * <font class="keyword">sizeof</font>(*ip));
01785                 <font class="keywordflow">if</font> (ip == NULL) <font class="keywordflow">return</font> <a class="code" href="Gromacs_8h.html#a59">mdio_seterror</a>(<a class="code" href="Gromacs_8h.html#a7">MDIO_BADMALLOC</a>);
01786                 bufsize = (int) (size3 * 1.2);
01787                 buf = (<font class="keywordtype">int</font> *)realloc(buf, bufsize * <font class="keyword">sizeof</font>(*buf));
01788                 <font class="keywordflow">if</font> (buf == NULL) <font class="keywordflow">return</font> <a class="code" href="Gromacs_8h.html#a59">mdio_seterror</a>(<a class="code" href="Gromacs_8h.html#a7">MDIO_BADMALLOC</a>);
01789                 oldsize = *size;
01790         }
01791         buf[0] = buf[1] = buf[2] = 0;
01792 
01793         <a class="code" href="Gromacs_8h.html#a53">xtc_int</a>(mf, &amp;(minint[0]));
01794         <a class="code" href="Gromacs_8h.html#a53">xtc_int</a>(mf, &amp;(minint[1]));
01795         <a class="code" href="Gromacs_8h.html#a53">xtc_int</a>(mf, &amp;(minint[2]));
01796 
01797         <a class="code" href="Gromacs_8h.html#a53">xtc_int</a>(mf, &amp;(maxint[0]));
01798         <a class="code" href="Gromacs_8h.html#a53">xtc_int</a>(mf, &amp;(maxint[1]));
01799         <a class="code" href="Gromacs_8h.html#a53">xtc_int</a>(mf, &amp;(maxint[2]));
01800                 
01801         sizeint[0] = maxint[0] - minint[0]+1;
01802         sizeint[1] = maxint[1] - minint[1]+1;
01803         sizeint[2] = maxint[2] - minint[2]+1;
01804         
01805         <font class="comment">/* check if one of the sizes is to big to be multiplied */</font>
01806         <font class="keywordflow">if</font> ((sizeint[0] | sizeint[1] | sizeint[2] ) &gt; 0xffffff) {
01807                 bitsizeint[0] = <a class="code" href="Gromacs_8h.html#a70">xtc_sizeofint</a>(sizeint[0]);
01808                 bitsizeint[1] = <a class="code" href="Gromacs_8h.html#a70">xtc_sizeofint</a>(sizeint[1]);
01809                 bitsizeint[2] = <a class="code" href="Gromacs_8h.html#a70">xtc_sizeofint</a>(sizeint[2]);
01810                 bitsize = 0; <font class="comment">/* flag the use of large sizes */</font>
01811         } <font class="keywordflow">else</font> {
01812                 bitsize = <a class="code" href="Gromacs_8h.html#a71">xtc_sizeofints</a>(3, sizeint);
01813         }
01814 
01815         <a class="code" href="Gromacs_8h.html#a53">xtc_int</a>(mf, &amp;smallidx);
01816         smaller = <a class="code" href="Gromacs_8h.html#a35">xtc_magicints</a>[<a class="code" href="Gromacs_8h.html#a30">FIRSTIDX</a> &gt; smallidx - 1 ? <a class="code" href="Gromacs_8h.html#a30">FIRSTIDX</a> : smallidx - 1] / 2;
01817         small = <a class="code" href="Gromacs_8h.html#a35">xtc_magicints</a>[smallidx] / 2;
01818         sizesmall[0] = sizesmall[1] = sizesmall[2] = <a class="code" href="Gromacs_8h.html#a35">xtc_magicints</a>[smallidx] ;
01819 
01820         <font class="comment">/* buf[0] holds the length in bytes */</font>
01821 
01822         <font class="keywordflow">if</font> (<a class="code" href="Gromacs_8h.html#a53">xtc_int</a>(mf, &amp;(buf[0])) &lt; 0) <font class="keywordflow">return</font> -1;
01823 
01824         <font class="keywordflow">if</font> (<a class="code" href="Gromacs_8h.html#a69">xtc_data</a>(mf, (<font class="keywordtype">char</font> *) &amp;buf[3], (<font class="keywordtype">int</font>) buf[0]) &lt; 0) <font class="keywordflow">return</font> -1;
01825 
01826         buf[0] = buf[1] = buf[2] = 0;
01827 
01828         lfp = fp;
01829         inv_precision = 1.0f / (*precision);
01830         run = 0;
01831         i = 0;
01832         lip = ip;
01833         <font class="keywordflow">while</font> (i &lt; lsize) {
01834                 thiscoord = (<font class="keywordtype">int</font> *)(lip) + i * 3;
01835 
01836                 <font class="keywordflow">if</font> (bitsize == 0) {
01837                         thiscoord[0] = <a class="code" href="Gromacs_8h.html#a64">xtc_receivebits</a>(buf, bitsizeint[0]);
01838                         thiscoord[1] = <a class="code" href="Gromacs_8h.html#a64">xtc_receivebits</a>(buf, bitsizeint[1]);
01839                         thiscoord[2] = <a class="code" href="Gromacs_8h.html#a64">xtc_receivebits</a>(buf, bitsizeint[2]);
01840                 } <font class="keywordflow">else</font> {
01841                         <a class="code" href="Gromacs_8h.html#a72">xtc_receiveints</a>(buf, 3, bitsize, sizeint, thiscoord);
01842                 }
01843 
01844                 i++;
01845                 thiscoord[0] += minint[0];
01846                 thiscoord[1] += minint[1];
01847                 thiscoord[2] += minint[2];
01848 
01849                 prevcoord[0] = thiscoord[0];
01850                 prevcoord[1] = thiscoord[1];
01851                 prevcoord[2] = thiscoord[2];
01852  
01853 
01854                 flag = <a class="code" href="Gromacs_8h.html#a64">xtc_receivebits</a>(buf, 1);
01855                 is_smaller = 0;
01856                 <font class="keywordflow">if</font> (flag == 1) {
01857                         run = <a class="code" href="Gromacs_8h.html#a64">xtc_receivebits</a>(buf, 5);
01858                         is_smaller = run % 3;
01859                         run -= is_smaller;
01860                         is_smaller--;
01861                 }
01862                 <font class="keywordflow">if</font> (run &gt; 0) {
01863                         thiscoord += 3;
01864                         <font class="keywordflow">for</font> (k = 0; k &lt; run; k+=3) {
01865                                 <a class="code" href="Gromacs_8h.html#a72">xtc_receiveints</a>(buf, 3, smallidx, sizesmall, thiscoord);
01866                                 i++;
01867                                 thiscoord[0] += prevcoord[0] - small;
01868                                 thiscoord[1] += prevcoord[1] - small;
01869                                 thiscoord[2] += prevcoord[2] - small;
01870                                 <font class="keywordflow">if</font> (k == 0) {
01871                                         <font class="comment">/* interchange first with second atom for better</font>
01872 <font class="comment">                                         * compression of water molecules</font>
01873 <font class="comment">                                         */</font>
01874                                         tmp = thiscoord[0]; thiscoord[0] = prevcoord[0];
01875                                         prevcoord[0] = tmp;
01876                                         tmp = thiscoord[1]; thiscoord[1] = prevcoord[1];
01877                                         prevcoord[1] = tmp;
01878                                         tmp = thiscoord[2]; thiscoord[2] = prevcoord[2];
01879                                         prevcoord[2] = tmp;
01880                                         *lfp++ = prevcoord[0] * inv_precision;
01881                                         *lfp++ = prevcoord[1] * inv_precision;
01882                                         *lfp++ = prevcoord[2] * inv_precision;
01883                                 } <font class="keywordflow">else</font> {
01884                                         prevcoord[0] = thiscoord[0];
01885                                         prevcoord[1] = thiscoord[1];
01886                                         prevcoord[2] = thiscoord[2];
01887                                 }
01888                                 *lfp++ = thiscoord[0] * inv_precision;
01889                                 *lfp++ = thiscoord[1] * inv_precision;
01890                                 *lfp++ = thiscoord[2] * inv_precision;
01891                         }
01892                 } <font class="keywordflow">else</font> {
01893                         *lfp++ = thiscoord[0] * inv_precision;
01894                         *lfp++ = thiscoord[1] * inv_precision;
01895                         *lfp++ = thiscoord[2] * inv_precision;          
01896                 }
01897                 smallidx += is_smaller;
01898                 <font class="keywordflow">if</font> (is_smaller &lt; 0) {
01899                         small = smaller;
01900                         <font class="keywordflow">if</font> (smallidx &gt; <a class="code" href="Gromacs_8h.html#a30">FIRSTIDX</a>) {
01901                                 smaller = <a class="code" href="Gromacs_8h.html#a35">xtc_magicints</a>[smallidx - 1] /2;
01902                         } <font class="keywordflow">else</font> {
01903                                 smaller = 0;
01904                         }
01905                 } <font class="keywordflow">else</font> <font class="keywordflow">if</font> (is_smaller &gt; 0) {
01906                         smaller = small;
01907                         small = <a class="code" href="Gromacs_8h.html#a35">xtc_magicints</a>[smallidx] / 2;
01908                 }
01909                 sizesmall[0] = sizesmall[1] = sizesmall[2] = <a class="code" href="Gromacs_8h.html#a35">xtc_magicints</a>[smallidx] ;
01910         }
01911         <font class="keywordflow">return</font> 1;
01912 }
01913 <font class="preprocessor">#endif</font>
</pre></div><hr><address><small>Generated on Wed Mar 22 13:15:30 2006 for VMD Plugins (current) by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.gif" alt="doxygen" align="middle" border=0 
width=110 height=53></a>1.2.14 written by <a href="mailto:dimitri@stack.nl">Dimitri van Heesch</a>,
 &copy;&nbsp;1997-2002</small></address>
</body>
</html>
