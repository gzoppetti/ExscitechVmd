<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>tinkerplugin.c Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.2.14 -->
<center>
<a class="qindex" href="index.html">Main Page</a> &nbsp; <a class="qindex" href="classes.html">Alphabetical List</a> &nbsp; <a class="qindex" href="annotated.html">Compound List</a> &nbsp; <a class="qindex" href="files.html">File List</a> &nbsp; <a class="qindex" href="functions.html">Compound Members</a> &nbsp; <a class="qindex" href="globals.html">File Members</a> &nbsp; <a class="qindex" href="pages.html">Related Pages</a> &nbsp; </center>
<hr><h1>tinkerplugin.c</h1><a href="tinkerplugin_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 <font class="comment">/***************************************************************************</font>
00002 <font class="comment"> *cr</font>
00003 <font class="comment"> *cr            (C) Copyright 1995-2006 The Board of Trustees of the</font>
00004 <font class="comment"> *cr                        University of Illinois</font>
00005 <font class="comment"> *cr                         All Rights Reserved</font>
00006 <font class="comment"> *cr</font>
00007 <font class="comment"> ***************************************************************************/</font>
00008 
00009 <font class="comment">/***************************************************************************</font>
00010 <font class="comment"> * RCS INFORMATION:</font>
00011 <font class="comment"> *</font>
00012 <font class="comment"> *      $RCSfile: tinkerplugin.c,v $</font>
00013 <font class="comment"> *      $Author: johns $       $Locker:  $             $State: Exp $</font>
00014 <font class="comment"> *      $Revision: 1.10 $       $Date: 2006/02/23 19:36:45 $</font>
00015 <font class="comment"> *</font>
00016 <font class="comment"> ***************************************************************************/</font>
00017 
00018  <font class="comment">/*</font>
00019 <font class="comment">  * The .arc file is the one coming straight out of tinker.</font>
00020 <font class="comment">  * Many frames, looks like a regular tinker, except that in the last columns</font>
00021 <font class="comment">  * after x, y and z it has :</font>
00022 <font class="comment">  * </font>
00023 <font class="comment">  * atom type (not important for viz)</font>
00024 <font class="comment">  * </font>
00025 <font class="comment">  * and then info in a Z-matrix form</font>
00026 <font class="comment">  * </font>
00027 <font class="comment">  * atom to which you are bonded, atom to which you are 'angled' and atom to</font>
00028 <font class="comment">  * which you are 'torsioned'.</font>
00029 <font class="comment">  * </font>
00030 <font class="comment">  */</font>
00031 
00032 <font class="preprocessor">#include "<a class="code" href="largefiles_8h.html">largefiles.h</a>"</font>   <font class="comment">/* platform dependent 64-bit file I/O defines */</font>
00033 
00034 <font class="preprocessor">#include &lt;stdio.h&gt;</font>
00035 <font class="preprocessor">#include &lt;stdlib.h&gt;</font>
00036 <font class="preprocessor">#include &lt;string.h&gt;</font>
00037 <font class="preprocessor">#include &lt;ctype.h&gt;</font>
00038 <font class="preprocessor">#include "<a class="code" href="molfile__plugin_8h.html">molfile_plugin.h</a>"</font>
00039 
<a name="l00040"></a><a class="code" href="structtinkerdata.html">00040</a> <font class="keyword">typedef</font> <font class="keyword">struct </font>{
<a name="l00041"></a><a class="code" href="structtinkerdata.html#m0">00041</a>   FILE *file;
<a name="l00042"></a><a class="code" href="structtinkerdata.html#m1">00042</a>   <font class="keywordtype">int</font> numatoms;
<a name="l00043"></a><a class="code" href="structtinkerdata.html#m2">00043</a>   <font class="keywordtype">char</font> *file_name;
<a name="l00044"></a><a class="code" href="structtinkerdata.html#m3">00044</a>   <a class="code" href="structmolfile__atom__t.html">molfile_atom_t</a> *atomlist;
00045 } <a class="code" href="structtinkerdata.html">tinkerdata</a>;
00046  
<a name="l00047"></a><a class="code" href="tinkerplugin_8c.html#a1">00047</a> <font class="keyword">static</font> <font class="keywordtype">void</font> *<a class="code" href="tinkerplugin_8c.html#a1">open_tinker_read</a>(<font class="keyword">const</font> <font class="keywordtype">char</font> *filename, <font class="keyword">const</font> <font class="keywordtype">char</font> *filetype, 
00048                            <font class="keywordtype">int</font> *natoms) {
00049   FILE *fd;
00050   <a class="code" href="structtinkerdata.html">tinkerdata</a> *data;
00051   <font class="keywordtype">int</font> i;
00052 
00053   fd = fopen(filename, <font class="stringliteral">"rb"</font>);
00054   <font class="keywordflow">if</font> (!fd) <font class="keywordflow">return</font> NULL;
00055   
00056   data = (<a class="code" href="structtinkerdata.html">tinkerdata</a> *)malloc(<font class="keyword">sizeof</font>(<a class="code" href="structtinkerdata.html">tinkerdata</a>));
00057   data-&gt;<a class="code" href="structtinkerdata.html#m0">file</a> = fd;
00058   data-&gt;<a class="code" href="structtinkerdata.html#m2">file_name</a> = strdup(filename);
00059 
00060   <font class="comment">/* First line is the number of atoms, followed by other stuff */</font>
00061   i = fscanf(data-&gt;<a class="code" href="structtinkerdata.html#m0">file</a>, <font class="stringliteral">"%d"</font>, natoms);
00062   <font class="keywordflow">if</font> (i &lt; 1) {
00063     fprintf(stderr, <font class="stringliteral">"\n\nread) ERROR: tinker file '%s' should have the number of atoms in the first line.\n"</font>, filename);
00064     <font class="keywordflow">return</font> NULL;
00065   }
00066   data-&gt;<a class="code" href="structtinkerdata.html#m1">numatoms</a>=*natoms;
00067 
00068   <font class="keywordflow">while</font> (getc(fd) != <font class="charliteral">'\n'</font>); <font class="comment">/* skip rest of this line */</font>
00069   
00070   <font class="keywordflow">return</font> data;
00071 }
00072 
<a name="l00073"></a><a class="code" href="tinkerplugin_8c.html#a2">00073</a> <font class="keyword">static</font> <font class="keywordtype">int</font> <a class="code" href="tinkerplugin_8c.html#a2">read_tinker_structure</a>(<font class="keywordtype">void</font> *mydata, <font class="keywordtype">int</font> *optflags, 
00074                               <a class="code" href="structmolfile__atom__t.html">molfile_atom_t</a> *atoms) {
00075   <font class="keywordtype">int</font> i, j, atomid;
00076   <font class="keywordtype">char</font> *k;
00077   <font class="keywordtype">float</font> coord;
00078   <a class="code" href="structmolfile__atom__t.html">molfile_atom_t</a> *atom;
00079   <a class="code" href="structtinkerdata.html">tinkerdata</a> *data = (<a class="code" href="structtinkerdata.html">tinkerdata</a> *)mydata;
00080 
00081   <font class="keywordflow">for</font> (i=0; i&lt;data-&gt;<a class="code" href="structtinkerdata.html#m1">numatoms</a>; i++) {
00082     <font class="keywordtype">char</font> buffer[1024], fbuffer[1024];
00083     k = fgets(fbuffer, 1024, data-&gt;<a class="code" href="structtinkerdata.html#m0">file</a>);
00084     atom = atoms + i;
00085     j=sscanf(fbuffer, <font class="stringliteral">"%d %s %f %f %f"</font>, &amp;atomid, buffer, &amp;coord, &amp;coord, &amp;coord);
00086     <font class="keywordflow">if</font> (k == NULL) {
00087       fprintf(stderr, <font class="stringliteral">"tinker structure) missing atom(s) in file '%s'\n"</font>, data-&gt;<a class="code" href="structtinkerdata.html#m2">file_name</a>);
00088       fprintf(stderr, <font class="stringliteral">"tinker structure) expecting '%d' atoms, found only '%d'\n"</font>, data-&gt;<a class="code" href="structtinkerdata.html#m1">numatoms</a>, i+1);
00089       <font class="keywordflow">return</font> <a class="code" href="molfile__plugin_8h.html#a4">MOLFILE_ERROR</a>;
00090     } <font class="keywordflow">else</font> <font class="keywordflow">if</font> (j &lt; 5) {
00091       fprintf(stderr, <font class="stringliteral">"tinker structure) missing type or coordinate(s) in file '%s' for atom '%d'\n"</font>, data-&gt;<a class="code" href="structtinkerdata.html#m2">file_name</a>, i+1);
00092       <font class="keywordflow">return</font> <a class="code" href="molfile__plugin_8h.html#a4">MOLFILE_ERROR</a>;
00093     }
00094 
00095     strncpy(atom-&gt;<a class="code" href="structmolfile__atom__t.html#m0">name</a>, buffer, <font class="keyword">sizeof</font>(atom-&gt;<a class="code" href="structmolfile__atom__t.html#m0">name</a>));
00096     strncpy(atom-&gt;<a class="code" href="structmolfile__atom__t.html#m1">type</a>, atom-&gt;<a class="code" href="structmolfile__atom__t.html#m0">name</a>, <font class="keyword">sizeof</font>(atom-&gt;<a class="code" href="structmolfile__atom__t.html#m1">type</a>));
00097     atom-&gt;<a class="code" href="structmolfile__atom__t.html#m2">resname</a>[0] = <font class="charliteral">'\0'</font>;
00098     atom-&gt;<a class="code" href="structmolfile__atom__t.html#m3">resid</a> = 1;
00099     atom-&gt;<a class="code" href="structmolfile__atom__t.html#m5">chain</a>[0] = <font class="charliteral">'\0'</font>;
00100     atom-&gt;<a class="code" href="structmolfile__atom__t.html#m4">segid</a>[0] = <font class="charliteral">'\0'</font>;
00101   }
00102 
00103   rewind(data-&gt;<a class="code" href="structtinkerdata.html#m0">file</a>);
00104   <font class="keywordflow">return</font> <a class="code" href="molfile__plugin_8h.html#a2">MOLFILE_SUCCESS</a>;
00105 }
00106 
<a name="l00107"></a><a class="code" href="tinkerplugin_8c.html#a3">00107</a> <font class="keyword">static</font> <font class="keywordtype">int</font> <a class="code" href="tinkerplugin_8c.html#a3">read_tinker_timestep</a>(<font class="keywordtype">void</font> *mydata, <font class="keywordtype">int</font> natoms, <a class="code" href="structmolfile__timestep__t.html">molfile_timestep_t</a> *ts) {
00108   <font class="keywordtype">int</font> i, j, atomid;
00109   <font class="keywordtype">char</font> atom_name[1024], fbuffer[1024], *k;
00110   <font class="keywordtype">float</font> x, y, z;
00111   
00112   <a class="code" href="structtinkerdata.html">tinkerdata</a> *data = (<a class="code" href="structtinkerdata.html">tinkerdata</a> *)mydata;
00113   
00114   <font class="comment">/* skip over the first line */</font>
00115   <font class="keywordflow">if</font> (NULL == fgets(fbuffer, 1024, data-&gt;<a class="code" href="structtinkerdata.html#m0">file</a>))  <font class="keywordflow">return</font> <a class="code" href="molfile__plugin_8h.html#a4">MOLFILE_ERROR</a>;
00116 
00117   <font class="comment">/* read the coordinates */</font>
00118   <font class="keywordflow">for</font> (i=0; i&lt;natoms; i++) {
00119     k = fgets(fbuffer, 1024, data-&gt;<a class="code" href="structtinkerdata.html#m0">file</a>);
00120 
00121     <font class="comment">/* Read in atom type, X, Y, Z, skipping any remaining data fields */</font>
00122     j = sscanf(fbuffer, <font class="stringliteral">"%d %s %f %f %f"</font>, &amp;atomid, atom_name, &amp;x, &amp;y, &amp;z);
00123     <font class="keywordflow">if</font> (k == NULL) {
00124       <font class="keywordflow">return</font> <a class="code" href="molfile__plugin_8h.html#a4">MOLFILE_ERROR</a>;
00125     } <font class="keywordflow">else</font> <font class="keywordflow">if</font> (j &lt; 5) {
00126       fprintf(stderr, <font class="stringliteral">"tinker timestep) missing type or coordinate(s) in file '%s' for atom '%d'\n"</font>,data-&gt;<a class="code" href="structtinkerdata.html#m2">file_name</a>,i+1);
00127       <font class="keywordflow">return</font> <a class="code" href="molfile__plugin_8h.html#a4">MOLFILE_ERROR</a>;
00128     } <font class="keywordflow">else</font> <font class="keywordflow">if</font> (j &gt;= 5) {
00129       <font class="keywordflow">if</font> (ts != NULL) { 
00130         <font class="comment">/* only save coords if we're given a timestep pointer, */</font>
00131         <font class="comment">/* otherwise assume that VMD wants us to skip past it. */</font>
00132         ts-&gt;<a class="code" href="structmolfile__timestep__t.html#m0">coords</a>[3*i  ] = x;
00133         ts-&gt;<a class="code" href="structmolfile__timestep__t.html#m0">coords</a>[3*i+1] = y;
00134         ts-&gt;<a class="code" href="structmolfile__timestep__t.html#m0">coords</a>[3*i+2] = z;
00135       }
00136     } <font class="keywordflow">else</font> {
00137       <font class="keywordflow">break</font>;
00138     }
00139   }
00140   
00141   <font class="keywordflow">return</font> <a class="code" href="molfile__plugin_8h.html#a2">MOLFILE_SUCCESS</a>;
00142 }
00143     
<a name="l00144"></a><a class="code" href="tinkerplugin_8c.html#a4">00144</a> <font class="keyword">static</font> <font class="keywordtype">void</font> <a class="code" href="tinkerplugin_8c.html#a4">close_tinker_read</a>(<font class="keywordtype">void</font> *mydata) {
00145   <a class="code" href="structtinkerdata.html">tinkerdata</a> *data = (<a class="code" href="structtinkerdata.html">tinkerdata</a> *)mydata;
00146   fclose(data-&gt;<a class="code" href="structtinkerdata.html#m0">file</a>);
00147   free(data-&gt;<a class="code" href="structtinkerdata.html#m2">file_name</a>);
00148   free(data);
00149 }
00150 
00151 <font class="comment">/* registration stuff */</font>
<a name="l00152"></a><a class="code" href="tinkerplugin_8c.html#a0">00152</a> <font class="keyword">static</font> <a class="code" href="structmolfile__plugin__t.html">molfile_plugin_t</a> <a class="code" href="tinkerplugin_8c.html#a0">tinkerplugin</a> = {
00153   <a class="code" href="vmdplugin_8h.html#a10">vmdplugin_ABIVERSION</a>,
00154   <a class="code" href="molfile__plugin_8h.html#a0">MOLFILE_PLUGIN_TYPE</a>,                         <font class="comment">/* type */</font>
00155   <font class="stringliteral">"tinker"</font>,                                    <font class="comment">/* name */</font>
00156   <font class="stringliteral">"Tinker"</font>,                                    <font class="comment">/* name */</font>
00157   <font class="stringliteral">"John E. Stone"</font>,                             <font class="comment">/* author */</font>
00158   0,                                           <font class="comment">/* major version */</font>
00159   3,                                           <font class="comment">/* minor version */</font>
00160   <a class="code" href="vmdplugin_8h.html#a12">VMDPLUGIN_THREADSAFE</a>,                        <font class="comment">/* is reentrant */</font>
00161   <font class="stringliteral">"arc"</font>,
00162   <a class="code" href="tinkerplugin_8c.html#a1">open_tinker_read</a>,
00163   <a class="code" href="tinkerplugin_8c.html#a2">read_tinker_structure</a>,
00164   0,
00165   <a class="code" href="tinkerplugin_8c.html#a3">read_tinker_timestep</a>,
00166   <a class="code" href="tinkerplugin_8c.html#a4">close_tinker_read</a>,
00167   0,
00168   0,
00169   0,
00170   0,
00171   0,                            <font class="comment">/* read_volumetric_metadata */</font>
00172   0,                            <font class="comment">/* read_volumetric_data */</font>
00173   0                             <font class="comment">/* read_rawgraphics */</font>
00174 };
00175 
<a name="l00176"></a><a class="code" href="tinkerplugin_8c.html#a5">00176</a> <a class="code" href="vmdplugin_8h.html#a7">VMDPLUGIN_API</a> <font class="keywordtype">int</font> <a class="code" href="vmdplugin_8h.html#a5">VMDPLUGIN_init</a>() {
00177   <font class="keywordflow">return</font> <a class="code" href="vmdplugin_8h.html#a13">VMDPLUGIN_SUCCESS</a>;
00178 }
00179 
<a name="l00180"></a><a class="code" href="tinkerplugin_8c.html#a6">00180</a> <a class="code" href="vmdplugin_8h.html#a7">VMDPLUGIN_API</a> <font class="keywordtype">int</font> <a class="code" href="vmdplugin_8h.html#a3">VMDPLUGIN_register</a>(<font class="keywordtype">void</font> *v, <a class="code" href="vmdplugin_8h.html#a15">vmdplugin_register_cb</a> cb) {
00181   (*cb)(v, (<a class="code" href="structvmdplugin__t.html">vmdplugin_t</a> *)&amp;tinkerplugin);
00182   <font class="keywordflow">return</font> <a class="code" href="vmdplugin_8h.html#a13">VMDPLUGIN_SUCCESS</a>;
00183 }
00184 
<a name="l00185"></a><a class="code" href="tinkerplugin_8c.html#a7">00185</a> <a class="code" href="vmdplugin_8h.html#a7">VMDPLUGIN_API</a> <font class="keywordtype">int</font> <a class="code" href="vmdplugin_8h.html#a6">VMDPLUGIN_fini</a>() {
00186   <font class="keywordflow">return</font> <a class="code" href="vmdplugin_8h.html#a13">VMDPLUGIN_SUCCESS</a>;
00187 }
00188 
00189 
00190 <font class="preprocessor">#ifdef TEST_PLUGIN</font>
00191 <font class="preprocessor"></font>
00192 <font class="keywordtype">int</font> <a class="code" href="main_8c.html#a3">main</a>(<font class="keywordtype">int</font> argc, <font class="keywordtype">char</font> *argv[]) {
00193   <a class="code" href="structmolfile__timestep__t.html">molfile_timestep_t</a> timestep;
00194   <font class="keywordtype">void</font> *v;
00195   <font class="keywordtype">int</font> natoms;
00196   <font class="keywordtype">int</font> i, nsets, set;
00197 
00198   <font class="keywordflow">while</font> (--argc) {
00199     ++argv;
00200     v = <a class="code" href="tinkerplugin_8c.html#a1">open_tinker_read</a>(*argv, <font class="stringliteral">"tinker"</font>, &amp;natoms);
00201     <font class="keywordflow">if</font> (!v) {
00202       fprintf(stderr, <font class="stringliteral">"open_tinker_read failed for file %s\n"</font>, *argv);
00203       <font class="keywordflow">return</font> 1;
00204     }
00205     fprintf(stderr, <font class="stringliteral">"open_tinker_read succeeded for file %s\n"</font>, *argv);
00206     fprintf(stderr, <font class="stringliteral">"number of atoms: %d\n"</font>, natoms);
00207 
00208     i = 0;
00209     timestep.<a class="code" href="structmolfile__timestep__t.html#m0">coords</a> = (<font class="keywordtype">float</font> *)malloc(3*<font class="keyword">sizeof</font>(<font class="keywordtype">float</font>)*natoms);
00210     <font class="keywordflow">while</font> (!<a class="code" href="tinkerplugin_8c.html#a3">read_tinker_timestep</a>(v, natoms, &amp;timestep)) {
00211       i++;
00212     }
00213     fprintf(stderr, <font class="stringliteral">"ended read_next_timestep on frame %d\n"</font>, i);
00214 
00215     <a class="code" href="tinkerplugin_8c.html#a4">close_tinker_read</a>(v);
00216   }
00217   <font class="keywordflow">return</font> 0;
00218 }
00219 
00220 <font class="preprocessor">#endif</font>
00221 <font class="preprocessor"></font>
</pre></div><hr><address><small>Generated on Wed Mar 22 13:15:31 2006 for VMD Plugins (current) by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.gif" alt="doxygen" align="middle" border=0 
width=110 height=53></a>1.2.14 written by <a href="mailto:dimitri@stack.nl">Dimitri van Heesch</a>,
 &copy;&nbsp;1997-2002</small></address>
</body>
</html>
