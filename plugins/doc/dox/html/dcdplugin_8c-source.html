<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>dcdplugin.c Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.2.14 -->
<center>
<a class="qindex" href="index.html">Main Page</a> &nbsp; <a class="qindex" href="classes.html">Alphabetical List</a> &nbsp; <a class="qindex" href="annotated.html">Compound List</a> &nbsp; <a class="qindex" href="files.html">File List</a> &nbsp; <a class="qindex" href="functions.html">Compound Members</a> &nbsp; <a class="qindex" href="globals.html">File Members</a> &nbsp; <a class="qindex" href="pages.html">Related Pages</a> &nbsp; </center>
<hr><h1>dcdplugin.c</h1><a href="dcdplugin_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 <font class="comment">/***************************************************************************</font>
00002 <font class="comment"> *cr                                                                       </font>
00003 <font class="comment"> *cr            (C) Copyright 1995-2006 The Board of Trustees of the           </font>
00004 <font class="comment"> *cr                        University of Illinois                       </font>
00005 <font class="comment"> *cr                         All Rights Reserved                        </font>
00006 <font class="comment"> *cr                                                                   </font>
00007 <font class="comment"> ***************************************************************************/</font>
00008 
00009 <font class="comment">/***************************************************************************</font>
00010 <font class="comment"> * RCS INFORMATION:</font>
00011 <font class="comment"> *</font>
00012 <font class="comment"> *      $RCSfile: dcdplugin.c,v $</font>
00013 <font class="comment"> *      $Author: johns $       $Locker:  $             $State: Exp $</font>
00014 <font class="comment"> *      $Revision: 1.68 $       $Date: 2006/03/16 21:45:00 $</font>
00015 <font class="comment"> *</font>
00016 <font class="comment"> ***************************************************************************</font>
00017 <font class="comment"> * DESCRIPTION:</font>
00018 <font class="comment"> *   Code for reading and writing CHARMM, NAMD, and X-PLOR format </font>
00019 <font class="comment"> *   molecular dynamic trajectory files.</font>
00020 <font class="comment"> *</font>
00021 <font class="comment"> * TODO:</font>
00022 <font class="comment"> *   Integrate improvements from the NAMD source tree</font>
00023 <font class="comment"> *    - NAMD's writer code has better type-correctness for the sizes</font>
00024 <font class="comment"> *      of "int".  NAMD uses "int32" explicitly, which is required on</font>
00025 <font class="comment"> *      machines like the T3E.  VMD's version of the code doesn't do that</font>
00026 <font class="comment"> *      presently.</font>
00027 <font class="comment"> *</font>
00028 <font class="comment"> *  Try various alternative I/O API options:</font>
00029 <font class="comment"> *   - use mmap(), with read-once flags</font>
00030 <font class="comment"> *   - use O_DIRECT open mode on new revs of Linux kernel </font>
00031 <font class="comment"> *   - use directio() call on a file descriptor to enable on Solaris</font>
00032 <font class="comment"> *   - use aio_open()/read()/write()</font>
00033 <font class="comment"> *   - use readv/writev() etc.</font>
00034 <font class="comment"> *</font>
00035 <font class="comment"> *  Standalone test binary compilation flags:</font>
00036 <font class="comment"> *  cc -fast -xarch=v9a -I../../include -DTEST_DCDPLUGIN dcdplugin.c \</font>
00037 <font class="comment"> *    -o ~/bin/readdcd -lm</font>
00038 <font class="comment"> *</font>
00039 <font class="comment"> *  Profiling flags:</font>
00040 <font class="comment"> *  cc -xpg -fast -xarch=v9a -g -I../../include -DTEST_DCDPLUGIN dcdplugin.c \</font>
00041 <font class="comment"> *    -o ~/bin/readdcd -lm</font>
00042 <font class="comment"> *</font>
00043 <font class="comment"> ***************************************************************************/</font>
00044 
00045 <font class="preprocessor">#include "<a class="code" href="largefiles_8h.html">largefiles.h</a>"</font>   <font class="comment">/* platform dependent 64-bit file I/O defines */</font>
00046 
00047 <font class="preprocessor">#include &lt;stdio.h&gt;</font>
00048 <font class="preprocessor">#include &lt;sys/stat.h&gt;</font>
00049 <font class="preprocessor">#include &lt;sys/types.h&gt;</font>
00050 <font class="preprocessor">#include &lt;stdlib.h&gt;</font>
00051 <font class="preprocessor">#include &lt;string.h&gt;</font>
00052 <font class="preprocessor">#include &lt;math.h&gt;</font>
00053 <font class="preprocessor">#include &lt;time.h&gt;</font>
00054 <font class="preprocessor">#include "<a class="code" href="endianswap_8h.html">endianswap.h</a>"</font>
00055 <font class="preprocessor">#include "<a class="code" href="fastio_8h.html">fastio.h</a>"</font>
00056 <font class="preprocessor">#include "<a class="code" href="molfile__plugin_8h.html">molfile_plugin.h</a>"</font>
00057 
00058 <font class="preprocessor">#ifndef M_PI_2</font>
<a name="l00059"></a><a class="code" href="dcdplugin_8c.html#a0">00059</a> <font class="preprocessor"></font><font class="preprocessor">#define M_PI_2 1.57079632679489661922</font>
00060 <font class="preprocessor"></font><font class="preprocessor">#endif</font>
00061 <font class="preprocessor"></font>
<a name="l00062"></a><a class="code" href="dcdplugin_8c.html#a1">00062</a> <font class="preprocessor">#define RECSCALE32BIT 1</font>
<a name="l00063"></a><a class="code" href="dcdplugin_8c.html#a2">00063</a> <font class="preprocessor"></font><font class="preprocessor">#define RECSCALE64BIT 2</font>
<a name="l00064"></a><a class="code" href="dcdplugin_8c.html#a3">00064</a> <font class="preprocessor"></font><font class="preprocessor">#define RECSCALEMAX   2</font>
00065 <font class="preprocessor"></font>
<a name="l00066"></a><a class="code" href="structdcdhandle.html">00066</a> <font class="keyword">typedef</font> <font class="keyword">struct </font>{
<a name="l00067"></a><a class="code" href="structdcdhandle.html#m0">00067</a>   <a class="code" href="fastio_8h.html#a5">fio_fd</a> fd;
<a name="l00068"></a><a class="code" href="structdcdhandle.html#m1">00068</a>   <font class="keywordtype">int</font> natoms;
<a name="l00069"></a><a class="code" href="structdcdhandle.html#m2">00069</a>   <font class="keywordtype">int</font> nsets;
<a name="l00070"></a><a class="code" href="structdcdhandle.html#m3">00070</a>   <font class="keywordtype">int</font> setsread;
<a name="l00071"></a><a class="code" href="structdcdhandle.html#m4">00071</a>   <font class="keywordtype">int</font> istart;
<a name="l00072"></a><a class="code" href="structdcdhandle.html#m5">00072</a>   <font class="keywordtype">int</font> nsavc;
<a name="l00073"></a><a class="code" href="structdcdhandle.html#m6">00073</a>   <font class="keywordtype">double</font> delta;
<a name="l00074"></a><a class="code" href="structdcdhandle.html#m7">00074</a>   <font class="keywordtype">int</font> nfixed;
<a name="l00075"></a><a class="code" href="structdcdhandle.html#m10">00075</a>   <font class="keywordtype">float</font> *x, *y, *z;
<a name="l00076"></a><a class="code" href="structdcdhandle.html#m11">00076</a>   <font class="keywordtype">int</font> *freeind;
<a name="l00077"></a><a class="code" href="structdcdhandle.html#m12">00077</a>   <font class="keywordtype">float</font> *fixedcoords;
<a name="l00078"></a><a class="code" href="structdcdhandle.html#m13">00078</a>   <font class="keywordtype">int</font> reverse;
<a name="l00079"></a><a class="code" href="structdcdhandle.html#m14">00079</a>   <font class="keywordtype">int</font> charmm;  
<a name="l00080"></a><a class="code" href="structdcdhandle.html#m15">00080</a>   <font class="keywordtype">int</font> first;
<a name="l00081"></a><a class="code" href="structdcdhandle.html#m16">00081</a>   <font class="keywordtype">int</font> with_unitcell;
00082 } <a class="code" href="structdcdhandle.html">dcdhandle</a>;
00083 
00084 <font class="comment">/* Define error codes that may be returned by the DCD routines */</font>
<a name="l00085"></a><a class="code" href="dcdplugin_8c.html#a4">00085</a> <font class="preprocessor">#define DCD_SUCCESS      0  </font><font class="comment">/* No problems                     */</font>
<a name="l00086"></a><a class="code" href="dcdplugin_8c.html#a5">00086</a> <font class="preprocessor">#define DCD_EOF         -1  </font><font class="comment">/* Normal EOF                      */</font>
<a name="l00087"></a><a class="code" href="dcdplugin_8c.html#a6">00087</a> <font class="preprocessor">#define DCD_DNE         -2  </font><font class="comment">/* DCD file does not exist         */</font>
<a name="l00088"></a><a class="code" href="dcdplugin_8c.html#a7">00088</a> <font class="preprocessor">#define DCD_OPENFAILED  -3  </font><font class="comment">/* Open of DCD file failed         */</font>
<a name="l00089"></a><a class="code" href="dcdplugin_8c.html#a8">00089</a> <font class="preprocessor">#define DCD_BADREAD     -4  </font><font class="comment">/* read call on DCD file failed    */</font>
<a name="l00090"></a><a class="code" href="dcdplugin_8c.html#a9">00090</a> <font class="preprocessor">#define DCD_BADEOF      -5  </font><font class="comment">/* premature EOF found in DCD file */</font>
<a name="l00091"></a><a class="code" href="dcdplugin_8c.html#a10">00091</a> <font class="preprocessor">#define DCD_BADFORMAT   -6  </font><font class="comment">/* format of DCD file is wrong     */</font>
<a name="l00092"></a><a class="code" href="dcdplugin_8c.html#a11">00092</a> <font class="preprocessor">#define DCD_FILEEXISTS  -7  </font><font class="comment">/* output file already exists      */</font>
<a name="l00093"></a><a class="code" href="dcdplugin_8c.html#a12">00093</a> <font class="preprocessor">#define DCD_BADMALLOC   -8  </font><font class="comment">/* malloc failed                   */</font>
<a name="l00094"></a><a class="code" href="dcdplugin_8c.html#a13">00094</a> <font class="preprocessor">#define DCD_BADWRITE    -9  </font><font class="comment">/* write call on DCD file failed   */</font>
00095 
00096 <font class="comment">/* Define feature flags for this DCD file */</font>
<a name="l00097"></a><a class="code" href="dcdplugin_8c.html#a14">00097</a> <font class="preprocessor">#define DCD_IS_CHARMM       0x01</font>
<a name="l00098"></a><a class="code" href="dcdplugin_8c.html#a15">00098</a> <font class="preprocessor"></font><font class="preprocessor">#define DCD_HAS_4DIMS       0x02</font>
<a name="l00099"></a><a class="code" href="dcdplugin_8c.html#a16">00099</a> <font class="preprocessor"></font><font class="preprocessor">#define DCD_HAS_EXTRA_BLOCK 0x04</font>
<a name="l00100"></a><a class="code" href="dcdplugin_8c.html#a17">00100</a> <font class="preprocessor"></font><font class="preprocessor">#define DCD_HAS_64BIT_REC   0x08</font>
00101 <font class="preprocessor"></font>
00102 <font class="comment">/* defines used by write_dcdstep */</font>
<a name="l00103"></a><a class="code" href="dcdplugin_8c.html#a18">00103</a> <font class="preprocessor">#define NFILE_POS 8L</font>
<a name="l00104"></a><a class="code" href="dcdplugin_8c.html#a19">00104</a> <font class="preprocessor"></font><font class="preprocessor">#define NSTEP_POS 20L</font>
00105 <font class="preprocessor"></font>
00106 <font class="comment">/* READ Macro to make porting easier */</font>
<a name="l00107"></a><a class="code" href="dcdplugin_8c.html#a20">00107</a> <font class="preprocessor">#define READ(fd, buf, size)  fio_fread(((void *) buf), (size), 1, (fd))</font>
00108 <font class="preprocessor"></font>
00109 <font class="comment">/* WRITE Macro to make porting easier */</font>
<a name="l00110"></a><a class="code" href="dcdplugin_8c.html#a21">00110</a> <font class="preprocessor">#define WRITE(fd, buf, size) fio_fwrite(((void *) buf), (size), 1, (fd))</font>
00111 <font class="preprocessor"></font>
00112 <font class="comment">/* XXX This is broken - fread never returns -1 */</font>
<a name="l00113"></a><a class="code" href="dcdplugin_8c.html#a22">00113</a> <font class="preprocessor">#define CHECK_FREAD(X, msg) if (X==-1) { return(DCD_BADREAD); }</font>
<a name="l00114"></a><a class="code" href="dcdplugin_8c.html#a23">00114</a> <font class="preprocessor"></font><font class="preprocessor">#define CHECK_FEOF(X, msg)  if (X==0)  { return(DCD_BADEOF); }</font>
00115 <font class="preprocessor"></font>
00116 
00117 <font class="comment">/* print DCD error in a human readable way */</font>
<a name="l00118"></a><a class="code" href="dcdplugin_8c.html#a25">00118</a> <font class="keyword">static</font> <font class="keywordtype">void</font> <a class="code" href="dcdplugin_8c.html#a25">print_dcderror</a>(<font class="keyword">const</font> <font class="keywordtype">char</font> *func, <font class="keywordtype">int</font> errcode) {
00119   <font class="keyword">const</font> <font class="keywordtype">char</font> *errstr;
00120 
00121   <font class="keywordflow">switch</font> (errcode) {
00122     <font class="keywordflow">case</font> <a class="code" href="dcdplugin_8c.html#a5">DCD_EOF</a>:         errstr = <font class="stringliteral">"end of file"</font>; <font class="keywordflow">break</font>;
00123     <font class="keywordflow">case</font> <a class="code" href="dcdplugin_8c.html#a6">DCD_DNE</a>:         errstr = <font class="stringliteral">"file not found"</font>; <font class="keywordflow">break</font>;
00124     <font class="keywordflow">case</font> <a class="code" href="dcdplugin_8c.html#a7">DCD_OPENFAILED</a>:  errstr = <font class="stringliteral">"file open failed"</font>; <font class="keywordflow">break</font>;
00125     <font class="keywordflow">case</font> <a class="code" href="dcdplugin_8c.html#a8">DCD_BADREAD</a>:     errstr = <font class="stringliteral">"error during read"</font>; <font class="keywordflow">break</font>;
00126     <font class="keywordflow">case</font> <a class="code" href="dcdplugin_8c.html#a9">DCD_BADEOF</a>:      errstr = <font class="stringliteral">"premature end of file"</font>; <font class="keywordflow">break</font>;
00127     <font class="keywordflow">case</font> <a class="code" href="dcdplugin_8c.html#a10">DCD_BADFORMAT</a>:   errstr = <font class="stringliteral">"corruption or unrecognized file structure"</font>; <font class="keywordflow">break</font>;
00128     <font class="keywordflow">case</font> <a class="code" href="dcdplugin_8c.html#a11">DCD_FILEEXISTS</a>:  errstr = <font class="stringliteral">"output file already exists"</font>; <font class="keywordflow">break</font>;
00129     <font class="keywordflow">case</font> <a class="code" href="dcdplugin_8c.html#a12">DCD_BADMALLOC</a>:   errstr = <font class="stringliteral">"memory allocation failed"</font>; <font class="keywordflow">break</font>;
00130     <font class="keywordflow">case</font> <a class="code" href="dcdplugin_8c.html#a13">DCD_BADWRITE</a>:    errstr = <font class="stringliteral">"error during write"</font>; <font class="keywordflow">break</font>;
00131     <font class="keywordflow">case</font> <a class="code" href="dcdplugin_8c.html#a4">DCD_SUCCESS</a>:     
00132     <font class="keywordflow">default</font>:
00133       errstr = <font class="stringliteral">"no error"</font>;
00134       <font class="keywordflow">break</font>;
00135   } 
00136   printf(<font class="stringliteral">"dcdplugin) %s: %s\n"</font>, func, errstr); 
00137 }
00138 
00139 
00140 <font class="comment">/*</font>
00141 <font class="comment"> * Read the header information from a dcd file.</font>
00142 <font class="comment"> * Input: fd - a file struct opened for binary reading.</font>
00143 <font class="comment"> * Output: 0 on success, negative error code on failure.</font>
00144 <font class="comment"> * Side effects: *natoms set to number of atoms per frame</font>
00145 <font class="comment"> *               *nsets set to number of frames in dcd file</font>
00146 <font class="comment"> *               *istart set to starting timestep of dcd file</font>
00147 <font class="comment"> *               *nsavc set to timesteps between dcd saves</font>
00148 <font class="comment"> *               *delta set to value of trajectory timestep</font>
00149 <font class="comment"> *               *nfixed set to number of fixed atoms </font>
00150 <font class="comment"> *               *freeind may be set to heap-allocated space</font>
00151 <font class="comment"> *               *reverse set to one if reverse-endian, zero if not.</font>
00152 <font class="comment"> *               *charmm set to internal code for handling charmm data.</font>
00153 <font class="comment"> */</font>
<a name="l00154"></a><a class="code" href="dcdplugin_8c.html#a26">00154</a> <font class="keyword">static</font> <font class="keywordtype">int</font> <a class="code" href="dcdplugin_8c.html#a26">read_dcdheader</a>(<a class="code" href="fastio_8h.html#a5">fio_fd</a> fd, <font class="keywordtype">int</font> *N, <font class="keywordtype">int</font> *NSET, <font class="keywordtype">int</font> *ISTART, 
00155                    <font class="keywordtype">int</font> *NSAVC, <font class="keywordtype">double</font> *DELTA, <font class="keywordtype">int</font> *NAMNF, 
00156                    <font class="keywordtype">int</font> **FREEINDEXES, <font class="keywordtype">float</font> **fixedcoords, <font class="keywordtype">int</font> *reverseEndian, 
00157                    <font class="keywordtype">int</font> *charmm)
00158 {
00159   <font class="keywordtype">unsigned</font> <font class="keywordtype">int</font> input_integer[2];  <font class="comment">/* buffer space */</font>
00160   <font class="keywordtype">int</font> i, ret_val, rec_scale;
00161   <font class="keywordtype">char</font> hdrbuf[84];    <font class="comment">/* char buffer used to store header */</font>
00162   <font class="keywordtype">int</font> NTITLE;
00163   <font class="keywordtype">int</font> dcdcordmagic;
00164   <font class="keywordtype">char</font> *corp = (<font class="keywordtype">char</font> *) &amp;dcdcordmagic;
00165 
00166   <font class="comment">/* coordinate dcd file magic string 'CORD' */</font>
00167   corp[0] = <font class="charliteral">'C'</font>;
00168   corp[1] = <font class="charliteral">'O'</font>;
00169   corp[2] = <font class="charliteral">'R'</font>;
00170   corp[3] = <font class="charliteral">'D'</font>;
00171 
00172   <font class="comment">/* First thing in the file should be an 84.</font>
00173 <font class="comment">   * some 64-bit compiles have a 64-bit record length indicator,</font>
00174 <font class="comment">   * so we have to read two ints and check in a more complicated </font>
00175 <font class="comment">   * way. :-( */</font>
00176   ret_val = <a class="code" href="dcdplugin_8c.html#a20">READ</a>(fd, input_integer, 2*<font class="keyword">sizeof</font>(<font class="keywordtype">unsigned</font> <font class="keywordtype">int</font>));
00177   <a class="code" href="dcdplugin_8c.html#a22">CHECK_FREAD</a>(ret_val, <font class="stringliteral">"reading first int from dcd file"</font>);
00178   <a class="code" href="dcdplugin_8c.html#a23">CHECK_FEOF</a>(ret_val, <font class="stringliteral">"reading first int from dcd file"</font>);
00179 
00180   <font class="comment">/* Check magic number in file header and determine byte order*/</font>
00181   <font class="keywordflow">if</font> ((input_integer[0]+input_integer[1]) == 84) {
00182     *reverseEndian=0;
00183     rec_scale=<a class="code" href="dcdplugin_8c.html#a2">RECSCALE64BIT</a>;
00184     printf(<font class="stringliteral">"dcdplugin) detected CHARMM -i8 64-bit DCD file of native endianness\n"</font>);
00185   } <font class="keywordflow">else</font> <font class="keywordflow">if</font> (input_integer[0] == 84 &amp;&amp; input_integer[1] == dcdcordmagic) {
00186     *reverseEndian=0;
00187     rec_scale=<a class="code" href="dcdplugin_8c.html#a1">RECSCALE32BIT</a>;
00188     printf(<font class="stringliteral">"dcdplugin) detected standard 32-bit DCD file of native endianness\n"</font>);
00189   } <font class="keywordflow">else</font> {
00190     <font class="comment">/* now try reverse endian */</font>
00191     <a class="code" href="endianswap_8h.html#a4">swap4_aligned</a>(input_integer, 2); <font class="comment">/* will have to unswap magic if 32-bit */</font>
00192     <font class="keywordflow">if</font> ((input_integer[0]+input_integer[1]) == 84) {
00193       *reverseEndian=1;
00194       rec_scale=<a class="code" href="dcdplugin_8c.html#a2">RECSCALE64BIT</a>;
00195       printf(<font class="stringliteral">"dcdplugin) detected CHARMM -i8 64-bit DCD file of opposite endianness\n"</font>);
00196     } <font class="keywordflow">else</font> {
00197       <a class="code" href="endianswap_8h.html#a4">swap4_aligned</a>(&amp;input_integer[1], 1); <font class="comment">/* unswap magic (see above) */</font>
00198       <font class="keywordflow">if</font> (input_integer[0] == 84 &amp;&amp; input_integer[1] == dcdcordmagic) {
00199         *reverseEndian=1;
00200         rec_scale=<a class="code" href="dcdplugin_8c.html#a1">RECSCALE32BIT</a>;
00201         printf(<font class="stringliteral">"dcdplugin) detected standard 32-bit DCD file of opposite endianness\n"</font>);
00202       } <font class="keywordflow">else</font> {
00203         <font class="comment">/* not simply reversed endianism or -i8, something rather more evil */</font>
00204         printf(<font class="stringliteral">"dcdplugin) unrecognized DCD header:\n"</font>);
00205         printf(<font class="stringliteral">"dcdplugin)   [0]: %10d  [1]: %10d\n"</font>, input_integer[0], input_integer[1]);
00206         printf(<font class="stringliteral">"dcdplugin)   [0]: 0x%08x  [1]: 0x%08x\n"</font>, input_integer[0], input_integer[1]);
00207         <font class="keywordflow">return</font> <a class="code" href="dcdplugin_8c.html#a10">DCD_BADFORMAT</a>;
00208 
00209       }
00210     }
00211   }
00212 
00213   <font class="comment">/* check for magic string, in case of long record markers */</font>
00214   <font class="keywordflow">if</font> (rec_scale == <a class="code" href="dcdplugin_8c.html#a2">RECSCALE64BIT</a>) { 
00215     ret_val = <a class="code" href="dcdplugin_8c.html#a20">READ</a>(fd, input_integer, <font class="keyword">sizeof</font>(<font class="keywordtype">unsigned</font> <font class="keywordtype">int</font>));
00216     <font class="keywordflow">if</font> (input_integer[0] != dcdcordmagic) {
00217       printf(<font class="stringliteral">"dcdplugin) failed to find CORD magic in CHARMM -i8 64-bit DCD file\n"</font>);
00218       <font class="keywordflow">return</font> <a class="code" href="dcdplugin_8c.html#a10">DCD_BADFORMAT</a>;
00219     }
00220   }
00221 
00222   <font class="comment">/* Buffer the entire header for random access */</font>
00223   ret_val = <a class="code" href="dcdplugin_8c.html#a20">READ</a>(fd, hdrbuf, 80);
00224   <a class="code" href="dcdplugin_8c.html#a22">CHECK_FREAD</a>(ret_val, <font class="stringliteral">"buffering header"</font>);
00225   <a class="code" href="dcdplugin_8c.html#a23">CHECK_FEOF</a>(ret_val, <font class="stringliteral">"buffering header"</font>);
00226 
00227   <font class="comment">/* CHARMm-genereate DCD files set the last integer in the     */</font>
00228   <font class="comment">/* header, which is unused by X-PLOR, to its version number.  */</font>
00229   <font class="comment">/* Checking if this is nonzero tells us this is a CHARMm file */</font>
00230   <font class="comment">/* and to look for other CHARMm flags.                        */</font>
00231   <font class="keywordflow">if</font> (*((<font class="keywordtype">int</font> *) (hdrbuf + 76)) != 0) {
00232     (*charmm) = <a class="code" href="dcdplugin_8c.html#a14">DCD_IS_CHARMM</a>;
00233     <font class="keywordflow">if</font> (*((<font class="keywordtype">int</font> *) (hdrbuf + 40)) != 0)
00234       (*charmm) |= <a class="code" href="dcdplugin_8c.html#a16">DCD_HAS_EXTRA_BLOCK</a>;
00235 
00236     <font class="keywordflow">if</font> (*((<font class="keywordtype">int</font> *) (hdrbuf + 44)) == 1)
00237       (*charmm) |= <a class="code" href="dcdplugin_8c.html#a15">DCD_HAS_4DIMS</a>;
00238 
00239     <font class="keywordflow">if</font> (rec_scale == <a class="code" href="dcdplugin_8c.html#a2">RECSCALE64BIT</a>)
00240       (*charmm) |= <a class="code" href="dcdplugin_8c.html#a17">DCD_HAS_64BIT_REC</a>;
00241   
00242   } <font class="keywordflow">else</font> {
00243     (*charmm) = 0;
00244   }
00245 
00246   <font class="comment">/* Store the number of sets of coordinates (NSET) */</font>
00247   (*NSET) = *((<font class="keywordtype">int</font> *) (hdrbuf));
00248   <font class="keywordflow">if</font> (*reverseEndian) <a class="code" href="endianswap_8h.html#a1">swap4_unaligned</a>(NSET, 1);
00249 
00250   <font class="comment">/* Store ISTART, the starting timestep */</font>
00251   (*ISTART) = *((<font class="keywordtype">int</font> *) (hdrbuf + 4));
00252   <font class="keywordflow">if</font> (*reverseEndian) <a class="code" href="endianswap_8h.html#a1">swap4_unaligned</a>(ISTART, 1);
00253 
00254   <font class="comment">/* Store NSAVC, the number of timesteps between dcd saves */</font>
00255   (*NSAVC) = *((<font class="keywordtype">int</font> *) (hdrbuf + 8));
00256   <font class="keywordflow">if</font> (*reverseEndian) <a class="code" href="endianswap_8h.html#a1">swap4_unaligned</a>(NSAVC, 1);
00257 
00258   <font class="comment">/* Store NAMNF, the number of fixed atoms */</font>
00259   (*NAMNF) = *((<font class="keywordtype">int</font> *) (hdrbuf + 32));
00260   <font class="keywordflow">if</font> (*reverseEndian) <a class="code" href="endianswap_8h.html#a1">swap4_unaligned</a>(NAMNF, 1);
00261 
00262   <font class="comment">/* Read in the timestep, DELTA */</font>
00263   <font class="comment">/* Note: DELTA is stored as a double with X-PLOR but as a float with CHARMm */</font>
00264   <font class="keywordflow">if</font> ((*charmm) &amp; <a class="code" href="dcdplugin_8c.html#a14">DCD_IS_CHARMM</a>) {
00265     <font class="keywordtype">float</font> ftmp;
00266     ftmp = *((<font class="keywordtype">float</font> *)(hdrbuf+36)); <font class="comment">/* is this safe on Alpha? */</font>
00267     <font class="keywordflow">if</font> (*reverseEndian)
00268       <a class="code" href="endianswap_8h.html#a4">swap4_aligned</a>(&amp;ftmp, 1);
00269 
00270     *DELTA = (double)ftmp;
00271   } <font class="keywordflow">else</font> {
00272     (*DELTA) = *((<font class="keywordtype">double</font> *)(hdrbuf + 36));
00273     <font class="keywordflow">if</font> (*reverseEndian) <a class="code" href="endianswap_8h.html#a2">swap8_unaligned</a>(DELTA, 1);
00274   }
00275 
00276   <font class="comment">/* Get the end size of the first block */</font>
00277   ret_val = <a class="code" href="dcdplugin_8c.html#a20">READ</a>(fd, input_integer, rec_scale*<font class="keyword">sizeof</font>(<font class="keywordtype">int</font>));
00278   <a class="code" href="dcdplugin_8c.html#a22">CHECK_FREAD</a>(ret_val, <font class="stringliteral">"reading second 84 from dcd file"</font>);
00279   <a class="code" href="dcdplugin_8c.html#a23">CHECK_FEOF</a>(ret_val, <font class="stringliteral">"reading second 84 from dcd file"</font>);
00280   <font class="keywordflow">if</font> (*reverseEndian) <a class="code" href="endianswap_8h.html#a4">swap4_aligned</a>(input_integer, rec_scale);
00281 
00282   <font class="keywordflow">if</font> (rec_scale == <a class="code" href="dcdplugin_8c.html#a2">RECSCALE64BIT</a>) {
00283     <font class="keywordflow">if</font> ((input_integer[0]+input_integer[1]) != 84) {
00284       <font class="keywordflow">return</font> <a class="code" href="dcdplugin_8c.html#a10">DCD_BADFORMAT</a>;
00285     }
00286   } <font class="keywordflow">else</font> {
00287     <font class="keywordflow">if</font> (input_integer[0] != 84) {
00288       <font class="keywordflow">return</font> <a class="code" href="dcdplugin_8c.html#a10">DCD_BADFORMAT</a>;
00289     }
00290   }
00291   
00292   <font class="comment">/* Read in the size of the next block */</font>
00293   input_integer[1] = 0;
00294   ret_val = <a class="code" href="dcdplugin_8c.html#a20">READ</a>(fd, input_integer, rec_scale*<font class="keyword">sizeof</font>(<font class="keywordtype">int</font>));
00295   <a class="code" href="dcdplugin_8c.html#a22">CHECK_FREAD</a>(ret_val, <font class="stringliteral">"reading size of title block"</font>);
00296   <a class="code" href="dcdplugin_8c.html#a23">CHECK_FEOF</a>(ret_val, <font class="stringliteral">"reading size of title block"</font>);
00297   <font class="keywordflow">if</font> (*reverseEndian) <a class="code" href="endianswap_8h.html#a4">swap4_aligned</a>(input_integer, rec_scale);
00298 
00299   <font class="keywordflow">if</font> ((((input_integer[0]+input_integer[1])-4) % 80) == 0) {
00300     <font class="comment">/* Read NTITLE, the number of 80 character title strings there are */</font>
00301     ret_val = <a class="code" href="dcdplugin_8c.html#a20">READ</a>(fd, &amp;NTITLE, <font class="keyword">sizeof</font>(<font class="keywordtype">int</font>));
00302     <a class="code" href="dcdplugin_8c.html#a22">CHECK_FREAD</a>(ret_val, <font class="stringliteral">"reading NTITLE"</font>);
00303     <a class="code" href="dcdplugin_8c.html#a23">CHECK_FEOF</a>(ret_val, <font class="stringliteral">"reading NTITLE"</font>);
00304     <font class="keywordflow">if</font> (*reverseEndian) <a class="code" href="endianswap_8h.html#a4">swap4_aligned</a>(&amp;NTITLE, 1);
00305 
00306     <font class="keywordflow">for</font> (i=0; i&lt;NTITLE; i++) {
00307       <a class="code" href="fastio_8h.html#a13">fio_fseek</a>(fd, 80, <a class="code" href="fastio_8h.html#a2">FIO_SEEK_CUR</a>);
00308       <a class="code" href="dcdplugin_8c.html#a23">CHECK_FEOF</a>(ret_val, <font class="stringliteral">"reading TITLE"</font>);
00309     }
00310 
00311     <font class="comment">/* Get the ending size for this block */</font>
00312     ret_val = <a class="code" href="dcdplugin_8c.html#a20">READ</a>(fd, input_integer, rec_scale*<font class="keyword">sizeof</font>(<font class="keywordtype">int</font>));
00313     <a class="code" href="dcdplugin_8c.html#a22">CHECK_FREAD</a>(ret_val, <font class="stringliteral">"reading size of title block"</font>);
00314     <a class="code" href="dcdplugin_8c.html#a23">CHECK_FEOF</a>(ret_val, <font class="stringliteral">"reading size of title block"</font>);
00315   } <font class="keywordflow">else</font> {
00316     <font class="keywordflow">return</font> <a class="code" href="dcdplugin_8c.html#a10">DCD_BADFORMAT</a>;
00317   }
00318 
00319   <font class="comment">/* Read in an integer '4' */</font>
00320   input_integer[1] = 0;
00321   ret_val = <a class="code" href="dcdplugin_8c.html#a20">READ</a>(fd, input_integer, rec_scale*<font class="keyword">sizeof</font>(<font class="keywordtype">int</font>));
00322   
00323   <a class="code" href="dcdplugin_8c.html#a22">CHECK_FREAD</a>(ret_val, <font class="stringliteral">"reading a '4'"</font>);
00324   <a class="code" href="dcdplugin_8c.html#a23">CHECK_FEOF</a>(ret_val, <font class="stringliteral">"reading a '4'"</font>);
00325   <font class="keywordflow">if</font> (*reverseEndian) <a class="code" href="endianswap_8h.html#a4">swap4_aligned</a>(input_integer, rec_scale);
00326 
00327   <font class="keywordflow">if</font> ((input_integer[0]+input_integer[1]) != 4) {
00328     <font class="keywordflow">return</font> <a class="code" href="dcdplugin_8c.html#a10">DCD_BADFORMAT</a>;
00329   }
00330 
00331   <font class="comment">/* Read in the number of atoms */</font>
00332   ret_val = <a class="code" href="dcdplugin_8c.html#a20">READ</a>(fd, N, <font class="keyword">sizeof</font>(<font class="keywordtype">int</font>));
00333   <a class="code" href="dcdplugin_8c.html#a22">CHECK_FREAD</a>(ret_val, <font class="stringliteral">"reading number of atoms"</font>);
00334   <a class="code" href="dcdplugin_8c.html#a23">CHECK_FEOF</a>(ret_val, <font class="stringliteral">"reading number of atoms"</font>);
00335   <font class="keywordflow">if</font> (*reverseEndian) <a class="code" href="endianswap_8h.html#a4">swap4_aligned</a>(N, 1);
00336 
00337   <font class="comment">/* Read in an integer '4' */</font>
00338   input_integer[1] = 0;
00339   ret_val = <a class="code" href="dcdplugin_8c.html#a20">READ</a>(fd, input_integer, rec_scale*<font class="keyword">sizeof</font>(<font class="keywordtype">int</font>));
00340   <a class="code" href="dcdplugin_8c.html#a22">CHECK_FREAD</a>(ret_val, <font class="stringliteral">"reading a '4'"</font>);
00341   <a class="code" href="dcdplugin_8c.html#a23">CHECK_FEOF</a>(ret_val, <font class="stringliteral">"reading a '4'"</font>);
00342   <font class="keywordflow">if</font> (*reverseEndian) <a class="code" href="endianswap_8h.html#a4">swap4_aligned</a>(input_integer, rec_scale);
00343 
00344   <font class="keywordflow">if</font> ((input_integer[0]+input_integer[1]) != 4) {
00345     <font class="keywordflow">return</font> <a class="code" href="dcdplugin_8c.html#a10">DCD_BADFORMAT</a>;
00346   }
00347 
00348   *FREEINDEXES = NULL;
00349   *fixedcoords = NULL;
00350   <font class="keywordflow">if</font> (*NAMNF != 0) {
00351     (*FREEINDEXES) = (<font class="keywordtype">int</font> *) calloc(((*N)-(*NAMNF)), <font class="keyword">sizeof</font>(<font class="keywordtype">int</font>));
00352     <font class="keywordflow">if</font> (*FREEINDEXES == NULL)
00353       <font class="keywordflow">return</font> <a class="code" href="dcdplugin_8c.html#a12">DCD_BADMALLOC</a>;
00354 
00355     *fixedcoords = (<font class="keywordtype">float</font> *) calloc((*N)*4 - (*NAMNF), <font class="keyword">sizeof</font>(<font class="keywordtype">float</font>));
00356     <font class="keywordflow">if</font> (*fixedcoords == NULL)
00357       <font class="keywordflow">return</font> <a class="code" href="dcdplugin_8c.html#a12">DCD_BADMALLOC</a>;
00358 
00359     <font class="comment">/* Read in index array size */</font>
00360     input_integer[1]=0;
00361     ret_val = <a class="code" href="dcdplugin_8c.html#a20">READ</a>(fd, input_integer, rec_scale*<font class="keyword">sizeof</font>(<font class="keywordtype">int</font>));
00362     <a class="code" href="dcdplugin_8c.html#a22">CHECK_FREAD</a>(ret_val, <font class="stringliteral">"reading size of index array"</font>);
00363     <a class="code" href="dcdplugin_8c.html#a23">CHECK_FEOF</a>(ret_val, <font class="stringliteral">"reading size of index array"</font>);
00364     <font class="keywordflow">if</font> (*reverseEndian) <a class="code" href="endianswap_8h.html#a4">swap4_aligned</a>(input_integer, rec_scale);
00365 
00366     <font class="keywordflow">if</font> ((input_integer[0]+input_integer[1]) != ((*N)-(*NAMNF))*4) {
00367       <font class="keywordflow">return</font> <a class="code" href="dcdplugin_8c.html#a10">DCD_BADFORMAT</a>;
00368     }
00369 
00370     ret_val = <a class="code" href="dcdplugin_8c.html#a20">READ</a>(fd, (*FREEINDEXES), ((*N)-(*NAMNF))*<font class="keyword">sizeof</font>(<font class="keywordtype">int</font>));
00371     <a class="code" href="dcdplugin_8c.html#a22">CHECK_FREAD</a>(ret_val, <font class="stringliteral">"reading size of index array"</font>);
00372     <a class="code" href="dcdplugin_8c.html#a23">CHECK_FEOF</a>(ret_val, <font class="stringliteral">"reading size of index array"</font>);
00373 
00374     <font class="keywordflow">if</font> (*reverseEndian)
00375       <a class="code" href="endianswap_8h.html#a4">swap4_aligned</a>((*FREEINDEXES), ((*N)-(*NAMNF)));
00376 
00377     input_integer[1]=0;
00378     ret_val = <a class="code" href="dcdplugin_8c.html#a20">READ</a>(fd, input_integer, rec_scale*<font class="keyword">sizeof</font>(<font class="keywordtype">int</font>));
00379     <a class="code" href="dcdplugin_8c.html#a22">CHECK_FREAD</a>(ret_val, <font class="stringliteral">"reading size of index array"</font>);
00380     <a class="code" href="dcdplugin_8c.html#a23">CHECK_FEOF</a>(ret_val, <font class="stringliteral">"reading size of index array"</font>);
00381     <font class="keywordflow">if</font> (*reverseEndian) <a class="code" href="endianswap_8h.html#a4">swap4_aligned</a>(input_integer, rec_scale);
00382 
00383     <font class="keywordflow">if</font> ((input_integer[0]+input_integer[1]) != ((*N)-(*NAMNF))*4) {
00384       <font class="keywordflow">return</font> <a class="code" href="dcdplugin_8c.html#a10">DCD_BADFORMAT</a>;
00385     }
00386   }
00387 
00388   <font class="keywordflow">return</font> <a class="code" href="dcdplugin_8c.html#a4">DCD_SUCCESS</a>;
00389 }
00390 
<a name="l00391"></a><a class="code" href="dcdplugin_8c.html#a27">00391</a> <font class="keyword">static</font> <font class="keywordtype">int</font> <a class="code" href="dcdplugin_8c.html#a27">read_charmm_extrablock</a>(<a class="code" href="fastio_8h.html#a5">fio_fd</a> fd, <font class="keywordtype">int</font> charmm, <font class="keywordtype">int</font> reverseEndian,
00392                                   <font class="keywordtype">float</font> *unitcell) {
00393   <font class="keywordtype">int</font> i, input_integer[2], rec_scale;
00394 
00395   <font class="keywordflow">if</font> (charmm &amp; <a class="code" href="dcdplugin_8c.html#a17">DCD_HAS_64BIT_REC</a>) {
00396     rec_scale = <a class="code" href="dcdplugin_8c.html#a2">RECSCALE64BIT</a>;
00397   } <font class="keywordflow">else</font> {
00398     rec_scale = <a class="code" href="dcdplugin_8c.html#a1">RECSCALE32BIT</a>;
00399   }
00400 
00401   <font class="keywordflow">if</font> ((charmm &amp; <a class="code" href="dcdplugin_8c.html#a14">DCD_IS_CHARMM</a>) &amp;&amp; (charmm &amp; <a class="code" href="dcdplugin_8c.html#a16">DCD_HAS_EXTRA_BLOCK</a>)) {
00402     <font class="comment">/* Leading integer must be 48 */</font>
00403     input_integer[1] = 0;
00404     <font class="keywordflow">if</font> (<a class="code" href="fastio_8h.html#a10">fio_fread</a>(input_integer, <font class="keyword">sizeof</font>(<font class="keywordtype">int</font>), rec_scale, fd) != rec_scale)
00405       <font class="keywordflow">return</font> <a class="code" href="dcdplugin_8c.html#a8">DCD_BADREAD</a>; 
00406     <font class="keywordflow">if</font> (reverseEndian) <a class="code" href="endianswap_8h.html#a4">swap4_aligned</a>(input_integer, rec_scale);
00407     <font class="keywordflow">if</font> ((input_integer[0]+input_integer[1]) == 48) {
00408       <font class="keywordtype">double</font> tmp[6];
00409       <font class="keywordflow">if</font> (<a class="code" href="fastio_8h.html#a10">fio_fread</a>(tmp, 48, 1, fd) != 1) <font class="keywordflow">return</font> <a class="code" href="dcdplugin_8c.html#a8">DCD_BADREAD</a>;
00410       <font class="keywordflow">if</font> (reverseEndian) 
00411         <a class="code" href="endianswap_8h.html#a5">swap8_aligned</a>(tmp, 6);
00412       <font class="keywordflow">for</font> (i=0; i&lt;6; i++) unitcell[i] = (float)tmp[i];
00413     } <font class="keywordflow">else</font> {
00414       <font class="comment">/* unrecognized block, just skip it */</font>
00415       <font class="keywordflow">if</font> (<a class="code" href="fastio_8h.html#a13">fio_fseek</a>(fd, (input_integer[0]+input_integer[1]), <a class="code" href="fastio_8h.html#a2">FIO_SEEK_CUR</a>)) <font class="keywordflow">return</font> <a class="code" href="dcdplugin_8c.html#a8">DCD_BADREAD</a>;
00416     }
00417     <font class="keywordflow">if</font> (<a class="code" href="fastio_8h.html#a10">fio_fread</a>(input_integer, <font class="keyword">sizeof</font>(<font class="keywordtype">int</font>), rec_scale, fd) != rec_scale) <font class="keywordflow">return</font> <a class="code" href="dcdplugin_8c.html#a8">DCD_BADREAD</a>; 
00418   } 
00419 
00420   <font class="keywordflow">return</font> <a class="code" href="dcdplugin_8c.html#a4">DCD_SUCCESS</a>;
00421 }
00422 
<a name="l00423"></a><a class="code" href="dcdplugin_8c.html#a28">00423</a> <font class="keyword">static</font> <font class="keywordtype">int</font> <a class="code" href="dcdplugin_8c.html#a28">read_fixed_atoms</a>(<a class="code" href="fastio_8h.html#a5">fio_fd</a> fd, <font class="keywordtype">int</font> N, <font class="keywordtype">int</font> num_free, <font class="keyword">const</font> <font class="keywordtype">int</font> *indexes,
00424                             <font class="keywordtype">int</font> reverseEndian, <font class="keyword">const</font> <font class="keywordtype">float</font> *fixedcoords, 
00425                             <font class="keywordtype">float</font> *freeatoms, <font class="keywordtype">float</font> *pos, <font class="keywordtype">int</font> charmm) {
00426   <font class="keywordtype">int</font> i, input_integer[2], rec_scale;
00427   
00428   <font class="keywordflow">if</font>(charmm &amp; <a class="code" href="dcdplugin_8c.html#a17">DCD_HAS_64BIT_REC</a>) {
00429     rec_scale=<a class="code" href="dcdplugin_8c.html#a2">RECSCALE64BIT</a>;
00430   } <font class="keywordflow">else</font> {
00431     rec_scale=<a class="code" href="dcdplugin_8c.html#a1">RECSCALE32BIT</a>;
00432   }
00433   
00434   <font class="comment">/* Read leading integer */</font>
00435   input_integer[1]=0;
00436   <font class="keywordflow">if</font> (<a class="code" href="fastio_8h.html#a10">fio_fread</a>(input_integer, <font class="keyword">sizeof</font>(<font class="keywordtype">int</font>), rec_scale, fd) != rec_scale) <font class="keywordflow">return</font> <a class="code" href="dcdplugin_8c.html#a8">DCD_BADREAD</a>;
00437   <font class="keywordflow">if</font> (reverseEndian) <a class="code" href="endianswap_8h.html#a4">swap4_aligned</a>(input_integer, rec_scale);
00438   <font class="keywordflow">if</font> ((input_integer[0]+input_integer[1]) != 4*num_free) <font class="keywordflow">return</font> <a class="code" href="dcdplugin_8c.html#a10">DCD_BADFORMAT</a>;
00439   
00440   <font class="comment">/* Read free atom coordinates */</font>
00441   <font class="keywordflow">if</font> (<a class="code" href="fastio_8h.html#a10">fio_fread</a>(freeatoms, 4*num_free, 1, fd) != 1) <font class="keywordflow">return</font> <a class="code" href="dcdplugin_8c.html#a8">DCD_BADREAD</a>;
00442   <font class="keywordflow">if</font> (reverseEndian)
00443     <a class="code" href="endianswap_8h.html#a4">swap4_aligned</a>(freeatoms, num_free);
00444 
00445   <font class="comment">/* Copy fixed and free atom coordinates into position buffer */</font>
00446   memcpy(pos, fixedcoords, 4*N);
00447   <font class="keywordflow">for</font> (i=0; i&lt;num_free; i++)
00448     pos[indexes[i]-1] = freeatoms[i];
00449 
00450   <font class="comment">/* Read trailing integer */</font> 
00451   input_integer[1]=0;
00452   <font class="keywordflow">if</font> (<a class="code" href="fastio_8h.html#a10">fio_fread</a>(input_integer, <font class="keyword">sizeof</font>(<font class="keywordtype">int</font>), rec_scale, fd) != rec_scale) <font class="keywordflow">return</font> <a class="code" href="dcdplugin_8c.html#a8">DCD_BADREAD</a>;
00453   <font class="keywordflow">if</font> (reverseEndian) <a class="code" href="endianswap_8h.html#a4">swap4_aligned</a>(input_integer, rec_scale);
00454   <font class="keywordflow">if</font> ((input_integer[0]+input_integer[1]) != 4*num_free) <font class="keywordflow">return</font> <a class="code" href="dcdplugin_8c.html#a10">DCD_BADFORMAT</a>;
00455 
00456   <font class="keywordflow">return</font> <a class="code" href="dcdplugin_8c.html#a4">DCD_SUCCESS</a>;
00457 }
00458   
<a name="l00459"></a><a class="code" href="dcdplugin_8c.html#a29">00459</a> <font class="keyword">static</font> <font class="keywordtype">int</font> <a class="code" href="dcdplugin_8c.html#a29">read_charmm_4dim</a>(<a class="code" href="fastio_8h.html#a5">fio_fd</a> fd, <font class="keywordtype">int</font> charmm, <font class="keywordtype">int</font> reverseEndian) {
00460   <font class="keywordtype">int</font> input_integer[2],rec_scale;
00461 
00462   <font class="keywordflow">if</font> (charmm &amp; <a class="code" href="dcdplugin_8c.html#a17">DCD_HAS_64BIT_REC</a>) {
00463     rec_scale=<a class="code" href="dcdplugin_8c.html#a2">RECSCALE64BIT</a>;
00464   } <font class="keywordflow">else</font> {
00465     rec_scale=<a class="code" href="dcdplugin_8c.html#a1">RECSCALE32BIT</a>;
00466   }
00467     
00468   <font class="comment">/* If this is a CHARMm file and contains a 4th dimension block, */</font>
00469   <font class="comment">/* we must skip past it to avoid problems                       */</font>
00470   <font class="keywordflow">if</font> ((charmm &amp; <a class="code" href="dcdplugin_8c.html#a14">DCD_IS_CHARMM</a>) &amp;&amp; (charmm &amp; <a class="code" href="dcdplugin_8c.html#a15">DCD_HAS_4DIMS</a>)) {
00471     input_integer[1]=0;
00472     <font class="keywordflow">if</font> (<a class="code" href="fastio_8h.html#a10">fio_fread</a>(input_integer, <font class="keyword">sizeof</font>(<font class="keywordtype">int</font>), rec_scale, fd) != rec_scale) <font class="keywordflow">return</font> <a class="code" href="dcdplugin_8c.html#a8">DCD_BADREAD</a>;  
00473     <font class="keywordflow">if</font> (reverseEndian) <a class="code" href="endianswap_8h.html#a4">swap4_aligned</a>(input_integer, rec_scale);
00474     <font class="keywordflow">if</font> (<a class="code" href="fastio_8h.html#a13">fio_fseek</a>(fd, (input_integer[0]+input_integer[1]), <a class="code" href="fastio_8h.html#a2">FIO_SEEK_CUR</a>)) <font class="keywordflow">return</font> <a class="code" href="dcdplugin_8c.html#a8">DCD_BADREAD</a>;
00475     <font class="keywordflow">if</font> (<a class="code" href="fastio_8h.html#a10">fio_fread</a>(input_integer, <font class="keyword">sizeof</font>(<font class="keywordtype">int</font>), rec_scale, fd) != rec_scale) <font class="keywordflow">return</font> <a class="code" href="dcdplugin_8c.html#a8">DCD_BADREAD</a>;  
00476   }
00477 
00478   <font class="keywordflow">return</font> <a class="code" href="dcdplugin_8c.html#a4">DCD_SUCCESS</a>;
00479 }
00480 
00481 <font class="comment">/* </font>
00482 <font class="comment"> * Read a dcd timestep from a dcd file</font>
00483 <font class="comment"> * Input: fd - a file struct opened for binary reading, from which the </font>
00484 <font class="comment"> *             header information has already been read.</font>
00485 <font class="comment"> *        natoms, nfixed, first, *freeind, reverse, charmm - the corresponding </font>
00486 <font class="comment"> *             items as set by read_dcdheader</font>
00487 <font class="comment"> *        first - true if this is the first frame we are reading.</font>
00488 <font class="comment"> *        x, y, z: space for natoms each of floats.</font>
00489 <font class="comment"> *        unitcell - space for six floats to hold the unit cell data.  </font>
00490 <font class="comment"> *                   Not set if no unit cell data is present.</font>
00491 <font class="comment"> * Output: 0 on success, negative error code on failure.</font>
00492 <font class="comment"> * Side effects: x, y, z contain the coordinates for the timestep read.</font>
00493 <font class="comment"> *               unitcell holds unit cell data if present.</font>
00494 <font class="comment"> */</font>
<a name="l00495"></a><a class="code" href="dcdplugin_8c.html#a30">00495</a> <font class="keyword">static</font> <font class="keywordtype">int</font> <a class="code" href="dcdplugin_8c.html#a30">read_dcdstep</a>(<a class="code" href="fastio_8h.html#a5">fio_fd</a> fd, <font class="keywordtype">int</font> N, <font class="keywordtype">float</font> *X, <font class="keywordtype">float</font> *Y, <font class="keywordtype">float</font> *Z, 
00496                         <font class="keywordtype">float</font> *unitcell, <font class="keywordtype">int</font> num_fixed,
00497                         <font class="keywordtype">int</font> first, <font class="keywordtype">int</font> *indexes, <font class="keywordtype">float</font> *fixedcoords, 
00498                         <font class="keywordtype">int</font> reverseEndian, <font class="keywordtype">int</font> charmm) {
00499   <font class="keywordtype">int</font> ret_val, rec_scale;   <font class="comment">/* Return value from read */</font>
00500   
00501   <font class="keywordflow">if</font> (charmm &amp; <a class="code" href="dcdplugin_8c.html#a17">DCD_HAS_64BIT_REC</a>) {
00502     rec_scale=<a class="code" href="dcdplugin_8c.html#a2">RECSCALE64BIT</a>;
00503   } <font class="keywordflow">else</font> {
00504     rec_scale=<a class="code" href="dcdplugin_8c.html#a1">RECSCALE32BIT</a>;
00505   }
00506   
00507   <font class="keywordflow">if</font> ((num_fixed==0) || first) {
00508     <font class="comment">/* temp storage for reading formatting info */</font>
00509     <font class="comment">/* note: has to be max size we'll ever use  */</font>
00510     <font class="keywordtype">int</font> tmpbuf[6*<a class="code" href="dcdplugin_8c.html#a3">RECSCALEMAX</a>]; 
00511 
00512     <a class="code" href="structfio__iovec.html">fio_iovec</a> iov[7];   <font class="comment">/* I/O vector for fio_readv() call          */</font>
00513     <a class="code" href="fastio_8h.html#a6">fio_size_t</a> readlen; <font class="comment">/* number of bytes actually read            */</font>
00514     <font class="keywordtype">int</font> i;
00515 
00516     <font class="comment">/* if there are no fixed atoms or this is the first timestep read */</font>
00517     <font class="comment">/* then we read all coordinates normally.                         */</font>
00518 
00519     <font class="comment">/* read the charmm periodic cell information */</font>
00520     <font class="comment">/* XXX this too should be read together with the other items in a */</font>
00521     <font class="comment">/*     single fio_readv() call in order to prevent lots of extra  */</font>
00522     <font class="comment">/*     kernel/user context switches.                              */</font>
00523     ret_val = <a class="code" href="dcdplugin_8c.html#a27">read_charmm_extrablock</a>(fd, charmm, reverseEndian, unitcell);
00524     <font class="keywordflow">if</font> (ret_val) <font class="keywordflow">return</font> ret_val;
00525 
00526     <font class="comment">/* setup the I/O vector for the call to fio_readv() */</font>
00527     iov[0].<a class="code" href="structfio__iovec.html#m0">iov_base</a> = (fio_caddr_t) &amp;tmpbuf[0]; <font class="comment">/* read format integer    */</font>
00528     iov[0].<a class="code" href="structfio__iovec.html#m1">iov_len</a>  = rec_scale*<font class="keyword">sizeof</font>(int);
00529 
00530     iov[1].<a class="code" href="structfio__iovec.html#m0">iov_base</a> = (fio_caddr_t) X;          <font class="comment">/* read X coordinates     */</font>
00531     iov[1].<a class="code" href="structfio__iovec.html#m1">iov_len</a>  = <font class="keyword">sizeof</font>(float)*N;
00532 
00533     iov[2].<a class="code" href="structfio__iovec.html#m0">iov_base</a> = (fio_caddr_t) &amp;tmpbuf[1*rec_scale]; <font class="comment">/* read 2 format integers */</font>
00534     iov[2].<a class="code" href="structfio__iovec.html#m1">iov_len</a>  = rec_scale*<font class="keyword">sizeof</font>(int) * 2;
00535 
00536     iov[3].<a class="code" href="structfio__iovec.html#m0">iov_base</a> = (fio_caddr_t) Y;          <font class="comment">/* read Y coordinates     */</font>
00537     iov[3].<a class="code" href="structfio__iovec.html#m1">iov_len</a>  = <font class="keyword">sizeof</font>(float)*N;
00538 
00539     iov[4].<a class="code" href="structfio__iovec.html#m0">iov_base</a> = (fio_caddr_t) &amp;tmpbuf[3*rec_scale]; <font class="comment">/* read 2 format integers */</font>
00540     iov[4].<a class="code" href="structfio__iovec.html#m1">iov_len</a>  = rec_scale*<font class="keyword">sizeof</font>(int) * 2;
00541 
00542     iov[5].<a class="code" href="structfio__iovec.html#m0">iov_base</a> = (fio_caddr_t) Z;          <font class="comment">/* read Y coordinates     */</font>
00543     iov[5].<a class="code" href="structfio__iovec.html#m1">iov_len</a>  = <font class="keyword">sizeof</font>(float)*N;
00544 
00545     iov[6].<a class="code" href="structfio__iovec.html#m0">iov_base</a> = (fio_caddr_t) &amp;tmpbuf[5*rec_scale]; <font class="comment">/* read format integer    */</font>
00546     iov[6].<a class="code" href="structfio__iovec.html#m1">iov_len</a>  = rec_scale*<font class="keyword">sizeof</font>(int);
00547 
00548     readlen = <a class="code" href="fastio_8h.html#a11">fio_readv</a>(fd, &amp;iov[0], 7);
00549 
00550     <font class="keywordflow">if</font> (readlen != (rec_scale*6*<font class="keyword">sizeof</font>(int) + 3*N*<font class="keyword">sizeof</font>(float)))
00551       <font class="keywordflow">return</font> <a class="code" href="dcdplugin_8c.html#a8">DCD_BADREAD</a>;
00552 
00553     <font class="comment">/* convert endianism if necessary */</font>
00554     <font class="keywordflow">if</font> (reverseEndian) {
00555       <a class="code" href="endianswap_8h.html#a4">swap4_aligned</a>(&amp;tmpbuf[0], rec_scale*6);
00556       <a class="code" href="endianswap_8h.html#a4">swap4_aligned</a>(X, N);
00557       <a class="code" href="endianswap_8h.html#a4">swap4_aligned</a>(Y, N);
00558       <a class="code" href="endianswap_8h.html#a4">swap4_aligned</a>(Z, N);
00559     }
00560 
00561     <font class="comment">/* double-check the fortran format size values for safety */</font>
00562     <font class="keywordflow">if</font>(rec_scale == 1) {
00563       <font class="keywordflow">for</font> (i=0; i&lt;6; i++) {
00564         <font class="keywordflow">if</font> (tmpbuf[i] != <font class="keyword">sizeof</font>(float)*N) <font class="keywordflow">return</font> <a class="code" href="dcdplugin_8c.html#a10">DCD_BADFORMAT</a>;
00565       }
00566     } <font class="keywordflow">else</font> {
00567       <font class="keywordflow">for</font> (i=0; i&lt;6; i++) {
00568           <font class="keywordflow">if</font> ((tmpbuf[2*i]+tmpbuf[2*i+1]) != <font class="keyword">sizeof</font>(float)*N) <font class="keywordflow">return</font> <a class="code" href="dcdplugin_8c.html#a10">DCD_BADFORMAT</a>;
00569       }
00570     }
00571 
00572     <font class="comment">/* copy fixed atom coordinates into fixedcoords array if this was the */</font>
00573     <font class="comment">/* first timestep, to be used from now on.  We just copy all atoms.   */</font>
00574     <font class="keywordflow">if</font> (num_fixed &amp;&amp; first) {
00575       memcpy(fixedcoords, X, N*<font class="keyword">sizeof</font>(<font class="keywordtype">float</font>));
00576       memcpy(fixedcoords+N, Y, N*<font class="keyword">sizeof</font>(<font class="keywordtype">float</font>));
00577       memcpy(fixedcoords+2*N, Z, N*<font class="keyword">sizeof</font>(<font class="keywordtype">float</font>));
00578     }
00579 
00580     <font class="comment">/* read in the optional charmm 4th array */</font>
00581     <font class="comment">/* XXX this too should be read together with the other items in a */</font>
00582     <font class="comment">/*     single fio_readv() call in order to prevent lots of extra  */</font>
00583     <font class="comment">/*     kernel/user context switches.                              */</font>
00584     ret_val = <a class="code" href="dcdplugin_8c.html#a29">read_charmm_4dim</a>(fd, charmm, reverseEndian);
00585     <font class="keywordflow">if</font> (ret_val) <font class="keywordflow">return</font> ret_val;
00586   } <font class="keywordflow">else</font> {
00587     <font class="comment">/* if there are fixed atoms, and this isn't the first frame, then we */</font>
00588     <font class="comment">/* only read in the non-fixed atoms for all subsequent timesteps.    */</font>
00589     ret_val = <a class="code" href="dcdplugin_8c.html#a27">read_charmm_extrablock</a>(fd, charmm, reverseEndian, unitcell);
00590     <font class="keywordflow">if</font> (ret_val) <font class="keywordflow">return</font> ret_val;
00591     ret_val = <a class="code" href="dcdplugin_8c.html#a28">read_fixed_atoms</a>(fd, N, N-num_fixed, indexes, reverseEndian,
00592                                fixedcoords, fixedcoords+3*N, X, charmm);
00593     <font class="keywordflow">if</font> (ret_val) <font class="keywordflow">return</font> ret_val;
00594     ret_val = <a class="code" href="dcdplugin_8c.html#a28">read_fixed_atoms</a>(fd, N, N-num_fixed, indexes, reverseEndian,
00595                                fixedcoords+N, fixedcoords+3*N, Y, charmm);
00596     <font class="keywordflow">if</font> (ret_val) <font class="keywordflow">return</font> ret_val;
00597     ret_val = <a class="code" href="dcdplugin_8c.html#a28">read_fixed_atoms</a>(fd, N, N-num_fixed, indexes, reverseEndian,
00598                                fixedcoords+2*N, fixedcoords+3*N, Z, charmm);
00599     <font class="keywordflow">if</font> (ret_val) <font class="keywordflow">return</font> ret_val;
00600     ret_val = <a class="code" href="dcdplugin_8c.html#a29">read_charmm_4dim</a>(fd, charmm, reverseEndian);
00601     <font class="keywordflow">if</font> (ret_val) <font class="keywordflow">return</font> ret_val;
00602   }
00603 
00604   <font class="keywordflow">return</font> <a class="code" href="dcdplugin_8c.html#a4">DCD_SUCCESS</a>;
00605 }
00606 
00607 
00608 <font class="comment">/* </font>
00609 <font class="comment"> * Skip past a timestep.  If there are fixed atoms, this cannot be used with</font>
00610 <font class="comment"> * the first timestep.  </font>
00611 <font class="comment"> * Input: fd - a file struct from which the header has already been read</font>
00612 <font class="comment"> *        natoms - number of atoms per timestep</font>
00613 <font class="comment"> *        nfixed - number of fixed atoms</font>
00614 <font class="comment"> *        charmm - charmm flags as returned by read_dcdheader</font>
00615 <font class="comment"> * Output: 0 on success, negative error code on failure.</font>
00616 <font class="comment"> * Side effects: One timestep will be skipped; fd will be positioned at the</font>
00617 <font class="comment"> *               next timestep.</font>
00618 <font class="comment"> */</font>
<a name="l00619"></a><a class="code" href="dcdplugin_8c.html#a31">00619</a> <font class="keyword">static</font> <font class="keywordtype">int</font> <a class="code" href="dcdplugin_8c.html#a31">skip_dcdstep</a>(<a class="code" href="fastio_8h.html#a5">fio_fd</a> fd, <font class="keywordtype">int</font> natoms, <font class="keywordtype">int</font> nfixed, <font class="keywordtype">int</font> charmm) {
00620   
00621   <font class="keywordtype">int</font> seekoffset = 0;
00622   <font class="keywordtype">int</font> rec_scale;
00623 
00624   <font class="keywordflow">if</font> (charmm &amp; <a class="code" href="dcdplugin_8c.html#a17">DCD_HAS_64BIT_REC</a>) {
00625     rec_scale=<a class="code" href="dcdplugin_8c.html#a2">RECSCALE64BIT</a>;
00626   } <font class="keywordflow">else</font> {
00627     rec_scale=<a class="code" href="dcdplugin_8c.html#a1">RECSCALE32BIT</a>;
00628   }
00629 
00630   <font class="comment">/* Skip charmm extra block */</font>
00631   <font class="keywordflow">if</font> ((charmm &amp; <a class="code" href="dcdplugin_8c.html#a14">DCD_IS_CHARMM</a>) &amp;&amp; (charmm &amp; <a class="code" href="dcdplugin_8c.html#a16">DCD_HAS_EXTRA_BLOCK</a>)) {
00632     seekoffset += 4*rec_scale + 48 + 4*rec_scale;
00633   }
00634 
00635   <font class="comment">/* For each atom set, seek past an int, the free atoms, and another int. */</font>
00636   seekoffset += 3 * (2*rec_scale + natoms - nfixed) * 4;
00637 
00638   <font class="comment">/* Assume that charmm 4th dim is the same size as the other three. */</font>
00639   <font class="keywordflow">if</font> ((charmm &amp; <a class="code" href="dcdplugin_8c.html#a14">DCD_IS_CHARMM</a>) &amp;&amp; (charmm &amp; <a class="code" href="dcdplugin_8c.html#a15">DCD_HAS_4DIMS</a>)) {
00640     seekoffset += (2*rec_scale + natoms - nfixed) * 4;
00641   }
00642  
00643   <font class="keywordflow">if</font> (<a class="code" href="fastio_8h.html#a13">fio_fseek</a>(fd, seekoffset, <a class="code" href="fastio_8h.html#a2">FIO_SEEK_CUR</a>)) <font class="keywordflow">return</font> <a class="code" href="dcdplugin_8c.html#a9">DCD_BADEOF</a>;
00644 
00645   <font class="keywordflow">return</font> <a class="code" href="dcdplugin_8c.html#a4">DCD_SUCCESS</a>;
00646 }
00647 
00648 
00649 <font class="comment">/* </font>
00650 <font class="comment"> * Write a timestep to a dcd file</font>
00651 <font class="comment"> * Input: fd - a file struct for which a dcd header has already been written</font>
00652 <font class="comment"> *       curframe: Count of frames written to this file, starting with 1.</font>
00653 <font class="comment"> *       curstep: Count of timesteps elapsed = istart + curframe * nsavc.</font>
00654 <font class="comment"> *        natoms - number of elements in x, y, z arrays</font>
00655 <font class="comment"> *        x, y, z: pointers to atom coordinates</font>
00656 <font class="comment"> * Output: 0 on success, negative error code on failure.</font>
00657 <font class="comment"> * Side effects: coordinates are written to the dcd file.</font>
00658 <font class="comment"> */</font>
<a name="l00659"></a><a class="code" href="dcdplugin_8c.html#a32">00659</a> <font class="keyword">static</font> <font class="keywordtype">int</font> <a class="code" href="dcdplugin_8c.html#a32">write_dcdstep</a>(<a class="code" href="fastio_8h.html#a5">fio_fd</a> fd, <font class="keywordtype">int</font> curframe, <font class="keywordtype">int</font> curstep, <font class="keywordtype">int</font> N, 
00660                   <font class="keyword">const</font> <font class="keywordtype">float</font> *X, <font class="keyword">const</font> <font class="keywordtype">float</font> *Y, <font class="keyword">const</font> <font class="keywordtype">float</font> *Z, 
00661                   <font class="keyword">const</font> <font class="keywordtype">double</font> *unitcell, <font class="keywordtype">int</font> charmm) {
00662   <font class="keywordtype">int</font> out_integer;
00663   <font class="keywordtype">int</font> rc;
00664 
00665   <font class="keywordflow">if</font> (charmm) {
00666     <font class="comment">/* write out optional unit cell */</font>
00667     <font class="keywordflow">if</font> (unitcell != NULL) {
00668       out_integer = 48; <font class="comment">/* 48 bytes (6 doubles) */</font>
00669       <a class="code" href="fastio_8h.html#a15">fio_write_int32</a>(fd, out_integer);
00670       <a class="code" href="dcdplugin_8c.html#a21">WRITE</a>(fd, unitcell, out_integer);
00671       <a class="code" href="fastio_8h.html#a15">fio_write_int32</a>(fd, out_integer);
00672     }
00673   }
00674 
00675   <font class="comment">/* write out coordinates */</font>
00676   out_integer = N*4; <font class="comment">/* N*4 bytes per X/Y/Z array (N floats per array) */</font>
00677   <a class="code" href="fastio_8h.html#a15">fio_write_int32</a>(fd, out_integer);
00678   <font class="keywordflow">if</font> (<a class="code" href="fastio_8h.html#a12">fio_fwrite</a>((<font class="keywordtype">void</font> *) X, out_integer, 1, fd) != 1) <font class="keywordflow">return</font> <a class="code" href="dcdplugin_8c.html#a13">DCD_BADWRITE</a>;
00679   <a class="code" href="fastio_8h.html#a15">fio_write_int32</a>(fd, out_integer);
00680   <a class="code" href="fastio_8h.html#a15">fio_write_int32</a>(fd, out_integer);
00681   <font class="keywordflow">if</font> (<a class="code" href="fastio_8h.html#a12">fio_fwrite</a>((<font class="keywordtype">void</font> *) Y, out_integer, 1, fd) != 1) <font class="keywordflow">return</font> <a class="code" href="dcdplugin_8c.html#a13">DCD_BADWRITE</a>;
00682   <a class="code" href="fastio_8h.html#a15">fio_write_int32</a>(fd, out_integer);
00683   <a class="code" href="fastio_8h.html#a15">fio_write_int32</a>(fd, out_integer);
00684   <font class="keywordflow">if</font> (<a class="code" href="fastio_8h.html#a12">fio_fwrite</a>((<font class="keywordtype">void</font> *) Z, out_integer, 1, fd) != 1) <font class="keywordflow">return</font> <a class="code" href="dcdplugin_8c.html#a13">DCD_BADWRITE</a>;
00685   <a class="code" href="fastio_8h.html#a15">fio_write_int32</a>(fd, out_integer);
00686 
00687   <font class="comment">/* update the DCD header information */</font>
00688   <a class="code" href="fastio_8h.html#a13">fio_fseek</a>(fd, <a class="code" href="dcdplugin_8c.html#a18">NFILE_POS</a>, <a class="code" href="fastio_8h.html#a3">FIO_SEEK_SET</a>);
00689   <a class="code" href="fastio_8h.html#a15">fio_write_int32</a>(fd, curframe);
00690   <a class="code" href="fastio_8h.html#a13">fio_fseek</a>(fd, <a class="code" href="dcdplugin_8c.html#a19">NSTEP_POS</a>, <a class="code" href="fastio_8h.html#a3">FIO_SEEK_SET</a>);
00691   <a class="code" href="fastio_8h.html#a15">fio_write_int32</a>(fd, curstep);
00692   <a class="code" href="fastio_8h.html#a13">fio_fseek</a>(fd, 0, <a class="code" href="fastio_8h.html#a4">FIO_SEEK_END</a>);
00693 
00694   <font class="keywordflow">return</font> <a class="code" href="dcdplugin_8c.html#a4">DCD_SUCCESS</a>;
00695 }
00696 
00697 <font class="comment">/*</font>
00698 <font class="comment"> * Write a header for a new dcd file</font>
00699 <font class="comment"> * Input: fd - file struct opened for binary writing</font>
00700 <font class="comment"> *        remarks - string to be put in the remarks section of the header.  </font>
00701 <font class="comment"> *                  The string will be truncated to 70 characters.</font>
00702 <font class="comment"> *        natoms, istart, nsavc, delta - see comments in read_dcdheader</font>
00703 <font class="comment"> * Output: 0 on success, negative error code on failure.</font>
00704 <font class="comment"> * Side effects: Header information is written to the dcd file.</font>
00705 <font class="comment"> */</font>
<a name="l00706"></a><a class="code" href="dcdplugin_8c.html#a33">00706</a> <font class="keyword">static</font> <font class="keywordtype">int</font> <a class="code" href="dcdplugin_8c.html#a33">write_dcdheader</a>(<a class="code" href="fastio_8h.html#a5">fio_fd</a> fd, <font class="keyword">const</font> <font class="keywordtype">char</font> *remarks, <font class="keywordtype">int</font> N, 
00707                     <font class="keywordtype">int</font> ISTART, <font class="keywordtype">int</font> NSAVC, <font class="keywordtype">double</font> DELTA, <font class="keywordtype">int</font> with_unitcell,
00708                     <font class="keywordtype">int</font> charmm) {
00709   <font class="keywordtype">int</font> out_integer;
00710   <font class="keywordtype">float</font> out_float;
00711   <font class="keywordtype">char</font> title_string[200];
00712   time_t cur_time;
00713   <font class="keyword">struct </font>tm *tmbuf;
00714   <font class="keywordtype">char</font> time_str[81];
00715 
00716   out_integer = 84;
00717   <a class="code" href="dcdplugin_8c.html#a21">WRITE</a>(fd, (<font class="keywordtype">char</font> *) &amp; out_integer, <font class="keyword">sizeof</font>(<font class="keywordtype">int</font>));
00718   strcpy(title_string, <font class="stringliteral">"CORD"</font>);
00719   <a class="code" href="dcdplugin_8c.html#a21">WRITE</a>(fd, title_string, 4);
00720   <a class="code" href="fastio_8h.html#a15">fio_write_int32</a>(fd, 0);      <font class="comment">/* Number of frames in file, none written yet   */</font>
00721   <a class="code" href="fastio_8h.html#a15">fio_write_int32</a>(fd, ISTART); <font class="comment">/* Starting timestep                            */</font>
00722   <a class="code" href="fastio_8h.html#a15">fio_write_int32</a>(fd, NSAVC);  <font class="comment">/* Timesteps between frames written to the file */</font>
00723   <a class="code" href="fastio_8h.html#a15">fio_write_int32</a>(fd, 0);      <font class="comment">/* Number of timesteps in simulation            */</font>
00724   <a class="code" href="fastio_8h.html#a15">fio_write_int32</a>(fd, 0);      <font class="comment">/* NAMD writes NSTEP or ISTART - NSAVC here?    */</font>
00725   <a class="code" href="fastio_8h.html#a15">fio_write_int32</a>(fd, 0);
00726   <a class="code" href="fastio_8h.html#a15">fio_write_int32</a>(fd, 0);
00727   <a class="code" href="fastio_8h.html#a15">fio_write_int32</a>(fd, 0);
00728   <a class="code" href="fastio_8h.html#a15">fio_write_int32</a>(fd, 0);
00729   <font class="keywordflow">if</font> (charmm) {
00730     out_float = DELTA;
00731     <a class="code" href="dcdplugin_8c.html#a21">WRITE</a>(fd, (<font class="keywordtype">char</font> *) &amp;out_float, <font class="keyword">sizeof</font>(<font class="keywordtype">float</font>));
00732     <font class="keywordflow">if</font> (with_unitcell) {
00733       <a class="code" href="fastio_8h.html#a15">fio_write_int32</a>(fd, 1);
00734     } <font class="keywordflow">else</font> {
00735       <a class="code" href="fastio_8h.html#a15">fio_write_int32</a>(fd, 0);
00736     }
00737   } <font class="keywordflow">else</font> {
00738     <a class="code" href="dcdplugin_8c.html#a21">WRITE</a>(fd, (<font class="keywordtype">char</font> *) &amp;DELTA, <font class="keyword">sizeof</font>(<font class="keywordtype">double</font>));
00739   }
00740   <a class="code" href="fastio_8h.html#a15">fio_write_int32</a>(fd, 0);
00741   <a class="code" href="fastio_8h.html#a15">fio_write_int32</a>(fd, 0);
00742   <a class="code" href="fastio_8h.html#a15">fio_write_int32</a>(fd, 0);
00743   <a class="code" href="fastio_8h.html#a15">fio_write_int32</a>(fd, 0);
00744   <a class="code" href="fastio_8h.html#a15">fio_write_int32</a>(fd, 0);
00745   <a class="code" href="fastio_8h.html#a15">fio_write_int32</a>(fd, 0);
00746   <a class="code" href="fastio_8h.html#a15">fio_write_int32</a>(fd, 0);
00747   <a class="code" href="fastio_8h.html#a15">fio_write_int32</a>(fd, 0);
00748   <font class="keywordflow">if</font> (charmm) {
00749     <a class="code" href="fastio_8h.html#a15">fio_write_int32</a>(fd, 24); <font class="comment">/* Pretend to be CHARMM version 24 */</font>
00750   } <font class="keywordflow">else</font> {
00751     <a class="code" href="fastio_8h.html#a15">fio_write_int32</a>(fd, 0);
00752   }
00753   <a class="code" href="fastio_8h.html#a15">fio_write_int32</a>(fd, 84);
00754   <a class="code" href="fastio_8h.html#a15">fio_write_int32</a>(fd, 164);
00755   <a class="code" href="fastio_8h.html#a15">fio_write_int32</a>(fd, 2);
00756 
00757   strncpy(title_string, remarks, 80);
00758   title_string[79] = <font class="charliteral">'\0'</font>;
00759   <a class="code" href="dcdplugin_8c.html#a21">WRITE</a>(fd, title_string, 80);
00760 
00761   cur_time=time(NULL);
00762   tmbuf=localtime(&amp;cur_time);
00763   strftime(time_str, 80, <font class="stringliteral">"REMARKS Created %d %B, %Y at %R"</font>, tmbuf);
00764   <a class="code" href="dcdplugin_8c.html#a21">WRITE</a>(fd, time_str, 80);
00765 
00766   <a class="code" href="fastio_8h.html#a15">fio_write_int32</a>(fd, 164);
00767   <a class="code" href="fastio_8h.html#a15">fio_write_int32</a>(fd, 4);
00768   <a class="code" href="fastio_8h.html#a15">fio_write_int32</a>(fd, N);
00769   <a class="code" href="fastio_8h.html#a15">fio_write_int32</a>(fd, 4);
00770 
00771   <font class="keywordflow">return</font> <a class="code" href="dcdplugin_8c.html#a4">DCD_SUCCESS</a>;
00772 }
00773 
00774 
00775 <font class="comment">/*</font>
00776 <font class="comment"> * clean up dcd data</font>
00777 <font class="comment"> * Input: nfixed, freeind - elements as returned by read_dcdheader</font>
00778 <font class="comment"> * Output: None</font>
00779 <font class="comment"> * Side effects: Space pointed to by freeind is freed if necessary.</font>
00780 <font class="comment"> */</font>
<a name="l00781"></a><a class="code" href="dcdplugin_8c.html#a34">00781</a> <font class="keyword">static</font> <font class="keywordtype">void</font> <a class="code" href="dcdplugin_8c.html#a34">close_dcd_read</a>(<font class="keywordtype">int</font> *indexes, <font class="keywordtype">float</font> *fixedcoords) {
00782   free(indexes);
00783   free(fixedcoords);
00784 }
00785 
00786 
00787 
00788 
00789 
<a name="l00790"></a><a class="code" href="dcdplugin_8c.html#a35">00790</a> <font class="keyword">static</font> <font class="keywordtype">void</font> *<a class="code" href="dcdplugin_8c.html#a35">open_dcd_read</a>(<font class="keyword">const</font> <font class="keywordtype">char</font> *path, <font class="keyword">const</font> <font class="keywordtype">char</font> *filetype, 
00791     <font class="keywordtype">int</font> *natoms) {
00792   <a class="code" href="structdcdhandle.html">dcdhandle</a> *dcd;
00793   <a class="code" href="fastio_8h.html#a5">fio_fd</a> fd;
00794   <font class="keywordtype">int</font> rc;
00795   <font class="keyword">struct </font>stat stbuf;
00796 
00797   <font class="keywordflow">if</font> (!path) <font class="keywordflow">return</font> NULL;
00798 
00799   <font class="comment">/* See if the file exists, and get its size */</font>
00800   memset(&amp;stbuf, 0, <font class="keyword">sizeof</font>(<font class="keyword">struct</font> stat));
00801   <font class="keywordflow">if</font> (stat(path, &amp;stbuf)) {
00802     printf(<font class="stringliteral">"dcdplugin) Could not access file '%s'.\n"</font>, path);
00803     <font class="keywordflow">return</font> NULL;
00804   }
00805 
00806   <font class="keywordflow">if</font> (<a class="code" href="fastio_8h.html#a8">fio_open</a>(path, <a class="code" href="fastio_8h.html#a0">FIO_READ</a>, &amp;fd) &lt; 0) {
00807     printf(<font class="stringliteral">"dcdplugin) Could not open file '%s' for reading.\n"</font>, path);
00808     <font class="keywordflow">return</font> NULL;
00809   }
00810 
00811   dcd = (<a class="code" href="structdcdhandle.html">dcdhandle</a> *)malloc(<font class="keyword">sizeof</font>(<a class="code" href="structdcdhandle.html">dcdhandle</a>));
00812   memset(dcd, 0, <font class="keyword">sizeof</font>(<a class="code" href="structdcdhandle.html">dcdhandle</a>));
00813   dcd-&gt;<a class="code" href="structdcdhandle.html#m0">fd</a> = fd;
00814 
00815   <font class="keywordflow">if</font> ((rc = <a class="code" href="dcdplugin_8c.html#a26">read_dcdheader</a>(dcd-&gt;<a class="code" href="structdcdhandle.html#m0">fd</a>, &amp;dcd-&gt;<a class="code" href="structdcdhandle.html#m1">natoms</a>, &amp;dcd-&gt;<a class="code" href="structdcdhandle.html#m2">nsets</a>, &amp;dcd-&gt;<a class="code" href="structdcdhandle.html#m4">istart</a>, 
00816          &amp;dcd-&gt;<a class="code" href="structdcdhandle.html#m5">nsavc</a>, &amp;dcd-&gt;<a class="code" href="structdcdhandle.html#m6">delta</a>, &amp;dcd-&gt;<a class="code" href="structdcdhandle.html#m7">nfixed</a>, &amp;dcd-&gt;<a class="code" href="structdcdhandle.html#m11">freeind</a>, 
00817          &amp;dcd-&gt;<a class="code" href="structdcdhandle.html#m12">fixedcoords</a>, &amp;dcd-&gt;<a class="code" href="structdcdhandle.html#m13">reverse</a>, &amp;dcd-&gt;<a class="code" href="structdcdhandle.html#m14">charmm</a>))) {
00818     <a class="code" href="dcdplugin_8c.html#a25">print_dcderror</a>(<font class="stringliteral">"read_dcdheader"</font>, rc);
00819     <a class="code" href="fastio_8h.html#a9">fio_fclose</a>(dcd-&gt;<a class="code" href="structdcdhandle.html#m0">fd</a>);
00820     free(dcd);
00821     <font class="keywordflow">return</font> NULL;
00822   }
00823 
00824   <font class="comment">/*</font>
00825 <font class="comment">   * Check that the file is big enough to really hold the number of sets</font>
00826 <font class="comment">   * it claims to have.  Then we'll use nsets to keep track of where EOF</font>
00827 <font class="comment">   * should be.</font>
00828 <font class="comment">   */</font>
00829   {
00830     <a class="code" href="fastio_8h.html#a6">fio_size_t</a> ndims, firstframesize, framesize, extrablocksize;
00831     <a class="code" href="fastio_8h.html#a6">fio_size_t</a> trjsize, filesize, curpos;
00832     <font class="keywordtype">int</font> newnsets;
00833 
00834     extrablocksize = dcd-&gt;<a class="code" href="structdcdhandle.html#m14">charmm</a> &amp; <a class="code" href="dcdplugin_8c.html#a16">DCD_HAS_EXTRA_BLOCK</a> ? 48 + 8 : 0;
00835     ndims = dcd-&gt;<a class="code" href="structdcdhandle.html#m14">charmm</a> &amp; <a class="code" href="dcdplugin_8c.html#a15">DCD_HAS_4DIMS</a> ? 4 : 3;
00836     firstframesize = (dcd-&gt;<a class="code" href="structdcdhandle.html#m1">natoms</a>+2) * ndims * <font class="keyword">sizeof</font>(float) + extrablocksize;
00837     framesize = (dcd-&gt;<a class="code" href="structdcdhandle.html#m1">natoms</a>-dcd-&gt;<a class="code" href="structdcdhandle.html#m7">nfixed</a>+2) * ndims * <font class="keyword">sizeof</font>(float) 
00838       + extrablocksize;
00839 
00840     <font class="comment">/* </font>
00841 <font class="comment">     * It's safe to use ftell, even though ftell returns a long, because the </font>
00842 <font class="comment">     * header size is &lt; 4GB.</font>
00843 <font class="comment">     */</font>
00844 
00845     curpos = <a class="code" href="fastio_8h.html#a14">fio_ftell</a>(dcd-&gt;<a class="code" href="structdcdhandle.html#m0">fd</a>); <font class="comment">/* save current offset (end of header) */</font>
00846 
00847 <font class="preprocessor">#if defined(_MSC_VER) &amp;&amp; defined(FASTIO_NATIVEWIN32)</font>
00848 <font class="preprocessor"></font>    <font class="comment">/* the stat() call is not 64-bit savvy on Windows             */</font>
00849     <font class="comment">/* so we have to use the fastio fseek/ftell routines for this */</font>
00850     <font class="comment">/* until we add a portable filesize routine for this purpose  */</font>
00851     <a class="code" href="fastio_8h.html#a13">fio_fseek</a>(dcd-&gt;<a class="code" href="structdcdhandle.html#m0">fd</a>, 0, <a class="code" href="fastio_8h.html#a4">FIO_SEEK_END</a>);       <font class="comment">/* seek to end of file */</font>
00852     filesize = <a class="code" href="fastio_8h.html#a14">fio_ftell</a>(dcd-&gt;<a class="code" href="structdcdhandle.html#m0">fd</a>);
00853     <a class="code" href="fastio_8h.html#a13">fio_fseek</a>(dcd-&gt;<a class="code" href="structdcdhandle.html#m0">fd</a>, curpos, <a class="code" href="fastio_8h.html#a3">FIO_SEEK_SET</a>);  <font class="comment">/* return to end of header */</font>
00854 <font class="preprocessor">#else</font>
00855 <font class="preprocessor"></font>    filesize = stbuf.st_size; <font class="comment">/* this works ok on Unix machines */</font>
00856 <font class="preprocessor">#endif</font>
00857 <font class="preprocessor"></font>    trjsize = filesize - curpos - firstframesize;
00858     <font class="keywordflow">if</font> (trjsize &lt; 0) {
00859       printf(<font class="stringliteral">"dcdplugin) file '%s' appears to contain no timesteps.\n"</font>, path);
00860       <a class="code" href="fastio_8h.html#a9">fio_fclose</a>(dcd-&gt;<a class="code" href="structdcdhandle.html#m0">fd</a>);
00861       free(dcd);
00862       <font class="keywordflow">return</font> NULL;
00863     }
00864 
00865     newnsets = trjsize / framesize + 1;
00866 
00867     <font class="keywordflow">if</font> (dcd-&gt;<a class="code" href="structdcdhandle.html#m2">nsets</a> &gt; 0 &amp;&amp; newnsets != dcd-&gt;<a class="code" href="structdcdhandle.html#m2">nsets</a>) {
00868       printf(<font class="stringliteral">"dcdplugin) Warning: DCD header claims %d frames, file size indicates there are actually %d frames\n"</font>, dcd-&gt;<a class="code" href="structdcdhandle.html#m2">nsets</a>, newnsets);
00869     }
00870 
00871     dcd-&gt;<a class="code" href="structdcdhandle.html#m2">nsets</a> = newnsets; 
00872     dcd-&gt;<a class="code" href="structdcdhandle.html#m3">setsread</a> = 0;
00873   }
00874 
00875   dcd-&gt;<a class="code" href="structdcdhandle.html#m15">first</a> = 1;
00876   dcd-&gt;<a class="code" href="structdcdhandle.html#m8">x</a> = (<font class="keywordtype">float</font> *)malloc(dcd-&gt;<a class="code" href="structdcdhandle.html#m1">natoms</a> * <font class="keyword">sizeof</font>(<font class="keywordtype">float</font>));
00877   dcd-&gt;<a class="code" href="structdcdhandle.html#m9">y</a> = (<font class="keywordtype">float</font> *)malloc(dcd-&gt;<a class="code" href="structdcdhandle.html#m1">natoms</a> * <font class="keyword">sizeof</font>(<font class="keywordtype">float</font>));
00878   dcd-&gt;<a class="code" href="structdcdhandle.html#m10">z</a> = (<font class="keywordtype">float</font> *)malloc(dcd-&gt;<a class="code" href="structdcdhandle.html#m1">natoms</a> * <font class="keyword">sizeof</font>(<font class="keywordtype">float</font>));
00879   <font class="keywordflow">if</font> (!dcd-&gt;<a class="code" href="structdcdhandle.html#m8">x</a> || !dcd-&gt;<a class="code" href="structdcdhandle.html#m9">y</a> || !dcd-&gt;<a class="code" href="structdcdhandle.html#m10">z</a>) {
00880     printf(<font class="stringliteral">"dcdplugin) Unable to allocate space for %d atoms.\n"</font>, dcd-&gt;<a class="code" href="structdcdhandle.html#m1">natoms</a>);
00881     <font class="keywordflow">if</font> (dcd-&gt;<a class="code" href="structdcdhandle.html#m8">x</a>)
00882       free(dcd-&gt;<a class="code" href="structdcdhandle.html#m8">x</a>);
00883     <font class="keywordflow">if</font> (dcd-&gt;<a class="code" href="structdcdhandle.html#m9">y</a>)
00884       free(dcd-&gt;<a class="code" href="structdcdhandle.html#m9">y</a>);
00885     <font class="keywordflow">if</font> (dcd-&gt;<a class="code" href="structdcdhandle.html#m10">z</a>)
00886       free(dcd-&gt;<a class="code" href="structdcdhandle.html#m10">z</a>);
00887     <a class="code" href="fastio_8h.html#a9">fio_fclose</a>(dcd-&gt;<a class="code" href="structdcdhandle.html#m0">fd</a>);
00888     free(dcd);
00889     <font class="keywordflow">return</font> NULL;
00890   }
00891   *natoms = dcd-&gt;<a class="code" href="structdcdhandle.html#m1">natoms</a>;
00892   <font class="keywordflow">return</font> dcd;
00893 }
00894 
00895 
<a name="l00896"></a><a class="code" href="dcdplugin_8c.html#a36">00896</a> <font class="keyword">static</font> <font class="keywordtype">int</font> <a class="code" href="webpdbplugin_8c.html#a8">read_next_timestep</a>(<font class="keywordtype">void</font> *v, <font class="keywordtype">int</font> natoms, <a class="code" href="structmolfile__timestep__t.html">molfile_timestep_t</a> *ts) {
00897   <a class="code" href="structdcdhandle.html">dcdhandle</a> *dcd;
00898   <font class="keywordtype">int</font> i, j, rc;
00899   <font class="keywordtype">float</font> unitcell[6];
00900   unitcell[0] = unitcell[2] = unitcell[5] = 1.0f;
00901   unitcell[1] = unitcell[3] = unitcell[4] = 90.0f;
00902   dcd = (<a class="code" href="structdcdhandle.html">dcdhandle</a> *)v;
00903 
00904   <font class="comment">/* Check for EOF here; that way all EOF's encountered later must be errors */</font>
00905   <font class="keywordflow">if</font> (dcd-&gt;<a class="code" href="structdcdhandle.html#m3">setsread</a> == dcd-&gt;<a class="code" href="structdcdhandle.html#m2">nsets</a>) <font class="keywordflow">return</font> <a class="code" href="molfile__plugin_8h.html#a3">MOLFILE_EOF</a>;
00906   dcd-&gt;<a class="code" href="structdcdhandle.html#m3">setsread</a>++;
00907   <font class="keywordflow">if</font> (!ts) {
00908     <font class="keywordflow">if</font> (dcd-&gt;<a class="code" href="structdcdhandle.html#m15">first</a> &amp;&amp; dcd-&gt;<a class="code" href="structdcdhandle.html#m7">nfixed</a>) {
00909       <font class="comment">/* We can't just skip it because we need the fixed atom coordinates */</font>
00910       rc = <a class="code" href="dcdplugin_8c.html#a30">read_dcdstep</a>(dcd-&gt;<a class="code" href="structdcdhandle.html#m0">fd</a>, dcd-&gt;<a class="code" href="structdcdhandle.html#m1">natoms</a>, dcd-&gt;<a class="code" href="structdcdhandle.html#m8">x</a>, dcd-&gt;<a class="code" href="structdcdhandle.html#m9">y</a>, dcd-&gt;<a class="code" href="structdcdhandle.html#m10">z</a>, 
00911           unitcell, dcd-&gt;<a class="code" href="structdcdhandle.html#m7">nfixed</a>, dcd-&gt;<a class="code" href="structdcdhandle.html#m15">first</a>, dcd-&gt;<a class="code" href="structdcdhandle.html#m11">freeind</a>, dcd-&gt;<a class="code" href="structdcdhandle.html#m12">fixedcoords</a>, 
00912              dcd-&gt;<a class="code" href="structdcdhandle.html#m13">reverse</a>, dcd-&gt;<a class="code" href="structdcdhandle.html#m14">charmm</a>);
00913       dcd-&gt;<a class="code" href="structdcdhandle.html#m15">first</a> = 0;
00914       <font class="keywordflow">return</font> rc; <font class="comment">/* XXX this needs to be updated */</font>
00915     }
00916     dcd-&gt;<a class="code" href="structdcdhandle.html#m15">first</a> = 0;
00917     <font class="comment">/* XXX this needs to be changed */</font>
00918     <font class="keywordflow">return</font> <a class="code" href="dcdplugin_8c.html#a31">skip_dcdstep</a>(dcd-&gt;<a class="code" href="structdcdhandle.html#m0">fd</a>, dcd-&gt;<a class="code" href="structdcdhandle.html#m1">natoms</a>, dcd-&gt;<a class="code" href="structdcdhandle.html#m7">nfixed</a>, dcd-&gt;<a class="code" href="structdcdhandle.html#m14">charmm</a>);
00919   }
00920   rc = <a class="code" href="dcdplugin_8c.html#a30">read_dcdstep</a>(dcd-&gt;<a class="code" href="structdcdhandle.html#m0">fd</a>, dcd-&gt;<a class="code" href="structdcdhandle.html#m1">natoms</a>, dcd-&gt;<a class="code" href="structdcdhandle.html#m8">x</a>, dcd-&gt;<a class="code" href="structdcdhandle.html#m9">y</a>, dcd-&gt;<a class="code" href="structdcdhandle.html#m10">z</a>, unitcell,
00921              dcd-&gt;<a class="code" href="structdcdhandle.html#m7">nfixed</a>, dcd-&gt;<a class="code" href="structdcdhandle.html#m15">first</a>, dcd-&gt;<a class="code" href="structdcdhandle.html#m11">freeind</a>, dcd-&gt;<a class="code" href="structdcdhandle.html#m12">fixedcoords</a>, 
00922              dcd-&gt;<a class="code" href="structdcdhandle.html#m13">reverse</a>, dcd-&gt;<a class="code" href="structdcdhandle.html#m14">charmm</a>);
00923   dcd-&gt;<a class="code" href="structdcdhandle.html#m15">first</a> = 0;
00924   <font class="keywordflow">if</font> (rc &lt; 0) {  
00925     <a class="code" href="dcdplugin_8c.html#a25">print_dcderror</a>(<font class="stringliteral">"read_dcdstep"</font>, rc);
00926     <font class="keywordflow">return</font> <a class="code" href="molfile__plugin_8h.html#a4">MOLFILE_ERROR</a>;
00927   }
00928 
00929   <font class="comment">/* copy timestep data from plugin-local buffers to VMD's buffer */</font>
00930   <font class="comment">/* XXX </font>
00931 <font class="comment">   *   This code is still the root of all evil.  Just doing this extra copy</font>
00932 <font class="comment">   *   cuts the I/O rate of the DCD reader from 728 MB/sec down to</font>
00933 <font class="comment">   *   394 MB/sec when reading from a ram filesystem.  </font>
00934 <font class="comment">   *   For a physical disk filesystem, the I/O rate goes from </font>
00935 <font class="comment">   *   187 MB/sec down to 122 MB/sec.  Clearly this extra copy has to go.</font>
00936 <font class="comment">   */</font>
00937   {
00938     <font class="keywordtype">int</font> natoms = dcd-&gt;<a class="code" href="structdcdhandle.html#m1">natoms</a>;
00939     <font class="keywordtype">float</font> *nts = ts-&gt;<a class="code" href="structmolfile__timestep__t.html#m0">coords</a>;
00940     <font class="keyword">const</font> <font class="keywordtype">float</font> *bufx = dcd-&gt;<a class="code" href="structdcdhandle.html#m8">x</a>;
00941     <font class="keyword">const</font> <font class="keywordtype">float</font> *bufy = dcd-&gt;<a class="code" href="structdcdhandle.html#m9">y</a>;
00942     <font class="keyword">const</font> <font class="keywordtype">float</font> *bufz = dcd-&gt;<a class="code" href="structdcdhandle.html#m10">z</a>;
00943 
00944     <font class="keywordflow">for</font> (i=0, j=0; i&lt;natoms; i++, j+=3) {
00945       nts[j    ] = bufx[i];
00946       nts[j + 1] = bufy[i];
00947       nts[j + 2] = bufz[i];
00948     }
00949   }
00950 
00951   ts-&gt;<a class="code" href="structmolfile__timestep__t.html#z4_0">A</a> = unitcell[0];
00952   ts-&gt;<a class="code" href="structmolfile__timestep__t.html#z4_1">B</a> = unitcell[2];
00953   ts-&gt;<a class="code" href="structmolfile__timestep__t.html#z4_2">C</a> = unitcell[5];
00954 
00955   <font class="keywordflow">if</font> (unitcell[1] &gt;= -1.0 &amp;&amp; unitcell[1] &lt;= 1.0 &amp;&amp;
00956       unitcell[3] &gt;= -1.0 &amp;&amp; unitcell[3] &lt;= 1.0 &amp;&amp;
00957       unitcell[4] &gt;= -1.0 &amp;&amp; unitcell[4] &lt;= 1.0) {
00958     <font class="comment">/* This file was generated by CHARMM, or by NAMD &gt; 2.5, with the angle */</font>
00959     <font class="comment">/* cosines of the periodic cell angles written to the DCD file.        */</font> 
00960     <font class="comment">/* This formulation improves rounding behavior for orthogonal cells    */</font>
00961     <font class="comment">/* so that the angles end up at precisely 90 degrees, unlike acos().   */</font>
00962     ts-&gt;<a class="code" href="structmolfile__timestep__t.html#z4_3">alpha</a> = 90.0 - asin(unitcell[4]) * 90.0 / <a class="code" href="dcdplugin_8c.html#a0">M_PI_2</a>; <font class="comment">/* cosBC */</font>
00963     ts-&gt;<a class="code" href="structmolfile__timestep__t.html#z4_4">beta</a>  = 90.0 - asin(unitcell[3]) * 90.0 / <a class="code" href="dcdplugin_8c.html#a0">M_PI_2</a>; <font class="comment">/* cosAC */</font>
00964     ts-&gt;<a class="code" href="structmolfile__timestep__t.html#z4_5">gamma</a> = 90.0 - asin(unitcell[1]) * 90.0 / <a class="code" href="dcdplugin_8c.html#a0">M_PI_2</a>; <font class="comment">/* cosAB */</font>
00965   } <font class="keywordflow">else</font> {
00966     <font class="comment">/* This file was likely generated by NAMD 2.5 and the periodic cell    */</font>
00967     <font class="comment">/* angles are specified in degrees rather than angle cosines.          */</font>
00968     ts-&gt;<a class="code" href="structmolfile__timestep__t.html#z4_3">alpha</a> = unitcell[4]; <font class="comment">/* angle between B and C */</font>
00969     ts-&gt;<a class="code" href="structmolfile__timestep__t.html#z4_4">beta</a>  = unitcell[3]; <font class="comment">/* angle between A and C */</font>
00970     ts-&gt;<a class="code" href="structmolfile__timestep__t.html#z4_5">gamma</a> = unitcell[1]; <font class="comment">/* angle between A and B */</font>
00971   }
00972  
00973   <font class="keywordflow">return</font> <a class="code" href="molfile__plugin_8h.html#a2">MOLFILE_SUCCESS</a>;
00974 }
00975  
00976 
<a name="l00977"></a><a class="code" href="dcdplugin_8c.html#a37">00977</a> <font class="keyword">static</font> <font class="keywordtype">void</font> <a class="code" href="stlplugin_8C.html#a4">close_file_read</a>(<font class="keywordtype">void</font> *v) {
00978   <a class="code" href="structdcdhandle.html">dcdhandle</a> *dcd = (<a class="code" href="structdcdhandle.html">dcdhandle</a> *)v;
00979   <a class="code" href="dcdplugin_8c.html#a34">close_dcd_read</a>(dcd-&gt;<a class="code" href="structdcdhandle.html#m11">freeind</a>, dcd-&gt;<a class="code" href="structdcdhandle.html#m12">fixedcoords</a>);
00980   <a class="code" href="fastio_8h.html#a9">fio_fclose</a>(dcd-&gt;<a class="code" href="structdcdhandle.html#m0">fd</a>);
00981   free(dcd-&gt;<a class="code" href="structdcdhandle.html#m8">x</a>);
00982   free(dcd-&gt;<a class="code" href="structdcdhandle.html#m9">y</a>);
00983   free(dcd-&gt;<a class="code" href="structdcdhandle.html#m10">z</a>);
00984   free(dcd); 
00985 }
00986 
00987 
<a name="l00988"></a><a class="code" href="dcdplugin_8c.html#a38">00988</a> <font class="keyword">static</font> <font class="keywordtype">void</font> *<a class="code" href="dcdplugin_8c.html#a38">open_dcd_write</a>(<font class="keyword">const</font> <font class="keywordtype">char</font> *path, <font class="keyword">const</font> <font class="keywordtype">char</font> *filetype, 
00989     <font class="keywordtype">int</font> natoms) {
00990   <a class="code" href="structdcdhandle.html">dcdhandle</a> *dcd;
00991   <a class="code" href="fastio_8h.html#a5">fio_fd</a> fd;
00992   <font class="keywordtype">int</font> rc;
00993   <font class="keywordtype">int</font> istart, nsavc;
00994   <font class="keywordtype">double</font> delta;
00995   <font class="keywordtype">int</font> with_unitcell;
00996   <font class="keywordtype">int</font> charmm;
00997 
00998   <font class="keywordflow">if</font> (<a class="code" href="fastio_8h.html#a8">fio_open</a>(path, <a class="code" href="fastio_8h.html#a1">FIO_WRITE</a>, &amp;fd) &lt; 0) {
00999     printf(<font class="stringliteral">"dcdplugin) Could not open file '%s' for writing\n"</font>, path);
01000     <font class="keywordflow">return</font> NULL;
01001   }
01002 
01003   dcd = (<a class="code" href="structdcdhandle.html">dcdhandle</a> *)malloc(<font class="keyword">sizeof</font>(<a class="code" href="structdcdhandle.html">dcdhandle</a>));
01004   memset(dcd, 0, <font class="keyword">sizeof</font>(<a class="code" href="structdcdhandle.html">dcdhandle</a>));
01005   dcd-&gt;<a class="code" href="structdcdhandle.html#m0">fd</a> = fd;
01006 
01007   istart = 0;             <font class="comment">/* starting timestep of DCD file                  */</font>
01008   nsavc = 1;              <font class="comment">/* number of timesteps between written DCD frames */</font>
01009   delta = 1.0;            <font class="comment">/* length of a timestep                           */</font>
01010   with_unitcell = 1;      <font class="comment">/* contains unit cell information (charmm format) */</font>
01011   charmm = <a class="code" href="dcdplugin_8c.html#a14">DCD_IS_CHARMM</a>; <font class="comment">/* charmm-formatted DCD file                      */</font> 
01012   <font class="keywordflow">if</font> (with_unitcell) 
01013     charmm |= <a class="code" href="dcdplugin_8c.html#a16">DCD_HAS_EXTRA_BLOCK</a>;
01014   
01015   rc = <a class="code" href="dcdplugin_8c.html#a33">write_dcdheader</a>(dcd-&gt;<a class="code" href="structdcdhandle.html#m0">fd</a>, <font class="stringliteral">"Created by DCD plugin"</font>, natoms, 
01016                        istart, nsavc, delta, with_unitcell, charmm);
01017 
01018   <font class="keywordflow">if</font> (rc &lt; 0) {
01019     <a class="code" href="dcdplugin_8c.html#a25">print_dcderror</a>(<font class="stringliteral">"write_dcdheader"</font>, rc);
01020     <a class="code" href="fastio_8h.html#a9">fio_fclose</a>(dcd-&gt;<a class="code" href="structdcdhandle.html#m0">fd</a>);
01021     free(dcd);
01022     <font class="keywordflow">return</font> NULL;
01023   }
01024 
01025   dcd-&gt;<a class="code" href="structdcdhandle.html#m1">natoms</a> = natoms;
01026   dcd-&gt;<a class="code" href="structdcdhandle.html#m2">nsets</a> = 0;
01027   dcd-&gt;<a class="code" href="structdcdhandle.html#m4">istart</a> = istart;
01028   dcd-&gt;<a class="code" href="structdcdhandle.html#m5">nsavc</a> = nsavc;
01029   dcd-&gt;<a class="code" href="structdcdhandle.html#m16">with_unitcell</a> = with_unitcell;
01030   dcd-&gt;<a class="code" href="structdcdhandle.html#m14">charmm</a> = charmm;
01031   dcd-&gt;<a class="code" href="structdcdhandle.html#m8">x</a> = (<font class="keywordtype">float</font> *)malloc(natoms * <font class="keyword">sizeof</font>(<font class="keywordtype">float</font>));
01032   dcd-&gt;<a class="code" href="structdcdhandle.html#m9">y</a> = (<font class="keywordtype">float</font> *)malloc(natoms * <font class="keyword">sizeof</font>(<font class="keywordtype">float</font>));
01033   dcd-&gt;<a class="code" href="structdcdhandle.html#m10">z</a> = (<font class="keywordtype">float</font> *)malloc(natoms * <font class="keyword">sizeof</font>(<font class="keywordtype">float</font>));
01034   <font class="keywordflow">return</font> dcd;
01035 }
01036 
01037 
<a name="l01038"></a><a class="code" href="dcdplugin_8c.html#a39">01038</a> <font class="keyword">static</font> <font class="keywordtype">int</font> <a class="code" href="pdbplugin_8c.html#a10">write_timestep</a>(<font class="keywordtype">void</font> *v, <font class="keyword">const</font> <a class="code" href="structmolfile__timestep__t.html">molfile_timestep_t</a> *ts) { 
01039   <a class="code" href="structdcdhandle.html">dcdhandle</a> *dcd = (<a class="code" href="structdcdhandle.html">dcdhandle</a> *)v;
01040   <font class="keywordtype">int</font> i, rc, curstep;
01041   <font class="keywordtype">float</font> *pos = ts-&gt;<a class="code" href="structmolfile__timestep__t.html#m0">coords</a>;
01042   <font class="keywordtype">double</font> unitcell[6];
01043   unitcell[0] = unitcell[2] = unitcell[5] = 1.0f;
01044   unitcell[1] = unitcell[3] = unitcell[4] = 90.0f;
01045 
01046   <font class="comment">/* copy atom coords into separate X/Y/Z arrays for writing */</font>
01047   <font class="keywordflow">for</font> (i=0; i&lt;dcd-&gt;<a class="code" href="structdcdhandle.html#m1">natoms</a>; i++) {
01048     dcd-&gt;<a class="code" href="structdcdhandle.html#m8">x</a>[i] = *(pos++); 
01049     dcd-&gt;<a class="code" href="structdcdhandle.html#m9">y</a>[i] = *(pos++); 
01050     dcd-&gt;<a class="code" href="structdcdhandle.html#m10">z</a>[i] = *(pos++); 
01051   }
01052   dcd-&gt;<a class="code" href="structdcdhandle.html#m2">nsets</a>++;
01053   curstep = dcd-&gt;<a class="code" href="structdcdhandle.html#m4">istart</a> + dcd-&gt;<a class="code" href="structdcdhandle.html#m2">nsets</a> * dcd-&gt;<a class="code" href="structdcdhandle.html#m5">nsavc</a>;
01054 
01055   unitcell[0] = ts-&gt;<a class="code" href="structmolfile__timestep__t.html#z4_0">A</a>;
01056   unitcell[2] = ts-&gt;<a class="code" href="structmolfile__timestep__t.html#z4_1">B</a>;
01057   unitcell[5] = ts-&gt;<a class="code" href="structmolfile__timestep__t.html#z4_2">C</a>;
01058   unitcell[1] = sin((<a class="code" href="dcdplugin_8c.html#a0">M_PI_2</a> / 90.0) * (90.0 - ts-&gt;<a class="code" href="structmolfile__timestep__t.html#z4_5">gamma</a>)); <font class="comment">/* cosAB */</font>
01059   unitcell[3] = sin((<a class="code" href="dcdplugin_8c.html#a0">M_PI_2</a> / 90.0) * (90.0 - ts-&gt;<a class="code" href="structmolfile__timestep__t.html#z4_4">beta</a>));  <font class="comment">/* cosAC */</font>
01060   unitcell[4] = sin((<a class="code" href="dcdplugin_8c.html#a0">M_PI_2</a> / 90.0) * (90.0 - ts-&gt;<a class="code" href="structmolfile__timestep__t.html#z4_3">alpha</a>)); <font class="comment">/* cosBC */</font>
01061 
01062   rc = <a class="code" href="dcdplugin_8c.html#a32">write_dcdstep</a>(dcd-&gt;<a class="code" href="structdcdhandle.html#m0">fd</a>, dcd-&gt;<a class="code" href="structdcdhandle.html#m2">nsets</a>, curstep, dcd-&gt;<a class="code" href="structdcdhandle.html#m1">natoms</a>, 
01063                      dcd-&gt;<a class="code" href="structdcdhandle.html#m8">x</a>, dcd-&gt;<a class="code" href="structdcdhandle.html#m9">y</a>, dcd-&gt;<a class="code" href="structdcdhandle.html#m10">z</a>,
01064                      dcd-&gt;<a class="code" href="structdcdhandle.html#m16">with_unitcell</a> ? unitcell : NULL,
01065                      dcd-&gt;<a class="code" href="structdcdhandle.html#m14">charmm</a>);
01066   <font class="keywordflow">if</font> (rc &lt; 0) {
01067     <a class="code" href="dcdplugin_8c.html#a25">print_dcderror</a>(<font class="stringliteral">"write_dcdstep"</font>, rc);
01068     <font class="keywordflow">return</font> <a class="code" href="molfile__plugin_8h.html#a4">MOLFILE_ERROR</a>;
01069   }
01070 
01071   <font class="keywordflow">return</font> <a class="code" href="molfile__plugin_8h.html#a2">MOLFILE_SUCCESS</a>;
01072 }
01073 
<a name="l01074"></a><a class="code" href="dcdplugin_8c.html#a40">01074</a> <font class="keyword">static</font> <font class="keywordtype">void</font> <a class="code" href="pdbplugin_8c.html#a11">close_file_write</a>(<font class="keywordtype">void</font> *v) {
01075   <a class="code" href="structdcdhandle.html">dcdhandle</a> *dcd = (<a class="code" href="structdcdhandle.html">dcdhandle</a> *)v;
01076   <a class="code" href="fastio_8h.html#a9">fio_fclose</a>(dcd-&gt;<a class="code" href="structdcdhandle.html#m0">fd</a>);
01077   free(dcd-&gt;<a class="code" href="structdcdhandle.html#m8">x</a>);
01078   free(dcd-&gt;<a class="code" href="structdcdhandle.html#m9">y</a>);
01079   free(dcd-&gt;<a class="code" href="structdcdhandle.html#m10">z</a>);
01080   free(dcd);
01081 }
01082 
01083 
01084 <font class="comment">/*</font>
01085 <font class="comment"> * Initialization stuff here</font>
01086 <font class="comment"> */</font>
<a name="l01087"></a><a class="code" href="dcdplugin_8c.html#a24">01087</a> <font class="keyword">static</font> <a class="code" href="structmolfile__plugin__t.html">molfile_plugin_t</a> <a class="code" href="dcdplugin_8c.html#a24">dcdplugin</a> = {
01088   <a class="code" href="vmdplugin_8h.html#a10">vmdplugin_ABIVERSION</a>,                         <font class="comment">/* ABI version */</font>
01089   <a class="code" href="molfile__plugin_8h.html#a0">MOLFILE_PLUGIN_TYPE</a>,                          <font class="comment">/* type */</font>
01090   <font class="stringliteral">"dcd"</font>,                                        <font class="comment">/* short name */</font>
01091   <font class="stringliteral">"CHARMM,NAMD,XPLOR DCD Trajectory"</font>,           <font class="comment">/* pretty name */</font>
01092   <font class="stringliteral">"Justin Gullingsrud, John Stone"</font>,             <font class="comment">/* author */</font>
01093   1,                                            <font class="comment">/* major version */</font>
01094   8,                                            <font class="comment">/* minor version */</font>
01095   <a class="code" href="vmdplugin_8h.html#a12">VMDPLUGIN_THREADSAFE</a>,                         <font class="comment">/* is reentrant  */</font>
01096   <font class="stringliteral">"dcd"</font>,                                        <font class="comment">/* filename extension */</font>
01097   <a class="code" href="dcdplugin_8c.html#a35">open_dcd_read</a>,
01098   0,
01099   0,
01100   <a class="code" href="dcdplugin_8c.html#a36">read_next_timestep</a>,
01101   <a class="code" href="dcdplugin_8c.html#a37">close_file_read</a>,
01102   <a class="code" href="dcdplugin_8c.html#a38">open_dcd_write</a>,
01103   0,
01104   <a class="code" href="dcdplugin_8c.html#a39">write_timestep</a>,
01105   <a class="code" href="dcdplugin_8c.html#a40">close_file_write</a>
01106 };
01107 
<a name="l01108"></a><a class="code" href="dcdplugin_8c.html#a41">01108</a> <a class="code" href="vmdplugin_8h.html#a7">VMDPLUGIN_API</a> <font class="keywordtype">int</font> <a class="code" href="vmdplugin_8h.html#a5">VMDPLUGIN_init</a>() {
01109   <font class="keywordflow">return</font> <a class="code" href="vmdplugin_8h.html#a13">VMDPLUGIN_SUCCESS</a>;
01110 }
01111 
<a name="l01112"></a><a class="code" href="dcdplugin_8c.html#a42">01112</a> <a class="code" href="vmdplugin_8h.html#a7">VMDPLUGIN_API</a> <font class="keywordtype">int</font> <a class="code" href="vmdplugin_8h.html#a3">VMDPLUGIN_register</a>(<font class="keywordtype">void</font> *v, <a class="code" href="vmdplugin_8h.html#a15">vmdplugin_register_cb</a> cb) {
01113   (*cb)(v, (<a class="code" href="structvmdplugin__t.html">vmdplugin_t</a> *)&amp;dcdplugin);
01114   <font class="keywordflow">return</font> <a class="code" href="vmdplugin_8h.html#a13">VMDPLUGIN_SUCCESS</a>;
01115 }
01116 
<a name="l01117"></a><a class="code" href="dcdplugin_8c.html#a43">01117</a> <a class="code" href="vmdplugin_8h.html#a7">VMDPLUGIN_API</a> <font class="keywordtype">int</font> <a class="code" href="vmdplugin_8h.html#a6">VMDPLUGIN_fini</a>() {
01118   <font class="keywordflow">return</font> <a class="code" href="vmdplugin_8h.html#a13">VMDPLUGIN_SUCCESS</a>;
01119 }
01120 
01121   
01122 <font class="preprocessor">#ifdef TEST_DCDPLUGIN</font>
01123 <font class="preprocessor"></font>
01124 <font class="preprocessor">#include &lt;sys/time.h&gt;</font>
01125 
01126 <font class="comment">/* get the time of day from the system clock, and store it (in seconds) */</font>
01127 <font class="keywordtype">double</font> time_of_day(<font class="keywordtype">void</font>) {
01128 <font class="preprocessor">#if defined(_MSC_VER)</font>
01129 <font class="preprocessor"></font>  <font class="keywordtype">double</font> t;
01130 
01131   t = GetTickCount();
01132   t = t / 1000.0;
01133 
01134   <font class="keywordflow">return</font> t;
01135 <font class="preprocessor">#else</font>
01136 <font class="preprocessor"></font>  <font class="keyword">struct </font>timeval tm;
01137   <font class="keyword">struct </font>timezone tz;
01138 
01139   gettimeofday(&amp;tm, &amp;tz);
01140   <font class="keywordflow">return</font>((double)(tm.tv_sec) + (double)(tm.tv_usec)/1000000.0);
01141 <font class="preprocessor">#endif</font>
01142 <font class="preprocessor"></font>}
01143 
01144 <font class="keywordtype">int</font> <a class="code" href="main_8c.html#a3">main</a>(<font class="keywordtype">int</font> argc, <font class="keywordtype">char</font> *argv[]) {
01145   <a class="code" href="structmolfile__timestep__t.html">molfile_timestep_t</a> timestep;
01146   <font class="keywordtype">void</font> *v;
01147   <a class="code" href="structdcdhandle.html">dcdhandle</a> *dcd;
01148   <font class="keywordtype">int</font> i, natoms;
01149   <font class="keywordtype">float</font> sizeMB =0.0, totalMB = 0.0;
01150   <font class="keywordtype">double</font> starttime, endtime, totaltime = 0.0;
01151 
01152   <font class="keywordflow">while</font> (--argc) {
01153     ++argv; 
01154     natoms = 0;
01155     v = <a class="code" href="dcdplugin_8c.html#a35">open_dcd_read</a>(*argv, <font class="stringliteral">"dcd"</font>, &amp;natoms);
01156     <font class="keywordflow">if</font> (!v) {
01157       fprintf(stderr, <font class="stringliteral">"main) open_dcd_read failed for file %s\n"</font>, *argv);
01158       <font class="keywordflow">return</font> 1;
01159     }
01160     dcd = (<a class="code" href="structdcdhandle.html">dcdhandle</a> *)v;
01161     sizeMB = ((natoms * 3.0) * dcd-&gt;<a class="code" href="structdcdhandle.html#m2">nsets</a> * 4.0) / (1024.0 * 1024.0);
01162     totalMB += sizeMB; 
01163     printf(<font class="stringliteral">"main) file: %s\n"</font>, *argv);
01164     printf(<font class="stringliteral">"  %d atoms, %d frames, size: %6.1fMB\n"</font>, natoms, dcd-&gt;<a class="code" href="structdcdhandle.html#m2">nsets</a>, sizeMB);
01165 
01166     starttime = time_of_day();
01167     timestep.<a class="code" href="structmolfile__timestep__t.html#m0">coords</a> = (<font class="keywordtype">float</font> *)malloc(3*<font class="keyword">sizeof</font>(<font class="keywordtype">float</font>)*natoms);
01168     <font class="keywordflow">for</font> (i=0; i&lt;dcd-&gt;<a class="code" href="structdcdhandle.html#m2">nsets</a>; i++) {
01169       <font class="keywordtype">int</font> rc = <a class="code" href="webpdbplugin_8c.html#a8">read_next_timestep</a>(v, natoms, &amp;timestep);
01170       <font class="keywordflow">if</font> (rc) {
01171         fprintf(stderr, <font class="stringliteral">"error in read_next_timestep on frame %d\n"</font>, i);
01172         <font class="keywordflow">return</font> 1;
01173       }
01174     }
01175     endtime = time_of_day();
01176     <a class="code" href="stlplugin_8C.html#a4">close_file_read</a>(v);
01177     totaltime += endtime - starttime;
01178     printf(<font class="stringliteral">"  Time: %5.1f seconds\n"</font>, endtime - starttime);
01179     printf(<font class="stringliteral">"  Speed: %5.1f MB/sec, %5.1f timesteps/sec\n"</font>, sizeMB / (endtime - starttime), (dcd-&gt;<a class="code" href="structdcdhandle.html#m2">nsets</a> / (endtime - starttime)));
01180   }
01181   printf(<font class="stringliteral">"Overall Size: %6.1f MB\n"</font>, totalMB);
01182   printf(<font class="stringliteral">"Overall Time: %6.1f seconds\n"</font>, totaltime);
01183   printf(<font class="stringliteral">"Overall Speed: %5.1f MB/sec\n"</font>, totalMB / totaltime);
01184   <font class="keywordflow">return</font> 0;
01185 }
01186       
01187 <font class="preprocessor">#endif</font>
01188 <font class="preprocessor"></font>
</pre></div><hr><address><small>Generated on Wed Mar 22 13:15:28 2006 for VMD Plugins (current) by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.gif" alt="doxygen" align="middle" border=0 
width=110 height=53></a>1.2.14 written by <a href="mailto:dimitri@stack.nl">Dimitri van Heesch</a>,
 &copy;&nbsp;1997-2002</small></address>
</body>
</html>
