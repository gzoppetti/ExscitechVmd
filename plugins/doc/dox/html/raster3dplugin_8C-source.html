<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>raster3dplugin.C Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.2.14 -->
<center>
<a class="qindex" href="index.html">Main Page</a> &nbsp; <a class="qindex" href="classes.html">Alphabetical List</a> &nbsp; <a class="qindex" href="annotated.html">Compound List</a> &nbsp; <a class="qindex" href="files.html">File List</a> &nbsp; <a class="qindex" href="functions.html">Compound Members</a> &nbsp; <a class="qindex" href="globals.html">File Members</a> &nbsp; <a class="qindex" href="pages.html">Related Pages</a> &nbsp; </center>
<hr><h1>raster3dplugin.C</h1><a href="raster3dplugin_8C.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 
00002 <font class="comment">/***************************************************************************</font>
00003 <font class="comment"> *cr</font>
00004 <font class="comment"> *cr            (C) Copyright 1995-2006 The Board of Trustees of the</font>
00005 <font class="comment"> *cr                        University of Illinois</font>
00006 <font class="comment"> *cr                         All Rights Reserved</font>
00007 <font class="comment"> *cr</font>
00008 <font class="comment"> ***************************************************************************/</font>
00009 
00010 <font class="preprocessor">#include &lt;stdio.h&gt;</font>
00011 <font class="preprocessor">#include &lt;math.h&gt;</font>
00012 <font class="preprocessor">#include &lt;string.h&gt;</font>
00013 <font class="preprocessor">#include &lt;stdlib.h&gt;</font>
00014 
00015 <font class="preprocessor">#include "<a class="code" href="molfile__plugin_8h.html">molfile_plugin.h</a>"</font>
00016 
<a name="l00017"></a><a class="code" href="structhandle__t.html">00017</a> <font class="keyword">typedef</font> <font class="keyword">struct </font>{
<a name="l00018"></a><a class="code" href="structhandle__t.html#m0">00018</a>   FILE *fd;
<a name="l00019"></a><a class="code" href="structhandle__t.html#m1">00019</a>   <a class="code" href="structmolfile__graphics__t.html">molfile_graphics_t</a> *graphics;
00020 } <a class="code" href="structhandle__t.html">handle_t</a>;
00021 
<a name="l00022"></a><a class="code" href="raster3dplugin_8C.html#a1">00022</a> <font class="keyword">static</font> <font class="keywordtype">void</font> *<a class="code" href="webpdbplugin_8c.html#a5">open_file_read</a>(<font class="keyword">const</font> <font class="keywordtype">char</font> *filepath, <font class="keyword">const</font> <font class="keywordtype">char</font> *filetype,
00023     <font class="keywordtype">int</font> *natoms) {
00024   FILE *fd;
00025   <a class="code" href="structhandle__t.html">handle_t</a> *handle;
00026   
00027   fd = fopen(filepath, <font class="stringliteral">"rt"</font>);
00028   <font class="keywordflow">if</font> (!fd) 
00029     <font class="keywordflow">return</font> NULL;
00030   handle = <font class="keyword">new</font> <a class="code" href="structhandle__t.html">handle_t</a>;
00031   handle-&gt;<a class="code" href="structhandle__t.html#m0">fd</a> = fd;
00032   handle-&gt;<a class="code" href="structhandle__t.html#m1">graphics</a> = NULL;
00033   *natoms = 0;
00034   <font class="keywordflow">return</font> handle;
00035 }
00036 
<a name="l00037"></a><a class="code" href="raster3dplugin_8C.html#a2">00037</a> <font class="keyword">static</font> <font class="keywordtype">void</font> <a class="code" href="raster3dplugin_8C.html#a2">next_elem</a>(<font class="keywordtype">int</font> &amp;n, <font class="keywordtype">int</font> &amp;max, <a class="code" href="structmolfile__graphics__t.html">molfile_graphics_t</a> *&amp; graphics) {
00038   ++n;
00039   <font class="keywordflow">if</font> (n == max) {
00040     max *= 2;
00041     graphics = (<a class="code" href="structmolfile__graphics__t.html">molfile_graphics_t</a> *)realloc(graphics, max*<font class="keyword">sizeof</font>(<a class="code" href="structmolfile__graphics__t.html">molfile_graphics_t</a>));
00042   }
00043 }
00044 
00045 <font class="comment">// gets a line of text from the file, ignoring comments</font>
<a name="l00046"></a><a class="code" href="raster3dplugin_8C.html#a3">00046</a> <font class="keyword">static</font> <font class="keywordtype">int</font> <a class="code" href="raster3dplugin_8C.html#a3">get_line</a>(<font class="keywordtype">int</font> &amp;line, <font class="keywordtype">char</font> *buf, <font class="keywordtype">int</font> len, FILE *f) {
00047    <font class="keywordflow">do</font> {
00048       line++;
00049       <font class="keywordflow">if</font> (!fgets(buf, len - 1, f)) <font class="keywordflow">return</font> 0;
00050    } <font class="keywordflow">while</font> (buf[0] == <font class="charliteral">'#'</font>);
00051    <font class="keywordflow">return</font> 1;
00052 }
00053 
<a name="l00054"></a><a class="code" href="raster3dplugin_8C.html#a4">00054</a> <font class="keyword">static</font> <font class="keywordtype">int</font> <a class="code" href="stlplugin_8C.html#a3">read_rawgraphics</a>(<font class="keywordtype">void</font> *v, <font class="keywordtype">int</font> *nelem, 
00055     <font class="keyword">const</font> <a class="code" href="structmolfile__graphics__t.html">molfile_graphics_t</a> **gdata) {
00056 
00057 <font class="comment">/* TODO</font>
00058 <font class="comment"> *</font>
00059 <font class="comment"> * 1. doesn't properly render capped cylinders</font>
00060 <font class="comment"> * 2. needs to handle object types 15, 19, 9 (affects coordinate system);</font>
00061 <font class="comment"> *    needs to first understand VMD's coordinate system.</font>
00062 <font class="comment"> * 3. doesn't properly handle object type 8 (material definitions)</font>
00063 <font class="comment"> * 4. doesn't properly handle object type 14 (quadrics)</font>
00064 <font class="comment"> * 5. doesn't properly support file indirection (using '@')</font>
00065 <font class="comment"> * 6. doesn't differentiate between round-ended cylinders (obj 3)</font>
00066 <font class="comment"> *    and flat-ended cylinders (obj 5)</font>
00067 <font class="comment"> * 7. doesn't handle planes</font>
00068 <font class="comment"> * 8. doesn't support text (object types 10-12)</font>
00069 <font class="comment"> * 9. doesn't handle depth cueing and transformations in global</font>
00070 <font class="comment"> *    properties (object 16)</font>
00071 <font class="comment"> */</font>
00072 
00074 <font class="comment">// TITLE (80 chars)</font>
00075 <font class="comment">// NTX, NTY (number of tiles -- ignored)</font>
00076 <font class="comment">// NPX, NPY (number of points per tile -- ignored)</font>
00077 <font class="comment">// SCHEME (antialiasing scheme -- ignored)</font>
00078 <font class="comment">// BKGND (background color -- ignored)</font>
00079 <font class="comment">// SHADOW (T/F -- ignored)</font>
00080 <font class="comment">// IPHONG (phong power -- ignored)</font>
00081 <font class="comment">// STRAIT (secondary light source -- ignored)</font>
00082 <font class="comment">// AMBIEN (ambient illumination -- ignored)</font>
00083 <font class="comment">// SPECLR ignored</font>
00084 <font class="comment">// EYEPOS ignored</font>
00085 <font class="comment">// SOURCE ignored</font>
00086 <font class="comment">// TMAT 4x4 matrix used to view the system</font>
00087 <font class="comment">// object mode (1 == triangle, 2 == spheres, or 3 ==  mixed)</font>
00088 <font class="comment">// INFMTS  --  FORTRAN input field specifications</font>
00089 <font class="comment">//   for input format specifiers 1/6, 2, and 3/5</font>
00090 <font class="comment">//   triangle(1) or plane(6) (x1,y1,z1)-(x2,y2,z2)-(x3,y3,z3) (r,g,b)</font>
00091 <font class="comment">//   sphere(2)      (x,y,z) r (r,g,b)</font>
00092 <font class="comment">//   cylinder(3,5)  (x1,y1,z1) R1 - (x2,y2,z2) R2(is ignored) (r,g,b)</font>
00093 <font class="comment">//                      except if one radius is 0, a cone is made</font>
00094 <font class="comment">//   I ignore these lines and just read them in as "%f"</font>
00095 
00096    <font class="keywordtype">int</font> futureVersion = 0;
00097    <font class="keywordtype">int</font> line = 0;
00098 
00099    <font class="keywordtype">int</font> count, i;
00100    <font class="keywordtype">char</font> buffer[200];
00101    <font class="keywordtype">float</font> mat[16];
00102    FILE *infile;
00103 
00104    <a class="code" href="structhandle__t.html">handle_t</a> *handle = (<a class="code" href="structhandle__t.html">handle_t</a> *)v;
00105    infile = handle-&gt;<a class="code" href="structhandle__t.html#m0">fd</a>;
00106 
00107    <font class="keywordtype">int</font> maxelem = 10;
00108    <font class="keywordtype">int</font> n = 0;
00109    <a class="code" href="structmolfile__graphics__t.html">molfile_graphics_t</a> *graphics = (<a class="code" href="structmolfile__graphics__t.html">molfile_graphics_t</a> *)malloc(
00110        maxelem*<font class="keyword">sizeof</font>(<a class="code" href="structmolfile__graphics__t.html">molfile_graphics_t</a>));
00111 
00112    <font class="comment">// XXX This should probably be in open_file_read</font>
00113    <font class="keywordflow">if</font> (!<a class="code" href="raster3dplugin_8C.html#a3">get_line</a>(line, buffer, 199, infile)) {
00114       fprintf(stderr, <font class="stringliteral">"Raster3D input: error reading file header (line %d)\n"</font>,
00115           line);
00116       <font class="keywordflow">return</font> <a class="code" href="molfile__plugin_8h.html#a4">MOLFILE_ERROR</a>;
00117    }
00118 
00119    <font class="comment">// tell the user info about the file</font>
00120    <font class="keywordflow">for</font> (i = strlen(buffer) - 1; i &gt;= 0 &amp;&amp;
00121         (buffer[i] == 10 || buffer[i] == 13); i--) buffer[i] = 0;
00122    printf(<font class="stringliteral">"Raster3D input: scene title: '%s'\n"</font>, buffer);
00123 
00124    <font class="comment">// The next 11 lines of text contain more header information</font>
00125    <font class="comment">// about lighting, anti aliasing, image size, etc. This can be</font>
00126    <font class="comment">// ignored.</font>
00127    <font class="keywordflow">for</font> (count = 0; count &lt; 11; count++) {
00128       <font class="keywordflow">if</font> (!<a class="code" href="raster3dplugin_8C.html#a3">get_line</a>(line, buffer, 199, infile)) {
00129          fprintf(stderr, 
00130              <font class="stringliteral">"Raster3D input: error reading file header (line %d)\n"</font>, line);
00131          <font class="keywordflow">return</font> <a class="code" href="molfile__plugin_8h.html#a4">MOLFILE_ERROR</a>;
00132       }
00133    }
00134 
00135    <font class="comment">// Now I have to get the matrix.  This is made nasty since</font>
00136    <font class="comment">// there could be extra text after the first four numbers on a line</font>
00137    <font class="comment">// as in: 1 0 0 0 This is an extra comment</font>
00138    <font class="keywordflow">for</font> (i=0; i&lt;4; i++) {
00139       <a class="code" href="raster3dplugin_8C.html#a3">get_line</a>(line, buffer, 199, infile);  <font class="comment">// read the whole line into a string</font>
00140       <font class="keywordflow">if</font> (sscanf(buffer, <font class="stringliteral">"%f %f %f %f"</font>,
00141                  &amp;mat[4*i], &amp;mat[4*i+1], &amp;mat[4*i+2], &amp;mat[4*i+3])&lt;4) {
00142          fprintf(stderr, <font class="stringliteral">"Raster3D input: invalid format in file (line %d)\n"</font>,
00143              line);
00144          <font class="keywordflow">return</font> <a class="code" href="molfile__plugin_8h.html#a4">MOLFILE_ERROR</a>;
00145       }
00146    }
00147 
00148    <a class="code" href="raster3dplugin_8C.html#a3">get_line</a>(line, buffer, 199, infile);
00149    <font class="keywordflow">if</font> (sscanf(buffer, <font class="stringliteral">"%d"</font>, &amp;i) &lt; 1) {
00150      fprintf(stderr, 
00151          <font class="stringliteral">"Raster3D input: error reading object input mode (line %d)\n"</font>, line);
00152      <font class="keywordflow">return</font> <a class="code" href="molfile__plugin_8h.html#a4">MOLFILE_ERROR</a>;
00153    }
00154 
00155    <font class="keywordflow">if</font> (i != 3) {
00156       fprintf(stderr, 
00157           <font class="stringliteral">"Raster3D input: the specified file is in an unsupported format\n"</font>);
00158       fprintf(stderr, 
00159           <font class="stringliteral">"(object input mode %d). Aborting.\n"</font>, i);
00160       <font class="keywordflow">return</font> <a class="code" href="molfile__plugin_8h.html#a4">MOLFILE_ERROR</a>;
00161    }
00162 
00163    <font class="keywordtype">float</font> data[15];
00164    <font class="keywordtype">float</font> normals[15];
00165    <font class="keywordtype">float</font> tricolors[9];
00166    <font class="keywordtype">float</font> color[9];
00167 
00168       <font class="comment">// INFMT/INFMTS input specifiers; these can specifiy Fortran formatted</font>
00169       <font class="comment">// input formats, but are usually "*" meaning free-format input. We</font>
00170       <font class="comment">// give a warning if it's not free-format.</font>
00171       <font class="keywordflow">for</font> (count = 0; count &lt; 3; count++) {
00172          <a class="code" href="raster3dplugin_8C.html#a3">get_line</a>(line, buffer, 199, infile);
00173          <font class="keywordflow">for</font> (i = strlen(buffer) - 1; i &gt;= 0 &amp;&amp; (buffer[i] == 10 || buffer[i] == 13); i--)
00174             buffer[i] = 0;
00175          <font class="keywordflow">if</font> (strcmp(buffer, <font class="stringliteral">"*"</font>)) <font class="keywordflow">break</font>;
00176       }
00177       <font class="keywordflow">if</font> (count &lt; 3) {  
00178         fprintf(stderr, <font class="stringliteral">"Raster3D input: Warning: this file contains input in a nonstandard\n"</font>);
00179         fprintf(stderr, <font class="stringliteral">"Fortran format. This is generally not supported, and the read may fail.\n"</font>);
00180       }
00181       count = 0;
00182 
00183       <font class="keywordflow">while</font> (!feof(infile) &amp;&amp; !ferror(infile)) {
00184          <font class="keywordtype">int</font> objtype = -1;
00185 
00186          <font class="keywordflow">if</font> (!<a class="code" href="raster3dplugin_8C.html#a3">get_line</a>(line, buffer, 199, infile)) <font class="keywordflow">continue</font>;
00187 
00188          <font class="keywordflow">if</font> (sscanf(buffer, <font class="stringliteral">"%d"</font>, &amp;objtype) != 1) {
00189             fprintf(stderr, <font class="stringliteral">"Raster3D input: bad data in file (line %d)\n"</font>,
00190                 line);
00191             <font class="keywordflow">return</font> <a class="code" href="molfile__plugin_8h.html#a4">MOLFILE_ERROR</a>;
00192          }
00193 
00194          <font class="keywordflow">switch</font>(objtype) {
00195 
00196             <font class="keywordflow">case</font> 1: <font class="comment">// triangle</font>
00197                <font class="keywordtype">char</font> buffer2[200];
00198                <font class="keywordtype">int</font> have_normals;
00199                <font class="keywordtype">int</font> have_tricolors;
00200                <font class="keywordtype">long</font> fpos;
00201 
00202                have_normals = 0;
00203                have_tricolors = 0;
00204 
00205                <a class="code" href="raster3dplugin_8C.html#a3">get_line</a>(line, buffer, 127, infile);
00206                <font class="keywordflow">if</font> (feof(infile)) {
00207                   <font class="comment">//msgErr &lt;&lt; "Raster3D input: error reading triangle data (line "</font>
00208                          <font class="comment">//&lt;&lt; line &lt;&lt; ")" &lt;&lt; sendmsg;</font>
00209                   <font class="keywordflow">return</font> <a class="code" href="molfile__plugin_8h.html#a4">MOLFILE_ERROR</a>;
00210                }
00211 
00212                <font class="keywordflow">if</font> (sscanf(buffer, <font class="stringliteral">"%f %f %f %f %f %f %f %f %f %f %f %f"</font>,
00213                           data  , data+1, data+2,
00214                           data+3, data+4, data+5,
00215                           data+6, data+7, data+8,
00216                           data+9, data+10, data+11) &lt; 12) { 
00217                   <font class="comment">//msgErr &lt;&lt; "Raster3D input: bad triangle data in file (line "</font>
00218                          <font class="comment">//&lt;&lt; line &lt;&lt; "). Will try to continue." &lt;&lt; sendmsg;</font>
00219                   <font class="keywordflow">continue</font>;
00220                }
00221 
00222                <font class="keywordflow">while</font> (!feof(infile) &amp;&amp; !ferror(infile)) {
00223 
00224                   fpos = ftell(infile);
00225                   <font class="keywordflow">if</font> (!<a class="code" href="raster3dplugin_8C.html#a3">get_line</a>(line, buffer2, 199, infile)) {
00226                      fseek(infile, fpos, SEEK_SET);
00227                      <font class="keywordflow">break</font>;
00228                   }
00229 
00230                   <font class="keywordflow">if</font> (sscanf(buffer2, <font class="stringliteral">"%d"</font>, &amp;objtype) != 1) {
00231                      <font class="comment">//msgErr &lt;&lt; "Raster3D input: bad data in file (line " &lt;&lt; line</font>
00232                             <font class="comment">//&lt;&lt; "). Aborting." &lt;&lt; sendmsg;</font>
00233                      <font class="keywordflow">return</font> <a class="code" href="molfile__plugin_8h.html#a4">MOLFILE_ERROR</a>;
00234                   }
00235 
00236                   <font class="keywordflow">switch</font> (objtype) {
00237                      <font class="keywordflow">case</font> 7: <font class="comment">// explicit normals</font>
00238 
00239                         <font class="keywordflow">if</font> (!<a class="code" href="raster3dplugin_8C.html#a3">get_line</a>(line, buffer2, 199, infile)) {
00240                            <font class="comment">//msgErr &lt;&lt; "Raster3D input: read error in file (line " &lt;&lt; line</font>
00241                                   <font class="comment">//&lt;&lt; "). Aborting." &lt;&lt; sendmsg;</font>
00242                            <font class="keywordflow">return</font> <a class="code" href="molfile__plugin_8h.html#a4">MOLFILE_ERROR</a>;
00243                         }
00244 
00245                         <font class="keywordflow">if</font> (sscanf(buffer2, <font class="stringliteral">"%f %f %f %f %f %f %f %f %f"</font>,
00246                                    normals  , normals+1, normals+2,
00247                                    normals+3, normals+4, normals+5,
00248                                    normals+6, normals+7, normals+8 ) &lt; 9) { 
00249                            <font class="comment">//msgErr &lt;&lt; "Raster3D input: error reading triangle normals (line "</font>
00250                                   <font class="comment">//&lt;&lt; line &lt;&lt; "). Will try to continue." &lt;&lt; sendmsg;</font>
00251                            <font class="keywordflow">continue</font>;
00252                         }
00253 
00254                         have_normals = 1;
00255 
00256                         <font class="keywordflow">break</font>;
00257 
00258                      <font class="keywordflow">case</font> 17: <font class="comment">// colors at vertices of a tri-color</font>
00259 
00260                         <font class="keywordflow">if</font> (!<a class="code" href="raster3dplugin_8C.html#a3">get_line</a>(line, buffer2, 199, infile)) {
00261                            <font class="comment">//msgErr &lt;&lt; "Raster3D input: read error in file (line " &lt;&lt; line</font>
00262                                   <font class="comment">//&lt;&lt; "). Aborting." &lt;&lt; sendmsg;</font>
00263                            <font class="keywordflow">return</font> <a class="code" href="molfile__plugin_8h.html#a4">MOLFILE_ERROR</a>;
00264                         }
00265 
00266                         <font class="keywordflow">if</font> (sscanf(buffer2, <font class="stringliteral">"%f %f %f %f %f %f %f %f %f"</font>,
00267                                    tricolors,  tricolors+ 1, tricolors + 2,
00268                                    tricolors + 3, tricolors + 4, tricolors + 5,
00269                                    tricolors + 6, tricolors + 7, tricolors + 8) &lt; 9) {
00270                            <font class="comment">//msgErr &lt;&lt; "Raster3D input: error reading vertex colors (line "</font>
00271                                   <font class="comment">//&lt;&lt; line &lt;&lt; "). Will try to continue." &lt;&lt; sendmsg;</font>
00272                            <font class="keywordflow">continue</font>;
00273                         }
00274 
00275                         have_tricolors = 1;
00276 
00277                         <font class="keywordflow">break</font>;
00278 
00279                      <font class="keywordflow">default</font>:
00280 
00281                         fseek(infile, fpos, SEEK_SET);
00282                         fpos = 0;
00283                         <font class="keywordflow">break</font>;
00284 
00285                   }
00286 
00287                   <font class="keywordflow">if</font> (!fpos) <font class="keywordflow">break</font>;
00288                }
00289 
00290                <font class="keywordflow">if</font> (ferror(infile)) {
00291                   <font class="comment">//msgErr &lt;&lt; "Raster3D input: read error in file (line "</font>
00292                            <font class="comment">//&lt;&lt; line &lt;&lt; "). Aborting." &lt;&lt; sendmsg;</font>
00293                   <font class="keywordflow">return</font> <a class="code" href="molfile__plugin_8h.html#a4">MOLFILE_ERROR</a>;
00294                }
00295 
00296                             graphics[n].<a class="code" href="structmolfile__graphics__t.html#m0">type</a> = <a class="code" href="molfile__plugin_8h.html#a30a28">MOLFILE_COLOR</a>;
00297                             graphics[n].<a class="code" href="structmolfile__graphics__t.html#m3">data</a>[0] = sqrt(data[9]);
00298                             graphics[n].<a class="code" href="structmolfile__graphics__t.html#m3">data</a>[1] = sqrt(data[10]);
00299                             graphics[n].<a class="code" href="structmolfile__graphics__t.html#m3">data</a>[2] = sqrt(data[11]);
00300                             <a class="code" href="raster3dplugin_8C.html#a2">next_elem</a>(n, maxelem, graphics);
00301 
00302                <font class="keywordflow">if</font> (have_tricolors) {
00303                  <font class="keywordflow">for</font> (<font class="keywordtype">int</font> qq=0; qq&lt;9; qq++) color[qq] = sqrt(tricolors[qq]);
00304                }
00305 
00306                <font class="keywordflow">if</font> (!have_normals &amp;&amp; !have_tricolors) {
00307                  graphics[n].<a class="code" href="structmolfile__graphics__t.html#m0">type</a> = <a class="code" href="molfile__plugin_8h.html#a30a19">MOLFILE_TRIANGLE</a>;
00308                  memcpy(graphics[n].data, data, 3*<font class="keyword">sizeof</font>(<font class="keywordtype">float</font>));
00309                  <a class="code" href="raster3dplugin_8C.html#a2">next_elem</a>(n, maxelem, graphics);
00310 
00311                } <font class="keywordflow">else</font> <font class="keywordflow">if</font> (have_normals &amp;&amp; !have_tricolors) {
00312            graphics[n].<a class="code" href="structmolfile__graphics__t.html#m0">type</a> = <a class="code" href="molfile__plugin_8h.html#a30a20">MOLFILE_TRINORM</a>;
00313            memcpy(graphics[n].data, data, 9*<font class="keyword">sizeof</font>(<font class="keywordtype">float</font>));
00314            <a class="code" href="raster3dplugin_8C.html#a2">next_elem</a>(n, maxelem, graphics);
00315            graphics[n].<a class="code" href="structmolfile__graphics__t.html#m0">type</a> = <a class="code" href="molfile__plugin_8h.html#a30a21">MOLFILE_NORMS</a>;
00316            memcpy(graphics[n].data, normals, 9*<font class="keyword">sizeof</font>(<font class="keywordtype">float</font>));
00317            <a class="code" href="raster3dplugin_8C.html#a2">next_elem</a>(n, maxelem, graphics);
00318                } <font class="keywordflow">else</font> <font class="keywordflow">if</font> (have_tricolors &amp;&amp; !have_normals) {
00319 <font class="preprocessor">#if 0</font>
00320 <font class="preprocessor"></font>
00321                   <font class="keywordtype">float</font> tmp1[3], tmp2[3], tmp3[3];
00322                   <font class="keywordtype">int</font> j;
00323                   <font class="keywordflow">for</font> (j = 0; j &lt; 3; j++) {
00324                      tmp1[j] = data[3 + j] - data[j];
00325                      tmp2[j] = data[6 + j] - data[3 + j];
00326                   }
00327                   cross_prod(tmp3, tmp1, tmp2);
00328                   vec_normalize(tmp3);
00329                   triclr.putdata(data, data+3, data+6,
00330                                  tmp3, tmp3, tmp3,
00331                                  colorIndices[0], colorIndices[1], colorIndices[2], cmdList);
00332 <font class="preprocessor">#else</font>
00333 <font class="preprocessor"></font>                  <font class="comment">// XXX Take the average of the color</font>
00334                   graphics[n].<a class="code" href="structmolfile__graphics__t.html#m0">type</a> = <a class="code" href="molfile__plugin_8h.html#a30a28">MOLFILE_COLOR</a>;
00335                   graphics[n].<a class="code" href="structmolfile__graphics__t.html#m3">data</a>[0] = (color[0]+color[3]+color[6])/3.0f;
00336                   graphics[n].<a class="code" href="structmolfile__graphics__t.html#m3">data</a>[1] = (color[1]+color[4]+color[7])/3.0f;
00337                   graphics[n].<a class="code" href="structmolfile__graphics__t.html#m3">data</a>[2] = (color[2]+color[5]+color[8])/3.0f;
00338                   <a class="code" href="raster3dplugin_8C.html#a2">next_elem</a>(n, maxelem, graphics);
00339                   graphics[n].<a class="code" href="structmolfile__graphics__t.html#m0">type</a> = <a class="code" href="molfile__plugin_8h.html#a30a19">MOLFILE_TRIANGLE</a>;
00340                   memcpy(graphics[n].data, data, 3*<font class="keyword">sizeof</font>(<font class="keywordtype">float</font>));
00341                   <a class="code" href="raster3dplugin_8C.html#a2">next_elem</a>(n, maxelem, graphics);
00342 
00343 <font class="preprocessor">#endif</font>
00344 <font class="preprocessor"></font>               } <font class="keywordflow">else</font> {
00345 
00346 <font class="preprocessor">#if 0</font>
00347 <font class="preprocessor"></font>                  triclr.putdata(data, data+3, data+6,
00348                                  normals, normals+3, normals+6,
00349                                  colorIndices[0], colorIndices[1], colorIndices[2], cmdList);
00350 <font class="preprocessor">#else</font>
00351 <font class="preprocessor"></font>           graphics[n].<a class="code" href="structmolfile__graphics__t.html#m0">type</a> = <a class="code" href="molfile__plugin_8h.html#a30a29">MOLFILE_TRICOLOR</a>;
00352            memcpy(graphics[n].data, data, 9*<font class="keyword">sizeof</font>(<font class="keywordtype">float</font>));
00353            <a class="code" href="raster3dplugin_8C.html#a2">next_elem</a>(n, maxelem, graphics);
00354            graphics[n].<a class="code" href="structmolfile__graphics__t.html#m0">type</a> = <a class="code" href="molfile__plugin_8h.html#a30a21">MOLFILE_NORMS</a>;
00355            memcpy(graphics[n].data, normals, 9*<font class="keyword">sizeof</font>(<font class="keywordtype">float</font>));
00356            <a class="code" href="raster3dplugin_8C.html#a2">next_elem</a>(n, maxelem, graphics);
00357            graphics[n].<a class="code" href="structmolfile__graphics__t.html#m0">type</a> = <a class="code" href="molfile__plugin_8h.html#a30a28">MOLFILE_COLOR</a>;
00358            memcpy(graphics[n].data, color, 9*<font class="keyword">sizeof</font>(<font class="keywordtype">float</font>));
00359            <a class="code" href="raster3dplugin_8C.html#a2">next_elem</a>(n, maxelem, graphics);
00360 <font class="preprocessor">#endif</font>
00361 <font class="preprocessor"></font>               }
00362 
00363                <font class="keywordflow">break</font>;
00364 
00365             <font class="keywordflow">case</font> 2: <font class="comment">// sphere</font>
00366 
00367                <font class="keywordflow">if</font> (!<a class="code" href="raster3dplugin_8C.html#a3">get_line</a>(line, buffer, 199, infile)) {
00368                   <font class="comment">//msgErr &lt;&lt; "Raster3D input: error reading sphere data (line "</font>
00369                          <font class="comment">//&lt;&lt; line &lt;&lt; ")" &lt;&lt; sendmsg;</font>
00370                   <font class="keywordflow">return</font> <a class="code" href="molfile__plugin_8h.html#a4">MOLFILE_ERROR</a>;
00371                }
00372 
00373                <font class="keywordflow">if</font> (sscanf(buffer, <font class="stringliteral">"%f %f %f %f %f %f %f"</font>,
00374                           data, data + 1, data + 2, data + 3,
00375                           data + 4, data + 5, data + 6) != 7) {
00376                   <font class="comment">//msgErr &lt;&lt; "Raster3D input: bad sphere data in file (line "</font>
00377                          <font class="comment">//&lt;&lt; line &lt;&lt; "). Will try to continue." &lt;&lt; sendmsg;</font>
00378                   <font class="keywordflow">continue</font>;
00379                }
00380                  graphics[n].<a class="code" href="structmolfile__graphics__t.html#m0">type</a> = <a class="code" href="molfile__plugin_8h.html#a30a28">MOLFILE_COLOR</a>;
00381                  color[0] = sqrt(data[4]);
00382                  color[1] = sqrt(data[5]);
00383                  color[2] = sqrt(data[6]);
00384                  memcpy(graphics[n].data, color, 3*<font class="keyword">sizeof</font>(<font class="keywordtype">float</font>));
00385                  <a class="code" href="raster3dplugin_8C.html#a2">next_elem</a>(n, maxelem, graphics);
00386                  graphics[n].<a class="code" href="structmolfile__graphics__t.html#m0">type</a> = <a class="code" href="molfile__plugin_8h.html#a30a26">MOLFILE_SPHERE</a>;
00387                  graphics[n].<a class="code" href="structmolfile__graphics__t.html#m2">size</a> = data[3];
00388                  graphics[n].<a class="code" href="structmolfile__graphics__t.html#m1">style</a> = 12; <font class="comment">// XXX hard-coded resolution</font>
00389                  memcpy(graphics[n].data, data, 3*<font class="keyword">sizeof</font>(<font class="keywordtype">float</font>));
00390                  <a class="code" href="raster3dplugin_8C.html#a2">next_elem</a>(n, maxelem, graphics);
00391                <font class="keywordflow">break</font>;
00392 
00393             <font class="keywordflow">case</font> 3: <font class="comment">// rounded cylinder</font>
00394             <font class="keywordflow">case</font> 5: <font class="comment">// flat cylinder</font>
00395 
00396                <font class="keywordflow">if</font> (!<a class="code" href="raster3dplugin_8C.html#a3">get_line</a>(line, buffer, 199, infile)) {
00397                   <font class="comment">//msgErr &lt;&lt; "Raster3D input: error reading cylinder data (line "</font>
00398                          <font class="comment">//&lt;&lt; line &lt;&lt; ")" &lt;&lt; sendmsg;</font>
00399                   <font class="keywordflow">return</font> <a class="code" href="molfile__plugin_8h.html#a4">MOLFILE_ERROR</a>;
00400                }
00401 
00402                <font class="keywordflow">if</font> (sscanf(buffer, <font class="stringliteral">"%f %f %f %f %f %f %f %f %f %f %f"</font>,
00403                           data, data + 1, data + 2, data + 3, data + 4,
00404                           data + 5, data + 6, data + 7, data + 8, data + 9,
00405                           data + 10) != 11) {
00406                   <font class="comment">//msgErr &lt;&lt; "Raster3D input: bad cylinder data (line "</font>
00407                          <font class="comment">//&lt;&lt; line &lt;&lt; "). Will try to continue." &lt;&lt; sendmsg;</font>
00408                   <font class="keywordflow">continue</font>;
00409                }
00410                  graphics[n].<a class="code" href="structmolfile__graphics__t.html#m0">type</a> = <a class="code" href="molfile__plugin_8h.html#a30a28">MOLFILE_COLOR</a>;
00411                  color[0] = sqrt(data[8]);
00412                  color[1] = sqrt(data[9]);
00413                  color[2] = sqrt(data[10]);
00414                  memcpy(graphics[n].data, color, 3*<font class="keyword">sizeof</font>(<font class="keywordtype">float</font>));
00415                  <a class="code" href="raster3dplugin_8C.html#a2">next_elem</a>(n, maxelem, graphics);
00416                  graphics[n].<a class="code" href="structmolfile__graphics__t.html#m0">type</a> = <a class="code" href="molfile__plugin_8h.html#a30a23">MOLFILE_CYLINDER</a>;
00417                  graphics[n].<a class="code" href="structmolfile__graphics__t.html#m2">size</a> = data[3];
00418                  graphics[n].<a class="code" href="structmolfile__graphics__t.html#m1">style</a> = 12; <font class="comment">// XXX hard-coded resolution</font>
00419                  memcpy(graphics[n].data, data, 3*<font class="keyword">sizeof</font>(<font class="keywordtype">float</font>));
00420                  memcpy(graphics[n].data+3, data+4, 3*<font class="keyword">sizeof</font>(<font class="keywordtype">float</font>));
00421                  <a class="code" href="raster3dplugin_8C.html#a2">next_elem</a>(n, maxelem, graphics);
00422 
00423                <font class="comment">// cap with spheres for object 3</font>
00424                <font class="keywordflow">if</font> (objtype == 3) {
00425                  graphics[n].<a class="code" href="structmolfile__graphics__t.html#m0">type</a> = <a class="code" href="molfile__plugin_8h.html#a30a26">MOLFILE_SPHERE</a>;
00426                  graphics[n].<a class="code" href="structmolfile__graphics__t.html#m2">size</a> = data[3];
00427                  graphics[n].<a class="code" href="structmolfile__graphics__t.html#m1">style</a> = 12; <font class="comment">// XXX hard-coded resolution</font>
00428                  memcpy(graphics[n].data, data, 3*<font class="keyword">sizeof</font>(<font class="keywordtype">float</font>));
00429                  <a class="code" href="raster3dplugin_8C.html#a2">next_elem</a>(n, maxelem, graphics);
00430                  graphics[n].<a class="code" href="structmolfile__graphics__t.html#m0">type</a> = <a class="code" href="molfile__plugin_8h.html#a30a26">MOLFILE_SPHERE</a>;
00431                  graphics[n].<a class="code" href="structmolfile__graphics__t.html#m2">size</a> = data[3];
00432                  graphics[n].<a class="code" href="structmolfile__graphics__t.html#m1">style</a> = 12; <font class="comment">// XXX hard-coded resolution</font>
00433                  memcpy(graphics[n].data, data+4, 3*<font class="keyword">sizeof</font>(<font class="keywordtype">float</font>));
00434                  <a class="code" href="raster3dplugin_8C.html#a2">next_elem</a>(n, maxelem, graphics);
00435                }
00436 
00437                <font class="keywordflow">break</font>;
00438 
00439             <font class="keywordflow">case</font> 9:
00440                <font class="keywordflow">break</font>;
00441 
00442             <font class="keywordflow">case</font> 6: <font class="keywordflow">case</font> 8: <font class="keywordflow">case</font> 10: <font class="keywordflow">case</font> 11: <font class="keywordflow">case</font> 12: <font class="keywordflow">case</font> 13: <font class="keywordflow">case</font> 15: <font class="keywordflow">case</font> 19:
00443 
00444                <font class="comment">// Ignore the next line</font>
00445                <a class="code" href="raster3dplugin_8C.html#a3">get_line</a>(line, buffer, 199, infile);
00446 
00447                <font class="keywordflow">break</font>;
00448 
00449             <font class="keywordflow">case</font> 7:
00450                <font class="comment">//msgErr &lt;&lt; "Raster3D input: encountered unexpected object 7 (triangle ";</font>
00451                <font class="comment">//msgErr &lt;&lt; "vertex normals) (line " &lt;&lt; line;</font>
00452                <font class="comment">//msgErr &lt;&lt; "). Will try to continue." &lt;&lt; sendmsg;</font>
00453                <font class="keywordflow">break</font>;
00454 
00455             <font class="keywordflow">case</font> 17:
00456                <font class="comment">//msgErr &lt;&lt; "Raster3D input: encountered unexpected object 17 (triangle " &lt;&lt; sendmsg;</font>
00457                <font class="comment">//msgErr &lt;&lt; "vertex colors) (line " &lt;&lt; line &lt;&lt; "). Will try to continue." &lt;&lt; sendmsg;</font>
00458                <font class="keywordflow">break</font>;
00459 
00460             <font class="keywordflow">case</font> 0:  <font class="comment">// Raster3D 'force EOF' -- checked later</font>
00461                <font class="keywordflow">break</font>;
00462 
00463             <font class="comment">// We encountered an object that is not recognized.</font>
00464             <font class="comment">// Need to warn the user. Future version of R3d perhaps?</font>
00465             <font class="keywordflow">default</font>:
00466                <font class="keywordflow">if</font> (!futureVersion) {
00467                   <font class="comment">//msgErr &lt;&lt; "Raster3D input: encountered unknown object type #"</font>
00468                          <font class="comment">//&lt;&lt; objtype &lt;&lt; sendmsg;</font>
00469                   <font class="comment">//msgErr &lt;&lt; " (line " &lt;&lt; line &lt;&lt; "). Future version of Raster3D maybe?"</font>
00470                          <font class="comment">//&lt;&lt; " Will try to continue." &lt;&lt; sendmsg;</font>
00471                   futureVersion = 1;
00472                }
00473                <font class="keywordflow">break</font>;
00474 
00475          } <font class="comment">// end of switch</font>
00476 
00477          <font class="comment">// If this is a Raster3d "force EOF" object, break</font>
00478          <font class="keywordflow">if</font> (objtype == 0) <font class="keywordflow">break</font>;
00479 
00480       } <font class="comment">// end of while</font>
00481 
00482    <font class="keywordflow">if</font> (ferror(infile)) {
00483       <font class="comment">//msgErr &lt;&lt; "Raster3D input: read error while reading input file (line "</font>
00484              <font class="comment">//&lt;&lt; line &lt;&lt; "). Aborting." &lt;&lt; sendmsg;</font>
00485       <font class="keywordflow">return</font> <a class="code" href="molfile__plugin_8h.html#a4">MOLFILE_ERROR</a>;
00486    }
00487 
00488    <font class="comment">// normal exit</font>
00489    *nelem = n;
00490    handle-&gt;<a class="code" href="structhandle__t.html#m1">graphics</a> = graphics;
00491    *gdata = graphics;
00492    <font class="keywordflow">return</font> <a class="code" href="molfile__plugin_8h.html#a2">MOLFILE_SUCCESS</a>;
00493 }
00494 
<a name="l00495"></a><a class="code" href="raster3dplugin_8C.html#a5">00495</a> <font class="keyword">static</font> <font class="keywordtype">void</font> <a class="code" href="stlplugin_8C.html#a4">close_file_read</a>(<font class="keywordtype">void</font> *v) {
00496   <a class="code" href="structhandle__t.html">handle_t</a> *handle = (<a class="code" href="structhandle__t.html">handle_t</a> *)v;
00497   fclose(handle-&gt;<a class="code" href="structhandle__t.html#m0">fd</a>);
00498   handle-&gt;<a class="code" href="structhandle__t.html#m0">fd</a> = NULL;
00499   <font class="keyword">delete</font> [] handle-&gt;<a class="code" href="structhandle__t.html#m1">graphics</a>;
00500   handle-&gt;<a class="code" href="structhandle__t.html#m1">graphics</a> = NULL;
00501   <font class="keyword">delete</font> handle;
00502 }
00503 
00504 
00505 <font class="comment">/*</font>
00506 <font class="comment"> * Initialization stuff here</font>
00507 <font class="comment"> */</font>
<a name="l00508"></a><a class="code" href="raster3dplugin_8C.html#a0">00508</a> <font class="keyword">static</font> <a class="code" href="structmolfile__plugin__t.html">molfile_plugin_t</a> <a class="code" href="raster3dplugin_8C.html#a0">plugin</a> = {
00509   <a class="code" href="vmdplugin_8h.html#a10">vmdplugin_ABIVERSION</a>,  <font class="comment">// ABI version</font>
00510   <a class="code" href="molfile__plugin_8h.html#a0">MOLFILE_PLUGIN_TYPE</a>,   <font class="comment">// type of plugin</font>
00511   <font class="stringliteral">"raster3d"</font>,            <font class="comment">// short name of plugin</font>
00512   <font class="stringliteral">"Raster3d Scene File"</font>, <font class="comment">// pretty name of plugin</font>
00513   <font class="stringliteral">"Justin Gullingsrud"</font>,  <font class="comment">// authors</font>
00514   0,                     <font class="comment">// major version</font>
00515   1,                     <font class="comment">// minor version</font>
00516   <a class="code" href="vmdplugin_8h.html#a12">VMDPLUGIN_THREADSAFE</a>,  <font class="comment">// is reentrant</font>
00517   <font class="stringliteral">"r3d"</font>                  <font class="comment">// filename extension</font>
00518 };
00519 
<a name="l00520"></a><a class="code" href="raster3dplugin_8C.html#a6">00520</a> <a class="code" href="vmdplugin_8h.html#a7">VMDPLUGIN_API</a> <font class="keywordtype">int</font> <a class="code" href="vmdplugin_8h.html#a5">VMDPLUGIN_init</a>(<font class="keywordtype">void</font>) { <font class="keywordflow">return</font> <a class="code" href="vmdplugin_8h.html#a13">VMDPLUGIN_SUCCESS</a>; }
<a name="l00521"></a><a class="code" href="raster3dplugin_8C.html#a7">00521</a> <a class="code" href="vmdplugin_8h.html#a7">VMDPLUGIN_API</a> <font class="keywordtype">int</font> <a class="code" href="vmdplugin_8h.html#a6">VMDPLUGIN_fini</a>(<font class="keywordtype">void</font>) { <font class="keywordflow">return</font> <a class="code" href="vmdplugin_8h.html#a13">VMDPLUGIN_SUCCESS</a>; }
<a name="l00522"></a><a class="code" href="raster3dplugin_8C.html#a8">00522</a> <a class="code" href="vmdplugin_8h.html#a7">VMDPLUGIN_API</a> <font class="keywordtype">int</font> <a class="code" href="vmdplugin_8h.html#a3">VMDPLUGIN_register</a>(<font class="keywordtype">void</font> *v, <a class="code" href="vmdplugin_8h.html#a15">vmdplugin_register_cb</a> cb) {
00523   plugin.<a class="code" href="structmolfile__plugin__t.html#m1">open_file_read</a> = <a class="code" href="raster3dplugin_8C.html#a1">open_file_read</a>;
00524   plugin.<a class="code" href="structmolfile__plugin__t.html#m12">read_rawgraphics</a> = <a class="code" href="raster3dplugin_8C.html#a4">read_rawgraphics</a>;
00525   plugin.<a class="code" href="structmolfile__plugin__t.html#m5">close_file_read</a> = <a class="code" href="raster3dplugin_8C.html#a5">close_file_read</a>;
00526   (*cb)(v, (<a class="code" href="structvmdplugin__t.html">vmdplugin_t</a> *)&amp;plugin);
00527   <font class="keywordflow">return</font> <a class="code" href="vmdplugin_8h.html#a13">VMDPLUGIN_SUCCESS</a>;
00528 }
00529 
00530 
</pre></div><hr><address><small>Generated on Wed Mar 22 13:15:31 2006 for VMD Plugins (current) by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.gif" alt="doxygen" align="middle" border=0 
width=110 height=53></a>1.2.14 written by <a href="mailto:dimitri@stack.nl">Dimitri van Heesch</a>,
 &copy;&nbsp;1997-2002</small></address>
</body>
</html>
