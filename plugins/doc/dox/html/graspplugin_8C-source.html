<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>graspplugin.C Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.2.14 -->
<center>
<a class="qindex" href="index.html">Main Page</a> &nbsp; <a class="qindex" href="classes.html">Alphabetical List</a> &nbsp; <a class="qindex" href="annotated.html">Compound List</a> &nbsp; <a class="qindex" href="files.html">File List</a> &nbsp; <a class="qindex" href="functions.html">Compound Members</a> &nbsp; <a class="qindex" href="globals.html">File Members</a> &nbsp; <a class="qindex" href="pages.html">Related Pages</a> &nbsp; </center>
<hr><h1>graspplugin.C</h1><a href="graspplugin_8C.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 <font class="comment">/***************************************************************************</font>
00002 <font class="comment"> *cr</font>
00003 <font class="comment"> *cr            (C) Copyright 1995-2006 The Board of Trustees of the</font>
00004 <font class="comment"> *cr                        University of Illinois</font>
00005 <font class="comment"> *cr                         All Rights Reserved</font>
00006 <font class="comment"> *cr</font>
00007 <font class="comment"> ***************************************************************************/</font>
00008 
00009 <font class="comment">/***************************************************************************</font>
00010 <font class="comment"> * RCS INFORMATION:</font>
00011 <font class="comment"> *</font>
00012 <font class="comment"> *      $RCSfile: graspplugin.C,v $</font>
00013 <font class="comment"> *      $Author: johns $       $Locker:  $             $State: Exp $</font>
00014 <font class="comment"> *      $Revision: 1.17 $       $Date: 2006/02/23 19:36:44 $</font>
00015 <font class="comment"> *</font>
00016 <font class="comment"> ***************************************************************************/</font>
00017 
00018 <font class="comment">/* </font>
00019 <font class="comment"> * Reader for GRASP binary surface files</font>
00020 <font class="comment"> * The file format is briefly described at these two sites:</font>
00021 <font class="comment"> *   http://honiglab.cpmc.columbia.edu/grasp/grasp_contents.html#A.1</font>
00022 <font class="comment"> *   http://www.msg.ucsf.edu/local/programs/grasp/html/Appendix%20A.html</font>
00023 <font class="comment"> */</font>
00024 <font class="preprocessor">#include &lt;stdio.h&gt;</font>
00025 <font class="preprocessor">#include &lt;math.h&gt;</font>
00026 <font class="preprocessor">#include &lt;string.h&gt;</font>
00027 <font class="preprocessor">#include "<a class="code" href="molfile__plugin_8h.html">molfile_plugin.h</a>"</font>
00028 <font class="preprocessor">#include "<a class="code" href="endianswap_8h.html">endianswap.h</a>"</font>
00029 
<a name="l00030"></a><a class="code" href="graspplugin_8C.html#a2">00030</a> <font class="keyword">static</font> <font class="keywordtype">int</font> <a class="code" href="graspplugin_8C.html#a2">is_little_endian</a>(<font class="keywordtype">void</font>) {
00031   <font class="keywordtype">int</font> x=1;
00032   <font class="keywordflow">return</font> *((<font class="keywordtype">char</font> *)&amp;x);
00033 }   
00034 
<a name="l00035"></a><a class="code" href="structgrasp__t.html">00035</a> <font class="keyword">typedef</font> <font class="keyword">struct </font>{
<a name="l00036"></a><a class="code" href="structgrasp__t.html#m0">00036</a>   FILE *fd;
<a name="l00037"></a><a class="code" href="structgrasp__t.html#m1">00037</a>   <a class="code" href="structmolfile__graphics__t.html">molfile_graphics_t</a> *graphics;
00038 } <a class="code" href="structgrasp__t.html">grasp_t</a>;
00039 
<a name="l00040"></a><a class="code" href="graspplugin_8C.html#a3">00040</a> <font class="keyword">static</font> <font class="keywordtype">void</font> *<a class="code" href="webpdbplugin_8c.html#a5">open_file_read</a>(<font class="keyword">const</font> <font class="keywordtype">char</font> *filepath, <font class="keyword">const</font> <font class="keywordtype">char</font> *filetype,
00041     <font class="keywordtype">int</font> *natoms) {
00042   FILE *fd;
00043   <a class="code" href="structgrasp__t.html">grasp_t</a> *grasp;
00044   
00045   fd = fopen(filepath, <font class="stringliteral">"rb"</font>);
00046   <font class="keywordflow">if</font> (!fd) 
00047     <font class="keywordflow">return</font> NULL;
00048   grasp = <font class="keyword">new</font> <a class="code" href="structgrasp__t.html">grasp_t</a>;
00049   grasp-&gt;<a class="code" href="structgrasp__t.html#m0">fd</a> = fd;
00050   grasp-&gt;<a class="code" href="structgrasp__t.html#m1">graphics</a> = NULL;
00051   *natoms = 0;
00052   <font class="keywordflow">return</font> grasp;
00053 }
00054 
<a name="l00055"></a><a class="code" href="graspplugin_8C.html#a4">00055</a> <font class="keyword">static</font> <font class="keywordtype">int</font> <a class="code" href="stlplugin_8C.html#a3">read_rawgraphics</a>(<font class="keywordtype">void</font> *v, <font class="keywordtype">int</font> *nelem, 
00056     <font class="keyword">const</font> <a class="code" href="structmolfile__graphics__t.html">molfile_graphics_t</a> **data) {
00057   <a class="code" href="structgrasp__t.html">grasp_t</a> *grasp = (<a class="code" href="structgrasp__t.html">grasp_t</a> *)v;
00058   FILE *infile = grasp-&gt;<a class="code" href="structgrasp__t.html#m0">fd</a>;
00059 
00060   <font class="comment">// Reverse engineering is your friend, and combined with FORTRAN code, voila!</font>
00061   <font class="comment">// od -c shows the header starts off:</font>
00062   <font class="comment">// \0  \0  \0   P   f   o   r   m   a   t   =   2</font>
00063   <font class="comment">// and according to ungrasp, this is a 1 for grasp versions 1.0</font>
00064   <font class="comment">// and 1.1, and 2 for grasp version 1.2</font>
00065   <font class="comment">// Also, the header lines are of length 80 characters + 4 header chars</font>
00066   <font class="comment">// + 4 trailer chars</font>
00067   <font class="comment">// The 4 bytes at the beginning/end are standard Fortran array trash</font>
00068   <font class="keywordtype">char</font> trash[4];
00069 <font class="preprocessor">#define TRASH fread(trash, 4, 1, infile)</font>
00070 <font class="preprocessor"></font>  <font class="keywordtype">char</font> line[81];
00071 
00072   <font class="comment">// FIRST LINE OF HEADER; contains format type</font>
00073   TRASH; 
00074   fread(line, 1, 80, infile); 
00075   <font class="comment">// make sure it says 'format='</font>
00076   <font class="keywordflow">if</font> (strncmp(line, <font class="stringliteral">"format="</font>, 7) != 0) {
00077     fprintf(stderr, <font class="stringliteral">"First characters of file don't look like a GRASP file\n"</font>);
00078     <font class="keywordflow">return</font> <a class="code" href="molfile__plugin_8h.html#a4">MOLFILE_ERROR</a>;
00079   }
00080   TRASH;
00081    
00082   <font class="comment">// next char should be a 0 or 1</font>
00083   <font class="keywordtype">char</font> gfiletype = line[7];
00084   <font class="keywordflow">if</font> (gfiletype == <font class="charliteral">'1'</font>) {
00085     gfiletype = 1;
00086   } <font class="keywordflow">else</font> <font class="keywordflow">if</font> (gfiletype == <font class="charliteral">'2'</font>) {
00087     gfiletype = 2;
00088   } <font class="keywordflow">else</font> {
00089     fprintf(stderr, <font class="stringliteral">"GRASP file is in format %c, but only '1' or '2' is supported\n"</font>, gfiletype);
00090     <font class="keywordflow">return</font> <a class="code" href="molfile__plugin_8h.html#a4">MOLFILE_ERROR</a>;
00091   }
00092 
00093   <font class="comment">// SECOND LINE: contains "vertices,accessibles,normals,triangles"</font>
00094   TRASH; 
00095   fread(line, 1, 80, infile); 
00096   TRASH;
00097 
00098   <font class="comment">// THIRD LINE: contains (0 or more of)?</font>
00099   <font class="comment">//  "potentials,curvature,distances,gproperty,g2property,vertexcolor</font>
00100   <font class="keywordtype">char</font> line3[81];
00101   TRASH; 
00102   fread(line3, 1, 80, infile); 
00103   line3[80] = 0;
00104   TRASH;
00105 
00106   <font class="comment">// FOURTH LINE stores vertices, triangles, gridsize, lattice spacing</font>
00107   <font class="keywordtype">int</font> nvert, ntriangles, gridsize;
00108   <font class="keywordtype">float</font> lattice;
00109   TRASH; 
00110   fread(line, 1, 80, infile); 
00111   TRASH;
00112   sscanf(line, <font class="stringliteral">"%d%d%d%f"</font>, &amp;nvert, &amp;ntriangles, &amp;gridsize, &amp;lattice);
00113 
00114   <font class="comment">// FIFTH LINE stores the center (x,y,z) position</font>
00115   <font class="keywordtype">float</font> center[3];
00116   TRASH; 
00117   fread(line, 1, 80, infile); 
00118   TRASH;
00119   sscanf(line, <font class="stringliteral">"%f%f%f"</font>, center, center+1, center+2);
00120 
00121   <font class="keywordtype">float</font> *vertex = <font class="keyword">new</font> <font class="keywordtype">float</font>[3 * nvert];
00122   <font class="keywordtype">float</font> *access = <font class="keyword">new</font> <font class="keywordtype">float</font>[3 * nvert];
00123   <font class="keywordtype">float</font> *normal = <font class="keyword">new</font> <font class="keywordtype">float</font>[3 * nvert];
00124   <font class="keywordtype">int</font> *triangle = <font class="keyword">new</font> <font class="keywordtype">int</font>[3 * ntriangles];
00125 
00126   <font class="keywordflow">if</font> (!vertex || !access || !normal || !triangle) {
00127     <font class="keyword">delete</font> [] vertex;
00128     <font class="keyword">delete</font> [] access;
00129     <font class="keyword">delete</font> [] normal;
00130     <font class="keyword">delete</font> [] triangle;
00131     fprintf(stderr, <font class="stringliteral">"Failed vertex/access/normal/triangle allocations.\n"</font>);
00132     <font class="keywordflow">return</font> <a class="code" href="molfile__plugin_8h.html#a4">MOLFILE_ERROR</a>;
00133   }
00134 
00135   <font class="comment">// ungrasp says:</font>
00136   <font class="comment">//    if (filetype.eq.1) then integer*2</font>
00137   <font class="comment">//    if (filetype.eq.2) then integer*4</font>
00138 
00139   <font class="comment">// And read them in.  Who needs error checking?</font>
00140   TRASH; 
00141   fread(vertex, 3 * <font class="keyword">sizeof</font>(<font class="keywordtype">float</font>), nvert, infile); 
00142   TRASH;
00143   TRASH; 
00144   fread(access, 3 * <font class="keyword">sizeof</font>(<font class="keywordtype">float</font>), nvert, infile); 
00145   TRASH;
00146   TRASH; 
00147   fread(normal, 3 * <font class="keyword">sizeof</font>(<font class="keywordtype">float</font>), nvert, infile); 
00148   TRASH;
00149 
00150   <font class="keywordflow">if</font> (<a class="code" href="graspplugin_8C.html#a2">is_little_endian</a>()) {
00151     <a class="code" href="endianswap_8h.html#a4">swap4_aligned</a>(vertex, 3*nvert);
00152     <a class="code" href="endianswap_8h.html#a4">swap4_aligned</a>(access, 3*nvert);
00153     <a class="code" href="endianswap_8h.html#a4">swap4_aligned</a>(normal, 3*nvert);
00154   }
00155 
00156   <font class="keywordflow">if</font> (gfiletype == 2) {
00157     TRASH; 
00158     fread(triangle, 3 * <font class="keyword">sizeof</font>(<font class="keywordtype">int</font>), ntriangles, infile); 
00159     TRASH;
00160     <font class="keywordflow">if</font> (<a class="code" href="graspplugin_8C.html#a2">is_little_endian</a>())
00161       <a class="code" href="endianswap_8h.html#a4">swap4_aligned</a>(triangle, 3*ntriangles);
00162   } <font class="keywordflow">else</font> {
00163 <font class="preprocessor">#if 1</font>
00164 <font class="preprocessor"></font>    <font class="keywordtype">int</font> i;
00165     <font class="keywordtype">short</font> *striangle = <font class="keyword">new</font> <font class="keywordtype">short</font>[3 * ntriangles];
00166     <font class="keywordflow">if</font> (!striangle) {
00167       <font class="keyword">delete</font> [] vertex;
00168       <font class="keyword">delete</font> [] access;
00169       <font class="keyword">delete</font> [] normal;
00170       <font class="keyword">delete</font> [] triangle;
00171       fprintf(stderr, <font class="stringliteral">"Failed short triangle allocation.\n"</font>);
00172       <font class="keywordflow">return</font> <a class="code" href="molfile__plugin_8h.html#a4">MOLFILE_ERROR</a>;
00173     }
00174 
00175     TRASH;
00176     fread(striangle, <font class="keyword">sizeof</font>(<font class="keywordtype">short</font>), 3 * ntriangles, infile);
00177     <font class="keywordflow">if</font> (<a class="code" href="graspplugin_8C.html#a2">is_little_endian</a>()) <a class="code" href="endianswap_8h.html#a3">swap2_aligned</a>(striangle, 3 * ntriangles);
00178     <font class="keywordflow">for</font> (i=0; i&lt;3*ntriangles; i++) {
00179       triangle[i] = striangle[i];
00180     }
00181     <font class="keyword">delete</font> [] striangle;  
00182     TRASH;
00183 <font class="preprocessor">#else</font>
00184 <font class="preprocessor"></font>    <font class="comment">// do it the slow way (converting from short to int)</font>
00185     <font class="keywordtype">int</font> i;
00186     <font class="keywordtype">short</font> tmp[3];
00187     TRASH;
00188     <font class="keywordflow">for</font> (i=0; i&lt;ntriangles; i++) {
00189       fread(tmp, <font class="keyword">sizeof</font>(<font class="keywordtype">short</font>), 3, infile);
00190       <font class="keywordflow">if</font> (<a class="code" href="graspplugin_8C.html#a2">is_little_endian</a>()) <a class="code" href="endianswap_8h.html#a3">swap2_aligned</a>(tmp, 3);
00191       triangle[3*i+0] = tmp[0];
00192       triangle[3*i+1] = tmp[1];
00193       triangle[3*i+2] = tmp[2];
00194     }
00195     TRASH;
00196 <font class="preprocessor">#endif</font>
00197 <font class="preprocessor"></font>  }
00198 
00199   <font class="comment">// And draw things</font>
00200   grasp-&gt;<a class="code" href="structgrasp__t.html#m1">graphics</a> = <font class="keyword">new</font> <a class="code" href="structmolfile__graphics__t.html">molfile_graphics_t</a>[2*ntriangles];
00201   <font class="keywordtype">int</font> vert1, vert2, vert3;
00202 
00203   <font class="keywordflow">for</font> (<font class="keywordtype">int</font> tri_count = 0; tri_count &lt; ntriangles; tri_count++) {
00204     vert1 = triangle[3*tri_count+0] - 1;  <font class="comment">// from 1-based FORTRAN</font>
00205     vert2 = triangle[3*tri_count+1] - 1;  <font class="comment">// to 0-based C++</font>
00206     vert3 = triangle[3*tri_count+2] - 1;
00207 
00208     <font class="keywordflow">if</font> (vert1 &lt;      0 || vert2 &lt;      0 || vert3 &lt;      0 ||
00209         vert1 &gt;= nvert || vert2 &gt;= nvert || vert3 &gt;= nvert) {
00210       printf(<font class="stringliteral">"graspplugin) Error, out-of-range vertex index, aborting.\n"</font>); 
00211       <font class="keyword">delete</font> [] vertex;
00212       <font class="keyword">delete</font> [] access;
00213       <font class="keyword">delete</font> [] normal;
00214       <font class="keyword">delete</font> [] triangle;
00215       <font class="keywordflow">return</font> <a class="code" href="molfile__plugin_8h.html#a4">MOLFILE_ERROR</a>;
00216     }
00217 
00218     grasp-&gt;<a class="code" href="structgrasp__t.html#m1">graphics</a>[2*tri_count  ].<a class="code" href="structmolfile__graphics__t.html#m0">type</a> = <a class="code" href="molfile__plugin_8h.html#a30a20">MOLFILE_TRINORM</a>;
00219     grasp-&gt;<a class="code" href="structgrasp__t.html#m1">graphics</a>[2*tri_count+1].<a class="code" href="structmolfile__graphics__t.html#m0">type</a> = <a class="code" href="molfile__plugin_8h.html#a30a21">MOLFILE_NORMS</a>;
00220 
00221     <font class="keywordtype">float</font> *tridata =  grasp-&gt;<a class="code" href="structgrasp__t.html#m1">graphics</a>[2*tri_count  ].<a class="code" href="structmolfile__graphics__t.html#m3">data</a>;
00222     <font class="keywordtype">float</font> *normdata = grasp-&gt;<a class="code" href="structgrasp__t.html#m1">graphics</a>[2*tri_count+1].<a class="code" href="structmolfile__graphics__t.html#m3">data</a>;
00223     memcpy(tridata  , vertex+3*vert1, 3*<font class="keyword">sizeof</font>(<font class="keywordtype">float</font>));
00224     memcpy(tridata+3, vertex+3*vert2, 3*<font class="keyword">sizeof</font>(<font class="keywordtype">float</font>));
00225     memcpy(tridata+6, vertex+3*vert3, 3*<font class="keyword">sizeof</font>(<font class="keywordtype">float</font>));
00226     memcpy(normdata  , normal+3*vert1, 3*<font class="keyword">sizeof</font>(<font class="keywordtype">float</font>));
00227     memcpy(normdata+3, normal+3*vert2, 3*<font class="keyword">sizeof</font>(<font class="keywordtype">float</font>));
00228     memcpy(normdata+6, normal+3*vert3, 3*<font class="keyword">sizeof</font>(<font class="keywordtype">float</font>));
00229   } 
00230 
00231   *nelem = 2*ntriangles;
00232   *data = grasp-&gt;<a class="code" href="structgrasp__t.html#m1">graphics</a>;
00233 
00234   <font class="keyword">delete</font> [] triangle;
00235   <font class="keyword">delete</font> [] normal;
00236   <font class="keyword">delete</font> [] access;
00237   <font class="keyword">delete</font> [] vertex;
00238 
00239   <font class="keywordflow">return</font> <a class="code" href="molfile__plugin_8h.html#a2">MOLFILE_SUCCESS</a>;
00240 }
00241 
00242 
<a name="l00243"></a><a class="code" href="graspplugin_8C.html#a5">00243</a> <font class="keyword">static</font> <font class="keywordtype">void</font> <a class="code" href="stlplugin_8C.html#a4">close_file_read</a>(<font class="keywordtype">void</font> *v) {
00244   <a class="code" href="structgrasp__t.html">grasp_t</a> *grasp = (<a class="code" href="structgrasp__t.html">grasp_t</a> *)v;
00245   fclose(grasp-&gt;<a class="code" href="structgrasp__t.html#m0">fd</a>);
00246   <font class="keyword">delete</font> [] grasp-&gt;<a class="code" href="structgrasp__t.html#m1">graphics</a>;
00247   <font class="keyword">delete</font> grasp;
00248 }
00249 
00250 
00251 <font class="comment">/*</font>
00252 <font class="comment"> * Initialization stuff here</font>
00253 <font class="comment"> */</font>
<a name="l00254"></a><a class="code" href="graspplugin_8C.html#a1">00254</a> <font class="keyword">static</font> <a class="code" href="structmolfile__plugin__t.html">molfile_plugin_t</a> <a class="code" href="graspplugin_8C.html#a1">plugin</a> = {
00255   <a class="code" href="vmdplugin_8h.html#a10">vmdplugin_ABIVERSION</a>,               <font class="comment">// ABI version</font>
00256   <a class="code" href="molfile__plugin_8h.html#a0">MOLFILE_PLUGIN_TYPE</a>,                <font class="comment">// type of plugin</font>
00257   <font class="stringliteral">"grasp"</font>,                            <font class="comment">// short name of plugin</font>
00258   <font class="stringliteral">"GRASP"</font>,                            <font class="comment">// pretty name of plugin</font>
00259   <font class="stringliteral">"Justin Gullingsrud, John Stone"</font>,   <font class="comment">// author</font>
00260   0,                                  <font class="comment">// major version</font>
00261   5,                                  <font class="comment">// minor version</font>
00262   <a class="code" href="vmdplugin_8h.html#a12">VMDPLUGIN_THREADSAFE</a>,               <font class="comment">// is reentrant</font>
00263   <font class="stringliteral">"srf,grasp"</font>                         <font class="comment">// filename extension </font>
00264 };
00265 
<a name="l00266"></a><a class="code" href="graspplugin_8C.html#a6">00266</a> <a class="code" href="vmdplugin_8h.html#a7">VMDPLUGIN_API</a> <font class="keywordtype">int</font> <a class="code" href="vmdplugin_8h.html#a5">VMDPLUGIN_init</a>(<font class="keywordtype">void</font>) { <font class="keywordflow">return</font> <a class="code" href="vmdplugin_8h.html#a13">VMDPLUGIN_SUCCESS</a>; }
<a name="l00267"></a><a class="code" href="graspplugin_8C.html#a7">00267</a> <a class="code" href="vmdplugin_8h.html#a7">VMDPLUGIN_API</a> <font class="keywordtype">int</font> <a class="code" href="vmdplugin_8h.html#a6">VMDPLUGIN_fini</a>(<font class="keywordtype">void</font>) { <font class="keywordflow">return</font> <a class="code" href="vmdplugin_8h.html#a13">VMDPLUGIN_SUCCESS</a>; }
<a name="l00268"></a><a class="code" href="graspplugin_8C.html#a8">00268</a> <a class="code" href="vmdplugin_8h.html#a7">VMDPLUGIN_API</a> <font class="keywordtype">int</font> <a class="code" href="vmdplugin_8h.html#a3">VMDPLUGIN_register</a>(<font class="keywordtype">void</font> *v, <a class="code" href="vmdplugin_8h.html#a15">vmdplugin_register_cb</a> cb) {
00269   plugin.<a class="code" href="structmolfile__plugin__t.html#m1">open_file_read</a> = <a class="code" href="graspplugin_8C.html#a3">open_file_read</a>;
00270   plugin.<a class="code" href="structmolfile__plugin__t.html#m12">read_rawgraphics</a> = <a class="code" href="graspplugin_8C.html#a4">read_rawgraphics</a>;
00271   plugin.<a class="code" href="structmolfile__plugin__t.html#m5">close_file_read</a> = <a class="code" href="graspplugin_8C.html#a5">close_file_read</a>;
00272   (*cb)(v, (<a class="code" href="structvmdplugin__t.html">vmdplugin_t</a> *)&amp;plugin);
00273   <font class="keywordflow">return</font> <a class="code" href="vmdplugin_8h.html#a13">VMDPLUGIN_SUCCESS</a>;
00274 }
00275 
00276 
</pre></div><hr><address><small>Generated on Wed Mar 22 13:15:29 2006 for VMD Plugins (current) by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.gif" alt="doxygen" align="middle" border=0 
width=110 height=53></a>1.2.14 written by <a href="mailto:dimitri@stack.nl">Dimitri van Heesch</a>,
 &copy;&nbsp;1997-2002</small></address>
</body>
</html>
