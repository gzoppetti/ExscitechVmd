<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>edmplugin.C Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.2.14 -->
<center>
<a class="qindex" href="index.html">Main Page</a> &nbsp; <a class="qindex" href="classes.html">Alphabetical List</a> &nbsp; <a class="qindex" href="annotated.html">Compound List</a> &nbsp; <a class="qindex" href="files.html">File List</a> &nbsp; <a class="qindex" href="functions.html">Compound Members</a> &nbsp; <a class="qindex" href="globals.html">File Members</a> &nbsp; <a class="qindex" href="pages.html">Related Pages</a> &nbsp; </center>
<hr><h1>edmplugin.C</h1><a href="edmplugin_8C.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 <font class="comment">/***************************************************************************</font>
00002 <font class="comment"> *cr</font>
00003 <font class="comment"> *cr            (C) Copyright 1995-2006 The Board of Trustees of the</font>
00004 <font class="comment"> *cr                        University of Illinois</font>
00005 <font class="comment"> *cr                         All Rights Reserved</font>
00006 <font class="comment"> *cr</font>
00007 <font class="comment"> ***************************************************************************/</font>
00008 
00009 <font class="comment">/***************************************************************************</font>
00010 <font class="comment"> * RCS INFORMATION:</font>
00011 <font class="comment"> *</font>
00012 <font class="comment"> *      $RCSfile: edmplugin.C,v $</font>
00013 <font class="comment"> *      $Author: johns $       $Locker:  $             $State: Exp $</font>
00014 <font class="comment"> *      $Revision: 1.25 $       $Date: 2006/02/23 19:36:44 $</font>
00015 <font class="comment"> *</font>
00016 <font class="comment"> ***************************************************************************/</font>
00017 
00018 <font class="preprocessor">#include &lt;stdio.h&gt;</font>
00019 <font class="preprocessor">#include &lt;stdlib.h&gt;</font>
00020 <font class="preprocessor">#include &lt;math.h&gt;</font>
00021 <font class="preprocessor">#include &lt;string.h&gt;</font>
00022 
00023 <font class="preprocessor">#include "<a class="code" href="molfile__plugin_8h.html">molfile_plugin.h</a>"</font>
00024 
<a name="l00025"></a><a class="code" href="structedm__t.html">00025</a> <font class="keyword">typedef</font> <font class="keyword">struct </font>{
<a name="l00026"></a><a class="code" href="structedm__t.html#m0">00026</a>   FILE *fd;
<a name="l00027"></a><a class="code" href="structedm__t.html#m1">00027</a>   <font class="keywordtype">int</font> nsets;
<a name="l00028"></a><a class="code" href="structedm__t.html#m2">00028</a>   <a class="code" href="structmolfile__volumetric__t.html">molfile_volumetric_t</a> *vol;
00029 } <a class="code" href="structedm__t.html">edm_t</a>;
00030 
<a name="l00031"></a><a class="code" href="edmplugin_8C.html#a1">00031</a> <font class="keyword">static</font> <font class="keywordtype">void</font> <a class="code" href="xsfplugin_8C.html#a36">eatline</a>(FILE * fd) {
00032   <font class="keywordtype">char</font> readbuf[1025];
00033   fgets(readbuf, 1024, fd);    <font class="comment">// go on to next line</font>
00034 }  
00035 
<a name="l00036"></a><a class="code" href="edmplugin_8C.html#a2">00036</a> <font class="keyword">static</font> <font class="keywordtype">void</font> *<a class="code" href="edmplugin_8C.html#a2">open_edm_read</a>(<font class="keyword">const</font> <font class="keywordtype">char</font> *filepath, <font class="keyword">const</font> <font class="keywordtype">char</font> *filetype,
00037     <font class="keywordtype">int</font> *natoms) {
00038   FILE *fd;
00039   <a class="code" href="structedm__t.html">edm_t</a> *edm;
00040   <font class="keywordtype">int</font> ntitle, na, nb, nc, xsize, ysize, zsize;
00041   <font class="keywordtype">int</font> amin, amax, bmin, bmax, cmin, cmax;
00042   <font class="keywordtype">float</font> a, b, c, alpha, beta, gamma;
00043   <font class="keywordtype">float</font> xdelta, ydelta, zdelta;
00044   <font class="keywordtype">float</font> alpha1, beta1, gamma1;
00045   <font class="keywordtype">float</font> xaxis[3], yaxis[3], zaxis[3], z1, z2, z3;
00046   <font class="keywordtype">int</font> i, convcnt;
00047   
00048   fd = fopen(filepath, <font class="stringliteral">"rb"</font>);
00049   <font class="keywordflow">if</font> (!fd) 
00050     <font class="keywordflow">return</font> NULL;
00051 
00052   edm = <font class="keyword">new</font> <a class="code" href="structedm__t.html">edm_t</a>;
00053   edm-&gt;<a class="code" href="structedm__t.html#m0">fd</a> = fd;
00054   edm-&gt;<a class="code" href="structedm__t.html#m2">vol</a> = NULL;
00055   *natoms = <a class="code" href="molfile__plugin_8h.html#a7">MOLFILE_NUMATOMS_NONE</a>;
00056 
00057   edm-&gt;<a class="code" href="structedm__t.html#m2">vol</a> = <font class="keyword">new</font> <a class="code" href="structmolfile__volumetric__t.html">molfile_volumetric_t</a>[1];
00058  
00059   edm-&gt;<a class="code" href="structedm__t.html#m1">nsets</a> = 1; <font class="comment">// this EDM file contains only one data set</font>
00060 
00061   <font class="comment">// read in EDM file header information</font>
00062   <a class="code" href="xsfplugin_8C.html#a36">eatline</a>(edm-&gt;<a class="code" href="structedm__t.html#m0">fd</a>);               <font class="comment">// skip first header line </font>
00063 
00064   convcnt = fscanf(edm-&gt;<a class="code" href="structedm__t.html#m0">fd</a>, <font class="stringliteral">"%d"</font>, &amp;ntitle); <font class="comment">// read number of title lines</font>
00065   <font class="keywordflow">if</font> (convcnt != 1) {
00066     printf(<font class="stringliteral">"edmplugin: failed to read in title line count\n"</font>);
00067     fclose(edm-&gt;<a class="code" href="structedm__t.html#m0">fd</a>);
00068     <font class="keyword">delete</font> [] edm-&gt;<a class="code" href="structedm__t.html#m2">vol</a>;
00069     <font class="keyword">delete</font> edm;
00070     <font class="keywordflow">return</font> NULL;
00071   }
00072     
00073   <a class="code" href="xsfplugin_8C.html#a36">eatline</a>(edm-&gt;<a class="code" href="structedm__t.html#m0">fd</a>);               <font class="comment">// go on to next line</font>
00074 
00075   <font class="comment">// skip past title and comment lines in header</font>
00076   <font class="keywordflow">for</font> (i=0; i&lt;ntitle; i++) {
00077     <a class="code" href="xsfplugin_8C.html#a36">eatline</a>(edm-&gt;<a class="code" href="structedm__t.html#m0">fd</a>);             <font class="comment">// skip a line</font>
00078   }
00079 
00080   <font class="comment">// read in the box dimensions and grid spacing deltas</font>
00081   convcnt = fscanf(edm-&gt;<a class="code" href="structedm__t.html#m0">fd</a>, <font class="stringliteral">"%d %d %d %d %d %d %d %d %d"</font>,
00082          &amp;na, &amp;amin, &amp;amax, &amp;nb, &amp;bmin, &amp;bmax, &amp;nc, &amp;cmin, &amp;cmax);
00083   <font class="keywordflow">if</font> (convcnt != 9) {
00084     printf(<font class="stringliteral">"edmplugin: failed to read in box dimensions\n"</font>);
00085     fclose(edm-&gt;<a class="code" href="structedm__t.html#m0">fd</a>);
00086     <font class="keyword">delete</font> [] edm-&gt;<a class="code" href="structedm__t.html#m2">vol</a>;
00087     <font class="keyword">delete</font> edm;
00088     <font class="keywordflow">return</font> NULL;
00089   }
00090 
00091   <a class="code" href="xsfplugin_8C.html#a36">eatline</a>(edm-&gt;<a class="code" href="structedm__t.html#m0">fd</a>);               <font class="comment">// go on to next line</font>
00092   
00093   <font class="comment">// calculate number of samples in each dimension</font>
00094   xsize = amax - amin + 1;    
00095   ysize = bmax - bmin + 1;    
00096   zsize = cmax - cmin + 1;    
00097   edm-&gt;<a class="code" href="structedm__t.html#m2">vol</a>[0].<a class="code" href="structmolfile__volumetric__t.html#m5">xsize</a> = xsize;
00098   edm-&gt;<a class="code" href="structedm__t.html#m2">vol</a>[0].<a class="code" href="structmolfile__volumetric__t.html#m6">ysize</a> = ysize;
00099   edm-&gt;<a class="code" href="structedm__t.html#m2">vol</a>[0].<a class="code" href="structmolfile__volumetric__t.html#m7">zsize</a> = zsize;
00100   edm-&gt;<a class="code" href="structedm__t.html#m2">vol</a>[0].<a class="code" href="structmolfile__volumetric__t.html#m8">has_color</a> = 0;
00101 
00102   <font class="comment">// read in 6 values for unit cell box orientation </font>
00103   convcnt = fscanf(edm-&gt;<a class="code" href="structedm__t.html#m0">fd</a>, <font class="stringliteral">"%f %f %f %f %f %f"</font>, 
00104                    &amp;a, &amp;b, &amp;c, &amp;alpha, &amp;beta, &amp;gamma);
00105   <font class="keywordflow">if</font> (convcnt != 6) {
00106     printf(<font class="stringliteral">"edmplugin: failed to read in box lengths and angles\n"</font>);
00107     fclose(edm-&gt;<a class="code" href="structedm__t.html#m0">fd</a>);
00108     <font class="keyword">delete</font> [] edm-&gt;<a class="code" href="structedm__t.html#m2">vol</a>;
00109     <font class="keyword">delete</font> edm;
00110     <font class="keywordflow">return</font> NULL;
00111   }
00112   <a class="code" href="xsfplugin_8C.html#a36">eatline</a>(edm-&gt;<a class="code" href="structedm__t.html#m0">fd</a>);               <font class="comment">// go on to next line</font>
00113 
00114   <font class="comment">// find box coordinates </font>
00115   xdelta = a / (float) na;
00116   ydelta = b / (float) nb;
00117   zdelta = c / (float) nc;
00118 
00119   strcpy(edm-&gt;<a class="code" href="structedm__t.html#m2">vol</a>[0].<a class="code" href="structmolfile__volumetric__t.html#m0">dataname</a>, <font class="stringliteral">"X-PLOR Electron Density Map"</font>);
00120 
00121   <font class="comment">// convert degrees to radians</font>
00122   alpha1 = 3.14159265358979323846 * alpha / 180.0;
00123   beta1  = 3.14159265358979323846 *  beta / 180.0;
00124   gamma1 = 3.14159265358979323846 * gamma / 180.0;
00125 
00126   <font class="comment">// calculate non-orthogonal unit cell coordinates</font>
00127   xaxis[0] = xdelta;
00128   xaxis[1] = 0;
00129   xaxis[2] = 0;
00130 
00131   yaxis[0] = cos(gamma1) * ydelta;
00132   yaxis[1] = sin(gamma1) * ydelta;
00133   yaxis[2] = 0;
00134 
00135   z1 = cos(beta1);
00136   z2 = (cos(alpha1) - cos(beta1)*cos(gamma1)) / sin(gamma1);
00137   z3 = sqrt(1.0 - z1*z1 - z2*z2);
00138   zaxis[0] = z1 * zdelta;
00139   zaxis[1] = z2 * zdelta;
00140   zaxis[2] = z3 * zdelta;
00141 
00142   edm-&gt;<a class="code" href="structedm__t.html#m2">vol</a>[0].<a class="code" href="structmolfile__volumetric__t.html#m1">origin</a>[0] = xaxis[0] * amin + yaxis[0] * bmin + zaxis[0] * cmin;
00143   edm-&gt;<a class="code" href="structedm__t.html#m2">vol</a>[0].<a class="code" href="structmolfile__volumetric__t.html#m1">origin</a>[1] = yaxis[1] * bmin + zaxis[1] * cmin;
00144   edm-&gt;<a class="code" href="structedm__t.html#m2">vol</a>[0].<a class="code" href="structmolfile__volumetric__t.html#m1">origin</a>[2] = zaxis[2] * cmin;
00145 
00146   edm-&gt;<a class="code" href="structedm__t.html#m2">vol</a>[0].<a class="code" href="structmolfile__volumetric__t.html#m2">xaxis</a>[0] = xaxis[0] * xsize;
00147   edm-&gt;<a class="code" href="structedm__t.html#m2">vol</a>[0].<a class="code" href="structmolfile__volumetric__t.html#m2">xaxis</a>[1] = 0;
00148   edm-&gt;<a class="code" href="structedm__t.html#m2">vol</a>[0].<a class="code" href="structmolfile__volumetric__t.html#m2">xaxis</a>[2] = 0;
00149 
00150   edm-&gt;<a class="code" href="structedm__t.html#m2">vol</a>[0].<a class="code" href="structmolfile__volumetric__t.html#m3">yaxis</a>[0] = yaxis[0] * ysize;
00151   edm-&gt;<a class="code" href="structedm__t.html#m2">vol</a>[0].<a class="code" href="structmolfile__volumetric__t.html#m3">yaxis</a>[1] = yaxis[1] * ysize;
00152   edm-&gt;<a class="code" href="structedm__t.html#m2">vol</a>[0].<a class="code" href="structmolfile__volumetric__t.html#m3">yaxis</a>[2] = 0;
00153 
00154   edm-&gt;<a class="code" href="structedm__t.html#m2">vol</a>[0].<a class="code" href="structmolfile__volumetric__t.html#m4">zaxis</a>[0] = zaxis[0] * zsize;
00155   edm-&gt;<a class="code" href="structedm__t.html#m2">vol</a>[0].<a class="code" href="structmolfile__volumetric__t.html#m4">zaxis</a>[1] = zaxis[1] * zsize;
00156   edm-&gt;<a class="code" href="structedm__t.html#m2">vol</a>[0].<a class="code" href="structmolfile__volumetric__t.html#m4">zaxis</a>[2] = zaxis[2] * zsize;
00157 
00158   <font class="comment">// Check that the EDM file is stored in the "ZYX" format we expect,</font>
00159   <font class="comment">// and return NULL if it is not a supported file type.</font>
00160   <font class="keywordtype">char</font> planeorder[4];
00161   memset(planeorder, 0, <font class="keyword">sizeof</font>(planeorder));
00162   convcnt = fscanf(edm-&gt;<a class="code" href="structedm__t.html#m0">fd</a>, <font class="stringliteral">"%3s"</font>, planeorder);
00163   <font class="keywordflow">if</font> (convcnt != 1) {
00164     printf(<font class="stringliteral">"edmplugin: failed to read in plane order\n"</font>);
00165     fclose(edm-&gt;<a class="code" href="structedm__t.html#m0">fd</a>);
00166     <font class="keyword">delete</font> [] edm-&gt;<a class="code" href="structedm__t.html#m2">vol</a>;
00167     <font class="keyword">delete</font> edm;
00168     <font class="keywordflow">return</font> NULL;
00169   }
00170 
00171   <font class="keywordflow">if</font> (strcmp(planeorder, <font class="stringliteral">"ZYX"</font>)) { 
00172     printf(<font class="stringliteral">"edmplugin: unsupported plane ordering %s\n"</font>, planeorder);
00173     fclose(edm-&gt;<a class="code" href="structedm__t.html#m0">fd</a>);
00174     <font class="keyword">delete</font> [] edm-&gt;<a class="code" href="structedm__t.html#m2">vol</a>;
00175     <font class="keyword">delete</font> edm;
00176     <font class="keywordflow">return</font> NULL;
00177   }
00178   <a class="code" href="xsfplugin_8C.html#a36">eatline</a>(edm-&gt;<a class="code" href="structedm__t.html#m0">fd</a>);               <font class="comment">// go on to next line</font>
00179 
00180   <font class="keywordflow">return</font> edm;
00181 }
00182 
<a name="l00183"></a><a class="code" href="edmplugin_8C.html#a3">00183</a> <font class="keyword">static</font> <font class="keywordtype">int</font> <a class="code" href="edmplugin_8C.html#a3">read_edm_metadata</a>(<font class="keywordtype">void</font> *v, <font class="keywordtype">int</font> *nsets, 
00184   <a class="code" href="structmolfile__volumetric__t.html">molfile_volumetric_t</a> **metadata) {
00185   <a class="code" href="structedm__t.html">edm_t</a> *edm = (<a class="code" href="structedm__t.html">edm_t</a> *)v;
00186   *nsets = edm-&gt;<a class="code" href="structedm__t.html#m1">nsets</a>; 
00187   *metadata = edm-&gt;<a class="code" href="structedm__t.html#m2">vol</a>;  
00188 
00189   <font class="keywordflow">return</font> <a class="code" href="molfile__plugin_8h.html#a2">MOLFILE_SUCCESS</a>;
00190 }
00191 
<a name="l00192"></a><a class="code" href="edmplugin_8C.html#a4">00192</a> <font class="keyword">static</font> <font class="keywordtype">int</font> <a class="code" href="edmplugin_8C.html#a4">read_edm_data</a>(<font class="keywordtype">void</font> *v, <font class="keywordtype">int</font> set, <font class="keywordtype">float</font> *datablock,
00193                          <font class="keywordtype">float</font> *colorblock) {
00194   <a class="code" href="structedm__t.html">edm_t</a> *edm = (<a class="code" href="structedm__t.html">edm_t</a> *)v;
00195   <font class="keywordtype">float</font> * cell = datablock;
00196   <font class="keywordtype">int</font> z, l, sentinel, convcnt;
00197   <font class="keywordtype">char</font> readbuf[16];
00198  
00199   <font class="keywordtype">int</font> xsize = edm-&gt;<a class="code" href="structedm__t.html#m2">vol</a>[0].<a class="code" href="structmolfile__volumetric__t.html#m5">xsize</a>;
00200   <font class="keywordtype">int</font> ysize = edm-&gt;<a class="code" href="structedm__t.html#m2">vol</a>[0].<a class="code" href="structmolfile__volumetric__t.html#m6">ysize</a>;
00201   <font class="keywordtype">int</font> zsize = edm-&gt;<a class="code" href="structedm__t.html#m2">vol</a>[0].<a class="code" href="structmolfile__volumetric__t.html#m7">zsize</a>;
00202 
00203   <font class="comment">// number of lines of text per slice</font>
00204   <font class="keywordtype">int</font> nperslice = xsize * ysize;
00205   <font class="keywordtype">int</font> nlines = (int)(nperslice / 6.0);
00206   <font class="keywordflow">if</font> ((nlines * 6) &lt; nperslice) {
00207     nlines++;
00208   }
00209   <font class="keywordtype">int</font> leftover = (nperslice - (nlines - 1) * 6);
00210 
00211   <font class="keywordflow">for</font> (z=0; z&lt;zsize; z++) {
00212     <font class="keywordtype">int</font> c;
00213     <a class="code" href="xsfplugin_8C.html#a36">eatline</a>(edm-&gt;<a class="code" href="structedm__t.html#m0">fd</a>);                <font class="comment">// Eat the Z-plane index and throw away</font>
00214 
00215 <font class="preprocessor">#if 1</font>
00216 <font class="preprocessor"></font>    <font class="comment">// read one plane of data, once cell at a time</font>
00217     <font class="keywordflow">for</font> (c=0; c&lt;nperslice; c++) {
00218       convcnt = fscanf(edm-&gt;<a class="code" href="structedm__t.html#m0">fd</a>, <font class="stringliteral">"%f"</font>, cell);
00219       <font class="keywordflow">if</font> (convcnt != 1) {
00220         printf(<font class="stringliteral">"edmplugin: failed reading cell data\n"</font>);
00221         printf(<font class="stringliteral">"edmplugin: cell %d of %d, slice %d\n"</font>, c, nperslice, z);
00222         <font class="keywordflow">return</font> <a class="code" href="molfile__plugin_8h.html#a4">MOLFILE_ERROR</a>; <font class="comment">// bad file format encountered</font>
00223       }
00224       cell++;
00225     }
00226     <a class="code" href="xsfplugin_8C.html#a36">eatline</a>(edm-&gt;<a class="code" href="structedm__t.html#m0">fd</a>);                <font class="comment">// go on to next line</font>
00227 <font class="preprocessor">#else</font>
00228 <font class="preprocessor"></font>    <font class="keywordflow">for</font> (l=1; l&lt;nlines; l++) {
00229       <font class="keywordflow">for</font> (c=0; c&lt;6; c++) {
00230         fgets(readbuf, 13, edm-&gt;<a class="code" href="structedm__t.html#m0">fd</a>); <font class="comment">// read in 12 chars (fgets reads N-1)</font>
00231         convcnt = sscanf(readbuf, <font class="stringliteral">"%f"</font>, cell); <font class="comment">// convert ascii to float</font>
00232         <font class="keywordflow">if</font> (convcnt != 1) {
00233           printf(<font class="stringliteral">"edmplugin: failed reading cell data\n"</font>);
00234           printf(<font class="stringliteral">"edmplugin: cell on line %d cell %d, of %d lines\n"</font>, l, c, nlines);
00235           <font class="keywordflow">return</font> <a class="code" href="molfile__plugin_8h.html#a4">MOLFILE_ERROR</a>; <font class="comment">// bad file format encountered</font>
00236         }
00237         cell++;
00238       }
00239       <a class="code" href="xsfplugin_8C.html#a36">eatline</a>(edm-&gt;<a class="code" href="structedm__t.html#m0">fd</a>);              <font class="comment">// go on to next line</font>
00240     }
00241 
00242     <font class="comment">// read any remaining partial line of text for this plane.</font>
00243     <font class="keywordflow">if</font> (leftover &gt; 0) {
00244       <font class="keywordflow">for</font> (c=0; c&lt;leftover; c++) {
00245         fgets(readbuf, 13, edm-&gt;<a class="code" href="structedm__t.html#m0">fd</a>); 
00246         convcnt = sscanf(readbuf, <font class="stringliteral">"%f"</font>, cell);
00247         <font class="keywordflow">if</font> (convcnt != 1) {
00248           printf(<font class="stringliteral">"edmplugin: failed reading partial line cell data\n"</font>);
00249           <font class="keywordflow">return</font> <a class="code" href="molfile__plugin_8h.html#a4">MOLFILE_ERROR</a>; <font class="comment">// bad file format encountered</font>
00250         }
00251         cell++;
00252       }
00253     } 
00254 <font class="preprocessor">#endif</font>
00255 <font class="preprocessor"></font>  }
00256 
00257   <font class="comment">// read the -9999 end-of-file sentinel record</font>
00258   sentinel = 0;
00259   fgets(readbuf, 13, edm-&gt;<a class="code" href="structedm__t.html#m0">fd</a>);
00260   sscanf(readbuf, <font class="stringliteral">"%d"</font>, &amp;sentinel);  
00261   <font class="keywordflow">if</font> (sentinel != -9999) {
00262     printf(<font class="stringliteral">"edmplugin: EOF sentinel != -9999\n"</font>);
00263     <font class="comment">// return MOLFILE_ERROR; // bad file format encountered, no sentinel record</font>
00264   }
00265  
00266   <font class="keywordflow">return</font> <a class="code" href="molfile__plugin_8h.html#a2">MOLFILE_SUCCESS</a>;
00267 }
00268 
<a name="l00269"></a><a class="code" href="edmplugin_8C.html#a5">00269</a> <font class="keyword">static</font> <font class="keywordtype">void</font> <a class="code" href="edmplugin_8C.html#a5">close_edm_read</a>(<font class="keywordtype">void</font> *v) {
00270   <a class="code" href="structedm__t.html">edm_t</a> *edm = (<a class="code" href="structedm__t.html">edm_t</a> *)v;
00271 
00272   fclose(edm-&gt;<a class="code" href="structedm__t.html#m0">fd</a>);
00273   <font class="keyword">delete</font> [] edm-&gt;<a class="code" href="structedm__t.html#m2">vol</a>; 
00274   <font class="keyword">delete</font> edm;
00275 }
00276 
00277 <font class="comment">/*</font>
00278 <font class="comment"> * Initialization stuff here</font>
00279 <font class="comment"> */</font>
<a name="l00280"></a><a class="code" href="edmplugin_8C.html#a0">00280</a> <font class="keyword">static</font> <a class="code" href="structmolfile__plugin__t.html">molfile_plugin_t</a> <a class="code" href="edmplugin_8C.html#a0">plugin</a> = {
00281   <a class="code" href="vmdplugin_8h.html#a10">vmdplugin_ABIVERSION</a>,         <font class="comment">// ABI version</font>
00282   <a class="code" href="molfile__plugin_8h.html#a0">MOLFILE_PLUGIN_TYPE</a>,          <font class="comment">// plugin type</font>
00283   <font class="stringliteral">"edm"</font>,                        <font class="comment">// file format description</font>
00284   <font class="stringliteral">"XPLOR Electron Density Map"</font>, <font class="comment">// file format description</font>
00285   <font class="stringliteral">"John E. Stone"</font>,              <font class="comment">// author(s)</font>
00286   0,                            <font class="comment">// major version</font>
00287   4,                            <font class="comment">// minor version</font>
00288   <a class="code" href="vmdplugin_8h.html#a12">VMDPLUGIN_THREADSAFE</a>,         <font class="comment">// is reentrant</font>
00289   <font class="stringliteral">"edm"</font>                         <font class="comment">// filename extension</font>
00290 };
00291 
<a name="l00292"></a><a class="code" href="edmplugin_8C.html#a6">00292</a> <a class="code" href="vmdplugin_8h.html#a7">VMDPLUGIN_API</a> <font class="keywordtype">int</font> <a class="code" href="vmdplugin_8h.html#a5">VMDPLUGIN_init</a>(<font class="keywordtype">void</font>) { <font class="keywordflow">return</font> <a class="code" href="vmdplugin_8h.html#a13">VMDPLUGIN_SUCCESS</a>; }
<a name="l00293"></a><a class="code" href="edmplugin_8C.html#a7">00293</a> <a class="code" href="vmdplugin_8h.html#a7">VMDPLUGIN_API</a> <font class="keywordtype">int</font> <a class="code" href="vmdplugin_8h.html#a6">VMDPLUGIN_fini</a>(<font class="keywordtype">void</font>) { <font class="keywordflow">return</font> <a class="code" href="vmdplugin_8h.html#a13">VMDPLUGIN_SUCCESS</a>; }
<a name="l00294"></a><a class="code" href="edmplugin_8C.html#a8">00294</a> <a class="code" href="vmdplugin_8h.html#a7">VMDPLUGIN_API</a> <font class="keywordtype">int</font> <a class="code" href="vmdplugin_8h.html#a3">VMDPLUGIN_register</a>(<font class="keywordtype">void</font> *v, <a class="code" href="vmdplugin_8h.html#a15">vmdplugin_register_cb</a> cb) {
00295   plugin.<a class="code" href="structmolfile__plugin__t.html#m1">open_file_read</a> = <a class="code" href="edmplugin_8C.html#a2">open_edm_read</a>;
00296   plugin.<a class="code" href="structmolfile__plugin__t.html#m10">read_volumetric_metadata</a> = <a class="code" href="edmplugin_8C.html#a3">read_edm_metadata</a>;
00297   plugin.<a class="code" href="structmolfile__plugin__t.html#m11">read_volumetric_data</a> = <a class="code" href="edmplugin_8C.html#a4">read_edm_data</a>;
00298   plugin.<a class="code" href="structmolfile__plugin__t.html#m5">close_file_read</a> = <a class="code" href="edmplugin_8C.html#a5">close_edm_read</a>;
00299   (*cb)(v, (<a class="code" href="structvmdplugin__t.html">vmdplugin_t</a> *)&amp;plugin);
00300   <font class="keywordflow">return</font> <a class="code" href="vmdplugin_8h.html#a13">VMDPLUGIN_SUCCESS</a>;
00301 }
00302 
00303 
00304 
00305 <font class="preprocessor">#ifdef TEST_EDMPLUGIN</font>
00306 <font class="preprocessor"></font>
00307 <font class="keywordtype">int</font> <a class="code" href="main_8c.html#a3">main</a>(<font class="keywordtype">int</font> argc, <font class="keywordtype">char</font> *argv[]) {
00308   <font class="keywordtype">int</font> natoms;
00309   <font class="keywordtype">void</font> *v;
00310   <font class="keywordtype">int</font> i, nsets, set;
00311   <a class="code" href="structmolfile__volumetric__t.html">molfile_volumetric_t</a> * meta;
00312 
00313   <font class="keywordflow">while</font> (--argc) {
00314     ++argv;
00315     v = <a class="code" href="edmplugin_8C.html#a2">open_edm_read</a>(*argv, <font class="stringliteral">"edm"</font>, &amp;natoms);
00316     <font class="keywordflow">if</font> (!v) {
00317       fprintf(stderr, <font class="stringliteral">"open_edm_read failed for file %s\n"</font>, *argv);
00318       <font class="keywordflow">return</font> 1;
00319     }
00320 
00321     <font class="comment">// try loading the EDM metadata now</font>
00322     <font class="keywordflow">if</font> (<a class="code" href="edmplugin_8C.html#a3">read_edm_metadata</a>(v, &amp;nsets, &amp;meta)) {
00323       <font class="keywordflow">return</font> 1; <font class="comment">// failed to load edm file</font>
00324     }
00325 
00326     <font class="keywordflow">for</font> (set=0; set&lt;nsets; set++) {
00327       printf(<font class="stringliteral">"Loading volume set: %d\n"</font>, set);   
00328       
00329       <font class="keywordtype">int</font> elements = meta[set].<a class="code" href="structmolfile__volumetric__t.html#m5">xsize</a> * meta[set].<a class="code" href="structmolfile__volumetric__t.html#m6">ysize</a> * meta[set].<a class="code" href="structmolfile__volumetric__t.html#m7">zsize</a>;
00330       printf(<font class="stringliteral">"   Grid Elements: %d\n"</font>, elements);
00331       printf(<font class="stringliteral">" Grid dimensions: X: %d Y: %d Z: %d\n"</font>, 
00332              meta[set].xsize, meta[set].ysize, meta[set].zsize);
00333 
00334       <font class="keywordtype">float</font> * voldata = (<font class="keywordtype">float</font> *) malloc(<font class="keyword">sizeof</font>(<font class="keywordtype">float</font>) * elements);
00335       <font class="keywordtype">float</font> * coldata = NULL;
00336 
00337       <font class="keywordflow">if</font> (meta[set].<a class="code" href="structmolfile__volumetric__t.html#m8">has_color</a>) {
00338         coldata = (<font class="keywordtype">float</font> *) malloc(<font class="keyword">sizeof</font>(<font class="keywordtype">float</font>) * elements * 3);
00339       }
00340 
00341       <font class="comment">// try loading the EDM data sets now</font>
00342       <font class="keywordflow">if</font> (<a class="code" href="edmplugin_8C.html#a4">read_edm_data</a>(v, set, voldata, coldata)) {
00343         <font class="keywordflow">return</font> 1; <font class="comment">// failed to load edm file</font>
00344       }
00345 
00346       printf(<font class="stringliteral">"First 6 elements:\n   "</font>);
00347       <font class="keywordflow">for</font> (i=0; i&lt;6; i++) {
00348         printf(<font class="stringliteral">"%g, "</font>, voldata[i]);
00349       }
00350       printf(<font class="stringliteral">"\n"</font>); 
00351 
00352       printf(<font class="stringliteral">"Last 6 elements:\n   "</font>);
00353       <font class="keywordflow">for</font> (i=elements - 6; i&lt;elements; i++) {
00354         printf(<font class="stringliteral">"%g, "</font>, voldata[i]);
00355       }
00356       printf(<font class="stringliteral">"\n"</font>); 
00357     }
00358 
00359     <a class="code" href="edmplugin_8C.html#a5">close_edm_read</a>(v);
00360   }
00361   <font class="keywordflow">return</font> 0;
00362 }
00363 
00364 <font class="preprocessor">#endif</font>
00365 <font class="preprocessor"></font>
00366 
00367 
00368 
</pre></div><hr><address><small>Generated on Wed Mar 22 13:15:29 2006 for VMD Plugins (current) by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.gif" alt="doxygen" align="middle" border=0 
width=110 height=53></a>1.2.14 written by <a href="mailto:dimitri@stack.nl">Dimitri van Heesch</a>,
 &copy;&nbsp;1997-2002</small></address>
</body>
</html>
