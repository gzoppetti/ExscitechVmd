<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>xbgfplugin.C Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.2.14 -->
<center>
<a class="qindex" href="index.html">Main Page</a> &nbsp; <a class="qindex" href="classes.html">Alphabetical List</a> &nbsp; <a class="qindex" href="annotated.html">Compound List</a> &nbsp; <a class="qindex" href="files.html">File List</a> &nbsp; <a class="qindex" href="functions.html">Compound Members</a> &nbsp; <a class="qindex" href="globals.html">File Members</a> &nbsp; <a class="qindex" href="pages.html">Related Pages</a> &nbsp; </center>
<hr><h1>xbgfplugin.C</h1><a href="xbgfplugin_8C.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 <font class="comment">/***************************************************************************</font>
00002 <font class="comment"> *cr</font>
00003 <font class="comment"> *cr            (C) Copyright 1995-2006 The Board of Trustees of the</font>
00004 <font class="comment"> *cr                        University of Illinois</font>
00005 <font class="comment"> *cr                         All Rights Reserved</font>
00006 <font class="comment"> *cr</font>
00007 <font class="comment"> ***************************************************************************/</font>
00008 
00009 <font class="comment">/***************************************************************************</font>
00010 <font class="comment"> * RCS INFORMATION:</font>
00011 <font class="comment"> *</font>
00012 <font class="comment"> *      $RCSfile: xbgfplugin.C,v $</font>
00013 <font class="comment"> *      $Author: johns $       $Locker:  $             $State: Exp $</font>
00014 <font class="comment"> *      $Revision: 1.21 $       $Date: 2006/02/23 19:36:46 $</font>
00015 <font class="comment"> *</font>
00016 <font class="comment"> ***************************************************************************/</font>
00017 
00018 <font class="preprocessor">#include "<a class="code" href="molfile__plugin_8h.html">molfile_plugin.h</a>"</font>
00019 
00020 <font class="preprocessor">#include &lt;stdlib.h&gt;</font>
00021 <font class="preprocessor">#include &lt;stdio.h&gt;</font>
00022 <font class="preprocessor">#include &lt;string.h&gt;</font>
00023 
00024 <font class="preprocessor">#if defined(_AIX)</font>
00025 <font class="preprocessor"></font><font class="preprocessor">#include &lt;strings.h&gt;</font>
00026 <font class="preprocessor">#endif</font>
00027 <font class="preprocessor"></font>
<a name="l00028"></a><a class="code" href="xbgfplugin_8C.html#a0">00028</a> <font class="preprocessor">#define LINESIZE 256</font>
00029 <font class="preprocessor"></font>
<a name="l00030"></a><a class="code" href="structxbgfdata.html">00030</a> <font class="keyword">typedef</font> <font class="keyword">struct </font>{
<a name="l00031"></a><a class="code" href="structxbgfdata.html#m0">00031</a>   FILE *file;
<a name="l00032"></a><a class="code" href="structxbgfdata.html#m1">00032</a>   <a class="code" href="structmolfile__atom__t.html">molfile_atom_t</a> *atomlist;
<a name="l00033"></a><a class="code" href="structxbgfdata.html#m2">00033</a>   <a class="code" href="structmolfile__metadata__t.html">molfile_metadata_t</a> *meta;
<a name="l00034"></a><a class="code" href="structxbgfdata.html#m5">00034</a>   <font class="keywordtype">int</font> natoms, nbonds, optflags, coords_read;
<a name="l00035"></a><a class="code" href="structxbgfdata.html#m8">00035</a>   <font class="keywordtype">int</font> *from, *to;
<a name="l00036"></a><a class="code" href="structxbgfdata.html#m9">00036</a>   <font class="keywordtype">float</font> *bondorder;
00037 } <a class="code" href="structxbgfdata.html">xbgfdata</a>;
00038 
00039 
00040 <font class="comment">// Open the file and create the bgf struct used to pass data to the other</font>
00041 <font class="comment">// functions.</font>
<a name="l00042"></a><a class="code" href="xbgfplugin_8C.html#a2">00042</a> <font class="keyword">static</font> <font class="keywordtype">void</font> *<a class="code" href="xbgfplugin_8C.html#a2">open_bgf_read</a>(<font class="keyword">const</font> <font class="keywordtype">char</font> *path, <font class="keyword">const</font> <font class="keywordtype">char</font> *filetype, 
00043     <font class="keywordtype">int</font> *natoms) {
00044   FILE *fd;
00045   <a class="code" href="structxbgfdata.html">xbgfdata</a> *bgf;
00046   <font class="keywordtype">char</font> line[<a class="code" href="xbgfplugin_8C.html#a0">LINESIZE</a>]; 
00047   <font class="keywordtype">int</font> nbonds, optflags;
00048   <font class="keywordtype">int</font> numat=0;
00049   nbonds=0;
00050   <font class="keywordtype">int</font> nbline; <font class="comment">//Number of bonds in current line</font>
00051 
00052   <font class="comment">// Allocate and initialize the bgf structure</font>
00053   bgf = <font class="keyword">new</font> <a class="code" href="structxbgfdata.html">xbgfdata</a>;
00054 
00055   bgf-&gt;<a class="code" href="structxbgfdata.html#m2">meta</a> = (<a class="code" href="structmolfile__metadata__t.html">molfile_metadata_t</a> *) malloc(<font class="keyword">sizeof</font>(<a class="code" href="structmolfile__metadata__t.html">molfile_metadata_t</a>));
00056   memset(bgf-&gt;<a class="code" href="structxbgfdata.html#m2">meta</a>, 0, <font class="keyword">sizeof</font>(<a class="code" href="structmolfile__metadata__t.html">molfile_metadata_t</a>));
00057 
00058   bgf-&gt;<a class="code" href="structxbgfdata.html#m2">meta</a>-&gt;<a class="code" href="structmolfile__metadata__t.html#m4">remarklen</a> = 0;
00059   bgf-&gt;<a class="code" href="structxbgfdata.html#m2">meta</a>-&gt;<a class="code" href="structmolfile__metadata__t.html#m5">remarks</a> = NULL;
00060 
00061   <font class="keywordflow">if</font> ((fd = fopen(path, <font class="stringliteral">"r"</font>)) == NULL)
00062     <font class="keywordflow">return</font> NULL;
00063 
00064   <font class="keywordflow">do</font> {
00065     fgets(line, <a class="code" href="xbgfplugin_8C.html#a0">LINESIZE</a>, fd);
00066     <font class="keywordflow">if</font> ( ferror(fd) || feof(fd) ) {
00067       printf(<font class="stringliteral">"xbgfplugin) Improperly terminated bgf file\n"</font>);
00068       <font class="keywordflow">return</font> NULL;
00069     }
00070 
00071     <font class="keywordflow">if</font> ((strncmp(line, <font class="stringliteral">"ATOM"</font>, 4) == 0) || (strncmp(line, <font class="stringliteral">"HETATM"</font>, 6)==0)) 
00072       numat++;
00073 
00074     <font class="keywordflow">if</font> (strncmp(line,<font class="stringliteral">"CONECT"</font>,6)==0) {
00075       nbline=(strlen(line)-1)/6; 
00076       nbline -= 2;
00077       nbonds += nbline;
00078     }
00079 
00080     <font class="comment">// Read the remarks</font>
00081     <font class="keywordflow">if</font> (strncmp(line, <font class="stringliteral">"REMARK"</font>, 4)==0 || strncmp(line, <font class="stringliteral">"LEWIS"</font>, 4)==0 || 
00082         strncmp(line, <font class="stringliteral">"VDW"</font>, 3)==0) {
00083       <font class="keywordtype">int</font> len=strlen(line);
00084       <font class="keywordtype">int</font> newlen = len + bgf-&gt;<a class="code" href="structxbgfdata.html#m2">meta</a>-&gt;<a class="code" href="structmolfile__metadata__t.html#m4">remarklen</a>;
00085       <font class="keywordtype">char</font> *newstr=(<font class="keywordtype">char</font>*) realloc(bgf-&gt;<a class="code" href="structxbgfdata.html#m2">meta</a>-&gt;<a class="code" href="structmolfile__metadata__t.html#m5">remarks</a>, newlen + 1);
00086       <font class="keywordflow">if</font> (newstr != NULL) {
00087         bgf-&gt;<a class="code" href="structxbgfdata.html#m2">meta</a>-&gt;<a class="code" href="structmolfile__metadata__t.html#m5">remarks</a> = newstr;
00088         bgf-&gt;<a class="code" href="structxbgfdata.html#m2">meta</a>-&gt;<a class="code" href="structmolfile__metadata__t.html#m5">remarks</a>[bgf-&gt;<a class="code" href="structxbgfdata.html#m2">meta</a>-&gt;<a class="code" href="structmolfile__metadata__t.html#m4">remarklen</a>] = <font class="charliteral">'\0'</font>;
00089         memcpy(bgf-&gt;<a class="code" href="structxbgfdata.html#m2">meta</a>-&gt;<a class="code" href="structmolfile__metadata__t.html#m5">remarks</a> + bgf-&gt;<a class="code" href="structxbgfdata.html#m2">meta</a>-&gt;<a class="code" href="structmolfile__metadata__t.html#m4">remarklen</a>, line, len);
00090         bgf-&gt;<a class="code" href="structxbgfdata.html#m2">meta</a>-&gt;<a class="code" href="structmolfile__metadata__t.html#m5">remarks</a>[newlen] = <font class="charliteral">'\0'</font>;
00091         bgf-&gt;<a class="code" href="structxbgfdata.html#m2">meta</a>-&gt;<a class="code" href="structmolfile__metadata__t.html#m4">remarklen</a> = newlen;
00092       }
00093     }
00094 
00095     optflags = <a class="code" href="molfile__plugin_8h.html#a9">MOLFILE_INSERTION</a> | <a class="code" href="molfile__plugin_8h.html#a13">MOLFILE_CHARGE</a> | <a class="code" href="molfile__plugin_8h.html#a11">MOLFILE_BFACTOR</a> | <a class="code" href="molfile__plugin_8h.html#a10">MOLFILE_OCCUPANCY</a> | <a class="code" href="molfile__plugin_8h.html#a16">MOLFILE_ATOMICNUMBER</a>;
00096   } <font class="keywordflow">while</font> ( strncmp(line, <font class="stringliteral">"END"</font>, 3) );
00097     
00098   *natoms = numat;
00099   rewind(fd);
00100 
00101   bgf-&gt;<a class="code" href="structxbgfdata.html#m0">file</a> = fd;
00102   bgf-&gt;<a class="code" href="structxbgfdata.html#m3">natoms</a> = *natoms;
00103   bgf-&gt;<a class="code" href="structxbgfdata.html#m4">nbonds</a> = nbonds;
00104 
00105   bgf-&gt;<a class="code" href="structxbgfdata.html#m5">optflags</a> = optflags;
00106   bgf-&gt;<a class="code" href="structxbgfdata.html#m6">coords_read</a> = 0;
00107   bgf-&gt;<a class="code" href="structxbgfdata.html#m7">from</a> = NULL;
00108   bgf-&gt;<a class="code" href="structxbgfdata.html#m8">to</a> = NULL;
00109                                                                                 
00110   <font class="keywordflow">return</font> bgf;
00111 }
00112 
00113 
<a name="l00114"></a><a class="code" href="xbgfplugin_8C.html#a3">00114</a> <font class="keyword">static</font> <font class="keywordtype">void</font> <a class="code" href="xbgfplugin_8C.html#a3">adjust_bgf_field_string</a>(<font class="keywordtype">char</font> *field) {
00115   <font class="keywordtype">int</font> i, len;
00116 
00117   len = strlen(field);
00118   <font class="keywordflow">while</font> (len &gt; 0 &amp;&amp; field[len-1] == <font class="charliteral">' '</font>) {
00119     field[len-1] = <font class="charliteral">'\0'</font>;
00120     len--;
00121   }
00122 
00123   <font class="keywordflow">while</font> (len &gt; 0 &amp;&amp; field[0] == <font class="charliteral">' '</font>) {
00124     <font class="keywordflow">for</font> (i=0; i &lt; len; i++)
00125       field[i] = field[i+1];
00126     len--;
00127   }
00128 }
00129 
<a name="l00130"></a><a class="code" href="xbgfplugin_8C.html#a4">00130</a> <font class="keyword">static</font> <font class="keywordtype">void</font> <a class="code" href="xbgfplugin_8C.html#a4">get_bgf_coordinates</a>(<font class="keyword">const</font> <font class="keywordtype">char</font> *record, 
00131                                 <font class="keywordtype">float</font> *x, <font class="keywordtype">float</font> *y, <font class="keywordtype">float</font> *z) {
00132   <font class="keywordtype">char</font> numstr[50]; <font class="comment">/* store all fields in one array to save memset calls */</font>
00133   memset(numstr, 0, <font class="keyword">sizeof</font>(numstr));
00134   <font class="keywordflow">if</font> (x != NULL) {
00135     strncpy(numstr, record + 32, 10);
00136     *x = (float) atof(numstr);
00137   }
00138 
00139   <font class="keywordflow">if</font> (y != NULL) {
00140     strncpy(numstr+10, record + 42, 10);
00141     *y = (float) atof(numstr+10);
00142   }
00143 
00144   <font class="keywordflow">if</font> (z != NULL) {
00145     strncpy(numstr+20, record + 52, 10);
00146     *z = (float) atof(numstr+20);
00147   }
00148 }
00149 
00150 
<a name="l00151"></a><a class="code" href="xbgfplugin_8C.html#a5">00151</a> <font class="keyword">static</font> <font class="keywordtype">void</font> <a class="code" href="xbgfplugin_8C.html#a5">get_bgf_fields</a>(<font class="keyword">const</font> <font class="keywordtype">char</font> *record, <font class="keywordtype">char</font> *<a class="code" href="xsfplugin_8C.html#a2">name</a>, <font class="keywordtype">char</font> *resname, 
00152                            <font class="keywordtype">char</font> *chain, <font class="keywordtype">char</font>* segname, <font class="keywordtype">float</font> *occupancy, 
00153                            <font class="keywordtype">float</font> *bfactor, <font class="keywordtype">int</font> *elementindex,
00154                            <font class="keywordtype">int</font> *resid, <font class="keywordtype">char</font> *type, <font class="keywordtype">float</font> *charge,
00155                            <font class="keywordtype">float</font> *x, <font class="keywordtype">float</font> *y, <font class="keywordtype">float</font> *z, <font class="keywordtype">char</font>* insert) {
00156   <font class="keywordtype">char</font> tempresid[6];
00157   <font class="keywordtype">char</font> tempcharge[8];
00158   <font class="keywordtype">char</font> tempbeta[7];
00159   <font class="keywordtype">char</font> tempocc[7];
00160   <font class="keywordtype">char</font> tempelem[4];
00161   strcpy(insert, <font class="stringliteral">" "</font>);
00162 
00163   <font class="comment">/* get atom name */</font>
00164   strncpy(<a class="code" href="xsfplugin_8C.html#a2">name</a>, record + 14, 5);
00165   <a class="code" href="xsfplugin_8C.html#a2">name</a>[5] = <font class="charliteral">'\0'</font>;
00166   <a class="code" href="xbgfplugin_8C.html#a3">adjust_bgf_field_string</a>(<a class="code" href="xsfplugin_8C.html#a2">name</a>); <font class="comment">/* remove spaces from the name */</font>
00167 
00168   <font class="comment">/* get residue name */</font>
00169   strncpy(resname, record + 20, 4);
00170   resname[4] = <font class="charliteral">'\0'</font>;
00171   <a class="code" href="xbgfplugin_8C.html#a3">adjust_bgf_field_string</a>(resname); <font class="comment">/* remove spaces from the resname */</font>
00172 
00173   <font class="comment">/* set segname */</font>
00174   strncpy(segname, record + 101, 4);
00175   segname[4]=<font class="charliteral">'\0'</font>;
00176   <a class="code" href="xbgfplugin_8C.html#a3">adjust_bgf_field_string</a>(segname); <font class="comment">/* remove spaces from the segname */</font>
00177 
00178   <font class="comment">/* get chain name */</font>
00179   chain[0] = record[25];
00180   chain[1] = <font class="charliteral">'\0'</font>;
00181 
00182   <font class="comment">/* get residue id number */</font>
00183   strncpy(tempresid, record + 27, 5);
00184   tempresid[5] = <font class="charliteral">'\0'</font>;
00185   <a class="code" href="xbgfplugin_8C.html#a3">adjust_bgf_field_string</a>(tempresid); <font class="comment">/* remove spaces from the resid */</font>
00186   *resid=atoi(tempresid);
00187 
00188   <font class="comment">/* get force field type */</font>
00189   strncpy(type, record+63, 5);
00190   type[5]=<font class="charliteral">'\0'</font>;
00191   <a class="code" href="xbgfplugin_8C.html#a3">adjust_bgf_field_string</a>(type); <font class="comment">/* remove spaces */</font>
00192 
00193   <font class="comment">/* get charge*/</font>
00194   strncpy(tempcharge, record + 74, 7);
00195   tempcharge[7] = <font class="charliteral">'\0'</font>;
00196   <a class="code" href="xbgfplugin_8C.html#a3">adjust_bgf_field_string</a>(tempcharge); <font class="comment">/* remove spaces from the charge */</font>
00197   *charge=atof(tempcharge);
00198 
00199   <font class="comment">/* Get B factor, occupancy, and element */</font>
00200   strncpy(tempbeta, record + 83, 6);
00201   tempbeta[6] = <font class="charliteral">'\0'</font>;
00202   <a class="code" href="xbgfplugin_8C.html#a3">adjust_bgf_field_string</a>(tempbeta); <font class="comment">/* remove spaces from the beta field */</font>
00203   *bfactor=atof(tempbeta);
00204   
00205   strncpy(tempocc, record + 90, 6);
00206   tempocc[6] = <font class="charliteral">'\0'</font>;
00207   <a class="code" href="xbgfplugin_8C.html#a3">adjust_bgf_field_string</a>(tempocc); <font class="comment">/* remove spaces from the occupancy field */</font>
00208   *occupancy=atof(tempocc);
00209   
00210   strncpy(tempelem, record + 97, 3);
00211   tempelem[3] = <font class="charliteral">'\0'</font>;
00212   <a class="code" href="xbgfplugin_8C.html#a3">adjust_bgf_field_string</a>(tempelem); <font class="comment">/* remove spaces from the element */</font>
00213   *elementindex=atoi(tempelem);
00214 
00215   <font class="comment">/* get x, y, and z coordinates */</font>
00216   <a class="code" href="xbgfplugin_8C.html#a4">get_bgf_coordinates</a>(record, x, y, z);
00217 }  
00218 
00219 
00220 <font class="comment">// Read atom information, but not coordinates.</font>
<a name="l00221"></a><a class="code" href="xbgfplugin_8C.html#a6">00221</a> <font class="keyword">static</font> <font class="keywordtype">int</font> <a class="code" href="xbgfplugin_8C.html#a6">read_bgf_structure</a>(<font class="keywordtype">void</font> *v, <font class="keywordtype">int</font> *optflags, <a class="code" href="structmolfile__atom__t.html">molfile_atom_t</a> *atoms) {
00222   <a class="code" href="structxbgfdata.html">xbgfdata</a> *bgf = (<a class="code" href="structxbgfdata.html">xbgfdata</a> *)v;
00223   <font class="keywordtype">char</font> line[<a class="code" href="xbgfplugin_8C.html#a0">LINESIZE</a>]; 
00224   <a class="code" href="structmolfile__atom__t.html">molfile_atom_t</a> *atom;
00225   <font class="keywordtype">int</font> natoms=0;
00226 
00227   <font class="comment">//optflags = MOLFILE_INSERTION | MOLFILE_CHARGE | MOLFILE_BFACTOR | MOLFILE_OCCUPANCY | MOLFILE_ATOMICNUMBER;</font>
00228   *optflags = bgf-&gt;<a class="code" href="structxbgfdata.html#m5">optflags</a>;
00229 
00230   <font class="comment">// Find and read the ATOM record</font>
00231   rewind(bgf-&gt;<a class="code" href="structxbgfdata.html#m0">file</a>);
00232   <font class="keywordflow">do</font> {
00233     fgets(line, <a class="code" href="xbgfplugin_8C.html#a0">LINESIZE</a>, bgf-&gt;<a class="code" href="structxbgfdata.html#m0">file</a>);
00234     <font class="keywordflow">if</font> ( ferror(bgf-&gt;<a class="code" href="structxbgfdata.html#m0">file</a>) || feof(bgf-&gt;<a class="code" href="structxbgfdata.html#m0">file</a>) ) {
00235       printf(<font class="stringliteral">"xbgfplugin) FORMAT ATOM record found in file.\n"</font>);
00236       <font class="keywordflow">return</font> <a class="code" href="molfile__plugin_8h.html#a4">MOLFILE_ERROR</a>;
00237     }
00238   } <font class="keywordflow">while</font> ( strncmp(line, <font class="stringliteral">"FORMAT ATOM"</font>, 11) );
00239 
00240   <font class="comment">// Read the atoms</font>
00241   <font class="keywordflow">do</font> {
00242     fgets(line, <a class="code" href="xbgfplugin_8C.html#a0">LINESIZE</a>, bgf-&gt;<a class="code" href="structxbgfdata.html#m0">file</a>);
00243     <font class="keywordflow">if</font> ( ferror(bgf-&gt;<a class="code" href="structxbgfdata.html#m0">file</a>) || feof(bgf-&gt;<a class="code" href="structxbgfdata.html#m0">file</a>) ) {
00244       printf(<font class="stringliteral">"xbgfplugin) Error occurred reading atom record.\n"</font>);
00245       <font class="keywordflow">return</font> <a class="code" href="molfile__plugin_8h.html#a4">MOLFILE_ERROR</a>;
00246     }
00247 
00248     <font class="keywordflow">if</font> (strncmp(line, <font class="stringliteral">"ATOM"</font>, 4) &amp;&amp; strncmp(line, <font class="stringliteral">"HETATM"</font>, 6)) <font class="keywordflow">continue</font>;
00249     atom=atoms+natoms;
00250     natoms++;
00251     <a class="code" href="xbgfplugin_8C.html#a5">get_bgf_fields</a>(line, atom-&gt;<a class="code" href="structmolfile__atom__t.html#m0">name</a>, atom-&gt;<a class="code" href="structmolfile__atom__t.html#m2">resname</a>, atom-&gt;<a class="code" href="structmolfile__atom__t.html#m5">chain</a>, atom-&gt;<a class="code" href="structmolfile__atom__t.html#m4">segid</a>, 
00252                    &amp;atom-&gt;<a class="code" href="structmolfile__atom__t.html#m8">occupancy</a>, &amp;atom-&gt;<a class="code" href="structmolfile__atom__t.html#m9">bfactor</a>, &amp;atom-&gt;<a class="code" href="structmolfile__atom__t.html#m13">atomicnumber</a>, 
00253                    &amp;atom-&gt;<a class="code" href="structmolfile__atom__t.html#m3">resid</a>, atom-&gt;<a class="code" href="structmolfile__atom__t.html#m1">type</a>, &amp;atom-&gt;<a class="code" href="structmolfile__atom__t.html#m11">charge</a>, 
00254                    NULL, NULL, NULL, atom-&gt;<a class="code" href="structmolfile__atom__t.html#m7">insertion</a>);
00255   } <font class="keywordflow">while</font> (strncmp(line, <font class="stringliteral">"END"</font>, 3));
00256 
00257   bgf-&gt;<a class="code" href="structxbgfdata.html#m3">natoms</a> = natoms;
00258 
00259   <font class="keywordflow">return</font> <a class="code" href="molfile__plugin_8h.html#a2">MOLFILE_SUCCESS</a>;
00260 }
00261 
00262 
00263 <font class="comment">// Read atom coordinates</font>
<a name="l00264"></a><a class="code" href="xbgfplugin_8C.html#a7">00264</a> <font class="keyword">static</font> <font class="keywordtype">int</font> <a class="code" href="xbgfplugin_8C.html#a7">read_bgf_timestep</a>(<font class="keywordtype">void</font> *v, <font class="keywordtype">int</font> natoms, <a class="code" href="structmolfile__timestep__t.html">molfile_timestep_t</a> *ts) {
00265   <a class="code" href="structxbgfdata.html">xbgfdata</a> *bgf = (<a class="code" href="structxbgfdata.html">xbgfdata</a> *)v;
00266   <font class="keywordtype">char</font> line[<a class="code" href="xbgfplugin_8C.html#a0">LINESIZE</a>];
00267   <font class="keywordtype">int</font> i;
00268   <font class="keywordtype">float</font> x, y, z;
00269 
00270   <font class="comment">// Since the file is rewound when coordinates are read, EOF shouldn't</font>
00271   <font class="comment">// happen. Instead, use a flag to indicate that the single timestep has</font>
00272   <font class="comment">// been read</font>
00273   <font class="keywordflow">if</font> (bgf-&gt;<a class="code" href="structxbgfdata.html#m6">coords_read</a>) {
00274     <font class="keywordflow">return</font> <a class="code" href="molfile__plugin_8h.html#a3">MOLFILE_EOF</a>;
00275   }
00276 
00277   <font class="comment">// Find and read the ATOM record</font>
00278   rewind(bgf-&gt;<a class="code" href="structxbgfdata.html#m0">file</a>);
00279   <font class="keywordflow">do</font> {
00280     fgets(line, <a class="code" href="xbgfplugin_8C.html#a0">LINESIZE</a>, bgf-&gt;<a class="code" href="structxbgfdata.html#m0">file</a>);
00281     <font class="keywordflow">if</font> ( ferror(bgf-&gt;<a class="code" href="structxbgfdata.html#m0">file</a>) || feof(bgf-&gt;<a class="code" href="structxbgfdata.html#m0">file</a>) ) {
00282       printf(<font class="stringliteral">"xbgfplugin) No FORMAT ATOM record found in file.\n"</font>);
00283       <font class="keywordflow">return</font> <a class="code" href="molfile__plugin_8h.html#a4">MOLFILE_ERROR</a>;
00284     }
00285   } <font class="keywordflow">while</font> ( strncmp(line, <font class="stringliteral">"FORMAT ATOM"</font>, 11) );
00286 
00287   <font class="comment">// Read the atoms</font>
00288   <font class="keywordflow">for</font> (i = 0; i &lt; bgf-&gt;<a class="code" href="structxbgfdata.html#m3">natoms</a>; i++) {
00289     fgets(line, <a class="code" href="xbgfplugin_8C.html#a0">LINESIZE</a>, bgf-&gt;<a class="code" href="structxbgfdata.html#m0">file</a>);
00290     <font class="keywordflow">if</font> ( ferror(bgf-&gt;<a class="code" href="structxbgfdata.html#m0">file</a>) || feof(bgf-&gt;<a class="code" href="structxbgfdata.html#m0">file</a>) ) {
00291       printf(<font class="stringliteral">"xbgfplugin) Error occurred reading atom coordinates.\n"</font>);
00292       <font class="keywordflow">return</font> <a class="code" href="molfile__plugin_8h.html#a4">MOLFILE_ERROR</a>;
00293     }
00294 
00295     <font class="comment">// skip comments and blank lines</font>
00296     <font class="keywordflow">if</font> (strncmp(line,<font class="stringliteral">"ATOM"</font>,4)!=0 &amp;&amp; strncmp(line,<font class="stringliteral">"HETATM"</font>,6)!=0) <font class="keywordflow">continue</font>;
00297 
00298     <a class="code" href="xbgfplugin_8C.html#a4">get_bgf_coordinates</a>(line, &amp;x, &amp;y, &amp;z);
00299 
00300     <font class="keywordflow">if</font> (ts) {
00301       ts-&gt;<a class="code" href="structmolfile__timestep__t.html#m0">coords</a>[3*i  ] = x;
00302       ts-&gt;<a class="code" href="structmolfile__timestep__t.html#m0">coords</a>[3*i+1] = y;
00303       ts-&gt;<a class="code" href="structmolfile__timestep__t.html#m0">coords</a>[3*i+2] = z;
00304     }
00305   }
00306 
00307   bgf-&gt;<a class="code" href="structxbgfdata.html#m6">coords_read</a> = 1;
00308   <font class="keywordflow">return</font> <a class="code" href="molfile__plugin_8h.html#a2">MOLFILE_SUCCESS</a>;
00309 }
00310 
00311 
<a name="l00312"></a><a class="code" href="xbgfplugin_8C.html#a8">00312</a> <font class="keyword">static</font> <font class="keywordtype">void</font> *<a class="code" href="xbgfplugin_8C.html#a8">open_bgf_write</a>(<font class="keyword">const</font> <font class="keywordtype">char</font> *filename, <font class="keyword">const</font> <font class="keywordtype">char</font> *filetype, 
00313                            <font class="keywordtype">int</font> natoms) {
00314   FILE *fd;
00315   <a class="code" href="structxbgfdata.html">xbgfdata</a> *data;
00316 
00317   <font class="keywordflow">if</font> ((fd = fopen(filename, <font class="stringliteral">"w"</font>)) == NULL) { 
00318     printf(<font class="stringliteral">"xbgfplugin) Error, unable to open bgf file %s for writing\n"</font>,
00319             filename);
00320     <font class="keywordflow">return</font> NULL;
00321   }
00322   
00323   data = (<a class="code" href="structxbgfdata.html">xbgfdata</a> *)malloc(<font class="keyword">sizeof</font>(<a class="code" href="structxbgfdata.html">xbgfdata</a>));
00324   data-&gt;<a class="code" href="structxbgfdata.html#m3">natoms</a> = natoms;
00325   data-&gt;<a class="code" href="structxbgfdata.html#m0">file</a> = fd;
00326   <font class="keywordflow">return</font> data;
00327 }
00328 
00329 
<a name="l00330"></a><a class="code" href="xbgfplugin_8C.html#a9">00330</a> <font class="keyword">static</font> <font class="keywordtype">int</font> <a class="code" href="xbgfplugin_8C.html#a9">write_bgf_structure</a>(<font class="keywordtype">void</font> *mydata, <font class="keywordtype">int</font> optflags, 
00331                                <font class="keyword">const</font> <a class="code" href="structmolfile__atom__t.html">molfile_atom_t</a> *atoms) {
00332   <a class="code" href="structxbgfdata.html">xbgfdata</a> *data = (<a class="code" href="structxbgfdata.html">xbgfdata</a> *)mydata;
00333   data-&gt;<a class="code" href="structxbgfdata.html#m1">atomlist</a> = (<a class="code" href="structmolfile__atom__t.html">molfile_atom_t</a> *)malloc(data-&gt;<a class="code" href="structxbgfdata.html#m3">natoms</a>*<font class="keyword">sizeof</font>(<a class="code" href="structmolfile__atom__t.html">molfile_atom_t</a>));
00334   memcpy(data-&gt;<a class="code" href="structxbgfdata.html#m1">atomlist</a>, atoms, data-&gt;<a class="code" href="structxbgfdata.html#m3">natoms</a>*<font class="keyword">sizeof</font>(<a class="code" href="structmolfile__atom__t.html">molfile_atom_t</a>));
00335   <font class="keywordflow">return</font> <a class="code" href="molfile__plugin_8h.html#a2">MOLFILE_SUCCESS</a>;
00336 }
00337 
00338 
<a name="l00339"></a><a class="code" href="xbgfplugin_8C.html#a10">00339</a> <font class="keyword">static</font> <font class="keywordtype">int</font> <a class="code" href="xbgfplugin_8C.html#a10">read_bgf_bonds</a>(<font class="keywordtype">void</font> *v, <font class="keywordtype">int</font> *nbonds, <font class="keywordtype">int</font> **fromptr, <font class="keywordtype">int</font> **toptr, <font class="keywordtype">float</font> **bondorderptr) {
00340   <a class="code" href="structxbgfdata.html">xbgfdata</a> *bgf = (<a class="code" href="structxbgfdata.html">xbgfdata</a> *)v;
00341   <font class="keywordtype">char</font> line[<a class="code" href="xbgfplugin_8C.html#a0">LINESIZE</a>]; 
00342   <font class="keywordtype">char</font> nextline[<a class="code" href="xbgfplugin_8C.html#a0">LINESIZE</a>]; 
00343   <font class="keywordflow">if</font> (bgf-&gt;<a class="code" href="structxbgfdata.html#m4">nbonds</a> == 0) {
00344     *nbonds = 0;
00345     *fromptr = NULL;
00346     *toptr = NULL;
00347     *bondorderptr = NULL;
00348     <font class="keywordflow">return</font> <a class="code" href="molfile__plugin_8h.html#a2">MOLFILE_SUCCESS</a>;
00349   }
00350 
00351   <font class="comment">// Allocate memory for the from and to arrays. This will be freed when closed</font>
00352   bgf-&gt;<a class="code" href="structxbgfdata.html#m7">from</a> = <font class="keyword">new</font> <font class="keywordtype">int</font>[bgf-&gt;<a class="code" href="structxbgfdata.html#m4">nbonds</a>];
00353   bgf-&gt;<a class="code" href="structxbgfdata.html#m8">to</a> = <font class="keyword">new</font> <font class="keywordtype">int</font>[bgf-&gt;<a class="code" href="structxbgfdata.html#m4">nbonds</a>];
00354   bgf-&gt;<a class="code" href="structxbgfdata.html#m9">bondorder</a> = <font class="keyword">new</font> <font class="keywordtype">float</font>[bgf-&gt;<a class="code" href="structxbgfdata.html#m4">nbonds</a>];
00355 
00356   <font class="comment">// Find and read the BOND record</font>
00357   rewind(bgf-&gt;<a class="code" href="structxbgfdata.html#m0">file</a>);
00358   <font class="keywordflow">do</font> {
00359     fgets(line, <a class="code" href="xbgfplugin_8C.html#a0">LINESIZE</a>, bgf-&gt;<a class="code" href="structxbgfdata.html#m0">file</a>);
00360     <font class="keywordflow">if</font> ( ferror(bgf-&gt;<a class="code" href="structxbgfdata.html#m0">file</a>) || feof(bgf-&gt;<a class="code" href="structxbgfdata.html#m0">file</a>) ) {
00361       printf(<font class="stringliteral">"xbgfplugin) No bond record found in file.\n"</font>);
00362       <font class="keywordflow">return</font> <a class="code" href="molfile__plugin_8h.html#a4">MOLFILE_ERROR</a>;
00363     }
00364   } <font class="keywordflow">while</font> ( strncmp(line, <font class="stringliteral">"FORMAT CONECT"</font>, 13) != 0 );
00365 
00366   <font class="comment">// Read the bonds</font>
00367   <font class="keywordtype">int</font> j; <font class="comment">//From atom</font>
00368   <font class="keywordtype">int</font> k; <font class="comment">//To atom</font>
00369   <font class="keywordtype">bool</font> conline=<font class="keyword">false</font>; <font class="comment">//true if line after the conect line is an order line</font>
00370   <font class="keywordtype">char</font> currbond[7]=<font class="stringliteral">"xxxxxx"</font>; <font class="comment">//Stores current bond field</font>
00371   <font class="keywordtype">char</font> currcon[7]=<font class="stringliteral">"xxxxxx"</font>; <font class="comment">//Stores current ORDER field</font>
00372   <font class="keywordtype">char</font>* bondptr; <font class="comment">//pointer to current position in bond line</font>
00373   <font class="keywordtype">char</font>* conptr; <font class="comment">//pointer to current position in order line</font>
00374   <font class="keywordtype">int</font> bonds[8]; <font class="comment">//Stores bonds of current atom</font>
00375   <font class="keywordtype">float</font> orders[8]; <font class="comment">//Stores bond orders of current atom</font>
00376   <font class="keywordtype">int</font> numbonds; <font class="comment">//Stores number of bonds of current atom</font>
00377   <font class="keywordtype">int</font> numords; <font class="comment">//Stores number of bond order records of current atom</font>
00378   <font class="keywordtype">float</font> bo; <font class="comment">//current bond order</font>
00379   <font class="keywordtype">int</font> i=0; <font class="comment">//Number of the current bond</font>
00380   <font class="keywordtype">int</font> numfields=0; <font class="comment">//number of fields in the current line</font>
00381   fgets(line, <a class="code" href="xbgfplugin_8C.html#a0">LINESIZE</a>, bgf-&gt;<a class="code" href="structxbgfdata.html#m0">file</a>);
00382   <font class="keywordflow">while</font> (1) {
00383     <font class="comment">// bondptr=NULL;</font>
00384     <font class="comment">//conptr=NULL;</font>
00385     conline=<font class="keyword">false</font>;
00386     <font class="keywordflow">if</font> (strncmp(line,<font class="stringliteral">"END"</font>,3)==0)
00387       <font class="keywordflow">break</font>;
00388 
00389     fgets(nextline, <a class="code" href="xbgfplugin_8C.html#a0">LINESIZE</a>, bgf-&gt;<a class="code" href="structxbgfdata.html#m0">file</a>);
00390     <font class="keywordflow">if</font> ( ferror(bgf-&gt;<a class="code" href="structxbgfdata.html#m0">file</a>) || feof(bgf-&gt;<a class="code" href="structxbgfdata.html#m0">file</a>) ) {
00391       printf(<font class="stringliteral">"xbgfplugin) Error occurred reading bond record.\n"</font>);
00392       <font class="keywordflow">return</font> <a class="code" href="molfile__plugin_8h.html#a4">MOLFILE_ERROR</a>;
00393     }
00394 
00395     <font class="keywordflow">if</font> (strncmp(nextline,<font class="stringliteral">"ORDER"</font>,5)==0) 
00396       conline=<font class="keyword">true</font>;
00397 
00398     <font class="keywordflow">if</font> (strncmp(line,<font class="stringliteral">"CONECT"</font>,6)==0) {
00399       numfields=(strlen(line)-1)/6;
00400       bondptr=&amp;line[0];
00401       numfields--;
00402       bondptr += 6;
00403       numbonds=0;
00404       numords=0;
00405       strncpy(currbond,bondptr,6);
00406       j=atoi(currbond);
00407       numfields--;
00408       bondptr += 6;
00409 
00410       <font class="keywordflow">while</font> ((numfields &gt; 0) &amp;&amp; (numbonds &lt; 8)) {
00411         strncpy(currbond,bondptr,6);
00412         numfields--;
00413         bondptr += 6;
00414         bonds[numbonds]=atoi(currbond);
00415         numbonds++;
00416       }
00417 
00418       <font class="keywordflow">if</font> (conline) {
00419         numfields=(strlen(line)-1)/6;
00420         conptr=&amp;nextline[0];
00421         numfields -= 2;
00422         conptr += 12;
00423         numords=0;
00424         <font class="keywordflow">while</font> ((numfields &gt; 0) &amp;&amp; (numords &lt; numbonds)) {
00425           strncpy(currcon,conptr,6);
00426           numfields--;
00427           conptr+=6;
00428           bo=atof(currcon);
00429           orders[numords]=bo;
00430           numords++;
00431         }
00432       }
00433 
00434       <font class="keywordflow">for</font> (<font class="keywordtype">int</font> l=0;l&lt;numbonds;l++) {
00435         k=bonds[l];
00436         <font class="keywordflow">if</font> (j&lt;k) {
00437           bgf-&gt;<a class="code" href="structxbgfdata.html#m7">from</a>[i]=j;
00438           bgf-&gt;<a class="code" href="structxbgfdata.html#m8">to</a>[i]=k;
00439           <font class="keywordflow">if</font> (conline) {
00440             bgf-&gt;<a class="code" href="structxbgfdata.html#m9">bondorder</a>[i]=orders[l];
00441           } <font class="keywordflow">else</font> {
00442             bgf-&gt;<a class="code" href="structxbgfdata.html#m9">bondorder</a>[i]=1.0;
00443           }
00444           i++;
00445         }
00446       }
00447         
00448       <font class="keywordflow">if</font> (conline) {
00449         fgets(line, <a class="code" href="xbgfplugin_8C.html#a0">LINESIZE</a>, bgf-&gt;<a class="code" href="structxbgfdata.html#m0">file</a>);
00450       } <font class="keywordflow">else</font> {
00451         strncpy(line,nextline,<a class="code" href="xbgfplugin_8C.html#a0">LINESIZE</a>);
00452       }
00453     } <font class="keywordflow">else</font> {
00454       strncpy(line,nextline,<a class="code" href="xbgfplugin_8C.html#a0">LINESIZE</a>);
00455     }
00456   }
00457 
00458   *nbonds = i;
00459   *fromptr = bgf-&gt;<a class="code" href="structxbgfdata.html#m7">from</a>;
00460   *toptr = bgf-&gt;<a class="code" href="structxbgfdata.html#m8">to</a>;
00461   *bondorderptr = bgf-&gt;<a class="code" href="structxbgfdata.html#m9">bondorder</a>; <font class="comment">// not implemented yet</font>
00462 
00463   <font class="keywordflow">return</font> <a class="code" href="molfile__plugin_8h.html#a2">MOLFILE_SUCCESS</a>;
00464 }
00465 
00466 
<a name="l00467"></a><a class="code" href="xbgfplugin_8C.html#a11">00467</a> <font class="keyword">static</font> <font class="keywordtype">int</font> <a class="code" href="xbgfplugin_8C.html#a11">read_bonds</a>(<font class="keywordtype">void</font> *v, <font class="keywordtype">int</font> *nbonds, <font class="keywordtype">int</font> **fromptr, <font class="keywordtype">int</font> **toptr, <font class="keywordtype">float</font> **bondorderptr) {
00468   <a class="code" href="structxbgfdata.html">xbgfdata</a> *bgf = (<a class="code" href="structxbgfdata.html">xbgfdata</a> *)v;
00469 
00470   <font class="comment">/* now read bond data */</font>
00471   *nbonds=bgf-&gt;<a class="code" href="structxbgfdata.html#m4">nbonds</a>;
00472   <font class="keywordflow">if</font> (bgf-&gt;<a class="code" href="structxbgfdata.html#m4">nbonds</a> &gt; 0) {
00473     bgf-&gt;<a class="code" href="structxbgfdata.html#m7">from</a> = (<font class="keywordtype">int</font> *) malloc(*nbonds*<font class="keyword">sizeof</font>(<font class="keywordtype">int</font>));
00474     bgf-&gt;<a class="code" href="structxbgfdata.html#m8">to</a> = (<font class="keywordtype">int</font> *) malloc(*nbonds*<font class="keyword">sizeof</font>(<font class="keywordtype">int</font>));
00475     bgf-&gt;<a class="code" href="structxbgfdata.html#m9">bondorder</a> = (<font class="keywordtype">float</font> *) malloc(*nbonds*<font class="keyword">sizeof</font>(<font class="keywordtype">float</font>));
00476 
00477     <font class="keywordflow">if</font> ((<a class="code" href="xbgfplugin_8C.html#a10">read_bgf_bonds</a>(bgf, nbonds, &amp;(bgf-&gt;<a class="code" href="structxbgfdata.html#m7">from</a>), &amp;(bgf-&gt;<a class="code" href="structxbgfdata.html#m8">to</a>), &amp;(bgf-&gt;<a class="code" href="structxbgfdata.html#m9">bondorder</a>))) != <a class="code" href="molfile__plugin_8h.html#a2">MOLFILE_SUCCESS</a>) {
00478       fclose(bgf-&gt;<a class="code" href="structxbgfdata.html#m0">file</a>);
00479       bgf-&gt;<a class="code" href="structxbgfdata.html#m0">file</a> = NULL;
00480       <font class="keywordflow">return</font> <a class="code" href="molfile__plugin_8h.html#a4">MOLFILE_ERROR</a>;
00481     }
00482     *fromptr = bgf-&gt;<a class="code" href="structxbgfdata.html#m7">from</a>;
00483     *toptr = bgf-&gt;<a class="code" href="structxbgfdata.html#m8">to</a>;
00484     *bondorderptr = bgf-&gt;<a class="code" href="structxbgfdata.html#m9">bondorder</a>; <font class="comment">// not implemented yet</font>
00485   } <font class="keywordflow">else</font> {
00486     printf(<font class="stringliteral">"xbgfplugin) WARNING: no bonds defined in xbgf file.\n"</font>);
00487     *fromptr = NULL;
00488     *toptr = NULL;
00489     *bondorderptr = NULL;
00490   }
00491   <font class="keywordflow">return</font> <a class="code" href="molfile__plugin_8h.html#a2">MOLFILE_SUCCESS</a>;
00492 }
00493 
00494 
<a name="l00495"></a><a class="code" href="xbgfplugin_8C.html#a12">00495</a> <font class="keyword">static</font> <font class="keywordtype">int</font> <a class="code" href="xbgfplugin_8C.html#a12">write_bgf_timestep</a>(<font class="keywordtype">void</font> *mydata, <font class="keyword">const</font> <a class="code" href="structmolfile__timestep__t.html">molfile_timestep_t</a> *ts) {
00496   <a class="code" href="structxbgfdata.html">xbgfdata</a> *data = (<a class="code" href="structxbgfdata.html">xbgfdata</a> *)mydata; 
00497   <font class="keyword">const</font> <a class="code" href="structmolfile__atom__t.html">molfile_atom_t</a> *atom;
00498   <font class="keyword">const</font> <font class="keywordtype">float</font> *pos;
00499   <font class="keywordtype">int</font> i;
00500 
00501   <font class="comment">//print header block</font>
00502   fprintf(data-&gt;<a class="code" href="structxbgfdata.html#m0">file</a>, <font class="stringliteral">"BIOGRF  332\n"</font>);
00503   fprintf(data-&gt;<a class="code" href="structxbgfdata.html#m0">file</a>, <font class="stringliteral">"REMARK NATOM %4i\n"</font>, data-&gt;<a class="code" href="structxbgfdata.html#m3">natoms</a>);
00504   fprintf(data-&gt;<a class="code" href="structxbgfdata.html#m0">file</a>, <font class="stringliteral">"FORCEFIELD DREIDING\n"</font>);
00505   fprintf(data-&gt;<a class="code" href="structxbgfdata.html#m0">file</a>, <font class="stringliteral">"FORMAT ATOM   (a6,1x,i6,1x,a5,1x,a4,1x,a1,1x,i5,3f10.5,1x,a5,i3,i2,1x,f8.5,1x,f6.3,1x,f6.3,1x,i3,1x,a4)\n"</font>);
00506 
00507   <font class="comment">//print atoms block</font>
00508   atom = data-&gt;<a class="code" href="structxbgfdata.html#m1">atomlist</a>;
00509   pos = ts-&gt;<a class="code" href="structmolfile__timestep__t.html#m0">coords</a>;
00510   <font class="keywordtype">int</font> numbonds=0;
00511   <font class="keywordtype">int</font> lp=0;
00512   <font class="keywordflow">for</font> (i = 0; i &lt; data-&gt;<a class="code" href="structxbgfdata.html#m3">natoms</a>; i++) {
00513     fprintf(data-&gt;<a class="code" href="structxbgfdata.html#m0">file</a>, <font class="stringliteral">"%-6s %6i %5s %4s %1s %5i%10.5f%10.5f%10.5f %-5s%3i%2i %8.5f %6.3f %6.3f %3i %4s\n"</font>, <font class="stringliteral">"ATOM"</font>, i+1, atom-&gt;<a class="code" href="structmolfile__atom__t.html#m0">name</a>, atom-&gt;<a class="code" href="structmolfile__atom__t.html#m2">resname</a>, atom-&gt;<a class="code" href="structmolfile__atom__t.html#m5">chain</a>, atom-&gt;<a class="code" href="structmolfile__atom__t.html#m3">resid</a>, pos[0], pos[1], pos[2], atom-&gt;<a class="code" href="structmolfile__atom__t.html#m1">type</a>, numbonds, lp, atom-&gt;<a class="code" href="structmolfile__atom__t.html#m11">charge</a>, atom-&gt;<a class="code" href="structmolfile__atom__t.html#m9">bfactor</a>, atom-&gt;<a class="code" href="structmolfile__atom__t.html#m8">occupancy</a>, atom-&gt;<a class="code" href="structmolfile__atom__t.html#m13">atomicnumber</a>, atom-&gt;<a class="code" href="structmolfile__atom__t.html#m4">segid</a>);
00514     ++atom; 
00515     pos += 3;
00516   }
00517 
00518   <font class="comment">//write the connectivity data</font>
00519   fprintf(data-&gt;<a class="code" href="structxbgfdata.html#m0">file</a>,<font class="stringliteral">"FORMAT CONECT (a6,14i6) \nFORMAT ORDER (a6,i6,13f6.3)\n"</font>);
00520     
00521   <font class="comment">//iterate through the bond arrays and write them all</font>
00522   <font class="keywordtype">int</font>* bonds=(<font class="keywordtype">int</font> *)malloc((data-&gt;<a class="code" href="structxbgfdata.html#m3">natoms</a>+1) * <font class="keyword">sizeof</font>(<font class="keywordtype">int</font>) * 6);
00523   <font class="keywordtype">float</font>* orders=(<font class="keywordtype">float</font> *)malloc((data-&gt;<a class="code" href="structxbgfdata.html#m3">natoms</a>+1)*<font class="keyword">sizeof</font>(<font class="keywordtype">float</font>) * 6);
00524   <font class="keywordtype">int</font>* numcons=(<font class="keywordtype">int</font> *)malloc((data-&gt;<a class="code" href="structxbgfdata.html#m3">natoms</a>+1)*<font class="keyword">sizeof</font>(<font class="keywordtype">int</font>));
00525   <font class="keywordflow">for</font> (i=0;i&lt;data-&gt;<a class="code" href="structxbgfdata.html#m3">natoms</a>+1;i++) {
00526     numcons[i]=0;
00527   }
00528 
00529   <font class="keywordtype">int</font> j,k; <font class="comment">//indices for atoms being bonded</font>
00530   <font class="keywordtype">float</font> o; <font class="comment">//bond order</font>
00531   <font class="keywordflow">for</font> (i=0;i&lt;data-&gt;<a class="code" href="structxbgfdata.html#m4">nbonds</a>;i++) {
00532     j=data-&gt;<a class="code" href="structxbgfdata.html#m7">from</a>[i];
00533     k=data-&gt;<a class="code" href="structxbgfdata.html#m8">to</a>[i];
00534     o=data-&gt;<a class="code" href="structxbgfdata.html#m9">bondorder</a>[i];
00535     numcons[j]++;
00536     numcons[k]++;
00537     <font class="keywordflow">if</font> (numcons[j]&gt;6) {
00538       printf(<font class="stringliteral">"xbgfplugin) Warning: Bond overflow. Not all bonds were written\n"</font>);
00539       numcons[j]--;
00540       numcons[k]--;
00541       <font class="keywordflow">continue</font>;
00542     }
00543        
00544     <font class="keywordflow">if</font> (numcons[k]&gt;6) {
00545       printf(<font class="stringliteral">"xbgfplugin) Warning: Bond overflow. Not all bonds were written\n"</font>);
00546       numcons[k]--;
00547       numcons[j]--;
00548       <font class="keywordflow">continue</font>;
00549     }
00550     bonds[6*j+numcons[j]-1]=k;
00551     bonds[6*k+numcons[k]-1]=j;
00552     orders[6*j+numcons[j]-1]=o;
00553     orders[6*k+numcons[k]-1]=o;
00554   }
00555 
00556   <font class="keywordflow">for</font> (i=1;i&lt;=data-&gt;<a class="code" href="structxbgfdata.html#m3">natoms</a>;i++) {
00557     fprintf(data-&gt;<a class="code" href="structxbgfdata.html#m0">file</a>,<font class="stringliteral">"CONECT%6i"</font>,i);
00558     <font class="keywordflow">for</font> (j=0;j&lt;numcons[i];j++) {
00559       fprintf(data-&gt;<a class="code" href="structxbgfdata.html#m0">file</a>,<font class="stringliteral">"%6i"</font>,bonds[6*i+j]);
00560     }
00561     fprintf(data-&gt;<a class="code" href="structxbgfdata.html#m0">file</a>,<font class="stringliteral">"\nORDER %6i"</font>,i);
00562     <font class="keywordflow">for</font> (j=0;j&lt;numcons[i];j++) {
00563       fprintf(data-&gt;<a class="code" href="structxbgfdata.html#m0">file</a>,<font class="stringliteral">"%6.3f"</font>,orders[6*i+j]);
00564     }
00565     fprintf(data-&gt;<a class="code" href="structxbgfdata.html#m0">file</a>,<font class="stringliteral">"\n"</font>);
00566   }
00567 
00568   free(bonds);
00569   free(orders);
00570   free(numcons);
00571 
00572   fprintf(data-&gt;<a class="code" href="structxbgfdata.html#m0">file</a>,<font class="stringliteral">"END\n"</font>);
00573   <font class="keywordflow">return</font> <a class="code" href="molfile__plugin_8h.html#a2">MOLFILE_SUCCESS</a>;
00574 }
00575 
<a name="l00576"></a><a class="code" href="xbgfplugin_8C.html#a13">00576</a> <font class="keyword">static</font> <font class="keywordtype">int</font> <a class="code" href="xbgfplugin_8C.html#a13">write_bonds</a>(<font class="keywordtype">void</font> *v, <font class="keywordtype">int</font> nbonds, <font class="keywordtype">int</font> *fromptr, <font class="keywordtype">int</font> *toptr, <font class="keywordtype">float</font> *bondorderptr) {
00577   <a class="code" href="structxbgfdata.html">xbgfdata</a> *data = (<a class="code" href="structxbgfdata.html">xbgfdata</a> *)v;
00578   data-&gt;<a class="code" href="structxbgfdata.html#m7">from</a> = <font class="keyword">new</font> <font class="keywordtype">int</font>[nbonds];
00579   data-&gt;<a class="code" href="structxbgfdata.html#m8">to</a> = <font class="keyword">new</font> <font class="keywordtype">int</font>[nbonds];
00580   data-&gt;<a class="code" href="structxbgfdata.html#m9">bondorder</a> = <font class="keyword">new</font> <font class="keywordtype">float</font>[nbonds];
00581 
00582   <font class="comment">//set the pointers for use later</font>
00583   <font class="keywordflow">for</font> (<font class="keywordtype">int</font> i=0;i&lt;nbonds;i++) {
00584     data-&gt;<a class="code" href="structxbgfdata.html#m7">from</a>[i]=fromptr[i];
00585     data-&gt;<a class="code" href="structxbgfdata.html#m8">to</a>[i]=toptr[i];
00586     data-&gt;<a class="code" href="structxbgfdata.html#m9">bondorder</a>[i]=bondorderptr[i];
00587   }
00588 
00589   data-&gt;<a class="code" href="structxbgfdata.html#m4">nbonds</a> = nbonds;
00590 
00591   <font class="keywordflow">return</font> <a class="code" href="molfile__plugin_8h.html#a2">MOLFILE_SUCCESS</a>;
00592 }
00593 
<a name="l00594"></a><a class="code" href="xbgfplugin_8C.html#a14">00594</a> <font class="keyword">static</font> <font class="keywordtype">void</font> <a class="code" href="xbgfplugin_8C.html#a14">close_bgf_write</a>(<font class="keywordtype">void</font> *mydata) {
00595   <a class="code" href="structxbgfdata.html">xbgfdata</a> *data = (<a class="code" href="structxbgfdata.html">xbgfdata</a> *)mydata;
00596   fclose(data-&gt;<a class="code" href="structxbgfdata.html#m0">file</a>);
00597 
00598   <font class="keywordflow">if</font> (data-&gt;<a class="code" href="structxbgfdata.html#m1">atomlist</a> != NULL) free(data-&gt;<a class="code" href="structxbgfdata.html#m1">atomlist</a>);
00599   <font class="keywordflow">if</font> (data-&gt;<a class="code" href="structxbgfdata.html#m7">from</a> != NULL) free(data-&gt;<a class="code" href="structxbgfdata.html#m7">from</a>);
00600   <font class="keywordflow">if</font> (data-&gt;<a class="code" href="structxbgfdata.html#m8">to</a> != NULL) free(data-&gt;<a class="code" href="structxbgfdata.html#m8">to</a>);
00601   <font class="keywordflow">if</font> (data-&gt;<a class="code" href="structxbgfdata.html#m9">bondorder</a> != NULL) free(data-&gt;<a class="code" href="structxbgfdata.html#m9">bondorder</a>);
00602   free(data);
00603 }
00604 
00605 <font class="comment">//</font>
00606 <font class="comment">// Free the memory used by the bgf structure</font>
<a name="l00607"></a><a class="code" href="xbgfplugin_8C.html#a15">00607</a> <font class="keyword">static</font> <font class="keywordtype">void</font> <a class="code" href="xbgfplugin_8C.html#a15">close_bgf_read</a>(<font class="keywordtype">void</font> *v) {
00608   <a class="code" href="structxbgfdata.html">xbgfdata</a> *bgf = (<a class="code" href="structxbgfdata.html">xbgfdata</a> *)v;
00609   <font class="keywordflow">if</font> (bgf) {
00610     <font class="keywordflow">if</font> (bgf-&gt;<a class="code" href="structxbgfdata.html#m0">file</a>) fclose(bgf-&gt;<a class="code" href="structxbgfdata.html#m0">file</a>);
00611     <font class="keywordflow">if</font> (bgf-&gt;<a class="code" href="structxbgfdata.html#m7">from</a> != NULL) free(bgf-&gt;<a class="code" href="structxbgfdata.html#m7">from</a>);
00612     <font class="keywordflow">if</font> (bgf-&gt;<a class="code" href="structxbgfdata.html#m8">to</a> != NULL)   free(bgf-&gt;<a class="code" href="structxbgfdata.html#m8">to</a>);
00613     <font class="keywordflow">if</font> (bgf-&gt;<a class="code" href="structxbgfdata.html#m9">bondorder</a> != NULL) free(bgf-&gt;<a class="code" href="structxbgfdata.html#m9">bondorder</a>);
00614 
00615 
00616     <font class="keywordflow">if</font> (bgf-&gt;<a class="code" href="structxbgfdata.html#m2">meta</a>-&gt;<a class="code" href="structmolfile__metadata__t.html#m5">remarks</a> != NULL)
00617       free(bgf-&gt;<a class="code" href="structxbgfdata.html#m2">meta</a>-&gt;<a class="code" href="structmolfile__metadata__t.html#m5">remarks</a>);
00618     <font class="keywordflow">if</font> (bgf-&gt;<a class="code" href="structxbgfdata.html#m2">meta</a> != NULL) 
00619       free(bgf-&gt;<a class="code" href="structxbgfdata.html#m2">meta</a>);
00620     <font class="keyword">delete</font> bgf;
00621   }
00622 }
00623 
00624 
<a name="l00625"></a><a class="code" href="xbgfplugin_8C.html#a16">00625</a> <font class="keyword">static</font> <font class="keywordtype">int</font> <a class="code" href="xbgfplugin_8C.html#a16">read_molecule_metadata</a>(<font class="keywordtype">void</font> *v, <a class="code" href="structmolfile__metadata__t.html">molfile_metadata_t</a> **metadata) {
00626   <a class="code" href="structxbgfdata.html">xbgfdata</a> *bgf = (<a class="code" href="structxbgfdata.html">xbgfdata</a> *)v; 
00627   *metadata = bgf-&gt;<a class="code" href="structxbgfdata.html#m2">meta</a>;
00628   <font class="keywordflow">return</font> <a class="code" href="molfile__plugin_8h.html#a2">MOLFILE_SUCCESS</a>;
00629 }
00630 
00631 
<a name="l00632"></a><a class="code" href="xbgfplugin_8C.html#a1">00632</a> <font class="keyword">static</font> <a class="code" href="structmolfile__plugin__t.html">molfile_plugin_t</a> <a class="code" href="xbgfplugin_8C.html#a1">bgfplugin</a> = {
00633   <a class="code" href="vmdplugin_8h.html#a10">vmdplugin_ABIVERSION</a>,
00634   <a class="code" href="molfile__plugin_8h.html#a0">MOLFILE_PLUGIN_TYPE</a>,                      
00635   <font class="stringliteral">"xbgf"</font>,                                    
00636   <font class="stringliteral">"Internal Paratool Format"</font>,
00637   <font class="stringliteral">"Peter Freddolino "</font>,    
00638   0,                                        
00639   6,                                        
00640   <a class="code" href="vmdplugin_8h.html#a12">VMDPLUGIN_THREADSAFE</a>,                     
00641   <font class="stringliteral">"xbgf"</font>,
00642   <a class="code" href="xbgfplugin_8C.html#a2">open_bgf_read</a>,
00643   <a class="code" href="xbgfplugin_8C.html#a6">read_bgf_structure</a>,
00644   <a class="code" href="xbgfplugin_8C.html#a11">read_bonds</a>,
00645   <a class="code" href="xbgfplugin_8C.html#a7">read_bgf_timestep</a>,
00646   <a class="code" href="xbgfplugin_8C.html#a15">close_bgf_read</a>,
00647   <a class="code" href="xbgfplugin_8C.html#a8">open_bgf_write</a>,
00648   <a class="code" href="xbgfplugin_8C.html#a9">write_bgf_structure</a>,
00649   <a class="code" href="xbgfplugin_8C.html#a12">write_bgf_timestep</a>,
00650   <a class="code" href="xbgfplugin_8C.html#a14">close_bgf_write</a>,
00651   0,                            
00652   0,                            
00653   0,
00654   <a class="code" href="xbgfplugin_8C.html#a16">read_molecule_metadata</a>,
00655   <a class="code" href="xbgfplugin_8C.html#a13">write_bonds</a>  
00656 };
00657 
<a name="l00658"></a><a class="code" href="xbgfplugin_8C.html#a17">00658</a> <a class="code" href="vmdplugin_8h.html#a7">VMDPLUGIN_API</a> <font class="keywordtype">int</font> <a class="code" href="vmdplugin_8h.html#a5">VMDPLUGIN_init</a>() {
00659   <font class="keywordflow">return</font> <a class="code" href="vmdplugin_8h.html#a13">VMDPLUGIN_SUCCESS</a>;
00660 }
00661 
<a name="l00662"></a><a class="code" href="xbgfplugin_8C.html#a18">00662</a> <a class="code" href="vmdplugin_8h.html#a7">VMDPLUGIN_API</a> <font class="keywordtype">int</font> <a class="code" href="vmdplugin_8h.html#a3">VMDPLUGIN_register</a>(<font class="keywordtype">void</font> *v, <a class="code" href="vmdplugin_8h.html#a15">vmdplugin_register_cb</a> cb) {
00663   (*cb)(v, (<a class="code" href="structvmdplugin__t.html">vmdplugin_t</a> *)&amp;bgfplugin);
00664   <font class="keywordflow">return</font> <a class="code" href="vmdplugin_8h.html#a13">VMDPLUGIN_SUCCESS</a>;
00665 }
00666 
<a name="l00667"></a><a class="code" href="xbgfplugin_8C.html#a19">00667</a> <a class="code" href="vmdplugin_8h.html#a7">VMDPLUGIN_API</a> <font class="keywordtype">int</font> <a class="code" href="vmdplugin_8h.html#a6">VMDPLUGIN_fini</a>() {
00668   <font class="keywordflow">return</font> <a class="code" href="vmdplugin_8h.html#a13">VMDPLUGIN_SUCCESS</a>;
00669 }
00670 
00671 
</pre></div><hr><address><small>Generated on Wed Mar 22 13:15:32 2006 for VMD Plugins (current) by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.gif" alt="doxygen" align="middle" border=0 
width=110 height=53></a>1.2.14 written by <a href="mailto:dimitri@stack.nl">Dimitri van Heesch</a>,
 &copy;&nbsp;1997-2002</small></address>
</body>
</html>
