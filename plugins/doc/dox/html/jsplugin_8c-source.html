<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>jsplugin.c Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.2.14 -->
<center>
<a class="qindex" href="index.html">Main Page</a> &nbsp; <a class="qindex" href="classes.html">Alphabetical List</a> &nbsp; <a class="qindex" href="annotated.html">Compound List</a> &nbsp; <a class="qindex" href="files.html">File List</a> &nbsp; <a class="qindex" href="functions.html">Compound Members</a> &nbsp; <a class="qindex" href="globals.html">File Members</a> &nbsp; <a class="qindex" href="pages.html">Related Pages</a> &nbsp; </center>
<hr><h1>jsplugin.c</h1><a href="jsplugin_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 <font class="comment">/***************************************************************************</font>
00002 <font class="comment"> *cr                                                                       </font>
00003 <font class="comment"> *cr            (C) Copyright 1995-2006 The Board of Trustees of the           </font>
00004 <font class="comment"> *cr                        University of Illinois                       </font>
00005 <font class="comment"> *cr                         All Rights Reserved                        </font>
00006 <font class="comment"> *cr                                                                   </font>
00007 <font class="comment"> ***************************************************************************/</font>
00008 
00009 <font class="comment">/***************************************************************************</font>
00010 <font class="comment"> * RCS INFORMATION:</font>
00011 <font class="comment"> *</font>
00012 <font class="comment"> *      $RCSfile: jsplugin.c,v $</font>
00013 <font class="comment"> *      $Author: johns $       $Locker:  $             $State: Exp $</font>
00014 <font class="comment"> *      $Revision: 1.10 $       $Date: 2006/02/23 19:36:45 $</font>
00015 <font class="comment"> *</font>
00016 <font class="comment"> ***************************************************************************</font>
00017 <font class="comment"> * DESCRIPTION:</font>
00018 <font class="comment"> *   Code for reading and writing John's molecular dynamics trajectory files</font>
00019 <font class="comment"> *   for I/O performance testing and as a simple example plugin.</font>
00020 <font class="comment"> *</font>
00021 <font class="comment"> *   No programs actually use this format, so it's only a test/example code.</font>
00022 <font class="comment"> *</font>
00023 <font class="comment"> *   This plugin reads and writes mostly the same data that a DCD file </font>
00024 <font class="comment"> *   contains, but the ordering of I/O operations avoids having to do</font>
00025 <font class="comment"> *   scatter/gather passes on the buffers, so it ends up performing </font>
00026 <font class="comment"> *   two to three times faster than the DCD format for the same data set.</font>
00027 <font class="comment"> *</font>
00028 <font class="comment"> *   Best measured I/O performance in VMD so far is 631 MB/sec on a Sun V880z </font>
00029 <font class="comment"> *   Best standalone I/O performance so far is 688 MB/sec.</font>
00030 <font class="comment"> *</font>
00031 <font class="comment"> *  Standalone test binary compilation flags:</font>
00032 <font class="comment"> *  cc -fast -xarch=v9a -I../../include -DTEST_JSPLUGIN jsplugin.c \</font>
00033 <font class="comment"> *    -o ~/bin/readjs -lm</font>
00034 <font class="comment"> *</font>
00035 <font class="comment"> *  Profiling flags:</font>
00036 <font class="comment"> *  cc -xpg -fast -xarch=v9a -g -I../../include -DTEST_JSPLUGIN jsplugin.c \</font>
00037 <font class="comment"> *    -o ~/bin/readjs -lm</font>
00038 <font class="comment"> *</font>
00039 <font class="comment"> ***************************************************************************/</font>
00040 
00041 <font class="preprocessor">#include "<a class="code" href="largefiles_8h.html">largefiles.h</a>"</font>   <font class="comment">/* platform dependent 64-bit file I/O defines */</font>
00042 
00043 <font class="preprocessor">#include &lt;sys/stat.h&gt;</font>
00044 <font class="preprocessor">#include &lt;sys/types.h&gt;</font>
00045 <font class="preprocessor">#include &lt;stdio.h&gt;</font>
00046 <font class="preprocessor">#include &lt;stdlib.h&gt;</font>
00047 <font class="preprocessor">#include &lt;string.h&gt;</font>
00048 <font class="preprocessor">#include &lt;math.h&gt;</font>
00049 
00050 <font class="preprocessor">#include "<a class="code" href="fastio_8h.html">fastio.h</a>"</font>
00051 <font class="preprocessor">#include "<a class="code" href="endianswap_8h.html">endianswap.h</a>"</font>
00052 
00053 <font class="preprocessor">#include "<a class="code" href="molfile__plugin_8h.html">molfile_plugin.h</a>"</font>
00054 
00055 <font class="preprocessor">#ifndef M_PI_2</font>
<a name="l00056"></a><a class="code" href="jsplugin_8c.html#a0">00056</a> <font class="preprocessor"></font><font class="preprocessor">#define M_PI_2 1.57079632679489661922</font>
00057 <font class="preprocessor"></font><font class="preprocessor">#endif</font>
00058 <font class="preprocessor"></font>
<a name="l00059"></a><a class="code" href="jsplugin_8c.html#a1">00059</a> <font class="preprocessor">#define JSHEADERSTRING   "JS Binary Trajectory File Format"                </font>
<a name="l00060"></a><a class="code" href="jsplugin_8c.html#a2">00060</a> <font class="preprocessor"></font><font class="preprocessor">#define JSMAGICNUMBER    0x31337</font>
<a name="l00061"></a><a class="code" href="jsplugin_8c.html#a3">00061</a> <font class="preprocessor"></font><font class="preprocessor">#define JSENDIANISM      0x12345678</font>
<a name="l00062"></a><a class="code" href="jsplugin_8c.html#a4">00062</a> <font class="preprocessor"></font><font class="preprocessor">#define JSMAJORVERSION   1</font>
<a name="l00063"></a><a class="code" href="jsplugin_8c.html#a5">00063</a> <font class="preprocessor"></font><font class="preprocessor">#define JSMINORVERSION   0</font>
00064 <font class="preprocessor"></font>
<a name="l00065"></a><a class="code" href="jsplugin_8c.html#a6">00065</a> <font class="preprocessor">#define JSNFRAMESOFFSET  (strlen(JSHEADERSTRING) + 20)</font>
00066 <font class="preprocessor"></font>
<a name="l00067"></a><a class="code" href="jsplugin_8c.html#a7">00067</a> <font class="preprocessor">#define JSNOERR          0</font>
<a name="l00068"></a><a class="code" href="jsplugin_8c.html#a8">00068</a> <font class="preprocessor"></font><font class="preprocessor">#define JSBADFILE        1</font>
<a name="l00069"></a><a class="code" href="jsplugin_8c.html#a9">00069</a> <font class="preprocessor"></font><font class="preprocessor">#define JSBADFORMAT      2</font>
00070 <font class="preprocessor"></font>
<a name="l00071"></a><a class="code" href="structjshandle.html">00071</a> <font class="keyword">typedef</font> <font class="keyword">struct </font>{
<a name="l00072"></a><a class="code" href="structjshandle.html#m0">00072</a>   <a class="code" href="fastio_8h.html#a5">fio_fd</a> fd;
<a name="l00073"></a><a class="code" href="structjshandle.html#m1">00073</a>   <font class="keywordtype">int</font> natoms;
<a name="l00074"></a><a class="code" href="structjshandle.html#m2">00074</a>   <font class="keywordtype">int</font> nframes;
<a name="l00075"></a><a class="code" href="structjshandle.html#m3">00075</a>   <font class="keywordtype">double</font> tsdelta;
<a name="l00076"></a><a class="code" href="structjshandle.html#m4">00076</a>   <font class="keywordtype">int</font> reverse;
<a name="l00077"></a><a class="code" href="structjshandle.html#m5">00077</a>   <font class="keywordtype">int</font> with_unitcell;
00078 } <a class="code" href="structjshandle.html">jshandle</a>;
00079 
<a name="l00080"></a><a class="code" href="jsplugin_8c.html#a11">00080</a> <font class="keyword">static</font> <font class="keywordtype">void</font> *<a class="code" href="jsplugin_8c.html#a11">open_js_read</a>(<font class="keyword">const</font> <font class="keywordtype">char</font> *path, <font class="keyword">const</font> <font class="keywordtype">char</font> *filetype, <font class="keywordtype">int</font> *natoms) {
00081   <a class="code" href="structjshandle.html">jshandle</a> *js;
00082   <font class="keywordtype">int</font> jsmagicnumber, jsendianism, jsmajorversion, jsminorversion;
00083   <font class="keyword">struct </font>stat stbuf;
00084   <font class="keywordtype">char</font> strbuf[1024];
00085   <font class="keywordtype">int</font> rc = 0;
00086 
00087   <font class="keywordflow">if</font> (!path) <font class="keywordflow">return</font> NULL;
00088 
00089   <font class="comment">/* See if the file exists, and get its size */</font>
00090   memset(&amp;stbuf, 0, <font class="keyword">sizeof</font>(<font class="keyword">struct</font> stat));
00091   <font class="keywordflow">if</font> (stat(path, &amp;stbuf)) {
00092     fprintf(stderr, <font class="stringliteral">"Could not access file '%s'.\n"</font>, path);
00093     <font class="keywordflow">return</font> NULL;
00094   }
00095 
00096   js = (<a class="code" href="structjshandle.html">jshandle</a> *)malloc(<font class="keyword">sizeof</font>(<a class="code" href="structjshandle.html">jshandle</a>));
00097   memset(js, 0, <font class="keyword">sizeof</font>(<a class="code" href="structjshandle.html">jshandle</a>));
00098   <font class="keywordflow">if</font> (<a class="code" href="fastio_8h.html#a8">fio_open</a>(path, <a class="code" href="fastio_8h.html#a0">FIO_READ</a>, &amp;js-&gt;<a class="code" href="structjshandle.html#m0">fd</a>) &lt; 0) {
00099     fprintf(stderr, <font class="stringliteral">"Could not open file '%s' for reading.\n"</font>, path);
00100     free(js);
00101     <font class="keywordflow">return</font> NULL;
00102   }
00103 
00104   <font class="comment">/* emit header information */</font>
00105   <a class="code" href="fastio_8h.html#a10">fio_fread</a>(strbuf, strlen(<a class="code" href="jsplugin_8c.html#a1">JSHEADERSTRING</a>), 1, js-&gt;<a class="code" href="structjshandle.html#m0">fd</a>);
00106   strbuf[strlen(<a class="code" href="jsplugin_8c.html#a1">JSHEADERSTRING</a>)] = <font class="charliteral">'\0'</font>;
00107   <font class="keywordflow">if</font> (strcmp(strbuf, <a class="code" href="jsplugin_8c.html#a1">JSHEADERSTRING</a>)) {
00108     fprintf(stderr, <font class="stringliteral">"Bad trajectory header!\n"</font>);
00109     fprintf(stderr, <font class="stringliteral">"Read string: %s\n"</font>, strbuf);
00110     <font class="keywordflow">return</font> NULL;
00111   }
00112 
00113   <a class="code" href="fastio_8h.html#a16">fio_read_int32</a>(js-&gt;<a class="code" href="structjshandle.html#m0">fd</a>, &amp;jsmagicnumber);
00114   <a class="code" href="fastio_8h.html#a16">fio_read_int32</a>(js-&gt;<a class="code" href="structjshandle.html#m0">fd</a>, &amp;jsendianism);
00115   <a class="code" href="fastio_8h.html#a16">fio_read_int32</a>(js-&gt;<a class="code" href="structjshandle.html#m0">fd</a>, &amp;jsmajorversion);
00116   <a class="code" href="fastio_8h.html#a16">fio_read_int32</a>(js-&gt;<a class="code" href="structjshandle.html#m0">fd</a>, &amp;jsminorversion);
00117   <a class="code" href="fastio_8h.html#a16">fio_read_int32</a>(js-&gt;<a class="code" href="structjshandle.html#m0">fd</a>, &amp;js-&gt;<a class="code" href="structjshandle.html#m1">natoms</a>);
00118   <a class="code" href="fastio_8h.html#a16">fio_read_int32</a>(js-&gt;<a class="code" href="structjshandle.html#m0">fd</a>, &amp;js-&gt;<a class="code" href="structjshandle.html#m2">nframes</a>);
00119 
00120   <font class="keywordflow">if</font> ((jsmagicnumber != <a class="code" href="jsplugin_8c.html#a2">JSMAGICNUMBER</a>) || (jsendianism != <a class="code" href="jsplugin_8c.html#a3">JSENDIANISM</a>)) {
00121     fprintf(stderr, <font class="stringliteral">"Opposite endianism trajectory file, enabling byte swapping\n"</font>);
00122     js-&gt;<a class="code" href="structjshandle.html#m4">reverse</a> = 1;
00123     <a class="code" href="endianswap_8h.html#a4">swap4_aligned</a>(&amp;jsmagicnumber, 1);
00124     <a class="code" href="endianswap_8h.html#a4">swap4_aligned</a>(&amp;jsendianism, 1);
00125     <a class="code" href="endianswap_8h.html#a4">swap4_aligned</a>(&amp;jsmajorversion, 1);
00126     <a class="code" href="endianswap_8h.html#a4">swap4_aligned</a>(&amp;jsminorversion, 1);
00127     <a class="code" href="endianswap_8h.html#a4">swap4_aligned</a>(&amp;js-&gt;<a class="code" href="structjshandle.html#m1">natoms</a>, 1);
00128     <a class="code" href="endianswap_8h.html#a4">swap4_aligned</a>(&amp;js-&gt;<a class="code" href="structjshandle.html#m2">nframes</a>, 1);
00129   }
00130 
00131   <font class="keywordflow">if</font> ((jsmagicnumber != <a class="code" href="jsplugin_8c.html#a2">JSMAGICNUMBER</a>) || (jsendianism != <a class="code" href="jsplugin_8c.html#a3">JSENDIANISM</a>)) {
00132     fprintf(stderr, <font class="stringliteral">"read_jsreader returned %d\n"</font>, rc);
00133     <a class="code" href="fastio_8h.html#a9">fio_fclose</a>(js-&gt;<a class="code" href="structjshandle.html#m0">fd</a>);
00134     free(js);
00135     <font class="keywordflow">return</font> NULL;
00136   }
00137 
00138   *natoms = js-&gt;<a class="code" href="structjshandle.html#m1">natoms</a>;
00139   <font class="keywordflow">return</font> js;
00140 }
00141 
00142 
<a name="l00143"></a><a class="code" href="jsplugin_8c.html#a12">00143</a> <font class="keyword">static</font> <font class="keywordtype">int</font> <a class="code" href="jsplugin_8c.html#a12">read_js_timestep</a>(<font class="keywordtype">void</font> *v, <font class="keywordtype">int</font> natoms, <a class="code" href="structmolfile__timestep__t.html">molfile_timestep_t</a> *ts) {
00144   <a class="code" href="structjshandle.html">jshandle</a> *js = (<a class="code" href="structjshandle.html">jshandle</a> *)v;
00145   <font class="keywordtype">int</font> framelen = (natoms * 3 * <font class="keyword">sizeof</font>(float)) + (6 * <font class="keyword">sizeof</font>(double));;
00146 
00147   <font class="comment">/* if we have a valid ts pointer, read the timestep, otherwise skip it */</font> 
00148   <font class="keywordflow">if</font> (ts != NULL) {
00149     <font class="keywordtype">int</font> readlen; 
00150     <a class="code" href="structfio__iovec.html">fio_iovec</a> iov[2];
00151     <font class="keywordtype">double</font> unitcell[6];
00152     unitcell[0] = unitcell[2] = unitcell[5] = 1.0f;
00153     unitcell[1] = unitcell[3] = unitcell[4] = 90.0f;
00154   
00155     <font class="comment">/* setup the I/O vector */</font>
00156     iov[0].<a class="code" href="structfio__iovec.html#m0">iov_base</a> = (fio_caddr_t) ts-&gt;<a class="code" href="structmolfile__timestep__t.html#m0">coords</a>;   <font class="comment">/* read coordinates    */</font>
00157     iov[0].<a class="code" href="structfio__iovec.html#m1">iov_len</a>  = natoms * 3 * <font class="keyword">sizeof</font>(float);
00158     iov[1].<a class="code" href="structfio__iovec.html#m0">iov_base</a> = (fio_caddr_t) &amp;unitcell[0]; <font class="comment">/* read PBC unit cell  */</font>
00159     iov[1].<a class="code" href="structfio__iovec.html#m1">iov_len</a>  = 6 * <font class="keyword">sizeof</font>(double);
00160 
00161     <font class="comment">/* Do all of the reads with a single syscall, for peak efficiency. */</font>
00162     <font class="comment">/* On smart kernels, readv() causes only one context switch, and   */</font>
00163     <font class="comment">/* can effeciently scatter the reads to the various buffers.       */</font>
00164     readlen = <a class="code" href="fastio_8h.html#a11">fio_readv</a>(js-&gt;<a class="code" href="structjshandle.html#m0">fd</a>, &amp;iov[0], 2); 
00165   
00166     <font class="comment">/* check the number of read bytes versus what we expected */</font>
00167     <font class="keywordflow">if</font> (readlen != framelen)
00168       <font class="keywordflow">return</font> <a class="code" href="molfile__plugin_8h.html#a3">MOLFILE_EOF</a>;
00169 
00170     <font class="comment">/* perform byte swapping if necessary */</font>
00171     <font class="keywordflow">if</font> (js-&gt;<a class="code" href="structjshandle.html#m4">reverse</a>) {
00172       <a class="code" href="endianswap_8h.html#a4">swap4_aligned</a>(ts-&gt;<a class="code" href="structmolfile__timestep__t.html#m0">coords</a>, natoms * 3);
00173       <a class="code" href="endianswap_8h.html#a5">swap8_aligned</a>(unitcell, 6);
00174     }
00175 
00176     <font class="comment">/* copy unit cell values into VMD */</font>
00177     ts-&gt;<a class="code" href="structmolfile__timestep__t.html#z4_0">A</a> = unitcell[0];
00178     ts-&gt;<a class="code" href="structmolfile__timestep__t.html#z4_1">B</a> = unitcell[1];
00179     ts-&gt;<a class="code" href="structmolfile__timestep__t.html#z4_2">C</a> = unitcell[2];
00180     ts-&gt;<a class="code" href="structmolfile__timestep__t.html#z4_3">alpha</a> = 90.0 - asin(unitcell[3]) * 90.0 / <a class="code" href="jsplugin_8c.html#a0">M_PI_2</a>;
00181     ts-&gt;<a class="code" href="structmolfile__timestep__t.html#z4_4">beta</a>  = 90.0 - asin(unitcell[4]) * 90.0 / <a class="code" href="jsplugin_8c.html#a0">M_PI_2</a>;
00182     ts-&gt;<a class="code" href="structmolfile__timestep__t.html#z4_5">gamma</a> = 90.0 - asin(unitcell[5]) * 90.0 / <a class="code" href="jsplugin_8c.html#a0">M_PI_2</a>;
00183   } <font class="keywordflow">else</font> {
00184     <font class="comment">/* skip this frame, seek to the next frame */</font>
00185     <font class="keywordflow">if</font> (<a class="code" href="fastio_8h.html#a13">fio_fseek</a>(js-&gt;<a class="code" href="structjshandle.html#m0">fd</a>, framelen, <a class="code" href="fastio_8h.html#a2">FIO_SEEK_CUR</a>)) 
00186       <font class="keywordflow">return</font> <a class="code" href="molfile__plugin_8h.html#a3">MOLFILE_EOF</a>;
00187   }
00188  
00189   <font class="keywordflow">return</font> <a class="code" href="molfile__plugin_8h.html#a2">MOLFILE_SUCCESS</a>;
00190 }
00191  
00192 
<a name="l00193"></a><a class="code" href="jsplugin_8c.html#a13">00193</a> <font class="keyword">static</font> <font class="keywordtype">void</font> <a class="code" href="jsplugin_8c.html#a13">close_js_read</a>(<font class="keywordtype">void</font> *v) {
00194   <a class="code" href="structjshandle.html">jshandle</a> *js = (<a class="code" href="structjshandle.html">jshandle</a> *)v;
00195   <a class="code" href="fastio_8h.html#a9">fio_fclose</a>(js-&gt;<a class="code" href="structjshandle.html#m0">fd</a>);
00196   free(js); 
00197 }
00198 
00199 
<a name="l00200"></a><a class="code" href="jsplugin_8c.html#a14">00200</a> <font class="keyword">static</font> <font class="keywordtype">void</font> *<a class="code" href="jsplugin_8c.html#a14">open_js_write</a>(<font class="keyword">const</font> <font class="keywordtype">char</font> *path, <font class="keyword">const</font> <font class="keywordtype">char</font> *filetype, <font class="keywordtype">int</font> natoms) {
00201   <a class="code" href="structjshandle.html">jshandle</a> *js;
00202 
00203   js = (<a class="code" href="structjshandle.html">jshandle</a> *)malloc(<font class="keyword">sizeof</font>(<a class="code" href="structjshandle.html">jshandle</a>));
00204   memset(js, 0, <font class="keyword">sizeof</font>(<a class="code" href="structjshandle.html">jshandle</a>));
00205   <font class="keywordflow">if</font> (<a class="code" href="fastio_8h.html#a8">fio_open</a>(path, <a class="code" href="fastio_8h.html#a1">FIO_WRITE</a>, &amp;js-&gt;<a class="code" href="structjshandle.html#m0">fd</a>) &lt; 0) {
00206     fprintf(stderr, <font class="stringliteral">"Could not open file %s for writing\n"</font>, path);
00207     free(js);
00208     <font class="keywordflow">return</font> NULL;
00209   }
00210 
00211   js-&gt;<a class="code" href="structjshandle.html#m1">natoms</a> = natoms;
00212   js-&gt;<a class="code" href="structjshandle.html#m5">with_unitcell</a> = 1;
00213 
00214   <font class="comment">/* emit header information */</font>
00215   <a class="code" href="fastio_8h.html#a17">fio_write_str</a>(js-&gt;<a class="code" href="structjshandle.html#m0">fd</a>, <a class="code" href="jsplugin_8c.html#a1">JSHEADERSTRING</a>);
00216   <a class="code" href="fastio_8h.html#a15">fio_write_int32</a>(js-&gt;<a class="code" href="structjshandle.html#m0">fd</a>, <a class="code" href="jsplugin_8c.html#a2">JSMAGICNUMBER</a>);
00217   <a class="code" href="fastio_8h.html#a15">fio_write_int32</a>(js-&gt;<a class="code" href="structjshandle.html#m0">fd</a>, <a class="code" href="jsplugin_8c.html#a3">JSENDIANISM</a>);
00218   <a class="code" href="fastio_8h.html#a15">fio_write_int32</a>(js-&gt;<a class="code" href="structjshandle.html#m0">fd</a>, <a class="code" href="jsplugin_8c.html#a4">JSMAJORVERSION</a>);
00219   <a class="code" href="fastio_8h.html#a15">fio_write_int32</a>(js-&gt;<a class="code" href="structjshandle.html#m0">fd</a>, <a class="code" href="jsplugin_8c.html#a5">JSMINORVERSION</a>);
00220 
00221   <font class="comment">/* write number of atoms */</font>
00222   <a class="code" href="fastio_8h.html#a15">fio_write_int32</a>(js-&gt;<a class="code" href="structjshandle.html#m0">fd</a>, natoms);
00223 
00224   <font class="comment">/* write number of frames, to be updated later */</font>
00225   js-&gt;<a class="code" href="structjshandle.html#m2">nframes</a> = 0;
00226   <a class="code" href="fastio_8h.html#a15">fio_write_int32</a>(js-&gt;<a class="code" href="structjshandle.html#m0">fd</a>, js-&gt;<a class="code" href="structjshandle.html#m2">nframes</a>);
00227 
00228   <font class="keywordflow">return</font> js;
00229 }
00230 
<a name="l00231"></a><a class="code" href="jsplugin_8c.html#a15">00231</a> <font class="keyword">static</font> <font class="keywordtype">int</font> <a class="code" href="jsplugin_8c.html#a15">write_js_timestep</a>(<font class="keywordtype">void</font> *v, <font class="keyword">const</font> <a class="code" href="structmolfile__timestep__t.html">molfile_timestep_t</a> *ts) { 
00232   <a class="code" href="structjshandle.html">jshandle</a> *js = (<a class="code" href="structjshandle.html">jshandle</a> *)v;
00233   <font class="keywordtype">double</font> unitcell[6];
00234 
00235   js-&gt;<a class="code" href="structjshandle.html#m2">nframes</a>++; <font class="comment">/* increment frame count written to the file so far */</font>
00236 
00237   unitcell[0] = ts-&gt;<a class="code" href="structmolfile__timestep__t.html#z4_0">A</a>;
00238   unitcell[1] = ts-&gt;<a class="code" href="structmolfile__timestep__t.html#z4_1">B</a>;
00239   unitcell[2] = ts-&gt;<a class="code" href="structmolfile__timestep__t.html#z4_2">C</a>;
00240   unitcell[3] = sin((<a class="code" href="jsplugin_8c.html#a0">M_PI_2</a> / 90.0) * (90.0 - ts-&gt;<a class="code" href="structmolfile__timestep__t.html#z4_3">alpha</a>));
00241   unitcell[4] = sin((<a class="code" href="jsplugin_8c.html#a0">M_PI_2</a> / 90.0) * (90.0 - ts-&gt;<a class="code" href="structmolfile__timestep__t.html#z4_4">beta</a>));
00242   unitcell[5] = sin((<a class="code" href="jsplugin_8c.html#a0">M_PI_2</a> / 90.0) * (90.0 - ts-&gt;<a class="code" href="structmolfile__timestep__t.html#z4_5">gamma</a>));
00243 
00244   <font class="comment">/* coordinates for all atoms */</font>
00245   <a class="code" href="fastio_8h.html#a12">fio_fwrite</a>(ts-&gt;<a class="code" href="structmolfile__timestep__t.html#m0">coords</a>, js-&gt;<a class="code" href="structjshandle.html#m1">natoms</a> * 3 * <font class="keyword">sizeof</font>(<font class="keywordtype">float</font>), 1, js-&gt;<a class="code" href="structjshandle.html#m0">fd</a>);
00246 
00247   <font class="comment">/* PBC unit cell info */</font> 
00248   <a class="code" href="fastio_8h.html#a12">fio_fwrite</a>(&amp;unitcell[0], 6 * <font class="keyword">sizeof</font>(<font class="keywordtype">double</font>), 1, js-&gt;<a class="code" href="structjshandle.html#m0">fd</a>);
00249 
00250   <font class="keywordflow">return</font> <a class="code" href="molfile__plugin_8h.html#a2">MOLFILE_SUCCESS</a>;
00251 }
00252 
<a name="l00253"></a><a class="code" href="jsplugin_8c.html#a16">00253</a> <font class="keyword">static</font> <font class="keywordtype">void</font> <a class="code" href="jsplugin_8c.html#a16">close_js_write</a>(<font class="keywordtype">void</font> *v) {
00254   <a class="code" href="structjshandle.html">jshandle</a> *js = (<a class="code" href="structjshandle.html">jshandle</a> *)v;
00255 
00256   <font class="comment">/* update the trajectory header information */</font>
00257   <a class="code" href="fastio_8h.html#a13">fio_fseek</a>(js-&gt;<a class="code" href="structjshandle.html#m0">fd</a>, <a class="code" href="jsplugin_8c.html#a6">JSNFRAMESOFFSET</a>, <a class="code" href="fastio_8h.html#a3">FIO_SEEK_SET</a>);
00258   <a class="code" href="fastio_8h.html#a15">fio_write_int32</a>(js-&gt;<a class="code" href="structjshandle.html#m0">fd</a>, js-&gt;<a class="code" href="structjshandle.html#m2">nframes</a>);
00259   <a class="code" href="fastio_8h.html#a13">fio_fseek</a>(js-&gt;<a class="code" href="structjshandle.html#m0">fd</a>, 0, <a class="code" href="fastio_8h.html#a4">FIO_SEEK_END</a>);
00260 
00261   <a class="code" href="fastio_8h.html#a9">fio_fclose</a>(js-&gt;<a class="code" href="structjshandle.html#m0">fd</a>);
00262   free(js);
00263 }
00264 
00265 
00266 <font class="comment">/*</font>
00267 <font class="comment"> * Initialization stuff here</font>
00268 <font class="comment"> */</font>
<a name="l00269"></a><a class="code" href="jsplugin_8c.html#a10">00269</a> <font class="keyword">static</font> <a class="code" href="structmolfile__plugin__t.html">molfile_plugin_t</a> <a class="code" href="jsplugin_8c.html#a10">jsplugin</a> = {
00270   <a class="code" href="vmdplugin_8h.html#a10">vmdplugin_ABIVERSION</a>,                         <font class="comment">/* ABI version */</font>
00271   <a class="code" href="molfile__plugin_8h.html#a0">MOLFILE_PLUGIN_TYPE</a>,                          <font class="comment">/* type */</font>
00272   <font class="stringliteral">"js"</font>,                                         <font class="comment">/* name */</font>
00273   <font class="stringliteral">"js"</font>,                                         <font class="comment">/* name */</font>
00274   <font class="stringliteral">"John Stone"</font>,                                 <font class="comment">/* author */</font>
00275   0,                                            <font class="comment">/* major version */</font>
00276   8,                                            <font class="comment">/* minor version */</font>
00277   <a class="code" href="vmdplugin_8h.html#a12">VMDPLUGIN_THREADSAFE</a>,                         <font class="comment">/* is reentrant  */</font>
00278   <font class="stringliteral">"js"</font>,                                         <font class="comment">/* filename extension */</font>
00279   <a class="code" href="jsplugin_8c.html#a11">open_js_read</a>,
00280   0,
00281   0,
00282   <a class="code" href="jsplugin_8c.html#a12">read_js_timestep</a>,
00283   <a class="code" href="jsplugin_8c.html#a13">close_js_read</a>,
00284   <a class="code" href="jsplugin_8c.html#a14">open_js_write</a>,
00285   0,
00286   <a class="code" href="jsplugin_8c.html#a15">write_js_timestep</a>,
00287   <a class="code" href="jsplugin_8c.html#a16">close_js_write</a>,
00288   0,                            <font class="comment">/* read_volumetric_metadata */</font>
00289   0,                            <font class="comment">/* read_volumetric_data */</font>
00290   0                             <font class="comment">/* read_rawgraphics */</font>
00291 };
00292 
<a name="l00293"></a><a class="code" href="jsplugin_8c.html#a17">00293</a> <a class="code" href="vmdplugin_8h.html#a7">VMDPLUGIN_API</a> <font class="keywordtype">int</font> <a class="code" href="vmdplugin_8h.html#a5">VMDPLUGIN_init</a>() {
00294   <font class="keywordflow">return</font> <a class="code" href="vmdplugin_8h.html#a13">VMDPLUGIN_SUCCESS</a>;
00295 }
00296 
<a name="l00297"></a><a class="code" href="jsplugin_8c.html#a18">00297</a> <a class="code" href="vmdplugin_8h.html#a7">VMDPLUGIN_API</a> <font class="keywordtype">int</font> <a class="code" href="vmdplugin_8h.html#a3">VMDPLUGIN_register</a>(<font class="keywordtype">void</font> *v, <a class="code" href="vmdplugin_8h.html#a15">vmdplugin_register_cb</a> cb) {
00298   (*cb)(v, (<a class="code" href="structvmdplugin__t.html">vmdplugin_t</a> *)&amp;jsplugin);
00299   <font class="keywordflow">return</font> <a class="code" href="vmdplugin_8h.html#a13">VMDPLUGIN_SUCCESS</a>;
00300 }
00301 
<a name="l00302"></a><a class="code" href="jsplugin_8c.html#a19">00302</a> <a class="code" href="vmdplugin_8h.html#a7">VMDPLUGIN_API</a> <font class="keywordtype">int</font> <a class="code" href="vmdplugin_8h.html#a6">VMDPLUGIN_fini</a>() {
00303   <font class="keywordflow">return</font> <a class="code" href="vmdplugin_8h.html#a13">VMDPLUGIN_SUCCESS</a>;
00304 }
00305 
00306   
00307 <font class="preprocessor">#ifdef TEST_JSPLUGIN</font>
00308 <font class="preprocessor"></font>
00309 <font class="preprocessor">#include &lt;sys/time.h&gt;</font>
00310 
00311 <font class="comment">/* get the time of day from the system clock, and store it (in seconds) */</font>
00312 <font class="keywordtype">double</font> time_of_day(<font class="keywordtype">void</font>) {
00313 <font class="preprocessor">#if defined(_MSC_VER)</font>
00314 <font class="preprocessor"></font>  <font class="keywordtype">double</font> t;
00315 
00316   t = GetTickCount();
00317   t = t / 1000.0;
00318 
00319   <font class="keywordflow">return</font> t;
00320 <font class="preprocessor">#else</font>
00321 <font class="preprocessor"></font>  <font class="keyword">struct </font>timeval tm;
00322   <font class="keyword">struct </font>timezone tz;
00323 
00324   gettimeofday(&amp;tm, &amp;tz);
00325   <font class="keywordflow">return</font>((double)(tm.tv_sec) + (double)(tm.tv_usec)/1000000.0);
00326 <font class="preprocessor">#endif</font>
00327 <font class="preprocessor"></font>}
00328 
00329 <font class="keywordtype">int</font> <a class="code" href="main_8c.html#a3">main</a>(<font class="keywordtype">int</font> argc, <font class="keywordtype">char</font> *argv[]) {
00330   <a class="code" href="structmolfile__timestep__t.html">molfile_timestep_t</a> timestep;
00331   <font class="keywordtype">void</font> *v;
00332   <a class="code" href="structjshandle.html">jshandle</a> *js;
00333   <font class="keywordtype">int</font> i, natoms;
00334   <font class="keywordtype">float</font> sizeMB =0.0, totalMB = 0.0;
00335   <font class="keywordtype">double</font> starttime, endtime, totaltime = 0.0;
00336 
00337   <font class="keywordflow">while</font> (--argc) {
00338     ++argv; 
00339     natoms = 0;
00340     v = <a class="code" href="jsplugin_8c.html#a11">open_js_read</a>(*argv, <font class="stringliteral">"js"</font>, &amp;natoms);
00341     <font class="keywordflow">if</font> (!v) {
00342       fprintf(stderr, <font class="stringliteral">"open_js_read failed for file %s\n"</font>, *argv);
00343       <font class="keywordflow">return</font> 1;
00344     }
00345     js = (<a class="code" href="structjshandle.html">jshandle</a> *)v;
00346     sizeMB = ((natoms * 3.0) * js-&gt;<a class="code" href="structjshandle.html#m2">nframes</a> * 4.0) / (1024.0 * 1024.0);
00347     totalMB += sizeMB; 
00348     printf(<font class="stringliteral">"file: %s\n"</font>, *argv);
00349     printf(<font class="stringliteral">"  %d atoms, %d frames, size: %6.1fMB\n"</font>, natoms, js-&gt;<a class="code" href="structjshandle.html#m2">nframes</a>, sizeMB);
00350 
00351     starttime = time_of_day();
00352     timestep.<a class="code" href="structmolfile__timestep__t.html#m0">coords</a> = (<font class="keywordtype">float</font> *)malloc(3*<font class="keyword">sizeof</font>(<font class="keywordtype">float</font>)*natoms);
00353     <font class="keywordflow">for</font> (i=0; i&lt;js-&gt;<a class="code" href="structjshandle.html#m2">nframes</a>; i++) {
00354       <font class="keywordtype">int</font> rc = <a class="code" href="jsplugin_8c.html#a12">read_js_timestep</a>(v, natoms, &amp;timestep);
00355       <font class="keywordflow">if</font> (rc) {
00356         fprintf(stderr, <font class="stringliteral">"error in read_js_timestep on frame %d\n"</font>, i);
00357         <font class="keywordflow">return</font> 1;
00358       }
00359     }
00360     endtime = time_of_day();
00361     <a class="code" href="jsplugin_8c.html#a13">close_js_read</a>(v);
00362     totaltime += endtime - starttime;
00363     printf(<font class="stringliteral">"  Time: %5.1f seconds\n"</font>, endtime - starttime);
00364     printf(<font class="stringliteral">"  Speed: %5.1f MB/sec, %5.1f timesteps/sec\n"</font>, sizeMB / (endtime - starttime), (js-&gt;<a class="code" href="structjshandle.html#m2">nframes</a> / (endtime - starttime)));
00365   }
00366   printf(<font class="stringliteral">"Overall Size: %6.1f MB\n"</font>, totalMB);
00367   printf(<font class="stringliteral">"Overall Time: %6.1f seconds\n"</font>, totaltime);
00368   printf(<font class="stringliteral">"Overall Speed: %5.1f MB/sec\n"</font>, totalMB / totaltime);
00369   <font class="keywordflow">return</font> 0;
00370 }
00371       
00372 <font class="preprocessor">#endif</font>
00373 <font class="preprocessor"></font>
</pre></div><hr><address><small>Generated on Wed Mar 22 13:15:30 2006 for VMD Plugins (current) by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.gif" alt="doxygen" align="middle" border=0 
width=110 height=53></a>1.2.14 written by <a href="mailto:dimitri@stack.nl">Dimitri van Heesch</a>,
 &copy;&nbsp;1997-2002</small></address>
</body>
</html>
