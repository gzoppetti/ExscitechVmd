<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>binposplugin.c Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.2.14 -->
<center>
<a class="qindex" href="index.html">Main Page</a> &nbsp; <a class="qindex" href="classes.html">Alphabetical List</a> &nbsp; <a class="qindex" href="annotated.html">Compound List</a> &nbsp; <a class="qindex" href="files.html">File List</a> &nbsp; <a class="qindex" href="functions.html">Compound Members</a> &nbsp; <a class="qindex" href="globals.html">File Members</a> &nbsp; <a class="qindex" href="pages.html">Related Pages</a> &nbsp; </center>
<hr><h1>binposplugin.c</h1><a href="binposplugin_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 <font class="comment">/***************************************************************************</font>
00002 <font class="comment"> *cr</font>
00003 <font class="comment"> *cr            (C) Copyright 1995-2006 The Board of Trustees of the</font>
00004 <font class="comment"> *cr                        University of Illinois</font>
00005 <font class="comment"> *cr                         All Rights Reserved</font>
00006 <font class="comment"> *cr</font>
00007 <font class="comment"> ***************************************************************************/</font>
00008 
00009 <font class="comment">/***************************************************************************</font>
00010 <font class="comment"> * RCS INFORMATION:</font>
00011 <font class="comment"> *</font>
00012 <font class="comment"> *      $RCSfile: binposplugin.c,v $</font>
00013 <font class="comment"> *      $Author: johns $       $Locker:  $             $State: Exp $</font>
00014 <font class="comment"> *      $Revision: 1.9 $       $Date: 2006/02/23 19:36:44 $</font>
00015 <font class="comment"> *</font>
00016 <font class="comment"> ***************************************************************************/</font>
00017 
00018 <font class="preprocessor">#include "<a class="code" href="largefiles_8h.html">largefiles.h</a>"</font>   <font class="comment">/* platform dependent 64-bit file I/O defines */</font>
00019 
00020 <font class="preprocessor">#include &lt;stdlib.h&gt;</font>
00021 <font class="preprocessor">#include &lt;stdio.h&gt;</font>
00022 <font class="preprocessor">#include &lt;string.h&gt;</font>
00023 <font class="preprocessor">#include &lt;limits.h&gt;</font>
00024 
00025 <font class="preprocessor">#include "<a class="code" href="molfile__plugin_8h.html">molfile_plugin.h</a>"</font>
00026 
00027 <font class="preprocessor">#if INT_MAX == 2147483647</font>
00028 <font class="preprocessor"></font>  <font class="keyword">typedef</font> <font class="keywordtype">int</font> binpos_int32;
00029 <font class="preprocessor">#elif SHRT_MAX == 2147483647</font>
00030 <font class="preprocessor"></font>  <font class="keyword">typedef</font> <font class="keywordtype">short</font> binpos_int32;
00031 <font class="preprocessor">#elif LONG_MAX == 2147483647</font>
00032 <font class="preprocessor"></font>  <font class="keyword">typedef</font> <font class="keywordtype">long</font> binpos_int32;
00033 <font class="preprocessor">#endif</font>
00034 <font class="preprocessor"></font>
<a name="l00035"></a><a class="code" href="structbinposhandle.html">00035</a> <font class="keyword">typedef</font> <font class="keyword">struct </font>{
<a name="l00036"></a><a class="code" href="structbinposhandle.html#m0">00036</a>   FILE *fd;
<a name="l00037"></a><a class="code" href="structbinposhandle.html#m1">00037</a>   <font class="keywordtype">int</font> numatoms;
<a name="l00038"></a><a class="code" href="structbinposhandle.html#m2">00038</a>   <font class="keywordtype">int</font> wrongendian;
<a name="l00039"></a><a class="code" href="structbinposhandle.html#m3">00039</a>   <font class="keywordtype">float</font> *xyz;
00040 } <a class="code" href="structbinposhandle.html">binposhandle</a>;
00041 
<a name="l00042"></a><a class="code" href="binposplugin_8c.html#a1">00042</a> <font class="keyword">static</font> <font class="keywordtype">void</font> *<a class="code" href="binposplugin_8c.html#a1">open_binpos_read</a>(<font class="keyword">const</font> <font class="keywordtype">char</font> *path, <font class="keyword">const</font> <font class="keywordtype">char</font> *filetype, 
00043     <font class="keywordtype">int</font> *natoms) {
00044   <a class="code" href="structbinposhandle.html">binposhandle</a> *binpos;
00045   FILE *fd;
00046   <font class="keywordtype">int</font> er=0,point,igarb;
00047   <font class="keywordtype">char</font> lenbuf[4];
00048   <font class="keywordtype">char</font> tmpc;
00049   <font class="keywordtype">char</font> magicchar[5];
00050 
00051   fd = fopen(path, <font class="stringliteral">"rb"</font>);
00052   <font class="keywordflow">if</font> (!fd) 
00053    {
00054     fprintf(stderr, <font class="stringliteral">"Could not open file '%s' for reading.\n"</font>, path);
00055     <font class="keywordflow">return</font> NULL;
00056    }
00057   binpos = (<a class="code" href="structbinposhandle.html">binposhandle</a> *)malloc(<font class="keyword">sizeof</font>(<a class="code" href="structbinposhandle.html">binposhandle</a>));
00058   memset(binpos, 0, <font class="keyword">sizeof</font>(<a class="code" href="structbinposhandle.html">binposhandle</a>));
00059   fread(magicchar,<font class="keyword">sizeof</font>(<font class="keywordtype">char</font>),4,fd);
00060   magicchar[4]= <font class="charliteral">'\0'</font> ;
00061   <font class="keywordflow">if</font>(strcmp(magicchar,<font class="stringliteral">"fxyz"</font>)!=0)
00062    {
00063     fprintf(stderr,<font class="stringliteral">"not a binpos amber coordinate file\n"</font>);
00064     <font class="keywordflow">return</font> NULL;
00065    }
00066   fprintf(stderr,<font class="stringliteral">"Proceeding to open amber7 binpos coordinate file\n"</font>);
00067   fread(&amp;igarb,<font class="keyword">sizeof</font>(<font class="keywordtype">int</font>),1,fd);
00068   point=ftell(fd);
00069 
00070 <font class="comment">/* Check for endianism here*/</font>
00071   <font class="keywordflow">if</font>(igarb&gt;1000000000)
00072    {
00073     fprintf(stderr, <font class="stringliteral">"File '%s' appears to be other-endian.\n"</font>, path);
00074     binpos-&gt;<a class="code" href="structbinposhandle.html#m2">wrongendian</a> = 1;
00075     memcpy(lenbuf, (<font class="keyword">const</font> <font class="keywordtype">char</font> *)&amp;igarb, 4);
00076     tmpc = lenbuf[0]; lenbuf[0] = lenbuf[3]; lenbuf[3] = tmpc;
00077     tmpc = lenbuf[1]; lenbuf[1] = lenbuf[2]; lenbuf[2] = tmpc;
00078     memcpy((<font class="keywordtype">char</font> *)&amp;igarb, lenbuf, 4);
00079 
00080         <font class="keywordflow">if</font>((fseek(fd, point, SEEK_SET))!=0)
00081       {
00082           fprintf(stderr,<font class="stringliteral">"Endian correction failed. er=%d\n"</font>,er);
00083       <font class="keywordflow">return</font> NULL;      
00084      }
00085         fseek(fd, point, SEEK_SET);
00086    }
00087   binpos-&gt;<a class="code" href="structbinposhandle.html#m0">fd</a> = fd;
00088   binpos-&gt;<a class="code" href="structbinposhandle.html#m1">numatoms</a> = igarb;
00089   binpos-&gt;<a class="code" href="structbinposhandle.html#m3">xyz</a> = (<font class="keywordtype">float</font> *)malloc(3 * binpos-&gt;<a class="code" href="structbinposhandle.html#m1">numatoms</a> * <font class="keyword">sizeof</font>(<font class="keywordtype">float</font>));
00090 
00091   <font class="keywordflow">if</font> (!binpos-&gt;<a class="code" href="structbinposhandle.html#m3">xyz</a>) {
00092     fprintf(stderr, <font class="stringliteral">"Unable to allocate space for %d atoms.\n"</font>, binpos-&gt;<a class="code" href="structbinposhandle.html#m1">numatoms</a>);
00093     fclose(fd);
00094     free(binpos);
00095     <font class="keywordflow">return</font> NULL;
00096   }
00097   *natoms = binpos-&gt;<a class="code" href="structbinposhandle.html#m1">numatoms</a>;
00098   <font class="keywordflow">return</font> binpos;
00099 }
00100 
<a name="l00101"></a><a class="code" href="binposplugin_8c.html#a2">00101</a> <font class="keyword">static</font> <font class="keywordtype">int</font> <a class="code" href="webpdbplugin_8c.html#a8">read_next_timestep</a>(<font class="keywordtype">void</font> *v, <font class="keywordtype">int</font> natoms, <a class="code" href="structmolfile__timestep__t.html">molfile_timestep_t</a> *ts) 
00102  {
00103   <a class="code" href="structbinposhandle.html">binposhandle</a> *binpos;
00104   <font class="keywordtype">int</font> i, numatoms,igarb;
00105   <font class="keywordtype">char</font> *cdata;
00106   <font class="keywordtype">char</font> tmpc;
00107 
00108   binpos = (<a class="code" href="structbinposhandle.html">binposhandle</a> *)v;
00109   <font class="keywordflow">if</font> (!binpos-&gt;<a class="code" href="structbinposhandle.html#m0">fd</a>) 
00110     <font class="keywordflow">return</font> <a class="code" href="molfile__plugin_8h.html#a4">MOLFILE_ERROR</a>;  <font class="comment">/* Done reading frames */</font>
00111 
00112   numatoms = binpos-&gt;<a class="code" href="structbinposhandle.html#m1">numatoms</a>;
00113 
00114   <font class="keywordflow">if</font> (fread(binpos-&gt;<a class="code" href="structbinposhandle.html#m3">xyz</a>, <font class="keyword">sizeof</font>(<font class="keywordtype">float</font>), 3 * numatoms, binpos-&gt;<a class="code" href="structbinposhandle.html#m0">fd</a>)
00115                                  != (size_t)(3 * numatoms)) {
00116     fprintf(stderr, <font class="stringliteral">"Failure reading data from amber7 binary file.\n"</font>);
00117     <font class="keywordflow">return</font> <a class="code" href="molfile__plugin_8h.html#a4">MOLFILE_ERROR</a>;
00118   }
00119 
00120   <font class="keywordflow">if</font> (binpos-&gt;<a class="code" href="structbinposhandle.html#m2">wrongendian</a>) {
00121 
00122 <font class="comment">/*For float or single precision endian conversion*/</font>
00123 <font class="comment">/*amber7 binpos files are always float not doubles*/</font>
00124     cdata = (<font class="keywordtype">char</font> *) binpos-&gt;<a class="code" href="structbinposhandle.html#m3">xyz</a>;
00125     <font class="keywordflow">for</font> ( i=0; i&lt;3*numatoms; ++i, cdata+=4 ) {
00126     tmpc = cdata[0]; cdata[0] = cdata[3]; cdata[3] = tmpc;
00127     tmpc = cdata[1]; cdata[1] = cdata[2]; cdata[2] = tmpc;
00128     }
00129   }
00130 
00131   <font class="keywordflow">if</font> (ts) {
00132     <font class="keywordflow">for</font> ( i=0; i&lt;numatoms; ++i) {
00133       ts-&gt;<a class="code" href="structmolfile__timestep__t.html#m0">coords</a>[3*i] = binpos-&gt;<a class="code" href="structbinposhandle.html#m3">xyz</a>[3*i];
00134       ts-&gt;<a class="code" href="structmolfile__timestep__t.html#m0">coords</a>[3*i+1] = binpos-&gt;<a class="code" href="structbinposhandle.html#m3">xyz</a>[3*i+1];
00135       ts-&gt;<a class="code" href="structmolfile__timestep__t.html#m0">coords</a>[3*i+2] = binpos-&gt;<a class="code" href="structbinposhandle.html#m3">xyz</a>[3*i+2];
00136     }
00137   }
00138   <font class="comment">/*</font>
00139 <font class="comment">   * Close the file handle and set to NULL so we know we're done reading </font>
00140 <font class="comment">   * </font>
00141 <font class="comment">   */</font>
00142 
00143   <font class="keywordflow">if</font>((fread(&amp;igarb,<font class="keyword">sizeof</font>(<font class="keywordtype">int</font>),1,binpos-&gt;<a class="code" href="structbinposhandle.html#m0">fd</a>))!=1)
00144    {
00145     fclose(binpos-&gt;<a class="code" href="structbinposhandle.html#m0">fd</a>);
00146     binpos-&gt;<a class="code" href="structbinposhandle.html#m0">fd</a> = NULL;
00147    }
00148   <font class="keywordflow">return</font> <a class="code" href="molfile__plugin_8h.html#a2">MOLFILE_SUCCESS</a>;
00149 }
00150  
<a name="l00151"></a><a class="code" href="binposplugin_8c.html#a3">00151</a> <font class="keyword">static</font> <font class="keywordtype">void</font> <a class="code" href="stlplugin_8C.html#a4">close_file_read</a>(<font class="keywordtype">void</font> *v) {
00152   <a class="code" href="structbinposhandle.html">binposhandle</a> *binpos = (<a class="code" href="structbinposhandle.html">binposhandle</a> *)v;
00153   <font class="keywordflow">if</font> (binpos-&gt;<a class="code" href="structbinposhandle.html#m0">fd</a>)
00154     fclose(binpos-&gt;<a class="code" href="structbinposhandle.html#m0">fd</a>);
00155   free(binpos-&gt;<a class="code" href="structbinposhandle.html#m3">xyz</a>);
00156   free(binpos);
00157 }
00158 
<a name="l00159"></a><a class="code" href="binposplugin_8c.html#a4">00159</a> <font class="keyword">static</font> <font class="keywordtype">void</font> *<a class="code" href="binposplugin_8c.html#a4">open_binpos_write</a>(<font class="keyword">const</font> <font class="keywordtype">char</font> *path, <font class="keyword">const</font> <font class="keywordtype">char</font> *filetype, 
00160     <font class="keywordtype">int</font> natoms) {
00161   <a class="code" href="structbinposhandle.html">binposhandle</a> *binpos;
00162   FILE *fd;
00163 
00164   fd = fopen(path, <font class="stringliteral">"wb"</font>);
00165   <font class="keywordflow">if</font> (!fd) {
00166     fprintf(stderr, <font class="stringliteral">"Could not open file %s for writing\n"</font>, path);
00167     <font class="keywordflow">return</font> NULL;
00168   }
00169   fprintf(stderr,<font class="stringliteral">"Writing file in current machine endian-ism\n"</font>);
00170   binpos = (<a class="code" href="structbinposhandle.html">binposhandle</a> *)malloc(<font class="keyword">sizeof</font>(<a class="code" href="structbinposhandle.html">binposhandle</a>));
00171   binpos-&gt;<a class="code" href="structbinposhandle.html#m0">fd</a> = fd;
00172   binpos-&gt;<a class="code" href="structbinposhandle.html#m1">numatoms</a> = natoms;
00173   fwrite( <font class="stringliteral">"fxyz"</font>, 4, 1, binpos-&gt;<a class="code" href="structbinposhandle.html#m0">fd</a>);
00174   <font class="keywordflow">return</font> binpos;
00175 }
00176 
<a name="l00177"></a><a class="code" href="binposplugin_8c.html#a5">00177</a> <font class="keyword">static</font> <font class="keywordtype">int</font> <a class="code" href="pdbplugin_8c.html#a10">write_timestep</a>(<font class="keywordtype">void</font> *v, <font class="keyword">const</font> <a class="code" href="structmolfile__timestep__t.html">molfile_timestep_t</a> *ts) {
00178   
00179   <font class="keywordtype">int</font> i,numatoms;
00180 
00181   <a class="code" href="structbinposhandle.html">binposhandle</a> *binpos = (<a class="code" href="structbinposhandle.html">binposhandle</a> *)v;
00182   
00183   <font class="keywordflow">if</font> (!binpos-&gt;<a class="code" href="structbinposhandle.html#m0">fd</a>)
00184     <font class="keywordflow">return</font> <a class="code" href="molfile__plugin_8h.html#a4">MOLFILE_ERROR</a>;
00185 
00186 <font class="comment">/*add the number of atoms in between frames*/</font>
00187   <font class="comment">/*myint = (binpos_int32)binpos-&gt;numatoms;*/</font>
00188   numatoms = binpos-&gt;<a class="code" href="structbinposhandle.html#m1">numatoms</a>;
00189 
00190   fwrite(&amp;numatoms, 4, 1, binpos-&gt;<a class="code" href="structbinposhandle.html#m0">fd</a>);
00191 
00192   <font class="keywordflow">for</font> (i=0; i&lt;3*numatoms; i++) 
00193    {
00194     <font class="keywordtype">float</font> tmp = ts-&gt;<a class="code" href="structmolfile__timestep__t.html#m0">coords</a>[i];
00195     <font class="keywordflow">if</font> (fwrite(&amp;tmp, <font class="keyword">sizeof</font>(<font class="keywordtype">float</font>), 1, binpos-&gt;<a class="code" href="structbinposhandle.html#m0">fd</a>) != 1) {
00196       fprintf(stderr, <font class="stringliteral">"Error writing amber7 binary file\n"</font>);
00197       <font class="keywordflow">return</font> <a class="code" href="molfile__plugin_8h.html#a4">MOLFILE_ERROR</a>;
00198      }
00199    }
00200 
00201   <font class="comment">/*</font>
00202 <font class="comment">   * Close and NULLify the file handle so we don't write any more frames.</font>
00203 <font class="comment">   */</font>
00204 <font class="comment">/*  fclose(binpos-&gt;fd);</font>
00205 <font class="comment">  binpos-&gt;fd = NULL;*/</font>
00206 
00207   <font class="keywordflow">return</font> <a class="code" href="molfile__plugin_8h.html#a2">MOLFILE_SUCCESS</a>;
00208 }
00209        
<a name="l00210"></a><a class="code" href="binposplugin_8c.html#a6">00210</a> <font class="keyword">static</font> <font class="keywordtype">void</font> <a class="code" href="pdbplugin_8c.html#a11">close_file_write</a>(<font class="keywordtype">void</font> *v) {
00211   <a class="code" href="structbinposhandle.html">binposhandle</a> *binpos = (<a class="code" href="structbinposhandle.html">binposhandle</a> *)v;
00212   <font class="keywordflow">if</font> (binpos-&gt;<a class="code" href="structbinposhandle.html#m0">fd</a>)
00213     fclose(binpos-&gt;<a class="code" href="structbinposhandle.html#m0">fd</a>);
00214   free(binpos);
00215 }
00216 
00217 <font class="comment">/*</font>
00218 <font class="comment"> * Initialization stuff here</font>
00219 <font class="comment"> */</font>
00220 
<a name="l00221"></a><a class="code" href="binposplugin_8c.html#a0">00221</a> <font class="keyword">static</font> <a class="code" href="structmolfile__plugin__t.html">molfile_plugin_t</a> <a class="code" href="binposplugin_8c.html#a0">plugin</a> = {
00222   <a class="code" href="vmdplugin_8h.html#a10">vmdplugin_ABIVERSION</a>,         <font class="comment">/* ABI verison */</font>
00223   <a class="code" href="molfile__plugin_8h.html#a0">MOLFILE_PLUGIN_TYPE</a>,          <font class="comment">/* type of plugin */</font>
00224   <font class="stringliteral">"binpos"</font>,                     <font class="comment">/* short name of plugin */</font>
00225   <font class="stringliteral">"Scripps Binpos"</font>,             <font class="comment">/* pretty name of plugin */</font>
00226   <font class="stringliteral">"Brian Bennion"</font>,              <font class="comment">/* author */</font>
00227   0,                            <font class="comment">/* major version */</font>
00228   3,                            <font class="comment">/* minor version */</font>
00229   <a class="code" href="vmdplugin_8h.html#a12">VMDPLUGIN_THREADSAFE</a>,         <font class="comment">/* is reentrant */</font>
00230   <font class="stringliteral">"binpos"</font>,                     <font class="comment">/* same extension */</font>
00231   <a class="code" href="binposplugin_8c.html#a1">open_binpos_read</a>,
00232   0,
00233   0,
00234   <a class="code" href="binposplugin_8c.html#a2">read_next_timestep</a>,
00235   <a class="code" href="binposplugin_8c.html#a3">close_file_read</a>,
00236   <a class="code" href="binposplugin_8c.html#a4">open_binpos_write</a>,
00237   0,
00238   <a class="code" href="binposplugin_8c.html#a5">write_timestep</a>,
00239   <a class="code" href="binposplugin_8c.html#a6">close_file_write</a>
00240 };
00241 
<a name="l00242"></a><a class="code" href="binposplugin_8c.html#a7">00242</a> <a class="code" href="vmdplugin_8h.html#a7">VMDPLUGIN_API</a> <font class="keywordtype">int</font> <a class="code" href="vmdplugin_8h.html#a5">VMDPLUGIN_init</a>() {
00243   <font class="keywordflow">return</font> <a class="code" href="vmdplugin_8h.html#a13">VMDPLUGIN_SUCCESS</a>;
00244 }
00245 
<a name="l00246"></a><a class="code" href="binposplugin_8c.html#a8">00246</a> <a class="code" href="vmdplugin_8h.html#a7">VMDPLUGIN_API</a> <font class="keywordtype">int</font> <a class="code" href="vmdplugin_8h.html#a3">VMDPLUGIN_register</a>(<font class="keywordtype">void</font> *v, <a class="code" href="vmdplugin_8h.html#a15">vmdplugin_register_cb</a> cb) {
00247   (*cb)(v, (<a class="code" href="structvmdplugin__t.html">vmdplugin_t</a> *)&amp;plugin);
00248   <font class="keywordflow">return</font> <a class="code" href="vmdplugin_8h.html#a13">VMDPLUGIN_SUCCESS</a>;
00249 }
00250 
<a name="l00251"></a><a class="code" href="binposplugin_8c.html#a9">00251</a> <a class="code" href="vmdplugin_8h.html#a7">VMDPLUGIN_API</a> <font class="keywordtype">int</font> <a class="code" href="vmdplugin_8h.html#a6">VMDPLUGIN_fini</a>() {
00252   <font class="keywordflow">return</font> <a class="code" href="vmdplugin_8h.html#a13">VMDPLUGIN_SUCCESS</a>;
00253 }
</pre></div><hr><address><small>Generated on Wed Mar 22 13:15:28 2006 for VMD Plugins (current) by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.gif" alt="doxygen" align="middle" border=0 
width=110 height=53></a>1.2.14 written by <a href="mailto:dimitri@stack.nl">Dimitri van Heesch</a>,
 &copy;&nbsp;1997-2002</small></address>
</body>
</html>
