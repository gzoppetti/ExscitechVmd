<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>fastio.h Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.2.14 -->
<center>
<a class="qindex" href="index.html">Main Page</a> &nbsp; <a class="qindex" href="classes.html">Alphabetical List</a> &nbsp; <a class="qindex" href="annotated.html">Compound List</a> &nbsp; <a class="qindex" href="files.html">File List</a> &nbsp; <a class="qindex" href="functions.html">Compound Members</a> &nbsp; <a class="qindex" href="globals.html">File Members</a> &nbsp; <a class="qindex" href="pages.html">Related Pages</a> &nbsp; </center>
<hr><h1>fastio.h</h1><a href="fastio_8h.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 <font class="comment">/***************************************************************************</font>
00002 <font class="comment"> *cr</font>
00003 <font class="comment"> *cr            (C) Copyright 1995-2006 The Board of Trustees of the</font>
00004 <font class="comment"> *cr                        University of Illinois</font>
00005 <font class="comment"> *cr                         All Rights Reserved</font>
00006 <font class="comment"> *cr</font>
00007 <font class="comment"> ***************************************************************************/</font>
00008 <font class="comment">/***************************************************************************</font>
00009 <font class="comment"> * RCS INFORMATION:</font>
00010 <font class="comment"> *</font>
00011 <font class="comment"> *      $RCSfile: fastio.h,v $</font>
00012 <font class="comment"> *      $Author: johns $       $Locker:  $             $State: Exp $</font>
00013 <font class="comment"> *      $Revision: 1.19 $       $Date: 2006/01/27 20:31:44 $</font>
00014 <font class="comment"> *</font>
00015 <font class="comment"> ***************************************************************************</font>
00016 <font class="comment"> * DESCRIPTION:</font>
00017 <font class="comment"> *   This is a simple abstraction layer for system-dependent I/O calls</font>
00018 <font class="comment"> * that allow plugins to do binary I/O using the fastest possible method.</font>
00019 <font class="comment"> *</font>
00020 <font class="comment"> * This code is intended for use by binary trajectory reader plugins that</font>
00021 <font class="comment"> * work with multi-gigabyte data sets, reading only binary data.</font>
00022 <font class="comment"> *</font>
00023 <font class="comment"> ***************************************************************************/</font>
00024 
00025 <font class="comment">/* Compiling on windows */</font>
00026 <font class="preprocessor">#if defined(_MSC_VER)</font>
00027 <font class="preprocessor"></font>
00028 <font class="preprocessor">#if 1 </font>
00029 <font class="preprocessor"></font><font class="comment">/* use native Windows I/O calls */</font>
00030 <font class="preprocessor">#define FASTIO_NATIVEWIN32 1</font>
00031 <font class="preprocessor"></font>
00032 <font class="preprocessor">#include &lt;stdio.h&gt;</font>
00033 <font class="preprocessor">#include &lt;windows.h&gt;</font>
00034 
00035 <font class="keyword">typedef</font> HANDLE <a class="code" href="fastio_8h.html#a5">fio_fd</a>;
00036 <font class="keyword">typedef</font> LONGLONG <a class="code" href="fastio_8h.html#a6">fio_size_t</a>;
00037 <font class="keyword">typedef</font> <font class="keywordtype">void</font> * <a class="code" href="fastio_8h.html#a7">fio_caddr_t</a>;
00038 
00039 <font class="keyword">typedef</font> <font class="keyword">struct </font>{
00040   <a class="code" href="fastio_8h.html#a7">fio_caddr_t</a> iov_base;
00041   <font class="keywordtype">int</font> iov_len;
00042 } <a class="code" href="structfio__iovec.html">fio_iovec</a>;
00043 
00044 <font class="preprocessor">#define FIO_READ  0x01</font>
00045 <font class="preprocessor"></font><font class="preprocessor">#define FIO_WRITE 0x02</font>
00046 <font class="preprocessor"></font>
00047 <font class="preprocessor">#define FIO_SEEK_CUR  FILE_CURRENT</font>
00048 <font class="preprocessor"></font><font class="preprocessor">#define FIO_SEEK_SET  FILE_BEGIN</font>
00049 <font class="preprocessor"></font><font class="preprocessor">#define FIO_SEEK_END  FILE_END</font>
00050 <font class="preprocessor"></font>
00051 <font class="keyword">static</font> <font class="keywordtype">int</font> fio_win32convertfilename(<font class="keyword">const</font> <font class="keywordtype">char</font> *filename, <font class="keywordtype">char</font> *newfilename, <font class="keywordtype">int</font> maxlen) {
00052   <font class="keywordtype">int</font> i;
00053   <font class="keywordtype">int</font> len=strlen(filename);
00054  
00055   <font class="keywordflow">if</font> ((len + 1) &gt;= maxlen)
00056     <font class="keywordflow">return</font> -1;
00057    
00058   <font class="keywordflow">for</font> (i=0; i&lt;len; i++) {
00059     <font class="keywordflow">if</font> (filename[i] == <font class="charliteral">'/'</font>)
00060       newfilename[i] = <font class="charliteral">'\\'</font>;
00061     <font class="keywordflow">else</font>
00062       newfilename[i] = filename[i];
00063   }
00064   newfilename[len] = <font class="charliteral">'\0'</font>; <font class="comment">/* NUL terminate the string */</font>
00065 
00066   <font class="keywordflow">return</font> 0;
00067 }
00068 
00069 <font class="keyword">static</font> <font class="keywordtype">int</font> <a class="code" href="fastio_8h.html#a8">fio_open</a>(<font class="keyword">const</font> <font class="keywordtype">char</font> *filename, <font class="keywordtype">int</font> mode, <a class="code" href="fastio_8h.html#a5">fio_fd</a> *fd) {
00070   HANDLE fp;
00071   <font class="keywordtype">char</font> winfilename[8192];
00072   DWORD access;
00073   DWORD sharing;
00074   LPSECURITY_ATTRIBUTES security;
00075   DWORD createmode;
00076   DWORD flags;
00077 
00078   <font class="keywordflow">if</font> (fio_win32convertfilename(filename, winfilename, <font class="keyword">sizeof</font>(winfilename)))
00079     <font class="keywordflow">return</font> -1;  
00080 
00081   access = 0;
00082   <font class="keywordflow">if</font> (mode &amp; <a class="code" href="fastio_8h.html#a0">FIO_READ</a>)
00083     access |= GENERIC_READ;
00084   <font class="keywordflow">if</font> (mode &amp; <a class="code" href="fastio_8h.html#a1">FIO_WRITE</a>)
00085     access |= GENERIC_WRITE;
00086 <font class="preprocessor">#if 0</font>
00087 <font class="preprocessor"></font>  access = FILE_ALL_ACCESS; <font class="comment">/* XXX hack if above modes fail */</font>
00088 <font class="preprocessor">#endif</font>
00089 <font class="preprocessor"></font>
00090   sharing = 0;       <font class="comment">/* disallow sharing with other processes  */</font>
00091   security = NULL;   <font class="comment">/* child processes don't inherit anything */</font>
00092 
00093   <font class="comment">/* since we never append, blow away anything that's already there */</font>
00094   <font class="keywordflow">if</font> (mode &amp; <a class="code" href="fastio_8h.html#a1">FIO_WRITE</a>)
00095     createmode = CREATE_ALWAYS;
00096   <font class="keywordflow">else</font> 
00097     createmode = OPEN_EXISTING;
00098 
00099   flags = FILE_ATTRIBUTE_NORMAL;
00100 
00101   fp = CreateFile(winfilename, access, sharing, security, 
00102                   createmode, flags, NULL);
00103 
00104   <font class="keywordflow">if</font> (fp == NULL) {
00105     <font class="keywordflow">return</font> -1;
00106   } <font class="keywordflow">else</font> {
00107     *fd = fp;
00108     <font class="keywordflow">return</font> 0;
00109   }
00110 }
00111 
00112 
00113 <font class="keyword">static</font> <font class="keywordtype">int</font> <a class="code" href="fastio_8h.html#a9">fio_fclose</a>(<a class="code" href="fastio_8h.html#a5">fio_fd</a> fd) {
00114   BOOL rc;
00115   rc = CloseHandle(fd);
00116   <font class="keywordflow">if</font> (rc) 
00117     <font class="keywordflow">return</font> 0;
00118   <font class="keywordflow">else</font> 
00119     <font class="keywordflow">return</font> -1;
00120 }
00121 
00122 <font class="keyword">static</font> <a class="code" href="fastio_8h.html#a6">fio_size_t</a> <a class="code" href="fastio_8h.html#a10">fio_fread</a>(<font class="keywordtype">void</font> *ptr, <a class="code" href="fastio_8h.html#a6">fio_size_t</a> size, 
00123                             <a class="code" href="fastio_8h.html#a6">fio_size_t</a> nitems, <a class="code" href="fastio_8h.html#a5">fio_fd</a> fd) {
00124   BOOL rc;
00125   DWORD len;
00126   DWORD readlen;
00127 
00128   len = size * nitems;
00129 
00130   rc = ReadFile(fd, ptr, len, &amp;readlen, NULL);
00131   <font class="keywordflow">if</font> (rc) {
00132     <font class="keywordflow">if</font> (readlen == len)
00133       <font class="keywordflow">return</font> nitems;
00134     <font class="keywordflow">else</font> 
00135       <font class="keywordflow">return</font> 0;
00136   } <font class="keywordflow">else</font> {
00137     <font class="keywordflow">return</font> 0;
00138   }
00139 }
00140 
00141 <font class="keyword">static</font> <a class="code" href="fastio_8h.html#a6">fio_size_t</a> <a class="code" href="fastio_8h.html#a11">fio_readv</a>(<a class="code" href="fastio_8h.html#a5">fio_fd</a> fd, <font class="keyword">const</font> <a class="code" href="structfio__iovec.html">fio_iovec</a> * iov, <font class="keywordtype">int</font> iovcnt) {
00142   <font class="keywordtype">int</font> i;
00143   <a class="code" href="fastio_8h.html#a6">fio_size_t</a> len = 0; 
00144 
00145   <font class="keywordflow">for</font> (i=0; i&lt;iovcnt; i++) {
00146     <a class="code" href="fastio_8h.html#a6">fio_size_t</a> rc = <a class="code" href="fastio_8h.html#a10">fio_fread</a>(iov[i].iov_base, iov[i].iov_len, 1, fd);
00147     <font class="keywordflow">if</font> (rc != 1)
00148       <font class="keywordflow">break</font>;
00149     len += iov[i].<a class="code" href="structfio__iovec.html#m1">iov_len</a>;
00150   }
00151 
00152   <font class="keywordflow">return</font> len;
00153 }
00154 
00155 <font class="keyword">static</font> <a class="code" href="fastio_8h.html#a6">fio_size_t</a> <a class="code" href="fastio_8h.html#a12">fio_fwrite</a>(<font class="keywordtype">void</font> *ptr, <a class="code" href="fastio_8h.html#a6">fio_size_t</a> size, 
00156                              <a class="code" href="fastio_8h.html#a6">fio_size_t</a> nitems, <a class="code" href="fastio_8h.html#a5">fio_fd</a> fd) {
00157   BOOL rc;
00158   DWORD len;
00159   DWORD writelen;
00160 
00161   len = size * nitems; 
00162  
00163   rc = WriteFile(fd, ptr, len, &amp;writelen, NULL);
00164   <font class="keywordflow">if</font> (rc) {
00165     <font class="keywordflow">if</font> (writelen == len)
00166       <font class="keywordflow">return</font> nitems;
00167     <font class="keywordflow">else</font>
00168       <font class="keywordflow">return</font> 0;
00169   } <font class="keywordflow">else</font> {
00170     <font class="keywordflow">return</font> 0;
00171   }
00172 }
00173 
00174 <font class="keyword">static</font> <a class="code" href="fastio_8h.html#a6">fio_size_t</a> <a class="code" href="fastio_8h.html#a13">fio_fseek</a>(<a class="code" href="fastio_8h.html#a5">fio_fd</a> fd, <a class="code" href="fastio_8h.html#a6">fio_size_t</a> offset, <font class="keywordtype">int</font> whence) {
00175 <font class="preprocessor">#if 1</font>
00176 <font class="preprocessor"></font>  <font class="comment">/* code that works with older MSVC6 compilers */</font>
00177   LONGLONG finaloffset;
00178   LARGE_INTEGER bigint;
00179   LARGE_INTEGER finalint;
00180 
00181   bigint.QuadPart = offset;
00182   finalint = bigint;      <font class="comment">/* set the high part, which will be overwritten */</font>
00183   finalint.LowPart = SetFilePointer(fd, bigint.LowPart, &amp;finalint.HighPart, whence);
00184   <font class="keywordflow">if</font> (finalint.LowPart == -1) {
00185     <font class="comment">/* if (finalint.LowPart == INVALID_SET_FILE_POINTER) { */</font>
00186     <font class="comment">/* INVALID_SET_FILE_POINTER is a possible "ok" low order result when */</font>
00187     <font class="comment">/* working with 64-bit offsets, so we have to also check the system  */</font>
00188     <font class="comment">/* error value for this thread to be sure */</font>
00189     <font class="keywordflow">if</font> (GetLastError() != ERROR_SUCCESS) {
00190       <font class="keywordflow">return</font> -1;
00191     }
00192   } 
00193 
00194   finaloffset = finalint.QuadPart;
00195   <font class="keywordflow">return</font> 0;
00196 <font class="preprocessor">#else</font>
00197 <font class="preprocessor"></font>  BOOL rc;
00198   LONGLONG finaloffset;
00199 
00200   <font class="comment">/* SetFilePointerEx() only exists with new .NET compilers */</font>
00201   rc = SetFilePointerEx(fd, offset, &amp;finaloffset, whence);
00202 
00203   <font class="keywordflow">if</font> (rc) 
00204     <font class="keywordflow">return</font> 0;
00205   <font class="keywordflow">else</font>
00206     <font class="keywordflow">return</font> -1;
00207 <font class="preprocessor">#endif</font>
00208 <font class="preprocessor"></font>}
00209 
00210 <font class="keyword">static</font> <a class="code" href="fastio_8h.html#a6">fio_size_t</a> <a class="code" href="fastio_8h.html#a14">fio_ftell</a>(<a class="code" href="fastio_8h.html#a5">fio_fd</a> fd) {
00211   <font class="comment">/* code that works with older MSVC6 compilers */</font>
00212   LONGLONG finaloffset;
00213   LARGE_INTEGER bigint;
00214   LARGE_INTEGER finalint;
00215 
00216   bigint.QuadPart = 0;
00217   finalint = bigint;      <font class="comment">/* set the high part, which will be overwritten */</font>
00218 
00219   finalint.LowPart = SetFilePointer(fd, bigint.LowPart, &amp;finalint.HighPart, FILE_CURRENT);
00220   <font class="keywordflow">if</font> (finalint.LowPart == -1) {
00221     <font class="comment">/* if (finalint.LowPart == INVALID_SET_FILE_POINTER) { */</font>
00222     <font class="comment">/* INVALID_SET_FILE_POINTER is a possible "ok" low order result when */</font>
00223     <font class="comment">/* working with 64-bit offsets, so we have to also check the system  */</font>
00224     <font class="comment">/* error value for this thread to be sure */</font>
00225     <font class="keywordflow">if</font> (GetLastError() != ERROR_SUCCESS) {
00226       <font class="keywordflow">return</font> -1;
00227     }
00228   }
00229 
00230   finaloffset = finalint.QuadPart;
00231 
00232   <font class="keywordflow">return</font> finaloffset;
00233 }
00234 
00235 
00236 <font class="preprocessor">#else</font>
00237 <font class="preprocessor"></font>
00238 <font class="comment">/* Version for machines with plain old ANSI C  */</font>
00239 
00240 <font class="preprocessor">#include &lt;stdio.h&gt;</font>
00241 
00242 <font class="keyword">typedef</font> FILE * <a class="code" href="fastio_8h.html#a5">fio_fd</a>;
00243 <font class="keyword">typedef</font> size_t <a class="code" href="fastio_8h.html#a6">fio_size_t</a>;  <font class="comment">/* MSVC doesn't uinversally support ssize_t */</font>
00244 <font class="keyword">typedef</font> <font class="keywordtype">void</font> * <a class="code" href="fastio_8h.html#a7">fio_caddr_t</a>; <font class="comment">/* MSVC doesn't universally support caddr_t */</font>
00245 
00246 <font class="keyword">typedef</font> <font class="keyword">struct </font>{
00247   <a class="code" href="fastio_8h.html#a7">fio_caddr_t</a> iov_base;
00248   <font class="keywordtype">int</font> iov_len;
00249 } <a class="code" href="structfio__iovec.html">fio_iovec</a>;
00250 
00251 <font class="preprocessor">#define FIO_READ  0x01</font>
00252 <font class="preprocessor"></font><font class="preprocessor">#define FIO_WRITE 0x02</font>
00253 <font class="preprocessor"></font>
00254 <font class="preprocessor">#define FIO_SEEK_CUR SEEK_CUR</font>
00255 <font class="preprocessor"></font><font class="preprocessor">#define FIO_SEEK_SET SEEK_SET</font>
00256 <font class="preprocessor"></font><font class="preprocessor">#define FIO_SEEK_END SEEK_END</font>
00257 <font class="preprocessor"></font>
00258 <font class="keyword">static</font> <font class="keywordtype">int</font> <a class="code" href="fastio_8h.html#a8">fio_open</a>(<font class="keyword">const</font> <font class="keywordtype">char</font> *filename, <font class="keywordtype">int</font> mode, <a class="code" href="fastio_8h.html#a5">fio_fd</a> *fd) {
00259   <font class="keywordtype">char</font> * modestr;
00260   FILE *fp;
00261  
00262   <font class="keywordflow">if</font> (mode == <a class="code" href="fastio_8h.html#a0">FIO_READ</a>) 
00263     modestr = <font class="stringliteral">"rb"</font>;
00264 
00265   <font class="keywordflow">if</font> (mode == <a class="code" href="fastio_8h.html#a1">FIO_WRITE</a>) 
00266     modestr = <font class="stringliteral">"wb"</font>;
00267 
00268   fp = fopen(filename, modestr);
00269   <font class="keywordflow">if</font> (fp == NULL) {
00270     <font class="keywordflow">return</font> -1;
00271   } <font class="keywordflow">else</font> {
00272     *fd = fp;
00273     <font class="keywordflow">return</font> 0;
00274   }
00275 }
00276 
00277 <font class="keyword">static</font> <font class="keywordtype">int</font> <a class="code" href="fastio_8h.html#a9">fio_fclose</a>(<a class="code" href="fastio_8h.html#a5">fio_fd</a> fd) {
00278   <font class="keywordflow">return</font> fclose(fd);
00279 }
00280 
00281 <font class="keyword">static</font> <a class="code" href="fastio_8h.html#a6">fio_size_t</a> <a class="code" href="fastio_8h.html#a10">fio_fread</a>(<font class="keywordtype">void</font> *ptr, <a class="code" href="fastio_8h.html#a6">fio_size_t</a> size, 
00282                             <a class="code" href="fastio_8h.html#a6">fio_size_t</a> nitems, <a class="code" href="fastio_8h.html#a5">fio_fd</a> fd) {
00283   <font class="keywordflow">return</font> fread(ptr, size, nitems, fd);
00284 }
00285 
00286 <font class="keyword">static</font> <a class="code" href="fastio_8h.html#a6">fio_size_t</a> <a class="code" href="fastio_8h.html#a11">fio_readv</a>(<a class="code" href="fastio_8h.html#a5">fio_fd</a> fd, <font class="keyword">const</font> <a class="code" href="structfio__iovec.html">fio_iovec</a> * iov, <font class="keywordtype">int</font> iovcnt) {
00287   <font class="keywordtype">int</font> i;
00288   <a class="code" href="fastio_8h.html#a6">fio_size_t</a> len = 0; 
00289 
00290   <font class="keywordflow">for</font> (i=0; i&lt;iovcnt; i++) {
00291     <a class="code" href="fastio_8h.html#a6">fio_size_t</a> rc = fread(iov[i].iov_base, iov[i].iov_len, 1, fd);
00292     <font class="keywordflow">if</font> (rc != 1)
00293       <font class="keywordflow">break</font>;
00294     len += iov[i].<a class="code" href="structfio__iovec.html#m1">iov_len</a>;
00295   }
00296 
00297   <font class="keywordflow">return</font> len;
00298 }
00299 
00300 <font class="keyword">static</font> <a class="code" href="fastio_8h.html#a6">fio_size_t</a> <a class="code" href="fastio_8h.html#a12">fio_fwrite</a>(<font class="keywordtype">void</font> *ptr, <a class="code" href="fastio_8h.html#a6">fio_size_t</a> size, 
00301                              <a class="code" href="fastio_8h.html#a6">fio_size_t</a> nitems, <a class="code" href="fastio_8h.html#a5">fio_fd</a> fd) {
00302   <font class="keywordflow">return</font> fwrite(ptr, size, nitems, fd);
00303 }
00304 
00305 <font class="keyword">static</font> <a class="code" href="fastio_8h.html#a6">fio_size_t</a> <a class="code" href="fastio_8h.html#a13">fio_fseek</a>(<a class="code" href="fastio_8h.html#a5">fio_fd</a> fd, <a class="code" href="fastio_8h.html#a6">fio_size_t</a> offset, <font class="keywordtype">int</font> whence) {
00306   <font class="keywordflow">return</font> fseek(fd, offset, whence);
00307 }
00308 
00309 <font class="keyword">static</font> <a class="code" href="fastio_8h.html#a6">fio_size_t</a> <a class="code" href="fastio_8h.html#a14">fio_ftell</a>(<a class="code" href="fastio_8h.html#a5">fio_fd</a> fd) {
00310   <font class="keywordflow">return</font> ftell(fd);
00311 }
00312 <font class="preprocessor">#endif </font><font class="comment">/* plain ANSI C */</font>
00313 
00314 <font class="preprocessor">#else </font>
00315 <font class="preprocessor"></font>
00316 <font class="comment">/* Version for UNIX machines */</font>
00317 <font class="preprocessor">#include &lt;unistd.h&gt;</font>
00318 <font class="preprocessor">#include &lt;sys/types.h&gt;</font>
00319 <font class="preprocessor">#include &lt;sys/stat.h&gt;</font>
00320 <font class="preprocessor">#include &lt;fcntl.h&gt;</font>
00321 
<a name="l00322"></a><a class="code" href="fastio_8h.html#a5">00322</a> <font class="keyword">typedef</font> <font class="keywordtype">int</font> <a class="code" href="fastio_8h.html#a5">fio_fd</a>;
<a name="l00323"></a><a class="code" href="fastio_8h.html#a6">00323</a> <font class="keyword">typedef</font> off_t <a class="code" href="fastio_8h.html#a6">fio_size_t</a>;      <font class="comment">/* off_t is 64-bits with LFS builds */</font>
00324 
00325 <font class="comment">/* enable use of kernel readv() if available */</font>
00326 <font class="preprocessor">#if defined(__sun) || defined(__APPLE_CC__) || defined(__linux)</font>
00327 <font class="preprocessor"></font><font class="preprocessor">#define USE_KERNEL_READV 1</font>
00328 <font class="preprocessor"></font><font class="preprocessor">#endif</font>
00329 <font class="preprocessor"></font>
<a name="l00330"></a><a class="code" href="fastio_8h.html#a7">00330</a> <font class="keyword">typedef</font> <font class="keywordtype">void</font> * <a class="code" href="fastio_8h.html#a7">fio_caddr_t</a>;
00331 
00332 <font class="preprocessor">#if defined(USE_KERNEL_READV)</font>
00333 <font class="preprocessor"></font><font class="preprocessor">#include &lt;sys/uio.h&gt;</font>
00334 <font class="keyword">typedef</font> <font class="keyword">struct </font>iovec <a class="code" href="structfio__iovec.html">fio_iovec</a>;
00335 <font class="preprocessor">#else</font>
00336 <font class="preprocessor"></font>
<a name="l00337"></a><a class="code" href="structfio__iovec.html">00337</a> <font class="keyword">typedef</font> <font class="keyword">struct </font>{
<a name="l00338"></a><a class="code" href="structfio__iovec.html#m0">00338</a>   <a class="code" href="fastio_8h.html#a7">fio_caddr_t</a> iov_base;
<a name="l00339"></a><a class="code" href="structfio__iovec.html#m1">00339</a>   <font class="keywordtype">int</font> iov_len;
00340 } <a class="code" href="structfio__iovec.html">fio_iovec</a>;
00341 <font class="preprocessor">#endif</font>
00342 <font class="preprocessor"></font>
00343 
<a name="l00344"></a><a class="code" href="fastio_8h.html#a0">00344</a> <font class="preprocessor">#define FIO_READ  0x01</font>
<a name="l00345"></a><a class="code" href="fastio_8h.html#a1">00345</a> <font class="preprocessor"></font><font class="preprocessor">#define FIO_WRITE 0x02</font>
00346 <font class="preprocessor"></font>
<a name="l00347"></a><a class="code" href="fastio_8h.html#a2">00347</a> <font class="preprocessor">#define FIO_SEEK_CUR SEEK_CUR</font>
<a name="l00348"></a><a class="code" href="fastio_8h.html#a3">00348</a> <font class="preprocessor"></font><font class="preprocessor">#define FIO_SEEK_SET SEEK_SET</font>
<a name="l00349"></a><a class="code" href="fastio_8h.html#a4">00349</a> <font class="preprocessor"></font><font class="preprocessor">#define FIO_SEEK_END SEEK_END</font>
00350 <font class="preprocessor"></font>
<a name="l00351"></a><a class="code" href="fastio_8h.html#a8">00351</a> <font class="keyword">static</font> <font class="keywordtype">int</font> <a class="code" href="fastio_8h.html#a8">fio_open</a>(<font class="keyword">const</font> <font class="keywordtype">char</font> *filename, <font class="keywordtype">int</font> mode, <a class="code" href="fastio_8h.html#a5">fio_fd</a> *fd) {
00352   <font class="keywordtype">int</font> nfd;
00353   <font class="keywordtype">int</font> oflag = 0;
00354 
00355   <font class="keywordflow">if</font> (mode == <a class="code" href="fastio_8h.html#a0">FIO_READ</a>) 
00356     oflag = O_RDONLY;
00357 
00358   <font class="keywordflow">if</font> (mode == <a class="code" href="fastio_8h.html#a1">FIO_WRITE</a>) 
00359     oflag = O_WRONLY | O_CREAT | O_TRUNC;
00360 
00361   nfd = open(filename, oflag, 0666);
00362   <font class="keywordflow">if</font> (nfd &lt; 0) {
00363     <font class="keywordflow">return</font> -1;
00364   } <font class="keywordflow">else</font> {
00365     *fd = nfd;
00366     <font class="keywordflow">return</font> 0;
00367   }
00368 }
00369 
<a name="l00370"></a><a class="code" href="fastio_8h.html#a9">00370</a> <font class="keyword">static</font> <font class="keywordtype">int</font> <a class="code" href="fastio_8h.html#a9">fio_fclose</a>(<a class="code" href="fastio_8h.html#a5">fio_fd</a> fd) {
00371   <font class="keywordflow">return</font> close(fd);
00372 }
00373 
<a name="l00374"></a><a class="code" href="fastio_8h.html#a10">00374</a> <font class="keyword">static</font> <a class="code" href="fastio_8h.html#a6">fio_size_t</a> <a class="code" href="fastio_8h.html#a10">fio_fread</a>(<font class="keywordtype">void</font> *ptr, <a class="code" href="fastio_8h.html#a6">fio_size_t</a> size, 
00375                             <a class="code" href="fastio_8h.html#a6">fio_size_t</a> nitems, <a class="code" href="fastio_8h.html#a5">fio_fd</a> fd) {
00376   <font class="keywordtype">int</font> i;
00377   <a class="code" href="fastio_8h.html#a6">fio_size_t</a> len = 0; 
00378   <font class="keywordtype">int</font> cnt = 0;
00379 
00380   <font class="keywordflow">for</font> (i=0; i&lt;nitems; i++) {
00381     <a class="code" href="fastio_8h.html#a6">fio_size_t</a> rc = read(fd, (<font class="keywordtype">void</font>*) (((<font class="keywordtype">char</font> *) ptr) + (cnt * size)), size);
00382     <font class="keywordflow">if</font> (rc != size)
00383       <font class="keywordflow">break</font>;
00384     len += rc;
00385     cnt++;
00386   }
00387 
00388   <font class="keywordflow">return</font> cnt;
00389 }
00390 
<a name="l00391"></a><a class="code" href="fastio_8h.html#a11">00391</a> <font class="keyword">static</font> <a class="code" href="fastio_8h.html#a6">fio_size_t</a> <a class="code" href="fastio_8h.html#a11">fio_readv</a>(<a class="code" href="fastio_8h.html#a5">fio_fd</a> fd, <font class="keyword">const</font> <a class="code" href="structfio__iovec.html">fio_iovec</a> * iov, <font class="keywordtype">int</font> iovcnt) {
00392 <font class="preprocessor">#if defined(USE_KERNEL_READV)</font>
00393 <font class="preprocessor"></font>  <font class="keywordflow">return</font> readv(fd, iov, iovcnt);
00394 <font class="preprocessor">#else</font>
00395 <font class="preprocessor"></font>  <font class="keywordtype">int</font> i;
00396   <a class="code" href="fastio_8h.html#a6">fio_size_t</a> len = 0; 
00397 
00398   <font class="keywordflow">for</font> (i=0; i&lt;iovcnt; i++) {
00399     <a class="code" href="fastio_8h.html#a6">fio_size_t</a> rc = read(fd, iov[i].iov_base, iov[i].iov_len);
00400     <font class="keywordflow">if</font> (rc != iov[i].<a class="code" href="structfio__iovec.html#m1">iov_len</a>)
00401       <font class="keywordflow">break</font>;
00402     len += iov[i].<a class="code" href="structfio__iovec.html#m1">iov_len</a>;
00403   }
00404 
00405   <font class="keywordflow">return</font> len;
00406 <font class="preprocessor">#endif</font>
00407 <font class="preprocessor"></font>}
00408 
<a name="l00409"></a><a class="code" href="fastio_8h.html#a12">00409</a> <font class="keyword">static</font> <a class="code" href="fastio_8h.html#a6">fio_size_t</a> <a class="code" href="fastio_8h.html#a12">fio_fwrite</a>(<font class="keywordtype">void</font> *ptr, <a class="code" href="fastio_8h.html#a6">fio_size_t</a> size, 
00410                              <a class="code" href="fastio_8h.html#a6">fio_size_t</a> nitems, <a class="code" href="fastio_8h.html#a5">fio_fd</a> fd) {
00411   <font class="keywordtype">int</font> i;
00412   <a class="code" href="fastio_8h.html#a6">fio_size_t</a> len = 0; 
00413   <font class="keywordtype">int</font> cnt = 0;
00414 
00415   <font class="keywordflow">for</font> (i=0; i&lt;nitems; i++) {
00416     <a class="code" href="fastio_8h.html#a6">fio_size_t</a> rc = write(fd, ptr, size);
00417     <font class="keywordflow">if</font> (rc != size)
00418       <font class="keywordflow">break</font>;
00419     len += rc;
00420     cnt++;
00421   }
00422 
00423   <font class="keywordflow">return</font> cnt;
00424 }
00425 
<a name="l00426"></a><a class="code" href="fastio_8h.html#a13">00426</a> <font class="keyword">static</font> <a class="code" href="fastio_8h.html#a6">fio_size_t</a> <a class="code" href="fastio_8h.html#a13">fio_fseek</a>(<a class="code" href="fastio_8h.html#a5">fio_fd</a> fd, <a class="code" href="fastio_8h.html#a6">fio_size_t</a> offset, <font class="keywordtype">int</font> whence) {
00427  <font class="keywordflow">if</font> (lseek(fd, offset, whence) &gt;= 0)
00428    <font class="keywordflow">return</font> 0;  <font class="comment">/* success (emulate behavior of fseek) */</font>
00429  <font class="keywordflow">else</font> 
00430    <font class="keywordflow">return</font> -1; <font class="comment">/* failure (emulate behavior of fseek) */</font>
00431 }
00432 
<a name="l00433"></a><a class="code" href="fastio_8h.html#a14">00433</a> <font class="keyword">static</font> <a class="code" href="fastio_8h.html#a6">fio_size_t</a> <a class="code" href="fastio_8h.html#a14">fio_ftell</a>(<a class="code" href="fastio_8h.html#a5">fio_fd</a> fd) {
00434   <font class="keywordflow">return</font> lseek(fd, 0, SEEK_CUR);
00435 }
00436 
00437 <font class="preprocessor">#endif</font>
00438 <font class="preprocessor"></font>
00439 
00440 <font class="comment">/* higher level routines that are OS independent */</font>
00441 
<a name="l00442"></a><a class="code" href="fastio_8h.html#a15">00442</a> <font class="keyword">static</font> <font class="keywordtype">int</font> <a class="code" href="fastio_8h.html#a15">fio_write_int32</a>(<a class="code" href="fastio_8h.html#a5">fio_fd</a> fd, <font class="keywordtype">int</font> i) {
00443   <font class="keywordflow">return</font> (<a class="code" href="fastio_8h.html#a12">fio_fwrite</a>(&amp;i, 4, 1, fd) != 1);
00444 }
00445 
<a name="l00446"></a><a class="code" href="fastio_8h.html#a16">00446</a> <font class="keyword">static</font> <font class="keywordtype">int</font> <a class="code" href="fastio_8h.html#a16">fio_read_int32</a>(<a class="code" href="fastio_8h.html#a5">fio_fd</a> fd, <font class="keywordtype">int</font> *i) {
00447   <font class="keywordflow">return</font> (<a class="code" href="fastio_8h.html#a10">fio_fread</a>(i, 4, 1, fd) != 1);
00448 }
00449 
<a name="l00450"></a><a class="code" href="fastio_8h.html#a17">00450</a> <font class="keyword">static</font> <font class="keywordtype">int</font> <a class="code" href="fastio_8h.html#a17">fio_write_str</a>(<a class="code" href="fastio_8h.html#a5">fio_fd</a> fd, <font class="keyword">const</font> <font class="keywordtype">char</font> *str) {
00451   <font class="keywordtype">int</font> len = strlen(str);
00452   <font class="keywordflow">return</font> (<a class="code" href="fastio_8h.html#a12">fio_fwrite</a>((<font class="keywordtype">void</font> *) str, len, 1, fd) != 1);
00453 }
00454 
</pre></div><hr><address><small>Generated on Wed Mar 22 13:15:29 2006 for VMD Plugins (current) by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.gif" alt="doxygen" align="middle" border=0 
width=110 height=53></a>1.2.14 written by <a href="mailto:dimitri@stack.nl">Dimitri van Heesch</a>,
 &copy;&nbsp;1997-2002</small></address>
</body>
</html>
